{
    "collab_server" : "",
    "contents" : "library(deSolve)\nlibrary(zoo)\nlibrary(\"Rcpp\")\nlibrary(\"BH\")\nlibrary(\"RColorBrewer\")\n#sourceCpp(\"C:/Users/ahauser/Documents/Bayesian/Rstan/solvdiff_cpp.cpp\")\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/parmin4_v3.R\")\n\n##############################################################################################################################\n#Assumptions\n#load params from value_gender4_v3.R and p1, p2 from graphs.R\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\np1=c(rate1_inf=3.318999e+00, rate2_inf=5.440886e-01, rate1_diag=2.736363e+02, rate2_diag=7.710578e+00, rate_treat=1.879695e-03,rate_death=1.632000e-01)\np2=c(rate1_inf=NA, rate2_inf=NA, rate1_diag=NA, rate2_diag=NA, rate_treat=NA,rate_death=NA,q=0.05,rate_ratio=0.5,k1=1,k2=2,k3=2,alpha=2,rate_res=5,rate_susc=125)\n#no treatment interruption\nparams<-within(params,{\n  RateStopTreatFirst=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopSuppFirst=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopFailFirst=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopTreatSecond=4.35/c(Inf,Inf,Inf,Inf) #Assumption : T2 same as T1\n  RateStopSuppSecond=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopFailSecond=4.35/c(Inf,Inf,Inf,Inf)\n})\n#no starting with second-line PI\nparams<-within(params,{\n  #RateDirectTreatSecond=4.35/c(5000,12000,13000,1850)\n  RateDirectTreatSecond=c(0,0,0,0)\n})\n\n#Baseline model: from 2005 to 2018 will be used later\n#load p1 and p2 from graphs.R, load the right mod_dtg\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/parmin4_v3.R\")\nsourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2005.cpp\")\ntreat_dtgb=c(p_w_start=0,p_w_switch=0,rate_first=0,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\nxstart_dtg_2_2005=xstart_f_dtg_2(p2,treat_dtgb)\ntheta=p1\n#15 compartments\ndata=my_fun10_solver2_dtg_2(xstart_dtg_2_2005,theta,treat_dtgb,params,p2)\n###################################################################################################################################\n#Sensitivity analysis\n#Resistance, transmission, and DTG-efficacy\n#https://daphnia.ecology.uga.edu/drakelab/wp-content/uploads/2015/07/sensitivity-ebola.pdf\nrequire(lhs) #add the lhs library\nh <- 200 #choose number of points\nset.seed(6242015)\n\n#####################################################################################################\n#Sensitivity variation\nres.min <- 3\nres.max <- 9\nrev.min <- 50\nrev.max <- 200\nalpha.min <- 1\nalpha.max <- 5\nart_int.min <-1\nart_int.max <-2\n\npmsm.min <- 0.01\npmsm.max <- 0.1\nriskr.min <- 1\nriskr.max <- 5\nhiv_msm.min <- 1\nhiv_msm.max <- 3\ndtg_eff.min <- 1\ndtg_eff.max <- 2\n\n\n\n\n\n#####################################################################################################\n\nsourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2018.cpp\")\nxstart_dtg_2_2018=data[dim(data)[1],]\n\n\n\ndata_l=list()\n  source(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/parmin4_v3.R\")\n  source(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\nparams<-within(params,{\n  RateStopTreatFirst=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopSuppFirst=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopFailFirst=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopTreatSecond=4.35/c(Inf,Inf,Inf,Inf) #Assumption : T2 same as T1\n  RateStopSuppSecond=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopFailSecond=4.35/c(Inf,Inf,Inf,Inf)\n})\n#no starting with second-line PI\nparams<-within(params,{\n  #RateDirectTreatSecond=4.35/c(5000,12000,13000,1850)\n  RateDirectTreatSecond=c(0,0,0,0)\n})\n  data_l[[1]]=sim(8)\n  p2[c(\"rate_res\")]=3\n  data_l[[2]]=sim(8)\n  p2[c(\"rate_res\")]=9\n  data_l[[3]]=sim(8)\n  p2[c(\"rate_res\")]=5\n  \n  p2[c(\"rate_susc\")]=36\n  data_l[[4]]=sim(8)\n  p2[c(\"rate_susc\")]=200\n  data_l[[5]]=sim(8)\n  p2[c(\"rate_susc\")]=125\n  \n  p2[c(\"alpha\")]=1\n  data_l[[6]]=sim(8)\n  p2[c(\"alpha\")]=5\n  data_l[[7]]=sim(8)\n  p2[c(\"alpha\")]=2\n  \n  params<-within(params,{\n    RateSuppFirstDTG=4.35/c(24,39,41,60)*1\n    RateFailToSuppFirstDTG=4.35/c(120,200,210,230)*1\n  })\n  data_l[[8]]=sim(8)\n  params<-within(params,{\n    RateSuppFirstDTG=4.35/c(24,39,41,60)*2\n    RateFailToSuppFirstDTG=4.35/c(120,200,210,230)*2\n  })\n  data_l[[9]]=sim(8)\n\n  figures_dtg_4_update(data_l,men_women = 1:2)\n  \n  \n  \n  t=241\n  sapply(data_l,function(x){\n    sum(x[t,select_15(c(3,5,6,8,9,11,13,15),1:4,2,1)])/sum(x[t,select_15(c(3,5,6,8,9,11,13,15),1:4,1:2,1)])\n  })\n  \n  sim=function(i){\n    sourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2005.cpp\")\n    xstart_dtg_2_2005=xstart_f_dtg_2(p2,treat_dtgb)\n    theta=p1\n    #15 compartments\n    data=my_fun10_solver2_dtg_2(xstart_dtg_2_2005,theta,treat_dtgb,params,p2)\n    \n    sourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2018.cpp\")\n    xstart_dtg_2_2018=data[dim(data)[1],]\n    \n    xstart=xstart_dtg_2_2018\n    xstart[select_15(2:5,1:4,1:2,2)]=treat_dtg_mat[i,1]*(xstart[select_15(12:15,1:4,1:2,2)])\n    xstart[select_15(12:15,1:4,1:2,2)]=(1-treat_dtg_mat[i,1])*(xstart[select_15(12:15,1:4,1:2,2)])\n    xstart=c(xstart,xstart_dtg_2_2018[241:250])\n    data1=my_fun10_solver2_dtg_2(xstart,theta,treat_dtg_mat[i,],params,p2)\n    rownames(data1)=1:(dim(data1)[1])\n    data1=rbind(data[-dim(data)[1],],data1)\n    data1\n  }\n  \n\n\n#####################################################################################################\n#Sensitivity matrix\nlhs<-maximinLHS(h,8) #simulate\nparams.set <- cbind(\n  res = lhs[,1]*(res.max-res.min)+res.min,\n  rev = lhs[,2]*(rev.max-rev.min)+rev.min,\n  alpha = lhs[,3]*(alpha.max-alpha.min)+alpha.min,\n  art_int=lhs[,4]*(art_int.max-art_int.min)+art_int.min,#increase/decrease in treatment interruption rate\n  pmsm = lhs[,5]*(pmsm.max-pmsm.min)+pmsm.min,\n  riskr = lhs[,6]*(riskr.max-riskr.min)+riskr.min,\n  hiv_msm= lhs[,7]*(hiv_msm.max-hiv_msm.min)+hiv_msm.min,\n  dtg_eff= lhs[,8]*(dtg_eff.max-dtg_eff.min)+dtg_eff.min)#increase in hiv prevalence in msm vs het\n\nsave(params.set,file = \"C:/Users/ahauser/Documents/Step2/R_results/params.set.RData\")\n\n#####################################################################################################\nload(\"data_dtg_2005_2018.RData\") #load data\nxstart_dtg_2_2018=data[dim(data)[1],]\n\ndata_sens=function(params.set,p1,p2,parms,treat_dtg){\n  data_list=list()\n  h2=dim(params.set)[1]\n  for(j in 1:h2){\n    \n    #Changing parameters according to sensitivity matrix params.set\n    p2[c(\"rate_res\",\"rate_susc\",\"alpha\")]=params.set[j,1:3]\n    parms1<-within(parms,{\n      RateStopTreatFirst=4.35/c(1800,1400,750,680)*params.set[j,4]\n      RateStopSuppFirst=4.35/c(9000,5400,3300,1600)*params.set[j,4]\n      RateStopFailFirst=4.35/c(2700,2080,1240,560)*params.set[j,4]\n      RateStopTreatSecond=4.35/c(1800,1400,750,680)*params.set[j,4] #Assumption : T2 same as T1\n      RateStopSuppSecond=4.35/c(9000,5400,3300,1600)*params.set[j,4] #Assumption : S2 same as S1\n      RateStopFailSecond=4.35/c(2700,2080,1240,560)*params.set[j,4]\n     \n      RateTransm=c(params.set[j,6]*params.set[j,5]*params.set[j,7],\n                   1-params.set[j,5],\n                   1-params.set[j,5],\n                   0)*0.003*(0.05*(0.008/0.003)*1+2*(1-0.05))*\n        (1/(params.set[j,5]*params.set[j,6]*params.set[j,7]+2*(1-params.set[j,5])))\n      \n      RateSuppFirstDTG=4.35/c(30,30,31,34)*params.set[j,8]\n      RateFailToSuppFirstDTG=4.35/c(10,56,24,51)*params.set[j,8]\n      #factor to keep the same total number of new infected when changing hiv prevalence/risk among msm and msm prop\n    })\n    \n    #Simulate dataset\n    xstart=xstart_f(p2)\n    data=my_fun10_solver2(xstart,p1,parms1,p2)\n    data<-data_convert_to_old(data)\n    \n    xstart=xstart_dtg_2_2018\n    xstart[select_15(2:5,1:4,1:2,2)]=treat_dtg*(xstart[select_15(12:15,1:4,1:2,2)])\n    xstart[select_15(12:15,1:4,1:2,2)]=(1-treat_dtg)*(xstart[select_15(12:15,1:4,1:2,2)])\n    xstart=c(xstart,xstart_dtg_2_2018[241:250])\n    data1=my_fun10_solver2_dtg_2(xstart,theta,treat_dtg,parms1,p2)\n    rownames(data1)=1:(dim(data1)[1])\n    data1=rbind(data[-dim(data)[1],],data1)\n    \n    #Save dataset\n    data_list[[j+1]]=data1\n    \n    \n    if(j%%5==0){\n      print(j)\n    }\n  }\n  return(data_list)\n}\n\nlist_data=data_sens(params.set,p1,p2,params,treat_dtg_mat[args,])\n\n#####################################################################################################\n#Results from Ubelix of sensitivity analysis done in 8 parameters\nrange_sensitivity=function(data_list,ret=1){\n  #Data\n  data=data_list[[1]]\n  tmax=dim(data)[1]\n  tdr=rowSums(data[seq(1,tmax,1),select_15(c(2,12),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_15(c(2,12),1:4,1:2,1:2)])\n  h2=length(data_list)-1\n  #Sensitivity\n  mat_tdr=matrix(NA,nrow=h2,ncol=tmax)\n  for (i in 1:h2){\n    data=data_list[[i+1]]\n    mat_tdr[i,]=rowSums(data[seq(1,tmax,1),select_15(c(2,12),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_15(c(2,12),1:4,1:2,1:2)])\n  }\n  \n  #Sensitivity range\n  tdr_minmax=apply(mat_tdr,2,function(x) quantile(x,probs=c(0.025,0.975)))\n  #tdr_minmax=apply(mat_tdr,2,function(x) quantile(x,probs=c(0,1)))\n\n  #Return\n  if(ret==1){\n    return(tdr)\n  }else{return(tdr_minmax)}\n\n}\n\n#Rearranging data\nlist_scen_data=lapply(as.list(1:9),function(x){\n  load(paste(\"C:/Users/ahauser/Documents/Step2/R_results/dtg_sens/dtg_sens4/dtg_sens\",x,\".RData\",sep=\"\"))\n  return(list_data)\n})\n\n#TDR dataset for the 9 scenarios over time\ntdr<-lapply(list_scen_data,function(x){\n  range_sensitivity(x,ret=1)\n})\n#TDR ranges\ntdr_range<-lapply(list_scen_data,function(x){\n  range_sensitivity(x,ret=2)\n})\n\n#Plot\nfigures_dtg_4_update=function(tdr,tdr_range,scen=c(\"Scen. 1\", \"Scen. 2\", \"Scen. 3\",\"Scen. 4\"),cex_t=1.5,cex_l=2,width=4,label=\"Simulations\",text_y=\"Level of NNRTI PDR among diagnosed individuals (%)    \"){\n  #Time axis\n  tmax=length(tdr[[1]])\n  time_start_abs=2005\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  \n  ###################################################################################################################\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4,5,5,6,6),nrow = 4,ncol = 2,byrow = TRUE)\n  graphics::layout(mat = m,heights = c(0.4,0.5,0.05,0.05),widths=c(0.8,0.2))\n  \n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0))\n  yLow=sapply(tdr_range[1:5],function(x) x[1,397])*100\n  yHigh=sapply(tdr_range[1:5],function(x) x[2,397])*100\n  plot(seq(time_start_abs,time_stop_abs,1/12),tdr[[1]]*100,type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_abs),ylim=c(0,max(yHigh)),xaxt='n',xlab=\"\",ylab=\"\",main=\"1. DTG used as 1st-line regimen\",pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr[[2]]*100,type=\"l\",col=\"violet\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr[[3]]*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr[[4]]*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr[[5]]*100,type=\"l\",col=\"orange\",lwd=width)\n  abline(v=2018,lty=2,col=\"red\")\n  text(x=2015,y=max(tdr[[1]],na.rm=TRUE)*100*3/4,labels=\"DTG \\n introduction\",cex=2,col=\"red\")\n  mtext(text=text_y,side=2,line=4,cex=cex_t,adj=1)\n  par(mai=c(0.2,0,0.5,0.4))\n  plot(1:5,sapply(tdr[1:5],function(x) x[length(x)])*100,xlim=c(0.2,5.8),ylim=c(0,max(yHigh)),xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"violet\",\"blue\",\"red\",\"orange\"))\n  arrows(1:5,yHigh,1:5,yLow,col=c(\"black\",\"violet\",\"blue\",\"red\",\"orange\"),angle=90,length=0.06,code=3)\n  \n  #Plot2\n  par(mai=c(0.8,0.8,0.5,0))\n  yLow=sapply(tdr_range[c(1,6:9)],function(x) x[1,397])*100\n  yHigh=sapply(tdr_range[c(1,6:9)],function(x) x[2,397])*100\n  plot(seq(time_start_abs,time_stop_abs,1/12),tdr[[1]]*100,type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_abs),ylim=c(0,max(yHigh)),xaxt='n',xlab=\"\",ylab=\"\",main=\"2. DTG used as 1st-line and switch regimen\",pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr[[6]]*100,type=\"l\",col=\"violet\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr[[7]]*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr[[8]]*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr[[9]]*100,type=\"l\",col=\"orange\",lwd=width)\n  abline(v=2018,lty=2,col=\"red\")\n  text(x=2015,y=max(tdr[[1]],na.rm=TRUE)*100*3/4,labels=\"DTG \\n introduction\",cex=2,col=\"red\")\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  par(mai=c(0.8,0,0.5,0.4))\n  plot(1:5,sapply(tdr[c(1,6:9)],function(x) x[length(x)])*100,xlim=c(0.2,5.8),ylim=c(0,max(yHigh)),xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"violet\",\"blue\",\"red\",\"orange\"))\n  arrows(1:5,yHigh,1:5,yLow,col=c(\"black\",\"violet\",\"blue\",\"red\",\"orange\"),angle=90,length=0.06,code=3)\n  \n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Baseline model\",\"\"),\n         lty=c(1,NA),pch=c(NA,NA), lwd=c(2,3), col=c(\"black\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.15),seg.len=c(1.2,1.2))\n  \n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(scen),\n         lty=c(1,1,1,1),pch=c(NA,NA,NA,NA), lwd=c(2,2,2,2), col=c(\"violet\",\"blue\",\"red\",\"orange\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.22,0.10,0.15,0.17),seg.len=c(1,1,1,1))\n  \n}\n\nfigures_dtg_4_update(tdr,tdr_range)\n\nd=expand.grid(obs=0:10, benchmark=c('antlr', 'bloat', 'chart', 'eclipse', 'fop', 'hsqldb', 'jython', 'luindex', 'lusearch', 'pmd', 'xalan'), gc=c('CopyMS', 'GenCopy', 'GenImmix', 'GenMS', 'Immix'), opt=c('on', 'off'), heapSize=seq(from=1.5, to=4, by=0.5))\nd$time = rexp(nrow(d), 0.01)+1000\nd$time = d$time + abs(d$heapSize-3)*100\nd$time[d$opt=='on'] = d$time[d$opt=='on']-200\n\nd$time[d$opt=='on' & d$benchmark=='bloat'] = d$time[d$opt=='on' & d$benchmark=='bloat'] + 190\nd$time[d$opt=='on' & d$benchmark=='pmd' & d$gc=='Immix'] = d$time[d$opt=='on' & d$benchmark=='pmd' & d$gc=='Immix'] + 600\n\n\nt=1+20*12\ndata_dtg=expand.grid(gender=c(\"male\",\"female\"),dtg_elig=c(\"63%\",\"100%\"),care_stage=c(\"newly infected\", \"diagnosed\", \"unsuppressed, on ART\", \"suppressed, on ART\"))\ndata_dtg$tdr=NA\ndata_dtg$tdr_lower=NA\ndata_dtg$tdr_upper=NA\n\n\ntdr_f<-function(gender,dtg_elig,care_stage){\n  if(dtg_elig==\"63%\"){scen=8}\n  if(dtg_elig==\"100%\"){scen=9}\n  load(paste(\"C:/Users/ahauser/Documents/Step2/R_results/dtg_sens/dtg_sens4/dtg_sens\",scen,\".RData\",sep=\"\"))\n  data1=list_data[[1]]\n  gender=ifelse(gender==\"male\",1,2)\n  t=1+20*12\n  if(care_stage==\"newly infected\"){\n    tdr1=diff(data1[t:(t+1),246])/diff(data1[t:(t+1),241])\n    tdr_sens=sapply(list_data[2:201],function(x) diff(x[t:(t+1),246])/diff(x[t:(t+1),241]))\n    tdr1_range=quantile(tdr_sens,probs=c(0.025,0.975))\n    return(c(tdr1,tdr1_range))}\n  if(care_stage==\"diagnosed\"){\n    tdr2=sum(data1[t,select_15(2,1:4,2,gender)])/sum(data1[t,select_15(2,1:4,1:2,gender)])\n    tdr_sens=sapply(list_data[2:201],function(x) sum(x[t,select_15(2,1:4,2,gender)])/sum(x[t,select_15(2,1:4,1:2,gender)]))\n    tdr2_range=quantile(tdr_sens,probs=c(0.025,0.975))\n    return(c(tdr2,tdr2_range))}\n  if(care_stage==\"unsuppressed, on ART\"){\n    tdr3=sum(data1[t,select_15(c(3,5,6,8,9,11,13,15),1:4,2,gender)])/sum(data1[t,select_15(c(3,5,6,8,9,11,13,15),1:4,1:2,gender)])\n    tdr_sens=sapply(list_data[2:201],function(x) sum(x[t,select_15(c(3,5,6,8,9,11,13,15),1:4,2,gender)])/sum(x[t,select_15(c(3,5,6,8,9,11,13,15),1:4,1:2,gender)]))\n    tdr3_range=quantile(tdr_sens,probs=c(0,1))\n    return(c(tdr3,tdr3_range))}\n  if(care_stage==\"suppressed, on ART\"){\n    tdr4=sum(data1[t,select_15(c(4,7,10,14),1:4,2,gender)])/sum(data1[t,select_15(c(4,7,10,14),1:4,1:2,gender)])\n    tdr_sens=sapply(list_data[2:201],function(x) sum(x[t,select_15(c(4,7,10,14),1:4,2,gender)])/sum(x[t,select_15(c(4,7,10,14),1:4,1:2,gender)]))\n    tdr4_range=quantile(tdr_sens,probs=c(0.0,1))\n    return(c(tdr4,tdr4_range))}\n}\ndata_dtg[,4:6]=t(as.matrix(apply(data_dtg,1,function(x) tdr_f(x[1],x[2],x[3]))))\n\n\nggplot(data_dtg, aes(x = dtg_elig, y = tdr, color = factor(gender))) +\n  geom_point(position = position_dodge(width = 0.6), size = 5) +\n  geom_linerange(aes(ymin = tdr_lower, ymax = tdr_upper),\n                 position = position_dodge(width = 0.6), \n                 size = 1.5, linetype = 1)+\n  facet_wrap(~ care_stage,labeller = label_wrap_gen(multi_line=FALSE))\n###################################################################################################################################\n#DTG-efficacy\nsourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2018.cpp\")\nxstart_dtg_2_2018=data[dim(data)[1],]\ndtg_list=list()\n\nfor(i in 1:9){\n  xstart=xstart_dtg_2_2018\n  xstart[select_15(12:15,1:4,1:2,2)]=(1-treat_dtg_mat[i,1])*(xstart[select_15(2:5,1:4,1:2,2)]+xstart[select_15(12:15,1:4,1:2,2)])\n  xstart[select_15(2:5,1:4,1:2,2)]=treat_dtg_mat[i,1]*(xstart[select_15(2:5,1:4,1:2,2)]+xstart[select_15(12:15,1:4,1:2,2)])\n  \n  scen_list=list()\n  \n  for(j in 1:l){\n    dtg_efficacy_fail=(j-1)/(l-1)\n    source(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n    params[[\"RateFailFirstDTG\"]]=params[[\"RateFailFirstDTG\"]]*dtg_efficacy_fail\n    params[[\"RateTreatToFailFirstDTG\"]]=params[[\"RateTreatToFailFirstDTG\"]]*dtg_efficacy_fail\n    data1=my_fun10_solver2_dtg_2(xstart,theta,treat_dtg_mat[i,],params,p2)\n    rownames(data1)=1:(dim(data1)[1])\n    data1=rbind(data[-dim(data)[1],],data1)\n    scen_list[[j]]<-data1\n  }\n  dtg_list[[i]]<-scen_list\n  print(i)\n}  \n  \n#DTG-efficacy\nsourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2018.cpp\")\nxstart_dtg_2_2018=data[dim(data)[1],]\nl=11\nlist_datab=list()\nlist_data4=list()\nlist_data5=list()\nlist_data8=list()\n\nfor(i in 1:l){\n  dtg_efficacy_fail=(i-1)/(l-1)\n  source(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n  params[[\"RateFailFirstDTG\"]]=params[[\"RateFailFirstDTG\"]]*dtg_efficacy_fail\n  params[[\"RateTreatToFailFirstDTG\"]]=params[[\"RateTreatToFailFirstDTG\"]]*dtg_efficacy_fail\n  \n  #Baseline\n  xstart_b=xstart_dtg_2_2018\n  xstart_b[select_dtg_2(12:15,1:4,1:2,2)]=(1-treat_dtgb[1])*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  xstart_b[select_dtg_2(2:5,1:4,1:2,2)]=treat_dtgb[1]*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  datab=my_fun10_solver2_dtg_2(xstart_b,theta,treat_dtgb)\n  rownames(datab)=1:(dim(datab)[1])\n  datab=rbind(data[-dim(data)[1],],datab)\n  list_datab[[i]]=datab\n  #4\n  xstart_4=xstart_dtg_2_2018\n  xstart_4[select_dtg_2(12:15,1:4,1:2,2)]=(1-treat_dtg4[1])*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  xstart_4[select_dtg_2(2:5,1:4,1:2,2)]=treat_dtg4[1]*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  data4=my_fun10_solver2_dtg_2(xstart_4,theta,treat_dtg4)\n  rownames(data4)=1:(dim(data4)[1])\n  data4=rbind(data[-dim(data)[1],],data4)\n  list_data4[[i]]=data4\n  #5\n  xstart_5=xstart_dtg_2_2018\n  xstart_5[select_dtg_2(12:15,1:4,1:2,2)]=(1-treat_dtg5[1])*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  xstart_5[select_dtg_2(2:5,1:4,1:2,2)]=treat_dtg5[1]*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  data5=my_fun10_solver2_dtg_2(xstart_5,theta,treat_dtg5)\n  rownames(data5)=1:(dim(data5)[1])\n  data5=rbind(data[-dim(data)[1],],data5)\n  list_data5[[i]]=data5\n  #8\n  xstart_8=xstart_dtg_2_2018\n  xstart_8[select_dtg_2(12:15,1:4,1:2,2)]=(1-treat_dtg8[1])*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  xstart_8[select_dtg_2(2:5,1:4,1:2,2)]=treat_dtg8[1]*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  data8=my_fun10_solver2_dtg_2(xstart_8,theta,treat_dtg8)\n  rownames(data8)=1:(dim(data8)[1])\n  data8=rbind(data,data8[-1,])\n  list_data8[[i]]=data8\n  \n  print(i)\n}\n\nlist_data1=list()\nlist_data2=list()\nlist_data3=list()\nlist_data6=list()\nlist_data7=list()\n\nfor(i in 1:l){\n  dtg_efficacy_fail=(i-1)/(l-1)\n  source(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n  params[[\"RateFailFirstDTG\"]]=params[[\"RateFailFirstDTG\"]]*dtg_efficacy_fail\n  params[[\"RateTreatToFailFirstDTG\"]]=params[[\"RateTreatToFailFirstDTG\"]]*dtg_efficacy_fail\n  \n  #1\n  xstart_1=xstart_dtg_2_2018\n  xstart_1[select_dtg_2(12:15,1:4,1:2,2)]=(1-treat_dtg1[1])*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  xstart_1[select_dtg_2(2:5,1:4,1:2,2)]=treat_dtg1[1]*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  data1=my_fun10_solver2_dtg_2(xstart_1,theta,treat_dtg1)\n  rownames(data1)=1:(dim(data1)[1])\n  data1=rbind(data[-dim(data)[1],],data1)\n  list_data1[[i]]=data1\n  #2\n  xstart_2=xstart_dtg_2_2018\n  xstart_2[select_dtg_2(12:15,1:4,1:2,2)]=(1-treat_dtg2[1])*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  xstart_2[select_dtg_2(2:5,1:4,1:2,2)]=treat_dtg2[1]*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  data2=my_fun10_solver2_dtg_2(xstart_2,theta,treat_dtg2)\n  rownames(data2)=1:(dim(data2)[1])\n  data2=rbind(data[-dim(data)[1],],data2)\n  list_data2[[i]]=data2\n  #3\n  xstart_3=xstart_dtg_2_2018\n  xstart_3[select_dtg_2(12:15,1:4,1:2,2)]=(1-treat_dtg3[1])*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  xstart_3[select_dtg_2(2:5,1:4,1:2,2)]=treat_dtg3[1]*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  data3=my_fun10_solver2_dtg_2(xstart_3,theta,treat_dtg3)\n  rownames(data3)=1:(dim(data3)[1])\n  data3=rbind(data[-dim(data)[1],],data3)\n  list_data3[[i]]=data3\n  #6\n  xstart_6=xstart_dtg_2_2018\n  xstart_6[select_dtg_2(12:15,1:4,1:2,2)]=(1-treat_dtg6[1])*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  xstart_6[select_dtg_2(2:5,1:4,1:2,2)]=treat_dtg6[1]*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  data6=my_fun10_solver2_dtg_2(xstart_6,theta,treat_dtg6)\n  rownames(data6)=1:(dim(data6)[1])\n  data6=rbind(data,data6[-1,])\n  list_data6[[i]]=data6\n  #7\n  xstart_7=xstart_dtg_2_2018\n  xstart_7[select_dtg_2(12:15,1:4,1:2,2)]=(1-treat_dtg7[1])*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  xstart_7[select_dtg_2(2:5,1:4,1:2,2)]=treat_dtg7[1]*(xstart_dtg_2_2018[select_dtg_2(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_dtg_2(12:15,1:4,1:2,2)])\n  data7=my_fun10_solver2_dtg_2(xstart_7,theta,treat_dtg7)\n  rownames(data7)=1:(dim(data7)[1])\n  data7=rbind(data,data7[-1,])\n  list_data7[[i]]=data7\n  \n  print(i)\n}\n\n#########################################################################################################################\n#Plot function sensitivity analysis, lines\nfigures_dtg_sens=function(list_datab,list_data1,list_data2,list_data3,list_data4,list_data5,list_data6,list_data7,list_data8,scen=c(\"Scen. 1\", \"Scen. 2\", \"Scen. 3\",\"Scen. 4\"),cex_t=1.5,cex_l=2,width=2,label=\"Simulations\",stage=2,men_women=c(1:2),new_inf=FALSE,text_y=\"Level of NNRTI PDR among diagnosed individuals (%)    \",title_1=\"1. DTG as 1st-line\",title_2=\"2. DTG as 1st-line and switch\",rgb_tr=0.2){\n  \n  ###################################################################################################################\n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4),nrow = 4,ncol = 1,byrow = FALSE)\n  graphics::layout(mat = m,heights = c(0.4,0.5,0.05,0.05),widths=c(0.5,0.5))\n  \n  #Time axis\n  tmax=dim(list_datab[[1]])[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n\n  #Data\n  trandrb=list()\n  trandr1=list()\n  trandr2=list()\n  trandr3=list()\n  trandr4=list()\n  trandr5=list()\n  trandr6=list()\n  trandr7=list()\n  trandr8=list()\n  l=length(list_datab)\n  \n  trandr_index=1\n  if(stage==2){trandr_index=c(stage,12)}\n  for(i in 1:l){\n  trandrb[[i]]=rowSums((list_datab[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])/rowSums((list_datab[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,1:2,men_women)])\n  \n  trandr1[[i]]=rowSums((list_data1[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])/rowSums((list_data1[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,1:2,men_women)])\n  trandr2[[i]]=rowSums((list_data2[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])/rowSums((list_data2[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,1:2,men_women)])\n  trandr3[[i]]=rowSums((list_data3[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])/rowSums((list_data3[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,1:2,men_women)])\n  trandr4[[i]]=rowSums((list_data4[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])/rowSums((list_data4[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,1:2,men_women)])\n  \n  trandr5[[i]]=rowSums((list_data5[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])/rowSums((list_data5[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,1:2,men_women)])\n  trandr6[[i]]=rowSums((list_data6[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])/rowSums((list_data6[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,1:2,men_women)])\n  trandr7[[i]]=rowSums((list_data7[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])/rowSums((list_data7[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,1:2,men_women)])\n  trandr8[[i]]=rowSums((list_data8[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])/rowSums((list_data8[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,1:2,men_women)])\n  }\n  \n  if(new_inf){\n    for(i in 1:l){\n      trandrb[[i]]=c(rep(NA,12),rollapply(diff((list_datab[[i]])[1:tmax,246]),12,sum)/rollapply(diff((list_datab[[i]])[1:tmax,241]),12,sum))\n      trandr1[[i]]=c(rep(NA,12),rollapply(diff((list_data1[[i]])[1:tmax,246]),12,sum)/rollapply(diff((list_data1[[i]])[1:tmax,241]),12,sum))\n      trandr2[[i]]=c(rep(NA,12),rollapply(diff((list_data2[[i]])[1:tmax,246]),12,sum)/rollapply(diff((list_data2[[i]])[1:tmax,241]),12,sum))\n      trandr3[[i]]=c(rep(NA,12),rollapply(diff((list_data3[[i]])[1:tmax,246]),12,sum)/rollapply(diff((list_data3[[i]])[1:tmax,241]),12,sum))\n      trandr4[[i]]=c(rep(NA,12),rollapply(diff((list_data4[[i]])[1:tmax,246]),12,sum)/rollapply(diff((list_data4[[i]])[1:tmax,241]),12,sum))\n      trandr5[[i]]=c(rep(NA,12),rollapply(diff((list_data5[[i]])[1:tmax,246]),12,sum)/rollapply(diff((list_data5[[i]])[1:tmax,241]),12,sum))\n      trandr6[[i]]=c(rep(NA,12),rollapply(diff((list_data6[[i]])[1:tmax,246]),12,sum)/rollapply(diff((list_data6[[i]])[1:tmax,241]),12,sum))\n      trandr7[[i]]=c(rep(NA,12),rollapply(diff((list_data7[[i]])[1:tmax,246]),12,sum)/rollapply(diff((list_data7[[i]])[1:tmax,241]),12,sum))\n      trandr8[[i]]=c(rep(NA,12),rollapply(diff((list_data8[[i]])[1:tmax,246]),12,sum)/rollapply(diff((list_data8[[i]])[1:tmax,241]),12,sum))\n    }\n  }\n  if(new_inf){text_y=\"Level of NNRTI PDR among newly infected individuals (%)\"}\n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandrb[[l]]*100,type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(unlist(c(trandrb,trandr1,trandr2,trandr3,trandr4)),na.rm=TRUE))*100,xaxt='n',xlab=\"\",ylab=\"\",main=ifelse(length(men_women)>1,title_1,paste(title_1,paste(c(\"men\",\"women\")[men_women],collapse=\" and \"),sep=\", \")),pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandrb[[i]]*100,type=\"l\",col=rgb(0,0,0,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr1[[l]]*100,type=\"l\",col=\"violet\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr1[[i]]*100,type=\"l\",col=rgb(238/255,130/255,238/255,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2[[l]]*100,type=\"l\",col=\"blue\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr2[[i]]*100,type=\"l\",col=rgb(0,0,255/255,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr3[[l]]*100,type=\"l\",col=\"red\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr3[[i]]*100,type=\"l\",col=rgb(255/255,0,0,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr4[[l]]*100,type=\"l\",col=\"orange\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr4[[i]]*100,type=\"l\",col=rgb(255/255,165/255,0,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandrb[[l]]*100,type=\"l\",col=rgb(0,0,0,1),lwd=width)\n  abline(v=2018,lty=2,col=\"red\")\n  text(x=2015,y=max(unlist(c(trandrb,trandr1,trandr2,trandr3,trandr4)),na.rm=TRUE)*100*3/4,labels=\"DTG \\n introduction\",cex=2,col=\"red\")\n  mtext(text=text_y,side=2,line=4,cex=cex_t,adj=1)\n  \n  \n  #Plot2\n  par(mai=c(0.8,0.8,0.5,0.4))\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr5[[l]]*100,type=\"l\",col=\"violet\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(unlist(c(trandrb,trandr5,trandr6,trandr7,trandr8)),na.rm=TRUE))*100,xaxt='n',xlab=\"\",ylab=\"\",main=ifelse(length(men_women)>1,title_2,paste(title_2,paste(c(\"men\",\"women\")[men_women],collapse=\" and \"),sep=\", \")),pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr5[[i]]*100,type=\"l\",col=rgb(238/255,130/255,238/255,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr6[[l]]*100,type=\"l\",col=\"blue\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr6[[i]]*100,type=\"l\",col=rgb(0,0,255/255,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr7[[l]]*100,type=\"l\",col=\"red\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr7[[i]]*100,type=\"l\",col=rgb(255/255,0,0,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr8[[l]]*100,type=\"l\",col=\"orange\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr8[[i]]*100,type=\"l\",col=rgb(255/255,165/255,0,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandrb[[l]]*100,type=\"l\",col=\"black\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandrb[[i]]*100,type=\"l\",col=rgb(0,0,0,rgb_tr),lwd=width)\n  }\n  abline(v=2018,lty=2,col=\"red\")\n  text(x=2015,y=max(unlist(c(trandrb,trandr5,trandr6,trandr7,trandr8)),na.rm=TRUE)*100*3/4,labels=\"DTG \\n introduction\",cex=2,col=\"red\")\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  \n  \n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Baseline model\",\"\"),\n         lty=c(1,NA),pch=c(NA,NA), lwd=c(2,3), col=c(\"black\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.15),seg.len=c(1.2,1.2))\n  \n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(scen),\n         lty=c(1,1,1,1),pch=c(NA,NA,NA,NA), lwd=c(2,2,2,2), col=c(\"violet\",\"blue\",\"red\",\"orange\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.22,0.10,0.15,0.17),seg.len=c(1,1,1,1))\n  \n}\n\nfigures_dtg_sens_absv=function(list_datab,list_data1,list_data2,list_data3,list_data4,list_data5,list_data6,list_data7,list_data8,scen=c(\"Scen. 1\", \"Scen. 2\", \"Scen. 3\",\"Scen. 4\"),cex_t=1.5,cex_l=2,width=2,label=\"Simulations\",stage=2,men_women=c(1:2),new_inf=FALSE,text_y=\"Number of NNRTI PDR among diagnosed individuals (1000)    \",title_1=\"1. DTG as 1st-line\",title_2=\"2. DTG as 1st-line and switch\",rgb_tr=0.2){\n  \n  ###################################################################################################################\n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4),nrow = 4,ncol = 1,byrow = FALSE)\n  graphics::layout(mat = m,heights = c(0.4,0.5,0.05,0.05),widths=c(0.5,0.5))\n  \n  #Time axis\n  tmax=dim(list_datab[[1]])[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  \n  #Data\n  trandrb=list()\n  trandr1=list()\n  trandr2=list()\n  trandr3=list()\n  trandr4=list()\n  trandr5=list()\n  trandr6=list()\n  trandr7=list()\n  trandr8=list()\n  l=length(list_datab)\n  \n  trandr_index=1\n  if(stage==2){trandr_index=c(stage,12)}\n  for(i in 1:l){\n    trandrb[[i]]=rowSums((list_datab[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])\n    \n    trandr1[[i]]=rowSums((list_data1[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])\n    trandr2[[i]]=rowSums((list_data2[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])\n    trandr3[[i]]=rowSums((list_data3[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])\n    trandr4[[i]]=rowSums((list_data4[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])\n    \n    trandr5[[i]]=rowSums((list_data5[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])\n    trandr6[[i]]=rowSums((list_data6[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])\n    trandr7[[i]]=rowSums((list_data7[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])\n    trandr8[[i]]=rowSums((list_data8[[i]])[seq(1,tmax,1),select_dtg_2(trandr_index,1:4,2,men_women)])\n  }\n  \n  if(new_inf){text_y=\"Level of NNRTI PDR among newly infected individuals (%)\"}\n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandrb[[l]],type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(unlist(c(trandrb,trandr1,trandr2,trandr3,trandr4)),na.rm=TRUE)),xaxt='n',xlab=\"\",ylab=\"\",main=ifelse(length(men_women)>1,title_1,paste(title_1,paste(c(\"men\",\"women\")[men_women],collapse=\" and \"),sep=\", \")),pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandrb[[i]],type=\"l\",col=rgb(0,0,0,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr1[[l]],type=\"l\",col=\"violet\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr1[[i]],type=\"l\",col=rgb(238/255,130/255,238/255,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2[[l]],type=\"l\",col=\"blue\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr2[[i]],type=\"l\",col=rgb(0,0,255/255,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr3[[l]],type=\"l\",col=\"red\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr3[[i]],type=\"l\",col=rgb(255/255,0,0,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr4[[l]],type=\"l\",col=\"orange\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr4[[i]],type=\"l\",col=rgb(255/255,165/255,0,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandrb[[l]],type=\"l\",col=rgb(0,0,0,1),lwd=width)\n  abline(v=2018,lty=2,col=\"red\")\n  text(x=2015,y=max(unlist(c(trandrb,trandr1,trandr2,trandr3,trandr4)),na.rm=TRUE)*3/4,labels=\"DTG \\n introduction\",cex=2,col=\"red\")\n  mtext(text=text_y,side=2,line=4,cex=cex_t,adj=1)\n  \n  \n  #Plot2\n  par(mai=c(0.8,0.8,0.5,0.4))\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr5[[l]],type=\"l\",col=\"violet\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(unlist(c(trandrb,trandr5,trandr6,trandr7,trandr8)),na.rm=TRUE)),xaxt='n',xlab=\"\",ylab=\"\",main=ifelse(length(men_women)>1,title_2,paste(title_2,paste(c(\"men\",\"women\")[men_women],collapse=\" and \"),sep=\", \")),pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr5[[i]],type=\"l\",col=rgb(238/255,130/255,238/255,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr6[[l]],type=\"l\",col=\"blue\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr6[[i]],type=\"l\",col=rgb(0,0,255/255,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr7[[l]],type=\"l\",col=\"red\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr7[[i]],type=\"l\",col=rgb(255/255,0,0,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr8[[l]],type=\"l\",col=\"orange\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandr8[[i]],type=\"l\",col=rgb(255/255,165/255,0,rgb_tr),lwd=width)\n  }\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandrb[[l]],type=\"l\",col=\"black\",lwd=width)\n  for(i in 1:l){\n    lines(seq(time_start_abs,time_stop_abs,1/12),trandrb[[i]],type=\"l\",col=rgb(0,0,0,rgb_tr),lwd=width)\n  }\n  abline(v=2018,lty=2,col=\"red\")\n  text(x=2015,y=max(unlist(c(trandrb,trandr5,trandr6,trandr7,trandr8)),na.rm=TRUE)*3/4,labels=\"DTG \\n introduction\",cex=2,col=\"red\")\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  \n  \n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Baseline model\",\"\"),\n         lty=c(1,NA),pch=c(NA,NA), lwd=c(2,3), col=c(\"black\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.15),seg.len=c(1.2,1.2))\n  \n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(scen),\n         lty=c(1,1,1,1),pch=c(NA,NA,NA,NA), lwd=c(2,2,2,2), col=c(\"violet\",\"blue\",\"red\",\"orange\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.22,0.10,0.15,0.17),seg.len=c(1,1,1,1))\n  \n}\n\n#########################################################################################################################\n#Plot results\nfigures_dtg_sens(list_datab,list_data1,list_data2,list_data3,list_data4,list_data5,list_data6,list_data7,list_data8,men_women=1:2,scen=c(\"a) men\",paste(\"b) men,\", dtg_women1*100,\"% women\",sep=\"\"),paste(\"c) men,\", dtg_women2*100,\"% women\",sep=\"\"),\"d) men and women\"))\nfigures_dtg_sens(list_datab,list_data1,list_data2,list_data3,list_data4,list_data5,list_data6,list_data7,list_data8,men_women=1:2,new_inf = TRUE)\n\nfigures_dtg_sens_absv(list_datab,list_data1,list_data2,list_data3,list_data4,list_data5,list_data6,list_data7,list_data8,men_women=1:2)\n\n#########################################################################################################################\n#Additional results\ndata4=list_data4[[11]]\ndata4_e=list_data4[[1]]\ntmax=397\n\n#new-treated\n(c(NA,rollapply(diff(data4[,249]),1,sum))/c(NA,rollapply(diff(data4[,244]),1,sum)))[seq(1,tmax,12)]\n(c(NA,rollapply(diff(data4_e[,249]),1,sum))/c(NA,rollapply(diff(data4_e[,244]),1,sum)))[seq(1,tmax,12)]\n\n#resistance level higher when gamma_fail=0\nrowSums(data4[seq(1,tmax,12),select_dtg_2(trandr_index,1:4,2,men_women)])/rowSums(data4[seq(1,tmax,12),select_dtg_2(trandr_index,1:4,1:2,men_women)])\nrowSums(data4_e[seq(1,tmax,12),select_dtg_2(trandr_index,1:4,2,men_women)])/rowSums(data4_e[seq(1,tmax,12),select_dtg_2(trandr_index,1:4,1:2,men_women)])\n#newly-infected: resistance level higher with fail=0 --> more infectious people\n(c(NA,rollapply(diff(data4[,246]),1,sum))/c(NA,rollapply(diff(data4[,241]),1,sum)))[seq(1,tmax,12)]\n(c(NA,rollapply(diff(data4_e[,246]),1,sum))/c(NA,rollapply(diff(data4_e[,241]),1,sum)))[seq(1,tmax,12)]\n#there is no one in 12:15 compartments\nrowSums(data4[seq(1,tmax,12),select_dtg_2(c(12:15),1:4,1:2,1:2)])\nrowSums(data4_e[seq(1,tmax,12),select_dtg_2(c(12:15),1:4,1:2,1:2)])\n#same resistance in levels in nnrti 3,5\nrowSums(data4[seq(1,tmax,12),select_dtg_2(c(3,5),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,12),select_dtg_2(c(3,5),1:4,1:2,1:2)])\nrowSums(data4_e[seq(1,tmax,12),select_dtg_2(c(3,5),1:4,2,1:2)])/rowSums(data4_e[seq(1,tmax,12),select_dtg_2(c(3,5),1:4,1:2,1:2)])\n#resistance higher in fail=0 in dtg 9,11// except in 2018-2019\nrowSums(data4[seq(1,tmax,12),select_dtg_2(c(9,11),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,12),select_dtg_2(c(9,11),1:4,1:2,1:2)])\nrowSums(data4_e[seq(1,tmax,12),select_dtg_2(c(9,11),1:4,2,1:2)])/rowSums(data4_e[seq(1,tmax,12),select_dtg_2(c(9,11),1:4,1:2,1:2)])\n#resistance higher in fail=0 in pi 6,8.\n#In fail=0 nobody leaves from dtg to pi as nobody fails.\n#People leaving have lower resistance level than in pi 6:8. That's why it's less increasing when fail=1.\nrowSums(data4[seq(1,tmax,12),select_dtg_2(c(6,8),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,12),select_dtg_2(c(6,8),1:4,1:2,1:2)])\nrowSums(data4_e[seq(1,tmax,12),select_dtg_2(c(6,8),1:4,2,1:2)])/rowSums(data4_e[seq(1,tmax,12),select_dtg_2(c(6,8),1:4,1:2,1:2)])\n#resistance higher in fail=0 in treated and infectious\nrowSums(data4[seq(1,tmax,12),select_dtg_2(c(3,5,6,8,9,11),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,12),select_dtg_2(c(3,5,6,8,9,11),1:4,1:2,1:2)])\nrowSums(data4_e[seq(1,tmax,12),select_dtg_2(c(3,5,6,8,9,11),1:4,2,1:2)])/rowSums(data4_e[seq(1,tmax,12),select_dtg_2(c(3,5,6,8,9,11),1:4,1:2,1:2)])",
    "created" : 1551285108146.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "228|44|250|0|\n253|47|256|0|\n259|39|261|0|\n263|45|265|0|\n268|205|328|0|\n521|405|651|0|\n653|414|770|0|\n",
    "hash" : "4052555175",
    "id" : "11A2C2ED",
    "lastKnownWriteTime" : 1557868260,
    "last_content_update" : 1557868261011,
    "path" : "~/Step2/dtg/dtg_sens.R",
    "project_path" : "dtg_sens.R",
    "properties" : {
    },
    "relative_order" : 13,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}