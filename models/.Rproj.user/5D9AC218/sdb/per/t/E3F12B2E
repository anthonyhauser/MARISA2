{
    "collab_server" : "",
    "contents" : " library(deSolve)\nlibrary(zoo)\nlibrary(\"Rcpp\")\nlibrary(\"BH\")\n############################################################################################################################\n#Counterfactual scenario: switch to DTG\n#1) Nobody switch\n#2) All men switch and women stay on EFV\n#3) All men switch and half the women\n#a) immediate switch to DTG for treatment naive (ind who start treatment) and ind on nnrti\n#b) immediate switch for treatment naive and delayed switch for ind on nnrti\n#c) delayed switch for all\n\n#Source and figures\n#used\nfigures_2_dtg_update=function(data,cex_t=1.5,cex_l=1.5,width=4,i=2,new_inf=FALSE){\n  #Time axis\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  \n  #Data\n  if(dim(data)[2]==250){\n    new_infected=rollapply(diff(data[1:tmax,241]),12,sum)\n    death_people=rollapply(diff(data[1:tmax,242]),12,sum)\n    undiag_people=rowSums(data[seq(1,tmax,1),select_15(1,1:4,1:2,1:2)])\n    treat_people=rowSums(data[seq(1,tmax,1),select_15(c(3:11,13:15),1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),select_15(1:15,1:4,1:2,1:2)])\n    resis_people=rowSums(data[seq(1,tmax,1),select_15(c(5,15),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_15(c(5,15),1:4,1:2,1:2)])\n    \n    trandr_index=i\n    if(i==2){trandr_index=c(i,12)}\n    trandr=rowSums(data[seq(1,tmax,1),select_15(trandr_index,1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,1:2)])\n    if(new_inf){\n      trandr=c(rep(NA,12),rollapply(diff(data[1:tmax,246]),12,sum)/rollapply(diff(data[1:tmax,241]),12,sum))\n    }\n  }else{\n    new_infected=rollapply(diff(data[1:tmax,289]),12,sum)\n    death_people=rollapply(diff(data[1:tmax,290]),12,sum)\n    undiag_people=rowSums(data[seq(1,tmax,1),select_18(1,1:4,1:2,1:2)])\n    treat_people=rowSums(data[seq(1,tmax,1),select_18(c(3:11,13:18),1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),select_18(1:18,1:4,1:2,1:2)])\n    resis_people=rowSums(data[seq(1,tmax,1),select_18(c(5,15,18),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_18(c(5,15,18),1:4,1:2,1:2)])\n    \n    trandr_index=i\n    if(i==2){trandr_index=c(i,12)}\n    trandr=rowSums(data[seq(1,tmax,1),select_18(trandr_index,1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_18(trandr_index,1:4,1:2,1:2)])\n    if(new_inf){\n      trandr=c(rep(NA,12),rollapply(diff(data[1:tmax,246]),12,sum)/rollapply(diff(data[1:tmax,241]),12,sum))\n    }\n  }\n  \n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  m <- matrix(c(1,2,3,4,5,6,7,7),nrow = 4,ncol = 2,byrow = TRUE)\n  graphics::layout(mat = m,heights = c(0.3,0.3,0.35,0.05),widths=c(0.5,0.5))\n  \n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2015+11/12,length.out=11),newinf_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(c(newinf_value,new_infected))),xaxt='n',xlab=\"\",ylab=\"\",main=\"A. New infected\",pch=1,col=\"red\",cex.main=2.5,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected,type=\"l\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot2\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(2005.5:2015.5,undiag_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(undiag_value,undiag_people)),xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",pch=1,col=\"red\",cex.main=2.5,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people,type=\"l\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot3\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2015+11/12,length.out=11),death_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(death_value,death_people)),xaxt='n',xlab=\"\",ylab=\"\",main=\"C. AIDS-related deaths\",pch=1,col=\"red\",cex.main=2.5,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people,type=\"l\",col=\"black\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot4\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(2005.5:2015.5,c(treat_percent*100),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(treat_percent,treat_people)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",pch=1,col=\"red\",cex.main=2.5,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,type=\"l\",col=\"black\",lwd=width)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  \n  #Plot5\n  par(mai=c(0.8,0.8,0.5,0.4))\n  plot(2005.5:2016.5,c(rep(NA,5),80,NA,NA,NA,95,NA,NA),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(resis_people[-1])*100,100),xaxt='n',xlab=\"\",ylab=\"\",main=\"E. ADR (Failing 1st-line)\",pch=1,col=\"blue\",cex.main=2.5,cex.axis=2.5,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),type=\"l\",col=\"black\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  #Plot6\n  par(mai=c(0.8,0.7,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(0.1,trandr,na.rm=TRUE)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2.5,cex.axis=2.5,cex.lab=2.5,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,tck=-0.1,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2,tck=-0.05)\n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  \n  legend(x=\"left\", inset =0,\n         c(\"Simulated by the model\",\"Estimated data (WHO)\",\"Data from previous studies\"),\n         lty=c(1,NA,NA),pch=c(NA,\"o\",\"o\"), lwd=c(2,3,3), col=c(\"black\",\"red\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.15,0.15))\n}\nfigures_dtg_4_update=function(list_data,scen=c(\"Scen. 1\", \"Scen. 2\", \"Scen. 3\",\"Scen. 4\"),cex_t=1.5,cex_l=2,width=4,label=\"Simulations\",i=2,men_women=c(1:2),new_inf=FALSE,text_y=\"Level of NNRTI PDR among diagnosed individuals (%)    \",title_1=\"1. DTG as 1st-line\",title_2=\"2. DTG as 1st-line and switch\"){\n  #Datasets 1,2,3,4\n  data=list_data[[1]]\n  data1=list_data[[2]]\n  data2=list_data[[3]]\n  data3=list_data[[4]]\n  data4=list_data[[5]]\n  data5=list_data[[6]]\n  data6=list_data[[7]]\n  data7=list_data[[8]]\n  data8=list_data[[9]]\n  \n  ###################################################################################################################\n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4),nrow = 4,ncol = 1,byrow = FALSE)\n  graphics::layout(mat = m,heights = c(0.4,0.5,0.05,0.05),widths=c(0.5,0.5))\n  \n  #Time axis\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  #Data\n  trandr=c(rep(NA,11),rollapply(diff(data[1:tmax,244]),12,sum)/rollapply(diff(data[1:tmax,241]),12,sum))\n  \n  trandr_index=1\n  if(i==2){trandr_index=c(i,12)}\n  trandr=rowSums(data[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr1=rowSums(data1[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data1[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr2=rowSums(data2[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data2[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr3=rowSums(data3[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data3[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr4=rowSums(data4[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data4[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr5=rowSums(data5[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data5[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr6=rowSums(data6[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data6[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr7=rowSums(data7[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data7[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr8=rowSums(data8[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data8[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  \n  if(new_inf){\n    trandr=c(rep(NA,12),rollapply(diff(data[1:tmax,246]),12,sum)/rollapply(diff(data[1:tmax,241]),12,sum))\n    trandr1=c(rep(NA,12),rollapply(diff(data1[1:tmax,246]),12,sum)/rollapply(diff(data1[1:tmax,241]),12,sum))\n    trandr2=c(rep(NA,12),rollapply(diff(data2[1:tmax,246]),12,sum)/rollapply(diff(data2[1:tmax,241]),12,sum))\n    trandr3=c(rep(NA,12),rollapply(diff(data3[1:tmax,246]),12,sum)/rollapply(diff(data3[1:tmax,241]),12,sum))\n    trandr4=c(rep(NA,12),rollapply(diff(data4[1:tmax,246]),12,sum)/rollapply(diff(data4[1:tmax,241]),12,sum))\n    trandr5=c(rep(NA,12),rollapply(diff(data5[1:tmax,246]),12,sum)/rollapply(diff(data5[1:tmax,241]),12,sum))\n    trandr6=c(rep(NA,12),rollapply(diff(data6[1:tmax,246]),12,sum)/rollapply(diff(data6[1:tmax,241]),12,sum))\n    trandr7=c(rep(NA,12),rollapply(diff(data7[1:tmax,246]),12,sum)/rollapply(diff(data7[1:tmax,241]),12,sum))\n    trandr8=c(rep(NA,12),rollapply(diff(data8[1:tmax,246]),12,sum)/rollapply(diff(data8[1:tmax,241]),12,sum))\n  }\n  if(new_inf){text_y=\"Level of NNRTI PDR among newly infected individuals (%)\"}\n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  #plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"1. PDR level (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr1,trandr2,trandr3,trandr4,na.rm=TRUE)*100,max(trandr,trandr1,trandr2,trandr3,trandr4,na.rm=TRUE)*100),xaxt='n',xlab=\"\",ylab=\"\",main=ifelse(length(men_women)>1,title_1,paste(title_1,paste(c(\"men\",\"women\")[men_women],collapse=\" and \"),sep=\", \")),pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr1*100,type=\"l\",col=\"violet\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr4*100,type=\"l\",col=\"orange\",lwd=width)\n  abline(v=2018,lty=2,col=\"red\")\n  text(x=2015,y=max(trandr,trandr5,trandr6,trandr7,trandr8,na.rm=TRUE)*100*3/4,labels=\"DTG \\n introduction\",cex=2,col=\"red\")\n  mtext(text=text_y,side=2,line=4,cex=cex_t,adj=1)\n  \n  \n  #Plot2\n  par(mai=c(0.8,0.8,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  #plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"2. PDR level (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr5,trandr6,trandr7,trandr8,na.rm=TRUE)*100,max(trandr,trandr5,trandr6,trandr7,trandr8,na.rm=TRUE)*100),xaxt='n',xlab=\"\",ylab=\"\",main=ifelse(length(men_women)>1,title_2,paste(title_2,paste(c(\"men\",\"women\")[men_women],collapse=\" and \"),sep=\", \")),pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr5*100,type=\"l\",col=\"violet\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr6*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr7*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr8*100,type=\"l\",col=\"orange\",lwd=width)\n  abline(v=2018,lty=2,col=\"red\")\n  text(x=2015,y=max(trandr,trandr5,trandr6,trandr7,trandr8,na.rm=TRUE)*100*3/4,labels=\"DTG \\n introduction\",cex=2,col=\"red\")\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  \n  \n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Baseline model\",\"\"),\n         lty=c(1,NA),pch=c(NA,NA), lwd=c(2,3), col=c(\"black\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.15),seg.len=c(1.2,1.2))\n  \n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(scen),\n         lty=c(1,1,1,1),pch=c(NA,NA,NA,NA), lwd=c(2,2,2,2), col=c(\"violet\",\"blue\",\"red\",\"orange\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.22,0.10,0.15,0.17),seg.len=c(1,1,1,1))\n  \n}\n#not used\nfigures_2_dtg=function(data,cex_t=1.5,cex_l=1.5,width=4,i=2){\n  #Time axis\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  \n  #Data\n  new_infected=rollapply(diff(data[1:tmax,177]),12,sum)\n  death_people=rollapply(diff(data[1:tmax,178]),12,sum)\n  undiag_people=rowSums(data[seq(1,tmax,1),select_dtg(1,1:4,1:2,1:2)])\n  treat_people=rowSums(data[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(1:11,1:4,1:2,1:2)])\n  resis_people=rowSums(data[seq(1,tmax,1),select_dtg(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(5),1:4,1:2,1:2)])\n  trandr=rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  \n  infectious_res=rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,1:2,1:2)])\n  rollapply(diff(data[1:tmax,180]),12,sum)/(rollapply(diff(data[1:tmax,177]),12,sum)+rollapply(diff(data[1:tmax,180]),12,sum))\n  rowSums(data[seq(1,tmax,1),select_dtg(c(1),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(1),1:4,1:2,1:2)])\n  rowSums(data[seq(1,tmax,1),select_dtg(c(2,3,5,6,8),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(2,3,5,6,8),1:4,1:2,1:2)])\n  rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,1:2,1:2)])\n  \n  rowSums(data[seq(1,tmax,1),select_dtg(c(2,3,5,6,8),1:4,2,1)])/rowSums(data[seq(1,tmax,1),select_dtg(c(2,3,5,6,8),1:4,1:2,1)])\n  rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,2,1)])/rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,1:2,1)])\n  \n  rowSums(data[seq(1,tmax,1),select_dtg(c(2,3,5,6,8),1:4,2,2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(2,3,5,6,8),1:4,1:2,2)])\n  rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,2,2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,1:2,2)])\n  \n  \n  print(\"TDR in newly infected\")\n  print((rollapply(diff(data[1:tmax,180]),12,sum)/rollapply(diff(data[1:tmax,177]),12,sum))[seq(1,tmax,12)])\n  print(\"People treated by first second and third\")\n  print((round((rowSums(data[seq(1,tmax,1),select_dtg(3:5,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)]))*100)/100)[seq(1,tmax,12)])\n  print((round((rowSums(data[seq(1,tmax,1),select_dtg(6:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)]))*100)/100)[seq(1,tmax,12)])\n  print((round((rowSums(data[seq(1,tmax,1),select_dtg(9:11,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)]))*100)/100)[seq(1,tmax,12)])\n  \n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  m <- matrix(c(1,2,3,4,5,6,7,7),nrow = 4,ncol = 2,byrow = TRUE)\n  layout(mat = m,heights = c(0.3,0.3,0.35,0.05),widths=c(0.5,0.5))\n  \n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2014+11/12,length.out=10),newinf_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(c(newinf_value,new_infected))),xaxt='n',xlab=\"\",ylab=\"\",main=\"A. New infected\",pch=1,col=\"red\",cex.main=2.5,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected,type=\"l\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot2\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(2005.5:2015.5,apply(undiag_value,1,sum),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(apply(undiag_value,1,sum),undiag_people)),xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",pch=1,col=\"red\",cex.main=2.5,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people,type=\"l\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot3\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2014+11/12,length.out=10),death_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(death_value,death_people)),xaxt='n',xlab=\"\",ylab=\"\",main=\"C. AIDS-related deaths\",pch=1,col=\"red\",cex.main=2.5,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people,type=\"l\",col=\"black\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot4\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(2005.5:2015.5,c(rep(NA,5),treat_percent*100),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(treat_percent,treat_people)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",pch=1,col=\"red\",cex.main=2.5,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,type=\"l\",col=\"black\",lwd=width)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  \n  #Plot5\n  par(mai=c(0.8,0.8,0.5,0.4))\n  plot(2005.5:2016.5,c(rep(NA,5),80,NA,NA,NA,95,NA,NA),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(resis_people[-1])*100,100),xaxt='n',xlab=\"\",ylab=\"\",main=\"E. ADR (Failing 1st-line)\",pch=1,col=\"blue\",cex.main=2.5,cex.axis=2.5,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),type=\"l\",col=\"black\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  #Plot6\n  par(mai=c(0.8,0.7,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(0.1,trandr)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2.5,cex.axis=2.5,cex.lab=2.5,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,tck=-0.1,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2,tck=-0.05)\n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  \n  legend(x=\"left\", inset =0,\n         c(\"Simulated by the model\",\"Estimated data (WHO)\",\"Data from previous studies\"),\n         lty=c(1,NA,NA),pch=c(NA,\"o\",\"o\"), lwd=c(2,3,3), col=c(\"black\",\"red\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.15,0.15))\n}\nfigures_2_dtg_2=function(data,cex_t=1.5,cex_l=1.5,width=4,i=2){\n  #Time axis\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  \n  #Data\n  new_infected=rollapply(diff(data[1:tmax,177]),12,sum)\n  death_people=rollapply(diff(data[1:tmax,178]),12,sum)\n  undiag_people=rowSums(data[seq(1,tmax,1),select_dtg(1,1:4,1:2,1:2)])\n  treat_people=rowSums(data[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(1:11,1:4,1:2,1:2)])\n  resis_people=rowSums(data[seq(1,tmax,1),select_dtg(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(5),1:4,1:2,1:2)])\n  trandr=rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  \n  infectious_res=rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,1:2,1:2)])\n  rollapply(diff(data[1:tmax,180]),12,sum)/(rollapply(diff(data[1:tmax,177]),12,sum)+rollapply(diff(data[1:tmax,180]),12,sum))\n  rowSums(data[seq(1,tmax,1),select_dtg(c(1),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(1),1:4,1:2,1:2)])\n  rowSums(data[seq(1,tmax,1),select_dtg(c(2,3,5,6,8),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(2,3,5,6,8),1:4,1:2,1:2)])\n  rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,1:2,1:2)])\n  \n  rowSums(data[seq(1,tmax,1),select_dtg(c(2,3,5,6,8),1:4,2,1)])/rowSums(data[seq(1,tmax,1),select_dtg(c(2,3,5,6,8),1:4,1:2,1)])\n  rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,2,1)])/rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,1:2,1)])\n  \n  rowSums(data[seq(1,tmax,1),select_dtg(c(2,3,5,6,8),1:4,2,2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(2,3,5,6,8),1:4,1:2,2)])\n  rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,2,2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(1,2,3,5,6,8),1:4,1:2,2)])\n  \n  \n  print(\"TDR in newly infected\")\n  print((rollapply(diff(data[1:tmax,180]),12,sum)/rollapply(diff(data[1:tmax,177]),12,sum))[seq(1,tmax,12)])\n  print(\"People treated by first second and third\")\n  print((round((rowSums(data[seq(1,tmax,1),select_dtg(3:5,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)]))*100)/100)[seq(1,tmax,12)])\n  print((round((rowSums(data[seq(1,tmax,1),select_dtg(6:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)]))*100)/100)[seq(1,tmax,12)])\n  print((round((rowSums(data[seq(1,tmax,1),select_dtg(9:11,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)]))*100)/100)[seq(1,tmax,12)])\n  \n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  m <- matrix(c(1,2,3,4,5,6,7,7),nrow = 4,ncol = 2,byrow = TRUE)\n  layout(mat = m,heights = c(0.3,0.3,0.35,0.05),widths=c(0.5,0.5))\n  \n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2014+11/12,length.out=10),newinf_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(c(newinf_value,new_infected))),xaxt='n',xlab=\"\",ylab=\"\",main=\"A. New infected\",pch=1,col=\"red\",cex.main=2.5,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected,type=\"l\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot2\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(2005.5:2015.5,apply(undiag_value,1,sum),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(apply(undiag_value,1,sum),undiag_people)),xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",pch=1,col=\"red\",cex.main=2.5,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people,type=\"l\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot3\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2014+11/12,length.out=10),death_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(death_value,death_people)),xaxt='n',xlab=\"\",ylab=\"\",main=\"C. AIDS-related deaths\",pch=1,col=\"red\",cex.main=2.5,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people,type=\"l\",col=\"black\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot4\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(2005.5:2015.5,c(rep(NA,5),treat_percent*100),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(treat_percent,treat_people)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",pch=1,col=\"red\",cex.main=2.5,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,type=\"l\",col=\"black\",lwd=width)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  \n  #Plot5\n  par(mai=c(0.8,0.8,0.5,0.4))\n  plot(2005.5:2016.5,c(rep(NA,5),80,NA,NA,NA,95,NA,NA),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(resis_people[-1])*100,100),xaxt='n',xlab=\"\",ylab=\"\",main=\"E. ADR (Failing 1st-line)\",pch=1,col=\"blue\",cex.main=2.5,cex.axis=2.5,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),type=\"l\",col=\"black\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  #Plot6\n  par(mai=c(0.8,0.7,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(0.1,trandr)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2.5,cex.axis=2.5,cex.lab=2.5,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,tck=-0.1,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2,tck=-0.05)\n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  \n  legend(x=\"left\", inset =0,\n         c(\"Simulated by the model\",\"Estimated data (WHO)\",\"Data from previous studies\"),\n         lty=c(1,NA,NA),pch=c(NA,\"o\",\"o\"), lwd=c(2,3,3), col=c(\"black\",\"red\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.15,0.15))\n}\nfigures_scen=function(list_data,scen=c(\"Scen. 1\", \"Scen. 2\", \"Scen. 3\"),cex_t=1.5,cex_l=1.5,width=4,label=\"Simulations\",i=2){\n  #Datasets 1,2,3,4\n  data=list_data[[1]]\n  data2=list_data[[2]]\n  data3=list_data[[3]]\n  data4=list_data[[4]]\n  #Time axis\n  tmax=times[length(times)]+1#because it times start at 0 but column of data at 1\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  #Data\n  new_infected=rollapply(diff(data[1:tmax,177]),12,sum)\n  death_people=rollapply(diff(data[1:tmax,178]),12,sum)\n  undiag_people=rowSums(data[seq(1,tmax,1),select_dtg(1,1:4,1:2,1:2)])\n  treat_people=rowSums(data[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(1:11,1:4,1:2,1:2)])\n  resis_people=rowSums(data[seq(1,tmax,1),select_dtg(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(5),1:4,1:2,1:2)])\n  trandr=rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  #Data2\n  new_infected2=rollapply(diff(data2[1:tmax,177]),12,sum)\n  death_people2=rollapply(diff(data2[1:tmax,178]),12,sum)\n  undiag_people2=rowSums(data2[seq(1,tmax,1),select_dtg(1,1:4,1:2,1:2)])\n  treat_people2=rowSums(data2[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)])/rowSums(data2[seq(1,tmax,1),select_dtg(1:11,1:4,1:2,1:2)])\n  resis_people2=rowSums(data2[seq(1,tmax,1),select_dtg(c(5),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),select_dtg(c(5),1:4,1:2,1:2)])\n  trandr2=rowSums(data2[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  #Data3\n  new_infected3=rollapply(diff(data3[1:tmax,177]),12,sum)\n  death_people3=rollapply(diff(data3[1:tmax,178]),12,sum)\n  undiag_people3=rowSums(data3[seq(1,tmax,1),select_dtg(1,1:4,1:2,1:2)])\n  treat_people3=rowSums(data3[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)])/rowSums(data3[seq(1,tmax,1),select_dtg(1:11,1:4,1:2,1:2)])\n  resis_people3=rowSums(data3[seq(1,tmax,1),select_dtg(c(5),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),select_dtg(c(5),1:4,1:2,1:2)])\n  trandr3=rowSums(data3[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  #Data4\n  new_infected4=rollapply(diff(data4[1:tmax,177]),12,sum)\n  death_people4=rollapply(diff(data4[1:tmax,178]),12,sum)\n  undiag_people4=rowSums(data4[seq(1,tmax,1),select_dtg(1,1:4,1:2,1:2)])\n  treat_people4=rowSums(data4[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)])/rowSums(data4[seq(1,tmax,1),select_dtg(1:11,1:4,1:2,1:2)])\n  resis_people4=rowSums(data4[seq(1,tmax,1),select_dtg(c(5),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),select_dtg(c(5),1:4,1:2,1:2)])\n  trandr4=rowSums(data4[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  \n  ###################################################################################################################\n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4,5,6,7,7,8,8),nrow = 5,ncol = 2,byrow = TRUE)\n  layout(mat = m,heights = c(0.28,0.28,0.34,0.05,0.05),widths=c(0.5,0.5))\n  \n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2014+11/12,length.out=10),newinf_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(c(newinf_value,new_infected,new_infected2,new_infected3,new_infected4)),max(c(newinf_value,new_infected,new_infected2,new_infected3,new_infected4))),xaxt='n',xlab=\"\",ylab=\"\",main=\"A. Newly infected\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected,type=\"l\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected4,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  \n  #Plot2\n  #par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(2005.5:2015.5,apply(undiag_value,1,sum),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(apply(undiag_value,1,sum),undiag_people,undiag_people2,undiag_people3,undiag_people4),max(apply(undiag_value,1,sum),undiag_people,undiag_people2,undiag_people3,undiag_people4)),xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people,type=\"l\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people4,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot3\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2014+11/12,length.out=10),death_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(death_value,death_people,death_people2,death_people3,death_people4),max(death_value,death_people,death_people2,death_people3,death_people4)),xaxt='n',xlab=\"\",ylab=\"\",main=\"C. AIDS-related deaths\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people4,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot4\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(2005.5:2015.5,c(rep(NA,5),treat_percent*100),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(treat_percent,treat_people,treat_people2,treat_people3,treat_people4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people4*100,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  \n  #Plot5\n  #par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  par(mai=c(0.8,0.8,0.5,0.4))\n  plot(2005.5:2016.5,c(rep(NA,5),80,NA,NA,NA,95,NA,NA),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(resis_people[-1],resis_people2[-1],resis_people3[-1],resis_people4[-1])*100,100),xaxt='n',xlab=\"\",ylab=\"\",main=\"E. ADR (Failing 1st-line)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.5,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people2[13:length(resis_people2)]*100),type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people3[13:length(resis_people3)]*100),type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people4[13:length(resis_people4)]*100),type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  #Plot6\n  par(mai=c(0.8,0.7,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"F. Level of PDR (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.5,cex.lab=2.5,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr4*100,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,tck=-0.1,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2,tck=-0.05)\n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(label,\"*************\"),\n         lty=c(NA,NA),pch=c(NA,\"o\"), lwd=c(2,3), col=c(\"black\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.9))\n  \n  # legend(x=\"left\", inset =0,\n  #        c(\"Simulated by the model\",\"Estimated data (WHO)\",\"Data from previous studies\"),\n  #        lty=c(1,NA,NA),pch=c(NA,\"o\",\"o\"), lwd=c(2,3,3), col=c(\"black\",\"red\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.15,0.15))\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Model simulation\",scen),\n         lty=c(1,1,1,1),pch=c(NA,NA,NA,NA), lwd=c(2,2,2,2), col=c(\"black\",\"blue\",\"red\",\"orange\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.15,0.15,0.15),seg.len=c(1.2,1.2,1.2,1.2))\n}\nfigures_dtg_scen=function(list_data,scen=c(\"Scen. 1\", \"Scen. 2\", \"Scen. 3\"),cex_t=1.5,cex_l=1.5,width=4,label=\"Simulations\",i=2){\n  #Datasets 1,2,3,4\n  data=list_data[[1]]\n  data2=list_data[[2]]\n  data3=list_data[[3]]\n  data4=list_data[[4]]\n  #Time axis\n  tmin=12*13+1\n  tmax=dim(data)[1]\n  time_start_abs=2005+(tmin-1)/12\n  time_start_diff=2005+(tmin-1)/12 #no need to postpone as we have information from 2005\n  time_stop_abs=time_start_abs+(tmax-tmin)/12\n  time_stop_diff=time_start_diff+(tmax-tmin)/12-1/12\n  #Data: number of death from 2018, TDR from 2018, relative effect of the number of death, yearly changes in TDR\n  death=rollapply(diff(data[1:tmax,178]),12,sum)[(tmin-11):(tmax-12)]\n  death_2=rollapply(diff(data2[1:tmax,178]),12,sum)[(tmin-11):(tmax-12)]\n  death_3=rollapply(diff(data3[1:tmax,178]),12,sum)[(tmin-11):(tmax-12)]\n  death_4=rollapply(diff(data4[1:tmax,178]),12,sum)[(tmin-11):(tmax-12)]\n  #tdr\n  tdr=(rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)]))[tmin:tmax]\n  tdr_2=(rowSums(data2[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)]))[tmin:tmax]\n  tdr_3=(rowSums(data3[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)]))[tmin:tmax]\n  tdr_4=(rowSums(data4[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)]))[tmin:tmax]\n  tdr=tdr*100\n  tdr_2=tdr_2*100\n  tdr_3=tdr_3*100\n  tdr_4=tdr_4*100\n  #reduction in death compared to baseline model\n  death_eff=(death-death)/death\n  death_eff_2=(death-death_2)/death\n  death_eff_3=(death-death_3)/death\n  death_eff_4=(death-death_4)/death\n  #timestep increase/decrease of tdr\n  tdr_inc=diff(tdr) #from 2018 to 2025.83=time_stop_abs-1/12\n  tdr_inc_2=diff(tdr_2)\n  tdr_inc_3=diff(tdr_3)\n  tdr_inc_4=diff(tdr_4)\n  #6 main indicators for each option\n  #Data\n  new_infected=rollapply(diff(data[1:tmax,177]),12,sum)\n  death_people=rollapply(diff(data[1:tmax,178]),12,sum)\n  undiag_people=rowSums(data[seq(1,tmax,1),select_dtg(1,1:4,1:2,1:2)])\n  treat_people=rowSums(data[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(1:11,1:4,1:2,1:2)])\n  resis_people=rowSums(data[seq(1,tmax,1),select_dtg(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(5),1:4,1:2,1:2)])\n  trandr=rowSums(data[seq(1,tmax,1),select_dtg(c(2),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(2),1:4,1:2,1:2)])\n  #Data2\n  new_infected2=rollapply(diff(data2[1:tmax,177]),12,sum)\n  death_people2=rollapply(diff(data2[1:tmax,178]),12,sum)\n  undiag_people2=rowSums(data2[seq(1,tmax,1),select_dtg(1,1:4,1:2,1:2)])\n  treat_people2=rowSums(data2[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)])/rowSums(data2[seq(1,tmax,1),select_dtg(1:11,1:4,1:2,1:2)])\n  resis_people2=rowSums(data2[seq(1,tmax,1),select_dtg(c(5),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),select_dtg(c(5),1:4,1:2,1:2)])\n  trandr2=rowSums(data2[seq(1,tmax,1),select_dtg(c(2),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),select_dtg(c(2),1:4,1:2,1:2)])\n  #Data3\n  new_infected3=rollapply(diff(data3[1:tmax,177]),12,sum)\n  death_people3=rollapply(diff(data3[1:tmax,178]),12,sum)\n  undiag_people3=rowSums(data3[seq(1,tmax,1),select_dtg(1,1:4,1:2,1:2)])\n  treat_people3=rowSums(data3[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)])/rowSums(data3[seq(1,tmax,1),select_dtg(1:11,1:4,1:2,1:2)])\n  resis_people3=rowSums(data3[seq(1,tmax,1),select_dtg(c(5),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),select_dtg(c(5),1:4,1:2,1:2)])\n  trandr3=rowSums(data3[seq(1,tmax,1),select_dtg(c(2),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),select_dtg(c(2),1:4,1:2,1:2)])\n  #Data4\n  new_infected4=rollapply(diff(data4[1:tmax,177]),12,sum)\n  death_people4=rollapply(diff(data4[1:tmax,178]),12,sum)\n  undiag_people4=rowSums(data4[seq(1,tmax,1),select_dtg(1,1:4,1:2,1:2)])\n  treat_people4=rowSums(data4[seq(1,tmax,1),select_dtg(3:11,1:4,1:2,1:2)])/rowSums(data4[seq(1,tmax,1),select_dtg(1:11,1:4,1:2,1:2)])\n  resis_people4=rowSums(data4[seq(1,tmax,1),select_dtg(c(5),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),select_dtg(c(5),1:4,1:2,1:2)])\n  trandr4=rowSums(data4[seq(1,tmax,1),select_dtg(c(2),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),select_dtg(c(2),1:4,1:2,1:2)])\n  \n  ###################################################################################################################\n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4,5,5,6,6),nrow = 4,ncol = 2,byrow = TRUE)\n  layout(mat = m,heights = c(0.4,0.5,0.05,0.05),widths=c(0.5,0.5))\n  \n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(time_start_diff,time_stop_diff,1/12),death,type=\"l\",lwd=width,xlim=c(time_start_diff,time_stop_diff),ylim=c(0,max(c(death,death_2,death_3,death_4))),xaxt='n',xlab=\"\",ylab=\"\",main=\"A. Death\",pch=1,col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_4,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot2\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(seq(time_start_abs,time_stop_abs,1/12),tdr,type=\"l\",lwd=width,xlim=c(time_start_abs,time_stop_abs),ylim=c(min(c(tdr,tdr_2,tdr_3,tdr_4)),max(c(tdr,tdr_2,tdr_3,tdr_4))),xaxt='n',xlab=\"\",ylab=\"\",main=\"B. PDR level\",pch=1,col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr_2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr_3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr_4,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"Percent\",side=2,line=4,cex=cex_t)\n  \n  #Plot3\n  par(mai=c(0.8,0.8,0.5,0.4))\n  plot(seq(time_start_diff,time_stop_diff,1/12),death_eff,type=\"l\",lwd=width,xlim=c(time_start_diff,time_stop_diff),ylim=c(min(c(-death_eff,-death_eff_2,-death_eff_3,-death_eff_4)),max(c(-death_eff,-death_eff_2,-death_eff_3,-death_eff_4))),xaxt='n',xlab=\"\",ylab=\"\",main=\"C. Relative reduction in mortality\",pch=1,col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2)\n  lines(seq(time_start_diff,time_stop_diff,1/12),-death_eff_2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),-death_eff_3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),-death_eff_4,type=\"l\",col=\"orange\",lwd=width)\n  \n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"Percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  #Plot4\n  par(mai=c(0.8,0.7,0.5,0.4))\n  plot(seq(time_start_abs,time_stop_abs,1/12),c(tdr_inc,NA),type=\"l\",lwd=width,xlim=c(time_start_abs,time_stop_abs),ylim=c(0,max(c(tdr_inc,tdr_inc_2,tdr_inc_3,tdr_inc_4))),xaxt='n',xlab=\"\",ylab=\"\",main=\"B. TDR(t+1)-TDR(t)\",pch=1,col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(tdr_inc_2,NA),type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(tdr_inc_3,NA),type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(tdr_inc_4,NA),type=\"l\",col=\"orange\",lwd=width)\n  \n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"Percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(label,\"*************\"),\n         lty=c(NA,NA),pch=c(NA,\"o\"), lwd=c(2,3), col=c(\"black\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.9))\n  \n  # legend(x=\"left\", inset =0,\n  #        c(\"Simulated by the model\",\"Estimated data (WHO)\",\"Data from previous studies\"),\n  #        lty=c(1,NA,NA),pch=c(NA,\"o\",\"o\"), lwd=c(2,3,3), col=c(\"black\",\"red\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.15,0.15))\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Model simulation\",scen),\n         lty=c(1,1,1,1),pch=c(NA,NA,NA,NA), lwd=c(2,2,2,2), col=c(\"black\",\"blue\",\"red\",\"orange\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.15,0.15,0.15),seg.len=c(1.2,1.2,1.2,1.2))\n}\nfigures_dtg_3=function(list_data,scen=c(\"Scen. 1\", \"Scen. 2\", \"Scen. 3\"),cex_t=1.5,cex_l=2,width=4,label=\"Simulations\",i=2){\n  #Datasets 1,2,3,4\n  data=list_data[[1]]\n  data1=list_data[[2]]\n  data2=list_data[[3]]\n  data3=list_data[[4]]\n  data4=list_data[[5]]\n  data5=list_data[[6]]\n  data6=list_data[[7]]\n  \n  ###################################################################################################################\n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4,5,6,3,4),nrow = 4,ncol = 2,byrow = FALSE)\n  layout(mat = m,heights = c(0.4,0.5,0.05,0.05),widths=c(0.5,0.5))\n  \n  #Time axis\n  tmax=times[length(times)]+1#because it times start at 0 but column of data at 1\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  #Data\n  trandr=rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr1=rowSums(data1[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data1[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr2=rowSums(data2[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr3=rowSums(data3[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr4=rowSums(data4[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr5=rowSums(data5[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data5[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr6=rowSums(data6[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data6[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  \n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  #plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"1A. PDR level (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"1A. DTG as 1st-line\",pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  #lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr1*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr3*100,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"Level of NNRTI PDR among diagnosed individuals (%)    \",side=2,line=4,cex=cex_t,adj=1)\n  #mtext(text=\"Level of NNRTI PDR\",side=2,line=4,cex=cex_t)\n  \n  \n  #Plot2\n  par(mai=c(0.8,0.8,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  #plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"2A. PDR level (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"2A. DTG as 1st-line and switch\",pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  #lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr4*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr5*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr6*100,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  #mtext(text=\"Level of NNRTI PDR among diagnosed individuals (%)\",side=2,line=4,cex=cex_t,adj=1)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  \n  \n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Baseline model\",\"\"),\n         lty=c(1,NA),pch=c(NA,NA), lwd=c(2,3), col=c(\"black\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.15),seg.len=c(1.2,1.2))\n  \n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(scen),\n         lty=c(1,1,1),pch=c(NA,NA,NA), lwd=c(2,2,2), col=c(\"blue\",\"red\",\"orange\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.22,0.22,0.22),seg.len=c(1.2,1.2,1.2))\n  \n  ###################################################################################################################\n  ###################################################################################################################\n  ###################################################################################################################\n  ###################################################################################################################\n  #Time axis\n  tmin=12*13+1\n  tmax=dim(data)[1]\n  time_start_abs=2005+(tmin-1)/12\n  time_start_diff=2005+(tmin-1)/12 #no need to postpone as we have information from 2005\n  time_stop_abs=time_start_abs+(tmax-tmin)/12\n  time_stop_diff=time_start_diff+(tmax-tmin)/12-1/12\n  #Data: number of death from 2018, TDR from 2018, relative effect of the number of death, yearly changes in TDR\n  death=rollapply(diff(data[1:tmax,178]),12,sum)[(tmin-11):(tmax-12)]\n  death_2=rollapply(diff(data2[1:tmax,178]),12,sum)[(tmin-11):(tmax-12)]\n  death_3=rollapply(diff(data3[1:tmax,178]),12,sum)[(tmin-11):(tmax-12)]\n  death_4=rollapply(diff(data4[1:tmax,178]),12,sum)[(tmin-11):(tmax-12)]\n  #tdr\n  tdr=(rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)]))[tmin:tmax]\n  \n  tdr_1=(rowSums(data1[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data1[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)]))[tmin:tmax]\n  tdr_2=(rowSums(data2[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)]))[tmin:tmax]\n  tdr_3=(rowSums(data3[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)]))[tmin:tmax]\n  tdr_4=(rowSums(data4[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)]))[tmin:tmax]\n  tdr_5=(rowSums(data5[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data5[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)]))[tmin:tmax]\n  tdr_6=(rowSums(data6[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data6[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)]))[tmin:tmax]\n  \n  tdr=tdr*100\n  tdr_1=tdr_1*100\n  tdr_2=tdr_2*100\n  tdr_3=tdr_3*100\n  tdr_4=tdr_4*100\n  tdr_5=tdr_5*100\n  tdr_6=tdr_6*100\n  #Plot3\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(seq(time_start_abs,time_stop_abs,1/12),tdr,type=\"l\",lwd=width,xlim=c(time_start_abs,time_stop_abs),ylim=c(0,max(c(tdr,tdr_1,tdr_2,tdr_3,tdr_4,tdr_5,tdr_6))),xaxt='n',xlab=\"\",ylab=\"\",main=\"1B. DTG as 1st-line (from 2018)\",pch=1,col=\"black\",cex.main=2,cex.axis=2.5,cex.lab=2.2,cex=2)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr_1,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr_2,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr_3,type=\"l\",col=\"orange\",lwd=width)\n  #mtext(text=\"Level of NNRTI PDR among diagnosed individuals (%)\",side=2,line=4,cex=cex_t)\n  box(lwd=2)\n  \n  #Plot4\n  par(mai=c(0.8,0.7,0.5,0.4))\n  plot(seq(time_start_abs,time_stop_abs,1/12),tdr,type=\"l\",lwd=width,xlim=c(time_start_abs,time_stop_abs),ylim=c(0,max(c(tdr,tdr_1,tdr_2,tdr_3,tdr_4,tdr_5,tdr_6))),xaxt='n',xlab=\"\",ylab=\"\",main=\"2B. DTG as 1st-line and switch (from 2018)\",pch=1,col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr_4,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr_5,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),tdr_6,type=\"l\",col=\"orange\",lwd=width)\n  box(lwd=2)\n  \n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  #mtext(text=\"Percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n}\nfigures_dtg_4=function(list_data,scen=c(\"Scen. 1\", \"Scen. 2\", \"Scen. 3\",\"Scen. 4\"),cex_t=1.5,cex_l=2,width=4,label=\"Simulations\",i=2){\n  #Datasets 1,2,3,4\n  data=list_data[[1]]\n  data1=list_data[[2]]\n  data2=list_data[[3]]\n  data3=list_data[[4]]\n  data4=list_data[[5]]\n  data5=list_data[[6]]\n  data6=list_data[[7]]\n  data7=list_data[[8]]\n  data8=list_data[[9]]\n  \n  ###################################################################################################################\n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4),nrow = 4,ncol = 1,byrow = FALSE)\n  layout(mat = m,heights = c(0.4,0.5,0.05,0.05),widths=c(0.5,0.5))\n  \n  #Time axis\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  #Data\n  trandr=rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr1=rowSums(data1[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data1[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr2=rowSums(data2[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr3=rowSums(data3[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr4=rowSums(data4[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr5=rowSums(data5[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data5[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr6=rowSums(data6[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data6[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr7=rowSums(data7[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data7[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr8=rowSums(data8[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data8[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  \n  \n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  #plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"1. PDR level (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr1,trandr2,trandr3,trandr4)*100,max(trandr,trandr1,trandr2,trandr3,trandr4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"1. DTG as 1st-line\",pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  #lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr1*100,type=\"l\",col=\"violet\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr4*100,type=\"l\",col=\"orange\",lwd=width)\n  abline(v=2018,lty=2,col=\"red\")\n  text(x=2015,y=max(trandr,trandr5,trandr6,trandr7,trandr8)*100*3/4,labels=\"DTG \\n introduction\",cex=2,col=\"red\")\n  mtext(text=\"Level of NNRTI PDR among diagnosed individuals (%)    \",side=2,line=4,cex=cex_t,adj=1)\n  #mtext(text=\"Level of NNRTI PDR\",side=2,line=4,cex=cex_t)\n  \n  \n  #Plot2\n  par(mai=c(0.8,0.8,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  #plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"2. PDR level (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr5,trandr6,trandr7,trandr8)*100,max(trandr,trandr5,trandr6,trandr7,trandr8)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"2. DTG as 1st-line and switch\",pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  #lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr5*100,type=\"l\",col=\"violet\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr6*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr7*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr8*100,type=\"l\",col=\"orange\",lwd=width)\n  abline(v=2018,lty=2,col=\"red\")\n  text(x=2015,y=max(trandr,trandr5,trandr6,trandr7,trandr8)*100*3/4,labels=\"DTG \\n introduction\",cex=2,col=\"red\")\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  #mtext(text=\"Level of NNRTI PDR among diagnosed individuals (%)\",side=2,line=4,cex=cex_t,adj=1)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  \n  \n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Baseline model\",\"\"),\n         lty=c(1,NA),pch=c(NA,NA), lwd=c(2,3), col=c(\"black\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.15),seg.len=c(1.2,1.2))\n  \n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(scen),\n         lty=c(1,1,1,1),pch=c(NA,NA,NA,NA), lwd=c(2,2,2,2), col=c(\"violet\",\"blue\",\"red\",\"orange\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.22,0.10,0.15,0.17),seg.len=c(1,1,1,1))\n  \n}\nfigures_dtg_4_2=function(list_data,scen=c(\"Scen. 1\", \"Scen. 2\", \"Scen. 3\",\"Scen. 4\"),cex_t=1.5,cex_l=2,width=4,label=\"Simulations\",i=2,width1=c(0.15,0.15,0.15),width2=c(0.15,0.15),legend_width3=1){\n  #Datasets 1,2,3,4\n  data=list_data[[1]]\n  data1=list_data[[2]]\n  data2=list_data[[3]]\n  data3=list_data[[4]]\n  data4=list_data[[5]]\n  data5=list_data[[6]]\n  data6=list_data[[7]]\n  data7=list_data[[8]]\n  data8=list_data[[9]]\n  \n  ###################################################################################################################\n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4,5),nrow = 5,ncol = 1,byrow = FALSE)\n  layout(mat = m,heights = c(0.40,0.425,0.03,0.03,0.115))\n  \n  #Time axis\n  tmax=times[length(times)]+1#because it times start at 0 but column of data at 1\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  #Data\n  trandr=rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr1=rowSums(data1[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data1[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr2=rowSums(data2[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr3=rowSums(data3[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr4=rowSums(data4[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr5=rowSums(data5[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data5[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr6=rowSums(data6[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data6[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr7=rowSums(data7[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data7[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  trandr8=rowSums(data8[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data8[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n  \n  \n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  #plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"1. PDR level (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr1,trandr2,trandr3,trandr4)*100,max(trandr,trandr1,trandr2,trandr3,trandr4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"1. DTG as 1st-line\",pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  #lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr1*100,type=\"l\",col=\"violet\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr4*100,type=\"l\",col=\"orange\",lwd=width)\n  abline(v=2018,lty=2,col=\"red\")\n  text(x=2015,y=max(trandr,trandr5,trandr6,trandr7,trandr8)*100*3/4,labels=\"DTG \\n introduction\",cex=2,col=\"red\")\n  mtext(text=\"Level of NNRTI PDR among diagnosed individuals (%)    \",side=2,line=4,cex=cex_t,adj=1)\n  #mtext(text=\"Level of NNRTI PDR\",side=2,line=4,cex=cex_t)\n  \n  \n  #Plot2\n  par(mai=c(0.8,0.8,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  #plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"2. PDR level (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr5,trandr6,trandr7,trandr8)*100,max(trandr,trandr5,trandr6,trandr7,trandr8)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"2. DTG as 1st-line and switch\",pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  #lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr5*100,type=\"l\",col=\"violet\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr6*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr7*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr8*100,type=\"l\",col=\"orange\",lwd=width)\n  abline(v=2018,lty=2,col=\"red\")\n  text(x=2015,y=max(trandr,trandr5,trandr6,trandr7,trandr8)*100*3/4,labels=\"DTG \\n introduction\",cex=2,col=\"red\")\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  #mtext(text=\"Level of NNRTI PDR among diagnosed individuals (%)\",side=2,line=4,cex=cex_t,adj=1)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Baseline model\",scen[1:2]),\n         lty=c(1,1,1),pch=c(NA,NA,NA), lwd=4, col=c(\"black\",\"violet\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = width1,seg.len=0.5,x.intersp = 0.2)\n  \n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(scen[3:4]),\n         lty=c(1,1),pch=c(NA,NA), lwd=4, col=c(\"red\",\"orange\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = width2,seg.len=0.5,x.intersp = 0.2)\n  plot.new()\n  par(lwd=1,mai=c(0,0,0,0))\n  legend(x=\"left\",paste(strwrap(\"Figure 1: Simulated levels of NNRTI pre-treatment drug resistance in South Africa during 2005-2038 as dolutegravir is introduced in 2018 under two scenarios: DTG as first-line regimen for ART-initiators (panel 1) or DTG for all patients (panel 2), and with different restrictions of prescription based on gender. Baseline model shows the situation without the introduction of dolutegravir.\",width=legend_width3*getOption(\"width\")),sep=\"\\n\"),\n         cex=1.8,x.intersp = -1,y.intersp=0.6,box.col=NA)\n}\nfig_slide=function(list_data,scen=c(\"men\", \"men and women not in childbearing age\", \"men and women not in childbearing age or using contraception\",\"men and women\"),cex_t=1.5,cex_l=2,width=4,label=\"Simulations\",i=2,men_women=c(1,2),new_inf=FALSE,text_y=\"Level of NNRTI PDR among diagnosed individuals (%)\",title_1=\"1. DTG for ART naive individuals\",title_2=\"2. DTG for ART-naive and ART-experienced individuals\"){\n  #Datasets 1,2,3,4\n  data=list_data[[1]]\n  data1=list_data[[2]]\n  data2=list_data[[3]]\n  data3=list_data[[4]]\n  data4=list_data[[5]]\n  data5=list_data[[6]]\n  data6=list_data[[7]]\n  data7=list_data[[8]]\n  data8=list_data[[9]]\n  \n  ###################################################################################################################\n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4,5,6),nrow = 6,ncol = 1,byrow = FALSE)\n  graphics::layout(mat = m,heights = c(0.42,0.5,0.04,0.04,0.04,0.04))\n  \n  #Time axis\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  #Data\n  trandr=c(rep(NA,11),rollapply(diff(data[1:tmax,244]),12,sum)/rollapply(diff(data[1:tmax,241]),12,sum))\n  \n  trandr_index=1\n  if(i==2){trandr_index=c(i,12)}\n  trandr=rowSums(data[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr1=rowSums(data1[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data1[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr2=rowSums(data2[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data2[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr3=rowSums(data3[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data3[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr4=rowSums(data4[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data4[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr5=rowSums(data5[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data5[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr6=rowSums(data6[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data6[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr7=rowSums(data7[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data7[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  trandr8=rowSums(data8[seq(1,tmax,1),select_15(trandr_index,1:4,2,men_women)])/rowSums(data8[seq(1,tmax,1),select_15(trandr_index,1:4,1:2,men_women)])\n  \n  if(new_inf){\n    trandr=c(rep(NA,12),rollapply(diff(data[1:tmax,246]),12,sum)/rollapply(diff(data[1:tmax,241]),12,sum))\n    trandr1=c(rep(NA,12),rollapply(diff(data1[1:tmax,246]),12,sum)/rollapply(diff(data1[1:tmax,241]),12,sum))\n    trandr2=c(rep(NA,12),rollapply(diff(data2[1:tmax,246]),12,sum)/rollapply(diff(data2[1:tmax,241]),12,sum))\n    trandr3=c(rep(NA,12),rollapply(diff(data3[1:tmax,246]),12,sum)/rollapply(diff(data3[1:tmax,241]),12,sum))\n    trandr4=c(rep(NA,12),rollapply(diff(data4[1:tmax,246]),12,sum)/rollapply(diff(data4[1:tmax,241]),12,sum))\n    trandr5=c(rep(NA,12),rollapply(diff(data5[1:tmax,246]),12,sum)/rollapply(diff(data5[1:tmax,241]),12,sum))\n    trandr6=c(rep(NA,12),rollapply(diff(data6[1:tmax,246]),12,sum)/rollapply(diff(data6[1:tmax,241]),12,sum))\n    trandr7=c(rep(NA,12),rollapply(diff(data7[1:tmax,246]),12,sum)/rollapply(diff(data7[1:tmax,241]),12,sum))\n    trandr8=c(rep(NA,12),rollapply(diff(data8[1:tmax,246]),12,sum)/rollapply(diff(data8[1:tmax,241]),12,sum))\n  }\n  if(new_inf){text_y=\"Level of NNRTI PDR among newly infected individuals (%)\"}\n  #Plot1\n  par(mai=c(0.2,0.8,0.3,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  #plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"1. PDR level (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr1,trandr2,trandr3,trandr4,na.rm=TRUE)*100,max(trandr,trandr1,trandr2,trandr3,trandr4,na.rm=TRUE)*100),xaxt='n',xlab=\"\",ylab=\"\",main=title_1,pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr1*100,type=\"l\",col=\"violet\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr4*100,type=\"l\",col=\"orange\",lwd=width)\n  abline(v=2018,lty=2,col=\"red\")\n  text(x=2014,y=max(trandr,trandr5,trandr6,trandr7,trandr8,na.rm=TRUE)*100*3/4,labels=\"DTG \\n introduction\",cex=2,col=\"red\")\n  mtext(text=text_y,side=2,line=4,cex=cex_t,adj=1)\n  \n  \n  #Plot2\n  par(mai=c(0.8,0.8,0.3,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  #plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"2. PDR level (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(trandr,trandr5,trandr6,trandr7,trandr8,na.rm=TRUE)*100,max(trandr,trandr5,trandr6,trandr7,trandr8,na.rm=TRUE)*100),xaxt='n',xlab=\"\",ylab=\"\",main=title_2,pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr5*100,type=\"l\",col=\"violet\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr6*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr7*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr8*100,type=\"l\",col=\"orange\",lwd=width)\n  abline(v=2018,lty=2,col=\"red\")\n  text(x=2014,y=max(trandr,trandr5,trandr6,trandr7,trandr8,na.rm=TRUE)*100*3/4,labels=\"DTG \\n introduction\",cex=2,col=\"red\")\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  \n  \n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Baseline model\",\"\"),\n         lty=c(1,NA),pch=c(NA,NA), lwd=c(2,3), col=c(\"black\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.15),seg.len=c(1,1))\n  \n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(scen[1:2]),\n         lty=c(1,1),pch=c(NA,NA), lwd=c(2,2), col=c(\"violet\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.22,0.2),seg.len=c(1,1))\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(scen[3]),\n         lty=c(1),pch=c(NA), lwd=c(2), col=c(\"red\"), box.col=NA,horiz=TRUE,cex=cex_l,seg.len=c(1,1))\n  \n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(scen[4]),\n         lty=c(1),pch=c(NA), lwd=c(2), col=c(\"orange\"), box.col=NA,horiz=TRUE,cex=cex_l,seg.len=c(1,1))\n  \n}\nfigures_dtg_sum=function(list_data){\n#Datasets\ndata=list_data[[1]]\ntmax=dim(data)[1]\n\n#Baseline model\ntrandr_b=sum(data[tmax,select_15(2,1:4,2,1:2)])/sum(data[tmax,select_15(2,1:4,1:2,1:2)])\ndeath_b=sum(diff(data[(13*12+1):tmax,242]))\nnew_inf_b=sum(diff(data[(13*12+1):tmax,241]))\n\n#Scenarios\ntrandr=c()\ndeath=c()\nnew_inf=c()\nfor(i in 1:8){\n  data_i=list_data[[i+1]]\n  trandr[i]=sum(data_i[tmax,select_15(2,1:4,2,1:2)])/sum(data_i[tmax,select_15(2,1:4,1:2,1:2)])\n  death[i]=sum(diff(data_i[(13*12+1):tmax,242]))\n  new_inf[i]=sum(diff(data_i[(13*12+1):tmax,241]))\n}\ntrandr=rep(trandr_b,8)-trandr\ndeath=rep(death_b,8)-death\nnew_inf=rep(new_inf_b,8)-new_inf\n\n#Data death and new infections\nmyd<- data.frame( var2 = rep(c(\"1st-line\",\"1st-line & switch\"),each=2),\n                  samp = rep(c(\"Cumulative number of AIDS-related death averted 2018-2038\",\"Cumulative number of new-infections averted 2018-2038\"),2), \n                  V4=rep(NA,4),V3 = rep(NA,4), V2 = rep(NA,4), V1 = rep(NA,4) )\n\nmyd[myd$var2==\"1st-line\",\"V1\"]=c(death[1],new_inf[1])\nmyd[myd$var2==\"1st-line\",\"V2\"]=c(death[2],new_inf[2])\nmyd[myd$var2==\"1st-line\",\"V3\"]=c(death[3],new_inf[3])\nmyd[myd$var2==\"1st-line\",\"V4\"]=c(death[4],new_inf[4])\nmyd[myd$var2==\"1st-line & switch\",\"V1\"]=c(death[5],new_inf[5])\nmyd[myd$var2==\"1st-line & switch\",\"V2\"]=c(death[6],new_inf[6])\nmyd[myd$var2==\"1st-line & switch\",\"V3\"]=c(death[7],new_inf[7])\nmyd[myd$var2==\"1st-line & switch\",\"V4\"]=c(death[8],new_inf[8])\n\nmeltd<- melt(myd, id.vars=1:2)\n\n#Figure\npar(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\nm <- matrix(c(1,2),nrow = 2,ncol = 1,byrow = TRUE)\nlayout(mat = m,heights = c(0.92,0.08))\n\nplot1<-ggplot(meltd, aes(x = var2, y = value, fill = variable, label = round(value, 1))) +\n  geom_bar(stat = \"identity\", position = position_dodge(width = 0.8), width = 0.6) +\n  facet_grid(samp ~ .,switch = \"y\",  scales = \"free_y\", space = \"free\",labeller=label_wrap_gen(width=30, multi_line=T)) +\n  coord_flip() +\n  scale_fill_manual(\"\",guide=guide_legend(reverse=T),values = c(\"V1\" = \"violet\",\"V2\" = \"blue\",\"V3\" = \"red\",\"V4\"=\"orange\"),labels=c(\"men and women\",\"men, 62% women\",\"men, 17% women\", \"men\")) +\n  geom_text(aes(y = value + 10 * sign(value)), position = position_dodge(width = 0.8), size=4)+\n  theme_bw()+\n  scale_x_discrete(limits = rev(levels(meltd$var2)))+\n  theme(\n    legend.position = \"bottom\",legend.direction=\"horizontal\",\n    strip.placement = \"outside\",\n    #axis.title.x = element_blank(),\n    axis.title.y = element_blank(),\n    # added face and size arguments\n    axis.text.y = element_text(colour=\"black\", size=12),\n    axis.text.x= element_text(size=13),\n    strip.text.y = element_text(size = 10, colour = \"black\", face='bold'),\n    plot.margin = margin(0.1, 0.1, 2, 0.1, \"cm\"))+\n  ylab(\"N (1000)\")\nplot1\n}\n\n##############################################################################################################################\n#Assumptions\n#load params from value_gender4_v3.R and p1, p2 from graphs.R\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\nsource(\"C:/Users/ahauser/Documents/Step2/dtg/value_gender4_v4.R\")\np1=c(rate1_inf=3.318999e+00, rate2_inf=5.440886e-01, rate1_diag=2.736363e+02, rate2_diag=7.710578e+00, rate_treat=1.879695e-03,rate_death=1.632000e-01)\np2=c(rate1_inf=NA, rate2_inf=NA, rate1_diag=NA, rate2_diag=NA, rate_treat=NA,rate_death=NA,q=0.05,rate_ratio=0.5,k1=1,k2=2,k3=2,alpha=2,rate_res=5,rate_susc=125)\n#no treatment interruption\nparams<-within(params,{\n  RateStopTreatFirst=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopSuppFirst=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopFailFirst=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopTreatSecond=4.35/c(Inf,Inf,Inf,Inf) #Assumption : T2 same as T1\n  RateStopSuppSecond=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopFailSecond=4.35/c(Inf,Inf,Inf,Inf)\n})\n#no starting with second-line PI\nparams<-within(params,{\n  #RateDirectTreatSecond=4.35/c(5000,12000,13000,1850)\n  RateTreatSecond=4.35/c(531,427,294,189)*1/5\n  RateDirectTreatSecond=c(0,0,0,0)\n})\n#Resistance parameters\np2[\"alpha\"]=2\np2[\"alpha2\"]=2\n\np2[\"alpha\"]=2.64\np2[\"alpha2\"]=4.9\n\n\n\n##############################################################################################################################\n#1. Run 8 counterfactual scenarios\n##############################################################################################################################\n#different dtg prescription levels in women\ndtg_women1=0.175 #above 50\ndtg_women2=0.63 #above 50 or using contraception\ntreat_dtgb=c(p_w_start=0,p_w_switch=0,rate_first=0,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\ntreat_dtg1=c(p_w_start=0,p_w_switch=0,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\ntreat_dtg2=c(p_w_start=dtg_women1,p_w_switch=0,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\ntreat_dtg3=c(p_w_start=dtg_women2,p_w_switch=0,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\ntreat_dtg4=c(p_w_start=1,p_w_switch=0,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\n#switch also treat and suppressed\ntreat_dtg5=c(p_w_start=0,p_w_switch=0,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg6=c(p_w_start=dtg_women1,p_w_switch=dtg_women1,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg7=c(p_w_start=dtg_women2,p_w_switch=dtg_women2,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg8=c(p_w_start=1,p_w_switch=1,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg_mat=rbind(treat_dtgb,treat_dtg1,treat_dtg2,treat_dtg3,treat_dtg4,treat_dtg5,treat_dtg6,treat_dtg7,treat_dtg8)\n##############################################################################################################################\n#Baseline model: from 2005 to 2018 will be used later\n#load p1 and p2 from graphs.R, load the right mod_dtg\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/parmin4_v3.R\")\nsourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2005.cpp\")\nxstart_dtg_2_2005=xstart_f_dtg_2(p2,treat_dtgb)\ntheta=p1\n#15 compartments\ndata=my_fun10_solver2_dtg_2(xstart_dtg_2_2005,theta,treat_dtgb,params,p2)\nsave(data,file=\"C:/Users/ahauser/Documents/Step2/R_results/data_dtg_2005_2018.RData\")\n#Transform into 18 compartments\ndata_18=matrix(rep(0,dim(data)[1]*298),nrow=dim(data)[1],ncol=298)\ndata_18[,select_18(1:15,1:4,1:2,1:2)]=data[,1:240]\ndata_18[,289:298]=data[,241:250]\nsave(data_18,file=\"C:/Users/ahauser/Documents/Step2/R_results/data_dtg_2005_2018_18comp.RData\")\nfigures_2_dtg_update(data)\n\n##############################################################################################################################\n#Baseline model from 2018 to 2038\nxstart_dtg_2_2018=data[dim(data)[1],]\n#15 stages\nsourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2018.cpp\")\nxstart_b=array(rep(0,240),dim=c(15,4,2,2))\nxstart_b[1:15,1:4,1:2,1:2]=xstart_dtg_2_2018[1:240]\nxstart_b[select_15(12:15,1:4,1:2,2)]=(1-treat_dtgb[1])*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\nxstart_b[select_15(2:5,1:4,1:2,2)]=treat_dtgb[1]*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\nxstart_b=c(xstart_b,xstart_dtg_2_2018[241:250])\ndatab=my_fun10_solver2_dtg_2(xstart_b,theta,treat_dtgb,params,p2)\nrownames(datab)=1:(dim(datab)[1])\ndatab=rbind(data[-dim(data)[1],],datab)\nfigures_2_dtg_update(datab)\n\n#18 stages\nsourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/2018_298.cpp\")\ncomp_time=250\nxstart_b=array(rep(0,288),dim=c(18,4,2,2))\nxstart_b[1:15,1:4,1:2,1:2]=xstart_dtg_2_2018[1:240]\nxstart_b[select_18(12:15,1:4,1:2,2)]=(1-treat_dtgb[1])*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\nxstart_b[select_18(2:5,1:4,1:2,2)]=treat_dtgb[1]*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\nxstart_b=c(xstart_b,xstart_dtg_2_2018[241:250])\ndatab=my_fun10_solver2_dtg_2(xstart_b,theta,treat_dtgb,params,p2,comp_time)\nrownames(datab)=1:(dim(datab)[1])\ndatab=rbind(data_18[-dim(data_18)[1],],datab)\nfigures_2_dtg_update(datab) #data_18 do not capture new inf and death after 2018 as mod_cpp_18 does not save it\n##############################################################################################################################\n#Counterfactual scenarios from 2018 to 2038\nsourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2018.cpp\")\nxstart_dtg_2_2018=data[dim(data)[1],]\ndtg_list=list()\nfor(i in 1:9){\n  xstart=xstart_dtg_2_2018\n  xstart[select_15(2:5,1:4,1:2,2)]=treat_dtg_mat[i,1]*(xstart[select_15(12:15,1:4,1:2,2)])\n  xstart[select_15(12:15,1:4,1:2,2)]=(1-treat_dtg_mat[i,1])*(xstart[select_15(12:15,1:4,1:2,2)])\n  xstart=c(xstart,xstart_dtg_2_2018[241:250])\n  data1=my_fun10_solver2_dtg_2(xstart,theta,treat_dtg_mat[i,],params,p2)\n  rownames(data1)=1:(dim(data1)[1])\n  data1=rbind(data[-dim(data)[1],],data1)\n  dtg_list[[i]]<-data1\n  print(i)\n}\nfigures_dtg_4_update(dtg_list,men_women = 1:2)\nfigures_dtg_4_update(dtg_list,scen=c(\"a) men\",paste(\"b) men,\", dtg_women1*100,\"% women\",sep=\"\"),paste(\"c) men,\", dtg_women2*100,\"% women\",sep=\"\"),\"d) men and women\"),men_women=1:2,new_inf=TRUE)\n\n##############################################################################################################################\n#Counterfactual scenarios from 2018 to 2038\nsourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2018.cpp\")\nxstart_dtg_2_2018=data[dim(data)[1],]\ndtg_list=list()\nfor(i in 1:9){\n  params<-within(params,{\n    RateFailFirstDTG=1/i*4.35/c(2700,2000,980,380)\n    RateTreatToFailFirstDTG=1/i*4.35/c(100,95,65,55)\n  })\n  xstart=xstart_dtg_2_2018\n  xstart[select_15(2:5,1:4,1:2,2)]=treat_dtg_mat[5,1]*(xstart[select_15(12:15,1:4,1:2,2)])\n  xstart[select_15(12:15,1:4,1:2,2)]=(1-treat_dtg_mat[5,1])*(xstart[select_15(12:15,1:4,1:2,2)])\n  xstart=c(xstart,xstart_dtg_2_2018[241:250])\n  data1=my_fun10_solver2_dtg_2(xstart,theta,treat_dtg_mat[5,],params,p2)\n  rownames(data1)=1:(dim(data1)[1])\n  data1=rbind(data[-dim(data)[1],],data1)\n  dtg_list[[i]]<-data1\n  print(i)\n}\n\ntmax=397\ndata1=dtg_list[[1]]\nnew_inf_res_1=rollapply(diff(data1[1:tmax,246]),12,sum)\ndata1=dtg_list[[9]]\nnew_inf_res_2=rollapply(diff(data1[1:tmax,246]),12,sum)\nplot(new_inf_res_1,type=\"l\")\nlines(new_inf_res_2)\n\n\nrollapply(diff(data1[1:tmax,246]),1,sum)/rollapply(diff(data1[1:tmax,241]),1,sum)\n\ninfectious=rowSums(data1[seq(1,tmax,1),select_15(c(1,2,3,5,6,8,9,11,12,13,15),1:4,1:2,1:2)])\ninfectious/rowSums(data1[seq(1,tmax,1),select_15(1:15,1:4,1:2,1:2)])\nrowSums(data1[seq(1,tmax,1),select_15(c(9,11),1:4,1:2,1:2)])/infectious\nrowSums(data1[seq(1,tmax,1),select_15(c(9,11),1:4,2,1:2)])/rowSums(data1[seq(1,tmax,1),select_15(c(9,11),1:4,1:2,1:2)])\nrowSums(data1[seq(1,tmax,1),select_15(c(1,2,3,5,6,8,12,13,15),1:4,2,1:2)])/rowSums(data1[seq(1,tmax,1),select_15(c(1,2,3,5,6,8,12,13,15),1:4,1:2,1:2)])\nrowSums(data1[seq(1,tmax,1),select_15(c(1,2,3,5,6,8,9,11,12,13,15),1:4,2,1:2)])/rowSums(data1[seq(1,tmax,1),select_15(c(1,2,3,5,6,8,9,11,12,13,15),1:4,1:2,1:2)])\n\nfigures_dtg_4_update(dtg_list)\nfigures_dtg_4_update(dtg_list,scen=c(\"a) men\",paste(\"b) men,\", dtg_women1*100,\"% women\",sep=\"\"),paste(\"c) men,\", dtg_women2*100,\"% women\",sep=\"\"),\"d) men and women\"),men_women=1:2,new_inf=TRUE)\n\n\n\n\n\n\n##############################################################################################################################\n#Counterfactual scenarios from 2018 to 2038\nload(\"C:/Users/ahauser/Documents/Step2/R_results/data_dtg_2005_2018.RData\")\nsourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2018.cpp\")\nxstart_dtg_2_2018=data[dim(data)[1],]\ndtg_list=list()\np_dtg=c(1,rep(0.63,4),rep(1,4))\nswitch_fail=c(4,rep(c(0.01,0.1,0.2,1),2))#c(4,rep(c(0.5,1,2,4),2))\nfor(i in 1:9){\n  x=1\n  y=p_dtg[i]\n  z=switch_fail[i]\n  treat_dtg=c(p_w_start=y,p_w_switch=y,rate_first=1,rate_switch=x,p_treat=1,p_supp=1,p_fail=z,delay_first=0,delay_switch=0)\n\n  xstart=xstart_dtg_2_2018\n  xstart[select_15(12:15,1:4,1:2,2)]=(1-treat_dtg[1])*(xstart[select_15(2:5,1:4,1:2,2)]+xstart[select_15(12:15,1:4,1:2,2)])\n  xstart[select_15(2:5,1:4,1:2,2)]=treat_dtg[1]*(xstart[select_15(2:5,1:4,1:2,2)]+xstart[select_15(12:15,1:4,1:2,2)])\n  xstart=c(xstart,xstart_dtg_2_2018[241:250])\n  data1=my_fun10_solver2_dtg_2(xstart,theta,treat_dtg,params,p2)\n  rownames(data1)=1:(dim(data1)[1])\n  data1=rbind(data[-dim(data)[1],],data1)\n  dtg_list[[i]]<-data1\n  print(i)\n}\nfigures_dtg_4_update(dtg_list)\nfigures_dtg_4_update(dtg_list,scen=c(\"a) men\",paste(\"b) men,\", dtg_women1*100,\"% women\",sep=\"\"),paste(\"c) men,\", dtg_women2*100,\"% women\",sep=\"\"),\"d) men and women\"),men_women=1:2,new_inf=TRUE)\n\ndata=dtg_list[[5]]\na=rowSums(data[seq(157,397,12),select_15(c(3,5,6,8,9:11),1:4,2,1:2)])/\n  rowSums(data[seq(157,397,12),select_15(c(3,5,6,8,9:11),1:4,1:2,1:2)])\ndata=dtg_list[[8]]\nb=rowSums(data[seq(157,397,12),select_15(c(3,5,6,8,9:11),1:4,2,1:2)])/\n  rowSums(data[seq(157,397,12),select_15(c(3,5,6,8,9:11),1:4,1:2,1:2)])\na-b\n\n##############################################################################################################################\n#R and C++ procedure time\nsourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/dtg/solvdiff_cpp_dtg_2_2018.cpp\")\nxstart_b[select_15(12:15,1:4,1:2,2)]=(1-treat_dtgb[1])*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\nxstart_b[select_15(2:5,1:4,1:2,2)]=treat_dtgb[1]*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\n\nptm <- proc.time()\ndata=my_fun10_solver2_dtg_2(xstart_dtg_2,theta,treat_dtg8,params,p2)\nproc.time() - ptm\n\nptm <- proc.time()\nout <- lsoda(xstart_dtg_2,times=1:396,func= mod_cpp_dtg_2r, parms = list(p1=theta,treat_dtg=treat_dtg8,parms=params))\nproc.time() - ptm\n\n##############################################################################################################################\n#2. NNRTI resistance according to switching time and level of dtg-eligibility, heatmap\n##############################################################################################################################\n#see heatmap.R (results plot) and heatmap_ub.R (Ubelix simulation)\n\n##############################################################################################################################\n#3. Mortality and NNRTI resistance in other compartments\n##############################################################################################################################\n#Different mortality and resistance rate when varying proportion of dtg-eligible people\ncomp_time=158 #not important, as we don't formally use the advantage of having 18 compartments\nsourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/2018_298.cpp\")\n#level of nnrti resistance in 2025 in different care stages, in men and women,\n#according to percentage x of DTG-eligible women\nnnrti_dtg=function(x,year_obs){\n  treat_dtg=c(p_w_start=x,p_w_switch=x,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\n  t_obs=(year_obs-2018)*12 #when is outcome measured\n  \n  #simulation\n  xstart_b=array(rep(0,288),dim=c(18,4,2,2))\n  xstart_b[1:15,1:4,1:2,1:2]=xstart_dtg_2_2018[1:240]\n  xstart_b[select_18(12:15,1:4,1:2,2)]=(1-treat_dtg[1])*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\n  xstart_b[select_18(2:5,1:4,1:2,2)]=treat_dtg[1]*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\n  xstart_b=c(xstart_b,rep(0,10))\n  data2=my_fun10_solver2_dtg_2(xstart_b,theta,treat_dtg,params,p2,comp_time)\n  rownames(data2)=1:(dim(data2)[1])\n  \n  #outcomes\n  inf=sum(data2[t_obs,select_18(c(1),1:4,2,1:2)])/\n    sum(data2[t_obs,select_18(c(1),1:4,1:2,1:2)])\n  inf_m=sum(data2[t_obs,select_18(c(1),1:4,2,1)])/\n    sum(data2[t_obs,select_18(c(1),1:4,1:2,1)])\n  inf_w=sum(data2[t_obs,select_18(c(1),1:4,2,2)])/\n    sum(data2[t_obs,select_18(c(1),1:4,1:2,2)])\n  diag=sum(data2[t_obs,select_18(c(2,12),1:4,2,1:2)])/\n    sum(data2[t_obs,select_18(c(2,12),1:4,1:2,1:2)])\n  diag_m=sum(data2[t_obs,select_18(c(2,12),1:4,2,1)])/\n    sum(data2[t_obs,select_18(c(2,12),1:4,1:2,1)])\n  diag_w=sum(data2[t_obs,select_18(c(2,12),1:4,2,2)])/\n    sum(data2[t_obs,select_18(c(2,12),1:4,1:2,2)])\n  infectious=sum(data2[t_obs,select_18(c(1,2,3,5,6,8,9,11,12,13,15,16,18),1:4,2,1:2)])/\n    sum(data2[t_obs,select_18(c(1,2,3,5,6,8,9,11,12,13,15,16,18),1:4,1:2,1:2)])\n  infectious_m=sum(data2[t_obs,select_18(c(1,2,3,5,6,8,9,11,12,13,15,16,18),1:4,2,1)])/\n    sum(data2[t_obs,select_18(c(1,2,3,5,6,8,9,11,12,13,15,16,18),1:4,1:2,1)])\n  infectious_w=sum(data2[t_obs,select_18(c(1,2,3,5,6,8,9,11,12,13,15,16,18),1:4,2,2)])/\n    sum(data2[t_obs,select_18(c(1,2,3,5,6,8,9,11,12,13,15,16,18),1:4,1:2,2)])\n  treated=sum(data2[t_obs,select_18(c(3,5,6,8,9,11,13,15,16,18),1:4,2,1:2)])/\n    sum(data2[t_obs,select_18(c(3,5,6,8,9,11,13,15,16,18),1:4,1:2,1:2)])\n  treated_m=sum(data2[t_obs,select_18(c(3,5,6,8,9,11,13,15,16,18),1:4,2,1)])/\n    sum(data2[t_obs,select_18(c(3,5,6,8,9,11,13,15,16,18),1:4,1:2,1)])\n  treated_w=sum(data2[t_obs,select_18(c(3,5,6,8,9,11,13,15,16,18),1:4,2,2)])/\n    sum(data2[t_obs,select_18(c(3,5,6,8,9,11,13,15,16,18),1:4,1:2,2)])\n  \n  return(c(inf,inf_m,inf_w,diag,diag_m,diag_w,infectious,infectious_m,infectious_w,treated,treated_m,treated_w))\n}\n#proportion of people in the different care stages\ncare_dtg=function(x){\n    treat_dtg=c(p_w_start=x,p_w_switch=x,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\n    \n    #simulations\n    xstart_b=array(rep(0,288),dim=c(18,4,2,2))\n    xstart_b[1:15,1:4,1:2,1:2]=xstart_dtg_2_2018[1:240]\n    xstart_b[select(12:15,1:4,1:2,2)]=(1-treat_dtg[1])*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\n    xstart_b[select(2:5,1:4,1:2,2)]=treat_dtg[1]*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\n    xstart_b=c(xstart_b,rep(0,10))\n    data2=my_fun10_solver2_dtg_2(xstart_b,theta,treat_dtg,params,p2,comp_time)\n    rownames(data2)=1:(dim(data2)[1])\n    \n    #outcomes\n    inf=sum(data2[dim(data2)[1],select_18(c(1),1:4,1:2,1:2)])/\n      sum(data2[dim(data2)[1],select_18(c(1,2,3,5,6,8,9,11,12,13,15,16,18),1:4,1:2,1:2)])\n    diag=sum(data2[dim(data2)[1],select_18(c(2),1:4,1:2,1:2)])/\n      sum(data2[dim(data2)[1],select_18(c(1,2,3,5,6,8,9,11,12,13,15,16,18),1:4,1:2,1:2)])\n    treat=sum(data2[dim(data2)[1],select_18(c(c(3,5,6,8,9,11,12,13,15,16,18)),1:4,1:2,1:2)])/\n      sum(data2[dim(data2)[1],select_18(c(1,2,3,5,6,8,9,11,12,13,15,16,18),1:4,1:2,1:2)])\n    return(c(inf,diag,treat))\n}\n#resistance in the newly diagnosed ineligible women\nres_dtg=function(x){\n  treat_dtg=c(p_w_start=x,p_w_switch=x,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\n \n  #simulation\n  xstart_b=array(rep(0,288),dim=c(18,4,2,2))\n  xstart_b[1:15,1:4,1:2,1:2]=xstart_dtg_2_2018[1:240]\n  xstart_b[select(12:15,1:4,1:2,2)]=(1-treat_dtg[1])*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\n  xstart_b[select(2:5,1:4,1:2,2)]=treat_dtg[1]*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\n  xstart_b=c(xstart_b,rep(0,10))\n  data2=my_fun10_solver2_dtg_2(xstart_b,theta,treat_dtg,params,p2,comp_time)\n  rownames(data2)=1:(dim(data2)[1])\n  \n  #outcomes\n  nnrti_2035=diff(data2[200:201,289:296]) #give the number of newly diagnosed women not eligible for dtg per cd4 and resistance (matrix[cd4,res] -> vector(8))\n  res_2035=sum(nnrti_2035[5:8])/sum(nnrti_2035[1:8]) #give the percentage of resistance in newly diagnosed women not dtg eligible per cd4\n\n  return(list(nnrti_2035,res_2035))\n}\n#mortality\nmort_dtg=function(x,data_18,comp_time){\n  dtg_p=x\n  treat_dtg=c(p_w_start=dtg_p,p_w_switch=dtg_p,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\n  \n  #simulations\n  xstart_b=array(rep(0,288),dim=c(18,4,2,2))\n  xstart_b[1:15,1:4,1:2,1:2]=xstart_dtg_2_2018[1:240]\n  xstart_b[select(12:15,1:4,1:2,2)]=(1-treat_dtg[1])*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\n  xstart_b[select(2:5,1:4,1:2,2)]=treat_dtg[1]*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\n  xstart_b=c(xstart_b,xstart_dtg_2_2018[241:250])\n  data2=my_fun10_solver2_dtg_2(xstart_b,theta,treat_dtg,params,p2,comp_time)\n  rownames(data2)=1:(dim(data2)[1])\n  \n  #outcomes\n  tmax=dim(data2)[1]\n  mort1=sum(diff(data2[(comp_time):tmax,298]))\n  res=rowSums(data2[seq(157,tmax,12),select(c(12),1:4,2,2)])/rowSums(data2[seq(157,tmax,12),select(c(12),1:4,1:2,2)])\n  cd4=rowSums(data2[seq(157,tmax,12),select(c(16),4,1:2,2)])/rowSums(data2[seq(157,tmax,12),select(c(16),1:4,1:2,2)])\n  \n  return(list(mort1,res,cd4))\n}\n\n#-------------------------------------------------------------------------------------------\n#Simulations\n#nnrti_dtg\nmat2=matrix(0,11,12)\nfor(i in seq(0,1,by=0.1)){\n  mat2[i*10+1,]=as.vector(nnrti_dtg(i,2025))\n  print(i)\n}\n\n#care_dtg\nfor(i in seq(0,1,by=0.1)){\n  print(as.vector(care_dtg(i)))\n  print(i)\n}\n\n#mort_dtg\nnnrti_2035=list()\nres_2035=c()\nfor(i in 0:10){\n  print(i*0.095)\n  mort=mort_dtg(i*0.095)\n  nnrti_2035[[i+1]]=mort[[1]]\n  res_2035[i+1]=mort[[2]]\n  print(nnrti_2035)\n  print(res_2035)\n}\n\n#-------------------------------------------------------------------------------------------\n#Plots\nnnrti_res_dtg_plot=function(mat1){\n  par(mfrow = c(1,1),lwd=2,oma=c(0.1,0.1,0.1,0.1))\n  mtext(text=\"                                NNRTI resistance level (in %)\",side=2,line=3,cex=1,adj=1)\n  m <- matrix(c(1,2,3,4,5,5,5,5,6,6,6,6),nrow = 3,ncol = 4,byrow = TRUE)\n  graphics::layout(mat = m,heights = c(1,0.1,0.15),widths=c(1,1,1,1))\n  # m <- matrix(c(1,2,3,4,4,4),nrow = 2,ncol = 3,byrow = TRUE)\n  # layout(mat = m,heights = c(0.8,0.15),widths=c(0.3,0.3,0.3))\n  title=c(\"B. Undiagnosed\",\"C. Diagnosed\\n untreated\",\"A. Total\\n infectious\",\"D. on ART,\\n infectious\")\n  #Plot1\n  for(i in c(3,1,2,4)){\n    par(mai=c(0.2,0.3,0.3,0)*2)\n    if(i==3){\n      par(mai=c(0.2,0.4,0.3,0)*2)\n    }\n    if(i==4){\n      par(mai=c(0.2,0.3,0.3,0.05)*2)\n    }\n    plot(seq(0,1,by=0.1)*100,mat1[1:11,(i-1)*3+2],type=\"l\",cex.axis=2,cex.main=2,main=title[i],ylab=\"\",ylim=c(0,100),lwd=4,xaxt=\"n\")\n    lines(seq(0,1,by=0.1)*100,mat1[1:11,(i-1)*3+3],type=\"l\",col=\"red\",ylim=c(0,100),lwd=4)\n    ticks=c(0,50,100)\n    axis(1,at=ticks,labels=ticks,cex.axis=2)\n    if(i==3 ){\n      mtext(text=\"NNRTI resistance level (%)\",side=2,line=4,cex=1.5,adj=1)\n    }\n    if(i==2){\n      mtext(text=\"% DTG-eligible women\",side=1,line=4,cex=1.5,adj=1)\n    }\n  }\n  par(mai=c(0,0,0,0)*0)\n  plot.new()\n  plot.new()\n legend(x=\"bottom\", inset =0,\n         c(\"Men\",\"Women\"),\n         lty=c(1,1,NA),lwd=c(4,4), col=c(\"black\",\"red\"), box.col=NA,horiz=TRUE,pt.cex=1,cex=2,text.width = c(0.15,0.15))\n}\nnnrti_res_dtg_plot=function(mat1){\n  par(mfrow = c(1,1),lwd=2,oma=c(0.2,0.2,0.2,0.2))\n  mtext(text=\"                                NNRTI resistance level (in %)\",side=2,line=3,cex=1,adj=1)\n  m <- matrix(c(1,2,3,4,5,5,6,6),nrow = 4,ncol = 2,byrow = TRUE)\n  graphics::layout(mat = m,heights = c(1,1,0.1,0.2),widths=c(1,1,1,1))\n  # m <- matrix(c(1,2,3,4,4,4),nrow = 2,ncol = 3,byrow = TRUE)\n  # layout(mat = m,heights = c(0.8,0.15),widths=c(0.3,0.3,0.3))\n  title=c(\"B. Undiagnosed\",\"C. Diagnosed\\n untreated\",\"A. Total\\n infectious\",\"D. on ART,\\n infectious\")\n  #Plot1\n  for(i in c(3,1,2,4)){\n    par(mai=c(0.2,0.3,0.3,0.1)*2)\n    if(i==3 || i==2){\n      par(mai=c(0.2,0.4,0.3,0.1)*2)\n    }\n    if(i==4){\n      par(mai=c(0.2,0.3,0.3,0.1)*2)\n    }\n    plot(seq(0,1,by=0.1)*100,mat1[1:11,(i-1)*3+2],type=\"l\",cex.axis=2,cex.main=2,main=title[i],ylab=\"\",ylim=c(0,100),lwd=4,xaxt=\"n\")\n    lines(seq(0,1,by=0.1)*100,mat1[1:11,(i-1)*3+3],type=\"l\",col=\"red\",ylim=c(0,100),lwd=4)\n    ticks=c(0,50,100)\n    axis(1,at=ticks,labels=ticks,cex.axis=2)\n    if(i==3 ){\n      mtext(text=\"NNRTI resistance level (%)         \",side=2,line=3,cex=1.5,adj=1)\n    }\n    if(i==2){\n      mtext(text=\"        % DTG-eligible women\",at=c(100),side=1,line=4,cex=1.5)\n    }\n  }\n  par(mai=c(0,0,0,0)*0)\n  plot.new()\n  plot.new()\n  legend(x=\"bottom\", inset =0,\n         c(\"Men\",\"Women\"),\n         lty=c(1,1,NA),lwd=c(4,4), col=c(\"black\",\"red\"), box.col=NA,horiz=TRUE,pt.cex=1,cex=2,text.width = c(0.15,0.15))\n}\nnnrti_res_dtg_plot(mat2*100)\n\n##############################################################################################################################\n##############################################################################################################################\n##############################################################################################################################\n##############################################################################################################################\n##############################################################################################################################\n##############################################################################################################################\n#Additional scenarios\n#DTG to ART initiators and to switch\n#Baseline model\ntreat_dtgb=c(p_w_start=0,p_w_switch=0,rate_first=0,rate_switch=0,p_treat=0,p_supp=0,p_fail=1,delay_first=0,delay_switch=0)\n#Only treat first with DTG no switch to DTG\ntreat_dtg1=c(p_w_start=0,p_w_switch=0,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg2=c(p_w_start=0.5,p_w_switch=0.5,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg3=c(p_w_start=1,p_w_switch=1,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=1,delay_first=0,delay_switch=0)\n#switch\ntreat_dtg4=c(p_w_start=0,p_w_switch=0,rate_first=0,rate_switch=1,p_treat=0,p_supp=0,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg5=c(p_w_start=0,p_w_switch=0.5,rate_first=0,rate_switch=1,p_treat=0,p_supp=0,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg6=c(p_w_start=0,p_w_switch=1,rate_first=0,rate_switch=1,p_treat=0,p_supp=0,p_fail=1,delay_first=0,delay_switch=0)\n#Treat First and switch\ntreat_dtg7=c(p_w_start=0,p_w_switch=0,rate_first=1,rate_switch=1,p_treat=0,p_supp=0,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg8=c(p_w_start=0.5,p_w_switch=0.5,rate_first=1,rate_switch=1,p_treat=0,p_supp=0,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg9=c(p_w_start=1,p_w_switch=1,rate_first=1,rate_switch=1,p_treat=0,p_supp=0,p_fail=1,delay_first=0,delay_switch=0)\n\n\n#------------------------------------------------------------------------------------------------------------------\n#DTG to ART initiators and to switch\ntreat_dtg1=c(p_w_start=0,p_w_switch=0,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\ntreat_dtg2=c(p_w_start=0.5,p_w_switch=0.5,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\ntreat_dtg3=c(p_w_start=1,p_w_switch=1,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\n#switch also treat and suppressed\ntreat_dtg4=c(p_w_start=0,p_w_switch=0,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg5=c(p_w_start=0.5,p_w_switch=0.5,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg6=c(p_w_start=1,p_w_switch=1,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\n\n#Scenarios for CROI abstract\n#DTG to ART initiators and to switch\ndtg_women1=0.175\ndtg_women2=0.62\ntreat_dtg1=c(p_w_start=0,p_w_switch=0,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\ntreat_dtg2=c(p_w_start=dtg_women1,p_w_switch=dtg_women1,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\ntreat_dtg3=c(p_w_start=dtg_women2,p_w_switch=dtg_women2,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\ntreat_dtg4=c(p_w_start=1,p_w_switch=1,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\n#switch also treat and suppressed\ntreat_dtg5=c(p_w_start=0,p_w_switch=0,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg6=c(p_w_start=dtg_women1,p_w_switch=dtg_women1,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg7=c(p_w_start=dtg_women2,p_w_switch=dtg_women2,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg8=c(p_w_start=1,p_w_switch=1,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\n\nfigures_scen(list(datab,data1,data2,data3),scen=c(\"a) men\",\"b) men, 50% women\",\"c) men and women\"),label=\"DTG only to treatment naive, failing 1st-line\")\nfigures_scen(list(datab,data4,data5,data6),scen=c(\"a) men\",\"b) men, 50% women\",\"c) men and women\"),label=\"DTG only to treatment naive failing and suppressed on 1st-line\")\n\ntrandr=rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\ntrandr1=rowSums(data1[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data1[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\ntrandr2=rowSums(data2[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\ntrandr3=rowSums(data3[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\ntrandr4=rowSums(data4[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\ntrandr5=rowSums(data5[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data5[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\ntrandr6=rowSums(data6[seq(1,tmax,1),select_dtg(c(i),1:4,2,1:2)])/rowSums(data6[seq(1,tmax,1),select_dtg(c(i),1:4,1:2,1:2)])\n\n(trandr-trandr1)[397]\n(trandr-trandr2)[397]\n(trandr-trandr3)[397]\n(trandr-trandr4)[397]\n(trandr-trandr5)[397]\n(trandr-trandr6)[397]\n\nfigures_dtg_3(list(data,data1,data2,data3,data4,data5,data6),scen=c(\"a) men\",\"b) men, 50% women\",\"c) men and women\"))\n\nfigures_dtg_4(list(datab,data1,data2,data3,data4,data5,data6,data7,data8),scen=c(\"a) men\",paste(\"b) men,\", dtg_women1*100,\"% women\",sep=\"\"),paste(\"c) men,\", dtg_women2*100,\"% women\",sep=\"\"),\"d) men and women\"))\nfigures_dtg_4_2(list(datab,data1,data2,data3,data4,data5,data6,data7,data8),scen=c(\"a) men\", \"b) men and women not in childbearing age\",\"c) men and women not in childbearing age or using contraception\",\"d) men and women\"),width1=c(0.15,0.18,0.16),width2=c(0,0.7),width=5,legend_width3=0.8)\n#inch 12x10\n#------------------------------------------------------------------------------------------------------------------\n#DTG to ART initiators\ntreat_dtg1=c(p_w_start=0,p_w_switch=0,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\ntreat_dtg2=c(p_w_start=0.5,p_w_switch=0.5,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\ntreat_dtg3=c(p_w_start=1,p_w_switch=1,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\n#DTG to ART initiators and to fail\ntreat_dtg4=c(p_w_start=0,p_w_switch=0,rate_first=1,rate_switch=1,p_treat=0,p_supp=0,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg5=c(p_w_start=0.5,p_w_switch=0.5,rate_first=1,rate_switch=1,p_treat=0,p_supp=0,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg6=c(p_w_start=1,p_w_switch=1,rate_first=1,rate_switch=1,p_treat=0,p_supp=0,p_fail=1,delay_first=0,delay_switch=0)\n#DTG to ART initiators and to all NNRTI-treated\ntreat_dtg7=c(p_w_start=0,p_w_switch=0,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg8=c(p_w_start=0.5,p_w_switch=0.5,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg9=c(p_w_start=1,p_w_switch=1,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\n#delay\ntreat_dtg10=c(p_w_start=0.5,p_w_switch=0.5,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg11=c(p_w_start=0.5,p_w_switch=0.5,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=2,delay_switch=2)\ntreat_dtg12=c(p_w_start=0.5,p_w_switch=0.5,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=4,delay_switch=4)\n\n#Figure\nfigures_scen(list(datab,data1,data2,data3),scen=c(\"1.men\",\"2.men,50% women\",\"3.men and women\"),label=\"DTG only to treatment naive, failing 1st-line\")\nfigures_scen(list(datab,data4,data5,data6),scen=c(\"4.men\",\"5.men,50% women\",\"6.men and women\"),label=\"DTG only to treatment naive failing 1st-line\")\nfigures_scen(list(datab,data7,data8,data9),scen=c(\"7.men\",\"8.men,50% women\",\"9.men and women\"),label=\"DTG only to treatment naive failing and suppressed on 1st-line\")\nfigures_scen(list(datab,data10,data11,data12),scen=c(\"10.no delay\",\"11. 2 years\",\"12. 4 years\"),label=\"DTG to treatment naive and 1st-line failing individuals\")\n\nfigures_dtg_scen(list(datab,data1,data2,data3),scen=c(\"1.men\",\"2.men,50% women\",\"3.men and women\"),label=\"DTG only to treatment naive, failing 1st-line\")\nfigures_dtg_scen(list(datab,data4,data5,data6),scen=c(\"4.men\",\"5.men,50% women\",\"6.men and women\"),label=\"DTG to 1st-line failing individuals\")\nfigures_dtg_scen(list(datab,data7,data8,data9),scen=c(\"7.men\",\"8.men,50% women\",\"9.men and women\"),label=\"DTG to treatment naive and 1st-line failing individuals\")\nfigures_dtg_scen(list(datab,data10,data11,data12),scen=c(\"10.no delay\",\"11. 2 years\",\"12. 4 years\"),label=\"DTG to treatment naive and 1st-line failing individuals\")\n\n",
    "created" : 1551285103627.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "15|82|107|0|\n108|305|205|0|\n207|61|298|0|\n299|63|390|0|\n391|125|519|0|\n520|129|649|0|\n650|124|781|0|\n782|134|868|0|\n869|197|957|0|\n958|412|1065|0|\n1066|36|1131|0|\n1353|31|1393|0|\n1395|21|1415|0|\n1417|20|1434|0|\n1436|39|1456|0|\n1487|34|1521|0|\n1522|34|1556|0|\n",
    "hash" : "3867240734",
    "id" : "E3F12B2E",
    "lastKnownWriteTime" : 1559127037,
    "last_content_update" : 1559127037415,
    "path" : "~/Step2/dtg/dtg.R",
    "project_path" : "dtg.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}