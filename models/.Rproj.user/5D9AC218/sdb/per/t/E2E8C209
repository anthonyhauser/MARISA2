{
    "collab_server" : "",
    "contents" : "library(deSolve)\nlibrary(zoo)\nlibrary(\"Rcpp\")\nlibrary(\"BH\")\n\n##############################################################################################################################\n#Assumptions\n#load params from value_gender4_v3.R and p1, p2 from graphs.R\n#source(\"C:/Users/ahauser/Documents/Step2/dtg/value_gender4_v4.R\")\nsource(\"value_gender4_v4.R\")\np1=c(rate1_inf=3.318999e+00, rate2_inf=5.440886e-01, rate1_diag=2.736363e+02, rate2_diag=7.710578e+00, rate_treat=1.879695e-03,rate_death=1.632000e-01)\np2=c(rate1_inf=NA, rate2_inf=NA, rate1_diag=NA, rate2_diag=NA, rate_treat=NA,rate_death=NA,q=0.05,rate_ratio=0.5,k1=1,k2=2,k3=2,alpha=2,rate_res=5,rate_susc=125)\n#no treatment interruption\nparams<-within(params,{\n  RateStopTreatFirst=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopSuppFirst=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopFailFirst=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopTreatSecond=4.35/c(Inf,Inf,Inf,Inf) #Assumption : T2 same as T1\n  RateStopSuppSecond=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopFailSecond=4.35/c(Inf,Inf,Inf,Inf)\n})\n#no starting with second-line PI\nparams<-within(params,{\n  #RateDirectTreatSecond=4.35/c(5000,12000,13000,1850)\n  RateTreatSecond=4.35/c(531,427,294,189)*1/5\n  RateDirectTreatSecond=c(0,0,0,0)\n})\n#Resistance parameters\np2[\"alpha\"]=2\np2[\"alpha2\"]=2\n\np2[\"alpha\"]=2.64\np2[\"alpha2\"]=4.9\n\n##############################################################################################################################\n#different dtg prescription levels in women\ndtg_women1=0.175 #above 50\ndtg_women2=0.63 #above 50 or using contraception\ntreat_dtgb=c(p_w_start=0,p_w_switch=0,rate_first=0,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\ntreat_dtg1=c(p_w_start=0,p_w_switch=0,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\ntreat_dtg2=c(p_w_start=dtg_women1,p_w_switch=0,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\ntreat_dtg3=c(p_w_start=dtg_women2,p_w_switch=0,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\ntreat_dtg4=c(p_w_start=1,p_w_switch=0,rate_first=1,rate_switch=0,p_treat=0,p_supp=0,p_fail=0,delay_first=0,delay_switch=0)\n#switch also treat and suppressed\ntreat_dtg5=c(p_w_start=0,p_w_switch=0,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg6=c(p_w_start=dtg_women1,p_w_switch=dtg_women1,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg7=c(p_w_start=dtg_women2,p_w_switch=dtg_women2,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg8=c(p_w_start=1,p_w_switch=1,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg9=c(p_w_start=0.99,p_w_switch=0.99,rate_first=1,rate_switch=1,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\ntreat_dtg_mat=rbind(treat_dtgb,treat_dtg1,treat_dtg2,treat_dtg3,treat_dtg4,treat_dtg5,treat_dtg6,treat_dtg7,treat_dtg8,treat_dtg9)\n\n##############################################################################################################################\n#Functions and dataset\n# source(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/parmin4_v3.R\")\n# sourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2018.cpp\")\n# load(\"C:/Users/ahauser/Documents/Step2/R_results/params.set.RData\")\n# load(\"C:/Users/ahauser/Documents/Step2/R_results/data_dtg_2005_2018.RData\")\nsource(\"parmin4_v3.R\")\n#sourceCpp(\"solvdiff_cpp_dtg_2_2018.cpp\")\nload(\"params.set.RData\")\n#load(\"data_dtg_2005_2018.RData\") #load data\n#xstart_dtg_2_2018=data[dim(data)[1],]\n#ARGS\nargs=(commandArgs(TRUE))\nargs=as.numeric(unlist(args))\nprint(args)\n\n\nparams.set=rbind(c(5,125,2,1,0.05,8/3,1,1),params.set)\ndata_sens=function(params.set,p1,p2,parms,scen,j){\n  \n    #Changing parameters according to sensitivity matrix params.set\n    p2[c(\"rate_res\",\"rate_susc\")]=params.set[j,1:2]\n    p2[c(\"alpha\",\"alpha2\")]=c(2.64,4.9)*(params.set[j,3]/2) #we divide by 2 as params.set[,3] goes from 1 to 5 (as alpha equalled 2)\n    parms1=parms\n    parms1<-within(parms,{\n      # RateStopTreatFirst=4.35/c(1800,1400,750,680)*params.set[j,4]\n      # RateStopSuppFirst=4.35/c(9000,5400,3300,1600)*params.set[j,4]\n      # RateStopFailFirst=4.35/c(2700,2080,1240,560)*params.set[j,4]\n      # RateStopTreatSecond=4.35/c(1800,1400,750,680)*params.set[j,4] #Assumption : T2 same as T1\n      # RateStopSuppSecond=4.35/c(9000,5400,3300,1600)*params.set[j,4] #Assumption : S2 same as S1\n      # RateStopFailSecond=4.35/c(2700,2080,1240,560)*params.set[j,4]\n\n      #Relax this assumption as a next step\n      RateStopTreatFirst=4.35/c(Inf,Inf,Inf,Inf)*params.set[j,4]\n      RateStopSuppFirst=4.35/c(Inf,Inf,Inf,Inf)*params.set[j,4]\n      RateStopFailFirst=4.35/c(Inf,Inf,Inf,Inf)*params.set[j,4]\n      RateStopTreatSecond=4.35/c(Inf,Inf,Inf,Inf)*params.set[j,4] #Assumption : T2 same as T1\n      RateStopSuppSecond=4.35/c(Inf,Inf,Inf,Inf)*params.set[j,4] #Assumption : S2 same as S1\n      RateStopFailSecond=4.35/c(Inf,Inf,Inf,Inf)*params.set[j,4]\n\n      RateTransm=c(params.set[j,6]*params.set[j,5]*params.set[j,7],\n                   1-params.set[j,5],\n                   1-params.set[j,5],\n                   0)*0.003*(0.05*(0.008/0.003)*1+2*(1-0.05))*\n        (1/(params.set[j,5]*params.set[j,6]*params.set[j,7]+2*(1-params.set[j,5])))\n\n\n      RateSuppFirstDTG=4.35/c(30,30,31,34)*params.set[j,8]\n      RateFailToSuppFirstDTG=4.35/c(10,56,24,51)*params.set[j,8]\n      #factor to keep the same total number of new infected when changing hiv prevalence/risk among msm and msm prop\n    })\n    \n    #Simulate the Baseline model (with no sensitivity variation)\n    #To 2019\n    #sourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2005.cpp\")\n    sourceCpp(\"solvdiff_cpp_dtg_2_2005.cpp\")\n    xstart_dtg_2_2005=xstart_f_dtg_2(p2,treat_dtgb)\n    theta=p1\n    data=my_fun10_solver2_dtg_2(xstart_dtg_2_2005,theta,treat_dtgb,parms1,p2)\n    print(sum(data[14*12+1,select_15(c(2,12),1:4,2,1:2)])/sum(data[14*12+1,select_15(c(2,12),1:4,1:2,1:2)]))\n    #To 2039\n    #sourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2019.cpp\")\n    sourceCpp(\"solvdiff_cpp_dtg_2_2019.cpp\")\n    xstart_dtg_2_2018=data[dim(data)[1],]\n    xstart=xstart_dtg_2_2018\n    \n    print(treat_dtg_mat[scen,1])\n    \n    xstart[select_15(12:15,1:4,1:2,2)]=(1-treat_dtg_mat[scen,1])*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\n    xstart[select_15(2:5,1:4,1:2,2)]=treat_dtg_mat[scen,1]*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\n    xstart=c(xstart,xstart_dtg_2_2018[241:250])\n    \n    print(sum(xstart[select_15(2:5,1:4,1:2,2)]))\n    \n    data1=my_fun10_solver2_dtg_2(xstart,theta,treat_dtg_mat[scen,],parms1,p2)\n    rownames(data1)=1:(dim(data1)[1])\n    \n    print(sum(data1[14*12+1,select_15(c(2,12),1:4,2,1:2)])/sum(data1[14*12+1,select_15(c(2,12),1:4,1:2,1:2)]))\n    \n    data1=rbind(data[-dim(data)[1],],data1)\n    \n    return(data1)\n}\n\n# args=c(1,1)\n# data=data_sens(params.set,p1,p2,params,args[1],args[2])\n# sum(data[30*12+1,select_15(c(2,12),1:4,2,1:2)])/sum(data[30*12+1,select_15(c(2,12),1:4,1:2,1:2)])\n\n#Results\ndata1=data_sens(params.set,p1,p2,params,args[1],args[2])\nsave(data1,file=\"data1.RData\")\n\n\n\n\n\n#Function used when we did job with 1 array for scen, no additionall array for sens of length 201\n#Function sensitivity\n# data_sens=function(params.set,p1,p2,parms,scen){\n#   data_list=list()\n#   print(\"ok-1\")\n#   #Simulate the Baseline model (with no sensitivity variation)\n#   #To 2018\n#   sourceCpp(\"solvdiff_cpp_dtg_2_2005.cpp\")\n#   #sourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2005.cpp\")\n#   xstart_dtg_2_2005=xstart_f_dtg_2(p2,treat_dtgb)\n#   theta=p1\n#   print(xstart_dtg_2_2005)\n#   data=my_fun10_solver2_dtg_2(xstart_dtg_2_2005,theta,treat_dtgb,params,p2)\n#   print(\"ok-2\")\n#   #To 2038\n#   #sourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2018.cpp\")\n#   sourceCpp(\"solvdiff_cpp_dtg_2_2018.cpp\")\n#   xstart_dtg_2_2018=data[dim(data)[1],]\n#   xstart=xstart_dtg_2_2018\n#   xstart[select_15(2:5,1:4,1:2,2)]=treat_dtg_mat[scen,1]*(xstart[select_15(12:15,1:4,1:2,2)])\n#   xstart[select_15(12:15,1:4,1:2,2)]=(1-treat_dtg_mat[scen,1])*(xstart[select_15(12:15,1:4,1:2,2)])\n#   xstart=c(xstart,xstart_dtg_2_2018[241:250])\n#   data1=my_fun10_solver2_dtg_2(xstart,theta,treat_dtg_mat[scen,],params,p2)\n#   rownames(data1)=1:(dim(data1)[1])\n#   data1=rbind(data[-dim(data)[1],],data1)\n#   #Save data\n#   data_list[[1]]=data1\n#   \n#   \n#   h2=dim(params.set)[1]\n#   for(j in 1:h2){\n#     \n#     #Changing parameters according to sensitivity matrix params.set\n#     p2[c(\"rate_res\",\"rate_susc\",\"alpha\")]=params.set[j,1:3]\n#     parms1<-within(parms,{\n#       # RateStopTreatFirst=4.35/c(1800,1400,750,680)*params.set[j,4]\n#       # RateStopSuppFirst=4.35/c(9000,5400,3300,1600)*params.set[j,4]\n#       # RateStopFailFirst=4.35/c(2700,2080,1240,560)*params.set[j,4]\n#       # RateStopTreatSecond=4.35/c(1800,1400,750,680)*params.set[j,4] #Assumption : T2 same as T1\n#       # RateStopSuppSecond=4.35/c(9000,5400,3300,1600)*params.set[j,4] #Assumption : S2 same as S1\n#       # RateStopFailSecond=4.35/c(2700,2080,1240,560)*params.set[j,4]\n#       \n#       #Relax this assumption as a next step\n#       RateStopTreatFirst=4.35/c(Inf,Inf,Inf,Inf)*params.set[j,4]\n#       RateStopSuppFirst=4.35/c(Inf,Inf,Inf,Inf)*params.set[j,4]\n#       RateStopFailFirst=4.35/c(Inf,Inf,Inf,Inf)*params.set[j,4]\n#       RateStopTreatSecond=4.35/c(Inf,Inf,Inf,Inf)*params.set[j,4] #Assumption : T2 same as T1\n#       RateStopSuppSecond=4.35/c(Inf,Inf,Inf,Inf)*params.set[j,4] #Assumption : S2 same as S1\n#       RateStopFailSecond=4.35/c(Inf,Inf,Inf,Inf)*params.set[j,4]\n#       \n#       RateTransm=c(params.set[j,6]*params.set[j,5]*params.set[j,7],\n#                    1-params.set[j,5],\n#                    1-params.set[j,5],\n#                    0)*0.003*(0.05*(0.008/0.003)*1+2*(1-0.05))*\n#         (1/(params.set[j,5]*params.set[j,6]*params.set[j,7]+2*(1-params.set[j,5])))\n#       \n#       \n#       RateSuppFirstDTG=4.35/c(30,30,31,34)*params.set[j,8]\n#       RateFailToSuppFirstDTG=4.35/c(10,56,24,51)*params.set[j,8]\n#       #factor to keep the same total number of new infected when changing hiv prevalence/risk among msm and msm prop\n#     })\n#     \n#     #Simulate the Baseline model (with no sensitivity variation)\n#     #To 2018\n#     #sourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2005.cpp\")\n#     sourceCpp(\"solvdiff_cpp_dtg_2_2005.cpp\")\n#     xstart_dtg_2_2005=xstart_f_dtg_2(p2,treat_dtgb)\n#     theta=p1\n#     data=my_fun10_solver2_dtg_2(xstart_dtg_2_2005,theta,treat_dtgb,params,p2)\n#     #To 2038\n#     #sourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2018.cpp\")\n#     sourceCpp(\"solvdiff_cpp_dtg_2_2018.cpp\")\n#     xstart_dtg_2_2018=data[dim(data)[1],]\n#     xstart=xstart_dtg_2_2018\n#     xstart[select_15(2:5,1:4,1:2,2)]=treat_dtg_mat[scen,1]*(xstart[select_15(12:15,1:4,1:2,2)])\n#     xstart[select_15(12:15,1:4,1:2,2)]=(1-treat_dtg_mat[scen,1])*(xstart[select_15(12:15,1:4,1:2,2)])\n#     xstart=c(xstart,xstart_dtg_2_2018[241:250])\n#     data1=my_fun10_solver2_dtg_2(xstart,theta,treat_dtg_mat[scen,],params,p2)\n#     rownames(data1)=1:(dim(data1)[1])\n#     data1=rbind(data[-dim(data)[1],],data1)\n#     data_list[[j+1]]=data1\n#     \n#     if(j%%5==0){\n#       print(j)\n#     }\n#   }\n#   return(data_list)\n# }",
    "created" : 1555402481100.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "69|50|133|0|\n",
    "hash" : "548769154",
    "id" : "E2E8C209",
    "lastKnownWriteTime" : 1560328089,
    "last_content_update" : 1560341768594,
    "path" : "~/Step2/dtg/dtg_sens_ub.R",
    "project_path" : "dtg_sens_ub.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 5,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}