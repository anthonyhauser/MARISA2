{
    "collab_server" : "",
    "contents" : "#sourceCpp(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/solvdiff_cpp.cpp\")\n#in Ubelix\n#sourceCpp(\"solvdiff_cpp.cpp\")\n\nselect=function(r1,r2,r3,r4){\n  l1=8\n  l2=4\n  l3=2\n  l4=2\n  ar=array(1:(l1*l2*l3*l4),dim=c(l1,l2,l3,l4))\n  return(as.vector(ar[r1,r2,r3,r4]))\n}\n\nmod =function(t,x,parms,p){\n  #mod =function(t,x, params){\n  with(as.list(parms), {\n    S=x[(length(x)-1):length(x)]\n    x=x[1:(64*2)]\n    \n    ##################################################################################################################\n    #Optimization\n    rate1_inf <- p[1] #number of unprotected sexual acts/month\n    rate2_inf <- p[2]\n    rate1_diag <- p[3] #diagnosis rate\n    rate2_diag <- p[4] #diagnosis rate\n    rate_treat <- p[5] #scale parameter for overall treatment rate\n    rate_death <- p[6] #scale parameter for overall death\n    q <- p[7]\n    #Range\n    rate_ratio <- p[8] #varying parameter to estimate death for treated (but neither suppressed nor failed)\n    \n    alpha <- p[12] #ratio between outcome when resistant/sensitive\n    rate_res <- p[13] #resistant rate\n    rate_susc <- p[14] #reversion rate\n    \n    #1. Infection and Diagnosis\n    RateInf1=array(rep(RateTransm,each=4),dim=c(4,2,2))*rate1_inf\n    RateInf2=RateInf1*rate2_inf\n    \n    Diag_frame[,4]=Diag_frame[,4]*rate2_diag\n    RateDiag=1/rate1_diag*apply(Diag_frame,1,function(x) smooth_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))\n    \n    #2. Treatment\n    #RateTreatFirst=apply(Treat_frame,1,function(x) smooth_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*smooth_st(2005+t/12,2001,2012,1,15)*rate_treat\n    RateTreatFirst=apply(Treat_frame,1,function(x) smooth_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*1/(1/smooth_st(2005+t/12,2001,2012,1/200,1/12)+smooth_st(2005+t/12,2012,2015,0,0))*rate_treat\n    #3. Death\n    p1=min(1,q*mean(sapply(2005+seq(t-36,t,1)/12,function(x) apply(Treat_frame[4,],1,function(y) smooth_st(x,y[\"a\"],y[\"b\"],y[\"c\"],y[\"d\"]))*1/(1/smooth_st(x,2001,2012,1/200,1/12)+smooth_st(x,2012,2015,0,0)))))\n    #p1=p1/2+0.2\n    mu[1:2,4,1]=p1*40.9+(1-p1)*134.4\n    mu[4,4,1]=p1*8.3+(1-p1)*41.7\n    mu[5,4,1]=p1*11.8+(1-p1)*59.7\n    mu[3,1:4,1]=rate_ratio*mu[4,1:4,1]+(1-rate_ratio)*mu[5,1:4,1]\n    mu[6:8,1:4,1]=mu[3:5,1:4,1]\n    mu[1:8,1:4,2]=mu[1:8,1:4,1]\n    mu=mu*rate_death/1000\n    \n    #Back and forth mutation and impact on treatment outcome\n    RateResistant=1/rate_res\n    RateSusceptible=1/rate_susc\n    #From T to S\n    RateSuppFirstSusc=RateSuppFirst/1\n    RateSuppFirstResis=1/alpha*RateSuppFirst/1\n    #From S to F\n    RateFailFirstSusc=RateFailFirst*1\n    RateFailFirstResis=alpha*RateFailFirst*1\n    #From T to F\n    RateTreatToFailFirstSusc=RateTreatToFailFirst*1\n    RateTreatToFailFirstResis=alpha*RateTreatToFailFirst*1\n    #From F to S\n    RateFailToSuppTreatFirstSusc=RateFailToSuppTreatFirst/1\n    RateFailToSuppTreatFirstResis=1/alpha*RateFailToSuppTreatFirst/1\n    \n    #For second-line regimen, no effect of NNRTI resistance on treatment as it is PI\n    ##################################################################################################################\n    dx=array(0,dim=c(8,4,2,2))\n    x=array(x,dim=c(8,4,2,2))\n    I=apply(x,4,sum)\n    \n    #First approach to model S: S=N-I\n    N=N_value[t+1,]\n    S=N-I\n    #Second approach to model S: include into the diff equations\n    # N=S+I\n    # dS=c(0,0)\n    # dS[1]=-S[1]/(S[1]+I[1])*(sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,1,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8),1:4,1,1:2],c(2,3),sum)))\n    #       -S[1]/(S[1]+I[1])*(sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8),1:4,2,1:2],c(2,3),sum)))\n    #       +0.0195*S[1]\n    # dS[2]=-S[2]/(S[2]+I[2])*(sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,1,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8),1:4,1,1:2],c(2,3),sum)))\n    #       -S[2]/(S[2]+I[2])*(sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8),1:4,2,1:2],c(2,3),sum)))\n    #       +0.0195*S[2]\n    \n    #First approach to model I_m15: take the number estimated, no regression\n    I_m15=rep(infected_m15_month[t+1]/2,2) #number of infected children reaching 15 years old at a given month\n    t_m15=rep(treat_m15[t+1]/2,2)\n    #Second approach to model I_m15: take the number estimated, regression\n    # I_m15=rep(inf_m15_app[t+1]/2,2) #number of infected children reaching 15 years old at a given month\n    # t_m15=rep(treat_m15_app[t+1]/2,2)\n    #Test to assess how much time would be saved if I_m15 not considered\n    # I_m15=rep(0,2) #number of infected children reaching 15 years old at a given month\n    # t_m15=rep(0,2)\n    dx[2,1:4,1,1:2]=rep((1-res_m15)*I_m15/4,each=4)\n    dx[2,1:4,2,1:2]=rep(res_m15*I_m15/4,each=4)\n    dx[3,1:4,1,1:2]=rep((1-res_m15)*t_m15/4,each=4)\n    dx[3,1:4,2,1:2]=rep(res_m15*t_m15/4,each=4)\n    \n    for(j in 1:2){\n      #dx[x1,x2,x3,x4] x1:care stages x2:disease progression x3:resistance x4:gender\n      #dx with only interaction with the neighbours in the compartmental model\n      dx[1,1,1,j]=S[j]/N[j]*(sum(RateInf1[1:4,1:2,j]*apply(x[c(1),1:4,1,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,j]*apply(x[c(2,3,5,6,8),1:4,1,1:2],c(2,3),sum)))-\n        (RateStageInf[1]+RateDiag[1]+mu[1,1,1])*x[1,1,1,j]\n      dx[2,1,1,j]=dx[2,1,1,j]+RateDiag[1]*x[1,1,1,j]-(RateTreatFirst[1]+RateStageDiag[1]+mu[2,1,1])*x[2,1,1,j]\n      dx[3,1,1,j]=dx[3,1,1,j]+RateTreatFirst[1]*x[2,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[3,1,1,j]+RateStageTreatFirstL[1]*x[3,2,1,j]\n      dx[4,1,1,j]=RateSuppFirstSusc[1]*x[3,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[4,1,1,j]+RateStageSuppFirst[1]*x[4,2,1,j]\n      dx[5,1,1,j]=RateFailFirstSusc[1]*x[4,1,1,j]-(RateTreatSecond[1]+RateStageFailFirst[1]+mu[5,1,1])*x[5,1,1,j]\n      dx[6,1,1,j]=RateTreatSecond[1]*x[5,1,1,j]-(RateSuppSecond[1]+RateStageTreatSecondR[1]+mu[6,1,1])*x[6,1,1,j]+RateStageTreatSecondL[1]*x[6,2,1,j]\n      dx[7,1,1,j]=RateSuppSecond[1]*x[6,1,1,j]-(RateFailSecond[1]+mu[7,1,1])*x[7,1,1,j]-RateStageSuppSecond[1]*x[7,1,1,j]\n      dx[8,1,1,j]=RateFailSecond[1]*x[7,1,1,j]-(RateStageFailSecond[1]+mu[8,1,1])*x[8,1,1,j]\n      \n      dx[1,2,1,j]=-(RateStageInf[2]+RateDiag[2]+mu[1,2,1])*x[1,2,1,j]+RateStageInf[1]*x[1,1,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]+RateDiag[2]*x[1,2,1,j]-(RateTreatFirst[2]+RateStageDiag[2]+mu[2,2,1])*x[2,2,1,j]+RateStageDiag[1]*x[2,1,1,j]\n      dx[3,2,1,j]=dx[3,2,1,j]+RateTreatFirst[2]*x[2,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[3,2,1,j]+RateStageTreatFirstR[1]*x[3,1,1,j]+RateStageTreatFirstL[2]*x[3,3,1,j]\n      dx[4,2,1,j]=RateSuppFirstSusc[2]*x[3,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[4,2,1,j]+RateStageSuppFirst[2]*x[4,3,1,j]\n      dx[5,2,1,j]=RateFailFirstSusc[2]*x[4,2,1,j]-(RateTreatSecond[2]+RateStageFailFirst[2]+mu[5,2,1])*x[5,2,1,j]+RateStageFailFirst[1]*x[5,1,1,j]\n      dx[6,2,1,j]=RateTreatSecond[2]*x[5,2,1,j]-(RateSuppSecond[2]+RateStageTreatSecondR[2]+RateStageTreatSecondL[1]+mu[6,2,1 ])*x[6,2,1,j]+RateStageTreatSecondR[1]*x[6,1,1,j]+RateStageTreatSecondL[2]*x[6,3,1,j]\n      dx[7,2,1,j]=RateSuppSecond[2]*x[6,2,1,j]-(RateFailSecond[2]+mu[7,2,1])*x[7,2,1,j]+RateStageSuppSecond[2]*x[7,3,1,j]+RateStageSuppSecond[1]*x[7,1,1,j]\n      dx[8,2,1,j]=RateFailSecond[2]*x[7,2,1,j]-(RateStageFailSecond[2]+mu[8,2,1])*x[8,2,1,j]+RateStageFailSecond[1]*x[8,1,1,j]\n      \n      dx[1,3,1,j]=-(RateStageInf[3]+RateDiag[3]+mu[1,3,1])*x[1,3,1,j]+RateStageInf[2]*x[1,2,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]+RateDiag[3]*x[1,3,1,j]-(RateTreatFirst[3]+RateStageDiag[3]+mu[2,3,1])*x[2,3,1,j]+RateStageDiag[2]*x[2,2,1,j]\n      dx[3,3,1,j]=dx[3,3,1,j]+RateTreatFirst[3]*x[2,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[3,3,1,j]+RateStageTreatFirstR[2]*x[3,2,1,j]+RateStageTreatFirstL[3]*x[3,4,1,j]\n      dx[4,3,1,j]=RateSuppFirstSusc[3]*x[3,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[4,3,1,j]+RateStageSuppFirst[3]*x[4,4,1,j]\n      dx[5,3,1,j]=RateFailFirstSusc[3]*x[4,3,1,j]-(RateTreatSecond[3]+RateStageFailFirst[3]+mu[5,3,1])*x[5,3,1,j]+RateStageFailFirst[2]*x[5,2,1,j]\n      dx[6,3,1,j]=RateTreatSecond[3]*x[5,3,1,j]-(RateSuppSecond[3]+RateStageTreatSecondR[3]+RateStageTreatSecondL[2]+mu[6,3,1])*x[6,3,1,j]+RateStageTreatSecondR[2]*x[6,2,1,j]+RateStageTreatSecondL[3]*x[6,4,1,j]\n      dx[7,3,1,j]=RateSuppSecond[3]*x[6,3,1,j]-(RateFailSecond[3]+RateStageSuppSecond[2]+mu[7,3,1])*x[7,3,1,j]+RateStageSuppSecond[3]*x[7,4,1,j]\n      dx[8,3,1,j]=RateFailSecond[3]*x[7,3,1,j]-(RateStageFailSecond[3]+mu[8,3,1])*x[8,3,1,j]+RateStageFailSecond[2]*x[8,2,1,j]\n      \n      dx[1,4,1,j]=-(RateDiag[4]+mu[1,4,1])*x[1,4,1,j]+RateStageInf[3]*x[1,3,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]+RateDiag[4]*x[1,4,1,j]-(RateTreatFirst[4]+mu[2,4,1])*x[2,4,1,j]+RateStageDiag[3]*x[2,3,1,j]\n      dx[3,4,1,j]=dx[3,4,1,j]+RateTreatFirst[4]*x[2,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[3,4,1,j]+RateStageTreatFirstR[3]*x[3,3,1,j]\n      dx[4,4,1,j]=RateSuppFirstSusc[4]*x[3,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[4,4,1,j]\n      dx[5,4,1,j]=RateFailFirstSusc[4]*x[4,4,1,j]-(RateTreatSecond[4]+mu[5,4,1])*x[5,4,1,j]+RateStageFailFirst[3]*x[5,3,1,j]\n      dx[6,4,1,j]=RateTreatSecond[4]*x[5,4,1,j]-(RateSuppSecond[4]+RateStageTreatSecondL[3]+mu[6,4,1])*x[6,4,1,j]+RateStageTreatSecondR[3]*x[6,3,1,j]\n      dx[7,4,1,j]=RateSuppSecond[4]*x[6,4,1,j]-(RateFailSecond[4]+RateStageSuppSecond[3]+mu[7,4,1])*x[7,4,1,j]\n      dx[8,4,1,j]=RateFailSecond[4]*x[7,4,1,j]-mu[8,4,1 ]*x[8,4,1,j]+RateStageFailSecond[3]*x[8,3,1,j]\n      \n      ##############################################################################################################################################################\n      \n      dx[1,1,1,j]=dx[1,1,1,j]\n      dx[2,1,1,j]=dx[2,1,1,j]-RateDirectTreatSecond[1]*x[2,1,1,j]+RateStopTreatFirst[1]*x[3,1,1,j]+RateStopSuppFirst[1]*x[4,1,1,j]+RateStopFailFirst[1]*x[5,1,1,j]+\n        RateStopTreatSecond[1]*x[6,1,1,j]+RateStopSuppSecond[1]*x[7,1,1,j]+RateStopFailSecond[1]*x[8,1,1,j]\n      dx[3,1,1,j]=dx[3,1,1,j]-RateStopTreatFirst[1]*x[3,1,1,j]-RateTreatToFailFirst[1]*x[3,1,1,j]\n      dx[4,1,1,j]=dx[4,1,1,j]-RateStopSuppFirst[1]*x[4,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[5,1,1,j]-RateSuppFirstToSecond[1]*x[4,1,1,j]\n      dx[5,1,1,j]=dx[5,1,1,j]-RateStopFailFirst[1]*x[5,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[5,1,1,j]+RateTreatToFailFirst[1]*x[3,1,1,j]\n      dx[6,1,1,j]=dx[6,1,1,j]-RateStopTreatSecond[1]*x[6,1,1,j]+RateDirectTreatSecond[1]*x[2,1,1,j]-RateTreatToFailSecond[1]*x[6,1,1,j]\n      dx[7,1,1,j]=dx[7,1,1,j]-RateStopSuppSecond[1]*x[7,1,1,j]+RateFailToSuppTreatSecond[1]*x[8,1,1,j]+RateSuppFirstToSecond[1]*x[4,1,1,j]\n      dx[8,1,1,j]=dx[8,1,1,j]-RateStopFailSecond[1]*x[8,1,1,j]-RateFailToSuppTreatSecond[1]*x[8,1,1,j]+RateTreatToFailSecond[1]*x[6,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]-RateDirectTreatSecond[2]*x[2,2,1,j]+RateStopTreatFirst[2]*x[3,2,1,j]+RateStopSuppFirst[2]*x[4,2,1,j]+RateStopFailFirst[2]*x[5,2,1,j]+\n        RateStopTreatSecond[2]*x[6,2,1,j]+RateStopSuppSecond[2]*x[7,2,1,j]+RateStopFailSecond[2]*x[8,2,1,j]\n      dx[3,2,1,j]=dx[3,2,1,j]-RateStopTreatFirst[2]*x[3,2,1,j]-RateTreatToFailFirst[2]*x[3,2,1,j]\n      dx[4,2,1,j]=dx[4,2,1,j]-RateStopSuppFirst[2]*x[4,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[5,2,1,j]-RateSuppFirstToSecond[2]*x[4,2,1,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateStopFailFirst[2]*x[5,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[5,2,1,j]+RateTreatToFailFirst[2]*x[3,2,1,j]\n      dx[6,2,1,j]=dx[6,2,1,j]-RateStopTreatSecond[2]*x[6,2,1,j]+RateDirectTreatSecond[2]*x[2,2,1,j]-RateTreatToFailSecond[2]*x[6,2,1,j]\n      dx[7,2,1,j]=dx[7,2,1,j]-RateStopSuppSecond[2]*x[7,2,1,j]+RateFailToSuppTreatSecond[2]*x[8,2,1,j]+RateSuppFirstToSecond[2]*x[4,2,1,j]\n      dx[8,2,1,j]=dx[8,2,1,j]-RateStopFailSecond[2]*x[8,2,1,j]-RateFailToSuppTreatSecond[2]*x[8,2,1,j]+RateTreatToFailSecond[2]*x[6,2,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]-RateDirectTreatSecond[3]*x[2,3,1,j]+RateStopTreatFirst[3]*x[3,3,1,j]+RateStopSuppFirst[3]*x[4,3,1,j]+RateStopFailFirst[3]*x[5,3,1,j]+\n        RateStopTreatSecond[3]*x[6,3,1,j]+RateStopSuppSecond[3]*x[7,3,1,j]+RateStopFailSecond[3]*x[8,3,1,j]\n      dx[3,3,1,j]=dx[3,3,1,j]-RateStopTreatFirst[3]*x[3,3,1,j]-RateTreatToFailFirst[3]*x[3,3,1,j]\n      dx[4,3,1,j]=dx[4,3,1,j]-RateStopSuppFirst[3]*x[4,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[5,3,1,j]-RateSuppFirstToSecond[3]*x[4,3,1,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateStopFailFirst[3]*x[5,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[5,3,1,j]+RateTreatToFailFirst[3]*x[3,3,1,j]\n      dx[6,3,1,j]=dx[6,3,1,j]-RateStopTreatSecond[3]*x[6,3,1,j]+RateDirectTreatSecond[3]*x[2,3,1,j]-RateTreatToFailSecond[3]*x[6,3,1,j]\n      dx[7,3,1,j]=dx[7,3,1,j]-RateStopSuppSecond[3]*x[7,3,1,j]+RateFailToSuppTreatSecond[3]*x[8,3,1,j]+RateSuppFirstToSecond[3]*x[4,3,1,j]\n      dx[8,3,1,j]=dx[8,3,1,j]-RateStopFailSecond[3]*x[8,3,1,j]-RateFailToSuppTreatSecond[3]*x[8,3,1,j]+RateTreatToFailSecond[3]*x[6,3,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]-RateDirectTreatSecond[4]*x[2,4,1,j]+RateStopTreatFirst[4]*x[3,4,1,j]+RateStopSuppFirst[4]*x[4,4,1,j]+RateStopFailFirst[4]*x[5,4,1,j]+\n        RateStopTreatSecond[4]*x[6,4,1,j]+RateStopSuppSecond[4]*x[7,4,1,j]+RateStopFailSecond[4]*x[8,4,1,j]\n      dx[3,4,1,j]=dx[3,4,1,j]-RateStopTreatFirst[4]*x[3,4,1,j]-RateTreatToFailFirst[4]*x[3,4,1,j]\n      dx[4,4,1,j]=dx[4,4,1,j]-RateStopSuppFirst[4]*x[4,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[5,4,1,j]-RateSuppFirstToSecond[4]*x[4,4,1,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateStopFailFirst[4]*x[5,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[5,4,1,j]+RateTreatToFailFirst[4]*x[3,4,1,j]\n      dx[6,4,1,j]=dx[6,4,1,j]-RateStopTreatSecond[4]*x[6,4,1,j]+RateDirectTreatSecond[4]*x[2,4,1,j]-RateTreatToFailSecond[4]*x[6,4,1,j]\n      dx[7,4,1,j]=dx[7,4,1,j]-RateStopSuppSecond[4]*x[7,4,1,j]+RateFailToSuppTreatSecond[4]*x[8,4,1,j]+RateSuppFirstToSecond[4]*x[4,4,1,j]\n      dx[8,4,1,j]=dx[8,4,1,j]-RateStopFailSecond[4]*x[8,4,1,j]-RateFailToSuppTreatSecond[4]*x[8,4,1,j]+RateTreatToFailSecond[4]*x[6,4,1,j]\n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      dx[1,1,2,j]=S[j]/N[j]*(sum(RateInf1[1:4,1:2,j]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,j]*apply(x[c(2,3,5,6,8),1:4,2,1:2],c(2,3),sum)))-\n        (RateStageInf[1]+RateDiag[1]+mu[1,1,2 ])*x[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]+RateDiag[1]*x[1,1,2,j]-(RateTreatFirst[1]+RateStageDiag[1]+mu[2,1,2 ])*x[2,1,2,j]\n      dx[3,1,2,j]=dx[3,1,2,j]+RateTreatFirst[1]*x[2,1,2,j]-(RateSuppFirstResis[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[3,1,2,j]+RateStageTreatFirstL[1]*x[3,2,2,j]\n      dx[4,1,2,j]=RateSuppFirstResis[1]*x[3,1,2,j]-(RateFailFirstResis[1]+mu[4,1,2])*x[4,1,2,j]-RateStageSuppFirst[1]*x[4,1,2,j]\n      dx[5,1,2,j]=RateFailFirstResis[1]*x[4,1,2,j]-(RateTreatSecond[1]+RateStageFailFirst[1]+mu[5,1,2 ])*x[5,1,2,j]\n      dx[6,1,2,j]=RateTreatSecond[1]*x[5,1,2,j]-(RateSuppSecond[1]+RateStageTreatSecondR[1]+mu[6,1,2 ])*x[6,1,2,j]+RateStageTreatSecondL[1]*x[6,2,2,j]\n      dx[7,1,2,j]=RateSuppSecond[1]*x[6,1,2,j]-(RateFailSecond[1]+mu[7,1,2])*x[7,1,2,j]-RateStageSuppSecond[1]*x[7,1,2,j]\n      dx[8,1,2,j]=RateFailSecond[1]*x[7,1,2,j]-(RateStageFailSecond[1]+mu[8,1,2])*x[8,1,2,j]\n      \n      dx[1,2,2,j]=-(RateStageInf[2]+RateDiag[2]+mu[1,2,2])*x[1,2,2,j]+RateStageInf[1]*x[1,1,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]+RateDiag[2]*x[1,2,2,j]-(RateTreatFirst[2]+RateStageDiag[2]+mu[2,2,2])*x[2,2,2,j]+RateStageDiag[1]*x[2,1,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]+RateTreatFirst[2]*x[2,2,2,j]-(RateSuppFirstResis[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2 ])*x[3,2,2,j]+RateStageTreatFirstR[1]*x[3,1,2,j]+RateStageTreatFirstL[2]*x[3,3,2,j]\n      dx[4,2,2,j]=RateSuppFirstResis[2]*x[3,2,2,j]-(RateFailFirstResis[2]+mu[4,2,2])*x[4,2,2,j]+RateStageSuppFirst[2]*x[4,3,2,j]+RateStageSuppFirst[1]*x[4,1,2,j]\n      dx[5,2,2,j]=RateFailFirstResis[2]*x[4,2,2,j]-(RateTreatSecond[2]+RateStageFailFirst[2]+mu[5,2,2])*x[5,2,2,j]+RateStageFailFirst[1]*x[5,1,2,j]\n      dx[6,2,2,j]=RateTreatSecond[2]*x[5,2,2,j]-(RateSuppSecond[2]+RateStageTreatSecondR[2]+RateStageTreatSecondL[1]+mu[6,2,2])*x[6,2,2,j]+RateStageTreatSecondR[1]*x[6,1,2,j]+RateStageTreatSecondL[2]*x[6,3,2,j]\n      dx[7,2,2,j]=RateSuppSecond[2]*x[6,2,2,j]-(RateFailSecond[2]+mu[7,2,2])*x[7,2,2,j]+RateStageSuppSecond[2]*x[7,3,2,j]+RateStageSuppSecond[1]*x[7,1,2,j]\n      dx[8,2,2,j]=RateFailSecond[2]*x[7,2,2,j]-(RateStageFailSecond[2]+mu[8,2,2])*x[8,2,2,j]+RateStageFailSecond[1]*x[8,1,2,j]\n      \n      dx[1,3,2,j]=-(RateStageInf[3]+RateDiag[3]+mu[1,3,2])*x[1,3,2,j]+RateStageInf[2]*x[1,2,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]+RateDiag[3]*x[1,3,2,j]-(RateTreatFirst[3]+RateStageDiag[3]+mu[2,3,2])*x[2,3,2,j]+RateStageDiag[2]*x[2,2,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]+RateTreatFirst[3]*x[2,3,2,j]-(RateSuppFirstResis[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[3,3,2,j]+RateStageTreatFirstR[2]*x[3,2,2,j]+RateStageTreatFirstL[3]*x[3,4,2,j]\n      dx[4,3,2,j]=RateSuppFirstResis[3]*x[3,3,2,j]-(RateFailFirstResis[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[4,3,2,j]+RateStageSuppFirst[3]*x[4,4,2,j]\n      dx[5,3,2,j]=RateFailFirstResis[3]*x[4,3,2,j]-(RateTreatSecond[3]+RateStageFailFirst[3]+mu[5,3,2])*x[5,3,2,j]+RateStageFailFirst[2]*x[5,2,2,j]\n      dx[6,3,2,j]=RateTreatSecond[3]*x[5,3,2,j]-(RateSuppSecond[3]+RateStageTreatSecondR[3]+RateStageTreatSecondL[2]+mu[6,3,2])*x[6,3,2,j]+RateStageTreatSecondR[2]*x[6,2,2,j]+RateStageTreatSecondL[3]*x[6,4,2,j]\n      dx[7,3,2,j]=RateSuppSecond[3]*x[6,3,2,j]-(RateFailSecond[3]+RateStageSuppSecond[2]+mu[7,3,2])*x[7,3,2,j]+RateStageSuppSecond[3]*x[7,4,2,j]\n      dx[8,3,2,j]=RateFailSecond[3]*x[7,3,2,j]-(RateStageFailSecond[3]+mu[8,3,2])*x[8,3,2,j]+RateStageFailSecond[2]*x[8,2,2,j]\n      \n      dx[1,4,2,j]=-(RateDiag[4]+mu[1,4,2])*x[1,4,2,j]+RateStageInf[3]*x[1,3,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]+RateDiag[4]*x[1,4,2,j]-(RateTreatFirst[4]+mu[2,4,2])*x[2,4,2,j]+RateStageDiag[3]*x[2,3,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]+RateTreatFirst[4]*x[2,4,2,j]-(RateSuppFirstResis[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[3,4,2,j]+RateStageTreatFirstR[3]*x[3,3,2,j]\n      dx[4,4,2,j]=RateSuppFirstResis[4]*x[3,4,2,j]-(RateFailFirstResis[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[4,4,2,j]\n      dx[5,4,2,j]=RateFailFirstResis[4]*x[4,4,2,j]-(RateTreatSecond[4]+mu[5,4,2])*x[5,4,2,j]+RateStageFailFirst[3]*x[5,3,2,j]\n      dx[6,4,2,j]=RateTreatSecond[4]*x[5,4,2,j]-(RateSuppSecond[4]+RateStageTreatSecondL[3]+mu[6,4,2])*x[6,4,2,j]+RateStageTreatSecondR[3]*x[6,3,2,j]\n      dx[7,4,2,j]=RateSuppSecond[4]*x[6,4,2,j]-(RateFailSecond[4]+RateStageSuppSecond[3]+mu[7,4,2])*x[7,4,2,j]\n      dx[8,4,2,j]=RateFailSecond[4]*x[7,4,2,j]-mu[8,4,2]*x[8,4,2,j]+RateStageFailSecond[3]*x[8,3,2,j]\n      \n      ##############################################################################################################################################################\n      \n      dx[1,1,2,j]=dx[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]-RateDirectTreatSecond[1]*x[2,1,2,j]+RateStopTreatFirst[1]*x[3,1,2,j]+RateStopSuppFirst[1]*x[4,1,2,j]+RateStopFailFirst[1]*x[5,1,2,j]+\n        RateStopTreatSecond[1]*x[6,1,2,j]+RateStopSuppSecond[1]*x[7,1,2,j]+RateStopFailSecond[1]*x[8,1,2,j]\n      dx[3,1,2,j]=dx[3,1,2,j]-RateStopTreatFirst[1]*x[3,1,2,j]-RateTreatToFailFirstResis[1]*x[3,1,2,j]\n      dx[4,1,2,j]=dx[4,1,2,j]-RateStopSuppFirst[1]*x[4,1,2,j]+RateFailToSuppTreatFirstResis[1]*x[5,1,2,j]-RateSuppFirstToSecond[1]*x[4,1,2,j]\n      dx[5,1,2,j]=dx[5,1,2,j]-RateStopFailFirst[1]*x[5,1,2,j]-RateFailToSuppTreatFirstResis[1]*x[5,1,2,j]+RateTreatToFailFirstResis[1]*x[3,1,2,j]\n      dx[6,1,2,j]=dx[6,1,2,j]-RateStopTreatSecond[1]*x[6,1,2,j]+RateDirectTreatSecond[1]*x[2,1,2,j]-RateTreatToFailSecond[1]*x[6,1,2,j]\n      dx[7,1,2,j]=dx[7,1,2,j]-RateStopSuppSecond[1]*x[7,1,2,j]+RateFailToSuppTreatSecond[1]*x[8,1,2,j]+RateSuppFirstToSecond[1]*x[4,1,2,j]\n      dx[8,1,2,j]=dx[8,1,2,j]-RateStopFailSecond[1]*x[8,1,2,j]-RateFailToSuppTreatSecond[1]*x[8,1,2,j]+RateTreatToFailSecond[1]*x[6,1,2,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateDirectTreatSecond[2]*x[2,2,2,j]+RateStopTreatFirst[2]*x[3,2,2,j]+RateStopSuppFirst[2]*x[4,2,2,j]+RateStopFailFirst[2]*x[5,2,2,j]+\n        RateStopTreatSecond[2]*x[6,2,2,j]+RateStopSuppSecond[2]*x[7,2,2,j]+RateStopFailSecond[2]*x[8,2,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]-RateStopTreatFirst[2]*x[3,2,2,j]-RateTreatToFailFirstResis[2]*x[3,2,2,j]\n      dx[4,2,2,j]=dx[4,2,2,j]-RateStopSuppFirst[2]*x[4,2,2,j]+RateFailToSuppTreatFirstResis[2]*x[5,2,2,j]-RateSuppFirstToSecond[2]*x[4,2,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]-RateStopFailFirst[2]*x[5,2,2,j]-RateFailToSuppTreatFirstResis[2]*x[5,2,2,j]+RateTreatToFailFirstResis[2]*x[3,2,2,j]\n      dx[6,2,2,j]=dx[6,2,2,j]-RateStopTreatSecond[2]*x[6,2,2,j]+RateDirectTreatSecond[2]*x[2,2,2,j]-RateTreatToFailSecond[2]*x[6,2,2,j]\n      dx[7,2,2,j]=dx[7,2,2,j]-RateStopSuppSecond[2]*x[7,2,2,j]+RateFailToSuppTreatSecond[2]*x[8,2,2,j]+RateSuppFirstToSecond[2]*x[4,2,2,j]\n      dx[8,2,2,j]=dx[8,2,2,j]-RateStopFailSecond[2]*x[8,2,2,j]-RateFailToSuppTreatSecond[2]*x[8,2,2,j]+RateTreatToFailSecond[2]*x[6,2,2,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateDirectTreatSecond[3]*x[2,3,2,j]+RateStopTreatFirst[3]*x[3,3,2,j]+RateStopSuppFirst[3]*x[4,3,2,j]+RateStopFailFirst[3]*x[5,3,2,j]+\n        RateStopTreatSecond[3]*x[6,3,2,j]+RateStopSuppSecond[3]*x[7,3,2,j]+RateStopFailSecond[3]*x[8,3,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]-RateStopTreatFirst[3]*x[3,3,2,j]-RateTreatToFailFirstResisResis[3]*x[3,3,2,j]\n      dx[4,3,2,j]=dx[4,3,2,j]-RateStopSuppFirst[3]*x[4,3,2,j]+RateFailToSuppTreatFirstResis[3]*x[5,3,2,j]-RateSuppFirstToSecond[3]*x[4,3,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]-RateStopFailFirst[3]*x[5,3,2,j]-RateFailToSuppTreatFirstResis[3]*x[5,3,2,j]+RateTreatToFailFirstResis[3]*x[3,3,2,j]\n      dx[6,3,2,j]=dx[6,3,2,j]-RateStopTreatSecond[3]*x[6,3,2,j]+RateDirectTreatSecond[3]*x[2,3,2,j]-RateTreatToFailSecond[3]*x[6,3,2,j]\n      dx[7,3,2,j]=dx[7,3,2,j]-RateStopSuppSecond[3]*x[7,3,2,j]+RateFailToSuppTreatSecond[3]*x[8,3,2,j]+RateSuppFirstToSecond[3]*x[4,3,2,j]\n      dx[8,3,2,j]=dx[8,3,2,j]-RateStopFailSecond[3]*x[8,3,2,j]-RateFailToSuppTreatSecond[3]*x[8,3,2,j]+RateTreatToFailSecond[3]*x[6,3,2,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateDirectTreatSecond[4]*x[2,4,2,j]+RateStopTreatFirst[4]*x[3,4,2,j]+RateStopSuppFirst[4]*x[4,4,2,j]+RateStopFailFirst[4]*x[5,4,2,j]+\n        RateStopTreatSecond[4]*x[6,4,2,j]+RateStopSuppSecond[4]*x[7,4,2,j]+RateStopFailSecond[4]*x[8,4,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]-RateStopTreatFirst[4]*x[3,4,2,j]-RateTreatToFailFirstResis[4]*x[3,4,2,j]\n      dx[4,4,2,j]=dx[4,4,2,j]-RateStopSuppFirst[4]*x[4,4,2,j]+RateFailToSuppTreatFirstResis[4]*x[5,4,2,j]-RateSuppFirstToSecond[4]*x[4,4,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]-RateStopFailFirst[4]*x[5,4,2,j]-RateFailToSuppTreatFirstResis[4]*x[5,4,2,j]+RateTreatToFailFirstResis[4]*x[3,4,2,j]\n      dx[6,4,2,j]=dx[6,4,2,j]-RateStopTreatSecond[4]*x[6,4,2,j]+RateDirectTreatSecond[4]*x[2,4,2,j]-RateTreatToFailSecond[4]*x[6,4,2,j]\n      dx[7,4,2,j]=dx[7,4,2,j]-RateStopSuppSecond[4]*x[7,4,2,j]+RateFailToSuppTreatSecond[4]*x[8,4,2,j]+RateSuppFirstToSecond[4]*x[4,4,2,j]\n      dx[8,4,2,j]=dx[8,4,2,j]-RateStopFailSecond[4]*x[8,4,2,j]-RateFailToSuppTreatSecond[4]*x[8,4,2,j]+RateTreatToFailSecond[4]*x[6,4,2,j]\n      \n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      #dx with interaction between resistant and Resiseptible compartments\n      dx[1,1,1,j]=dx[1,1,1,j]+RateSusceptible*x[1,1,2,j]\n      dx[2,1,1,j]=dx[2,1,1,j]+RateSusceptible*x[2,1,2,j]\n      dx[3,1,1,j]=dx[3,1,1,j]\n      dx[4,1,1,j]=dx[4,1,1,j]\n      dx[5,1,1,j]=dx[5,1,1,j]-RateResistant*x[5,1,1,j]\n      dx[6,1,1,j]=dx[6,1,1,j]\n      dx[7,1,1,j]=dx[7,1,1,j]\n      dx[8,1,1,j]=dx[8,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]+RateSusceptible*x[1,2,2,j]\n      dx[2,2,1,j]=dx[2,2,1,j]+RateSusceptible*x[2,2,2,j]\n      dx[3,2,1,j]=dx[3,2,1,j]\n      dx[4,2,1,j]=dx[4,2,1,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateResistant*x[5,2,1,j]\n      dx[6,2,1,j]=dx[6,2,1,j]\n      dx[7,2,1,j]=dx[7,2,1,j]\n      dx[8,2,1,j]=dx[8,2,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]+RateSusceptible*x[1,3,2,j]\n      dx[2,3,1,j]=dx[2,3,1,j]+RateSusceptible*x[2,3,2,j]\n      dx[3,3,1,j]=dx[3,3,1,j]\n      dx[4,3,1,j]=dx[4,3,1,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateResistant*x[5,3,1,j]\n      dx[6,3,1,j]=dx[6,3,1,j]\n      dx[7,3,1,j]=dx[7,3,1,j]\n      dx[8,3,1,j]=dx[8,3,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]+RateSusceptible*x[1,4,2,j]\n      dx[2,4,1,j]=dx[2,4,1,j]+RateSusceptible*x[2,4,2,j]\n      dx[3,4,1,j]=dx[3,4,1,j]\n      dx[4,4,1,j]=dx[4,4,1,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateResistant*x[5,4,1,j]\n      dx[6,4,1,j]=dx[6,4,1,j]\n      dx[7,4,1,j]=dx[7,4,1,j]\n      dx[8,4,1,j]=dx[8,4,1,j]\n      \n      #############################################################################################################################################################################\n      dx[1,1,2,j]=dx[1,1,2,j]-RateSusceptible*x[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]-RateSusceptible*x[2,1,2,j]\n      dx[3,1,2,j]=dx[3,1,2,j]\n      dx[4,1,2,j]=dx[4,1,2,j]\n      dx[5,1,2,j]=dx[5,1,2,j]+RateResistant*x[5,1,1,j]\n      dx[6,1,2,j]=dx[6,1,2,j]\n      dx[7,1,2,j]=dx[7,1,2,j]\n      dx[8,1,2,j]=dx[8,1,2,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]-RateSusceptible*x[1,2,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateSusceptible*x[2,2,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]\n      dx[4,2,2,j]=dx[4,2,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]+RateResistant*x[5,2,1,j]\n      dx[6,2,2,j]=dx[6,2,2,j]\n      dx[7,2,2,j]=dx[7,2,2,j]\n      dx[8,2,2,j]=dx[8,2,2,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]-RateSusceptible*x[1,3,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateSusceptible*x[2,3,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]\n      dx[4,3,2,j]=dx[4,3,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]+RateResistant*x[5,3,1,j]\n      dx[6,3,2,j]=dx[6,3,2,j]\n      dx[7,3,2,j]=dx[7,3,2,j]\n      dx[8,3,2,j]=dx[8,3,2,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]-RateSusceptible*x[1,4,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateSusceptible*x[2,4,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]\n      dx[4,4,2,j]=dx[4,4,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]+RateResistant*x[5,4,1,j]\n      dx[6,4,2,j]=dx[6,4,2,j]\n      dx[7,4,2,j]=dx[7,4,2,j]\n      dx[8,4,2,j]=dx[8,4,2,j]\n    }\n    \n    #dx[3:8,1:4,1,1:2]=dx[3:8,1:4,1,1:2]+infected_m15_month[t+1]*x[3:8,1:4,1,1:2]/sum(x[3:8,1:4,1,1:2])\n    ####################################################################################################################  \n    #Useful estimators\n    #Number of new infected people (by step)\n    newinf=sum(array(rep(rep(1/N,each=4),2),dim=c(4,2,2))*array(rep(S,each=8),dim=c(4,2,2))*RateInf1[1:4,1:2,1:2]*array(rep(apply(x[c(1),1:4,1:2,1:2],c(1,3),sum),2),dim=c(4,2,2)))+\n      sum(array(rep(rep(1/N,each=4),2),dim=c(4,2,2))*array(rep(S,each=8),dim=c(4,2,2))*RateInf2[1:4,1:2,1:2]*array(rep(apply(x[c(2,3,5,6,8),1:4,1:2,1:2],c(2,4),sum),2),dim=c(4,2,2)))\n    #New infected susceptible people\n    newinf2=sum(array(rep(rep(1/N,each=4),2),dim=c(4,2,2))*array(rep(S,each=8),dim=c(4,2,2))*RateInf1[1:4,1:2,1:2]*array(rep(apply(x[c(1),1:4,1,1:2],c(1,2),sum),2),dim=c(4,2,2)))+\n      sum(array(rep(rep(1/N,each=4),2),dim=c(4,2,2))*array(rep(S,each=8),dim=c(4,2,2))*RateInf2[1:4,1:2,1:2]*array(rep(apply(x[c(2,3,5,6,8),1:4,1,1:2],c(2,3),sum),2),dim=c(4,2,2)))\n    #New infected resistant people\n    newinf3=sum(array(rep(rep(1/N,each=4),2),dim=c(4,2,2))*array(rep(S,each=8),dim=c(4,2,2))*RateInf1[1:4,1:2,1:2]*array(rep(apply(x[c(1),1:4,2,1:2],c(1,2),sum),2),dim=c(4,2,2)))+\n      sum(array(rep(rep(1/N,each=4),2),dim=c(4,2,2))*array(rep(S,each=8),dim=c(4,2,2))*RateInf2[1:4,1:2,1:2]*array(rep(apply(x[c(2,3,5,6,8),1:4,2,1:2],c(2,3),sum),2),dim=c(4,2,2)))\n    \n    \n    \n    #Total number of infected but not suppressed people\n    notsup=sum(apply(x[c(1,2,3,5,6,8),1:4,1:2,1:2],c(4),sum))\n    #Proportion of susceptible people\n    susc=sum(S)/sum(N)\n    #fail1=sum(x[c(4,7),1:5,1])\n    #fail2=sum(x[c(4,7),1:5,2])\n    #newsu=RateSusceptible*sum(x[1:8,1:5,2])\n    #newres=RateResistant*sum(x[c(5,8),1:5,1])\n    #suscep=sum(x[1:8,1:5,1])\n    #resis=sum(x[1:8,1:5,2])\n    #Death: 1) total number 2) AIDS 3) Not treated 4) Treated\n    death=sum(array(apply(x,c(1,2,3),sum),dim=c(8,4,2))*mu) #1\n    death1=sum((array(apply(x,c(1,2,3),sum),dim=c(8,4,2))*mu)[1:8,4,1:2]) #2\n    death2=sum((array(apply(x,c(1,2,3),sum),dim=c(8,4,2))*mu)[1:2,4,1:2]) #3\n    death3=sum((array(apply(x,c(1,2,3),sum),dim=c(8,4,2))*mu)[3:8,4,1:2]) #4\n    \n    death_nt1=sum((array(apply(x,c(1,2,3),sum),dim=c(8,4,2))*mu)[1:2,1,1:2]) #1\n    death_nt2=sum((array(apply(x,c(1,2,3),sum),dim=c(8,4,2))*mu)[1:2,2,1:2]) #2\n    death_nt3=sum((array(apply(x,c(1,2,3),sum),dim=c(8,4,2))*mu)[1:2,3,1:2]) #3\n    death_nt4=sum((array(apply(x,c(1,2,3),sum),dim=c(8,4,2))*mu)[1:2,4,1:2]) #4\n    \n    death_t1=sum((array(apply(x,c(1,2,3),sum),dim=c(8,4,2))*mu)[3:8,1,1:2]) #1\n    death_t2=sum((array(apply(x,c(1,2,3),sum),dim=c(8,4,2))*mu)[3:8,2,1:2]) #2\n    death_t3=sum((array(apply(x,c(1,2,3),sum),dim=c(8,4,2))*mu)[3:8,3,1:2]) #3\n    death_t4=sum((array(apply(x,c(1,2,3),sum),dim=c(8,4,2))*mu)[3:8,4,1:2]) #4\n    \n    \n    #Number of new treated people\n    newtreated=sum(apply(x,2,sum)*RateTreatFirst)+sum(apply(x,2,sum)*RateTreatSecond)\n    #newtreated=sum(apply(x,2,sum)*RateTreatSecond)\n    #dx[2,4,1,j]=RateDiag[4]*x[1,4,1,j]-(RateTreatFirst[4]+mu[2,4,1])*x[2,4,1,j]+RateStageDiag[3]*x[2,3,1,j]\n    \n    #In and out compartment 1,1,1,1:2\n    d1=sum(array(rep(rep(1/N,each=4),2),dim=c(4,2,2))*array(rep(S,each=8),dim=c(4,2,2))*RateInf1[1:4,1:2,1:2]*array(rep(apply(x[c(1),1:4,1,1:2],c(1,2),sum),2),dim=c(4,2,2)))+\n      sum(array(rep(rep(1/N,each=4),2),dim=c(4,2,2))*array(rep(S,each=8),dim=c(4,2,2))*RateInf2[1:4,1:2,1:2]*array(rep(apply(x[c(2,3,5,6,8),1:4,1,1:2],c(2,3),sum),2),dim=c(4,2,2)))\n    d2=-(RateStageInf[1])*sum(x[1,1,1,1:2])\n    d3=(RateDiag[1])*sum(x[1,1,1,1:2])\n    d4=(mu[1,1,1])*sum(x[1,1,1,1:2])\n    d5=RateSusceptible*sum(x[1,1,2,1:2])\n    d6=c(d1,d2,d3,d4,d5)\n    #In and out compartment 1,1,2,1:2\n    d1=sum(array(rep(rep(1/N,each=4),2),dim=c(4,2,2))*array(rep(S,each=8),dim=c(4,2,2))*RateInf1[1:4,1:2,1:2]*array(rep(apply(x[c(1),1:4,2,1:2],c(1,2),sum),2),dim=c(4,2,2)))+\n      sum(array(rep(rep(1/N,each=4),2),dim=c(4,2,2))*array(rep(S,each=8),dim=c(4,2,2))*RateInf2[1:4,1:2,1:2]*array(rep(apply(x[c(2,3,5,6,8),1:4,2,1:2],c(2,3),sum),2),dim=c(4,2,2)))\n    d2=-(RateStageInf[1])*sum(x[1,1,2,1:2])\n    d3=(RateDiag[1])*sum(x[1,1,2,1:2])\n    d4=(mu[1,1,1])*sum(x[1,1,2,1:2])\n    d5=-RateSusceptible*sum(x[1,1,2,1:2])\n    d6=c(d6,d1,d2,d3,d4,d5)\n    \n    #In and out compartment 1,2,1,1:2\n    d1=0\n    d2=-(RateStageInf[2])*sum(x[1,2,1,1:2])\n    d3=(RateDiag[2])*sum(x[1,2,1,1:2])\n    d4=(mu[1,2,1])*sum(x[1,2,1,1:2])\n    d5=RateSusceptible*sum(x[1,2,2,1:2])\n    d6=c(d6,d1,d2,d3,d4,d5)\n    #In and out compartment 1,2,2,1:2\n    d1=0\n    d2=-(RateStageInf[2])*sum(x[1,2,2,1:2])\n    d3=(RateDiag[2])*sum(x[1,2,2,1:2])\n    d4=(mu[1,2,1])*sum(x[1,2,2,1:2])\n    d5=-RateSusceptible*sum(x[1,2,2,1:2])\n    d6=c(d6,d1,d2,d3,d4,d5)\n    \n    #In and out compartment 1,3,1,1:2\n    d1=0\n    d2=-(RateStageInf[3])*sum(x[1,3,1,1:2])\n    d3=(RateDiag[3])*sum(x[1,3,1,1:2])\n    d4=(mu[1,3,1])*sum(x[1,3,1,1:2])\n    d5=RateSusceptible*sum(x[1,3,2,1:2])\n    d6=c(d6,d1,d2,d3,d4,d5)\n    #In and out compartment 1,3,2,1:2\n    d1=0\n    d2=-(RateStageInf[3])*sum(x[1,3,2,1:2])\n    d3=(RateDiag[3])*sum(x[1,3,2,1:2])\n    d4=(mu[1,3,1])*sum(x[1,3,2,1:2])\n    d5=RateSusceptible*sum(x[1,3,2,1:2])\n    d6=c(d6,d1,d2,d3,d4,d5)\n    \n    #In and out compartment 1,4,1,1:2\n    d1=0\n    d2=0\n    d3=(RateDiag[4])*sum(x[1,4,1,1:2])\n    d4=(mu[1,4,1])*sum(x[1,4,1,1:2])\n    d5=RateSusceptible*sum(x[1,4,2,1:2])\n    d6=c(d6,d1,d2,d3,d4,d5)\n    #In and out compartment 1,4,2,1:2\n    d1=0\n    d2=0\n    d3=(RateDiag[4])*sum(x[1,4,2,1:2])\n    d4=(mu[1,4,1])*sum(x[1,4,2,1:2])\n    d5=RateSusceptible*sum(x[1,4,2,1:2])\n    d6=c(d6,d1,d2,d3,d4,d5)\n    \n    \n    d5=0\n    \n    cd4_1_Treat_Supp=sum(RateSuppFirstSusc[1]*x[3,1,1,1:2]+RateSuppFirstResis[1]*x[3,1,2,1:2])\n    \n    #Number of new treated people\n    treat1=sum(RateTreatFirst[1]*x[2,1,1:2,1:2])\n    treat2=sum(RateTreatFirst[2]*x[2,2,1:2,1:2])\n    treat3=sum(RateTreatFirst[3]*x[2,3,1:2,1:2])\n    treat4=sum(RateTreatFirst[4]*x[2,4,1:2,1:2])\n    \n    #Number of new diagnosed people\n    diag1=sum(RateDiag[1]*x[1,1,1:2,1:2])\n    diag2=sum(RateDiag[2]*x[1,2,1:2,1:2])\n    diag3=sum(RateDiag[3]*x[1,3,1:2,1:2])\n    diag4=sum(RateDiag[4]*x[1,4,1:2,1:2])\n    \n    #Number of new infected people\n    infec1=0\n    #S[1]/sum(N)*sum(RateInf[1,1:2,1]*apply(x[c(1,2,3,5,6,8),1:4,1,1:2],c(3),sum))+S[2]/sum(N)*sum(RateInf[1,1:2,2]*apply(x[c(1,2,3,5,6,8),1:4,1,1:2],c(3),sum))+S[1]/sum(N)*sum(RateInf[1,1:2,1]*apply(x[c(1,2,3,5,6,8),1:4,2,1:2],c(3),sum))+S[2]/sum(N)*sum(RateInf[1,1:2,2]*apply(x[c(1,2,3,5,6,8),1:4,2,1:2],c(3),sum))\n    infec2=0\n    #S[1]/sum(N)*sum(RateInf[2,1:2,1]*apply(x[c(1,2,3,5,6,8),1:4,1,1:2],c(3),sum))+S[2]/sum(N)*sum(RateInf[2,1:2,2]*apply(x[c(1,2,3,5,6,8),1:4,1,1:2],c(3),sum))+S[1]/sum(N)*sum(RateInf[2,1:2,1]*apply(x[c(1,2,3,5,6,8),1:4,2,1:2],c(3),sum))+S[2]/sum(N)*sum(RateInf[2,1:2,2]*apply(x[c(1,2,3,5,6,8),1:4,2,1:2],c(3),sum))\n    infec3=0\n    #S[1]/sum(N)*sum(RateInf[3,1:2,1]*apply(x[c(1,2,3,5,6,8),1:4,1,1:2],c(3),sum))+S[2]/sum(N)*sum(RateInf[3,1:2,2]*apply(x[c(1,2,3,5,6,8),1:4,1,1:2],c(3),sum))+S[1]/sum(N)*sum(RateInf[3,1:2,1]*apply(x[c(1,2,3,5,6,8),1:4,2,1:2],c(3),sum))+S[2]/sum(N)*sum(RateInf[3,1:2,2]*apply(x[c(1,2,3,5,6,8),1:4,2,1:2],c(3),sum))\n    infec4=0\n    #S[1]/sum(N)*sum(RateInf[4,1:2,1]*apply(x[c(1,2,3,5,6,8),1:4,1,1:2],c(3),sum))+S[2]/sum(N)*sum(RateInf[4,1:2,2]*apply(x[c(1,2,3,5,6,8),1:4,1,1:2],c(3),sum))+S[1]/sum(N)*sum(RateInf[4,1:2,1]*apply(x[c(1,2,3,5,6,8),1:4,2,1:2],c(3),sum))+S[2]/sum(N)*sum(RateInf[4,1:2,2]*apply(x[c(1,2,3,5,6,8),1:4,2,1:2],c(3),sum))\n    \n    #Deaths group male female\n    death_male=sum(x[1:8,1:4,1:2,1]*mu) #1\n    death_female=sum(x[1:8,1:4,1:2,2]*mu) #2\n    \n    #new diagnosed people susceptible and diagnosed\n    newdiag_susc=sum(RateDiag*apply(x[1,1:4,1,1:2],c(1),sum))\n    newdiag_resi=sum(RateDiag*apply(x[1,1:4,2,1:2],c(1),sum))\n    ####################################################################################################################  \n    res=dx\n    return(list(c(res,newinf,death,death1,death2,death3,cd4_1_Treat_Supp,treat1,treat2,treat3,treat4,diag1,diag2,diag3,diag4,infec1,infec2,infec3,infec4,d1,d2,d3,d4,d5,death_nt1,death_nt2,death_nt3,death_nt4,death_t1,death_t2,death_t3,death_t4,death_male,death_female,newinf2,newinf3,newdiag_susc,newdiag_resi,d6,S)))\n    #return(list(c(res,newinf,newsu,newres,death)))\n    #})\n  })\n}\n\nf=function(par,parms){\n  k1=par[9]\n  k2=par[10]\n  k3=par[11]\n  start_treat=170\n  start_value=array(0,dim=c(8,4,2,2))\n  start_value[1,1:4,1,1:2]=c(apply(undiag_value,1,sum)[1]*0.42*repart_f(k1),apply(undiag_value,1,sum)[1]*0.58*repart_f(k1))\n  start_value[2,1:4,1,1:2]=c((apply(diag_value,1,sum)[1]-start_treat)*0.42*repart_f(k2),(apply(diag_value,1,sum)[1]-start_treat)*0.58*repart_f(k2))\n  start_value[3,1:4,1,1:2]=c(start_treat*0.42*repart_f(k3),start_treat*0.58*repart_f(k3))\n  start_value[1:2,1:4,1,1:2]=0.99*start_value[1:2,1:4,1,1:2]\n  start_value[1:2,1:4,2,1:2]=1/99*start_value[1:2,1:4,1,1:2]\n  start_value[3,1:4,1,1:2]=0.99*start_value[3,1:4,1,1:2]\n  start_value[3,1:4,2,1:2]=1/99*start_value[3,1:4,1,1:2]\n  xstart=c(start_value,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)\n  #RateInf,RateDiag,Ratemu,RateResist,RateTreat,alpha\n  data<-as.data.frame(lsoda(xstart, times, mod_cpp, parms=parms,p=theta))\n  new_infected=colSums(matrix(diff(data[1:121,\"129\"]),nrow=12))\n  death_aids=colSums(matrix(diff(data[1:121,\"131\"]),nrow=12))\n  undiag_people=rowSums(data[seq(1,121,12),1+seq(1,121,8)])\n  treat_people=rowSums(data[seq(1,121,12),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,121,12),1+select(1:8,1:4,1:2,1:2)])\n  \n  a=sum(dpois(round(100*newinf_value/mean(new_infected)),100*new_infected/mean(new_infected),log=TRUE))/length(newinf_value)\n  b=sum(dpois(round(100*death_value/mean(death_aids)),100*death_aids/mean(death_aids),log=TRUE))/length(death_value)\n  c=sum(dpois(round(100*apply(undiag_value,1,sum)/mean(undiag_people)),100*undiag_people/mean(undiag_people),log=TRUE))/length(undiag_people)\n  d=sum(dpois(round(100*treat_percent/mean(treat_people)),100*treat_people[6:11]/mean(treat_people),log=TRUE))/length(treat_percent)\n  \n  return(-(a+b+c+d))\n  #N=max(c(a,b,c,d))-min(c(a,b,c,d))\n  #return(-log(sum(exp(c(a,b,c,d)+rep(N,4))))+N)\n  #return(-sum(dpois(newinf_value,new_infected,log=TRUE))/length(newinf_value)-sum(dpois(round(death_value),death_aids,log=TRUE))/length(death_value)-sum(dpois(round(apply(undiag_value,1,sum)),undiag_people,log=TRUE))/length(undiag_people)-sum(dpois(round(treat_percent*100),treat_people[6:11]*100,log=TRUE))/length(treat_percent))\n}\n###########################################################################################\n#ODE function\nmod_cpp=function(t,x,p1,parms=params,p2=p2){\n  with(as.list(parms), {\n    x=x[1:(64*2)]\n    \n    ##################################################################################################################\n    #Optimization\n    rate1_inf <- p1[1] #number of unprotected sexual acts/month\n    rate2_inf <- p1[2]\n    rate1_diag <- p1[3] #diagnosis rate\n    rate2_diag <- p1[4] #diagnosis rate\n    rate_treat <- p1[5] #scale parameter for overall treatment rate\n    rate_death <- p1[6] #scale parameter for overall death\n    q <- p2[7]\n    #Range\n    rate_ratio <- p2[8] #varying parameter to estimate death for treated (but neither suppressed nor failed)\n    \n    alpha <- p2[12] #ratio between outcome when resistant/sensitive\n    rate_res <- p2[13] #resistant rate\n    rate_susc <- p2[14] #reversion rate\n    res_test <- p2[15]\n    \n    #1. Infection and Diagnosis\n    RateInf1=array(rep(RateTransm,each=4),dim=c(4,2,2))*rate1_inf\n    RateInf2=RateInf1*rate2_inf\n    \n    Diag_frame[,4]=Diag_frame[,4]*rate2_diag\n    #RateDiag[cd4]\n    RateDiag=1/rate1_diag*apply(Diag_frame,1,function(x) smooth_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))\n    #print(array(rep(RateDiag,2)*rep(c(1,diag_women),each=4),dim=c(4,2)))\n    RateDiag=array(rep(RateDiag,2)*rep(c(1,diag_women),each=4),dim=c(4,2))+\n      array(rep(oi_inc,2)*rep(smooth_st(2005+t/12,oi_test[\"a\"],oi_test[\"b\"],oi_test[\"c\"],oi_test[\"d\"]),8),dim=c(4,2))+\n      array(c(rep(0,4),preg_inc)*rep(smooth_st(2005+t/12,preg_test[\"a\"],preg_test[\"b\"],preg_test[\"c\"],preg_test[\"d\"]),8),dim=c(4,2))\n    \n    #2. Treatment theoretical (if no counterfactual scenario)\n    # RateTreatFirst_th=apply(Treat_frame,1,function(x) smooth_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*smooth_st(2005+t/12,2001,2012,1,200/12)*rate_treat\n    # RateTreatFirst_th=apply(\n    #                   data.frame(t1=apply(Treat_frame,1,function(x) lin_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"])),\n    #                   t2=apply(Treat_frame2,1,function(x) lin_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*as.numeric(2005+t/12>Treat_frame2$a[4])),\n    #                   1,max)\n    # RateTreatFirst_th=RateTreatFirst_th*smooth_st(2005+t/12,2001,2012,1,200/12)*rate_treat\n    \n    RateTreatFirst_f=function(y){\n      if(y<2005){\n        return(apply(Treat_frame_original,1,function(x) smooth_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*smooth_st(y,2001,2012,1,200/12)*rate_treat)\n      }else{\n        return(apply(\n          data.frame(t1=apply(Treat_frame,1,function(x) lin_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"])),\n                     t2=apply(Treat_frame2,1,function(x) lin_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*as.numeric(y>Treat_frame2$a[4])),\n          1,max)*smooth_st(y,2001,2012,1,200/12)*rate_treat)\n      }\n    }\n    RateTreatFirst_th=RateTreatFirst_f(2005+t/12)\n    \n    RateDirectTreatSecond_th=RateDirectTreatSecond\n    \n    if(res_test>0){\n      RateTreatFirst=matrix(c(RateTreatFirst_th,c(0,0,0,0)),nrow=2,ncol=4,byrow=T)\n      RateDirectTreatSecond=matrix(c(RateDirectTreatSecond_th,RateTreatFirst_th+RateDirectTreatSecond_th),nrow=2,ncol=4,byrow=T)\n      \n    }else{\n      RateTreatFirst=matrix(c(RateTreatFirst_th,RateTreatFirst_th),nrow=2,ncol=4,byrow=T)\n      RateDirectTreatSecond=matrix(c(RateDirectTreatSecond_th,RateDirectTreatSecond_th),nrow=2,ncol=4,byrow=T)\n    }\n    \n    #3. Death\n    #p1=min(1,q*mean(sapply(2005+seq(t-36,t,1)/12,function(x) RateTreatFirst_f(x)[4]/rate_treat)))\n    p1=1-0.27*exp(-q*(mean(sapply(2005+seq(t-36,t,1)/12,function(x) RateTreatFirst_f(x)[4])-\n                             sapply(2005+seq(-36,0,1)/12,function(x) RateTreatFirst_f(x)[4])))/rate_treat)\n    mu[1:2,4,1]=p1*40.9+(1-p1)*134.4\n    mu[4,4,1]=p1*8.3+(1-p1)*41.7\n    mu[5,4,1]=p1*11.8+(1-p1)*59.7\n    mu[3,1:4,1]=rate_ratio*mu[4,1:4,1]+(1-rate_ratio)*mu[5,1:4,1]\n    mu[6:8,1:4,1]=mu[3:5,1:4,1]\n    mu[1:8,1:4,2]=mu[1:8,1:4,1]\n    mu=mu*rate_death/1000\n    \n    #Back and forth mutation and impact on treatment outcome\n    RateResistant=1/rate_res\n    RateSusceptible=1/rate_susc\n    #From T to S\n    RateSuppFirstSusc=RateSuppFirst/1\n    RateSuppFirstResis=1/alpha*RateSuppFirst/1\n    #From S to F\n    RateFailFirstSusc=RateFailFirst*1\n    RateFailFirstResis=alpha*RateFailFirst*1\n    #From T to F\n    RateTreatToFailFirstSusc=RateTreatToFailFirst*1\n    RateTreatToFailFirstResis=alpha*RateTreatToFailFirst*1\n    #From F to S\n    RateFailToSuppTreatFirstSusc=RateFailToSuppTreatFirst/1\n    RateFailToSuppTreatFirstResis=1/alpha*RateFailToSuppTreatFirst/1\n    \n    #For second-line regimen, no effect of NNRTI resistance on treatment as it is PI\n    ##################################################################################################################\n    dx=array(0,dim=c(8,4,2,2))\n    x=array(x,dim=c(8,4,2,2))\n    I=apply(x,4,sum)\n    \n    #First approach to model S: S=N-I\n    N=N_value_f(t+1)\n    S=N-I\n    \n    \n    #people reaching 15 years old\n    dx[1,1:4,1,1:2]=rep(c(predict(inf_m,1+t/12)$y/4,predict(inf_w,1+t/12)$y/4)/12,each=4)\n    dx[1,1:4,2,1:2]=0\n    dx[2,1:4,1,1:2]=rep(c(predict(diag_m,1+t/12)$y/4,predict(diag_w,1+t/12)$y/4)/12,each=4)\n    dx[2,1:4,2,1:2]=0\n    dx[3,1:4,1,1:2]=(1-0.9*0.2)*rep(c(predict(treat_m,1+t/12)$y/4,predict(treat_w,1+t/12)$y/4)/12,each=4)\n    dx[3,1:4,2,1:2]=0.9*0.2*rep(c(predict(treat_m,1+t/12)$y/4,predict(treat_w,1+t/12)$y/4)/12,each=4)\n    \n    for(j in 1:2){\n      #dx[x1,x2,x3,x4] x1:care stages x2:disease progression x3:resistance x4:gender\n      #dx with only interaction with the neighbours in the compartmental model\n      dx[1,1,1,j]=dx[1,1,1,j]+S[j]/N[j]*(sum(RateInf1[1:4,1:2,j]*apply(x[c(1),1:4,1,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,j]*apply(x[c(2,3,5,6,8),1:4,1,1:2],c(2,3),sum)))-\n        (RateStageInf[1]+RateDiag[1,j]+mu[1,1,1])*x[1,1,1,j]\n      dx[2,1,1,j]=dx[2,1,1,j]+RateDiag[1,j]*x[1,1,1,j]-(RateTreatFirst[1,1]+RateStageDiag[1]+mu[2,1,1])*x[2,1,1,j]\n      dx[3,1,1,j]=dx[3,1,1,j]+RateTreatFirst[1,1]*x[2,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[3,1,1,j]+RateStageTreatFirstL[1]*x[3,2,1,j]\n      dx[4,1,1,j]=RateSuppFirstSusc[1]*x[3,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[4,1,1,j]+RateStageSuppFirst[1]*x[4,2,1,j]\n      dx[5,1,1,j]=RateFailFirstSusc[1]*x[4,1,1,j]-(RateTreatSecond[1]+RateStageFailFirst[1]+mu[5,1,1])*x[5,1,1,j]\n      dx[6,1,1,j]=RateTreatSecond[1]*x[5,1,1,j]-(RateSuppSecond[1]+RateStageTreatSecondR[1]+mu[6,1,1])*x[6,1,1,j]+RateStageTreatSecondL[1]*x[6,2,1,j]\n      dx[7,1,1,j]=RateSuppSecond[1]*x[6,1,1,j]-(RateFailSecond[1]+mu[7,1,1])*x[7,1,1,j]+RateStageSuppSecond[1]*x[7,2,1,j]\n      dx[8,1,1,j]=RateFailSecond[1]*x[7,1,1,j]-(RateStageFailSecond[1]+mu[8,1,1])*x[8,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]-(RateStageInf[2]+RateDiag[2,j]+mu[1,2,1])*x[1,2,1,j]+RateStageInf[1]*x[1,1,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]+RateDiag[2,j]*x[1,2,1,j]-(RateTreatFirst[1,2]+RateStageDiag[2]+mu[2,2,1])*x[2,2,1,j]+RateStageDiag[1]*x[2,1,1,j]\n      dx[3,2,1,j]=dx[3,2,1,j]+RateTreatFirst[1,2]*x[2,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[3,2,1,j]+RateStageTreatFirstR[1]*x[3,1,1,j]+RateStageTreatFirstL[2]*x[3,3,1,j]\n      dx[4,2,1,j]=RateSuppFirstSusc[2]*x[3,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[4,2,1,j]+RateStageSuppFirst[2]*x[4,3,1,j]\n      dx[5,2,1,j]=RateFailFirstSusc[2]*x[4,2,1,j]-(RateTreatSecond[2]+RateStageFailFirst[2]+mu[5,2,1])*x[5,2,1,j]+RateStageFailFirst[1]*x[5,1,1,j]\n      dx[6,2,1,j]=RateTreatSecond[2]*x[5,2,1,j]-(RateSuppSecond[2]+RateStageTreatSecondR[2]+RateStageTreatSecondL[1]+mu[6,2,1 ])*x[6,2,1,j]+RateStageTreatSecondR[1]*x[6,1,1,j]+RateStageTreatSecondL[2]*x[6,3,1,j]\n      dx[7,2,1,j]=RateSuppSecond[2]*x[6,2,1,j]-(RateFailSecond[2]+RateStageSuppSecond[1]+mu[7,2,1])*x[7,2,1,j]+RateStageSuppSecond[2]*x[7,3,1,j]\n      dx[8,2,1,j]=RateFailSecond[2]*x[7,2,1,j]-(RateStageFailSecond[2]+mu[8,2,1])*x[8,2,1,j]+RateStageFailSecond[1]*x[8,1,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]-(RateStageInf[3]+RateDiag[3,j]+mu[1,3,1])*x[1,3,1,j]+RateStageInf[2]*x[1,2,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]+RateDiag[3,j]*x[1,3,1,j]-(RateTreatFirst[1,3]+RateStageDiag[3]+mu[2,3,1])*x[2,3,1,j]+RateStageDiag[2]*x[2,2,1,j]\n      dx[3,3,1,j]=dx[3,3,1,j]+RateTreatFirst[1,3]*x[2,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[3,3,1,j]+RateStageTreatFirstR[2]*x[3,2,1,j]+RateStageTreatFirstL[3]*x[3,4,1,j]\n      dx[4,3,1,j]=RateSuppFirstSusc[3]*x[3,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[4,3,1,j]+RateStageSuppFirst[3]*x[4,4,1,j]\n      dx[5,3,1,j]=RateFailFirstSusc[3]*x[4,3,1,j]-(RateTreatSecond[3]+RateStageFailFirst[3]+mu[5,3,1])*x[5,3,1,j]+RateStageFailFirst[2]*x[5,2,1,j]\n      dx[6,3,1,j]=RateTreatSecond[3]*x[5,3,1,j]-(RateSuppSecond[3]+RateStageTreatSecondR[3]+RateStageTreatSecondL[2]+mu[6,3,1])*x[6,3,1,j]+RateStageTreatSecondR[2]*x[6,2,1,j]+RateStageTreatSecondL[3]*x[6,4,1,j]\n      dx[7,3,1,j]=RateSuppSecond[3]*x[6,3,1,j]-(RateFailSecond[3]+RateStageSuppSecond[2]+mu[7,3,1])*x[7,3,1,j]+RateStageSuppSecond[3]*x[7,4,1,j]\n      dx[8,3,1,j]=RateFailSecond[3]*x[7,3,1,j]-(RateStageFailSecond[3]+mu[8,3,1])*x[8,3,1,j]+RateStageFailSecond[2]*x[8,2,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]-(RateDiag[4,j]+mu[1,4,1])*x[1,4,1,j]+RateStageInf[3]*x[1,3,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]+RateDiag[4,j]*x[1,4,1,j]-(RateTreatFirst[1,4]+mu[2,4,1])*x[2,4,1,j]+RateStageDiag[3]*x[2,3,1,j]\n      dx[3,4,1,j]=dx[3,4,1,j]+RateTreatFirst[1,4]*x[2,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[3,4,1,j]+RateStageTreatFirstR[3]*x[3,3,1,j]\n      dx[4,4,1,j]=RateSuppFirstSusc[4]*x[3,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[4,4,1,j]\n      dx[5,4,1,j]=RateFailFirstSusc[4]*x[4,4,1,j]-(RateTreatSecond[4]+mu[5,4,1])*x[5,4,1,j]+RateStageFailFirst[3]*x[5,3,1,j]\n      dx[6,4,1,j]=RateTreatSecond[4]*x[5,4,1,j]-(RateSuppSecond[4]+RateStageTreatSecondL[3]+mu[6,4,1])*x[6,4,1,j]+RateStageTreatSecondR[3]*x[6,3,1,j]\n      dx[7,4,1,j]=RateSuppSecond[4]*x[6,4,1,j]-(RateFailSecond[4]+RateStageSuppSecond[3]+mu[7,4,1])*x[7,4,1,j]\n      dx[8,4,1,j]=RateFailSecond[4]*x[7,4,1,j]-mu[8,4,1 ]*x[8,4,1,j]+RateStageFailSecond[3]*x[8,3,1,j]\n      \n      ##############################################################################################################################################################\n      \n      dx[1,1,1,j]=dx[1,1,1,j]\n      dx[2,1,1,j]=dx[2,1,1,j]-RateDirectTreatSecond[1,1]*x[2,1,1,j]+RateStopTreatFirst[1]*x[3,1,1,j]+RateStopSuppFirst[1]*x[4,1,1,j]+RateStopFailFirst[1]*x[5,1,1,j]+\n        RateStopTreatSecond[1]*x[6,1,1,j]+RateStopSuppSecond[1]*x[7,1,1,j]+RateStopFailSecond[1]*x[8,1,1,j]\n      dx[3,1,1,j]=dx[3,1,1,j]-RateStopTreatFirst[1]*x[3,1,1,j]-RateTreatToFailFirstSusc[1]*x[3,1,1,j]\n      dx[4,1,1,j]=dx[4,1,1,j]-RateStopSuppFirst[1]*x[4,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[5,1,1,j]-RateSuppFirstToSecond[1]*x[4,1,1,j]\n      dx[5,1,1,j]=dx[5,1,1,j]-RateStopFailFirst[1]*x[5,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[5,1,1,j]+RateTreatToFailFirstSusc[1]*x[3,1,1,j]\n      dx[6,1,1,j]=dx[6,1,1,j]-RateStopTreatSecond[1]*x[6,1,1,j]+RateDirectTreatSecond[1,1]*x[2,1,1,j]-RateTreatToFailSecond[1]*x[6,1,1,j]\n      dx[7,1,1,j]=dx[7,1,1,j]-RateStopSuppSecond[1]*x[7,1,1,j]+RateFailToSuppTreatSecond[1]*x[8,1,1,j]+RateSuppFirstToSecond[1]*x[4,1,1,j]\n      dx[8,1,1,j]=dx[8,1,1,j]-RateStopFailSecond[1]*x[8,1,1,j]-RateFailToSuppTreatSecond[1]*x[8,1,1,j]+RateTreatToFailSecond[1]*x[6,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]-RateDirectTreatSecond[1,2]*x[2,2,1,j]+RateStopTreatFirst[2]*x[3,2,1,j]+RateStopSuppFirst[2]*x[4,2,1,j]+RateStopFailFirst[2]*x[5,2,1,j]+\n        RateStopTreatSecond[2]*x[6,2,1,j]+RateStopSuppSecond[2]*x[7,2,1,j]+RateStopFailSecond[2]*x[8,2,1,j]\n      dx[3,2,1,j]=dx[3,2,1,j]-RateStopTreatFirst[2]*x[3,2,1,j]-RateTreatToFailFirstSusc[2]*x[3,2,1,j]\n      dx[4,2,1,j]=dx[4,2,1,j]-RateStopSuppFirst[2]*x[4,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[5,2,1,j]-RateSuppFirstToSecond[2]*x[4,2,1,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateStopFailFirst[2]*x[5,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[5,2,1,j]+RateTreatToFailFirstSusc[2]*x[3,2,1,j]\n      dx[6,2,1,j]=dx[6,2,1,j]-RateStopTreatSecond[2]*x[6,2,1,j]+RateDirectTreatSecond[1,2]*x[2,2,1,j]-RateTreatToFailSecond[2]*x[6,2,1,j]\n      dx[7,2,1,j]=dx[7,2,1,j]-RateStopSuppSecond[2]*x[7,2,1,j]+RateFailToSuppTreatSecond[2]*x[8,2,1,j]+RateSuppFirstToSecond[2]*x[4,2,1,j]\n      dx[8,2,1,j]=dx[8,2,1,j]-RateStopFailSecond[2]*x[8,2,1,j]-RateFailToSuppTreatSecond[2]*x[8,2,1,j]+RateTreatToFailSecond[2]*x[6,2,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]-RateDirectTreatSecond[1,3]*x[2,3,1,j]+RateStopTreatFirst[3]*x[3,3,1,j]+RateStopSuppFirst[3]*x[4,3,1,j]+RateStopFailFirst[3]*x[5,3,1,j]+\n        RateStopTreatSecond[3]*x[6,3,1,j]+RateStopSuppSecond[3]*x[7,3,1,j]+RateStopFailSecond[3]*x[8,3,1,j]\n      dx[3,3,1,j]=dx[3,3,1,j]-RateStopTreatFirst[3]*x[3,3,1,j]-RateTreatToFailFirstSusc[3]*x[3,3,1,j]\n      dx[4,3,1,j]=dx[4,3,1,j]-RateStopSuppFirst[3]*x[4,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[5,3,1,j]-RateSuppFirstToSecond[3]*x[4,3,1,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateStopFailFirst[3]*x[5,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[5,3,1,j]+RateTreatToFailFirstSusc[3]*x[3,3,1,j]\n      dx[6,3,1,j]=dx[6,3,1,j]-RateStopTreatSecond[3]*x[6,3,1,j]+RateDirectTreatSecond[1,3]*x[2,3,1,j]-RateTreatToFailSecond[3]*x[6,3,1,j]\n      dx[7,3,1,j]=dx[7,3,1,j]-RateStopSuppSecond[3]*x[7,3,1,j]+RateFailToSuppTreatSecond[3]*x[8,3,1,j]+RateSuppFirstToSecond[3]*x[4,3,1,j]\n      dx[8,3,1,j]=dx[8,3,1,j]-RateStopFailSecond[3]*x[8,3,1,j]-RateFailToSuppTreatSecond[3]*x[8,3,1,j]+RateTreatToFailSecond[3]*x[6,3,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]-RateDirectTreatSecond[1,4]*x[2,4,1,j]+RateStopTreatFirst[4]*x[3,4,1,j]+RateStopSuppFirst[4]*x[4,4,1,j]+RateStopFailFirst[4]*x[5,4,1,j]+\n        RateStopTreatSecond[4]*x[6,4,1,j]+RateStopSuppSecond[4]*x[7,4,1,j]+RateStopFailSecond[4]*x[8,4,1,j]\n      dx[3,4,1,j]=dx[3,4,1,j]-RateStopTreatFirst[4]*x[3,4,1,j]-RateTreatToFailFirstSusc[4]*x[3,4,1,j]\n      dx[4,4,1,j]=dx[4,4,1,j]-RateStopSuppFirst[4]*x[4,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[5,4,1,j]-RateSuppFirstToSecond[4]*x[4,4,1,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateStopFailFirst[4]*x[5,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[5,4,1,j]+RateTreatToFailFirstSusc[4]*x[3,4,1,j]\n      dx[6,4,1,j]=dx[6,4,1,j]-RateStopTreatSecond[4]*x[6,4,1,j]+RateDirectTreatSecond[1,4]*x[2,4,1,j]-RateTreatToFailSecond[4]*x[6,4,1,j]\n      dx[7,4,1,j]=dx[7,4,1,j]-RateStopSuppSecond[4]*x[7,4,1,j]+RateFailToSuppTreatSecond[4]*x[8,4,1,j]+RateSuppFirstToSecond[4]*x[4,4,1,j]\n      dx[8,4,1,j]=dx[8,4,1,j]-RateStopFailSecond[4]*x[8,4,1,j]-RateFailToSuppTreatSecond[4]*x[8,4,1,j]+RateTreatToFailSecond[4]*x[6,4,1,j]\n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      dx[1,1,2,j]=dx[1,1,2,j]+S[j]/N[j]*(sum(RateInf1[1:4,1:2,j]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,j]*apply(x[c(2,3,5,6,8),1:4,2,1:2],c(2,3),sum)))-\n        (RateStageInf[1]+RateDiag[1,j]+mu[1,1,2 ])*x[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]+RateDiag[1,j]*x[1,1,2,j]-(RateTreatFirst[2,1]+RateStageDiag[1]+mu[2,1,2 ])*x[2,1,2,j]\n      dx[3,1,2,j]=dx[3,1,2,j]+RateTreatFirst[2,1]*x[2,1,2,j]-(RateSuppFirstResis[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[3,1,2,j]+RateStageTreatFirstL[1]*x[3,2,2,j]\n      dx[4,1,2,j]=RateSuppFirstResis[1]*x[3,1,2,j]-(RateFailFirstResis[1]+mu[4,1,2])*x[4,1,2,j]+RateStageSuppFirst[1]*x[4,2,2,j]\n      dx[5,1,2,j]=RateFailFirstResis[1]*x[4,1,2,j]-(RateTreatSecond[1]+RateStageFailFirst[1]+mu[5,1,2 ])*x[5,1,2,j]\n      dx[6,1,2,j]=RateTreatSecond[1]*x[5,1,2,j]-(RateSuppSecond[1]+RateStageTreatSecondR[1]+mu[6,1,2 ])*x[6,1,2,j]+RateStageTreatSecondL[1]*x[6,2,2,j]\n      dx[7,1,2,j]=RateSuppSecond[1]*x[6,1,2,j]-(RateFailSecond[1]+mu[7,1,2])*x[7,1,2,j]+RateStageSuppSecond[1]*x[7,2,2,j]\n      dx[8,1,2,j]=RateFailSecond[1]*x[7,1,2,j]-(RateStageFailSecond[1]+mu[8,1,2])*x[8,1,2,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]-(RateStageInf[2]+RateDiag[2,j]+mu[1,2,2])*x[1,2,2,j]+RateStageInf[1]*x[1,1,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]+RateDiag[2,j]*x[1,2,2,j]-(RateTreatFirst[2,2]+RateStageDiag[2]+mu[2,2,2])*x[2,2,2,j]+RateStageDiag[1]*x[2,1,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]+RateTreatFirst[2,2]*x[2,2,2,j]-(RateSuppFirstResis[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2 ])*x[3,2,2,j]+RateStageTreatFirstR[1]*x[3,1,2,j]+RateStageTreatFirstL[2]*x[3,3,2,j]\n      dx[4,2,2,j]=RateSuppFirstResis[2]*x[3,2,2,j]-(RateFailFirstResis[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[4,2,2,j]+RateStageSuppFirst[2]*x[4,3,2,j]\n      dx[5,2,2,j]=RateFailFirstResis[2]*x[4,2,2,j]-(RateTreatSecond[2]+RateStageFailFirst[2]+mu[5,2,2])*x[5,2,2,j]+RateStageFailFirst[1]*x[5,1,2,j]\n      dx[6,2,2,j]=RateTreatSecond[2]*x[5,2,2,j]-(RateSuppSecond[2]+RateStageTreatSecondR[2]+RateStageTreatSecondL[1]+mu[6,2,2])*x[6,2,2,j]+RateStageTreatSecondR[1]*x[6,1,2,j]+RateStageTreatSecondL[2]*x[6,3,2,j]\n      dx[7,2,2,j]=RateSuppSecond[2]*x[6,2,2,j]-(RateFailSecond[2]+RateStageSuppSecond[1]+mu[7,2,2])*x[7,2,2,j]+RateStageSuppSecond[2]*x[7,3,2,j]\n      dx[8,2,2,j]=RateFailSecond[2]*x[7,2,2,j]-(RateStageFailSecond[2]+mu[8,2,2])*x[8,2,2,j]+RateStageFailSecond[1]*x[8,1,2,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]-(RateStageInf[3]+RateDiag[3,j]+mu[1,3,2])*x[1,3,2,j]+RateStageInf[2]*x[1,2,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]+RateDiag[3,j]*x[1,3,2,j]-(RateTreatFirst[2,3]+RateStageDiag[3]+mu[2,3,2])*x[2,3,2,j]+RateStageDiag[2]*x[2,2,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]+RateTreatFirst[2,3]*x[2,3,2,j]-(RateSuppFirstResis[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[3,3,2,j]+RateStageTreatFirstR[2]*x[3,2,2,j]+RateStageTreatFirstL[3]*x[3,4,2,j]\n      dx[4,3,2,j]=RateSuppFirstResis[3]*x[3,3,2,j]-(RateFailFirstResis[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[4,3,2,j]+RateStageSuppFirst[3]*x[4,4,2,j]\n      dx[5,3,2,j]=RateFailFirstResis[3]*x[4,3,2,j]-(RateTreatSecond[3]+RateStageFailFirst[3]+mu[5,3,2])*x[5,3,2,j]+RateStageFailFirst[2]*x[5,2,2,j]\n      dx[6,3,2,j]=RateTreatSecond[3]*x[5,3,2,j]-(RateSuppSecond[3]+RateStageTreatSecondR[3]+RateStageTreatSecondL[2]+mu[6,3,2])*x[6,3,2,j]+RateStageTreatSecondR[2]*x[6,2,2,j]+RateStageTreatSecondL[3]*x[6,4,2,j]\n      dx[7,3,2,j]=RateSuppSecond[3]*x[6,3,2,j]-(RateFailSecond[3]+RateStageSuppSecond[2]+mu[7,3,2])*x[7,3,2,j]+RateStageSuppSecond[3]*x[7,4,2,j]\n      dx[8,3,2,j]=RateFailSecond[3]*x[7,3,2,j]-(RateStageFailSecond[3]+mu[8,3,2])*x[8,3,2,j]+RateStageFailSecond[2]*x[8,2,2,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]-(RateDiag[4,j]+mu[1,4,2])*x[1,4,2,j]+RateStageInf[3]*x[1,3,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]+RateDiag[4,j]*x[1,4,2,j]-(RateTreatFirst[2,4]+mu[2,4,2])*x[2,4,2,j]+RateStageDiag[3]*x[2,3,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]+RateTreatFirst[2,4]*x[2,4,2,j]-(RateSuppFirstResis[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[3,4,2,j]+RateStageTreatFirstR[3]*x[3,3,2,j]\n      dx[4,4,2,j]=RateSuppFirstResis[4]*x[3,4,2,j]-(RateFailFirstResis[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[4,4,2,j]\n      dx[5,4,2,j]=RateFailFirstResis[4]*x[4,4,2,j]-(RateTreatSecond[4]+mu[5,4,2])*x[5,4,2,j]+RateStageFailFirst[3]*x[5,3,2,j]\n      dx[6,4,2,j]=RateTreatSecond[4]*x[5,4,2,j]-(RateSuppSecond[4]+RateStageTreatSecondL[3]+mu[6,4,2])*x[6,4,2,j]+RateStageTreatSecondR[3]*x[6,3,2,j]\n      dx[7,4,2,j]=RateSuppSecond[4]*x[6,4,2,j]-(RateFailSecond[4]+RateStageSuppSecond[3]+mu[7,4,2])*x[7,4,2,j]\n      dx[8,4,2,j]=RateFailSecond[4]*x[7,4,2,j]-mu[8,4,2]*x[8,4,2,j]+RateStageFailSecond[3]*x[8,3,2,j]\n      \n      ##############################################################################################################################################################\n      \n      dx[1,1,2,j]=dx[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]-RateDirectTreatSecond[2,1]*x[2,1,2,j]+RateStopTreatFirst[1]*x[3,1,2,j]+RateStopSuppFirst[1]*x[4,1,2,j]+RateStopFailFirst[1]*x[5,1,2,j]+\n        RateStopTreatSecond[1]*x[6,1,2,j]+RateStopSuppSecond[1]*x[7,1,2,j]+RateStopFailSecond[1]*x[8,1,2,j]\n      dx[3,1,2,j]=dx[3,1,2,j]-RateStopTreatFirst[1]*x[3,1,2,j]-RateTreatToFailFirstResis[1]*x[3,1,2,j]\n      dx[4,1,2,j]=dx[4,1,2,j]-RateStopSuppFirst[1]*x[4,1,2,j]+RateFailToSuppTreatFirstResis[1]*x[5,1,2,j]-RateSuppFirstToSecond[1]*x[4,1,2,j]\n      dx[5,1,2,j]=dx[5,1,2,j]-RateStopFailFirst[1]*x[5,1,2,j]-RateFailToSuppTreatFirstResis[1]*x[5,1,2,j]+RateTreatToFailFirstResis[1]*x[3,1,2,j]\n      dx[6,1,2,j]=dx[6,1,2,j]-RateStopTreatSecond[1]*x[6,1,2,j]+RateDirectTreatSecond[2,1]*x[2,1,2,j]-RateTreatToFailSecond[1]*x[6,1,2,j]\n      dx[7,1,2,j]=dx[7,1,2,j]-RateStopSuppSecond[1]*x[7,1,2,j]+RateFailToSuppTreatSecond[1]*x[8,1,2,j]+RateSuppFirstToSecond[1]*x[4,1,2,j]\n      dx[8,1,2,j]=dx[8,1,2,j]-RateStopFailSecond[1]*x[8,1,2,j]-RateFailToSuppTreatSecond[1]*x[8,1,2,j]+RateTreatToFailSecond[1]*x[6,1,2,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateDirectTreatSecond[2,2]*x[2,2,2,j]+RateStopTreatFirst[2]*x[3,2,2,j]+RateStopSuppFirst[2]*x[4,2,2,j]+RateStopFailFirst[2]*x[5,2,2,j]+\n        RateStopTreatSecond[2]*x[6,2,2,j]+RateStopSuppSecond[2]*x[7,2,2,j]+RateStopFailSecond[2]*x[8,2,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]-RateStopTreatFirst[2]*x[3,2,2,j]-RateTreatToFailFirstResis[2]*x[3,2,2,j]\n      dx[4,2,2,j]=dx[4,2,2,j]-RateStopSuppFirst[2]*x[4,2,2,j]+RateFailToSuppTreatFirstResis[2]*x[5,2,2,j]-RateSuppFirstToSecond[2]*x[4,2,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]-RateStopFailFirst[2]*x[5,2,2,j]-RateFailToSuppTreatFirstResis[2]*x[5,2,2,j]+RateTreatToFailFirstResis[2]*x[3,2,2,j]\n      dx[6,2,2,j]=dx[6,2,2,j]-RateStopTreatSecond[2]*x[6,2,2,j]+RateDirectTreatSecond[2,2]*x[2,2,2,j]-RateTreatToFailSecond[2]*x[6,2,2,j]\n      dx[7,2,2,j]=dx[7,2,2,j]-RateStopSuppSecond[2]*x[7,2,2,j]+RateFailToSuppTreatSecond[2]*x[8,2,2,j]+RateSuppFirstToSecond[2]*x[4,2,2,j]\n      dx[8,2,2,j]=dx[8,2,2,j]-RateStopFailSecond[2]*x[8,2,2,j]-RateFailToSuppTreatSecond[2]*x[8,2,2,j]+RateTreatToFailSecond[2]*x[6,2,2,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateDirectTreatSecond[2,3]*x[2,3,2,j]+RateStopTreatFirst[3]*x[3,3,2,j]+RateStopSuppFirst[3]*x[4,3,2,j]+RateStopFailFirst[3]*x[5,3,2,j]+\n        RateStopTreatSecond[3]*x[6,3,2,j]+RateStopSuppSecond[3]*x[7,3,2,j]+RateStopFailSecond[3]*x[8,3,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]-RateStopTreatFirst[3]*x[3,3,2,j]-RateTreatToFailFirstResis[3]*x[3,3,2,j]\n      dx[4,3,2,j]=dx[4,3,2,j]-RateStopSuppFirst[3]*x[4,3,2,j]+RateFailToSuppTreatFirstResis[3]*x[5,3,2,j]-RateSuppFirstToSecond[3]*x[4,3,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]-RateStopFailFirst[3]*x[5,3,2,j]-RateFailToSuppTreatFirstResis[3]*x[5,3,2,j]+RateTreatToFailFirstResis[3]*x[3,3,2,j]\n      dx[6,3,2,j]=dx[6,3,2,j]-RateStopTreatSecond[3]*x[6,3,2,j]+RateDirectTreatSecond[2,3]*x[2,3,2,j]-RateTreatToFailSecond[3]*x[6,3,2,j]\n      dx[7,3,2,j]=dx[7,3,2,j]-RateStopSuppSecond[3]*x[7,3,2,j]+RateFailToSuppTreatSecond[3]*x[8,3,2,j]+RateSuppFirstToSecond[3]*x[4,3,2,j]\n      dx[8,3,2,j]=dx[8,3,2,j]-RateStopFailSecond[3]*x[8,3,2,j]-RateFailToSuppTreatSecond[3]*x[8,3,2,j]+RateTreatToFailSecond[3]*x[6,3,2,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateDirectTreatSecond[2,4]*x[2,4,2,j]+RateStopTreatFirst[4]*x[3,4,2,j]+RateStopSuppFirst[4]*x[4,4,2,j]+RateStopFailFirst[4]*x[5,4,2,j]+\n        RateStopTreatSecond[4]*x[6,4,2,j]+RateStopSuppSecond[4]*x[7,4,2,j]+RateStopFailSecond[4]*x[8,4,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]-RateStopTreatFirst[4]*x[3,4,2,j]-RateTreatToFailFirstResis[4]*x[3,4,2,j]\n      dx[4,4,2,j]=dx[4,4,2,j]-RateStopSuppFirst[4]*x[4,4,2,j]+RateFailToSuppTreatFirstResis[4]*x[5,4,2,j]-RateSuppFirstToSecond[4]*x[4,4,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]-RateStopFailFirst[4]*x[5,4,2,j]-RateFailToSuppTreatFirstResis[4]*x[5,4,2,j]+RateTreatToFailFirstResis[4]*x[3,4,2,j]\n      dx[6,4,2,j]=dx[6,4,2,j]-RateStopTreatSecond[4]*x[6,4,2,j]+RateDirectTreatSecond[2,4]*x[2,4,2,j]-RateTreatToFailSecond[4]*x[6,4,2,j]\n      dx[7,4,2,j]=dx[7,4,2,j]-RateStopSuppSecond[4]*x[7,4,2,j]+RateFailToSuppTreatSecond[4]*x[8,4,2,j]+RateSuppFirstToSecond[4]*x[4,4,2,j]\n      dx[8,4,2,j]=dx[8,4,2,j]-RateStopFailSecond[4]*x[8,4,2,j]-RateFailToSuppTreatSecond[4]*x[8,4,2,j]+RateTreatToFailSecond[4]*x[6,4,2,j]\n      \n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      #dx with interaction between resistant and Resiseptible compartments\n      dx[1,1,1,j]=dx[1,1,1,j]+RateSusceptible*x[1,1,2,j]\n      dx[2,1,1,j]=dx[2,1,1,j]+RateSusceptible*x[2,1,2,j]\n      dx[3,1,1,j]=dx[3,1,1,j]\n      dx[4,1,1,j]=dx[4,1,1,j]\n      dx[5,1,1,j]=dx[5,1,1,j]-RateResistant*x[5,1,1,j]\n      dx[6,1,1,j]=dx[6,1,1,j]\n      dx[7,1,1,j]=dx[7,1,1,j]\n      dx[8,1,1,j]=dx[8,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]+RateSusceptible*x[1,2,2,j]\n      dx[2,2,1,j]=dx[2,2,1,j]+RateSusceptible*x[2,2,2,j]\n      dx[3,2,1,j]=dx[3,2,1,j]\n      dx[4,2,1,j]=dx[4,2,1,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateResistant*x[5,2,1,j]\n      dx[6,2,1,j]=dx[6,2,1,j]\n      dx[7,2,1,j]=dx[7,2,1,j]\n      dx[8,2,1,j]=dx[8,2,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]+RateSusceptible*x[1,3,2,j]\n      dx[2,3,1,j]=dx[2,3,1,j]+RateSusceptible*x[2,3,2,j]\n      dx[3,3,1,j]=dx[3,3,1,j]\n      dx[4,3,1,j]=dx[4,3,1,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateResistant*x[5,3,1,j]\n      dx[6,3,1,j]=dx[6,3,1,j]\n      dx[7,3,1,j]=dx[7,3,1,j]\n      dx[8,3,1,j]=dx[8,3,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]+RateSusceptible*x[1,4,2,j]\n      dx[2,4,1,j]=dx[2,4,1,j]+RateSusceptible*x[2,4,2,j]\n      dx[3,4,1,j]=dx[3,4,1,j]\n      dx[4,4,1,j]=dx[4,4,1,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateResistant*x[5,4,1,j]\n      dx[6,4,1,j]=dx[6,4,1,j]\n      dx[7,4,1,j]=dx[7,4,1,j]\n      dx[8,4,1,j]=dx[8,4,1,j]\n      \n      #############################################################################################################################################################################\n      dx[1,1,2,j]=dx[1,1,2,j]-RateSusceptible*x[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]-RateSusceptible*x[2,1,2,j]\n      dx[3,1,2,j]=dx[3,1,2,j]\n      dx[4,1,2,j]=dx[4,1,2,j]\n      dx[5,1,2,j]=dx[5,1,2,j]+RateResistant*x[5,1,1,j]\n      dx[6,1,2,j]=dx[6,1,2,j]\n      dx[7,1,2,j]=dx[7,1,2,j]\n      dx[8,1,2,j]=dx[8,1,2,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]-RateSusceptible*x[1,2,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateSusceptible*x[2,2,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]\n      dx[4,2,2,j]=dx[4,2,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]+RateResistant*x[5,2,1,j]\n      dx[6,2,2,j]=dx[6,2,2,j]\n      dx[7,2,2,j]=dx[7,2,2,j]\n      dx[8,2,2,j]=dx[8,2,2,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]-RateSusceptible*x[1,3,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateSusceptible*x[2,3,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]\n      dx[4,3,2,j]=dx[4,3,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]+RateResistant*x[5,3,1,j]\n      dx[6,3,2,j]=dx[6,3,2,j]\n      dx[7,3,2,j]=dx[7,3,2,j]\n      dx[8,3,2,j]=dx[8,3,2,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]-RateSusceptible*x[1,4,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateSusceptible*x[2,4,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]\n      dx[4,4,2,j]=dx[4,4,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]+RateResistant*x[5,4,1,j]\n      dx[6,4,2,j]=dx[6,4,2,j]\n      dx[7,4,2,j]=dx[7,4,2,j]\n      dx[8,4,2,j]=dx[8,4,2,j]\n    }\n    dx[(dx+x)<0]=0\n    #new_infections\n    new_inf=S[1]/N[1]*(sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,1:2,1:2],c(1,3),sum))+\n                         sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8),1:4,1:2,1:2],c(2,4),sum)))+\n      S[2]/N[2]*(sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,1:2,1:2],c(1,3),sum))+\n                   sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8),1:4,1:2,1:2],c(2,4),sum)))\n    \n    #new_infections resistant\n    new_inf_res=S[1]/N[1]*(sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+\n                             sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8),1:4,2,1:2],c(2,3),sum)))+\n      S[2]/N[2]*(sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+\n                   sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8),1:4,2,1:2],c(2,3),sum)))\n    \n    #death\n    death=sum(apply(x[1:8,1:4,1:2,1:2],c(1,2,3),sum)*mu)\n    \n    #death\n    death_infectious=sum(apply(x[c(1,2,3,5,6,8),1:4,1:2,1:2],c(1,2,3),sum)*mu[c(1,2,3,5,6,8),1:4,1:2])\n    \n    \n    #death resistant\n    death_res=sum(apply(x[1:8,1:4,2,1:2],c(1,2),sum)*mu[1:8,1:4,2])\n    \n    #new treated\n    new_treat=sum(RateTreatFirst[1:2,1:4]*t(apply(x[2,1:4,1:2,1:2],c(1,2),sum)))+\n      sum(RateDirectTreatSecond[1:2,1:4]*t(apply(x[2,1:4,1:2,1:2],c(1,2),sum)))\n    #new treated resistant\n    new_treat_res=sum(RateTreatFirst[2,1:4]*t(apply(x[2,1:4,2,1:2],c(1),sum)))+\n      sum(RateDirectTreatSecond[2,1:4]*t(apply(x[2,1:4,2,1:2],c(1),sum)))\n    \n    #new diagnosed susceptible\n    new_diag_susc=sum(RateDiag[1:4,1:2]*x[1,1:4,1,1:2])\n    #new diagnosed resistant\n    new_diag_res=sum(RateDiag[1:4,1:2]*x[1,1:4,2,1:2])\n    \n    #reviewer 2 response, proportion of ADR among res ind failing 1st-line\n    res_fail=sum(RateFailFirstResis[1:4]*apply(x[4,1:4,2,1:2],1,sum))+\n      sum(RateTreatToFailFirstResis[1:4]*apply(x[3,1:4,2,1:2],1,sum))\n    res_acq=sum(RateResistant*x[5,1:4,1,1:2])\n    \n    #new adr\n    new_adr=sum(x[c(5),1:4,1,1:2])*RateResistant\n    new_fail_susc=sum(RateFailFirstSusc[1:4]*apply(x[4,1:4,1,1:2],1,sum))+sum(RateTreatToFailFirstSusc[1:4]*apply(x[3,1:4,1,1:2],1,sum))\n    new_fail_res=sum(RateFailFirstResis[1:4]*apply(x[4,1:4,2,1:2],1,sum))+sum(RateTreatToFailFirstResis[1:4]*apply(x[3,1:4,2,1:2],1,sum))\n    \n    #reviewr 3 response no effect of baseline drug resistanct testing\n    t1=sum(RateTreatFirst[1:2,1:4]*t(apply(x[2,1:4,1:2,1:2],c(1,2),sum))) #go to 1st-line\n    t2=sum(matrix(rep(RateDirectTreatSecond_th,2),nrow=2,ncol=4)*t(apply(x[2,1:4,1:2,1:2],c(1,2),sum))) #go to second-line without rt\n    t3<-ifelse(res_test==0,0,sum(RateTreatFirst_th*apply(x[2,1:4,2,1:2],c(1),sum))) #go to second-line because rt\n    \n    #dx[3:8,1:4,1,1:2]=dx[3:8,1:4,1,1:2]+infected_m15_month[t+1]*x[3:8,1:4,1,1:2]/sum(x[3:8,1:4,1,1:2])\n    ####################################################################################################################  \n    res=c(dx,new_inf,death,new_treat,new_inf_res,death_infectious,new_treat_res,new_diag_susc,new_diag_res,new_adr,death_infectious)\n    #res=c(dx,new_inf,death,new_treat,new_inf_res,death_infectious,new_treat_res,new_diag_susc,new_diag_res,new_fail_susc,new_fail_res)\n    #reviewer 2 response, proportion of ADR among res ind failing 1st-line\n    #res=c(dx,res_fail,res_acq,new_fail_susc,new_fail_res,rep(0,6))\n    #reviewer 3 response, proportion of people going to 2nd-line due to rt\n    #res=c(dx,t1,t2,t3,rep(0,7))\n    return(c(res))\n    #return(list(c(res,newinf,newsu,newres,death)))\n    #})\n  })\n}\n#select the right rows\nselect=function(r1,r2,r3,r4){\n  l1=8\n  l2=4\n  l3=2\n  l4=2\n  ar=array(1:(l1*l2*l3*l4),dim=c(l1,l2,l3,l4))\n  return(as.vector(ar[r1,r2,r3,r4]))\n}\n#starting values\nxstart_f=function(par){\n  k1=par[9]\n  k2=par[10]\n  k3=par[11]\n  \n  start_value=array(0,dim=c(8,4,2,2))\n  start_value[1,1:4,1,1:2]=c(undiag_start[1]*repart_f(k1),undiag_start[2]*repart_f(k1))\n  start_value[2,1:4,1,1:2]=c(diag_start[1]*repart_f(k2),diag_start[2]*repart_f(k2))\n  start_value[3,1:4,1,1:2]=c(treat_start[1]*repart_f(k3),treat_start[2]*repart_f(k3))\n  \n  start_value[4,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0\n  start_value[5,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0\n  start_value[3,1:4,1,1:2]=start_value[3,1:4,1,1:2]*1\n  \n  res_start=0.01\n  \n  start_value[1:2,1:4,2,1:2]=array(rep(rep(c(res_start,res_start,res_start,res_start),each=2)*rep(c(1,1),4),2),dim=c(2,4,2))*start_value[1:2,1:4,1,1:2]\n  start_value[1:2,1:4,1,1:2]=array(rep(1-rep(c(res_start,res_start,res_start,res_start),each=2)*rep(c(1,1),4),2),dim=c(2,4,2))*start_value[1:2,1:4,1,1:2]\n  start_value[3,1:4,2,1:2]=res_start*start_value[3,1:4,1,1:2]\n  start_value[3,1:4,1,1:2]=(1-res_start)*start_value[3,1:4,1,1:2]\n  start_value[4,1:4,2,1:2]=res_start*start_value[4,1:4,1,1:2]\n  start_value[4,1:4,1,1:2]=(1-res_start)*start_value[4,1:4,1,1:2]\n  start_value[5,1:4,2,1:2]=0.7*start_value[5,1:4,1,1:2]\n  start_value[5,1:4,1,1:2]=0.3*start_value[5,1:4,1,1:2]\n  xstart=c(start_value,rep(0,10))\n  return(xstart)\n}\n#convert data so that we can plot with the old plot function\ndata_convert_to_old=function(data){\n  data_ret=matrix(0,nrow=dim(data)[1],ncol=140)\n  colnames(data_ret)=c(\"t\",as.character(1:139))\n  data_ret[,1]=1:(dim(data)[1])\n  data_ret[,2:130]=data[,1:129]# the col 131 is left blank (0) as it was already the case in the previous code and to not change the other functions\n  data_ret[,132]=data[,130]\n  data_ret[,133:140]=data[,131:138]\n  return(data_ret)\n}\n#loglikelihood with four indicators\nloglik <- function (theta, times, xstart,params,p2) {\n  par=p2\n  par[\"k1\"]=1\n  par[\"k2\"]=2\n  par[\"k3\"]=2\n  xstart=xstart_f(p2)\n  \n  data=my_fun10_solver2(xstart,theta,params,p2)\n  data<-data_convert_to_old(data)\n  tmax=dim(data)[1]\n  \n  mod_newinf=rollapply(diff(data[1:tmax,\"129\"]),12,sum)[seq(1,121,12)]\n  mod_death=rollapply(diff(data[1:tmax,\"131\"]),12,sum)[seq(1,121,12)]\n  mod_undiag=rowSums(data[seq(6,126,12),1+select(1,1:4,1:2,1:2)])\n  mod_treat=rowSums(data[seq(6,126,12),1+select(3:8,1:4,1:2,1:2)])\n  \n  return(-(sum(newinf_value*log(mod_newinf)-mod_newinf)+\n             sum(undiag_value*log(mod_undiag)-mod_undiag)+\n             sum(death_value*log(mod_death)-mod_death)+\n             sum(treat_value*log(mod_treat)-mod_treat))/1000+269.376)\n  \n  # return(-(sum(dnorm(x=sqrt(newinf_value),mean=sqrt(mod_newinf),sd=0.5,log=TRUE))+\n  #   sum(dnorm(x=sqrt(undiag_value),mean=sqrt(mod_undiag),sd=0.5,log=TRUE))+\n  #   sum(dnorm(x=sqrt(death_value),mean=sqrt(mod_death),sd=0.5,log=TRUE))+\n  #   sum(dnorm(x=sqrt(treat_value),mean=sqrt(mod_treat),sd=0.5,log=TRUE))))\n}\n# wrapper for loglikelihood function to take only the estimated parameters as an argument\nloglikwrap <- function(par) {\n  return(loglik(theta = par,times=times,xstart=xstart,params=params,p2=p2))\n}\n\nfigures_1=function(data,main.plot=TRUE){\n  tmax=dim(data)[1]\n  inf_mod=rollapply(diff(data[1:tmax,129]),12,sum)\n  death_mod=rollapply(diff(data[1:tmax,130]),12,sum)\n  undiag_mod=rowSums(data[seq(1,tmax,1),seq(1,121,8)])\n  treat_mod=rowSums(data[seq(1,tmax,1),select(3:8,1:4,1:2,1:2)])\n  resis_people=rowSums(data[seq(1,tmax,1),select(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select(c(5),1:4,1:2,1:2)])\n  trandr=rowSums(data[seq(1,tmax,1),select(c(2),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),select(c(2),1:4,1:2,1:2)])\n  #t\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  ##################################################################################################################\n  #Thembisa estimates\n  \n  \n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  m <- matrix(c(1,2,3,4,5,6),nrow = 3,ncol = 2,byrow = TRUE)\n  \n  layout(mat = m,heights = c(0.32,0.32,0.36))\n  \n  par(mai=c(0.6,0.7,0.5,0.4))\n  #ylim=c(min(newinf_value,new_infected)\n  plot(seq(2005+11/12,2014+11/12,length.out=10),inf_data,ylim=c(0,max(inf_data,inf_mod)),xlab=\"Calendar year\",ylab=\"1000 people\",main=\"A. New infected\",pch=1,col=\"red\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  lines(seq(2005+11/12,2015,length.out=109),inf_mod,type=\"l\",lwd=3)\n  #mtext(paste(\"f=\",as.numeric(round(f*100)/100)),side=\"3\",line=0,at=2002,cex=0.8,adj=0)\n  \n  par(mai=c(0.6,0.7,0.5,0.4))\n  #ylim=c(min(apply(undiag_value,1,sum),undiag_people)\n  plot(2005:2015,undiag_data,ylim=c(0,max(undiag_data,undiag_mod)),xlab=\"Calendar year\",ylab=\"1000 people\",main=\"B. Undiagnosed people\",pch=1,col=\"red\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  lines(seq(2005,2015,length.out=121),undiag_mod,type=\"l\",lwd=3)\n  \n  \n  par(mai=c(0.6,0.7,0.5,0.4))\n  \n  plot(seq(2005+11/12,2014+11/12,length.out=10),death_data,ylim=c(0,max(death_data,death_mod)),xlab=\"Calendar year\",ylab=\"1000 people\",main=\"C. AIDS-related deaths\",pch=1,col=\"red\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  lines(seq(2005+11/12,2015,length.out=109),death_mod,type=\"l\",col=\"black\",lwd=3)\n  \n  par(mai=c(0.6,0.7,0.5,0.4))\n  plot(2005:2015,c(rep(NA,5),treat_data),ylim=c(0,max(treat_data,treat_mod)),xlab=\"Calendar year\",ylab=\"percent\",main=\"D. ART coverage\",pch=1,col=\"red\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  lines(seq(2005,2015,length.out=121),treat_mod,type=\"l\",lwd=3)\n  #Plot5\n  par(mai=c(0.6,0.7,0.5,0.4))\n  plot(2005.5:2016.5,c(rep(NA,5),80,NA,NA,NA,95,NA,NA),xlim=c(2005,2018),ylim=c(min(resis_people[-1])*100,100),xlab=\"Calendar year\",ylab=\"percent\",main=\"E. ADR (Proportion of resistant if failing)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),type=\"l\",col=\"black\",lwd=3)\n  #Plot6\n  par(mai=c(0.6,0.7,0.5,0.4))\n  plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),ylim=c(min(trandr)*100,max(trandr)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=3)\n  \n}\n###########################################################################################\nfigures_long=function(par,parms,main.plot=TRUE){\n  k1=par[9]\n  k2=par[10]\n  k3=par[11]\n  start_treat=170\n  start_value=array(0,dim=c(8,4,2,2))\n  start_value[1,1:4,1,1:2]=c(apply(undiag_value,1,sum)[1]*0.42*repart_f(k1),apply(undiag_value,1,sum)[1]*0.58*repart_f(k1))\n  start_value[2,1:4,1,1:2]=c((apply(diag_value,1,sum)[1]-start_treat)*0.42*repart_f(k2),(apply(diag_value,1,sum)[1]-start_treat)*0.58*repart_f(k2))\n  start_value[3,1:4,1,1:2]=c(start_treat*0.42*repart_f(k3),start_treat*0.58*repart_f(k3))\n  start_value[4,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0.45\n  start_value[5,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0.15\n  start_value[3,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0.4\n  \n  start_value[1:2,1:4,2,1:2]=0.01*start_value[1:2,1:4,1,1:2]\n  start_value[1:2,1:4,1,1:2]=0.99*start_value[1:2,1:4,1,1:2]\n  start_value[3,1:4,2,1:2]=0.01*start_value[3,1:4,1,1:2]\n  start_value[3,1:4,1,1:2]=0.99*start_value[3,1:4,1,1:2]\n  start_value[4,1:4,2,1:2]=0.01*start_value[4,1:4,1,1:2]\n  start_value[4,1:4,1,1:2]=0.99*start_value[4,1:4,1,1:2]\n  start_value[5,1:4,2,1:2]=0.7*start_value[5,1:4,1,1:2]\n  start_value[5,1:4,1,1:2]=0.3*start_value[5,1:4,1,1:2]\n  xstart=c(start_value,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)\n  #RateInf,RateDiag,Ratemu,RateResist,RateTreat,alpha\n  data<-as.data.frame(lsoda(xstart, times, mod, parms=parms,p=par))\n  #RateInf,RateDiag,Ratemu,RateResist,RateTreat,alpha\n  new_infected=colSums(matrix(diff(data[1:121,\"129\"]),nrow=12))\n  undiag_people=rowSums(data[seq(1,121,12),1+seq(1,121,8)])\n  death_aids=colSums(matrix(diff(data[1:121,\"131\"]),nrow=12))\n  resis_people=rowSums(data[seq(13,121,1),1+select(c(5),1:4,2,1:2)])/rowSums(data[seq(13,121,1),1+select(c(5),1:4,1:2,1:2)])\n  treat_people=rowSums(data[seq(1,121,12),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,121,12),1+select(1:8,1:4,1:2,1:2)])\n  supp_people=rowSums(data[seq(1,121,1),1+select(c(4,7),1:4,1:2,1:2)])\n  infectious_people=rowSums(data[seq(1,121,1),1+select(c(1,2,3,5,6,8),1:4,1:2,1:2)])\n  treat_peop2=rowSums(data[seq(1,121,1),1+select(3:8,1:4,1:2,1:2)])\n  notsup=rowSums(data[seq(1,121,1),1+select(c(1,2,3,5,6,8),1:4,1:2,1:2)])/rowSums(N_value)[seq(1,121,1)]\n  inf=rowSums(data[seq(1,121,1),1+select(c(1,2,3,4,5,6,7,8),1:4,1:2,1:2)])#/rowSums(N_value)[seq(1,121,12)]\n  susc=rowSums(N_value)[seq(1,121,1)]-inf\n  trandr=rowSums(data[seq(1,121,1),1+select(c(2),1:4,2,1:2)])/rowSums(data[seq(1,121,1),1+select(c(2),1:4,1:2,1:2)])\n  \n  minf=rowSums(data[seq(1,121,12),1+select(1:8,1:4,1:2,1)])\n  finf=rowSums(data[seq(1,121,12),1+select(1:8,1:4,1:2,2)])\n  \n  a=sum(dpois(round(100*newinf_value/mean(new_infected)),100*new_infected/mean(new_infected),log=TRUE))/length(newinf_value)\n  b=sum(dpois(round(100*death_value/mean(death_aids)),100*death_aids/mean(death_aids),log=TRUE))/length(death_value)\n  c=sum(dpois(round(100*apply(undiag_value,1,sum)/mean(undiag_people)),100*undiag_people/mean(undiag_people),log=TRUE))/length(undiag_people)\n  d=sum(dpois(round(100*treat_percent/mean(treat_people)),100*treat_people[6:11]/mean(treat_people),log=TRUE))/length(treat_percent)\n  f=-(a+b+c+d)\n  \n  new_infected=rollapply(diff(data[1:121,\"129\"]),12,sum)\n  death_aids=rollapply(diff(data[1:121,\"131\"]),12,sum)\n  undiag_people=rowSums(data[seq(1,121,1),1+seq(1,121,8)])\n  treat_people=rowSums(data[seq(1,121,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,121,1),1+select(1:8,1:4,1:2,1:2)])\n  \n  ##################################################################################################################\n  #Distribution cd4 for each treatment stage\n  \n  par(mfrow = c(3, 2),lwd=2,oma=c(0,0,0,0))\n  cd4_1=rowSums(data[seq(1,121,12),1+select(1:8,1,1:2,1:2)])\n  cd4_2=rowSums(data[seq(1,121,12),1+select(1:8,2,1:2,1:2)])\n  cd4_3=rowSums(data[seq(1,121,12),1+select(1:8,3,1:2,1:2)])\n  cd4_4=rowSums(data[seq(1,121,12),1+select(1:8,4,1:2,1:2)])\n  plot(2005:2015,cd4_1,type=\"l\",col=\"black\",ylim=c(min(cd4_1,cd4_2,cd4_3,cd4_4),max(cd4_1,cd4_2,cd4_3,cd4_4)),main=\"Infected (1:8)\")\n  lines(2005:2015,cd4_2,type=\"l\",col=\"red\")\n  lines(2005:2015,cd4_3,type=\"l\",col=\"blue\")\n  lines(2005:2015,cd4_4,type=\"l\",col=\"green\")\n  \n  cd4_1=rowSums(data[seq(1,121,12),1+select(3:8,1,1:2,1:2)])\n  cd4_2=rowSums(data[seq(1,121,12),1+select(3:8,2,1:2,1:2)])\n  cd4_3=rowSums(data[seq(1,121,12),1+select(3:8,3,1:2,1:2)])\n  cd4_4=rowSums(data[seq(1,121,12),1+select(3:8,4,1:2,1:2)])\n  plot(2005:2015,cd4_1,type=\"l\",col=\"black\",ylim=c(min(cd4_1,cd4_2,cd4_3,cd4_4),max(cd4_1,cd4_2,cd4_3,cd4_4)),main=\"Treated (3:8)\")\n  lines(2005:2015,cd4_2,type=\"l\",col=\"red\")\n  lines(2005:2015,cd4_3,type=\"l\",col=\"blue\")\n  lines(2005:2015,cd4_4,type=\"l\",col=\"green\")\n  \n  first_ninety=rowSums(data[seq(1,121,12),1+select(c(2:8),1:4,1:2,1:2)])/rowSums(data[seq(1,121,12),1+select(c(1:8),1:4,1:2,1:2)])\n  second_ninety=rowSums(data[seq(1,121,12),1+select(c(3:8),1:4,1:2,1:2)])/rowSums(data[seq(1,121,12),1+select(2:8,1:4,1:2,1:2)])\n  third_ninety=rowSums(data[seq(1,121,12),1+select(c(4,7),1:4,1:2,1:2)])/rowSums(data[seq(1,121,12),1+select(c(4,5,7,8),1:4,1:2,1:2)])\n  par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  plot(2005:2015,first_ninety,type=\"l\",ylim=c(0,1),main=\"90-90-90 target\")\n  lines(2005:2015,second_ninety,col=\"red\")\n  lines(2005:2015,third_ninety,col=\"blue\")\n  \n  cd4_1=rowSums(data[seq(1,121,12),1+select(3,1,1:2,1:2)])\n  cd4_2=rowSums(data[seq(1,121,12),1+select(3,2,1:2,1:2)])\n  cd4_3=rowSums(data[seq(1,121,12),1+select(3,3,1:2,1:2)])\n  cd4_4=rowSums(data[seq(1,121,12),1+select(3,4,1:2,1:2)])\n  plot(2005:2015,cd4_1,type=\"l\",col=\"black\",ylim=c(min(cd4_1,cd4_2,cd4_3,cd4_4),max(cd4_1,cd4_2,cd4_3,cd4_4)),main=\"Start treatment (3)\")\n  lines(2005:2015,cd4_2,type=\"l\",col=\"red\")\n  lines(2005:2015,cd4_3,type=\"l\",col=\"blue\")\n  lines(2005:2015,cd4_4,type=\"l\",col=\"green\")\n  \n  par(mfrow = c(1,1),lwd=2,oma=c(0,0,0,0))\n  cd4_1=rowSums(data[seq(1,121,1),1+select(3,1:4,1,1:2)])\n  cd4_2=rowSums(data[seq(1,121,1),1+select(4,1:4,1,1:2)])\n  cd4_3=rowSums(data[seq(1,121,1),1+select(5,1:4,1,1:2)])\n  cd4_4=cd4_3\n  #cd4_4=rowSums(data[seq(1,121,1),1+select(5,1:4,1,1:2)])\n  plot(seq(2005,2015,1/12),cd4_1,type=\"l\",col=\"black\",ylim=c(min(cd4_1,cd4_2,cd4_3,cd4_4),max(cd4_1,cd4_2,cd4_3,cd4_4)),main=\"Failed,not_res (5,1)\")\n  lines(seq(2005,2015,1/12),cd4_2,type=\"l\",col=\"red\")\n  lines(seq(2005,2015,1/12),cd4_3,type=\"l\",col=\"blue\")\n  #lines(seq(2005,2015,1/12),cd4_4,type=\"l\",col=\"green\")\n  \n  cd4_1=rowSums(data[seq(1,121,1),1+select(3,1:4,2,1:2)])\n  cd4_2=rowSums(data[seq(1,121,1),1+select(4,1:4,2,1:2)])\n  cd4_3=rowSums(data[seq(1,121,1),1+select(5,1:4,2,1:2)])\n  cd4_4=cd4_3\n  #cd4_4=rowSums(data[seq(1,121,1),1+select(5,1:4,1,1:2)])\n  plot(seq(2005,2015,1/12),cd4_1,type=\"l\",col=\"black\",ylim=c(min(cd4_1,cd4_2,cd4_3,cd4_4),max(cd4_1,cd4_2,cd4_3,cd4_4)),main=\"Failed,not_res (5,2)\")\n  lines(seq(2005,2015,1/12),cd4_2,type=\"l\",col=\"red\")\n  lines(seq(2005,2015,1/12),cd4_3,type=\"l\",col=\"blue\")\n  #lines(seq(2005,2015,1/12),cd4_4,type=\"l\",col=\"green\")\n  print(rowSums(data[seq(1,121,1),1+select(c(1,2,3,5,6,8),1:4,2,1:2)])/rowSums(data[seq(1,121,1),1+select(c(1,2,3,5,6,8),1:4,1:2,1:2)]))\n  print(rowSums(data[seq(1,121,1),1+select(2,1:4,2,1:2)])/rowSums(data[seq(1,121,1),1+select(2,1:4,1:2,1:2)]))\n  print(rowSums(data[seq(1,121,1),1+select(1:2,1:4,2,1:2)])/rowSums(data[seq(1,121,1),1+select(1:2,1:4,1:2,1:2)]))\n  print(rowSums(data[seq(1,121,1),1+select(3:5,1:4,2,1:2)])/rowSums(data[seq(1,121,1),1+select(3:5,1:4,1:2,1:2)]))\n  print(rowSums(data[seq(1,121,1),1+select(3,1:4,2,1:2)])/rowSums(data[seq(1,121,1),1+select(3,1:4,1:2,1:2)]))\n  print(rowSums(data[seq(1,121,1),1+select(4,1:4,2,1:2)])/rowSums(data[seq(1,121,1),1+select(4,1:4,1:2,1:2)]))\n  print(rowSums(data[seq(1,121,1),1+select(5,1:4,2,1:2)])/rowSums(data[seq(1,121,1),1+select(5,1:4,1:2,1:2)]))\n  print(rowSums(data[seq(1,121,1),1+select(1:8,1:4,2,1:2)])/rowSums(data[seq(1,121,1),1+select(1:8,1:4,1:2,1:2)]))\n  print(rowSums(data[seq(1,121,1),1+select(1:8,1:4,2,1:2)]))\n  print(diff(data[1:121,\"165\"])/(diff(data[1:121,\"164\"])+diff(data[1:121,\"165\"])))\n  print(rollapply(diff(data[1:121,\"131\"]),1,sum))\n  print(rowSums(data[seq(1,121,1),1+select(1,1:4,1:2,1:2)]))\n  print(rowSums(data[seq(1,121,1),1+select(1:8,1:4,1:2,1:2)]))\n  \n  if(!main.plot){\n    par(mfrow = c(3, 2),lwd=2,oma=c(0,0,0,0))\n    \n    cd4_1=rowSums(data[seq(1,121,12),1+select(1,1,1:2,1:2)])\n    cd4_2=rowSums(data[seq(1,121,12),1+select(1,2,1:2,1:2)])\n    cd4_3=rowSums(data[seq(1,121,12),1+select(1,3,1:2,1:2)])\n    cd4_4=rowSums(data[seq(1,121,12),1+select(1,4,1:2,1:2)])\n    par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n    plot(2005:2015,cd4_1,type=\"l\",col=\"black\",ylim=c(min(cd4_1,cd4_2,cd4_3,cd4_4),max(cd4_1,cd4_2,cd4_3,cd4_4)),main=\"Distribution CD4: undiagnosed people (1)\")\n    lines(2005:2015,cd4_2,type=\"l\",col=\"red\")\n    lines(2005:2015,cd4_3,type=\"l\",col=\"blue\")\n    lines(2005:2015,cd4_4,type=\"l\",col=\"green\")\n    \n    cd4_1=rowSums(data[seq(1,121,12),1+select(2,1,1:2,1:2)])\n    cd4_2=rowSums(data[seq(1,121,12),1+select(2,2,1:2,1:2)])\n    cd4_3=rowSums(data[seq(1,121,12),1+select(2,3,1:2,1:2)])\n    cd4_4=rowSums(data[seq(1,121,12),1+select(2,4,1:2,1:2)])\n    plot(2005:2015,cd4_1,type=\"l\",col=\"black\",ylim=c(min(cd4_1,cd4_2,cd4_3,cd4_4),max(cd4_1,cd4_2,cd4_3,cd4_4)),main=\"Distribution CD4: diagnosed but not treated people (2)\")\n    lines(2005:2015,cd4_2,type=\"l\",col=\"red\")\n    lines(2005:2015,cd4_3,type=\"l\",col=\"blue\")\n    lines(2005:2015,cd4_4,type=\"l\",col=\"green\")\n    \n    cd4_1=rowSums(data[seq(1,121,12),1+select(1:2,1,1:2,1:2)])\n    cd4_2=rowSums(data[seq(1,121,12),1+select(1:2,2,1:2,1:2)])\n    cd4_3=rowSums(data[seq(1,121,12),1+select(1:2,3,1:2,1:2)])\n    cd4_4=rowSums(data[seq(1,121,12),1+select(1:2,4,1:2,1:2)])\n    plot(2005:2015,cd4_1,type=\"l\",col=\"black\",ylim=c(min(cd4_1,cd4_2,cd4_3,cd4_4),max(cd4_1,cd4_2,cd4_3,cd4_4)),main=\"Distribution CD4: untreated people (1,2)\")\n    lines(2005:2015,cd4_2,type=\"l\",col=\"red\")\n    lines(2005:2015,cd4_3,type=\"l\",col=\"blue\")\n    lines(2005:2015,cd4_4,type=\"l\",col=\"green\")\n    \n    ##################################################################################################################\n    par(mfrow = c(3, 2),lwd=2,oma=c(2,0,0,0))\n    d1=rowSums(data[seq(1,121,12),1+select(3,1:4,1,1:2)])\n    d2=rowSums(data[seq(1,121,12),1+select(4,1:4,1,1:2)])\n    d3=rowSums(data[seq(1,121,12),1+select(5,1:4,1,1:2)])\n    plot(2005:2015,d1,type=\"l\",col=\"black\",ylim=c(min(d1,d2,d3),max(d1,d2,d3)),main=\"Susceptible Treated people (3,4,5)\")\n    lines(2005:2015,d2,type=\"l\",col=\"red\")\n    lines(2005:2015,d3,type=\"l\",col=\"blue\")\n    \n    d1=rowSums(data[seq(1,121,12),1+select(3,1:4,2,1:2)])\n    d2=rowSums(data[seq(1,121,12),1+select(4,1:4,2,1:2)])\n    d3=rowSums(data[seq(1,121,12),1+select(5,1:4,2,1:2)])\n    plot(2005:2015,d1,type=\"l\",col=\"black\",ylim=c(min(d1,d2,d3),max(d1,d2,d3)),main=\"Resistance Treated people (3,4,5)\")\n    lines(2005:2015,d2,type=\"l\",col=\"red\")\n    lines(2005:2015,d3,type=\"l\",col=\"blue\")\n    \n    d1=rowSums(data[seq(1,121,12),1+select(1:8,1:4,1,1:2)])\n    d2=rowSums(data[seq(1,121,12),1+select(c(1,2,3,5),1:4,1,1:2)])\n    plot(2005:2015,d1,type=\"l\",col=\"black\",ylim=c(min(d1,d2),max(d1,d2)),main=\"Susceptible infect/infectious people\")\n    lines(2005:2015,d2,type=\"l\",col=\"red\")\n    \n    d1=rowSums(data[seq(1,121,12),1+select(1:8,1:4,2,1:2)])\n    d2=rowSums(data[seq(1,121,12),1+select(c(1,2,3,5),1:4,2,1:2)])\n    plot(2005:2015,d1,type=\"l\",col=\"black\",ylim=c(min(d1,d2),max(d1,d2)),main=\"Resistance infect/infectious people\")\n    lines(2005:2015,d2,type=\"l\",col=\"red\")\n    \n    d1=rowSums(data[seq(1,121,12),1+select(1,1:4,1,1:2)])\n    d2=rowSums(data[seq(1,121,12),1+select(2,1:4,1,1:2)])\n    plot(2005:2015,d1,type=\"l\",col=\"black\",ylim=c(min(d1,d2),max(d1,d2)),main=\"susceptible infected/diagnosed people\")\n    lines(2005:2015,d2,type=\"l\",col=\"red\")\n    \n    d1=rowSums(data[seq(1,121,12),1+select(1,1:4,2,1:2)])\n    d2=rowSums(data[seq(1,121,12),1+select(2,1:4,2,1:2)])\n    plot(2005:2015,d1,type=\"l\",col=\"black\",ylim=c(min(d1,d2),max(d1,d2)),main=\"Resistance infected/diagnosed people\")\n    lines(2005:2015,d2,type=\"l\",col=\"red\")\n    \n    par(mfrow = c(3, 2),lwd=2,oma=c(2,0,0,0))\n    d1=rowSums(data[seq(1,121,12),1+select(1:8,1:4,1,1:2)])/rowSums(data[seq(1,121,12),1+select(1:8,1:4,2,1:2)])\n    d2=rowSums(data[seq(1,121,12),1+select(c(1,2,3,5),1:4,1,1:2)])/rowSums(data[seq(1,121,12),1+select(c(1,2,3,5),1:4,2,1:2)])\n    d3=rowSums(data[seq(1,121,12),1+select(c(1),1:4,1,1:2)])/rowSums(data[seq(1,121,12),1+select(c(1),1:4,2,1:2)])\n    d4=rowSums(data[seq(1,121,12),1+select(c(2),1:4,1,1:2)])/rowSums(data[seq(1,121,12),1+select(c(2),1:4,2,1:2)])\n    plot(2005:2015,d1,type=\"l\",col=\"black\",ylim=c(min(d1,d2,d3,d4),max(d1,d2,d3,d4)),main=\"Ratio infect susc/resis\")\n    lines(2005:2015,d2,type=\"l\",col=\"red\")\n    lines(2005:2015,d3,type=\"l\",col=\"blue\")\n    lines(2005:2015,d4,type=\"l\",col=\"green\")\n    plot(2005:2015,1/d1,type=\"l\",col=\"black\",ylim=c(1/max(d1,d2,d3,d4),1/min(d1,d2,d3,d4)),main=\"Ratio infect susc/resis\")\n    lines(2005:2015,1/d2,type=\"l\",col=\"red\")\n    lines(2005:2015,1/d3,type=\"l\",col=\"blue\")\n    lines(2005:2015,1/d4,type=\"l\",col=\"green\")\n    \n    d1=rowSums(data[seq(1,121,12),1+select(3,1:4,1,1:2)])/rowSums(data[seq(1,121,12),1+select(3,1:4,2,1:2)])\n    d2=rowSums(data[seq(1,121,12),1+select(c(4),1:4,1,1:2)])/rowSums(data[seq(1,121,12),1+select(c(4),1:4,2,1:2)])\n    d3=rowSums(data[seq(1,121,12),1+select(c(5),1:4,1,1:2)])/rowSums(data[seq(1,121,12),1+select(c(5),1:4,2,1:2)])\n    d4=rowSums(data[seq(1,121,12),1+select(c(3,4,5),1:4,1,1:2)])/rowSums(data[seq(1,121,12),1+select(c(3,4,5),1:4,2,1:2)])\n    plot(2005:2015,d1,type=\"l\",col=\"black\",ylim=c(min(c(d1,d2[-1],d3[-1],d4)),max(c(d1,d2[-1],d3[-1],d4))),main=\"Ratio infect susc/resis\")\n    lines(2006:2015,d2[-1],type=\"l\",col=\"red\")\n    lines(2006:2015,d3[-1],type=\"l\",col=\"blue\")\n    lines(2005:2015,d4,type=\"l\",col=\"green\")\n    plot(2005:2015,1/d1,type=\"l\",col=\"black\",ylim=c(1/max(c(d1,d2[-1],d4)),1/min(c(d1,d2[-1],d4))),main=\"Ratio infect susc/resis\")\n    lines(2006:2015,1/d2[-1],type=\"l\",col=\"red\")\n    #lines(2006:2015,1/d3[-1],type=\"l\",col=\"blue\")\n    lines(2005:2015,1/d4,type=\"l\",col=\"green\")\n    ##################################################################################################################\n    #Distribution cd4 for each treatment stage, 2\n    par(mfrow = c(3, 2),lwd=2,oma=c(2,0,0,0))\n    \n    cd4_1=rowSums(data[seq(1,121,12),1+select(3,1,1:2,1:2)])\n    cd4_2=rowSums(data[seq(1,121,12),1+select(3,2,1:2,1:2)])\n    cd4_3=rowSums(data[seq(1,121,12),1+select(3,3,1:2,1:2)])\n    cd4_4=rowSums(data[seq(1,121,12),1+select(3,4,1:2,1:2)])\n    par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n    plot(2005:2015,cd4_1,type=\"l\",col=\"black\",ylim=c(min(cd4_1,cd4_2,cd4_3,cd4_4),max(cd4_1,cd4_2,cd4_3,cd4_4)),main=\"Distribution CD4:Started treatment (3)\")\n    lines(2005:2015,cd4_2,type=\"l\",col=\"red\")\n    lines(2005:2015,cd4_3,type=\"l\",col=\"blue\")\n    lines(2005:2015,cd4_4,type=\"l\",col=\"green\")\n    \n    cd4_1=rowSums(data[seq(1,121,12),1+select(4,1,1:2,1:2)])\n    cd4_2=rowSums(data[seq(1,121,12),1+select(4,2,1:2,1:2)])\n    cd4_3=rowSums(data[seq(1,121,12),1+select(4,3,1:2,1:2)])\n    cd4_4=rowSums(data[seq(1,121,12),1+select(4,4,1:2,1:2)])\n    plot(2005:2015,cd4_1,type=\"l\",col=\"black\",ylim=c(min(cd4_1,cd4_2,cd4_3,cd4_4),max(cd4_1,cd4_2,cd4_3,cd4_4)),main=\"Distribution CD4: Suppressed (4)\")\n    lines(2005:2015,cd4_2,type=\"l\",col=\"red\")\n    lines(2005:2015,cd4_3,type=\"l\",col=\"blue\")\n    lines(2005:2015,cd4_4,type=\"l\",col=\"green\")\n    \n    cd4_1=rowSums(data[seq(1,121,12),1+select(5,1,1:2,1:2)])\n    cd4_2=rowSums(data[seq(1,121,12),1+select(5,2,1:2,1:2)])\n    cd4_3=rowSums(data[seq(1,121,12),1+select(5,3,1:2,1:2)])\n    cd4_4=rowSums(data[seq(1,121,12),1+select(5,4,1:2,1:2)])\n    plot(2005:2015,cd4_1,type=\"l\",col=\"black\",ylim=c(min(cd4_1,cd4_2,cd4_3,cd4_4),max(cd4_1,cd4_2,cd4_3,cd4_4)),main=\"Distribution CD4: Failed (5)\")\n    lines(2005:2015,cd4_2,type=\"l\",col=\"red\")\n    lines(2005:2015,cd4_3,type=\"l\",col=\"blue\")\n    lines(2005:2015,cd4_4,type=\"l\",col=\"green\")\n    \n    cd4_1=rowSums(data[seq(1,121,12),1+select(3:5,1,1:2,1:2)])\n    cd4_2=rowSums(data[seq(1,121,12),1+select(3:5,2,1:2,1:2)])\n    cd4_3=rowSums(data[seq(1,121,12),1+select(3:5,3,1:2,1:2)])\n    cd4_4=rowSums(data[seq(1,121,12),1+select(3:5,4,1:2,1:2)])\n    plot(2005:2015,cd4_1,type=\"l\",col=\"black\",ylim=c(min(cd4_1,cd4_2,cd4_3,cd4_4),max(cd4_1,cd4_2,cd4_3,cd4_4)),main=\"Treated (3,4,5\")\n    lines(2005:2015,cd4_2,type=\"l\",col=\"red\")\n    lines(2005:2015,cd4_3,type=\"l\",col=\"blue\")\n    lines(2005:2015,cd4_4,type=\"l\",col=\"green\")\n    \n    cd4_1=rowSums(data[seq(1,121,12),1+select(1:5,1,1:2,1:2)])\n    cd4_2=rowSums(data[seq(1,121,12),1+select(1:5,2,1:2,1:2)])\n    cd4_3=rowSums(data[seq(1,121,12),1+select(1:5,3,1:2,1:2)])\n    cd4_4=rowSums(data[seq(1,121,12),1+select(1:5,4,1:2,1:2)])\n    plot(2005:2015,cd4_1,type=\"l\",col=\"black\",ylim=c(min(cd4_1,cd4_2,cd4_3,cd4_4),max(cd4_1,cd4_2,cd4_3,cd4_4)),main=\"Treated and untreated (1,2,3,4,5)\")\n    lines(2005:2015,cd4_2,type=\"l\",col=\"red\")\n    lines(2005:2015,cd4_3,type=\"l\",col=\"blue\")\n    lines(2005:2015,cd4_4,type=\"l\",col=\"green\")\n    \n    cd4_1=rowSums(data[seq(1,121,12),1+select(c(1,2,3,5,6,8),1,1:2,1:2)])\n    cd4_2=rowSums(data[seq(1,121,12),1+select(c(1,2,3,5,6,8),2,1:2,1:2)])\n    cd4_3=rowSums(data[seq(1,121,12),1+select(c(1,2,3,5,6,8),3,1:2,1:2)])\n    cd4_4=rowSums(data[seq(1,121,12),1+select(c(1,2,3,5,6,8),4,1:2,1:2)])\n    plot(2005:2015,cd4_1,type=\"l\",col=\"black\",ylim=c(min(cd4_1,cd4_2,cd4_3,cd4_4),max(cd4_1,cd4_2,cd4_3,cd4_4)),main=\"Infectious (1,2,3,5,6,8)\")\n    lines(2005:2015,cd4_2,type=\"l\",col=\"red\")\n    lines(2005:2015,cd4_3,type=\"l\",col=\"blue\")\n    lines(2005:2015,cd4_4,type=\"l\",col=\"green\")\n    \n    \n    # cd4_1_Treat_Supp=colSums(matrix(diff(data[1:121,\"134\"]),nrow=12))\n    # #Treat_1=rowSums(data[seq(1,121,12),1+select(3,1,1:2,1:2)])\n    # plot(2005:2014,cd4_1_Treat_Supp,type=\"l\")\n    # #plot(2005:2015,Treat_1,type=\"l\")\n    \n    # infec1_new=colSums(matrix(diff(data[1:121,\"143\"]),nrow=12))\n    # infec2_new=colSums(matrix(diff(data[1:121,\"144\"]),nrow=12))\n    # infec3_new=colSums(matrix(diff(data[1:121,\"145\"]),nrow=12))\n    # infec4_new=colSums(matrix(diff(data[1:121,\"146\"]),nrow=12))\n    # infec_new=infec1_new+infec2_new+infec3_new+infec4_new\n    # plot(2005:2014,infec1_new/infec_new,type=\"l\",ylim=c(0,1),main=\"Infection Distribution\")\n    # lines(2005:2014,infec2_new/infec_new,type=\"l\",col=\"blue\")\n    # lines(2005:2014,infec3_new/infec_new,type=\"l\",col=\"red\")\n    # lines(2005:2014,infec4_new/infec_new,type=\"l\",col=\"green\")\n    # plot(2005:2014,infec1_new,type=\"l\",ylim=c(0,max(c(infec1_new,infec2_new,infec3_new,infec4_new))),main=\"Infection total\")\n    # lines(2005:2014,infec2_new,type=\"l\",col=\"blue\")\n    # lines(2005:2014,infec3_new,type=\"l\",col=\"red\")\n    # lines(2005:2014,infec4_new,type=\"l\",col=\"green\")\n    ##################################################################################################################\n    #90 target, compartment 1:2,4, deaths treated and non-treated\n    par(mfrow = c(3, 2),lwd=2,oma=c(2,0,0,0))\n    \n    first_ninety=rowSums(data[seq(1,121,12),1+select(c(2:8),1:4,1:2,1:2)])/rowSums(data[seq(1,121,12),1+select(c(1:8),1:4,1:2,1:2)])\n    second_ninety=rowSums(data[seq(1,121,12),1+select(c(3:8),1:4,1:2,1:2)])/rowSums(data[seq(1,121,12),1+select(2:8,1:4,1:2,1:2)])\n    third_ninety=rowSums(data[seq(1,121,12),1+select(c(4,7),1:4,1:2,1:2)])/rowSums(data[seq(1,121,12),1+select(c(4,5,7,8),1:4,1:2,1:2)])\n    par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n    plot(2005:2015,first_ninety,type=\"l\",ylim=c(0,1),main=\"90-90-90 target\")\n    lines(2005:2015,second_ninety,col=\"red\")\n    lines(2005:2015,third_ninety,col=\"blue\")\n    \n    d1=colSums(matrix(diff(data[1:121,\"147\"]),nrow=12))\n    d2=colSums(matrix(diff(data[1:121,\"148\"]),nrow=12))\n    d3=colSums(matrix(diff(data[1:121,\"149\"]),nrow=12))\n    d4=colSums(matrix(diff(data[1:121,\"150\"]),nrow=12))\n    d5=colSums(matrix(diff(data[1:121,\"151\"]),nrow=12))\n    plot(2005:2014,d1,type=\"l\",ylim=c(0,max(c(d1,d2,d3,d4))),main=\"Compartment 1:2,4,1:2,1:2\")\n    lines(2005:2014,d2,type=\"l\",col=\"red\")\n    lines(2005:2014,d3,type=\"l\",col=\"blue\")\n    lines(2005:2014,d4,type=\"l\",col=\"green\")\n    lines(2005:2014,d5,type=\"l\",col=\"yellow\")\n    \n    d1=colSums(matrix(diff(data[1:121,\"152\"]),nrow=12))\n    d2=colSums(matrix(diff(data[1:121,\"153\"]),nrow=12))\n    d3=colSums(matrix(diff(data[1:121,\"154\"]),nrow=12))\n    d4=colSums(matrix(diff(data[1:121,\"155\"]),nrow=12))\n    plot(2005:2014,d1,type=\"l\",ylim=c(0,max(c(d1,d2,d3,d4))),main=\"Death non-treated\")\n    lines(2005:2014,d2,type=\"l\",col=\"red\")\n    lines(2005:2014,d3,type=\"l\",col=\"blue\")\n    lines(2005:2014,d4,type=\"l\",col=\"green\")\n    \n    d1=colSums(matrix(diff(data[1:121,\"156\"]),nrow=12))\n    d2=colSums(matrix(diff(data[1:121,\"157\"]),nrow=12))\n    d3=colSums(matrix(diff(data[1:121,\"158\"]),nrow=12))\n    d4=colSums(matrix(diff(data[1:121,\"159\"]),nrow=12))\n    plot(2005:2014,d1,type=\"l\",ylim=c(0,max(c(d1,d2,d3,d4))),main=\"Death treated\")\n    lines(2005:2014,d2,type=\"l\",col=\"red\")\n    lines(2005:2014,d3,type=\"l\",col=\"blue\")\n    lines(2005:2014,d4,type=\"l\",col=\"green\")\n    \n    d1=colSums(matrix(diff(data[1:121,\"160\"]),nrow=12))\n    d2=colSums(matrix(diff(data[1:121,\"161\"]),nrow=12))\n    plot(2005:2014,d1,type=\"l\",ylim=c(0,max(c(d1,d2))),main=\"Death male and female\")\n    lines(2005:2014,d2,type=\"l\",col=\"red\")\n    \n    d1=rowSums(data[seq(1,121,12),1+select(c(1:8),1:4,1:2,1)])\n    d2=rowSums(data[seq(1,121,12),1+select(c(1:8),1:4,1:2,2)])\n    plot(2005:2015,d1,type=\"l\",ylim=c(0,max(c(d1,d2))),main=\"Infected male and female\")\n    lines(2005:2015,d2,type=\"l\",col=\"red\")\n    ##################################################################################################################\n    #Distribution cd4 newly diagnosed\n    par(mfrow = c(1,1),lwd=2,oma=c(0,0,0,0))\n    m <- matrix(c(1,2,3),nrow = 3,ncol = 1,byrow = TRUE)\n    \n    layout(mat = m,heights = c(0.4,0.4,0.2))\n    \n    diag1_new=colSums(matrix(diff(data[1:121,\"139\"]),nrow=12))\n    diag2_new=colSums(matrix(diff(data[1:121,\"140\"]),nrow=12))\n    diag3_new=colSums(matrix(diff(data[1:121,\"141\"]),nrow=12))\n    diag4_new=colSums(matrix(diff(data[1:121,\"142\"]),nrow=12))\n    diag_new=diag1_new+diag2_new+diag3_new+diag4_new\n    par(lwd=2,mai=c(0.6,0.9,0.5,0.5))\n    plot(2005:2014,diag1_new/diag_new,type=\"l\",ylim=c(0,1),main=\"Newly Diagnosed : Distribution\",xlab=\"Calendar year\",ylab=\"Percent\")\n    lines(2005:2014,diag2_new/diag_new,type=\"l\",col=\"red\")\n    lines(2005:2014,diag3_new/diag_new,type=\"l\",col=\"blue\")\n    lines(2005:2014,diag4_new/diag_new,type=\"l\",col=\"green\")\n    par(lwd=2,mai=c(0.6,0.9,0.5,0.5))\n    plot(2005:2014,diag1_new,type=\"l\",ylim=c(0,max(c(diag1_new,diag2_new,diag3_new,diag4_new))),main=\"Newly Diagnosed : total\",xlab=\"Calendar year\",ylab=\"Individuals\")\n    lines(2005:2014,diag2_new,type=\"l\",col=\"red\")\n    lines(2005:2014,diag3_new,type=\"l\",col=\"blue\")\n    lines(2005:2014,diag4_new,type=\"l\",col=\"green\")\n    \n    par(lwd=1,mai=c(0,0,0,0))\n    plot(1, type = \"n\", axes=FALSE, xlab=\"\", ylab=\"\")\n    plot_colors <- c(\"blue\",\"black\", \"green\", \"orange\", \"pink\")\n    \n    legend(x = \"center\",inset = 0,\n           legend = c(\"CD4>500\", \"350<CD4<500\", \"200<CD4<350\",\"CD4<200\"), \n           col=c(\"black\",\"red\",\"blue\",\"green\"), lwd=5, cex=1, horiz = TRUE)\n    \n    ##################################################################################################################\n    #Distribution cd4 newly treated\n    par(mfrow = c(1,1),lwd=2,oma=c(0,0,0,0))\n    m <- matrix(c(1,2,3),nrow = 3,ncol = 1,byrow = TRUE)\n    \n    layout(mat = m,heights = c(0.4,0.4,0.2))\n    \n    treat1_new=colSums(matrix(diff(data[1:121,\"135\"]),nrow=12))\n    treat2_new=colSums(matrix(diff(data[1:121,\"136\"]),nrow=12))\n    treat3_new=colSums(matrix(diff(data[1:121,\"137\"]),nrow=12))\n    treat4_new=colSums(matrix(diff(data[1:121,\"138\"]),nrow=12))\n    treat_new=treat1_new+treat2_new+treat3_new+treat4_new\n    par(lwd=2,mai=c(0.6,0.9,0.5,0.5))\n    plot(2005:2014,treat1_new/treat_new,type=\"l\",ylim=c(0,1),main=\"Newly Treated Distribution\",xlab=\"Calendar year\",ylab=\"Percent\")\n    lines(2005:2014,treat2_new/treat_new,type=\"l\",col=\"red\")\n    lines(2005:2014,treat3_new/treat_new,type=\"l\",col=\"blue\")\n    lines(2005:2014,treat4_new/treat_new,type=\"l\",col=\"green\")\n    par(lwd=2,mai=c(0.6,0.9,0.5,0.5))\n    plot(2005:2014,treat1_new,type=\"l\",ylim=c(0,max(c(treat1_new,treat2_new,treat3_new,treat4_new))),main=\"Newly Diagnosed : total\",xlab=\"Calendar year\",ylab=\"Individuals\")\n    lines(2005:2014,treat2_new,type=\"l\",col=\"red\")\n    lines(2005:2014,treat3_new,type=\"l\",col=\"blue\")\n    lines(2005:2014,treat4_new,type=\"l\",col=\"green\")\n    \n    par(lwd=1,mai=c(0,0,0,0))\n    plot(1, type = \"n\", axes=FALSE, xlab=\"\", ylab=\"\")\n    plot_colors <- c(\"blue\",\"black\", \"green\", \"orange\", \"pink\")\n    \n    legend(x = \"center\",inset = 0,\n           legend = c(\"CD4>500\", \"350<CD4<500\", \"200<CD4<350\",\"CD4<200\"), \n           col=c(\"black\",\"red\",\"blue\",\"green\"), lwd=5, cex=1, horiz = TRUE)\n  }\n  ##################################################################################################################\n  #Thembisa estimates\n  # par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  # m <- matrix(c(1,2,3,4,5,6,7,7),nrow = 4,ncol = 2,byrow = TRUE)\n  # \n  # layout(mat = m,heights = c(0.35,0.3,0.3,0.05))\n  # \n  # par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  # #ylim=c(min(newinf_value,new_infected)\n  # plot(seq(2005+11/12,2014+11/12,length.out=10),newinf_value,ylim=c(0,max(newinf_value,new_infected)),xlab=\"Calendar year\",ylab=\"1000 people\",main=\"New infected\",pch=1,col=\"red\")\n  # lines(seq(2005+11/12,2015,length.out=109),new_infected,type=\"l\")\n  # #mtext(paste(\"f=\",as.numeric(round(f*100)/100)),side=\"3\",line=0,at=2002,cex=0.8,adj=0)\n  # mtext(\"a.\",side=\"3\",line=0,at=2004.5,cex=1,adj=0)\n  # \n  # par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  # #ylim=c(min(apply(undiag_value,1,sum),undiag_people)\n  # plot(2005:2015,apply(undiag_value,1,sum),ylim=c(0,max(apply(undiag_value,1,sum),undiag_people)),xlab=\"Calendar year\",ylab=\"1000 people\",main=\"Undiagnosed people\",pch=1,col=\"red\")\n  # lines(seq(2005,2015,length.out=121),undiag_people,type=\"l\")\n  # mtext(\"b.\",side=\"3\",line=0,at=2003.5,cex=1,adj=0)\n  # \n  # death_people=rollapply(diff(data[1:121,\"130\"]),12,sum)\n  # death1_people=rollapply(diff(data[1:121,\"131\"]),12,sum)\n  # death2_people=rollapply(diff(data[1:121,\"132\"]),12,sum)\n  # death3_people=rollapply(diff(data[1:121,\"133\"]),12,sum)\n  # \n  # par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  # #ylim=c(min(death_value,death1_people)\n  # plot(seq(2005+11/12,2014+11/12,length.out=10),death_value,ylim=c(0,max(death_value,death1_people)),xlab=\"Calendar year\",ylab=\"1000 people\",main=\"AIDS-related deaths\",pch=1,col=\"red\")\n  # lines(seq(2005+11/12,2015,length.out=109),death1_people,type=\"l\",col=\"black\")\n  # mtext(\"c.\",side=\"3\",line=0,at=2004.5,cex=1,adj=0)\n  # #lines(2005:2014,death1_people,type=\"l\",col=\"green\")\n  # #lines(2005:2014,death2_people,type=\"l\",col=\"blue\")\n  # #lines(2005:2014,death3_people,type=\"l\",col=\"red\")\n  # \n  # par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  # plot(2005:2015,c(rep(NA,5),treat_percent*100),ylim=c(0,max(treat_percent,treat_people)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"Proportion of people on treatment\",pch=1,col=\"red\")\n  # lines(seq(2005,2015,length.out=121),treat_people*100,type=\"l\")\n  # mtext(\"e.\",side=\"3\",line=0,at=2003.5,cex=1,adj=0)\n  # \n  # par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  # #min(resis_people)*100\n  # plot(seq(2005,2015,length.out=121),c(rep(NA,12),resis_people*100),type=\"l\",ylim=c(0,100),xlab=\"Calendar year\",ylab=\"percent\",main=\"Proportion of resistant if failing\",pch=1,col=\"black\")\n  # lines(2005:2016,c(rep(NA,5),80,NA,NA,NA,95,NA,NA),type=\"p\",col=\"blue\")\n  # mtext(\"d.\",side=\"3\",line=0,at=2003.5,cex=1,adj=0)\n  # \n  # par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  # #ylim=c(min(trandr)*100\n  # plot(seq(2005,2016,length.out=133),c(trandr*100,rep(NA,12)),type=\"l\",ylim=c(0,12),xlab=\"Calendar year\",ylab=\"percent\",main=\"TDR Prevalence (diagnosed people)\",pch=1,col=\"black\")\n  # lines(2005:2016,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),type=\"p\",col=\"blue\")\n  # mtext(\"f.\",side=\"3\",line=0,at=2003.5,cex=1,adj=0)\n  # \n  # par(lwd=1,mai=c(0,0,0,0))\n  # plot(1, type = \"n\", axes=FALSE, xlab=\"\", ylab=\"\")\n  # plot_colors <- c(\"blue\",\"black\", \"green\", \"orange\", \"pink\")\n  # \n  # legend(x=\"bottom\", inset =0,\n  #        c(\"Simulated by the model\",\"Estimated data (WHO)\",\"Data from previous studies\"),\n  #        lty=c(1,NA,NA),pch=c(NA,\"o\",\"o\"), lwd=c(2,3,3), col=c(\"black\",\"red\",\"blue\"), box.col=NA,horiz=TRUE,cex=1.05)\n  # \n  # \n  # \n  \n  \n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  m <- matrix(c(1,2,3,4,5,6,7,7),nrow = 4,ncol = 2,byrow = TRUE)\n  \n  layout(mat = m,heights = c(0.35,0.3,0.3,0.05))\n  \n  par(lwd=2,mai=c(0.6,0.7,0.5,0.4))\n  #ylim=c(min(newinf_value,new_infected)\n  plot(seq(2005+11/12,2014+11/12,length.out=10),newinf_value,ylim=c(0,max(newinf_value,new_infected)),xlab=\"Calendar year\",ylab=\"1000 people\",main=\"New infected\",pch=1,col=\"red\",lwd=3,cex=2,cex.main=1.8,cex.lab=1.6,cex.axis=1.5)\n  lines(seq(2005+11/12,2015,length.out=109),new_infected,type=\"l\",lwd=3)\n  #mtext(paste(\"f=\",as.numeric(round(f*100)/100)),side=\"3\",line=0,at=2002,cex=0.8,adj=0)\n  mtext(\"a.\",side=\"3\",line=0,at=2004.5,cex=1,adj=0)\n  \n  par(lwd=2,mai=c(0.6,0.7,0.5,0.4))\n  #ylim=c(min(apply(undiag_value,1,sum),undiag_people)\n  plot(2005:2015,apply(undiag_value,1,sum),ylim=c(0,max(apply(undiag_value,1,sum),undiag_people)),xlab=\"Calendar year\",ylab=\"1000 people\",main=\"Undiagnosed people\",pch=1,col=\"red\",lwd=3,cex=2,cex.main=1.8,cex.lab=1.6,cex.axis=1.5)\n  lines(seq(2005,2015,length.out=121),undiag_people,type=\"l\",lwd=3)\n  mtext(\"b.\",side=\"3\",line=0,at=2003.5,cex=1,adj=0)\n  \n  death_people=rollapply(diff(data[1:121,\"130\"]),12,sum)\n  death1_people=rollapply(diff(data[1:121,\"131\"]),12,sum)\n  death2_people=rollapply(diff(data[1:121,\"132\"]),12,sum)\n  death3_people=rollapply(diff(data[1:121,\"133\"]),12,sum)\n  \n  par(lwd=2,mai=c(0.6,0.7,0.5,0.4))\n  #ylim=c(min(death_value,death1_people)\n  plot(seq(2005+11/12,2014+11/12,length.out=10),death_value,ylim=c(0,max(death_value,death1_people)),xlab=\"Calendar year\",ylab=\"1000 people\",main=\"AIDS-related deaths\",pch=1,col=\"red\",lwd=3,cex=2,cex.main=1.8,cex.lab=1.6,cex.axis=1.5)\n  lines(seq(2005+11/12,2015,length.out=109),death1_people,type=\"l\",col=\"black\",lwd=3)\n  mtext(\"c.\",side=\"3\",line=0,at=2004.5,cex=1,adj=0)\n  #lines(2005:2014,death1_people,type=\"l\",col=\"green\")\n  #lines(2005:2014,death2_people,type=\"l\",col=\"blue\")\n  #lines(2005:2014,death3_people,type=\"l\",col=\"red\")\n  \n  par(lwd=2,mai=c(0.6,0.7,0.5,0.4))\n  plot(2005:2015,c(rep(NA,5),treat_percent*100),ylim=c(0,max(treat_percent,treat_people)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"Proportion of people on treatment\",pch=1,col=\"red\",lwd=3,cex=2,cex.main=1.8,cex.lab=1.6,cex.axis=1.5)\n  lines(seq(2005,2015,length.out=121),treat_people*100,type=\"l\",lwd=3)\n  mtext(\"d.\",side=\"3\",line=0,at=2003.5,cex=1,adj=0)\n  \n  par(lwd=2,mai=c(0.6,0.7,0.5,0.4))\n  #min(resis_people)*100\n  plot(seq(2005,2015,length.out=121),c(rep(NA,12),resis_people*100),type=\"l\",ylim=c(0,100),xlab=\"Calendar year\",ylab=\"percent\",main=\"Proportion of resistant if failing\",pch=1,col=\"black\",lwd=3,cex=2,cex.main=1.8,cex.lab=1.6,cex.axis=1.5)\n  lines(2005:2016,c(rep(NA,5),80,NA,NA,NA,95,NA,NA),type=\"p\",col=\"blue\",lwd=3)\n  mtext(\"e.\",side=\"3\",line=0,at=2003.5,cex=1,adj=0)\n  \n  par(lwd=2,mai=c(0.6,0.7,0.5,0.4))\n  #ylim=c(min(trandr)*100\n  plot(seq(2005,2016,length.out=133),c(trandr*100,rep(NA,12)),type=\"l\",ylim=c(0,12),xlab=\"Calendar year\",ylab=\"percent\",main=\"TDR Prevalence (diagnosed people)\",pch=1,col=\"black\",lwd=3,cex=2,cex.main=1.8,cex.lab=1.6,cex.axis=1.5)\n  lines(2005:2016,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),type=\"p\",col=\"blue\",lwd=3)\n  mtext(\"f.\",side=\"3\",line=0,at=2003.5,cex=1,adj=0)\n  \n  par(lwd=1,mai=c(0,0,0,0))\n  plot(1, type = \"n\", axes=FALSE, xlab=\"\", ylab=\"\")\n  plot_colors <- c(\"blue\",\"black\", \"green\", \"orange\", \"pink\")\n  \n  legend(x=\"left\", inset =0,\n         c(\"Simulated by the model\",\"Estimated data (WHO)\",\"Data from previous studies\"),\n         lty=c(1,NA,NA),pch=c(NA,\"o\",\"o\"), lwd=c(2,3,3), col=c(\"black\",\"red\",\"blue\"), box.col=NA,horiz=TRUE,cex=1.5,text.width = c(0,0.2,0.2))\n  \n  \n  # plot(2005:2015,inf,type=\"l\")\n  # plot(2005:2015,inf/(inf+susc),type=\"l\")\n  # plot(2005:2015,notsup)\n  # plot(2005:2015,susc)\n  # #plot(2005:2015,tr*notsup*susc)\n  # plot(2005:2015,notsup*susc)\n  # supp=rowSums(data[seq(1,121,12),1+select(c(4,7),1:4,1:2,1:2)])/rowSums(data[seq(1,121,12),1+select(1:8,1:4,1:2,1:2)])\n  # plot(2005:2015,supp)\n  # #plot(2005:2014,new_infected-death2_people)\n  # # plot(2005:2015,finf,ylim=c(min(c(finf,minf)),max(c(finf,minf))))\n  # # lines(2005:2015,minf)\n  # # print(finf)\n  # # print(minf)\n  # #plot(2005:2015,inf)\n  # \n  # op <- par(usr=c(0,1,0,1), # Reset the coordinates\n  #           xpd=NA)\n  # legend(-0.5,0.5, # Find suitable coordinates by trial and error\n  #        c(\"Simulated by the model\",\"Observed data\"), lty=c(1,NA),pch=c(\"*\",\"o\"), lwd=3, col=c(\"black\",\"red\"), box.col=NA,horiz=TRUE)\n  # #legend(-0.5,-1.1, # Find suitable coordinates by trial and error\n  #        #paste(\"f:\",as.character(round(f*100)/100),\" -- par:\",paste(as.vector(round(par*100)/100),sep=\",\",collapse=\", \"),sep=\"\",collapse=\"\"),box.col=NA,horiz=TRUE)\n}\n###########################################################################################\n#DTG, not more used\n\n#11 care stages, not more used\nselect_dtg=function(r1,r2,r3,r4){\n  l1=11\n  l2=4\n  l3=2\n  l4=2\n  ar=array(1:(l1*l2*l3*l4),dim=c(l1,l2,l3,l4))\n  return(as.vector(ar[r1,r2,r3,r4]))\n}\nmod_cpp_dtg=function(t,x,p1,treat_dtg){\n  #mod =function(t,x, params){\n  with(as.list(params), {\n    x=x[1:(88*2)]\n    ##################################################################################################################\n    #Optimization\n    rate1_inf <- p1[1] #number of unprotected sexual acts/month\n    rate2_inf <- p1[2]\n    rate1_diag <- p1[3] #diagnosis rate\n    rate2_diag <- p1[4] #diagnosis rate\n    rate_treat <- p1[5] #scale parameter for overall treatment rate\n    rate_death <- p1[6] #scale parameter for overall death\n    q <- p2[7]\n    #Range\n    rate_ratio <- p2[8] #varying parameter to estimate death for treated (but neither suppressed nor failed)\n    \n    alpha <- p2[12] #ratio between outcome when resistant/sensitive\n    rate_res <- p2[13] #resistant rate\n    rate_susc <- p2[14] #reversion rate\n    \n    #1. Infection and Diagnosis\n    RateInf1=array(rep(RateTransm,each=4),dim=c(4,2,2))*rate1_inf\n    RateInf2=RateInf1*rate2_inf\n    \n    Diag_frame[,4]=Diag_frame[,4]*rate2_diag\n    RateDiag=1/rate1_diag*apply(Diag_frame,1,function(x) smooth_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))\n    \n    RateDiag=array(rep(RateDiag,2)*rep(c(1,diag_women),each=4),dim=c(4,2))+\n      array(rep(oi_inc,2)*rep(smooth_st(2005+t/12,oi_test[\"a\"],oi_test[\"b\"],oi_test[\"c\"],oi_test[\"d\"]),8),dim=c(4,2))+\n      array(c(rep(0,4),preg_inc)*rep(smooth_st(2005+t/12,preg_test[\"a\"],preg_test[\"b\"],preg_test[\"c\"],preg_test[\"d\"]),8),dim=c(4,2))\n    \n    #2. Treatment theoretical (if no counterfactual scenario)\n    RateTreatFirst_th=apply(Treat_frame,1,function(x) smooth_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*smooth_st(2005+t/12,2001,2012,1,200/12)*rate_treat\n    \n    RateTreatFirst_f=function(y){\n      if(y<2005){\n        return(apply(Treat_frame_original,1,function(x) smooth_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*smooth_st(y,2001,2012,1,200/12)*rate_treat)\n      }else{\n        return(apply(\n          data.frame(t1=apply(Treat_frame,1,function(x) lin_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"])),\n                     t2=apply(Treat_frame2,1,function(x) lin_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*as.numeric(y>Treat_frame2$a[4])),\n          1,max)*smooth_st(y,2001,2012,1,200/12)*rate_treat)\n      }\n    }\n    RateTreatFirst_th=RateTreatFirst_f(2005+t/12)\n    \n    RateDirectTreatSecond_th=RateDirectTreatSecond\n    \n    #now\n    RateTreatFirst=matrix(c(RateTreatFirst_th,RateTreatFirst_th),nrow=2,ncol=4,byrow=T)\n    RateDirectTreatSecond=matrix(c(RateDirectTreatSecond_th,RateDirectTreatSecond_th),nrow=2,ncol=4,byrow=T)\n    \n    #Resistance testing at baseline\n    #RateTreatFirst=matrix(c(RateTreatFirst_th,c(0,0,0,0)),nrow=2,ncol=4,byrow=T)\n    #RateDirectTreatSecond=matrix(c(RateDirectTreatSecond_th,RateTreatFirst_th+RateDirectTreatSecond_th),nrow=2,ncol=4,byrow=T)\n    #RateTreatFirst=rep(rate_treat,4)\n    \n    #2. Treatment DTG\n    #RateTreatFirstDTG[res,cd4,gender]\n    RateTreatFirstDTG=array(rep(RateTreatFirst*treat_dtg[3],2)*rep(c(1,treat_dtg[1]),each=8),dim=c(2,4,2))*smooth_st(2005+t/12,2018,2018+treat_dtg[\"delay_first\"],0,1)\n    #RateSwitchDTG[care,cd4,res,gender]\n    RateSwitchDTG=array(rep(rep(treat_dtg[4]*RateTreatSecond,each=3)*rep(c(treat_dtg[5],treat_dtg[6],treat_dtg[7]),4),4)*\n                          #rep(c(1,treat_dtg[2]),each=24),dim=c(3,4,2,2))*\n                          rep(c(1,1),each=24),dim=c(3,4,2,2))*\n      smooth_st(2005+t/12,2018,2018+treat_dtg[\"delay_switch\"],0,1)\n    RateSwitchDTG[1:2,1:4,1:2,1:2]=rep(treat_dtg[4],32)*rep(rep(1/12,2)*c(treat_dtg[5],treat_dtg[6]),16)*\n      #rep(c(1,treat_dtg[2]),each=16)*\n      rep(c(1,1),each=16)*\n      smooth_st(2005+t/12,2018,2018+treat_dtg[\"delay_switch\"],0,1)\n    #RateTreatFirst [res,cd4,gender]\n    RateTreatFirst=array(rep(RateTreatFirst,2),dim=c(2,4,2))*apply(array(rep(1-(c(1,treat_dtg[1])*smooth_st(2005+t/12,2018,2018+treat_dtg[\"delay_first\"],0,1)*treat_dtg[3]),each=8),dim=c(2,4,2)),c(1,2,3),function(x) max(x,0))\n    #RateTreatSecond[CD4,gender]\n    RateTreatSecond=rep(RateTreatSecond,2)*apply(array(rep(1-(c(1,treat_dtg[2])*smooth_st(2005+t/12,2018,2018+treat_dtg[\"delay_switch\"],0,1)*treat_dtg[4]),each=4),dim=c(4,2)),c(1,2),function(x) max(x,0))\n    # RateTreatFirst=matrix(rep(0,8),nrow=2,ncol=4,byrow=T)\n    # RateDirectTreatSecond=matrix(rep(0,8),nrow=2,ncol=4,byrow=T)\n    #3. Death\n    #p1=p1_f(t,q)\n    #p1=min(1,q*mean(sapply(2005+seq(t-36,t,1)/12,function(x) apply(Treat_frame[4,],1,function(y) smooth_st(x,y[\"a\"],y[\"b\"],y[\"c\"],y[\"d\"]))*smooth_st(x,2001,2012,1,200/12))))\n    p1=min(1,q*mean(sapply(2005+seq(t-36,t,1)/12,function(x) RateTreatFirst_f(x)[4]/rate_treat)))\n    #p1=p1/2+0.2\n    mu[1:2,4,1]=p1*40.9+(1-p1)*134.4\n    mu[4,4,1]=p1*8.3+(1-p1)*41.7\n    mu[5,4,1]=p1*11.8+(1-p1)*59.7\n    mu[3,1:4,1]=rate_ratio*mu[4,1:4,1]+(1-rate_ratio)*mu[5,1:4,1]\n    mu[6:8,1:4,1]=mu[3:5,1:4,1]\n    mu[1:8,1:4,2]=mu[1:8,1:4,1]\n    mu=mu*rate_death/1000\n    \n    #Back and forth mutation and impact on treatment outcome\n    RateResistant=1/rate_res\n    RateSusceptible=1/rate_susc\n    #From T to S\n    RateSuppFirstSusc=RateSuppFirst/1\n    RateSuppFirstResis=1/alpha*RateSuppFirst/1\n    #From S to F\n    RateFailFirstSusc=RateFailFirst*1\n    RateFailFirstResis=alpha*RateFailFirst*1\n    #From T to F\n    RateTreatToFailFirstSusc=RateTreatToFailFirst*1\n    RateTreatToFailFirstResis=alpha*RateTreatToFailFirst*1\n    #From F to S\n    RateFailToSuppTreatFirstSusc=RateFailToSuppTreatFirst/1\n    RateFailToSuppTreatFirstResis=1/alpha*RateFailToSuppTreatFirst/1\n    \n    #For second-line regimen, no effect of NNRTI resistance on treatment as it is PI\n    ##################################################################################################################\n    dx=array(0,dim=c(11,4,2,2))\n    x=array(x,dim=c(11,4,2,2))\n    I=apply(x,4,sum)\n    \n    #First approach to model S: S=N-I\n    N=N_value_f(t+1)\n    S=N-I\n    #Percentage getting NNRTI-based 1st-line[gender]\n    p_NNRTI=sapply(1-(c(1,treat_dtg[1])*smooth_st(2005+t/12,2018,2018+treat_dtg[\"delay_first\"],0,1)*treat_dtg[3]),function(x) max(x,0))\n    #infected and treated children\n    I_m15=rep(infected_m15_f(t+1)/2,2) #number of infected children reaching 15 years old at a given month\n    t_m15=rep(treat_m15_f(t+1)/2,2)\n    \n    dx[2,1:4,1,1:2]=rep((1-res_m15)*I_m15/4,each=4)\n    dx[2,1:4,2,1:2]=rep(res_m15*I_m15/4,each=4)\n    dx[3,1:4,1,1:2]=rep((1-res_m15)*t_m15*p_NNRTI/4,each=4)\n    dx[3,1:4,2,1:2]=rep(res_m15*t_m15*p_NNRTI/4,each=4)\n    dx[9,1:4,1,1:2]=rep((1-res_m15)*t_m15*(1-p_NNRTI)/4,each=4)\n    dx[9,1:4,2,1:2]=rep(res_m15*t_m15*(1-p_NNRTI)/4,each=4)\n    \n    for(j in 1:2){\n      #dx[x1,x2,x3,x4] x1:care stages x2:disease progression x3:resistance x4:gender\n      #dx with only interaction with the neighbours in the compartmental model\n      dx[1,1,1,j]=S[j]/N[j]*(sum(RateInf1[1:4,1:2,j]*apply(x[c(1),1:4,1,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,j]*apply(x[c(2,3,5,6,8,9,11),1:4,1,1:2],c(2,3),sum)))-\n        (RateStageInf[1]+RateDiag[1,j]+mu[1,1,1])*x[1,1,1,j]\n      dx[2,1,1,j]=dx[2,1,1,j]+RateDiag[1,j]*x[1,1,1,j]-(RateTreatFirst[1,1,j]+RateStageDiag[1]+mu[2,1,1])*x[2,1,1,j]\n      dx[3,1,1,j]=dx[3,1,1,j]+RateTreatFirst[1,1,j]*x[2,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[3,1,1,j]+RateStageTreatFirstL[1]*x[3,2,1,j]\n      dx[4,1,1,j]=RateSuppFirstSusc[1]*x[3,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[4,1,1,j]+RateStageSuppFirst[1]*x[4,2,1,j]\n      dx[5,1,1,j]=RateFailFirstSusc[1]*x[4,1,1,j]-(RateTreatSecond[1,j]+RateStageFailFirst[1]+mu[5,1,1])*x[5,1,1,j]\n      dx[6,1,1,j]=RateTreatSecond[1,j]*x[5,1,1,j]-(RateSuppSecond[1]+RateStageTreatSecondR[1]+mu[6,1,1])*x[6,1,1,j]+RateStageTreatSecondL[1]*x[6,2,1,j]\n      dx[7,1,1,j]=RateSuppSecond[1]*x[6,1,1,j]-(RateFailSecond[1]+mu[7,1,1])*x[7,1,1,j]+RateStageSuppSecond[1]*x[7,2,1,j]\n      dx[8,1,1,j]=RateFailSecond[1]*x[7,1,1,j]-(RateStageFailSecond[1]+mu[8,1,1])*x[8,1,1,j]\n      \n      dx[1,2,1,j]=-(RateStageInf[2]+RateDiag[2,j]+mu[1,2,1])*x[1,2,1,j]+RateStageInf[1]*x[1,1,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]+RateDiag[2,j]*x[1,2,1,j]-(RateTreatFirst[1,2,j]+RateStageDiag[2]+mu[2,2,1])*x[2,2,1,j]+RateStageDiag[1]*x[2,1,1,j]\n      dx[3,2,1,j]=dx[3,2,1,j]+RateTreatFirst[1,2,j]*x[2,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[3,2,1,j]+RateStageTreatFirstR[1]*x[3,1,1,j]+RateStageTreatFirstL[2]*x[3,3,1,j]\n      dx[4,2,1,j]=RateSuppFirstSusc[2]*x[3,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[4,2,1,j]+RateStageSuppFirst[2]*x[4,3,1,j]\n      dx[5,2,1,j]=RateFailFirstSusc[2]*x[4,2,1,j]-(RateTreatSecond[2,j]+RateStageFailFirst[2]+mu[5,2,1])*x[5,2,1,j]+RateStageFailFirst[1]*x[5,1,1,j]\n      dx[6,2,1,j]=RateTreatSecond[2,j]*x[5,2,1,j]-(RateSuppSecond[2]+RateStageTreatSecondR[2]+RateStageTreatSecondL[1]+mu[6,2,1 ])*x[6,2,1,j]+RateStageTreatSecondR[1]*x[6,1,1,j]+RateStageTreatSecondL[2]*x[6,3,1,j]\n      dx[7,2,1,j]=RateSuppSecond[2]*x[6,2,1,j]-(RateFailSecond[2]+RateStageSuppSecond[1]+mu[7,2,1])*x[7,2,1,j]+RateStageSuppSecond[2]*x[7,3,1,j]\n      dx[8,2,1,j]=RateFailSecond[2]*x[7,2,1,j]-(RateStageFailSecond[2]+mu[8,2,1])*x[8,2,1,j]+RateStageFailSecond[1]*x[8,1,1,j]\n      \n      dx[1,3,1,j]=-(RateStageInf[3]+RateDiag[3,j]+mu[1,3,1])*x[1,3,1,j]+RateStageInf[2]*x[1,2,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]+RateDiag[3,j]*x[1,3,1,j]-(RateTreatFirst[1,3,j]+RateStageDiag[3]+mu[2,3,1])*x[2,3,1,j]+RateStageDiag[2]*x[2,2,1,j]\n      dx[3,3,1,j]=dx[3,3,1,j]+RateTreatFirst[1,3,j]*x[2,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[3,3,1,j]+RateStageTreatFirstR[2]*x[3,2,1,j]+RateStageTreatFirstL[3]*x[3,4,1,j]\n      dx[4,3,1,j]=RateSuppFirstSusc[3]*x[3,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[4,3,1,j]+RateStageSuppFirst[3]*x[4,4,1,j]\n      dx[5,3,1,j]=RateFailFirstSusc[3]*x[4,3,1,j]-(RateTreatSecond[3,j]+RateStageFailFirst[3]+mu[5,3,1])*x[5,3,1,j]+RateStageFailFirst[2]*x[5,2,1,j]\n      dx[6,3,1,j]=RateTreatSecond[3,j]*x[5,3,1,j]-(RateSuppSecond[3]+RateStageTreatSecondR[3]+RateStageTreatSecondL[2]+mu[6,3,1])*x[6,3,1,j]+RateStageTreatSecondR[2]*x[6,2,1,j]+RateStageTreatSecondL[3]*x[6,4,1,j]\n      dx[7,3,1,j]=RateSuppSecond[3]*x[6,3,1,j]-(RateFailSecond[3]+RateStageSuppSecond[2]+mu[7,3,1])*x[7,3,1,j]+RateStageSuppSecond[3]*x[7,4,1,j]\n      dx[8,3,1,j]=RateFailSecond[3]*x[7,3,1,j]-(RateStageFailSecond[3]+mu[8,3,1])*x[8,3,1,j]+RateStageFailSecond[2]*x[8,2,1,j]\n      \n      dx[1,4,1,j]=-(RateDiag[4,j]+mu[1,4,1])*x[1,4,1,j]+RateStageInf[3]*x[1,3,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]+RateDiag[4,j]*x[1,4,1,j]-(RateTreatFirst[1,4,j]+mu[2,4,1])*x[2,4,1,j]+RateStageDiag[3]*x[2,3,1,j]\n      dx[3,4,1,j]=dx[3,4,1,j]+RateTreatFirst[1,4,j]*x[2,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[3,4,1,j]+RateStageTreatFirstR[3]*x[3,3,1,j]\n      dx[4,4,1,j]=RateSuppFirstSusc[4]*x[3,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[4,4,1,j]\n      dx[5,4,1,j]=RateFailFirstSusc[4]*x[4,4,1,j]-(RateTreatSecond[4,j]+mu[5,4,1])*x[5,4,1,j]+RateStageFailFirst[3]*x[5,3,1,j]\n      dx[6,4,1,j]=RateTreatSecond[4,j]*x[5,4,1,j]-(RateSuppSecond[4]+RateStageTreatSecondL[3]+mu[6,4,1])*x[6,4,1,j]+RateStageTreatSecondR[3]*x[6,3,1,j]\n      dx[7,4,1,j]=RateSuppSecond[4]*x[6,4,1,j]-(RateFailSecond[4]+RateStageSuppSecond[3]+mu[7,4,1])*x[7,4,1,j]\n      dx[8,4,1,j]=RateFailSecond[4]*x[7,4,1,j]-mu[8,4,1 ]*x[8,4,1,j]+RateStageFailSecond[3]*x[8,3,1,j]\n      \n      ##############################################################################################################################################################\n      \n      dx[1,1,1,j]=dx[1,1,1,j]\n      dx[2,1,1,j]=dx[2,1,1,j]-RateDirectTreatSecond[1,1]*x[2,1,1,j]+RateStopTreatFirst[1]*x[3,1,1,j]+RateStopSuppFirst[1]*x[4,1,1,j]+RateStopFailFirst[1]*x[5,1,1,j]+\n        RateStopTreatSecond[1]*x[6,1,1,j]+RateStopSuppSecond[1]*x[7,1,1,j]+RateStopFailSecond[1]*x[8,1,1,j]\n      dx[3,1,1,j]=dx[3,1,1,j]-RateStopTreatFirst[1]*x[3,1,1,j]-RateTreatToFailFirstSusc[1]*x[3,1,1,j]\n      dx[4,1,1,j]=dx[4,1,1,j]-RateStopSuppFirst[1]*x[4,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[5,1,1,j]-RateSuppFirstToSecond[1]*x[4,1,1,j]\n      dx[5,1,1,j]=dx[5,1,1,j]-RateStopFailFirst[1]*x[5,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[5,1,1,j]+RateTreatToFailFirstSusc[1]*x[3,1,1,j]\n      dx[6,1,1,j]=dx[6,1,1,j]-RateStopTreatSecond[1]*x[6,1,1,j]+RateDirectTreatSecond[1,1]*x[2,1,1,j]-RateTreatToFailSecond[1]*x[6,1,1,j]\n      dx[7,1,1,j]=dx[7,1,1,j]-RateStopSuppSecond[1]*x[7,1,1,j]+RateFailToSuppTreatSecond[1]*x[8,1,1,j]+RateSuppFirstToSecond[1]*x[4,1,1,j]\n      dx[8,1,1,j]=dx[8,1,1,j]-RateStopFailSecond[1]*x[8,1,1,j]-RateFailToSuppTreatSecond[1]*x[8,1,1,j]+RateTreatToFailSecond[1]*x[6,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]-RateDirectTreatSecond[1,2]*x[2,2,1,j]+RateStopTreatFirst[2]*x[3,2,1,j]+RateStopSuppFirst[2]*x[4,2,1,j]+RateStopFailFirst[2]*x[5,2,1,j]+\n        RateStopTreatSecond[2]*x[6,2,1,j]+RateStopSuppSecond[2]*x[7,2,1,j]+RateStopFailSecond[2]*x[8,2,1,j]\n      dx[3,2,1,j]=dx[3,2,1,j]-RateStopTreatFirst[2]*x[3,2,1,j]-RateTreatToFailFirstSusc[2]*x[3,2,1,j]\n      dx[4,2,1,j]=dx[4,2,1,j]-RateStopSuppFirst[2]*x[4,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[5,2,1,j]-RateSuppFirstToSecond[2]*x[4,2,1,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateStopFailFirst[2]*x[5,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[5,2,1,j]+RateTreatToFailFirstSusc[2]*x[3,2,1,j]\n      dx[6,2,1,j]=dx[6,2,1,j]-RateStopTreatSecond[2]*x[6,2,1,j]+RateDirectTreatSecond[1,2]*x[2,2,1,j]-RateTreatToFailSecond[2]*x[6,2,1,j]\n      dx[7,2,1,j]=dx[7,2,1,j]-RateStopSuppSecond[2]*x[7,2,1,j]+RateFailToSuppTreatSecond[2]*x[8,2,1,j]+RateSuppFirstToSecond[2]*x[4,2,1,j]\n      dx[8,2,1,j]=dx[8,2,1,j]-RateStopFailSecond[2]*x[8,2,1,j]-RateFailToSuppTreatSecond[2]*x[8,2,1,j]+RateTreatToFailSecond[2]*x[6,2,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]-RateDirectTreatSecond[1,3]*x[2,3,1,j]+RateStopTreatFirst[3]*x[3,3,1,j]+RateStopSuppFirst[3]*x[4,3,1,j]+RateStopFailFirst[3]*x[5,3,1,j]+\n        RateStopTreatSecond[3]*x[6,3,1,j]+RateStopSuppSecond[3]*x[7,3,1,j]+RateStopFailSecond[3]*x[8,3,1,j]\n      dx[3,3,1,j]=dx[3,3,1,j]-RateStopTreatFirst[3]*x[3,3,1,j]-RateTreatToFailFirstSusc[3]*x[3,3,1,j]\n      dx[4,3,1,j]=dx[4,3,1,j]-RateStopSuppFirst[3]*x[4,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[5,3,1,j]-RateSuppFirstToSecond[3]*x[4,3,1,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateStopFailFirst[3]*x[5,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[5,3,1,j]+RateTreatToFailFirstSusc[3]*x[3,3,1,j]\n      dx[6,3,1,j]=dx[6,3,1,j]-RateStopTreatSecond[3]*x[6,3,1,j]+RateDirectTreatSecond[1,3]*x[2,3,1,j]-RateTreatToFailSecond[3]*x[6,3,1,j]\n      dx[7,3,1,j]=dx[7,3,1,j]-RateStopSuppSecond[3]*x[7,3,1,j]+RateFailToSuppTreatSecond[3]*x[8,3,1,j]+RateSuppFirstToSecond[3]*x[4,3,1,j]\n      dx[8,3,1,j]=dx[8,3,1,j]-RateStopFailSecond[3]*x[8,3,1,j]-RateFailToSuppTreatSecond[3]*x[8,3,1,j]+RateTreatToFailSecond[3]*x[6,3,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]-RateDirectTreatSecond[1,4]*x[2,4,1,j]+RateStopTreatFirst[4]*x[3,4,1,j]+RateStopSuppFirst[4]*x[4,4,1,j]+RateStopFailFirst[4]*x[5,4,1,j]+\n        RateStopTreatSecond[4]*x[6,4,1,j]+RateStopSuppSecond[4]*x[7,4,1,j]+RateStopFailSecond[4]*x[8,4,1,j]\n      dx[3,4,1,j]=dx[3,4,1,j]-RateStopTreatFirst[4]*x[3,4,1,j]-RateTreatToFailFirstSusc[4]*x[3,4,1,j]\n      dx[4,4,1,j]=dx[4,4,1,j]-RateStopSuppFirst[4]*x[4,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[5,4,1,j]-RateSuppFirstToSecond[4]*x[4,4,1,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateStopFailFirst[4]*x[5,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[5,4,1,j]+RateTreatToFailFirstSusc[4]*x[3,4,1,j]\n      dx[6,4,1,j]=dx[6,4,1,j]-RateStopTreatSecond[4]*x[6,4,1,j]+RateDirectTreatSecond[1,4]*x[2,4,1,j]-RateTreatToFailSecond[4]*x[6,4,1,j]\n      dx[7,4,1,j]=dx[7,4,1,j]-RateStopSuppSecond[4]*x[7,4,1,j]+RateFailToSuppTreatSecond[4]*x[8,4,1,j]+RateSuppFirstToSecond[4]*x[4,4,1,j]\n      dx[8,4,1,j]=dx[8,4,1,j]-RateStopFailSecond[4]*x[8,4,1,j]-RateFailToSuppTreatSecond[4]*x[8,4,1,j]+RateTreatToFailSecond[4]*x[6,4,1,j]\n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      dx[1,1,2,j]=S[j]/N[j]*(sum(RateInf1[1:4,1:2,j]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,j]*apply(x[c(2,3,5,6,8,9,11),1:4,2,1:2],c(2,3),sum)))-\n        (RateStageInf[1]+RateDiag[1,j]+mu[1,1,2 ])*x[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]+RateDiag[1,j]*x[1,1,2,j]-(RateTreatFirst[2,1,j]+RateStageDiag[1]+mu[2,1,2 ])*x[2,1,2,j]\n      dx[3,1,2,j]=dx[3,1,2,j]+RateTreatFirst[2,1,j]*x[2,1,2,j]-(RateSuppFirstResis[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[3,1,2,j]+RateStageTreatFirstL[1]*x[3,2,2,j]\n      dx[4,1,2,j]=RateSuppFirstResis[1]*x[3,1,2,j]-(RateFailFirstResis[1]+mu[4,1,2])*x[4,1,2,j]+RateStageSuppFirst[1]*x[4,2,2,j]\n      dx[5,1,2,j]=RateFailFirstResis[1]*x[4,1,2,j]-(RateTreatSecond[1,j]+RateStageFailFirst[1]+mu[5,1,2 ])*x[5,1,2,j]\n      dx[6,1,2,j]=RateTreatSecond[1,j]*x[5,1,2,j]-(RateSuppSecond[1]+RateStageTreatSecondR[1]+mu[6,1,2 ])*x[6,1,2,j]+RateStageTreatSecondL[1]*x[6,2,2,j]\n      dx[7,1,2,j]=RateSuppSecond[1]*x[6,1,2,j]-(RateFailSecond[1]+mu[7,1,2])*x[7,1,2,j]+RateStageSuppSecond[1]*x[7,2,2,j]\n      dx[8,1,2,j]=RateFailSecond[1]*x[7,1,2,j]-(RateStageFailSecond[1]+mu[8,1,2])*x[8,1,2,j]\n      \n      dx[1,2,2,j]=-(RateStageInf[2]+RateDiag[2,j]+mu[1,2,2])*x[1,2,2,j]+RateStageInf[1]*x[1,1,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]+RateDiag[2,j]*x[1,2,2,j]-(RateTreatFirst[2,2,j]+RateStageDiag[2]+mu[2,2,2])*x[2,2,2,j]+RateStageDiag[1]*x[2,1,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]+RateTreatFirst[2,2,j]*x[2,2,2,j]-(RateSuppFirstResis[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2 ])*x[3,2,2,j]+RateStageTreatFirstR[1]*x[3,1,2,j]+RateStageTreatFirstL[2]*x[3,3,2,j]\n      dx[4,2,2,j]=RateSuppFirstResis[2]*x[3,2,2,j]-(RateFailFirstResis[2]+RateStageSuppFirst[2]+mu[4,2,2])*x[4,2,2,j]+RateStageSuppFirst[2]*x[4,3,2,j]\n      dx[5,2,2,j]=RateFailFirstResis[2]*x[4,2,2,j]-(RateTreatSecond[2,j]+RateStageFailFirst[2]+mu[5,2,2])*x[5,2,2,j]+RateStageFailFirst[1]*x[5,1,2,j]\n      dx[6,2,2,j]=RateTreatSecond[2,j]*x[5,2,2,j]-(RateSuppSecond[2]+RateStageTreatSecondR[2]+RateStageTreatSecondL[1]+mu[6,2,2])*x[6,2,2,j]+RateStageTreatSecondR[1]*x[6,1,2,j]+RateStageTreatSecondL[2]*x[6,3,2,j]\n      dx[7,2,2,j]=RateSuppSecond[2]*x[6,2,2,j]-(RateFailSecond[2]+RateStageSuppSecond[1]+mu[7,2,2])*x[7,2,2,j]+RateStageSuppSecond[2]*x[7,3,2,j]\n      dx[8,2,2,j]=RateFailSecond[2]*x[7,2,2,j]-(RateStageFailSecond[2]+mu[8,2,2])*x[8,2,2,j]+RateStageFailSecond[1]*x[8,1,2,j]\n      \n      dx[1,3,2,j]=-(RateStageInf[3]+RateDiag[3,j]+mu[1,3,2])*x[1,3,2,j]+RateStageInf[2]*x[1,2,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]+RateDiag[3,j]*x[1,3,2,j]-(RateTreatFirst[2,3,j]+RateStageDiag[3]+mu[2,3,2])*x[2,3,2,j]+RateStageDiag[2]*x[2,2,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]+RateTreatFirst[2,3,j]*x[2,3,2,j]-(RateSuppFirstResis[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[3,3,2,j]+RateStageTreatFirstR[2]*x[3,2,2,j]+RateStageTreatFirstL[3]*x[3,4,2,j]\n      dx[4,3,2,j]=RateSuppFirstResis[3]*x[3,3,2,j]-(RateFailFirstResis[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[4,3,2,j]+RateStageSuppFirst[3]*x[4,4,2,j]\n      dx[5,3,2,j]=RateFailFirstResis[3]*x[4,3,2,j]-(RateTreatSecond[3,j]+RateStageFailFirst[3]+mu[5,3,2])*x[5,3,2,j]+RateStageFailFirst[2]*x[5,2,2,j]\n      dx[6,3,2,j]=RateTreatSecond[3,j]*x[5,3,2,j]-(RateSuppSecond[3]+RateStageTreatSecondR[3]+RateStageTreatSecondL[2]+mu[6,3,2])*x[6,3,2,j]+RateStageTreatSecondR[2]*x[6,2,2,j]+RateStageTreatSecondL[3]*x[6,4,2,j]\n      dx[7,3,2,j]=RateSuppSecond[3]*x[6,3,2,j]-(RateFailSecond[3]+RateStageSuppSecond[2]+mu[7,3,2])*x[7,3,2,j]+RateStageSuppSecond[3]*x[7,4,2,j]\n      dx[8,3,2,j]=RateFailSecond[3]*x[7,3,2,j]-(RateStageFailSecond[3]+mu[8,3,2])*x[8,3,2,j]+RateStageFailSecond[2]*x[8,2,2,j]\n      \n      dx[1,4,2,j]=-(RateDiag[4,j]+mu[1,4,2])*x[1,4,2,j]+RateStageInf[3]*x[1,3,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]+RateDiag[4,j]*x[1,4,2,j]-(RateTreatFirst[2,4,j]+mu[2,4,2])*x[2,4,2,j]+RateStageDiag[3]*x[2,3,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]+RateTreatFirst[2,4,j]*x[2,4,2,j]-(RateSuppFirstResis[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[3,4,2,j]+RateStageTreatFirstR[3]*x[3,3,2,j]\n      dx[4,4,2,j]=RateSuppFirstResis[4]*x[3,4,2,j]-(RateFailFirstResis[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[4,4,2,j]\n      dx[5,4,2,j]=RateFailFirstResis[4]*x[4,4,2,j]-(RateTreatSecond[4,j]+mu[5,4,2])*x[5,4,2,j]+RateStageFailFirst[3]*x[5,3,2,j]\n      dx[6,4,2,j]=RateTreatSecond[4,j]*x[5,4,2,j]-(RateSuppSecond[4]+RateStageTreatSecondL[3]+mu[6,4,2])*x[6,4,2,j]+RateStageTreatSecondR[3]*x[6,3,2,j]\n      dx[7,4,2,j]=RateSuppSecond[4]*x[6,4,2,j]-(RateFailSecond[4]+RateStageSuppSecond[3]+mu[7,4,2])*x[7,4,2,j]\n      dx[8,4,2,j]=RateFailSecond[4]*x[7,4,2,j]-mu[8,4,2]*x[8,4,2,j]+RateStageFailSecond[3]*x[8,3,2,j]\n      \n      ##############################################################################################################################################################\n      \n      dx[1,1,2,j]=dx[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]-RateDirectTreatSecond[2,1]*x[2,1,2,j]+RateStopTreatFirst[1]*x[3,1,2,j]+RateStopSuppFirst[1]*x[4,1,2,j]+RateStopFailFirst[1]*x[5,1,2,j]+\n        RateStopTreatSecond[1]*x[6,1,2,j]+RateStopSuppSecond[1]*x[7,1,2,j]+RateStopFailSecond[1]*x[8,1,2,j]\n      dx[3,1,2,j]=dx[3,1,2,j]-RateStopTreatFirst[1]*x[3,1,2,j]-RateTreatToFailFirstResis[1]*x[3,1,2,j]\n      dx[4,1,2,j]=dx[4,1,2,j]-RateStopSuppFirst[1]*x[4,1,2,j]+RateFailToSuppTreatFirstResis[1]*x[5,1,2,j]-RateSuppFirstToSecond[1]*x[4,1,2,j]\n      dx[5,1,2,j]=dx[5,1,2,j]-RateStopFailFirst[1]*x[5,1,2,j]-RateFailToSuppTreatFirstResis[1]*x[5,1,2,j]+RateTreatToFailFirstResis[1]*x[3,1,2,j]\n      dx[6,1,2,j]=dx[6,1,2,j]-RateStopTreatSecond[1]*x[6,1,2,j]+RateDirectTreatSecond[2,1]*x[2,1,2,j]-RateTreatToFailSecond[1]*x[6,1,2,j]\n      dx[7,1,2,j]=dx[7,1,2,j]-RateStopSuppSecond[1]*x[7,1,2,j]+RateFailToSuppTreatSecond[1]*x[8,1,2,j]+RateSuppFirstToSecond[1]*x[4,1,2,j]\n      dx[8,1,2,j]=dx[8,1,2,j]-RateStopFailSecond[1]*x[8,1,2,j]-RateFailToSuppTreatSecond[1]*x[8,1,2,j]+RateTreatToFailSecond[1]*x[6,1,2,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateDirectTreatSecond[2,2]*x[2,2,2,j]+RateStopTreatFirst[2]*x[3,2,2,j]+RateStopSuppFirst[2]*x[4,2,2,j]+RateStopFailFirst[2]*x[5,2,2,j]+\n        RateStopTreatSecond[2]*x[6,2,2,j]+RateStopSuppSecond[2]*x[7,2,2,j]+RateStopFailSecond[2]*x[8,2,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]-RateStopTreatFirst[2]*x[3,2,2,j]-RateTreatToFailFirstResis[2]*x[3,2,2,j]\n      dx[4,2,2,j]=dx[4,2,2,j]-RateStopSuppFirst[2]*x[4,2,2,j]+RateFailToSuppTreatFirstResis[2]*x[5,2,2,j]-RateSuppFirstToSecond[2]*x[4,2,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]-RateStopFailFirst[2]*x[5,2,2,j]-RateFailToSuppTreatFirstResis[2]*x[5,2,2,j]+RateTreatToFailFirstResis[2]*x[3,2,2,j]\n      dx[6,2,2,j]=dx[6,2,2,j]-RateStopTreatSecond[2]*x[6,2,2,j]+RateDirectTreatSecond[2,2]*x[2,2,2,j]-RateTreatToFailSecond[2]*x[6,2,2,j]\n      dx[7,2,2,j]=dx[7,2,2,j]-RateStopSuppSecond[2]*x[7,2,2,j]+RateFailToSuppTreatSecond[2]*x[8,2,2,j]+RateSuppFirstToSecond[2]*x[4,2,2,j]\n      dx[8,2,2,j]=dx[8,2,2,j]-RateStopFailSecond[2]*x[8,2,2,j]-RateFailToSuppTreatSecond[2]*x[8,2,2,j]+RateTreatToFailSecond[2]*x[6,2,2,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateDirectTreatSecond[2,3]*x[2,3,2,j]+RateStopTreatFirst[3]*x[3,3,2,j]+RateStopSuppFirst[3]*x[4,3,2,j]+RateStopFailFirst[3]*x[5,3,2,j]+\n        RateStopTreatSecond[3]*x[6,3,2,j]+RateStopSuppSecond[3]*x[7,3,2,j]+RateStopFailSecond[3]*x[8,3,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]-RateStopTreatFirst[3]*x[3,3,2,j]-RateTreatToFailFirstResis[3]*x[3,3,2,j]\n      dx[4,3,2,j]=dx[4,3,2,j]-RateStopSuppFirst[3]*x[4,3,2,j]+RateFailToSuppTreatFirstResis[3]*x[5,3,2,j]-RateSuppFirstToSecond[3]*x[4,3,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]-RateStopFailFirst[3]*x[5,3,2,j]-RateFailToSuppTreatFirstResis[3]*x[5,3,2,j]+RateTreatToFailFirstResis[3]*x[3,3,2,j]\n      dx[6,3,2,j]=dx[6,3,2,j]-RateStopTreatSecond[3]*x[6,3,2,j]+RateDirectTreatSecond[2,3]*x[2,3,2,j]-RateTreatToFailSecond[3]*x[6,3,2,j]\n      dx[7,3,2,j]=dx[7,3,2,j]-RateStopSuppSecond[3]*x[7,3,2,j]+RateFailToSuppTreatSecond[3]*x[8,3,2,j]+RateSuppFirstToSecond[3]*x[4,3,2,j]\n      dx[8,3,2,j]=dx[8,3,2,j]-RateStopFailSecond[3]*x[8,3,2,j]-RateFailToSuppTreatSecond[3]*x[8,3,2,j]+RateTreatToFailSecond[3]*x[6,3,2,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateDirectTreatSecond[2,4]*x[2,4,2,j]+RateStopTreatFirst[4]*x[3,4,2,j]+RateStopSuppFirst[4]*x[4,4,2,j]+RateStopFailFirst[4]*x[5,4,2,j]+\n        RateStopTreatSecond[4]*x[6,4,2,j]+RateStopSuppSecond[4]*x[7,4,2,j]+RateStopFailSecond[4]*x[8,4,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]-RateStopTreatFirst[4]*x[3,4,2,j]-RateTreatToFailFirstResis[4]*x[3,4,2,j]\n      dx[4,4,2,j]=dx[4,4,2,j]-RateStopSuppFirst[4]*x[4,4,2,j]+RateFailToSuppTreatFirstResis[4]*x[5,4,2,j]-RateSuppFirstToSecond[4]*x[4,4,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]-RateStopFailFirst[4]*x[5,4,2,j]-RateFailToSuppTreatFirstResis[4]*x[5,4,2,j]+RateTreatToFailFirstResis[4]*x[3,4,2,j]\n      dx[6,4,2,j]=dx[6,4,2,j]-RateStopTreatSecond[4]*x[6,4,2,j]+RateDirectTreatSecond[2,4]*x[2,4,2,j]-RateTreatToFailSecond[4]*x[6,4,2,j]\n      dx[7,4,2,j]=dx[7,4,2,j]-RateStopSuppSecond[4]*x[7,4,2,j]+RateFailToSuppTreatSecond[4]*x[8,4,2,j]+RateSuppFirstToSecond[4]*x[4,4,2,j]\n      dx[8,4,2,j]=dx[8,4,2,j]-RateStopFailSecond[4]*x[8,4,2,j]-RateFailToSuppTreatSecond[4]*x[8,4,2,j]+RateTreatToFailSecond[4]*x[6,4,2,j]\n      \n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      #dx with interaction between resistant and susceptible compartments\n      dx[1,1,1,j]=dx[1,1,1,j]+RateSusceptible*x[1,1,2,j]\n      dx[2,1,1,j]=dx[2,1,1,j]+RateSusceptible*x[2,1,2,j]\n      dx[3,1,1,j]=dx[3,1,1,j]\n      dx[4,1,1,j]=dx[4,1,1,j]\n      dx[5,1,1,j]=dx[5,1,1,j]-RateResistant*x[5,1,1,j]\n      dx[6,1,1,j]=dx[6,1,1,j]\n      dx[7,1,1,j]=dx[7,1,1,j]\n      dx[8,1,1,j]=dx[8,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]+RateSusceptible*x[1,2,2,j]\n      dx[2,2,1,j]=dx[2,2,1,j]+RateSusceptible*x[2,2,2,j]\n      dx[3,2,1,j]=dx[3,2,1,j]\n      dx[4,2,1,j]=dx[4,2,1,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateResistant*x[5,2,1,j]\n      dx[6,2,1,j]=dx[6,2,1,j]\n      dx[7,2,1,j]=dx[7,2,1,j]\n      dx[8,2,1,j]=dx[8,2,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]+RateSusceptible*x[1,3,2,j]\n      dx[2,3,1,j]=dx[2,3,1,j]+RateSusceptible*x[2,3,2,j]\n      dx[3,3,1,j]=dx[3,3,1,j]\n      dx[4,3,1,j]=dx[4,3,1,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateResistant*x[5,3,1,j]\n      dx[6,3,1,j]=dx[6,3,1,j]\n      dx[7,3,1,j]=dx[7,3,1,j]\n      dx[8,3,1,j]=dx[8,3,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]+RateSusceptible*x[1,4,2,j]\n      dx[2,4,1,j]=dx[2,4,1,j]+RateSusceptible*x[2,4,2,j]\n      dx[3,4,1,j]=dx[3,4,1,j]\n      dx[4,4,1,j]=dx[4,4,1,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateResistant*x[5,4,1,j]\n      dx[6,4,1,j]=dx[6,4,1,j]\n      dx[7,4,1,j]=dx[7,4,1,j]\n      dx[8,4,1,j]=dx[8,4,1,j]\n      \n      #############################################################################################################################################################################\n      dx[1,1,2,j]=dx[1,1,2,j]-RateSusceptible*x[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]-RateSusceptible*x[2,1,2,j]\n      dx[3,1,2,j]=dx[3,1,2,j]\n      dx[4,1,2,j]=dx[4,1,2,j]\n      dx[5,1,2,j]=dx[5,1,2,j]+RateResistant*x[5,1,1,j]\n      dx[6,1,2,j]=dx[6,1,2,j]\n      dx[7,1,2,j]=dx[7,1,2,j]\n      dx[8,1,2,j]=dx[8,1,2,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]-RateSusceptible*x[1,2,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateSusceptible*x[2,2,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]\n      dx[4,2,2,j]=dx[4,2,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]+RateResistant*x[5,2,1,j]\n      dx[6,2,2,j]=dx[6,2,2,j]\n      dx[7,2,2,j]=dx[7,2,2,j]\n      dx[8,2,2,j]=dx[8,2,2,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]-RateSusceptible*x[1,3,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateSusceptible*x[2,3,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]\n      dx[4,3,2,j]=dx[4,3,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]+RateResistant*x[5,3,1,j]\n      dx[6,3,2,j]=dx[6,3,2,j]\n      dx[7,3,2,j]=dx[7,3,2,j]\n      dx[8,3,2,j]=dx[8,3,2,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]-RateSusceptible*x[1,4,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateSusceptible*x[2,4,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]\n      dx[4,4,2,j]=dx[4,4,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]+RateResistant*x[5,4,1,j]\n      dx[6,4,2,j]=dx[6,4,2,j]\n      dx[7,4,2,j]=dx[7,4,2,j]\n      dx[8,4,2,j]=dx[8,4,2,j]\n      \n      \n      #RateTreatFirstDTG[res,cd4,gender]------------------------------\n      #NNRTI susceptible\n      dx[2,1,1,j]=dx[2,1,1,j]-RateTreatFirstDTG[1,1,j]*x[2,1,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]-RateTreatFirstDTG[1,2,j]*x[2,2,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]-RateTreatFirstDTG[1,3,j]*x[2,3,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]-RateTreatFirstDTG[1,4,j]*x[2,4,1,j]\n      \n      dx[2,1,2,j]=dx[2,1,2,j]-RateTreatFirstDTG[2,1,j]*x[2,1,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateTreatFirstDTG[2,2,j]*x[2,2,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateTreatFirstDTG[2,3,j]*x[2,3,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateTreatFirstDTG[2,4,j]*x[2,4,2,j]\n      \n      #RateSwitchDTG[care,cd4,res,gender]----------------------------\n      #NNRTI susceptible\n      dx[3,1,1,j]=dx[3,1,1,j]-RateSwitchDTG[1,1,1,j]*x[3,1,1,j]\n      dx[3,2,1,j]=dx[3,2,1,j]-RateSwitchDTG[1,2,1,j]*x[3,2,1,j]\n      dx[3,3,1,j]=dx[3,3,1,j]-RateSwitchDTG[1,3,1,j]*x[3,3,1,j]\n      dx[3,4,1,j]=dx[3,4,1,j]-RateSwitchDTG[1,4,1,j]*x[3,4,1,j]\n      \n      dx[4,1,1,j]=dx[4,1,1,j]-RateSwitchDTG[2,1,1,j]*x[4,1,1,j]\n      dx[4,2,1,j]=dx[4,2,1,j]-RateSwitchDTG[2,2,1,j]*x[4,2,1,j]\n      dx[4,3,1,j]=dx[4,3,1,j]-RateSwitchDTG[2,3,1,j]*x[4,3,1,j]\n      dx[4,4,1,j]=dx[4,4,1,j]-RateSwitchDTG[2,4,1,j]*x[4,4,1,j]\n      \n      dx[5,1,1,j]=dx[5,1,1,j]-RateSwitchDTG[3,1,1,j]*x[5,1,1,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateSwitchDTG[3,2,1,j]*x[5,2,1,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateSwitchDTG[3,3,1,j]*x[5,3,1,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateSwitchDTG[3,4,1,j]*x[5,4,1,j]\n      \n      #NNRTI resistant\n      dx[3,1,2,j]=dx[3,1,2,j]-RateSwitchDTG[1,1,2,j]*x[3,1,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]-RateSwitchDTG[1,2,2,j]*x[3,2,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]-RateSwitchDTG[1,3,2,j]*x[3,3,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]-RateSwitchDTG[1,4,2,j]*x[3,4,2,j]\n      \n      dx[4,1,2,j]=dx[4,1,2,j]-RateSwitchDTG[2,1,2,j]*x[4,1,2,j]\n      dx[4,2,2,j]=dx[4,2,2,j]-RateSwitchDTG[2,2,2,j]*x[4,2,2,j]\n      dx[4,3,2,j]=dx[4,3,2,j]-RateSwitchDTG[2,3,2,j]*x[4,3,2,j]\n      dx[4,4,2,j]=dx[4,4,2,j]-RateSwitchDTG[2,4,2,j]*x[4,4,2,j]\n      \n      dx[5,1,2,j]=dx[5,1,2,j]-RateSwitchDTG[3,1,2,j]*x[5,1,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]-RateSwitchDTG[3,2,2,j]*x[5,2,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]-RateSwitchDTG[3,3,2,j]*x[5,3,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]-RateSwitchDTG[3,4,2,j]*x[5,4,2,j]\n      \n      #DTG compartments-------------------------------------\n      #NNRTI susceptible\n      dx[9,1,1,j]=dx[9,1,1,j]+RateTreatFirstDTG[1,1,j]*x[2,1,1,j]+RateSwitchDTG[3,1,1,j]*x[5,1,1,j]+RateSwitchDTG[1,1,1,j]*x[3,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[9,1,1,j]+RateStageTreatFirstL[1]*x[9,2,1,j]\n      dx[10,1,1,j]=RateSuppFirstSusc[1]*x[9,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[10,1,1,j]+RateStageSuppFirst[1]*x[10,2,1,j]+RateSwitchDTG[2,1,1,j]*x[4,1,1,j]\n      dx[11,1,1,j]=RateFailFirstSusc[1]*x[10,1,1,j]-(RateStageFailFirst[1]+mu[5,1,1])*x[11,1,1,j]\n      \n      dx[9,2,1,j]=dx[9,2,1,j]+RateTreatFirstDTG[1,2,j]*x[2,2,1,j]+RateSwitchDTG[3,2,1,j]*x[5,2,1,j]+RateSwitchDTG[1,2,1,j]*x[3,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[9,2,1,j]+RateStageTreatFirstR[1]*x[9,1,1,j]+RateStageTreatFirstL[2]*x[9,3,1,j]\n      dx[10,2,1,j]=RateSuppFirstSusc[2]*x[9,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[10,2,1,j]+RateStageSuppFirst[2]*x[10,3,1,j]+RateSwitchDTG[2,2,1,j]*x[4,2,1,j]\n      dx[11,2,1,j]=RateFailFirstSusc[2]*x[10,2,1,j]-(RateStageFailFirst[2]+mu[5,2,1])*x[11,2,1,j]+RateStageFailFirst[1]*x[11,1,1,j]\n      \n      dx[9,3,1,j]=dx[9,3,1,j]+RateTreatFirstDTG[1,3,j]*x[2,3,1,j]+RateSwitchDTG[3,3,1,j]*x[5,3,1,j]+RateSwitchDTG[1,3,1,j]*x[3,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[9,3,1,j]+RateStageTreatFirstR[2]*x[9,2,1,j]+RateStageTreatFirstL[3]*x[9,4,1,j]\n      dx[10,3,1,j]=RateSuppFirstSusc[3]*x[9,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[10,3,1,j]+RateStageSuppFirst[3]*x[10,4,1,j]+RateSwitchDTG[2,3,1,j]*x[4,3,1,j]\n      dx[11,3,1,j]=RateFailFirstSusc[3]*x[10,3,1,j]-(RateStageFailFirst[3]+mu[5,3,1])*x[11,3,1,j]+RateStageFailFirst[2]*x[11,2,1,j]\n      \n      dx[9,4,1,j]=dx[9,4,1,j]+RateTreatFirstDTG[1,4,j]*x[2,4,1,j]+RateSwitchDTG[3,4,1,j]*x[5,4,1,j]+RateSwitchDTG[1,4,1,j]*x[3,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[9,4,1,j]+RateStageTreatFirstR[3]*x[9,3,1,j]\n      dx[10,4,1,j]=RateSuppFirstSusc[4]*x[9,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[10,4,1,j]+RateSwitchDTG[2,4,1,j]*x[4,4,1,j]\n      dx[11,4,1,j]=RateFailFirstSusc[4]*x[10,4,1,j]-(mu[5,4,1])*x[11,4,1,j]+RateStageFailFirst[3]*x[11,3,1,j]\n      #NNRTI resistant\n      dx[9,1,2,j]=dx[9,1,2,j]+RateTreatFirstDTG[2,1,j]*x[2,1,2,j]+RateSwitchDTG[3,1,2,j]*x[5,1,2,j]+RateSwitchDTG[1,1,2,j]*x[3,1,2,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[9,1,2,j]+RateStageTreatFirstL[1]*x[9,2,2,j]\n      dx[10,1,2,j]=RateSuppFirstSusc[1]*x[9,1,2,j]-(RateFailFirstSusc[1]+mu[4,1,2])*x[10,1,2,j]+RateStageSuppFirst[1]*x[10,2,2,j]+RateSwitchDTG[2,1,2,j]*x[4,1,2,j]\n      dx[11,1,2,j]=RateFailFirstSusc[1]*x[10,1,2,j]-(RateStageFailFirst[1]+mu[5,1,2])*x[11,1,2,j]\n      \n      dx[9,2,2,j]=dx[9,2,2,j]+RateTreatFirstDTG[2,2,j]*x[2,2,2,j]+RateSwitchDTG[3,2,2,j]*x[5,2,2,j]+RateSwitchDTG[1,2,2,j]*x[3,2,2,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[9,2,2,j]+RateStageTreatFirstR[1]*x[9,1,2,j]+RateStageTreatFirstL[2]*x[9,3,2,j]\n      dx[10,2,2,j]=RateSuppFirstSusc[2]*x[9,2,2,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[10,2,2,j]+RateStageSuppFirst[2]*x[10,3,2,j]+RateSwitchDTG[2,2,2,j]*x[4,2,2,j]\n      dx[11,2,2,j]=RateFailFirstSusc[2]*x[10,2,2,j]-(RateStageFailFirst[2]+mu[5,2,2])*x[11,2,2,j]+RateStageFailFirst[1]*x[11,1,2,j]\n      \n      dx[9,3,2,j]=dx[9,3,2,j]+RateTreatFirstDTG[2,3,j]*x[2,3,2,j]+RateSwitchDTG[3,3,2,j]*x[5,3,2,j]+RateSwitchDTG[1,3,2,j]*x[3,3,2,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[9,3,2,j]+RateStageTreatFirstR[2]*x[9,2,2,j]+RateStageTreatFirstL[3]*x[9,4,2,j]\n      dx[10,3,2,j]=RateSuppFirstSusc[3]*x[9,3,2,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[10,3,2,j]+RateStageSuppFirst[3]*x[10,4,2,j]+RateSwitchDTG[2,3,2,j]*x[4,3,2,j]\n      dx[11,3,2,j]=RateFailFirstSusc[3]*x[10,3,2,j]-(RateStageFailFirst[3]+mu[5,3,2])*x[11,3,2,j]+RateStageFailFirst[2]*x[11,2,2,j]\n      \n      dx[9,4,2,j]=dx[9,4,2,j]+RateTreatFirstDTG[2,4,j]*x[2,4,2,j]+RateSwitchDTG[3,4,2,j]*x[5,4,2,j]+RateSwitchDTG[1,4,2,j]*x[3,4,2,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[9,4,2,j]+RateStageTreatFirstR[3]*x[9,3,2,j]\n      dx[10,4,2,j]=RateSuppFirstSusc[4]*x[9,4,2,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[10,4,2,j]+RateSwitchDTG[2,4,2,j]*x[4,4,2,j]\n      dx[11,4,2,j]=RateFailFirstSusc[4]*x[10,4,2,j]-(mu[5,4,2])*x[11,4,2,j]+RateStageFailFirst[3]*x[11,3,2,j]\n      \n      \n      \n      \n      # #DTG compartments-------------------------------------\n      # #NNRTI susceptible\n      # dx[9,1,1,j]=dx[9,1,1,j]+RateTreatFirstDTG[1,1,j]*x[2,1,1,j]+RateSwitchDTG[1,1,1,j]*x[3,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[9,1,1,j]+RateStageTreatFirstL[1]*x[9,2,1,j]\n      # dx[10,1,1,j]=RateSwitchDTG[2,1,1,j]*x[4,1,1,j]+RateSuppFirstSusc[1]*x[9,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[10,1,1,j]+RateStageSuppFirst[1]*x[10,2,1,j]\n      # dx[11,1,1,j]=RateSwitchDTG[3,1,1,j]*x[5,1,1,j]+RateFailFirstSusc[1]*x[10,1,1,j]-(RateStageFailFirst[1]+mu[5,1,1])*x[11,1,1,j]\n      # \n      # dx[9,2,1,j]=dx[9,2,1,j]+RateTreatFirstDTG[1,2,j]*x[2,2,1,j]+RateSwitchDTG[1,2,1,j]*x[3,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[9,2,1,j]+RateStageTreatFirstR[1]*x[9,1,1,j]+RateStageTreatFirstL[2]*x[9,3,1,j]\n      # dx[10,2,1,j]=RateSwitchDTG[2,2,1,j]*x[4,2,1,j]+RateSuppFirstSusc[2]*x[9,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[10,2,1,j]+RateStageSuppFirst[2]*x[10,3,1,j]\n      # dx[11,2,1,j]=RateSwitchDTG[3,2,1,j]*x[5,2,1,j]+RateFailFirstSusc[2]*x[10,2,1,j]-(RateStageFailFirst[2]+mu[5,2,1])*x[11,2,1,j]+RateStageFailFirst[1]*x[11,1,1,j]\n      # \n      # dx[9,3,1,j]=dx[9,3,1,j]+RateTreatFirstDTG[1,3,j]*x[2,3,1,j]+RateSwitchDTG[1,3,1,j]*x[3,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[9,3,1,j]+RateStageTreatFirstR[2]*x[9,2,1,j]+RateStageTreatFirstL[3]*x[9,4,1,j]\n      # dx[10,3,1,j]=RateSwitchDTG[2,3,1,j]*x[4,3,1,j]+RateSuppFirstSusc[3]*x[9,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[10,3,1,j]+RateStageSuppFirst[3]*x[10,4,1,j]\n      # dx[11,3,1,j]=RateSwitchDTG[3,3,1,j]*x[5,3,1,j]+RateFailFirstSusc[3]*x[10,3,1,j]-(RateStageFailFirst[3]+mu[5,3,1])*x[11,3,1,j]+RateStageFailFirst[2]*x[11,2,1,j]\n      # \n      # dx[9,4,1,j]=dx[9,4,1,j]+RateTreatFirstDTG[1,4,j]*x[2,4,1,j]+RateSwitchDTG[1,4,1,j]*x[3,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[9,4,1,j]+RateStageTreatFirstR[3]*x[9,3,1,j]\n      # dx[10,4,1,j]=RateSwitchDTG[2,4,1,j]*x[4,4,1,j]+RateSuppFirstSusc[4]*x[9,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[10,4,1,j]\n      # dx[11,4,1,j]=RateSwitchDTG[3,4,1,j]*x[5,4,1,j]+RateFailFirstSusc[4]*x[10,4,1,j]-(mu[5,4,1])*x[11,4,1,j]+RateStageFailFirst[3]*x[11,3,1,j]\n      # ##############################################################################################################################################################\n      \n      dx[9,1,1,j]=dx[9,1,1,j]-RateStopTreatFirst[1]*x[9,1,1,j]-RateTreatToFailFirstSusc[1]*x[9,1,1,j]\n      dx[10,1,1,j]=dx[10,1,1,j]-RateStopSuppFirst[1]*x[10,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[11,1,1,j]\n      dx[11,1,1,j]=dx[11,1,1,j]-RateStopFailFirst[1]*x[11,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[11,1,1,j]+RateTreatToFailFirstSusc[1]*x[9,1,1,j]\n      \n      dx[9,2,1,j]=dx[9,2,1,j]-RateStopTreatFirst[2]*x[9,2,1,j]-RateTreatToFailFirstSusc[2]*x[9,2,1,j]\n      dx[10,2,1,j]=dx[10,2,1,j]-RateStopSuppFirst[2]*x[10,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[11,2,1,j]-RateSuppFirstToSecond[2]*x[10,2,1,j]\n      dx[11,2,1,j]=dx[11,2,1,j]-RateStopFailFirst[2]*x[11,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[11,2,1,j]+RateTreatToFailFirstSusc[2]*x[9,2,1,j]\n      \n      dx[9,3,1,j]=dx[9,3,1,j]-RateStopTreatFirst[3]*x[9,3,1,j]-RateTreatToFailFirstSusc[3]*x[9,3,1,j]\n      dx[10,3,1,j]=dx[10,3,1,j]-RateStopSuppFirst[3]*x[10,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[11,3,1,j]\n      dx[11,3,1,j]=dx[11,3,1,j]-RateStopFailFirst[3]*x[11,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[11,3,1,j]+RateTreatToFailFirstSusc[3]*x[9,3,1,j]\n      \n      dx[9,4,1,j]=dx[9,4,1,j]-RateStopTreatFirst[4]*x[9,4,1,j]-RateTreatToFailFirstSusc[4]*x[9,4,1,j]\n      dx[10,4,1,j]=dx[10,4,1,j]-RateStopSuppFirst[4]*x[10,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[11,4,1,j]\n      dx[11,4,1,j]=dx[11,4,1,j]-RateStopFailFirst[4]*x[11,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[11,4,1,j]+RateTreatToFailFirstSusc[4]*x[9,4,1,j]\n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      #NNRTI resistant\n      # dx[9,1,2,j]=dx[9,1,2,j]+RateTreatFirstDTG[2,1,j]*x[2,1,2,j]+RateSwitchDTG[1,1,2,j]*x[3,1,2,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[9,1,2,j]+RateStageTreatFirstL[1]*x[9,2,2,j]\n      # dx[10,1,2,j]=RateSwitchDTG[2,1,2,j]*x[4,1,2,j]+RateSuppFirstSusc[1]*x[9,1,2,j]-(RateFailFirstSusc[1]+mu[4,1,2])*x[10,1,2,j]+RateStageSuppFirst[1]*x[10,2,2,j]\n      # dx[11,1,2,j]=RateSwitchDTG[3,1,2,j]*x[5,1,2,j]+RateFailFirstSusc[1]*x[10,1,2,j]-(RateStageFailFirst[1]+mu[5,1,2])*x[11,1,2,j]\n      # \n      # dx[9,2,2,j]=dx[9,2,2,j]+RateTreatFirstDTG[2,2,j]*x[2,2,2,j]+RateSwitchDTG[1,2,2,j]*x[3,2,2,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[9,2,2,j]+RateStageTreatFirstR[1]*x[9,1,2,j]+RateStageTreatFirstL[2]*x[9,3,2,j]\n      # dx[10,2,2,j]=RateSwitchDTG[2,2,2,j]*x[4,2,2,j]+RateSuppFirstSusc[2]*x[9,2,2,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[10,2,2,j]+RateStageSuppFirst[2]*x[10,3,2,j]\n      # dx[11,2,2,j]=RateSwitchDTG[3,2,2,j]*x[5,2,2,j]+RateFailFirstSusc[2]*x[10,2,2,j]-(RateStageFailFirst[2]+mu[5,2,2])*x[11,2,2,j]+RateStageFailFirst[1]*x[11,1,2,j]\n      # \n      # dx[9,3,2,j]=dx[9,3,2,j]+RateTreatFirstDTG[2,3,j]*x[2,3,2,j]+RateSwitchDTG[1,3,2,j]*x[3,3,2,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[9,3,2,j]+RateStageTreatFirstR[2]*x[9,2,2,j]+RateStageTreatFirstL[3]*x[9,4,2,j]\n      # dx[10,3,2,j]=RateSwitchDTG[2,3,2,j]*x[4,3,2,j]+RateSuppFirstSusc[3]*x[9,3,2,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[10,3,2,j]+RateStageSuppFirst[3]*x[10,4,2,j]\n      # dx[11,3,2,j]=RateSwitchDTG[3,3,2,j]*x[5,3,2,j]+RateFailFirstSusc[3]*x[10,3,2,j]-(RateStageFailFirst[3]+mu[5,3,2])*x[11,3,2,j]+RateStageFailFirst[2]*x[11,2,2,j]\n      # \n      # dx[9,4,2,j]=dx[9,4,2,j]+RateTreatFirstDTG[2,4,j]*x[2,4,2,j]+RateSwitchDTG[1,4,2,j]*x[3,4,2,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[9,4,2,j]+RateStageTreatFirstR[3]*x[9,3,2,j]\n      # dx[10,4,2,j]=RateSwitchDTG[2,4,2,j]*x[4,4,2,j]+RateSuppFirstSusc[4]*x[9,4,2,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[10,4,2,j]\n      # dx[11,4,2,j]=RateSwitchDTG[3,4,2,j]*x[5,4,2,j]+RateFailFirstSusc[4]*x[10,4,2,j]-(mu[5,4,2])*x[11,4,2,j]+RateStageFailFirst[3]*x[11,3,2,j]\n      ##############################################################################################################################################################\n      \n      dx[9,1,2,j]=dx[9,1,2,j]-RateStopTreatFirst[1]*x[9,1,2,j]-RateTreatToFailFirstSusc[1]*x[9,1,2,j]\n      dx[10,1,2,j]=dx[10,1,2,j]-RateStopSuppFirst[1]*x[10,1,2,j]+RateFailToSuppTreatFirstSusc[1]*x[11,1,2,j]\n      dx[11,1,2,j]=dx[11,1,2,j]-RateStopFailFirst[1]*x[11,1,2,j]-RateFailToSuppTreatFirstSusc[1]*x[11,1,2,j]+RateTreatToFailFirstSusc[1]*x[9,1,2,j]\n      \n      dx[9,2,2,j]=dx[9,2,2,j]-RateStopTreatFirst[2]*x[9,2,2,j]-RateTreatToFailFirstSusc[2]*x[9,2,2,j]\n      dx[10,2,2,j]=dx[10,2,2,j]-RateStopSuppFirst[2]*x[10,2,2,j]+RateFailToSuppTreatFirstSusc[2]*x[11,2,2,j]\n      dx[11,2,2,j]=dx[11,2,2,j]-RateStopFailFirst[2]*x[11,2,2,j]-RateFailToSuppTreatFirstSusc[2]*x[11,2,2,j]+RateTreatToFailFirstSusc[2]*x[9,2,2,j]\n      \n      dx[9,3,2,j]=dx[9,3,2,j]-RateStopTreatFirst[3]*x[9,3,2,j]-RateTreatToFailFirstSusc[3]*x[9,3,2,j]\n      dx[10,3,2,j]=dx[10,3,2,j]-RateStopSuppFirst[3]*x[10,3,2,j]+RateFailToSuppTreatFirstSusc[3]*x[11,3,2,j]\n      dx[11,3,2,j]=dx[11,3,2,j]-RateStopFailFirst[3]*x[11,3,2,j]-RateFailToSuppTreatFirstSusc[3]*x[11,3,2,j]+RateTreatToFailFirstSusc[3]*x[9,3,2,j]\n      \n      dx[9,4,2,j]=dx[9,4,2,j]-RateStopTreatFirst[4]*x[9,4,2,j]-RateTreatToFailFirstSusc[4]*x[9,4,2,j]\n      dx[10,4,2,j]=dx[10,4,2,j]-RateStopSuppFirst[4]*x[10,4,2,j]+RateFailToSuppTreatFirstSusc[4]*x[11,4,2,j]\n      dx[11,4,2,j]=dx[11,4,2,j]-RateStopFailFirst[4]*x[11,4,2,j]-RateFailToSuppTreatFirstSusc[4]*x[11,4,2,j]+RateTreatToFailFirstSusc[4]*x[9,4,2,j]\n    }\n    dx[x+dx<0]=0\n    #new_infections\n    new_inf=S[1]/N[1]*(sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,1:2,1:2],c(1,3),sum))+\n                         sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8,9,11),1:4,1:2,1:2],c(2,4),sum)))+\n      S[2]/N[2]*(sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,1:2,1:2],c(1,3),sum))+\n                   sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8,9,11),1:4,1:2,1:2],c(2,4),sum)))\n    #death\n    death=sum(apply(x[1:8,1:4,1:2,1:2],c(1,2,3),sum)*mu)+sum(apply(x[9:11,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    \n    #new_infections resistant\n    new_inf_res=S[1]/N[1]*(sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+\n                             sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8,9,11),1:4,2,1:2],c(2,3),sum)))+\n      S[2]/N[2]*(sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+\n                   sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8,9,11),1:4,2,1:2],c(2,3),sum)))\n    \n    n1=S[1]/N[1]*sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))#susc inf\n    n2=S[1]/N[1]*sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8,9,11),1:4,2,1:2],c(2,3),sum))#susc diag\n    n3=S[2]/N[2]*sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))#res inf\n    n4=S[2]/N[2]*sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8,9,11),1:4,2,1:2],c(2,3),sum))#res diag\n    #death resistant\n    death_res=sum(apply(x[1:8,1:4,2,1:2],c(1,2),sum)*mu[1:8,1:4,2])\n    \n    #new treated\n    new_treat=sum(RateTreatFirst[1:2,1:4,1:2]*aperm(x[2,1:4,1:2,1:2],c(2,1,3)))+\n      sum(RateDirectTreatSecond[1:2,1:4]*aperm(apply(x[2,1:4,1:2,1:2],c(1,2),sum),c(2,1)))\n    #new treated resistant\n    new_treat_res=sum(RateTreatFirst[2,1:4,1:2]*x[2,1:4,2,1:2])+\n      sum(RateDirectTreatSecond[2,1:4]*apply(x[2,1:4,2,1:2],c(1),sum))\n    \n    # new_treat_susc=sum(RateTreatFirstDTG[1,1:4,1:2]*x[2,1:4,1,1:2])\n    # new_treat_res=sum(RateTreatFirstDTG[2,1:4,1:2]*x[2,1:4,2,1:2])\n    # new_diag_susc=sum(RateDiag[1:4]*apply(x[1,1:4,1,1:2],1,sum))\n    # new_diag_res=sum(RateDiag[1:4]*apply(x[1,1:4,2,1:2],1,sum))\n    # #new_diag_susc=sum(x[2,1:4,1,1:2])\n    # #new_diag_res=sum(x[2,1:4,2,1:2])\n    # mort_susc=sum(mu[2,1:4,1]*apply(x[2,1:4,1,1:2],1,sum))\n    # mort_res=sum(mu[2,1:4,2]*apply(x[2,1:4,2,1:2],1,sum))\n    \n    #dx[3:8,1:4,1,1:2]=dx[3:8,1:4,1,1:2]+infected_m15_month[t+1]*x[3:8,1:4,1,1:2]/sum(x[3:8,1:4,1,1:2])\n    ####################################################################################################################\n    res=c(dx,new_inf,death,new_treat,new_inf_res,death_res,new_treat_res)\n    #res=c(dx,new_inf,new_inf_res,n1,n2,n3,n4)\n    #res=c(dx,new_treat_susc,new_treat_res,new_diag_susc,new_diag_res,mort_susc,mort_res)\n    return(c(res))\n    #return(list(c(res,newinf,newsu,newres,death)))\n    #})\n  })\n}\nxstart_f_dtg=function(par){\n  k1=par[9]\n  k2=par[10]\n  k3=par[11]\n  start_treat=107\n  start_value=array(0,dim=c(11,4,2,2))\n  start_value[1,1:4,1,1:2]=c(apply(undiag_value,1,sum)[1]*0.42*repart_f(k1),apply(undiag_value,1,sum)[1]*0.58*repart_f(k1))\n  start_value[2,1:4,1,1:2]=c((apply(diag_value,1,sum)[1]-start_treat)*0.42*repart_f(k2),(apply(diag_value,1,sum)[1]-start_treat)*0.58*repart_f(k2))\n  start_value[3,1:4,1,1:2]=c(start_treat*0.42*repart_f(k3),start_treat*0.58*repart_f(k3))\n  # start_value[4,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0.45\n  # start_value[5,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0.15\n  # start_value[3,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0.4\n  \n  start_value[4,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0\n  start_value[5,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0\n  start_value[3,1:4,1,1:2]=start_value[3,1:4,1,1:2]*1\n  \n  start_value[1:2,1:4,2,1:2]=array(rep(rep(c(0.01,0.01,0.01,0.01),each=2),2),dim=c(2,4,2))*start_value[1:2,1:4,1,1:2]\n  start_value[1:2,1:4,1,1:2]=array(rep(rep(1-c(0.01,0.01,0.01,0.01),each=2),2),dim=c(2,4,2))*start_value[1:2,1:4,1,1:2]\n  start_value[3,1:4,2,1:2]=0.01*start_value[3,1:4,1,1:2]\n  start_value[3,1:4,1,1:2]=0.99*start_value[3,1:4,1,1:2]\n  start_value[4,1:4,2,1:2]=0.01*start_value[4,1:4,1,1:2]\n  start_value[4,1:4,1,1:2]=0.99*start_value[4,1:4,1,1:2]\n  start_value[5,1:4,2,1:2]=0.7*start_value[5,1:4,1,1:2]\n  start_value[5,1:4,1,1:2]=0.3*start_value[5,1:4,1,1:2]\n  xstart=c(start_value,rep(0,6))\n  return(xstart)\n}\n\n#15 care stages, not more used, see below\nmod_cpp_dtg_2=function(t,x,p1,treat_dtg){\n  #mod =function(t,x, params){\n  with(as.list(params), {\n    x=x[1:(240)] # 15*4*2*2=240\n    ##################################################################################################################\n    #Optimization\n    rate1_inf <- p1[1] #number of unprotected sexual acts/month\n    rate2_inf <- p1[2]\n    rate1_diag <- p1[3] #diagnosis rate\n    rate2_diag <- p1[4] #diagnosis rate\n    rate_treat <- p1[5] #scale parameter for overall treatment rate\n    rate_death <- p1[6] #scale parameter for overall death\n    q <- p2[7]\n    #Range\n    rate_ratio <- p2[8] #varying parameter to estimate death for treated (but neither suppressed nor failed)\n    \n    alpha <- p2[12] #ratio between outcome when resistant/sensitive\n    rate_res <- p2[13] #resistant rate\n    rate_susc <- p2[14] #reversion rate\n    \n    #1. Infection and Diagnosis\n    RateInf1=array(rep(RateTransm,each=4),dim=c(4,2,2))*rate1_inf\n    RateInf2=RateInf1*rate2_inf\n    \n    Diag_frame[,4]=Diag_frame[,4]*rate2_diag\n    RateDiag=1/rate1_diag*apply(Diag_frame,1,function(x) smooth_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))\n    \n    RateDiag=array(rep(RateDiag,2)*rep(c(1,diag_women),each=4),dim=c(4,2))+\n      array(rep(oi_inc,2)*rep(smooth_st(2005+t/12,oi_test[\"a\"],oi_test[\"b\"],oi_test[\"c\"],oi_test[\"d\"]),8),dim=c(4,2))+\n      array(c(rep(0,4),preg_inc)*rep(smooth_st(2005+t/12,preg_test[\"a\"],preg_test[\"b\"],preg_test[\"c\"],preg_test[\"d\"]),8),dim=c(4,2))\n    \n    #2. Treatment theoretical (if no counterfactual scenario)\n    RateTreatFirst_th=apply(Treat_frame,1,function(x) smooth_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*smooth_st(2005+t/12,2001,2012,1,200/12)*rate_treat\n    \n    RateTreatFirst_f=function(y){\n      if(y<2005){\n        return(apply(Treat_frame_original,1,function(x) smooth_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*smooth_st(y,2001,2012,1,200/12)*rate_treat)\n      }else{\n        return(apply(\n          data.frame(t1=apply(Treat_frame,1,function(x) lin_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"])),\n                     t2=apply(Treat_frame2,1,function(x) lin_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*as.numeric(y>Treat_frame2$a[4])),\n          1,max)*smooth_st(y,2001,2012,1,200/12)*rate_treat)\n      }\n    }\n    RateTreatFirst_th=RateTreatFirst_f(2005+t/12)\n    \n    RateDirectTreatSecond_th=RateDirectTreatSecond\n    \n    #now\n    RateTreatFirst=matrix(c(RateTreatFirst_th,RateTreatFirst_th),nrow=2,ncol=4,byrow=T)\n    RateDirectTreatSecond=matrix(c(RateDirectTreatSecond_th,RateDirectTreatSecond_th),nrow=2,ncol=4,byrow=T)\n    \n    #Resistance testing at baseline\n    #RateTreatFirst=matrix(c(RateTreatFirst_th,c(0,0,0,0)),nrow=2,ncol=4,byrow=T)\n    #RateDirectTreatSecond=matrix(c(RateDirectTreatSecond_th,RateTreatFirst_th+RateDirectTreatSecond_th),nrow=2,ncol=4,byrow=T)\n    #RateTreatFirst=ep(rate_treat,4)\n    \n    #2. Treatment DTG\n    #percentage of women eligible for dtg\n    if(treat_dtg[1]!=treat_dtg[2] & treat_dtg[2]!=0){print(\"percentage of women eligible for dtg not equal for FirstTreat and Switch.\")}\n    p_women_dtg=treat_dtg[1]\n    #RateTreatFirstDTG[res,cd4,gender]\n    RateTreatFirstDTG=array(rep(RateTreatFirst*treat_dtg[3],2)*rep(c(1,1),each=8),dim=c(2,4,2))*\n      smooth_st(2005+t/12,2018,2018+treat_dtg[\"delay_first\"],0,1) #delay\n    #RateSwitchDTG[care,cd4,res,gender]\n    #All people switch at a rate equal to RateTreatSecond\n    RateSwitchDTG=array(rep(rep(treat_dtg[4]*RateTreatSecond,each=3)*rep(c(treat_dtg[5],treat_dtg[6],treat_dtg[7]),4),4),dim=c(3,4,2,2))*\n      smooth_st(2005+t/12,2018,2018+treat_dtg[\"delay_switch\"],0,1) #delay\n    # RateSwitchDTG=array(rep(rep(treat_dtg[4]*rep(1/12,4),each=3)*rep(c(treat_dtg[5],treat_dtg[6],treat_dtg[7]),4),4),dim=c(3,4,2,2))*\n    #    smooth_st(2005+t/12,2018,2018+treat_dtg[\"delay_switch\"],0,1) #delay\n    #Treated and suppressed people switch at a rate equal to 1year^-1, failed people at a rate still equal to RateTreatSecond\n    RateSwitchDTG[1:2,1:4,1:2,1:2]=rep(treat_dtg[4],32)*rep(rep(1/12,2)*c(treat_dtg[5],treat_dtg[6]),16)*\n      smooth_st(2005+t/12,2018,2018+treat_dtg[\"delay_switch\"],0,1) #delay\n    #RateTreatFirst [res,cd4,gender]\n    RateTreatFirst_noDTG=array(rep(RateTreatFirst,2),dim=c(2,4,2))\n    RateTreatFirst=apply(RateTreatFirst_noDTG-RateTreatFirstDTG,c(1,2,3),function(x) max(x,0))\n    \n    #RateTreatSecond[CD4,gender]\n    RateTreatSecond_noDTG=array(rep(RateTreatSecond,2),dim=c(4,2))\n    # if(2005+t/12<2018){RateTreatSecond_noDTG=array(rep(RateTreatSecond,2),dim=c(4,2))\n    # }else{RateTreatSecond_noDTG=array(rep(1/12,8),dim=c(4,2))}\n    RateTreatSecond=apply(RateTreatSecond_noDTG-apply(RateSwitchDTG[3,1:4,1:2,1:2],c(1,3),mean),c(1,2),function(x) max(x,0))\n    #we take the mean here as RateTreatSecond is the same for men and women.\n    #It has not any impact as long as RateSwitchDTG is also the same for men and women.\n    \n    # RateTreatFirst=matrix(rep(0,8),nrow=2,ncol=4,byrow=T)\n    # RateDirectTreatSecond=matrix(rep(0,8),nrow=2,ncol=4,byrow=T)\n    #3. Death\n    #p1=p1_f(t,q)\n    #p1=min(1,q*mean(sapply(2005+seq(t-36,t,1)/12,function(x) apply(Treat_frame[4,],1,function(y) smooth_st(x,y[\"a\"],y[\"b\"],y[\"c\"],y[\"d\"]))*smooth_st(x,2001,2012,1,200/12))))\n    p1=min(1,q*mean(sapply(2005+seq(t-36,t,1)/12,function(x) RateTreatFirst_f(x)[4]/rate_treat)))\n    print(p1)\n    #p1=p1/2+0.2\n    mu[1:2,4,1]=p1*40.9+(1-p1)*134.4\n    mu[4,4,1]=p1*8.3+(1-p1)*41.7\n    mu[5,4,1]=p1*11.8+(1-p1)*59.7\n    mu[3,1:4,1]=rate_ratio*mu[4,1:4,1]+(1-rate_ratio)*mu[5,1:4,1]\n    mu[6:8,1:4,1]=mu[3:5,1:4,1]\n    mu[1:8,1:4,2]=mu[1:8,1:4,1]\n    mu=mu*rate_death/1000\n    print(p1*40.9+(1-p1)*134.4)\n    print(mu)\n    #Back and forth mutation and impact on treatment outcome\n    RateResistant=1/rate_res\n    RateSusceptible=1/rate_susc\n    #From T to S\n    RateSuppFirstSusc=RateSuppFirst/1\n    RateSuppFirstResis=1/alpha*RateSuppFirst/1\n    #From S to F\n    RateFailFirstSusc=RateFailFirst*1\n    RateFailFirstResis=alpha*RateFailFirst*1\n    #From T to F\n    RateTreatToFailFirstSusc=RateTreatToFailFirst*1\n    RateTreatToFailFirstResis=alpha*RateTreatToFailFirst*1\n    #From F to S\n    RateFailToSuppTreatFirstSusc=RateFailToSuppTreatFirst/1\n    RateFailToSuppTreatFirstResis=1/alpha*RateFailToSuppTreatFirst/1\n    \n    #For second-line regimen, no effect of NNRTI resistance on treatment as it is PI\n    ##################################################################################################################\n    dx=array(0,dim=c(15,4,2,2))\n    x=array(x,dim=c(15,4,2,2))\n    I=apply(x,4,sum)\n    \n    #First approach to model S: S=N-I\n    N=N_value_f(t+1)\n    S=N-I\n    #Percentage getting NNRTI-based 1st-line[gender]\n    p_NNRTI=sum(RateTreatFirst)/sum(RateTreatFirst+RateTreatFirstDTG)*c(1,treat_dtg[1])+c(0,1-treat_dtg[1])\n    #infected and treated children\n    I_m15=rep(infected_m15_f(t)/2,2) #number of infected children reaching 15 years old at a given month\n    t_m15=rep(treat_m15_f(t)/2,2)\n    \n    # dx[2,1:4,1,1:2]=rep((1-res_m15)*I_m15/4,each=4)\n    # dx[2,1:4,2,1:2]=rep(res_m15*I_m15/4,each=4)\n    # dx[3,1:4,1,1]=rep((1-res_m15)*t_m15[1]*p_NNRTI[1]/4,each=4)\n    # dx[3,1:4,2,1]=rep(res_m15*t_m15[1]*p_NNRTI[1]/4,each=4)\n    # dx[13,1:4,1,2]=rep((1-res_m15)*t_m15[2]*p_NNRTI[2]/4,each=4)\n    # dx[13,1:4,2,2]=rep(res_m15*t_m15[2]*p_NNRTI[2]/4,each=4)\n    # dx[9,1:4,1,1:2]=rep((1-res_m15)*t_m15*(1-p_NNRTI)/4,each=4)\n    # dx[9,1:4,2,1:2]=rep(res_m15*t_m15*(1-p_NNRTI)/4,each=4)\n    \n    # if(t>1){\n    #   print(\"RateTreatFirst\")\n    #   print(RateTreatFirst)\n    #   print(\"RateTreatSecond\")\n    #   print(RateTreatSecond)\n    #   print(\"RateDirectTreatSecond\")\n    #   print(RateDirectTreatSecond)\n    #   print(\"RateTreatSecond_noDTG\")\n    #   print(RateTreatSecond_noDTG)\n    #   print(\"RateSwitchDTG\")\n    #   print(RateSwitchDTG)\n    #   print(\"RateTreatFirstDTG\")\n    #   print(RateTreatFirstDTG)\n    #   print(\"RateDiag\")\n    #   print(RateDiag)\n    # }\n    \n    for(j in 1:2){\n      #dx[x1,x2,x3,x4] x1:care stages x2:disease progression x3:resistance x4:gender\n      #dx with only interaction with the neighbours in the compartmental model\n      dx[1,1,1,j]=S[j]/N[j]*(sum(RateInf1[1:4,1:2,j]*apply(x[c(1),1:4,1,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,j]*apply(x[c(2,3,5,6,8,9,11,12,13,15),1:4,1,1:2],c(2,3),sum)))-\n        (RateStageInf[1]+RateDiag[1,j]+mu[1,1,1])*x[1,1,1,j]\n      dx[2,1,1,j]=dx[2,1,1,j]+RateDiag[1,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,1,1,j]-(RateTreatFirst[1,1,j]+RateStageDiag[1]+mu[2,1,1])*x[2,1,1,j]\n      dx[3,1,1,j]=dx[3,1,1,j]+RateTreatFirst[1,1,j]*x[2,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[3,1,1,j]+RateStageTreatFirstL[1]*x[3,2,1,j]\n      dx[4,1,1,j]=RateSuppFirstSusc[1]*x[3,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[4,1,1,j]+RateStageSuppFirst[1]*x[4,2,1,j]\n      dx[5,1,1,j]=RateFailFirstSusc[1]*x[4,1,1,j]-(RateTreatSecond[1,j]+RateStageFailFirst[1]+mu[5,1,1])*x[5,1,1,j]\n      dx[6,1,1,j]=RateTreatSecond_noDTG[1,j]*x[11,1,1,j]+RateTreatSecond_noDTG[1,j]*x[15,1,1,j]+RateTreatSecond[1,j]*x[5,1,1,j]-(RateSuppSecond[1]+RateStageTreatSecondR[1]+mu[6,1,1])*x[6,1,1,j]+RateStageTreatSecondL[1]*x[6,2,1,j]\n      dx[7,1,1,j]=RateSuppSecond[1]*x[6,1,1,j]-(RateFailSecond[1]+mu[7,1,1])*x[7,1,1,j]+RateStageSuppSecond[1]*x[7,2,1,j]\n      dx[8,1,1,j]=RateFailSecond[1]*x[7,1,1,j]-(RateStageFailSecond[1]+mu[8,1,1])*x[8,1,1,j]\n      \n      dx[1,2,1,j]=-(RateStageInf[2]+RateDiag[2,j]+mu[1,2,1])*x[1,2,1,j]+RateStageInf[1]*x[1,1,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]+RateDiag[2,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,2,1,j]-(RateTreatFirst[1,2,j]+RateStageDiag[2]+mu[2,2,1])*x[2,2,1,j]+RateStageDiag[1]*x[2,1,1,j]\n      dx[3,2,1,j]=dx[3,2,1,j]+RateTreatFirst[1,2,j]*x[2,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[3,2,1,j]+RateStageTreatFirstR[1]*x[3,1,1,j]+RateStageTreatFirstL[2]*x[3,3,1,j]\n      dx[4,2,1,j]=RateSuppFirstSusc[2]*x[3,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[4,2,1,j]+RateStageSuppFirst[2]*x[4,3,1,j]\n      dx[5,2,1,j]=RateFailFirstSusc[2]*x[4,2,1,j]-(RateTreatSecond[2,j]+RateStageFailFirst[2]+mu[5,2,1])*x[5,2,1,j]+RateStageFailFirst[1]*x[5,1,1,j]\n      dx[6,2,1,j]=RateTreatSecond_noDTG[2,j]*x[11,2,1,j]+RateTreatSecond_noDTG[2,j]*x[15,2,1,j]+RateTreatSecond[2,j]*x[5,2,1,j]-(RateSuppSecond[2]+RateStageTreatSecondR[2]+RateStageTreatSecondL[1]+mu[6,2,1])*x[6,2,1,j]+RateStageTreatSecondR[1]*x[6,1,1,j]+RateStageTreatSecondL[2]*x[6,3,1,j]\n      dx[7,2,1,j]=RateSuppSecond[2]*x[6,2,1,j]-(RateFailSecond[2]+RateStageSuppSecond[1]+mu[7,2,1])*x[7,2,1,j]+RateStageSuppSecond[2]*x[7,3,1,j]\n      dx[8,2,1,j]=RateFailSecond[2]*x[7,2,1,j]-(RateStageFailSecond[2]+mu[8,2,1])*x[8,2,1,j]+RateStageFailSecond[1]*x[8,1,1,j]\n      \n      dx[1,3,1,j]=-(RateStageInf[3]+RateDiag[3,j]+mu[1,3,1])*x[1,3,1,j]+RateStageInf[2]*x[1,2,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]+RateDiag[3,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,3,1,j]-(RateTreatFirst[1,3,j]+RateStageDiag[3]+mu[2,3,1])*x[2,3,1,j]+RateStageDiag[2]*x[2,2,1,j]\n      dx[3,3,1,j]=dx[3,3,1,j]+RateTreatFirst[1,3,j]*x[2,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[3,3,1,j]+RateStageTreatFirstR[2]*x[3,2,1,j]+RateStageTreatFirstL[3]*x[3,4,1,j]\n      dx[4,3,1,j]=RateSuppFirstSusc[3]*x[3,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[4,3,1,j]+RateStageSuppFirst[3]*x[4,4,1,j]\n      dx[5,3,1,j]=RateFailFirstSusc[3]*x[4,3,1,j]-(RateTreatSecond[3,j]+RateStageFailFirst[3]+mu[5,3,1])*x[5,3,1,j]+RateStageFailFirst[2]*x[5,2,1,j]\n      dx[6,3,1,j]=RateTreatSecond_noDTG[3,j]*x[11,3,1,j]+RateTreatSecond_noDTG[3,j]*x[15,3,1,j]+RateTreatSecond[3,j]*x[5,3,1,j]-(RateSuppSecond[3]+RateStageTreatSecondR[3]+RateStageTreatSecondL[2]+mu[6,3,1])*x[6,3,1,j]+RateStageTreatSecondR[2]*x[6,2,1,j]+RateStageTreatSecondL[3]*x[6,4,1,j]\n      dx[7,3,1,j]=RateSuppSecond[3]*x[6,3,1,j]-(RateFailSecond[3]+RateStageSuppSecond[2]+mu[7,3,1])*x[7,3,1,j]+RateStageSuppSecond[3]*x[7,4,1,j]\n      dx[8,3,1,j]=RateFailSecond[3]*x[7,3,1,j]-(RateStageFailSecond[3]+mu[8,3,1])*x[8,3,1,j]+RateStageFailSecond[2]*x[8,2,1,j]\n      \n      dx[1,4,1,j]=-(RateDiag[4,j]+mu[1,4,1])*x[1,4,1,j]+RateStageInf[3]*x[1,3,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]+RateDiag[4,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,4,1,j]-(RateTreatFirst[1,4,j]+mu[2,4,1])*x[2,4,1,j]+RateStageDiag[3]*x[2,3,1,j]\n      dx[3,4,1,j]=dx[3,4,1,j]+RateTreatFirst[1,4,j]*x[2,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[3,4,1,j]+RateStageTreatFirstR[3]*x[3,3,1,j]\n      dx[4,4,1,j]=RateSuppFirstSusc[4]*x[3,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[4,4,1,j]\n      dx[5,4,1,j]=RateFailFirstSusc[4]*x[4,4,1,j]-(RateTreatSecond[4,j]+mu[5,4,1])*x[5,4,1,j]+RateStageFailFirst[3]*x[5,3,1,j]\n      dx[6,4,1,j]=RateTreatSecond_noDTG[4,j]*x[11,4,1,j]+RateTreatSecond_noDTG[4,j]*x[15,4,1,j]+RateTreatSecond[4,j]*x[5,4,1,j]-(RateSuppSecond[4]+RateStageTreatSecondL[3]+mu[6,4,1])*x[6,4,1,j]+RateStageTreatSecondR[3]*x[6,3,1,j]\n      dx[7,4,1,j]=RateSuppSecond[4]*x[6,4,1,j]-(RateFailSecond[4]+RateStageSuppSecond[3]+mu[7,4,1])*x[7,4,1,j]\n      dx[8,4,1,j]=RateFailSecond[4]*x[7,4,1,j]-mu[8,4,1 ]*x[8,4,1,j]+RateStageFailSecond[3]*x[8,3,1,j]\n      \n      ##############################################################################################################################################################\n      \n      dx[1,1,1,j]=dx[1,1,1,j]\n      dx[2,1,1,j]=dx[2,1,1,j]-RateDirectTreatSecond[1,1]*x[2,1,1,j]+RateStopTreatFirst[1]*x[3,1,1,j]+RateStopSuppFirst[1]*x[4,1,1,j]+RateStopFailFirst[1]*x[5,1,1,j]+\n        (RateStopTreatSecond[1]*x[6,1,1,j]+RateStopSuppSecond[1]*x[7,1,1,j]+RateStopFailSecond[1]*x[8,1,1,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,1,1,j]=dx[3,1,1,j]-RateStopTreatFirst[1]*x[3,1,1,j]-RateTreatToFailFirstSusc[1]*x[3,1,1,j]\n      dx[4,1,1,j]=dx[4,1,1,j]-RateStopSuppFirst[1]*x[4,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[5,1,1,j]-RateSuppFirstToSecond[1]*x[4,1,1,j]\n      dx[5,1,1,j]=dx[5,1,1,j]-RateStopFailFirst[1]*x[5,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[5,1,1,j]+RateTreatToFailFirstSusc[1]*x[3,1,1,j]\n      dx[6,1,1,j]=dx[6,1,1,j]-RateStopTreatSecond[1]*x[6,1,1,j]+RateDirectTreatSecond[1,1]*x[2,1,1,j]+RateDirectTreatSecond[1,1]*x[12,1,1,j]-RateTreatToFailSecond[1]*x[6,1,1,j]\n      dx[7,1,1,j]=dx[7,1,1,j]-RateStopSuppSecond[1]*x[7,1,1,j]+RateFailToSuppTreatSecond[1]*x[8,1,1,j]+RateSuppFirstToSecond[1]*x[4,1,1,j]\n      dx[8,1,1,j]=dx[8,1,1,j]-RateStopFailSecond[1]*x[8,1,1,j]-RateFailToSuppTreatSecond[1]*x[8,1,1,j]+RateTreatToFailSecond[1]*x[6,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]-RateDirectTreatSecond[1,2]*x[2,2,1,j]+RateStopTreatFirst[2]*x[3,2,1,j]+RateStopSuppFirst[2]*x[4,2,1,j]+RateStopFailFirst[2]*x[5,2,1,j]+\n        (RateStopTreatSecond[2]*x[6,2,1,j]+RateStopSuppSecond[2]*x[7,2,1,j]+RateStopFailSecond[2]*x[8,2,1,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,2,1,j]=dx[3,2,1,j]-RateStopTreatFirst[2]*x[3,2,1,j]-RateTreatToFailFirstSusc[2]*x[3,2,1,j]\n      dx[4,2,1,j]=dx[4,2,1,j]-RateStopSuppFirst[2]*x[4,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[5,2,1,j]-RateSuppFirstToSecond[2]*x[4,2,1,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateStopFailFirst[2]*x[5,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[5,2,1,j]+RateTreatToFailFirstSusc[2]*x[3,2,1,j]\n      dx[6,2,1,j]=dx[6,2,1,j]-RateStopTreatSecond[2]*x[6,2,1,j]+RateDirectTreatSecond[1,2]*x[2,2,1,j]+RateDirectTreatSecond[1,2]*x[12,2,1,j]-RateTreatToFailSecond[2]*x[6,2,1,j]\n      dx[7,2,1,j]=dx[7,2,1,j]-RateStopSuppSecond[2]*x[7,2,1,j]+RateFailToSuppTreatSecond[2]*x[8,2,1,j]+RateSuppFirstToSecond[2]*x[4,2,1,j]\n      dx[8,2,1,j]=dx[8,2,1,j]-RateStopFailSecond[2]*x[8,2,1,j]-RateFailToSuppTreatSecond[2]*x[8,2,1,j]+RateTreatToFailSecond[2]*x[6,2,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]-RateDirectTreatSecond[1,3]*x[2,3,1,j]+RateStopTreatFirst[3]*x[3,3,1,j]+RateStopSuppFirst[3]*x[4,3,1,j]+RateStopFailFirst[3]*x[5,3,1,j]+\n        (RateStopTreatSecond[3]*x[6,3,1,j]+RateStopSuppSecond[3]*x[7,3,1,j]+RateStopFailSecond[3]*x[8,3,1,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,3,1,j]=dx[3,3,1,j]-RateStopTreatFirst[3]*x[3,3,1,j]-RateTreatToFailFirstSusc[3]*x[3,3,1,j]\n      dx[4,3,1,j]=dx[4,3,1,j]-RateStopSuppFirst[3]*x[4,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[5,3,1,j]-RateSuppFirstToSecond[3]*x[4,3,1,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateStopFailFirst[3]*x[5,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[5,3,1,j]+RateTreatToFailFirstSusc[3]*x[3,3,1,j]\n      dx[6,3,1,j]=dx[6,3,1,j]-RateStopTreatSecond[3]*x[6,3,1,j]+RateDirectTreatSecond[1,3]*x[2,3,1,j]+RateDirectTreatSecond[1,3]*x[12,3,1,j]-RateTreatToFailSecond[3]*x[6,3,1,j]\n      dx[7,3,1,j]=dx[7,3,1,j]-RateStopSuppSecond[3]*x[7,3,1,j]+RateFailToSuppTreatSecond[3]*x[8,3,1,j]+RateSuppFirstToSecond[3]*x[4,3,1,j]\n      dx[8,3,1,j]=dx[8,3,1,j]-RateStopFailSecond[3]*x[8,3,1,j]-RateFailToSuppTreatSecond[3]*x[8,3,1,j]+RateTreatToFailSecond[3]*x[6,3,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]-RateDirectTreatSecond[1,4]*x[2,4,1,j]+RateStopTreatFirst[4]*x[3,4,1,j]+RateStopSuppFirst[4]*x[4,4,1,j]+RateStopFailFirst[4]*x[5,4,1,j]+\n        (RateStopTreatSecond[4]*x[6,4,1,j]+RateStopSuppSecond[4]*x[7,4,1,j]+RateStopFailSecond[4]*x[8,4,1,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,4,1,j]=dx[3,4,1,j]-RateStopTreatFirst[4]*x[3,4,1,j]-RateTreatToFailFirstSusc[4]*x[3,4,1,j]\n      dx[4,4,1,j]=dx[4,4,1,j]-RateStopSuppFirst[4]*x[4,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[5,4,1,j]-RateSuppFirstToSecond[4]*x[4,4,1,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateStopFailFirst[4]*x[5,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[5,4,1,j]+RateTreatToFailFirstSusc[4]*x[3,4,1,j]\n      dx[6,4,1,j]=dx[6,4,1,j]-RateStopTreatSecond[4]*x[6,4,1,j]+RateDirectTreatSecond[1,4]*x[2,4,1,j]+RateDirectTreatSecond[1,4]*x[12,4,1,j]-RateTreatToFailSecond[4]*x[6,4,1,j]\n      dx[7,4,1,j]=dx[7,4,1,j]-RateStopSuppSecond[4]*x[7,4,1,j]+RateFailToSuppTreatSecond[4]*x[8,4,1,j]+RateSuppFirstToSecond[4]*x[4,4,1,j]\n      dx[8,4,1,j]=dx[8,4,1,j]-RateStopFailSecond[4]*x[8,4,1,j]-RateFailToSuppTreatSecond[4]*x[8,4,1,j]+RateTreatToFailSecond[4]*x[6,4,1,j]\n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      dx[1,1,2,j]=S[j]/N[j]*(sum(RateInf1[1:4,1:2,j]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,j]*apply(x[c(2,3,5,6,8,9,11,12,13,15),1:4,2,1:2],c(2,3),sum)))-\n        (RateStageInf[1]+RateDiag[1,j]+mu[1,1,2 ])*x[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]+RateDiag[1,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,1,2,j]-(RateTreatFirst[2,1,j]+RateStageDiag[1]+mu[2,1,2])*x[2,1,2,j]\n      dx[3,1,2,j]=dx[3,1,2,j]+RateTreatFirst[2,1,j]*x[2,1,2,j]-(RateSuppFirstResis[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[3,1,2,j]+RateStageTreatFirstL[1]*x[3,2,2,j]\n      dx[4,1,2,j]=RateSuppFirstResis[1]*x[3,1,2,j]-(RateFailFirstResis[1]+mu[4,1,2])*x[4,1,2,j]+RateStageSuppFirst[1]*x[4,2,2,j]\n      dx[5,1,2,j]=RateFailFirstResis[1]*x[4,1,2,j]-(RateTreatSecond[1,j]+RateStageFailFirst[1]+mu[5,1,2 ])*x[5,1,2,j]\n      dx[6,1,2,j]=RateTreatSecond_noDTG[1,j]*x[11,1,2,j]+RateTreatSecond_noDTG[1,j]*x[15,1,2,j]+RateTreatSecond[1,j]*x[5,1,2,j]-(RateSuppSecond[1]+RateStageTreatSecondR[1]+mu[6,1,2])*x[6,1,2,j]+RateStageTreatSecondL[1]*x[6,2,2,j]\n      dx[7,1,2,j]=RateSuppSecond[1]*x[6,1,2,j]-(RateFailSecond[1]+mu[7,1,2])*x[7,1,2,j]+RateStageSuppSecond[1]*x[7,2,2,j]\n      dx[8,1,2,j]=RateFailSecond[1]*x[7,1,2,j]-(RateStageFailSecond[1]+mu[8,1,2])*x[8,1,2,j]\n      \n      dx[1,2,2,j]=-(RateStageInf[2]+RateDiag[2,j]+mu[1,2,2])*x[1,2,2,j]+RateStageInf[1]*x[1,1,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]+RateDiag[2,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,2,2,j]-(RateTreatFirst[2,2,j]+RateStageDiag[2]+mu[2,2,2])*x[2,2,2,j]+RateStageDiag[1]*x[2,1,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]+RateTreatFirst[2,2,j]*x[2,2,2,j]-(RateSuppFirstResis[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[3,2,2,j]+RateStageTreatFirstR[1]*x[3,1,2,j]+RateStageTreatFirstL[2]*x[3,3,2,j]\n      dx[4,2,2,j]=RateSuppFirstResis[2]*x[3,2,2,j]-(RateFailFirstResis[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[4,2,2,j]+RateStageSuppFirst[2]*x[4,3,2,j]\n      dx[5,2,2,j]=RateFailFirstResis[2]*x[4,2,2,j]-(RateTreatSecond[2,j]+RateStageFailFirst[2]+mu[5,2,2])*x[5,2,2,j]+RateStageFailFirst[1]*x[5,1,2,j]\n      dx[6,2,2,j]=RateTreatSecond_noDTG[2,j]*x[11,2,2,j]+RateTreatSecond_noDTG[2,j]*x[15,2,2,j]+RateTreatSecond[2,j]*x[5,2,2,j]-(RateSuppSecond[2]+RateStageTreatSecondR[2]+RateStageTreatSecondL[1]+mu[6,2,2])*x[6,2,2,j]+RateStageTreatSecondR[1]*x[6,1,2,j]+RateStageTreatSecondL[2]*x[6,3,2,j]\n      dx[7,2,2,j]=RateSuppSecond[2]*x[6,2,2,j]-(RateFailSecond[2]+RateStageSuppSecond[1]+mu[7,2,2])*x[7,2,2,j]+RateStageSuppSecond[2]*x[7,3,2,j]\n      dx[8,2,2,j]=RateFailSecond[2]*x[7,2,2,j]-(RateStageFailSecond[2]+mu[8,2,2])*x[8,2,2,j]+RateStageFailSecond[1]*x[8,1,2,j]\n      \n      dx[1,3,2,j]=-(RateStageInf[3]+RateDiag[3,j]+mu[1,3,2])*x[1,3,2,j]+RateStageInf[2]*x[1,2,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]+RateDiag[3,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,3,2,j]-(RateTreatFirst[2,3,j]+RateStageDiag[3]+mu[2,3,2])*x[2,3,2,j]+RateStageDiag[2]*x[2,2,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]+RateTreatFirst[2,3,j]*x[2,3,2,j]-(RateSuppFirstResis[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[3,3,2,j]+RateStageTreatFirstR[2]*x[3,2,2,j]+RateStageTreatFirstL[3]*x[3,4,2,j]\n      dx[4,3,2,j]=RateSuppFirstResis[3]*x[3,3,2,j]-(RateFailFirstResis[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[4,3,2,j]+RateStageSuppFirst[3]*x[4,4,2,j]\n      dx[5,3,2,j]=RateFailFirstResis[3]*x[4,3,2,j]-(RateTreatSecond[3,j]+RateStageFailFirst[3]+mu[5,3,2])*x[5,3,2,j]+RateStageFailFirst[2]*x[5,2,2,j]\n      dx[6,3,2,j]=RateTreatSecond_noDTG[3,j]*x[11,3,2,j]+RateTreatSecond_noDTG[3,j]*x[15,3,2,j]+RateTreatSecond[3,j]*x[5,3,2,j]-(RateSuppSecond[3]+RateStageTreatSecondR[3]+RateStageTreatSecondL[2]+mu[6,3,2])*x[6,3,2,j]+RateStageTreatSecondR[2]*x[6,2,2,j]+RateStageTreatSecondL[3]*x[6,4,2,j]\n      dx[7,3,2,j]=RateSuppSecond[3]*x[6,3,2,j]-(RateFailSecond[3]+RateStageSuppSecond[2]+mu[7,3,2])*x[7,3,2,j]+RateStageSuppSecond[3]*x[7,4,2,j]\n      dx[8,3,2,j]=RateFailSecond[3]*x[7,3,2,j]-(RateStageFailSecond[3]+mu[8,3,2])*x[8,3,2,j]+RateStageFailSecond[2]*x[8,2,2,j]\n      \n      dx[1,4,2,j]=-(RateDiag[4,j]+mu[1,4,2])*x[1,4,2,j]+RateStageInf[3]*x[1,3,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]+RateDiag[4,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,4,2,j]-(RateTreatFirst[2,4,j]+mu[2,4,2])*x[2,4,2,j]+RateStageDiag[3]*x[2,3,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]+RateTreatFirst[2,4,j]*x[2,4,2,j]-(RateSuppFirstResis[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[3,4,2,j]+RateStageTreatFirstR[3]*x[3,3,2,j]\n      dx[4,4,2,j]=RateSuppFirstResis[4]*x[3,4,2,j]-(RateFailFirstResis[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[4,4,2,j]\n      dx[5,4,2,j]=RateFailFirstResis[4]*x[4,4,2,j]-(RateTreatSecond[4,j]+mu[5,4,2])*x[5,4,2,j]+RateStageFailFirst[3]*x[5,3,2,j]\n      dx[6,4,2,j]=RateTreatSecond_noDTG[4,j]*x[11,4,2,j]+RateTreatSecond_noDTG[4,j]*x[15,4,2,j]+RateTreatSecond[4,j]*x[5,4,2,j]-(RateSuppSecond[4]+RateStageTreatSecondL[3]+mu[6,4,2])*x[6,4,2,j]+RateStageTreatSecondR[3]*x[6,3,2,j]\n      dx[7,4,2,j]=RateSuppSecond[4]*x[6,4,2,j]-(RateFailSecond[4]+RateStageSuppSecond[3]+mu[7,4,2])*x[7,4,2,j]\n      dx[8,4,2,j]=RateFailSecond[4]*x[7,4,2,j]-mu[8,4,2]*x[8,4,2,j]+RateStageFailSecond[3]*x[8,3,2,j]\n      \n      ##############################################################################################################################################################\n      \n      dx[1,1,2,j]=dx[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]-RateDirectTreatSecond[2,1]*x[2,1,2,j]+RateStopTreatFirst[1]*x[3,1,2,j]+RateStopSuppFirst[1]*x[4,1,2,j]+RateStopFailFirst[1]*x[5,1,2,j]+\n        (RateStopTreatSecond[1]*x[6,1,2,j]+RateStopSuppSecond[1]*x[7,1,2,j]+RateStopFailSecond[1]*x[8,1,2,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,1,2,j]=dx[3,1,2,j]-RateStopTreatFirst[1]*x[3,1,2,j]-RateTreatToFailFirstResis[1]*x[3,1,2,j]\n      dx[4,1,2,j]=dx[4,1,2,j]-RateStopSuppFirst[1]*x[4,1,2,j]+RateFailToSuppTreatFirstResis[1]*x[5,1,2,j]-RateSuppFirstToSecond[1]*x[4,1,2,j]\n      dx[5,1,2,j]=dx[5,1,2,j]-RateStopFailFirst[1]*x[5,1,2,j]-RateFailToSuppTreatFirstResis[1]*x[5,1,2,j]+RateTreatToFailFirstResis[1]*x[3,1,2,j]\n      dx[6,1,2,j]=dx[6,1,2,j]-RateStopTreatSecond[1]*x[6,1,2,j]+RateDirectTreatSecond[2,1]*x[2,1,2,j]+RateDirectTreatSecond[2,1]*x[12,1,2,j]-RateTreatToFailSecond[1]*x[6,1,2,j]\n      dx[7,1,2,j]=dx[7,1,2,j]-RateStopSuppSecond[1]*x[7,1,2,j]+RateFailToSuppTreatSecond[1]*x[8,1,2,j]+RateSuppFirstToSecond[1]*x[4,1,2,j]\n      dx[8,1,2,j]=dx[8,1,2,j]-RateStopFailSecond[1]*x[8,1,2,j]-RateFailToSuppTreatSecond[1]*x[8,1,2,j]+RateTreatToFailSecond[1]*x[6,1,2,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateDirectTreatSecond[2,2]*x[2,2,2,j]+RateStopTreatFirst[2]*x[3,2,2,j]+RateStopSuppFirst[2]*x[4,2,2,j]+RateStopFailFirst[2]*x[5,2,2,j]+\n        (RateStopTreatSecond[2]*x[6,2,2,j]+RateStopSuppSecond[2]*x[7,2,2,j]+RateStopFailSecond[2]*x[8,2,2,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,2,2,j]=dx[3,2,2,j]-RateStopTreatFirst[2]*x[3,2,2,j]-RateTreatToFailFirstResis[2]*x[3,2,2,j]\n      dx[4,2,2,j]=dx[4,2,2,j]-RateStopSuppFirst[2]*x[4,2,2,j]+RateFailToSuppTreatFirstResis[2]*x[5,2,2,j]-RateSuppFirstToSecond[2]*x[4,2,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]-RateStopFailFirst[2]*x[5,2,2,j]-RateFailToSuppTreatFirstResis[2]*x[5,2,2,j]+RateTreatToFailFirstResis[2]*x[3,2,2,j]\n      dx[6,2,2,j]=dx[6,2,2,j]-RateStopTreatSecond[2]*x[6,2,2,j]+RateDirectTreatSecond[2,2]*x[2,2,2,j]+RateDirectTreatSecond[2,2]*x[12,2,2,j]-RateTreatToFailSecond[2]*x[6,2,2,j]\n      dx[7,2,2,j]=dx[7,2,2,j]-RateStopSuppSecond[2]*x[7,2,2,j]+RateFailToSuppTreatSecond[2]*x[8,2,2,j]+RateSuppFirstToSecond[2]*x[4,2,2,j]\n      dx[8,2,2,j]=dx[8,2,2,j]-RateStopFailSecond[2]*x[8,2,2,j]-RateFailToSuppTreatSecond[2]*x[8,2,2,j]+RateTreatToFailSecond[2]*x[6,2,2,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateDirectTreatSecond[2,3]*x[2,3,2,j]+RateStopTreatFirst[3]*x[3,3,2,j]+RateStopSuppFirst[3]*x[4,3,2,j]+RateStopFailFirst[3]*x[5,3,2,j]+\n        (RateStopTreatSecond[3]*x[6,3,2,j]+RateStopSuppSecond[3]*x[7,3,2,j]+RateStopFailSecond[3]*x[8,3,2,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,3,2,j]=dx[3,3,2,j]-RateStopTreatFirst[3]*x[3,3,2,j]-RateTreatToFailFirstResis[3]*x[3,3,2,j]\n      dx[4,3,2,j]=dx[4,3,2,j]-RateStopSuppFirst[3]*x[4,3,2,j]+RateFailToSuppTreatFirstResis[3]*x[5,3,2,j]-RateSuppFirstToSecond[3]*x[4,3,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]-RateStopFailFirst[3]*x[5,3,2,j]-RateFailToSuppTreatFirstResis[3]*x[5,3,2,j]+RateTreatToFailFirstResis[3]*x[3,3,2,j]\n      dx[6,3,2,j]=dx[6,3,2,j]-RateStopTreatSecond[3]*x[6,3,2,j]+RateDirectTreatSecond[2,3]*x[2,3,2,j]+RateDirectTreatSecond[2,3]*x[12,3,2,j]-RateTreatToFailSecond[3]*x[6,3,2,j]\n      dx[7,3,2,j]=dx[7,3,2,j]-RateStopSuppSecond[3]*x[7,3,2,j]+RateFailToSuppTreatSecond[3]*x[8,3,2,j]+RateSuppFirstToSecond[3]*x[4,3,2,j]\n      dx[8,3,2,j]=dx[8,3,2,j]-RateStopFailSecond[3]*x[8,3,2,j]-RateFailToSuppTreatSecond[3]*x[8,3,2,j]+RateTreatToFailSecond[3]*x[6,3,2,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateDirectTreatSecond[2,4]*x[2,4,2,j]+RateStopTreatFirst[4]*x[3,4,2,j]+RateStopSuppFirst[4]*x[4,4,2,j]+RateStopFailFirst[4]*x[5,4,2,j]+\n        (RateStopTreatSecond[4]*x[6,4,2,j]+RateStopSuppSecond[4]*x[7,4,2,j]+RateStopFailSecond[4]*x[8,4,2,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,4,2,j]=dx[3,4,2,j]-RateStopTreatFirst[4]*x[3,4,2,j]-RateTreatToFailFirstResis[4]*x[3,4,2,j]\n      dx[4,4,2,j]=dx[4,4,2,j]-RateStopSuppFirst[4]*x[4,4,2,j]+RateFailToSuppTreatFirstResis[4]*x[5,4,2,j]-RateSuppFirstToSecond[4]*x[4,4,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]-RateStopFailFirst[4]*x[5,4,2,j]-RateFailToSuppTreatFirstResis[4]*x[5,4,2,j]+RateTreatToFailFirstResis[4]*x[3,4,2,j]\n      dx[6,4,2,j]=dx[6,4,2,j]-RateStopTreatSecond[4]*x[6,4,2,j]+RateDirectTreatSecond[2,4]*x[2,4,2,j]+RateDirectTreatSecond[2,4]*x[12,4,2,j]-RateTreatToFailSecond[4]*x[6,4,2,j]\n      dx[7,4,2,j]=dx[7,4,2,j]-RateStopSuppSecond[4]*x[7,4,2,j]+RateFailToSuppTreatSecond[4]*x[8,4,2,j]+RateSuppFirstToSecond[4]*x[4,4,2,j]\n      dx[8,4,2,j]=dx[8,4,2,j]-RateStopFailSecond[4]*x[8,4,2,j]-RateFailToSuppTreatSecond[4]*x[8,4,2,j]+RateTreatToFailSecond[4]*x[6,4,2,j]\n      \n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      #dx with interaction between resistant and susceptible compartments\n      dx[1,1,1,j]=dx[1,1,1,j]+RateSusceptible*x[1,1,2,j]\n      dx[2,1,1,j]=dx[2,1,1,j]+RateSusceptible*x[2,1,2,j]\n      dx[5,1,1,j]=dx[5,1,1,j]-RateResistant*x[5,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]+RateSusceptible*x[1,2,2,j]\n      dx[2,2,1,j]=dx[2,2,1,j]+RateSusceptible*x[2,2,2,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateResistant*x[5,2,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]+RateSusceptible*x[1,3,2,j]\n      dx[2,3,1,j]=dx[2,3,1,j]+RateSusceptible*x[2,3,2,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateResistant*x[5,3,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]+RateSusceptible*x[1,4,2,j]\n      dx[2,4,1,j]=dx[2,4,1,j]+RateSusceptible*x[2,4,2,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateResistant*x[5,4,1,j]\n      \n      #############################################################################################################################################################################\n      dx[1,1,2,j]=dx[1,1,2,j]-RateSusceptible*x[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]-RateSusceptible*x[2,1,2,j]\n      dx[5,1,2,j]=dx[5,1,2,j]+RateResistant*x[5,1,1,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]-RateSusceptible*x[1,2,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateSusceptible*x[2,2,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]+RateResistant*x[5,2,1,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]-RateSusceptible*x[1,3,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateSusceptible*x[2,3,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]+RateResistant*x[5,3,1,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]-RateSusceptible*x[1,4,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateSusceptible*x[2,4,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]+RateResistant*x[5,4,1,j]\n      \n      \n      #RateTreatFirstDTG[res,cd4,gender]------------------------------\n      #NNRTI susceptible\n      dx[2,1,1,j]=dx[2,1,1,j]-RateTreatFirstDTG[1,1,j]*x[2,1,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]-RateTreatFirstDTG[1,2,j]*x[2,2,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]-RateTreatFirstDTG[1,3,j]*x[2,3,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]-RateTreatFirstDTG[1,4,j]*x[2,4,1,j]\n      #NNRTI resistant\n      dx[2,1,2,j]=dx[2,1,2,j]-RateTreatFirstDTG[2,1,j]*x[2,1,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateTreatFirstDTG[2,2,j]*x[2,2,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateTreatFirstDTG[2,3,j]*x[2,3,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateTreatFirstDTG[2,4,j]*x[2,4,2,j]\n      \n      #RateSwitchDTG[care,cd4,res,gender]----------------------------\n      #NNRTI susceptible\n      dx[3,1,1,j]=dx[3,1,1,j]-RateSwitchDTG[1,1,1,j]*x[3,1,1,j]\n      dx[3,2,1,j]=dx[3,2,1,j]-RateSwitchDTG[1,2,1,j]*x[3,2,1,j]\n      dx[3,3,1,j]=dx[3,3,1,j]-RateSwitchDTG[1,3,1,j]*x[3,3,1,j]\n      dx[3,4,1,j]=dx[3,4,1,j]-RateSwitchDTG[1,4,1,j]*x[3,4,1,j]\n      \n      dx[4,1,1,j]=dx[4,1,1,j]-RateSwitchDTG[2,1,1,j]*x[4,1,1,j]\n      dx[4,2,1,j]=dx[4,2,1,j]-RateSwitchDTG[2,2,1,j]*x[4,2,1,j]\n      dx[4,3,1,j]=dx[4,3,1,j]-RateSwitchDTG[2,3,1,j]*x[4,3,1,j]\n      dx[4,4,1,j]=dx[4,4,1,j]-RateSwitchDTG[2,4,1,j]*x[4,4,1,j]\n      \n      dx[5,1,1,j]=dx[5,1,1,j]-RateSwitchDTG[3,1,1,j]*x[5,1,1,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateSwitchDTG[3,2,1,j]*x[5,2,1,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateSwitchDTG[3,3,1,j]*x[5,3,1,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateSwitchDTG[3,4,1,j]*x[5,4,1,j]\n      \n      #NNRTI resistant\n      dx[3,1,2,j]=dx[3,1,2,j]-RateSwitchDTG[1,1,2,j]*x[3,1,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]-RateSwitchDTG[1,2,2,j]*x[3,2,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]-RateSwitchDTG[1,3,2,j]*x[3,3,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]-RateSwitchDTG[1,4,2,j]*x[3,4,2,j]\n      \n      dx[4,1,2,j]=dx[4,1,2,j]-RateSwitchDTG[2,1,2,j]*x[4,1,2,j]\n      dx[4,2,2,j]=dx[4,2,2,j]-RateSwitchDTG[2,2,2,j]*x[4,2,2,j]\n      dx[4,3,2,j]=dx[4,3,2,j]-RateSwitchDTG[2,3,2,j]*x[4,3,2,j]\n      dx[4,4,2,j]=dx[4,4,2,j]-RateSwitchDTG[2,4,2,j]*x[4,4,2,j]\n      \n      dx[5,1,2,j]=dx[5,1,2,j]-RateSwitchDTG[3,1,2,j]*x[5,1,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]-RateSwitchDTG[3,2,2,j]*x[5,2,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]-RateSwitchDTG[3,3,2,j]*x[5,3,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]-RateSwitchDTG[3,4,2,j]*x[5,4,2,j]\n      \n      #DTG compartments-------------------------------------\n      #NNRTI susceptible\n      dx[9,1,1,j]=dx[9,1,1,j]+RateTreatFirstDTG[1,1,j]*x[2,1,1,j]+RateSwitchDTG[3,1,1,j]*x[5,1,1,j]+RateSwitchDTG[1,1,1,j]*x[3,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[9,1,1,j]+RateStageTreatFirstL[1]*x[9,2,1,j]\n      dx[10,1,1,j]=RateSuppFirstSusc[1]*x[9,1,1,j]-(RateFailFirstDTG[1]+mu[4,1,1])*x[10,1,1,j]+RateStageSuppFirst[1]*x[10,2,1,j]+RateSwitchDTG[2,1,1,j]*x[4,1,1,j]\n      dx[11,1,1,j]=RateFailFirstDTG[1]*x[10,1,1,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,1])*x[11,1,1,j]\n      dx[12,1,1,j]=dx[12,1,1,j]+RateDiag[1,j]*((j==2)*(1-p_women_dtg))*x[1,1,1,j]-(RateTreatFirst_noDTG[1,1,j]+RateStageDiag[1]+mu[2,1,1])*x[12,1,1,j]\n      dx[13,1,1,j]=dx[13,1,1,j]+RateTreatFirst_noDTG[1,1,j]*x[12,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[13,1,1,j]+RateStageTreatFirstL[1]*x[13,2,1,j]\n      dx[14,1,1,j]=dx[14,1,1,j]+RateSuppFirstSusc[1]*x[13,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[14,1,1,j]+RateStageSuppFirst[1]*x[14,2,1,j]\n      dx[15,1,1,j]=dx[15,1,1,j]+RateFailFirstSusc[1]*x[14,1,1,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,1])*x[15,1,1,j]\n      \n      dx[9,2,1,j]=dx[9,2,1,j]+RateTreatFirstDTG[1,2,j]*x[2,2,1,j]+RateSwitchDTG[3,2,1,j]*x[5,2,1,j]+RateSwitchDTG[1,2,1,j]*x[3,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[9,2,1,j]+RateStageTreatFirstR[1]*x[9,1,1,j]+RateStageTreatFirstL[2]*x[9,3,1,j]\n      dx[10,2,1,j]=RateSuppFirstSusc[2]*x[9,2,1,j]-(RateFailFirstDTG[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[10,2,1,j]+RateStageSuppFirst[2]*x[10,3,1,j]+RateSwitchDTG[2,2,1,j]*x[4,2,1,j]\n      dx[11,2,1,j]=RateFailFirstDTG[2]*x[10,2,1,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,1])*x[11,2,1,j]+RateStageFailFirst[1]*x[11,1,1,j]\n      dx[12,2,1,j]=dx[12,2,1,j]+RateDiag[2,j]*((j==2)*(1-p_women_dtg))*x[1,2,1,j]-(RateTreatFirst_noDTG[1,2,j]+RateStageDiag[2]+mu[2,2,1])*x[12,2,1,j]+RateStageDiag[1]*x[12,1,1,j]\n      dx[13,2,1,j]=dx[13,2,1,j]+RateTreatFirst_noDTG[1,2,j]*x[12,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[13,2,1,j]+RateStageTreatFirstR[1]*x[13,1,1,j]+RateStageTreatFirstL[2]*x[13,3,1,j]\n      dx[14,2,1,j]=dx[14,2,1,j]+RateSuppFirstSusc[2]*x[13,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[14,2,1,j]+RateStageSuppFirst[2]*x[14,3,1,j]\n      dx[15,2,1,j]=dx[15,2,1,j]+RateFailFirstSusc[2]*x[14,2,1,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,1])*x[15,2,1,j]+RateStageFailFirst[1]*x[15,1,1,j]\n      \n      dx[9,3,1,j]=dx[9,3,1,j]+RateTreatFirstDTG[1,3,j]*x[2,3,1,j]+RateSwitchDTG[3,3,1,j]*x[5,3,1,j]+RateSwitchDTG[1,3,1,j]*x[3,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[9,3,1,j]+RateStageTreatFirstR[2]*x[9,2,1,j]+RateStageTreatFirstL[3]*x[9,4,1,j]\n      dx[10,3,1,j]=RateSuppFirstSusc[3]*x[9,3,1,j]-(RateFailFirstDTG[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[10,3,1,j]+RateStageSuppFirst[3]*x[10,4,1,j]+RateSwitchDTG[2,3,1,j]*x[4,3,1,j]\n      dx[11,3,1,j]=RateFailFirstDTG[3]*x[10,3,1,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,1])*x[11,3,1,j]+RateStageFailFirst[2]*x[11,2,1,j]\n      dx[12,3,1,j]=dx[12,3,1,j]+RateDiag[3,j]*((j==2)*(1-p_women_dtg))*x[1,3,1,j]-(RateTreatFirst_noDTG[1,3,j]+RateStageDiag[3]+mu[2,3,1])*x[12,3,1,j]+RateStageDiag[2]*x[12,2,1,j]\n      dx[13,3,1,j]=dx[13,3,1,j]+RateTreatFirst_noDTG[1,3,j]*x[12,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[13,3,1,j]+RateStageTreatFirstR[2]*x[13,2,1,j]+RateStageTreatFirstL[3]*x[13,4,1,j]\n      dx[14,3,1,j]=dx[14,3,1,j]+RateSuppFirstSusc[3]*x[13,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[14,3,1,j]+RateStageSuppFirst[3]*x[14,4,1,j]\n      dx[15,3,1,j]=dx[15,3,1,j]+RateFailFirstSusc[3]*x[14,3,1,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,1])*x[15,3,1,j]+RateStageFailFirst[2]*x[15,2,1,j]\n      \n      dx[9,4,1,j]=dx[9,4,1,j]+RateTreatFirstDTG[1,4,j]*x[2,4,1,j]+RateSwitchDTG[3,4,1,j]*x[5,4,1,j]+RateSwitchDTG[1,4,1,j]*x[3,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[9,4,1,j]+RateStageTreatFirstR[3]*x[9,3,1,j]\n      dx[10,4,1,j]=RateSuppFirstSusc[4]*x[9,4,1,j]-(RateFailFirstDTG[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[10,4,1,j]+RateSwitchDTG[2,4,1,j]*x[4,4,1,j]\n      dx[11,4,1,j]=RateFailFirstDTG[4]*x[10,4,1,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,1])*x[11,4,1,j]+RateStageFailFirst[3]*x[11,3,1,j]\n      dx[12,4,1,j]=dx[12,4,1,j]+RateDiag[4,j]*((j==2)*(1-p_women_dtg))*x[1,4,1,j]-(RateTreatFirst_noDTG[1,4,j]+mu[2,4,1])*x[12,4,1,j]+RateStageDiag[3]*x[12,3,1,j]\n      dx[13,4,1,j]=dx[13,4,1,j]+RateTreatFirst_noDTG[1,4,j]*x[12,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[13,4,1,j]+RateStageTreatFirstR[3]*x[13,3,1,j]\n      dx[14,4,1,j]=dx[14,4,1,j]+RateSuppFirstSusc[4]*x[13,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[14,4,1,j]\n      dx[15,4,1,j]=dx[15,4,1,j]+RateFailFirstSusc[4]*x[14,4,1,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,1])*x[15,4,1,j]+RateStageFailFirst[3]*x[15,3,1,j]\n      \n      #NNRTI resistant\n      dx[9,1,2,j]=dx[9,1,2,j]+RateTreatFirstDTG[2,1,j]*x[2,1,2,j]+RateSwitchDTG[3,1,2,j]*x[5,1,2,j]+RateSwitchDTG[1,1,2,j]*x[3,1,2,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[9,1,2,j]+RateStageTreatFirstL[1]*x[9,2,2,j]\n      dx[10,1,2,j]=RateSuppFirstSusc[1]*x[9,1,2,j]-(RateFailFirstDTG[1]+mu[4,1,2])*x[10,1,2,j]+RateStageSuppFirst[1]*x[10,2,2,j]+RateSwitchDTG[2,1,2,j]*x[4,1,2,j]\n      dx[11,1,2,j]=RateFailFirstDTG[1]*x[10,1,2,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,2])*x[11,1,2,j]\n      dx[12,1,2,j]=dx[12,1,2,j]+RateDiag[1,j]*((j==2)*(1-p_women_dtg))*x[1,1,2,j]-(RateTreatFirst_noDTG[2,1,j]+RateStageDiag[1]+mu[2,1,2])*x[12,1,2,j]\n      dx[13,1,2,j]=dx[13,1,2,j]+RateTreatFirst_noDTG[2,1,j]*x[12,1,2,j]-(RateSuppFirstResis[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[13,1,2,j]+RateStageTreatFirstL[1]*x[13,2,2,j]\n      dx[14,1,2,j]=dx[14,1,2,j]+RateSuppFirstResis[1]*x[13,1,2,j]-(RateFailFirstResis[1]+mu[4,1,2])*x[14,1,2,j]+RateStageSuppFirst[1]*x[14,2,2,j]\n      dx[15,1,2,j]=dx[15,1,2,j]+RateFailFirstResis[1]*x[14,1,2,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,2])*x[15,1,2,j]\n      \n      dx[9,2,2,j]=dx[9,2,2,j]+RateTreatFirstDTG[2,2,j]*x[2,2,2,j]+RateSwitchDTG[3,2,2,j]*x[5,2,2,j]+RateSwitchDTG[1,2,2,j]*x[3,2,2,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[9,2,2,j]+RateStageTreatFirstR[1]*x[9,1,2,j]+RateStageTreatFirstL[2]*x[9,3,2,j]\n      dx[10,2,2,j]=RateSuppFirstSusc[2]*x[9,2,2,j]-(RateFailFirstDTG[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[10,2,2,j]+RateStageSuppFirst[2]*x[10,3,2,j]+RateSwitchDTG[2,2,2,j]*x[4,2,2,j]\n      dx[11,2,2,j]=RateFailFirstDTG[2]*x[10,2,2,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,2])*x[11,2,2,j]+RateStageFailFirst[1]*x[11,1,2,j]\n      dx[12,2,2,j]=dx[12,2,2,j]+RateDiag[2,j]*((j==2)*(1-p_women_dtg))*x[1,2,2,j]-(RateTreatFirst_noDTG[2,2,j]+RateStageDiag[2]+mu[2,2,2])*x[12,2,2,j]+RateStageDiag[1]*x[12,1,2,j]\n      dx[13,2,2,j]=dx[13,2,2,j]+RateTreatFirst_noDTG[2,2,j]*x[12,2,2,j]-(RateSuppFirstResis[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[13,2,2,j]+RateStageTreatFirstR[1]*x[13,1,2,j]+RateStageTreatFirstL[2]*x[13,3,2,j]\n      dx[14,2,2,j]=dx[14,2,2,j]+RateSuppFirstResis[2]*x[13,2,2,j]-(RateFailFirstResis[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[14,2,2,j]+RateStageSuppFirst[2]*x[14,3,2,j]\n      dx[15,2,2,j]=dx[15,2,2,j]+RateFailFirstResis[2]*x[14,2,2,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,2])*x[15,2,2,j]+RateStageFailFirst[1]*x[15,1,2,j]\n      \n      dx[9,3,2,j]=dx[9,3,2,j]+RateTreatFirstDTG[2,3,j]*x[2,3,2,j]+RateSwitchDTG[3,3,2,j]*x[5,3,2,j]+RateSwitchDTG[1,3,2,j]*x[3,3,2,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[9,3,2,j]+RateStageTreatFirstR[2]*x[9,2,2,j]+RateStageTreatFirstL[3]*x[9,4,2,j]\n      dx[10,3,2,j]=RateSuppFirstSusc[3]*x[9,3,2,j]-(RateFailFirstDTG[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[10,3,2,j]+RateStageSuppFirst[3]*x[10,4,2,j]+RateSwitchDTG[2,3,2,j]*x[4,3,2,j]\n      dx[11,3,2,j]=RateFailFirstDTG[3]*x[10,3,2,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,2])*x[11,3,2,j]+RateStageFailFirst[2]*x[11,2,2,j]\n      dx[12,3,2,j]=dx[12,3,2,j]+RateDiag[3,j]*((j==2)*(1-p_women_dtg))*x[1,3,2,j]-(RateTreatFirst_noDTG[2,3,j]+RateStageDiag[3]+mu[2,3,2])*x[12,3,2,j]+RateStageDiag[2]*x[12,2,2,j]\n      dx[13,3,2,j]=dx[13,3,2,j]+RateTreatFirst_noDTG[2,3,j]*x[12,3,2,j]-(RateSuppFirstResis[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[13,3,2,j]+RateStageTreatFirstR[2]*x[13,2,2,j]+RateStageTreatFirstL[3]*x[13,4,2,j]\n      dx[14,3,2,j]=dx[14,3,2,j]+RateSuppFirstResis[3]*x[13,3,2,j]-(RateFailFirstResis[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[14,3,2,j]+RateStageSuppFirst[3]*x[14,4,2,j]\n      dx[15,3,2,j]=dx[15,3,2,j]+RateFailFirstResis[3]*x[14,3,2,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,2])*x[15,3,2,j]+RateStageFailFirst[2]*x[15,2,2,j]\n      \n      dx[9,4,2,j]=dx[9,4,2,j]+RateTreatFirstDTG[2,4,j]*x[2,4,2,j]+RateSwitchDTG[3,4,2,j]*x[5,4,2,j]+RateSwitchDTG[1,4,2,j]*x[3,4,2,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[9,4,2,j]+RateStageTreatFirstR[3]*x[9,3,2,j]\n      dx[10,4,2,j]=RateSuppFirstSusc[4]*x[9,4,2,j]-(RateFailFirstDTG[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[10,4,2,j]+RateSwitchDTG[2,4,2,j]*x[4,4,2,j]\n      dx[11,4,2,j]=RateFailFirstDTG[4]*x[10,4,2,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,2])*x[11,4,2,j]+RateStageFailFirst[3]*x[11,3,2,j]\n      dx[12,4,2,j]=dx[12,4,2,j]+RateDiag[4,j]*((j==2)*(1-p_women_dtg))*x[1,4,2,j]-(RateTreatFirst_noDTG[2,4,j]+mu[2,4,2])*x[12,4,2,j]+RateStageDiag[3]*x[12,3,2,j]\n      dx[13,4,2,j]=dx[13,4,2,j]+RateTreatFirst_noDTG[2,4,j]*x[12,4,2,j]-(RateSuppFirstResis[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[13,4,2,j]+RateStageTreatFirstR[3]*x[13,3,2,j]\n      dx[14,4,2,j]=dx[14,4,2,j]+RateSuppFirstResis[4]*x[13,4,2,j]-(RateFailFirstResis[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[14,4,2,j]\n      dx[15,4,2,j]=dx[15,4,2,j]+RateFailFirstResis[4]*x[14,4,2,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,2])*x[15,4,2,j]+RateStageFailFirst[3]*x[15,3,2,j]\n      \n      \n      \n      # #DTG compartments-------------------------------------\n      # #NNRTI susceptible\n      # dx[9,1,1,j]=dx[9,1,1,j]+RateTreatFirstDTG[1,1,j]*x[2,1,1,j]+RateSwitchDTG[1,1,1,j]*x[3,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[9,1,1,j]+RateStageTreatFirstL[1]*x[9,2,1,j]\n      # dx[10,1,1,j]=RateSwitchDTG[2,1,1,j]*x[4,1,1,j]+RateSuppFirstSusc[1]*x[9,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[10,1,1,j]+RateStageSuppFirst[1]*x[10,2,1,j]\n      # dx[11,1,1,j]=RateSwitchDTG[3,1,1,j]*x[5,1,1,j]+RateFailFirstSusc[1]*x[10,1,1,j]-(RateStageFailFirst[1]+mu[5,1,1])*x[11,1,1,j]\n      # \n      # dx[9,2,1,j]=dx[9,2,1,j]+RateTreatFirstDTG[1,2,j]*x[2,2,1,j]+RateSwitchDTG[1,2,1,j]*x[3,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[9,2,1,j]+RateStageTreatFirstR[1]*x[9,1,1,j]+RateStageTreatFirstL[2]*x[9,3,1,j]\n      # dx[10,2,1,j]=RateSwitchDTG[2,2,1,j]*x[4,2,1,j]+RateSuppFirstSusc[2]*x[9,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[10,2,1,j]+RateStageSuppFirst[2]*x[10,3,1,j]\n      # dx[11,2,1,j]=RateSwitchDTG[3,2,1,j]*x[5,2,1,j]+RateFailFirstSusc[2]*x[10,2,1,j]-(RateStageFailFirst[2]+mu[5,2,1])*x[11,2,1,j]+RateStageFailFirst[1]*x[11,1,1,j]\n      # \n      # dx[9,3,1,j]=dx[9,3,1,j]+RateTreatFirstDTG[1,3,j]*x[2,3,1,j]+RateSwitchDTG[1,3,1,j]*x[3,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[9,3,1,j]+RateStageTreatFirstR[2]*x[9,2,1,j]+RateStageTreatFirstL[3]*x[9,4,1,j]\n      # dx[10,3,1,j]=RateSwitchDTG[2,3,1,j]*x[4,3,1,j]+RateSuppFirstSusc[3]*x[9,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[10,3,1,j]+RateStageSuppFirst[3]*x[10,4,1,j]\n      # dx[11,3,1,j]=RateSwitchDTG[3,3,1,j]*x[5,3,1,j]+RateFailFirstSusc[3]*x[10,3,1,j]-(RateStageFailFirst[3]+mu[5,3,1])*x[11,3,1,j]+RateStageFailFirst[2]*x[11,2,1,j]\n      # \n      # dx[9,4,1,j]=dx[9,4,1,j]+RateTreatFirstDTG[1,4,j]*x[2,4,1,j]+RateSwitchDTG[1,4,1,j]*x[3,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[9,4,1,j]+RateStageTreatFirstR[3]*x[9,3,1,j]\n      # dx[10,4,1,j]=RateSwitchDTG[2,4,1,j]*x[4,4,1,j]+RateSuppFirstSusc[4]*x[9,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[10,4,1,j]\n      # dx[11,4,1,j]=RateSwitchDTG[3,4,1,j]*x[5,4,1,j]+RateFailFirstSusc[4]*x[10,4,1,j]-(mu[5,4,1])*x[11,4,1,j]+RateStageFailFirst[3]*x[11,3,1,j]\n      # ##############################################################################################################################################################\n      \n      dx[9,1,1,j]=dx[9,1,1,j]-RateStopTreatFirst[1]*x[9,1,1,j]-RateTreatToFailFirstDTG[1]*x[9,1,1,j]\n      dx[10,1,1,j]=dx[10,1,1,j]-RateStopSuppFirst[1]*x[10,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[11,1,1,j]\n      dx[11,1,1,j]=dx[11,1,1,j]-RateStopFailFirst[1]*x[11,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[11,1,1,j]+RateTreatToFailFirstDTG[1]*x[9,1,1,j]\n      dx[12,1,1,j]=dx[12,1,1,j]-RateDirectTreatSecond[1,1]*x[12,1,1,j]+RateStopTreatFirst[1]*x[13,1,1,j]+RateStopSuppFirst[1]*x[14,1,1,j]+RateStopFailFirst[1]*x[15,1,1,j]+\n        (RateStopTreatSecond[1]*x[6,1,1,j]+RateStopSuppSecond[1]*x[7,1,1,j]+RateStopFailSecond[1]*x[8,1,1,j])*((j==2)*(1-p_women_dtg))\n      dx[13,1,1,j]=dx[13,1,1,j]-RateStopTreatFirst[1]*x[13,1,1,j]-RateTreatToFailFirstSusc[1]*x[13,1,1,j]\n      dx[14,1,1,j]=dx[14,1,1,j]-RateStopSuppFirst[1]*x[14,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[15,1,1,j]-RateSuppFirstToSecond[1]*x[14,1,1,j]\n      dx[15,1,1,j]=dx[15,1,1,j]-RateStopFailFirst[1]*x[15,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[15,1,1,j]+RateTreatToFailFirstSusc[1]*x[13,1,1,j]\n      \n      dx[9,2,1,j]=dx[9,2,1,j]-RateStopTreatFirst[2]*x[9,2,1,j]-RateTreatToFailFirstDTG[2]*x[9,2,1,j]\n      dx[10,2,1,j]=dx[10,2,1,j]-RateStopSuppFirst[2]*x[10,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[11,2,1,j]-RateSuppFirstToSecond[2]*x[10,2,1,j]\n      dx[11,2,1,j]=dx[11,2,1,j]-RateStopFailFirst[2]*x[11,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[11,2,1,j]+RateTreatToFailFirstDTG[2]*x[9,2,1,j]\n      dx[12,2,1,j]=dx[12,2,1,j]-RateDirectTreatSecond[1,2]*x[12,2,1,j]+RateStopTreatFirst[2]*x[13,2,1,j]+RateStopSuppFirst[2]*x[14,2,1,j]+RateStopFailFirst[2]*x[15,2,1,j]+\n        (RateStopTreatSecond[2]*x[6,2,1,j]+RateStopSuppSecond[2]*x[7,2,1,j]+RateStopFailSecond[2]*x[8,2,1,j])*((j==2)*(1-p_women_dtg))\n      dx[13,2,1,j]=dx[13,2,1,j]-RateStopTreatFirst[2]*x[13,2,1,j]-RateTreatToFailFirstSusc[2]*x[13,2,1,j]\n      dx[14,2,1,j]=dx[14,2,1,j]-RateStopSuppFirst[2]*x[14,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[15,2,1,j]-RateSuppFirstToSecond[2]*x[14,2,1,j]\n      dx[15,2,1,j]=dx[15,2,1,j]-RateStopFailFirst[2]*x[15,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[15,2,1,j]+RateTreatToFailFirstSusc[2]*x[13,2,1,j]\n      \n      dx[9,3,1,j]=dx[9,3,1,j]-RateStopTreatFirst[3]*x[9,3,1,j]-RateTreatToFailFirstDTG[3]*x[9,3,1,j]\n      dx[10,3,1,j]=dx[10,3,1,j]-RateStopSuppFirst[3]*x[10,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[11,3,1,j]\n      dx[11,3,1,j]=dx[11,3,1,j]-RateStopFailFirst[3]*x[11,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[11,3,1,j]+RateTreatToFailFirstDTG[3]*x[9,3,1,j]\n      dx[12,3,1,j]=dx[12,3,1,j]-RateDirectTreatSecond[1,3]*x[12,3,1,j]+RateStopTreatFirst[3]*x[13,3,1,j]+RateStopSuppFirst[3]*x[14,3,1,j]+RateStopFailFirst[3]*x[15,3,1,j]+\n        (RateStopTreatSecond[3]*x[6,3,1,j]+RateStopSuppSecond[3]*x[7,3,1,j]+RateStopFailSecond[3]*x[8,3,1,j])*((j==2)*(1-p_women_dtg))\n      dx[13,3,1,j]=dx[13,3,1,j]-RateStopTreatFirst[3]*x[13,3,1,j]-RateTreatToFailFirstSusc[3]*x[13,3,1,j]\n      dx[14,3,1,j]=dx[14,3,1,j]-RateStopSuppFirst[3]*x[14,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[15,3,1,j]-RateSuppFirstToSecond[3]*x[14,3,1,j]\n      dx[15,3,1,j]=dx[15,3,1,j]-RateStopFailFirst[3]*x[15,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[15,3,1,j]+RateTreatToFailFirstSusc[3]*x[13,3,1,j]\n      \n      dx[9,4,1,j]=dx[9,4,1,j]-RateStopTreatFirst[4]*x[9,4,1,j]-RateTreatToFailFirstDTG[4]*x[9,4,1,j]\n      dx[10,4,1,j]=dx[10,4,1,j]-RateStopSuppFirst[4]*x[10,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[11,4,1,j]\n      dx[11,4,1,j]=dx[11,4,1,j]-RateStopFailFirst[4]*x[11,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[11,4,1,j]+RateTreatToFailFirstDTG[4]*x[9,4,1,j]\n      dx[12,4,1,j]=dx[12,4,1,j]-RateDirectTreatSecond[1,4]*x[12,4,1,j]+RateStopTreatFirst[4]*x[13,4,1,j]+RateStopSuppFirst[4]*x[14,4,1,j]+RateStopFailFirst[4]*x[15,4,1,j]+\n        (RateStopTreatSecond[4]*x[6,4,1,j]+RateStopSuppSecond[4]*x[7,4,1,j]+RateStopFailSecond[4]*x[8,4,1,j])*((j==2)*(1-p_women_dtg))\n      dx[13,4,1,j]=dx[13,4,1,j]-RateStopTreatFirst[4]*x[13,4,1,j]-RateTreatToFailFirstSusc[4]*x[13,4,1,j]\n      dx[14,4,1,j]=dx[14,4,1,j]-RateStopSuppFirst[4]*x[14,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[15,4,1,j]-RateSuppFirstToSecond[4]*x[14,4,1,j]\n      dx[15,4,1,j]=dx[15,4,1,j]-RateStopFailFirst[4]*x[15,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[15,4,1,j]+RateTreatToFailFirstSusc[4]*x[13,4,1,j]\n      \n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      #NNRTI resistant\n      # dx[9,1,2,j]=dx[9,1,2,j]+RateTreatFirstDTG[2,1,j]*x[2,1,2,j]+RateSwitchDTG[1,1,2,j]*x[3,1,2,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[9,1,2,j]+RateStageTreatFirstL[1]*x[9,2,2,j]\n      # dx[10,1,2,j]=RateSwitchDTG[2,1,2,j]*x[4,1,2,j]+RateSuppFirstSusc[1]*x[9,1,2,j]-(RateFailFirstSusc[1]+mu[4,1,2])*x[10,1,2,j]+RateStageSuppFirst[1]*x[10,2,2,j]\n      # dx[11,1,2,j]=RateSwitchDTG[3,1,2,j]*x[5,1,2,j]+RateFailFirstSusc[1]*x[10,1,2,j]-(RateStageFailFirst[1]+mu[5,1,2])*x[11,1,2,j]\n      # \n      # dx[9,2,2,j]=dx[9,2,2,j]+RateTreatFirstDTG[2,2,j]*x[2,2,2,j]+RateSwitchDTG[1,2,2,j]*x[3,2,2,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[9,2,2,j]+RateStageTreatFirstR[1]*x[9,1,2,j]+RateStageTreatFirstL[2]*x[9,3,2,j]\n      # dx[10,2,2,j]=RateSwitchDTG[2,2,2,j]*x[4,2,2,j]+RateSuppFirstSusc[2]*x[9,2,2,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[10,2,2,j]+RateStageSuppFirst[2]*x[10,3,2,j]\n      # dx[11,2,2,j]=RateSwitchDTG[3,2,2,j]*x[5,2,2,j]+RateFailFirstSusc[2]*x[10,2,2,j]-(RateStageFailFirst[2]+mu[5,2,2])*x[11,2,2,j]+RateStageFailFirst[1]*x[11,1,2,j]\n      # \n      # dx[9,3,2,j]=dx[9,3,2,j]+RateTreatFirstDTG[2,3,j]*x[2,3,2,j]+RateSwitchDTG[1,3,2,j]*x[3,3,2,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[9,3,2,j]+RateStageTreatFirstR[2]*x[9,2,2,j]+RateStageTreatFirstL[3]*x[9,4,2,j]\n      # dx[10,3,2,j]=RateSwitchDTG[2,3,2,j]*x[4,3,2,j]+RateSuppFirstSusc[3]*x[9,3,2,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[10,3,2,j]+RateStageSuppFirst[3]*x[10,4,2,j]\n      # dx[11,3,2,j]=RateSwitchDTG[3,3,2,j]*x[5,3,2,j]+RateFailFirstSusc[3]*x[10,3,2,j]-(RateStageFailFirst[3]+mu[5,3,2])*x[11,3,2,j]+RateStageFailFirst[2]*x[11,2,2,j]\n      # \n      # dx[9,4,2,j]=dx[9,4,2,j]+RateTreatFirstDTG[2,4,j]*x[2,4,2,j]+RateSwitchDTG[1,4,2,j]*x[3,4,2,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[9,4,2,j]+RateStageTreatFirstR[3]*x[9,3,2,j]\n      # dx[10,4,2,j]=RateSwitchDTG[2,4,2,j]*x[4,4,2,j]+RateSuppFirstSusc[4]*x[9,4,2,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[10,4,2,j]\n      # dx[11,4,2,j]=RateSwitchDTG[3,4,2,j]*x[5,4,2,j]+RateFailFirstSusc[4]*x[10,4,2,j]-(mu[5,4,2])*x[11,4,2,j]+RateStageFailFirst[3]*x[11,3,2,j]\n      ##############################################################################################################################################################\n      \n      dx[9,1,2,j]=dx[9,1,2,j]-RateStopTreatFirst[1]*x[9,1,2,j]-RateTreatToFailFirstDTG[1]*x[9,1,2,j]\n      dx[10,1,2,j]=dx[10,1,2,j]-RateStopSuppFirst[1]*x[10,1,2,j]+RateFailToSuppTreatFirstSusc[1]*x[11,1,2,j]\n      dx[11,1,2,j]=dx[11,1,2,j]-RateStopFailFirst[1]*x[11,1,2,j]-RateFailToSuppTreatFirstSusc[1]*x[11,1,2,j]+RateTreatToFailFirstDTG[1]*x[9,1,2,j]\n      dx[12,1,2,j]=dx[12,1,2,j]-RateDirectTreatSecond[2,1]*x[12,1,2,j]+RateStopTreatFirst[1]*x[13,1,2,j]+RateStopSuppFirst[1]*x[14,1,2,j]+RateStopFailFirst[1]*x[15,1,2,j]+\n        (RateStopTreatSecond[1]*x[6,1,2,j]+RateStopSuppSecond[1]*x[7,1,2,j]+RateStopFailSecond[1]*x[8,1,2,j])*((j==2)*(1-p_women_dtg))\n      dx[13,1,2,j]=dx[13,1,2,j]-RateStopTreatFirst[1]*x[13,1,2,j]-RateTreatToFailFirstResis[1]*x[13,1,2,j]\n      dx[14,1,2,j]=dx[14,1,2,j]-RateStopSuppFirst[1]*x[14,1,2,j]+RateFailToSuppTreatFirstResis[1]*x[15,1,2,j]-RateSuppFirstToSecond[1]*x[14,1,2,j]\n      dx[15,1,2,j]=dx[15,1,2,j]-RateStopFailFirst[1]*x[15,1,2,j]-RateFailToSuppTreatFirstResis[1]*x[15,1,2,j]+RateTreatToFailFirstResis[1]*x[13,1,2,j]\n      \n      dx[9,2,2,j]=dx[9,2,2,j]-RateStopTreatFirst[2]*x[9,2,2,j]-RateTreatToFailFirstDTG[2]*x[9,2,2,j]\n      dx[10,2,2,j]=dx[10,2,2,j]-RateStopSuppFirst[2]*x[10,2,2,j]+RateFailToSuppTreatFirstSusc[2]*x[11,2,2,j]\n      dx[11,2,2,j]=dx[11,2,2,j]-RateStopFailFirst[2]*x[11,2,2,j]-RateFailToSuppTreatFirstSusc[2]*x[11,2,2,j]+RateTreatToFailFirstDTG[2]*x[9,2,2,j]\n      dx[12,2,2,j]=dx[12,2,2,j]-RateDirectTreatSecond[2,2]*x[12,2,2,j]+RateStopTreatFirst[2]*x[13,2,2,j]+RateStopSuppFirst[2]*x[14,2,2,j]+RateStopFailFirst[2]*x[15,2,2,j]+\n        (RateStopTreatSecond[2]*x[6,2,2,j]+RateStopSuppSecond[2]*x[7,2,2,j]+RateStopFailSecond[2]*x[8,2,2,j])*((j==2)*(1-p_women_dtg))\n      dx[13,2,2,j]=dx[13,2,2,j]-RateStopTreatFirst[2]*x[13,2,2,j]-RateTreatToFailFirstResis[2]*x[13,2,2,j]\n      dx[14,2,2,j]=dx[14,2,2,j]-RateStopSuppFirst[2]*x[14,2,2,j]+RateFailToSuppTreatFirstResis[2]*x[15,2,2,j]-RateSuppFirstToSecond[2]*x[14,2,2,j]\n      dx[15,2,2,j]=dx[15,2,2,j]-RateStopFailFirst[2]*x[15,2,2,j]-RateFailToSuppTreatFirstResis[2]*x[15,2,2,j]+RateTreatToFailFirstResis[2]*x[13,2,2,j]\n      \n      dx[9,3,2,j]=dx[9,3,2,j]-RateStopTreatFirst[3]*x[9,3,2,j]-RateTreatToFailFirstDTG[3]*x[9,3,2,j]\n      dx[10,3,2,j]=dx[10,3,2,j]-RateStopSuppFirst[3]*x[10,3,2,j]+RateFailToSuppTreatFirstSusc[3]*x[11,3,2,j]\n      dx[11,3,2,j]=dx[11,3,2,j]-RateStopFailFirst[3]*x[11,3,2,j]-RateFailToSuppTreatFirstSusc[3]*x[11,3,2,j]+RateTreatToFailFirstDTG[3]*x[9,3,2,j]\n      dx[12,3,2,j]=dx[12,3,2,j]-RateDirectTreatSecond[2,3]*x[12,3,2,j]+RateStopTreatFirst[3]*x[13,3,2,j]+RateStopSuppFirst[3]*x[14,3,2,j]+RateStopFailFirst[3]*x[15,3,2,j]+\n        (RateStopTreatSecond[3]*x[6,3,2,j]+RateStopSuppSecond[3]*x[7,3,2,j]+RateStopFailSecond[3]*x[8,3,2,j])*((j==2)*(1-p_women_dtg))\n      dx[13,3,2,j]=dx[13,3,2,j]-RateStopTreatFirst[3]*x[13,3,2,j]-RateTreatToFailFirstResis[3]*x[13,3,2,j]\n      dx[14,3,2,j]=dx[14,3,2,j]-RateStopSuppFirst[3]*x[14,3,2,j]+RateFailToSuppTreatFirstResis[3]*x[15,3,2,j]-RateSuppFirstToSecond[3]*x[14,3,2,j]\n      dx[15,3,2,j]=dx[15,3,2,j]-RateStopFailFirst[3]*x[15,3,2,j]-RateFailToSuppTreatFirstResis[3]*x[15,3,2,j]+RateTreatToFailFirstResis[3]*x[13,3,2,j]\n      \n      dx[9,4,2,j]=dx[9,4,2,j]-RateStopTreatFirst[4]*x[9,4,2,j]-RateTreatToFailFirstDTG[4]*x[9,4,2,j]\n      dx[10,4,2,j]=dx[10,4,2,j]-RateStopSuppFirst[4]*x[10,4,2,j]+RateFailToSuppTreatFirstSusc[4]*x[11,4,2,j]\n      dx[11,4,2,j]=dx[11,4,2,j]-RateStopFailFirst[4]*x[11,4,2,j]-RateFailToSuppTreatFirstSusc[4]*x[11,4,2,j]+RateTreatToFailFirstDTG[4]*x[9,4,2,j]\n      dx[12,4,2,j]=dx[12,4,2,j]-RateDirectTreatSecond[2,4]*x[12,4,2,j]+RateStopTreatFirst[4]*x[13,4,2,j]+RateStopSuppFirst[4]*x[14,4,2,j]+RateStopFailFirst[4]*x[15,4,2,j]+\n        (RateStopTreatSecond[4]*x[6,4,2,j]+RateStopSuppSecond[4]*x[7,4,2,j]+RateStopFailSecond[4]*x[8,4,2,j])*((j==2)*(1-p_women_dtg))\n      dx[13,4,2,j]=dx[13,4,2,j]-RateStopTreatFirst[4]*x[13,4,2,j]-RateTreatToFailFirstResis[4]*x[13,4,2,j]\n      dx[14,4,2,j]=dx[14,4,2,j]-RateStopSuppFirst[4]*x[14,4,2,j]+RateFailToSuppTreatFirstResis[4]*x[15,4,2,j]-RateSuppFirstToSecond[4]*x[14,4,2,j]\n      dx[15,4,2,j]=dx[15,4,2,j]-RateStopFailFirst[4]*x[15,4,2,j]-RateFailToSuppTreatFirstResis[4]*x[15,4,2,j]+RateTreatToFailFirstResis[4]*x[13,4,2,j]\n      \n      \n      \n      #Resistance acquisition and reversion\n      dx[12,1,2,j]=dx[12,1,2,j]-RateSusceptible*x[12,1,2,j]\n      dx[15,1,2,j]=dx[15,1,2,j]+RateResistant*x[15,1,1,j]\n      dx[12,2,2,j]=dx[12,2,2,j]-RateSusceptible*x[12,2,2,j]\n      dx[15,2,2,j]=dx[15,2,2,j]+RateResistant*x[15,2,1,j]\n      dx[12,3,2,j]=dx[12,3,2,j]-RateSusceptible*x[12,3,2,j]\n      dx[15,3,2,j]=dx[15,3,2,j]+RateResistant*x[15,3,1,j]\n      dx[12,4,2,j]=dx[12,4,2,j]-RateSusceptible*x[12,4,2,j]\n      dx[15,4,2,j]=dx[15,4,2,j]+RateResistant*x[15,4,1,j]\n      \n      dx[12,1,1,j]=dx[12,1,1,j]+RateSusceptible*x[12,1,2,j]\n      dx[15,1,1,j]=dx[15,1,1,j]-RateResistant*x[15,1,1,j]\n      dx[12,2,1,j]=dx[12,2,1,j]+RateSusceptible*x[12,2,2,j]\n      dx[15,2,1,j]=dx[15,2,1,j]-RateResistant*x[15,2,1,j]\n      dx[12,3,1,j]=dx[12,3,1,j]+RateSusceptible*x[12,3,2,j]\n      dx[15,3,1,j]=dx[15,3,1,j]-RateResistant*x[15,3,1,j]\n      dx[12,4,1,j]=dx[12,4,1,j]+RateSusceptible*x[12,4,2,j]\n      dx[15,4,1,j]=dx[15,4,1,j]-RateResistant*x[15,4,1,j]\n      \n    }\n    dx[x+dx<0]=0\n    #dx[12:15,1:4,1:2,1]=0\n    #new_infections\n    new_inf=S[1]/N[1]*(sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,1:2,1:2],c(1,3),sum))+\n                         sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8,9,11,12,13,15),1:4,1:2,1:2],c(2,4),sum)))+\n      S[2]/N[2]*(sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,1:2,1:2],c(1,3),sum))+\n                   sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8,9,11,12,13,15),1:4,1:2,1:2],c(2,4),sum)))\n    #death\n    death=sum(apply(x[1:8,1:4,1:2,1:2],c(1,2,3),sum)*mu)+sum(apply(x[12,1:4,1:2,1:2],c(1,2),sum)*mu[2,1:4,1:2])+\n      sum(apply(x[9:11,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])+sum(apply(x[13:15,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    death_w=sum(x[1:8,1:4,1:2,2]*mu)+sum(x[12,1:4,1:2,2]*mu[2,1:4,1:2])+\n      sum(x[9:11,1:4,1:2,2]*mu[3:5,1:4,1:2])+sum(x[13:15,1:4,1:2,2]*mu[3:5,1:4,1:2])\n    death_w_nnrti=sum(x[3:5,1:4,1:2,2]*mu[3:5,1:4,1:2])+sum(x[13:15,1:4,1:2,2]*mu[3:5,1:4,1:2])\n    death_w_inel=sum(x[13:15,1:4,1:2,2]*mu[3:5,1:4,1:2])\n    death2=sum(apply(x[3:5,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    death3=sum(apply(x[13:15,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    death4=sum(apply(x[9:11,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    death5=sum(apply(x[2,1:4,1:2,1:2],c(1,2),sum)*mu[2,1:4,1:2])\n    #new_infections resistant\n    new_inf_res=S[1]/N[1]*(sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+\n                             sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8,9,11,12,13,15),1:4,2,1:2],c(2,3),sum)))+\n      S[2]/N[2]*(sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+\n                   sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8,9,11,12,13,15),1:4,2,1:2],c(2,3),sum)))\n    \n    n1=S[1]/N[1]*sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))#susc inf\n    n2=S[1]/N[1]*sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8,9,11),1:4,2,1:2],c(2,3),sum))#susc diag\n    n3=S[2]/N[2]*sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))#res inf\n    n4=S[2]/N[2]*sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8,9,11),1:4,2,1:2],c(2,3),sum))#res diag\n    #death resistant\n    death_res=sum(apply(x[1:8,1:4,2,1:2],c(1,2),sum)*mu[1:8,1:4,2])+sum(apply(x[12,1:4,2,1:2],c(1),sum)*mu[2,1:4,2])+\n      sum(apply(x[9:11,1:4,2,1:2],c(1,2),sum)*mu[3:5,1:4,2])+sum(apply(x[13:15,1:4,2,1:2],c(1,2),sum)*mu[3:5,1:4,2])\n    \n    \n    death_treat=sum(apply(x[3:8,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:8,1:4,1:2])+\n      sum(apply(x[9:11,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])+sum(apply(x[13:15,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    death_treat_res=sum(apply(x[3:8,1:4,2,1:2],c(1,2),sum)*mu[3:8,1:4,2])+\n      sum(apply(x[9:11,1:4,2,1:2],c(1,2),sum)*mu[3:5,1:4,2])+sum(apply(x[13:15,1:4,2,1:2],c(1,2),sum)*mu[3:5,1:4,2])\n    \n    \n    new_treat=sum(RateTreatFirst[1:2,1:4,1:2]*aperm(x[2,1:4,1:2,1:2],perm=c(2,1,3)))+\n      sum(RateTreatFirstDTG[1:2,1:4,1:2]*aperm(x[2,1:4,1:2,1:2],perm=c(2,1,3)))+\n      sum(RateDirectTreatSecond[1:2,1:4]*aperm(apply(x[2,1:4,1:2,1:2],c(1,2),sum),c(2,1)))+\n      sum(RateTreatFirst[1:2,1:4,1:2]*aperm(x[12,1:4,1:2,1:2],perm=c(2,1,3)))+\n      sum(RateDirectTreatSecond[1:2,1:4]*aperm(apply(x[12,1:4,1:2,1:2],c(1,2),sum),c(2,1)))\n    \n    \n    new_treat_res=sum(RateTreatFirst[2,1:4,1:2]*x[2,1:4,2,1:2])+\n      sum(RateTreatFirstDTG[2,1:4,1:2]*x[2,1:4,2,1:2])+\n      sum(RateDirectTreatSecond[2,1:4]*apply(x[2,1:4,2,1:2],c(1),sum))+\n      sum(RateTreatFirst[2,1:4,1:2]*x[12,1:4,2,1:2])+\n      sum(RateDirectTreatSecond[2,1:4]*apply(x[12,1:4,2,1:2],c(1),sum))\n    \n    death_diag=sum(apply(x[12,1:4,1:2,1:2],c(1,2),sum)*mu[2,1:4,1:2])+sum(apply(x[2,1:4,1:2,1:2],c(1,2),sum)*mu[2,1:4,1:2])\n    death_diag_res=sum(apply(x[12,1:4,2,1:2],c(1),sum)*mu[2,1:4,2])+sum(apply(x[2,1:4,2,1:2],c(1),sum)*mu[2,1:4,2])\n    \n    new_diag=sum(RateDiag[1:4,1:2]*apply(x[1,1:4,1:2,1:2],c(1,3),sum))\n    new_diag_res=sum(RateDiag[1:4,1:2]*apply(x[1,1:4,2,1:2],c(1,2),sum))\n    \n    \n    #why last cd4 class go down quicker in res than in susc\n    new_pi_susc=sum(apply(RateDirectTreatSecond[1:2,1:4],c(2),sum)*apply(x[c(2,12),1:4,1,1:2],c(2),sum))+\n      sum(RateTreatSecond[1:4,1:2]*x[c(5),1:4,1,1:2])+\n      sum(RateTreatSecond_noDTG[1:4,1:2]*apply(x[c(5,15),1:4,1,1:2],c(2,3),sum))\n    new_pi_res=sum(apply(RateDirectTreatSecond[1:2,1:4],c(2),sum)*apply(x[c(2,12),1:4,2,1:2],c(2),sum))+\n      sum(RateTreatSecond[1:4,1:2]*x[c(5),1:4,2,1:2])+\n      sum(RateTreatSecond_noDTG[1:4,1:2]*apply(x[c(5,15),1:4,2,1:2],c(2,3),sum))\n    new_pi_susc_4=sum(RateDirectTreatSecond[1:2,4]*apply(x[c(2,12),4,1,1:2],c(2),sum))+\n      sum(RateTreatSecond[4,1:2]*x[c(5),4,1,1:2])+\n      sum(RateTreatSecond_noDTG[4,1:2]*apply(x[c(5,15),4,1,1:2],c(2),sum))\n    new_pi_res_4=sum(RateDirectTreatSecond[1:2,4]*apply(x[c(2,12),4,2,1:2],c(2),sum))+\n      sum(RateTreatSecond[4,1:2]*x[c(5),4,2,1:2])+\n      sum(RateTreatSecond_noDTG[4,1:2]*apply(x[c(5,15),4,2,1:2],c(2),sum))\n    \n    \n    m_susc=sum(RateDiag[1:4,1]*x[1,1:4,1,1]+RateDiag[1:4,2]*p_women_dtg*x[1,1:4,1,2])\n    m_res=sum(RateDiag[1:4,1]*x[1,1:4,2,1]+RateDiag[1:4,2]*p_women_dtg*x[1,1:4,2,2])\n    \n    m_susc=m_susc-sum(RateTreatFirst[1,1:4,1]*x[2,1:4,1,1]+RateTreatFirst[1,1:4,2]*x[2,1:4,1,2])\n    m_res=m_res-sum(RateTreatFirst[2,1:4,1]*x[2,1:4,2,1]+RateTreatFirst[2,1:4,2]*x[2,1:4,2,2])\n    \n    m_susc=m_susc-sum(RateDirectTreatSecond[1,1:4]*x[2,1:4,1,1]+RateDirectTreatSecond[1,1:4]*x[2,1:4,1,2])\n    m_res=m_res-sum(RateDirectTreatSecond[2,1:4]*x[2,1:4,2,1]+RateDirectTreatSecond[2,1:4]*x[2,1:4,2,2])\n    \n    m_susc=m_susc-sum(RateTreatFirstDTG[1,1:4,1]*x[2,1:4,1,1]+RateTreatFirstDTG[1,1:4,2]*x[2,1:4,1,2])\n    m_res=m_res-sum(RateTreatFirstDTG[2,1:4,1]*x[2,1:4,2,1]+RateTreatFirstDTG[2,1:4,2]*x[2,1:4,2,2])\n    \n    m_susc=m_susc-sum(mu[2,1:4,1]*x[2,1:4,1,1]+mu[2,1:4,1]*x[2,1:4,1,2])\n    m_res=m_res-sum(mu[2,1:4,2]*x[2,1:4,2,1]+mu[2,1:4,2]*x[2,1:4,2,2])\n    \n    # new_treat_susc=sum(RateTreatFirstDTG[1,1:4,1:2]*x[2,1:4,1,1:2])\n    # new_treat_res=sum(RateTreatFirstDTG[2,1:4,1:2]*x[2,1:4,2,1:2])\n    \n    \n    mort_susc=sum(mu[1,1:4,1]*apply(x[1,1:4,1,1:2],1,sum))\n    mort_res=sum(mu[1,1:4,2]*apply(x[1,1:4,2,1:2],1,sum))\n    \n    # #new_diag_susc=sum(x[2,1:4,1,1:2])\n    # #new_diag_res=sum(x[2,1:4,2,1:2])\n    # mort_susc=sum(mu[2,1:4,1]*apply(x[2,1:4,1,1:2],1,sum))\n    # mort_res=sum(mu[2,1:4,2]*apply(x[2,1:4,2,1:2],1,sum))\n    \n    #dx[3:8,1:4,1,1:2]=dx[3:8,1:4,1,1:2]+infected_m15_month[t+1]*x[3:8,1:4,1,1:2]/sum(x[3:8,1:4,1,1:2])\n    ####################################################################################################################\n    res=c(dx,new_inf,death,new_diag,new_treat,death_treat,new_inf_res,death_res,death_w,death_w_nnrti,death_w_inel)\n    #res=c(dx,new_inf,death,new_diag,new_treat,death_treat,new_inf_res,death_res,new_diag_res,new_treat_res,death_treat_res)\n    #res=c(dx,new_inf,death,new_diag,new_pi_susc,new_pi_res,new_inf_res,death_res,new_diag_res,new_pi_susc_4,new_pi_res_4)\n    #res=c(dx,new_treat_susc,new_treat_res,new_diag_susc,new_diag_res,mort_susc,mort_res)\n    #res=c(dx,new_inf,death,new_diag,new_treat,death_diag,new_inf_res,death_res,new_diag_res,new_treat_res,death_diag_res)\n    return(c(res))\n    #return(list(c(res,newinf,newsu,newres,death)))\n    #})\n  })\n}\n\n###########################################################################################\n#DTG\n#Rates\n#rates are defined in a separate function, unlike before\nmod_rate=function(t,x,p1,treat_dtg,parms,p2){\n  \n  e=as.list(parms)\n  e<-within(as.list(e), {\n    rate1_inf <- p1[1] #number of unprotected sexual acts/month\n    rate2_inf <- p1[2]\n    rate1_diag <- p1[3] #diagnosis rate\n    rate2_diag <- p1[4] #diagnosis rate\n    rate_treat <- p1[5] #scale parameter for overall treatment rate\n    rate_death <- p1[6] #scale parameter for overall death\n    q <- p2[7]\n    #Range\n    rate_ratio <- p2[8] #varying parameter to estimate death for treated (but neither suppressed nor failed)\n    rate_ratio <- 0.9\n    \n    alpha1 <- p2[12] #ratio between outcome when resistant/sensitive\n    rate_res <- p2[13] #resistant rate\n    rate_susc <- p2[14] #reversion rate\n    alpha2 <- p2[12]\n    \n    #1. Infection and Diagnosis\n    RateInf1<-array(rep(RateTransm,each=4),dim=c(4,2,2))*rate1_inf\n    RateInf2<-RateInf1*rate2_inf\n    \n    Diag_frame[,4]<-Diag_frame[,4]*rate2_diag\n    RateDiag<-1/rate1_diag*apply(Diag_frame,1,function(x) smooth_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))\n    \n    RateDiag<-array(rep(RateDiag,2)*rep(c(1,diag_women),each=4),dim=c(4,2))+\n      array(rep(oi_inc,2)*rep(smooth_st(2005+t/12,oi_test[\"a\"],oi_test[\"b\"],oi_test[\"c\"],oi_test[\"d\"]),8),dim=c(4,2))+\n      array(c(rep(0,4),preg_inc)*rep(smooth_st(2005+t/12,preg_test[\"a\"],preg_test[\"b\"],preg_test[\"c\"],preg_test[\"d\"]),8),dim=c(4,2))\n    \n    #2. Treatment theoretical (if no counterfactual scenario)\n    #2.1 Rate to first- and second-line regimen, NNRTI and PI\n    \n    #not more used\n    #RateTreatFirst_th<-apply(Treat_frame,1,function(x) smooth_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*smooth_st(2005+t/12,2001,2012,1,200/12)*rate_treat\n    \n    #Rate treat first function, second part is only used with scenario of earlier treat-all policy (take the max to have continuous increase in each cd4 stata)\n    RateTreatFirst_f<-function(y){\n      if(y<2005){\n        return(apply(Treat_frame_original,1,function(x) smooth_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*smooth_st(y,2001,2012,1,200/12)*rate_treat)\n      }else{\n        return(apply(\n          data.frame(t1=apply(Treat_frame,1,function(x) lin_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"])),\n                     t2=apply(Treat_frame2,1,function(x) lin_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*as.numeric(y>Treat_frame2$a[4])),\n          1,max)*smooth_st(y,2001,2012,1,200/12)*rate_treat)\n      }\n    }\n    #Theoretical treatment rates for first- and second-line regimen\n    RateTreatFirst_th<-RateTreatFirst_f(2005+t/12)\n    RateDirectTreatSecond_th<-RateDirectTreatSecond\n    \n    #RateTreatFirst[res,cd4]\n    RateTreatFirst<-matrix(c(RateTreatFirst_th,RateTreatFirst_th),nrow=2,ncol=4,byrow=T)\n    #RateTreatSecond[res,cd4]\n    RateDirectTreatSecond<-matrix(c(RateDirectTreatSecond_th,RateDirectTreatSecond_th),nrow=2,ncol=4,byrow=T)\n    \n    #2.2 Treatment rates in case of DTG introduction\n    #percentage of women eligible for dtg\n    if(treat_dtg[1]!=treat_dtg[2] & treat_dtg[2]!=0){print(\"percentage of women eligible for dtg not equal for FirstTreat and Switch.\")}\n    p_women_dtg<-treat_dtg[1]\n    #RateTreatFirstDTG[res,cd4,gender]\n    RateTreatFirstDTG<-array(rep(RateTreatFirst*treat_dtg[3],2)*rep(c(1,1),each=8),dim=c(2,4,2))*\n      smooth_st(2005+t/12,2018,2018+treat_dtg[\"delay_first\"],0,1) #delay\n    #-------------------------------------------------------------------------------------------------------------\n    #2.2.1 RateSwitchDTG[care,cd4,res,gender]\n    #1) All people switch at a rate equal to RateTreatSecond\n    #RateSwitchDTG<-array(rep(rep(treat_dtg[4]*RateTreatSecond,each=3)*rep(c(treat_dtg[5],treat_dtg[6],treat_dtg[7]),4),4),dim=c(3,4,2,2))*\n    #smooth_st(2005+t/12,2018,2018+treat_dtg[\"delay_switch\"],0,1) #delay\n    RateSwitchDTG<-array(rep(rep(RateTreatSecond,each=3)*rep(c(treat_dtg[5],treat_dtg[6],treat_dtg[7]),4),4),dim=c(3,4,2,2))*\n      smooth_st(2005+t/12,2018,2018+treat_dtg[\"delay_switch\"],0,1) #delay\n    #2) All people switch at a rate equal to 1/12 months^(-1)\n    # RateSwitchDTG=array(rep(rep(treat_dtg[4]*rep(1/12,4),each=3)*rep(c(treat_dtg[5],treat_dtg[6],treat_dtg[7]),4),4),dim=c(3,4,2,2))*\n    #    smooth_st(2005+t/12,2018,2018+treat_dtg[\"delay_switch\"],0,1) #delay\n    #3) Treated and suppressed people switch at a rate equal to 1year^-1, failed people at a rate still equal to 1) RateTreatSecond or 2) 1/12 months^(-1)\n    RateSwitchDTG[1:2,1:4,1:2,1:2]<-rep(treat_dtg[4],32)*rep(rep(1/12,2)*c(treat_dtg[5],treat_dtg[6]),16)*\n      smooth_st(2005+t/12,2018,2018+treat_dtg[\"delay_switch\"],0,1) #delay\n    #-------------------------------------------------------------------------------------------------------------\n    #2.2.2 Modified treatment rates\n    #RateTreatFirst [res,cd4,gender]\n    RateTreatFirst_noDTG<-array(rep(RateTreatFirst,2),dim=c(2,4,2)) #Treatment rate to NNRTI for DTG-ineligible people\n    RateTreatFirst<-apply(RateTreatFirst_noDTG-RateTreatFirstDTG,c(1,2,3),function(x) max(x,0))  #Treatment rate to NNRTI for DTG-eligible people\n    \n    #RateTreatSecond_noDTG[CD4,gender]\n    #1) Treat rates to second for dtg-ineligible people stay the same\n    RateTreatSecond_noDTG<-array(rep(RateTreatSecond,2),dim=c(4,2)) #Treatment rate to PI for DTG-ineligible people\n    #2) Treat rates to second for dtg-ineligible people increase in 2018 (only do that when switching rate to dtg of failed people is 1/12, in order to have same switching rates for both dtg-ineligible and -eligible)\n    # if(2005+t/12<2018){RateTreatSecond_noDTG=array(rep(RateTreatSecond,2),dim=c(4,2))\n    # }else{RateTreatSecond_noDTG=array(rep(1/12,8),dim=c(4,2))}\n    #RateTreatSecond[CD4,gender]\n    RateTreatSecond<-apply(RateTreatSecond_noDTG-apply(RateSwitchDTG[3,1:4,1:2,1:2],c(1,3),mean),c(1,2),function(x) max(x,0)) #Treatment rate to PI for DTG-eligible people\n    #we take the mean here as RateTreatSecond is the same for men and women. It has not any impact as long as RateSwitchDTG is also the same for men and women.\n    ############\n    #print(RateTreatSecond_noDTG)\n    #print(RateTreatSecond)\n    ############\n    #3. Death\n    p1<-min(1,q*mean(sapply(2005+seq(t-36,t,1)/12,function(x) RateTreatFirst_f(x)[4]/rate_treat)))\n    p1=1-0.27*exp(-q*(mean(sapply(2005+seq(t-36,t,1)/12,function(x) RateTreatFirst_f(x)[4])-\n                             sapply(2005+seq(-36,0,1)/12,function(x) RateTreatFirst_f(x)[4])))/rate_treat)\n    mu[1:2,4,1]<-p1*40.9+(1-p1)*134.4\n    mu[4,4,1]<-p1*8.3+(1-p1)*41.7\n    mu[5,4,1]<-p1*11.8+(1-p1)*59.7\n    mu[3,1:4,1]<-rate_ratio*mu[4,1:4,1]+(1-rate_ratio)*mu[5,1:4,1]\n    mu[6:8,1:4,1]<-mu[3:5,1:4,1]\n    mu[1:8,1:4,2]<-mu[1:8,1:4,1]\n    mu<-mu*rate_death/1000\n    \n    #Back and forth mutation and impact on treatment outcome\n    RateResistant<-1/rate_res\n    RateSusceptible<-1/rate_susc\n    #From T to S\n    RateSuppFirstSusc<-RateSuppFirst\n    RateSuppFirstResis<-1/alpha1*RateSuppFirst\n    #From S to F\n    RateFailFirstSusc<-RateFailFirst\n    RateFailFirstResis<-alpha2*RateFailFirst\n    #From T to F\n    RateTreatToFailFirstSusc<-RateTreatToFailFirst\n    RateTreatToFailFirstResis<-alpha1*RateTreatToFailFirst\n    #From F to S\n    RateFailToSuppTreatFirstSusc<-RateFailToSuppTreatFirst\n    RateFailToSuppTreatFirstResis<-1/alpha2*RateFailToSuppTreatFirst\n    \n    #For second-line regimen, no effect of NNRTI resistance on treatment as it is PI\n    ##################################################################################################################\n    if(length(x)==250){\n      I<-apply(array(x,dim=c(15,4,2,2)),4,sum)\n    }else if(length(x)==298){\n      I<-apply(array(x,dim=c(18,4,2,2)),4,sum)\n    }else{\n      stop(\"length of x !=250 or 298 (my comment)\")\n    }\n    \n    #First approach to model S: S=N-I\n    N<-N_value_f(t+1)\n    S<-N-I\n    #Percentage getting NNRTI-based 1st-line[gender]\n    p_NNRTI<-sum(RateTreatFirst)/sum(RateTreatFirst+RateTreatFirstDTG)*c(1,treat_dtg[1])+c(0,1-treat_dtg[1])\n  })\n  return(e)\n  #return(list(e[[\"RateSwitchDTG\"]],e[[\"RateTreatSecond\"]]))\n}\nmod_rate_2res=function(t,x,p1,treat_dtg,parms,p2){\n  \n  e=as.list(parms)\n  e<-within(as.list(e), {\n    rate1_inf <- p1[1] #number of unprotected sexual acts/month\n    rate2_inf <- p1[2]\n    rate1_diag <- p1[3] #diagnosis rate\n    rate2_diag <- p1[4] #diagnosis rate\n    rate_treat <- p1[5] #scale parameter for overall treatment rate\n    rate_death <- p1[6] #scale parameter for overall death\n    q <- p2[7]\n    #Range\n    rate_ratio <- p2[8] #varying parameter to estimate death for treated (but neither suppressed nor failed)\n    rate_ratio <- 0.9\n    \n    alpha1 <- p2[12] #ratio between outcome when resistant/sensitive\n    rate_res <- p2[13] #resistant rate\n    rate_susc <- p2[14] #reversion rate\n    alpha2 <- p2[15]\n    \n    #1. Infection and Diagnosis\n    RateInf1<-array(rep(RateTransm,each=4),dim=c(4,2,2))*rate1_inf\n    RateInf2<-RateInf1*rate2_inf\n    \n    Diag_frame[,4]<-Diag_frame[,4]*rate2_diag\n    RateDiag<-1/rate1_diag*apply(Diag_frame,1,function(x) smooth_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))\n    \n    RateDiag<-array(rep(RateDiag,2)*rep(c(1,diag_women),each=4),dim=c(4,2))+\n      array(rep(oi_inc,2)*rep(smooth_st(2005+t/12,oi_test[\"a\"],oi_test[\"b\"],oi_test[\"c\"],oi_test[\"d\"]),8),dim=c(4,2))+\n      array(c(rep(0,4),preg_inc)*rep(smooth_st(2005+t/12,preg_test[\"a\"],preg_test[\"b\"],preg_test[\"c\"],preg_test[\"d\"]),8),dim=c(4,2))\n    \n    #2. Treatment theoretical (if no counterfactual scenario)\n    #2.1 Rate to first- and second-line regimen, NNRTI and PI\n    \n    #not more used\n    #RateTreatFirst_th<-apply(Treat_frame,1,function(x) smooth_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*smooth_st(2005+t/12,2001,2012,1,200/12)*rate_treat\n    \n    #Rate treat first function, second part is only used with scenario of earlier treat-all policy (take the max to have continuous increase in each cd4 stata)\n    RateTreatFirst_f<-function(y){\n      if(y<2005){\n        return(apply(Treat_frame_original,1,function(x) smooth_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*smooth_st(y,2001,2012,1,200/12)*rate_treat)\n      }else{\n        return(apply(\n          data.frame(t1=apply(Treat_frame,1,function(x) lin_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"])),\n                     t2=apply(Treat_frame2,1,function(x) lin_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*as.numeric(y>Treat_frame2$a[4])),\n          1,max)*smooth_st(y,2001,2012,1,200/12)*rate_treat)\n      }\n    }\n    #Theoretical treatment rates for first- and second-line regimen\n    RateTreatFirst_th<-RateTreatFirst_f(2005+t/12)\n    RateDirectTreatSecond_th<-RateDirectTreatSecond\n    \n    #RateTreatFirst[res,cd4]\n    RateTreatFirst<-matrix(c(RateTreatFirst_th,RateTreatFirst_th),nrow=2,ncol=4,byrow=T)\n    #RateTreatSecond[res,cd4]\n    RateDirectTreatSecond<-matrix(c(RateDirectTreatSecond_th,RateDirectTreatSecond_th),nrow=2,ncol=4,byrow=T)\n    \n    #2.2 Treatment rates in case of DTG introduction\n    #percentage of women eligible for dtg\n    if(treat_dtg[1]!=treat_dtg[2] & treat_dtg[2]!=0){print(\"percentage of women eligible for dtg not equal for FirstTreat and Switch.\")}\n    p_women_dtg<-treat_dtg[1]\n    #RateTreatFirstDTG[res,cd4,gender]\n    RateTreatFirstDTG<-array(rep(RateTreatFirst*treat_dtg[3],2)*rep(c(1,1),each=8),dim=c(2,4,2))*\n      smooth_st(2005+t/12,2019,2019+treat_dtg[\"delay_first\"],0,1) #delay\n    #-------------------------------------------------------------------------------------------------------------\n    #2.2.1 RateSwitchDTG[care,cd4,res,gender]\n    #1) All people switch at a rate equal to RateTreatSecond\n    #RateSwitchDTG<-array(rep(rep(treat_dtg[4]*RateTreatSecond,each=3)*rep(c(treat_dtg[5],treat_dtg[6],treat_dtg[7]),4),4),dim=c(3,4,2,2))*\n    #smooth_st(2005+t/12,2019,2019+treat_dtg[\"delay_switch\"],0,1) #delay\n    RateSwitchDTG<-array(rep(rep(RateTreatSecond,each=3)*rep(c(treat_dtg[5],treat_dtg[6],treat_dtg[7]),4),4),dim=c(3,4,2,2))*\n      smooth_st(2005+t/12,2019,2019+treat_dtg[\"delay_switch\"],0,1) #delay\n    #2) All people switch at a rate equal to 1/12 months^(-1)\n    # RateSwitchDTG=array(rep(rep(treat_dtg[4]*rep(1/12,4),each=3)*rep(c(treat_dtg[5],treat_dtg[6],treat_dtg[7]),4),4),dim=c(3,4,2,2))*\n    #    smooth_st(2005+t/12,2019,2019+treat_dtg[\"delay_switch\"],0,1) #delay\n    #3) Treated and suppressed people switch at a rate equal to 1year^-1, failed people at a rate still equal to 1) RateTreatSecond or 2) 1/12 months^(-1)\n    RateSwitchDTG[1:2,1:4,1:2,1:2]<-rep(treat_dtg[4],32)*rep(rep(1/12,2)*c(treat_dtg[5],treat_dtg[6]),16)*\n      smooth_st(2005+t/12,2019,2019+treat_dtg[\"delay_switch\"],0,1) #delay\n    #4) Failed people switch at a rate equal to 5year^-1\n    RateSwitchDTG[3,1:4,1:2,1:2]<-rep(1/(12*5),16)*treat_dtg[7]*\n      smooth_st(2005+t/12,2019,2019+treat_dtg[\"delay_switch\"],0,1)\n    #-------------------------------------------------------------------------------------------------------------\n    #2.2.2 Modified treatment rates\n    #RateTreatFirst [res,cd4,gender]\n    RateTreatFirst_noDTG<-array(rep(RateTreatFirst,2),dim=c(2,4,2)) #Treatment rate to NNRTI for DTG-ineligible people\n    RateTreatFirst<-apply(RateTreatFirst_noDTG-RateTreatFirstDTG,c(1,2,3),function(x) max(x,0))  #Treatment rate to NNRTI for DTG-eligible people\n    \n    #RateTreatSecond_noDTG[CD4,gender]\n    #1) Treat rates to second for dtg-ineligible people stay the same\n    RateTreatSecond_noDTG<-array(rep(RateTreatSecond,2),dim=c(4,2)) #Treatment rate to PI for DTG-ineligible people\n    #2) Treat rates to second for dtg-ineligible people increase in 2019 (only do that when switching rate to dtg of failed people is 1/12, in order to have same switching rates for both dtg-ineligible and -eligible)\n    # if(2005+t/12<2019){RateTreatSecond_noDTG=array(rep(RateTreatSecond,2),dim=c(4,2))\n    # }else{RateTreatSecond_noDTG=array(rep(1/12,8),dim=c(4,2))}\n    \n    #RateTreatSecond[CD4,gender]\n    RateTreatSecond<-apply(RateTreatSecond_noDTG-apply(RateSwitchDTG[3,1:4,1:2,1:2],c(1,3),mean),c(1,2),function(x) max(x,0)) #Treatment rate to PI for DTG-eligible people\n    #we take the mean here as RateTreatSecond is the same for men and women. It has not any impact as long as RateSwitchDTG is also the same for men and women.\n    ############\n    #print(RateTreatSecond_noDTG)\n    #print(RateTreatSecond)\n    ############\n    #3. Death\n    p1<-min(1,q*mean(sapply(2005+seq(t-36,t,1)/12,function(x) RateTreatFirst_f(x)[4]/rate_treat)))\n    p1=1-0.27*exp(-q*(mean(sapply(2005+seq(t-36,t,1)/12,function(x) RateTreatFirst_f(x)[4])-\n                             sapply(2005+seq(-36,0,1)/12,function(x) RateTreatFirst_f(x)[4])))/rate_treat)\n    mu[1:2,4,1]<-p1*40.9+(1-p1)*134.4\n    mu[4,4,1]<-p1*8.3+(1-p1)*41.7\n    mu[5,4,1]<-p1*11.8+(1-p1)*59.7\n    mu[3,1:4,1]<-rate_ratio*mu[4,1:4,1]+(1-rate_ratio)*mu[5,1:4,1]\n    mu[6:8,1:4,1]<-mu[3:5,1:4,1]\n    mu[1:8,1:4,2]<-mu[1:8,1:4,1]\n    mu<-mu*rate_death/1000\n    \n    #Back and forth mutation and impact on treatment outcome\n    RateResistant<-1/rate_res\n    RateSusceptible<-1/rate_susc\n    #From T to S\n    RateSuppFirstSusc<-RateSuppFirst\n    RateSuppFirstResis<-1/alpha1*RateSuppFirst\n    #From S to F\n    RateFailFirstSusc<-RateFailFirst\n    RateFailFirstResis<-alpha2*RateFailFirst\n    #From T to F\n    RateTreatToFailFirstSusc<-RateTreatToFailFirst\n    RateTreatToFailFirstResis<-alpha1*RateTreatToFailFirst\n    #From F to S\n    RateFailToSuppTreatFirstSusc<-RateFailToSuppTreatFirst\n    RateFailToSuppTreatFirstResis<-1/alpha2*RateFailToSuppTreatFirst\n    \n    #For second-line regimen, no effect of NNRTI resistance on treatment as it is PI\n    ##################################################################################################################\n    if(length(x)==250){\n      I<-apply(array(x,dim=c(15,4,2,2)),4,sum)\n    }else if(length(x)==298){\n      I<-apply(array(x,dim=c(18,4,2,2)),4,sum)\n    }else{\n      stop(paste(\"length of x !=250 or 298 (my comment), length=\", length(x)))\n    }\n    \n    #First approach to model S: S=N-I\n    N<-N_value_f(t+1)\n    S<-N-I\n    #Percentage getting NNRTI-based 1st-line[gender]\n    p_NNRTI<-sum(RateTreatFirst)/sum(RateTreatFirst+RateTreatFirstDTG)*c(1,treat_dtg[1])+c(0,1-treat_dtg[1])\n  })\n  return(e)\n  #return(list(e[[\"RateSwitchDTG\"]],e[[\"RateTreatSecond\"]]))\n}\n\n#15 care stages\nselect_15=function(r1,r2,r3,r4){\n  l1=15\n  l2=4\n  l3=2\n  l4=2\n  ar=array(1:(l1*l2*l3*l4),dim=c(l1,l2,l3,l4))\n  return(as.vector(ar[r1,r2,r3,r4]))\n}\nxstart_f_dtg_2=function(par,treat_dtg){\n  k1=par[9]\n  k2=par[10]\n  k3=par[11]\n  \n  start_value=array(0,dim=c(15,4,2,2))\n  start_value[1,1:4,1,1:2]=c(undiag_start[1]*repart_f(k1),undiag_start[2]*repart_f(k1))\n  start_value[2,1:4,1,1:2]=c(diag_start[1]*repart_f(k2),diag_start[2]*repart_f(k2))\n  start_value[3,1:4,1,1:2]=c(treat_start[1]*repart_f(k3),treat_start[2]*repart_f(k3))\n  \n  start_value[4,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0\n  start_value[5,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0\n  start_value[3,1:4,1,1:2]=start_value[3,1:4,1,1:2]*1\n  \n  start_value[1:2,1:4,2,1:2]=array(rep(rep(c(0.01,0.01,0.01,0.01),each=2),2),dim=c(2,4,2))*start_value[1:2,1:4,1,1:2]\n  start_value[1:2,1:4,1,1:2]=array(rep(rep(1-c(0.01,0.01,0.01,0.01),each=2),2),dim=c(2,4,2))*start_value[1:2,1:4,1,1:2]\n  start_value[3,1:4,2,1:2]=0.01*start_value[3,1:4,1,1:2]\n  start_value[3,1:4,1,1:2]=0.99*start_value[3,1:4,1,1:2]\n  start_value[4,1:4,2,1:2]=0.01*start_value[4,1:4,1,1:2]\n  start_value[4,1:4,1,1:2]=0.99*start_value[4,1:4,1,1:2]\n  start_value[5,1:4,2,1:2]=0.7*start_value[5,1:4,1,1:2]\n  start_value[5,1:4,1,1:2]=0.3*start_value[5,1:4,1,1:2]\n  \n  start_value[12:15,1:4,1:2,2]=(1-treat_dtg[1])*start_value[2:5,1:4,1:2,2]\n  start_value[2:5,1:4,1:2,2]=treat_dtg[1]*start_value[2:5,1:4,1:2,2]\n  \n  xstart=c(start_value,rep(0,10))\n  return(xstart)\n}\nmod_dtg=function(t,x,p1,treat_dtg,parms,p2){\n  \n  #parms2=mod_rate(t,x,p1,treat_dtg,parms,p2)\n  parms2=mod_rate_2res(t,x,p1,treat_dtg,parms,p2) #2 rates to model the impact of res on treatment\n  dx=array(0,dim=c(15,4,2,2))\n  x=array(x,dim=c(15,4,2,2))\n  \n  #People reaching 15 not considered, because uncertainty about proportion of resistance,\n  #because you have to take into account both mtct of res. and acquisition of resistance due to pmtct (was not needed to be considered in marisa model 2005-2016)\n  \n  # dx[1,1:4,1,1:2]=rep(c(predict(inf_m,1+t/12)$y/4,predict(inf_w,1+t/12)$y/4)/12,each=4)\n  # dx[1,1:4,2,1:2]=0\n  # dx[2,1:4,1,1:2]=rep(c(predict(diag_m,1+t/12)$y/4,predict(diag_w,1+t/12)$y/4)/12,each=4)\n  # dx[2,1:4,2,1:2]=0\n  # dx[3,1:4,1,1:2]=(1-0.9*0.2)*rep(c(predict(treat_m,1+t/12)$y/4,predict(treat_w,1+t/12)$y/4)/12,each=4)\n  # dx[3,1:4,2,1:2]=0.9*0.2*rep(c(predict(treat_m,1+t/12)$y/4,predict(treat_w,1+t/12)$y/4)/12,each=4)\n  with(as.list(parms2), {\n    for(j in 1:2){\n      #dx[x1,x2,x3,x4] x1:care stages x2:disease progression x3:resistance x4:gender\n      #dx with only interaction with the neighbours in the compartmental model\n      dx[1,1,1,j]=S[j]/N[j]*(sum(RateInf1[1:4,1:2,j]*apply(x[c(1),1:4,1,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,j]*apply(x[c(2,3,5,6,8,9,11,12,13,15),1:4,1,1:2],c(2,3),sum)))-\n        (RateStageInf[1]+RateDiag[1,j]+mu[1,1,1])*x[1,1,1,j]\n      dx[2,1,1,j]=dx[2,1,1,j]+RateDiag[1,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,1,1,j]-(RateTreatFirst[1,1,j]+RateStageDiag[1]+mu[2,1,1])*x[2,1,1,j]\n      dx[3,1,1,j]=dx[3,1,1,j]+RateTreatFirst[1,1,j]*x[2,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[3,1,1,j]+RateStageTreatFirstL[1]*x[3,2,1,j]\n      dx[4,1,1,j]=RateSuppFirstSusc[1]*x[3,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[4,1,1,j]+RateStageSuppFirst[1]*x[4,2,1,j]\n      dx[5,1,1,j]=RateFailFirstSusc[1]*x[4,1,1,j]-(RateTreatSecond[1,j]+RateStageFailFirst[1]+mu[5,1,1])*x[5,1,1,j]\n      dx[6,1,1,j]=RateTreatSecond_noDTG[1,j]*x[11,1,1,j]+RateTreatSecond_noDTG[1,j]*x[15,1,1,j]+RateTreatSecond[1,j]*x[5,1,1,j]-(RateSuppSecond[1]+RateStageTreatSecondR[1]+mu[6,1,1])*x[6,1,1,j]+RateStageTreatSecondL[1]*x[6,2,1,j]\n      dx[7,1,1,j]=RateSuppSecond[1]*x[6,1,1,j]-(RateFailSecond[1]+mu[7,1,1])*x[7,1,1,j]+RateStageSuppSecond[1]*x[7,2,1,j]\n      dx[8,1,1,j]=RateFailSecond[1]*x[7,1,1,j]-(RateStageFailSecond[1]+mu[8,1,1])*x[8,1,1,j]\n      \n      dx[1,2,1,j]=-(RateStageInf[2]+RateDiag[2,j]+mu[1,2,1])*x[1,2,1,j]+RateStageInf[1]*x[1,1,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]+RateDiag[2,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,2,1,j]-(RateTreatFirst[1,2,j]+RateStageDiag[2]+mu[2,2,1])*x[2,2,1,j]+RateStageDiag[1]*x[2,1,1,j]\n      dx[3,2,1,j]=dx[3,2,1,j]+RateTreatFirst[1,2,j]*x[2,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[3,2,1,j]+RateStageTreatFirstR[1]*x[3,1,1,j]+RateStageTreatFirstL[2]*x[3,3,1,j]\n      dx[4,2,1,j]=RateSuppFirstSusc[2]*x[3,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[4,2,1,j]+RateStageSuppFirst[2]*x[4,3,1,j]\n      dx[5,2,1,j]=RateFailFirstSusc[2]*x[4,2,1,j]-(RateTreatSecond[2,j]+RateStageFailFirst[2]+mu[5,2,1])*x[5,2,1,j]+RateStageFailFirst[1]*x[5,1,1,j]\n      dx[6,2,1,j]=RateTreatSecond_noDTG[2,j]*x[11,2,1,j]+RateTreatSecond_noDTG[2,j]*x[15,2,1,j]+RateTreatSecond[2,j]*x[5,2,1,j]-(RateSuppSecond[2]+RateStageTreatSecondR[2]+RateStageTreatSecondL[1]+mu[6,2,1])*x[6,2,1,j]+RateStageTreatSecondR[1]*x[6,1,1,j]+RateStageTreatSecondL[2]*x[6,3,1,j]\n      dx[7,2,1,j]=RateSuppSecond[2]*x[6,2,1,j]-(RateFailSecond[2]+RateStageSuppSecond[1]+mu[7,2,1])*x[7,2,1,j]+RateStageSuppSecond[2]*x[7,3,1,j]\n      dx[8,2,1,j]=RateFailSecond[2]*x[7,2,1,j]-(RateStageFailSecond[2]+mu[8,2,1])*x[8,2,1,j]+RateStageFailSecond[1]*x[8,1,1,j]\n      \n      dx[1,3,1,j]=-(RateStageInf[3]+RateDiag[3,j]+mu[1,3,1])*x[1,3,1,j]+RateStageInf[2]*x[1,2,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]+RateDiag[3,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,3,1,j]-(RateTreatFirst[1,3,j]+RateStageDiag[3]+mu[2,3,1])*x[2,3,1,j]+RateStageDiag[2]*x[2,2,1,j]\n      dx[3,3,1,j]=dx[3,3,1,j]+RateTreatFirst[1,3,j]*x[2,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[3,3,1,j]+RateStageTreatFirstR[2]*x[3,2,1,j]+RateStageTreatFirstL[3]*x[3,4,1,j]\n      dx[4,3,1,j]=RateSuppFirstSusc[3]*x[3,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[4,3,1,j]+RateStageSuppFirst[3]*x[4,4,1,j]\n      dx[5,3,1,j]=RateFailFirstSusc[3]*x[4,3,1,j]-(RateTreatSecond[3,j]+RateStageFailFirst[3]+mu[5,3,1])*x[5,3,1,j]+RateStageFailFirst[2]*x[5,2,1,j]\n      dx[6,3,1,j]=RateTreatSecond_noDTG[3,j]*x[11,3,1,j]+RateTreatSecond_noDTG[3,j]*x[15,3,1,j]+RateTreatSecond[3,j]*x[5,3,1,j]-(RateSuppSecond[3]+RateStageTreatSecondR[3]+RateStageTreatSecondL[2]+mu[6,3,1])*x[6,3,1,j]+RateStageTreatSecondR[2]*x[6,2,1,j]+RateStageTreatSecondL[3]*x[6,4,1,j]\n      dx[7,3,1,j]=RateSuppSecond[3]*x[6,3,1,j]-(RateFailSecond[3]+RateStageSuppSecond[2]+mu[7,3,1])*x[7,3,1,j]+RateStageSuppSecond[3]*x[7,4,1,j]\n      dx[8,3,1,j]=RateFailSecond[3]*x[7,3,1,j]-(RateStageFailSecond[3]+mu[8,3,1])*x[8,3,1,j]+RateStageFailSecond[2]*x[8,2,1,j]\n      \n      dx[1,4,1,j]=-(RateDiag[4,j]+mu[1,4,1])*x[1,4,1,j]+RateStageInf[3]*x[1,3,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]+RateDiag[4,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,4,1,j]-(RateTreatFirst[1,4,j]+mu[2,4,1])*x[2,4,1,j]+RateStageDiag[3]*x[2,3,1,j]\n      dx[3,4,1,j]=dx[3,4,1,j]+RateTreatFirst[1,4,j]*x[2,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[3,4,1,j]+RateStageTreatFirstR[3]*x[3,3,1,j]\n      dx[4,4,1,j]=RateSuppFirstSusc[4]*x[3,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[4,4,1,j]\n      dx[5,4,1,j]=RateFailFirstSusc[4]*x[4,4,1,j]-(RateTreatSecond[4,j]+mu[5,4,1])*x[5,4,1,j]+RateStageFailFirst[3]*x[5,3,1,j]\n      dx[6,4,1,j]=RateTreatSecond_noDTG[4,j]*x[11,4,1,j]+RateTreatSecond_noDTG[4,j]*x[15,4,1,j]+RateTreatSecond[4,j]*x[5,4,1,j]-(RateSuppSecond[4]+RateStageTreatSecondL[3]+mu[6,4,1])*x[6,4,1,j]+RateStageTreatSecondR[3]*x[6,3,1,j]\n      dx[7,4,1,j]=RateSuppSecond[4]*x[6,4,1,j]-(RateFailSecond[4]+RateStageSuppSecond[3]+mu[7,4,1])*x[7,4,1,j]\n      dx[8,4,1,j]=RateFailSecond[4]*x[7,4,1,j]-mu[8,4,1 ]*x[8,4,1,j]+RateStageFailSecond[3]*x[8,3,1,j]\n      \n      ##############################################################################################################################################################\n      \n      dx[1,1,1,j]=dx[1,1,1,j]\n      dx[2,1,1,j]=dx[2,1,1,j]-RateDirectTreatSecond[1,1]*x[2,1,1,j]+RateStopTreatFirst[1]*x[3,1,1,j]+RateStopSuppFirst[1]*x[4,1,1,j]+RateStopFailFirst[1]*x[5,1,1,j]+\n        (RateStopTreatSecond[1]*x[6,1,1,j]+RateStopSuppSecond[1]*x[7,1,1,j]+RateStopFailSecond[1]*x[8,1,1,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,1,1,j]=dx[3,1,1,j]-RateStopTreatFirst[1]*x[3,1,1,j]-RateTreatToFailFirstSusc[1]*x[3,1,1,j]\n      dx[4,1,1,j]=dx[4,1,1,j]-RateStopSuppFirst[1]*x[4,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[5,1,1,j]-RateSuppFirstToSecond[1]*x[4,1,1,j]\n      dx[5,1,1,j]=dx[5,1,1,j]-RateStopFailFirst[1]*x[5,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[5,1,1,j]+RateTreatToFailFirstSusc[1]*x[3,1,1,j]\n      dx[6,1,1,j]=dx[6,1,1,j]-RateStopTreatSecond[1]*x[6,1,1,j]+RateDirectTreatSecond[1,1]*x[2,1,1,j]+RateDirectTreatSecond[1,1]*x[12,1,1,j]-RateTreatToFailSecond[1]*x[6,1,1,j]\n      dx[7,1,1,j]=dx[7,1,1,j]-RateStopSuppSecond[1]*x[7,1,1,j]+RateFailToSuppTreatSecond[1]*x[8,1,1,j]+RateSuppFirstToSecond[1]*x[4,1,1,j]\n      dx[8,1,1,j]=dx[8,1,1,j]-RateStopFailSecond[1]*x[8,1,1,j]-RateFailToSuppTreatSecond[1]*x[8,1,1,j]+RateTreatToFailSecond[1]*x[6,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]-RateDirectTreatSecond[1,2]*x[2,2,1,j]+RateStopTreatFirst[2]*x[3,2,1,j]+RateStopSuppFirst[2]*x[4,2,1,j]+RateStopFailFirst[2]*x[5,2,1,j]+\n        (RateStopTreatSecond[2]*x[6,2,1,j]+RateStopSuppSecond[2]*x[7,2,1,j]+RateStopFailSecond[2]*x[8,2,1,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,2,1,j]=dx[3,2,1,j]-RateStopTreatFirst[2]*x[3,2,1,j]-RateTreatToFailFirstSusc[2]*x[3,2,1,j]\n      dx[4,2,1,j]=dx[4,2,1,j]-RateStopSuppFirst[2]*x[4,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[5,2,1,j]-RateSuppFirstToSecond[2]*x[4,2,1,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateStopFailFirst[2]*x[5,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[5,2,1,j]+RateTreatToFailFirstSusc[2]*x[3,2,1,j]\n      dx[6,2,1,j]=dx[6,2,1,j]-RateStopTreatSecond[2]*x[6,2,1,j]+RateDirectTreatSecond[1,2]*x[2,2,1,j]+RateDirectTreatSecond[1,2]*x[12,2,1,j]-RateTreatToFailSecond[2]*x[6,2,1,j]\n      dx[7,2,1,j]=dx[7,2,1,j]-RateStopSuppSecond[2]*x[7,2,1,j]+RateFailToSuppTreatSecond[2]*x[8,2,1,j]+RateSuppFirstToSecond[2]*x[4,2,1,j]\n      dx[8,2,1,j]=dx[8,2,1,j]-RateStopFailSecond[2]*x[8,2,1,j]-RateFailToSuppTreatSecond[2]*x[8,2,1,j]+RateTreatToFailSecond[2]*x[6,2,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]-RateDirectTreatSecond[1,3]*x[2,3,1,j]+RateStopTreatFirst[3]*x[3,3,1,j]+RateStopSuppFirst[3]*x[4,3,1,j]+RateStopFailFirst[3]*x[5,3,1,j]+\n        (RateStopTreatSecond[3]*x[6,3,1,j]+RateStopSuppSecond[3]*x[7,3,1,j]+RateStopFailSecond[3]*x[8,3,1,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,3,1,j]=dx[3,3,1,j]-RateStopTreatFirst[3]*x[3,3,1,j]-RateTreatToFailFirstSusc[3]*x[3,3,1,j]\n      dx[4,3,1,j]=dx[4,3,1,j]-RateStopSuppFirst[3]*x[4,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[5,3,1,j]-RateSuppFirstToSecond[3]*x[4,3,1,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateStopFailFirst[3]*x[5,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[5,3,1,j]+RateTreatToFailFirstSusc[3]*x[3,3,1,j]\n      dx[6,3,1,j]=dx[6,3,1,j]-RateStopTreatSecond[3]*x[6,3,1,j]+RateDirectTreatSecond[1,3]*x[2,3,1,j]+RateDirectTreatSecond[1,3]*x[12,3,1,j]-RateTreatToFailSecond[3]*x[6,3,1,j]\n      dx[7,3,1,j]=dx[7,3,1,j]-RateStopSuppSecond[3]*x[7,3,1,j]+RateFailToSuppTreatSecond[3]*x[8,3,1,j]+RateSuppFirstToSecond[3]*x[4,3,1,j]\n      dx[8,3,1,j]=dx[8,3,1,j]-RateStopFailSecond[3]*x[8,3,1,j]-RateFailToSuppTreatSecond[3]*x[8,3,1,j]+RateTreatToFailSecond[3]*x[6,3,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]-RateDirectTreatSecond[1,4]*x[2,4,1,j]+RateStopTreatFirst[4]*x[3,4,1,j]+RateStopSuppFirst[4]*x[4,4,1,j]+RateStopFailFirst[4]*x[5,4,1,j]+\n        (RateStopTreatSecond[4]*x[6,4,1,j]+RateStopSuppSecond[4]*x[7,4,1,j]+RateStopFailSecond[4]*x[8,4,1,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,4,1,j]=dx[3,4,1,j]-RateStopTreatFirst[4]*x[3,4,1,j]-RateTreatToFailFirstSusc[4]*x[3,4,1,j]\n      dx[4,4,1,j]=dx[4,4,1,j]-RateStopSuppFirst[4]*x[4,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[5,4,1,j]-RateSuppFirstToSecond[4]*x[4,4,1,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateStopFailFirst[4]*x[5,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[5,4,1,j]+RateTreatToFailFirstSusc[4]*x[3,4,1,j]\n      dx[6,4,1,j]=dx[6,4,1,j]-RateStopTreatSecond[4]*x[6,4,1,j]+RateDirectTreatSecond[1,4]*x[2,4,1,j]+RateDirectTreatSecond[1,4]*x[12,4,1,j]-RateTreatToFailSecond[4]*x[6,4,1,j]\n      dx[7,4,1,j]=dx[7,4,1,j]-RateStopSuppSecond[4]*x[7,4,1,j]+RateFailToSuppTreatSecond[4]*x[8,4,1,j]+RateSuppFirstToSecond[4]*x[4,4,1,j]\n      dx[8,4,1,j]=dx[8,4,1,j]-RateStopFailSecond[4]*x[8,4,1,j]-RateFailToSuppTreatSecond[4]*x[8,4,1,j]+RateTreatToFailSecond[4]*x[6,4,1,j]\n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      dx[1,1,2,j]=S[j]/N[j]*(sum(RateInf1[1:4,1:2,j]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,j]*apply(x[c(2,3,5,6,8,9,11,12,13,15),1:4,2,1:2],c(2,3),sum)))-\n        (RateStageInf[1]+RateDiag[1,j]+mu[1,1,2 ])*x[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]+RateDiag[1,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,1,2,j]-(RateTreatFirst[2,1,j]+RateStageDiag[1]+mu[2,1,2])*x[2,1,2,j]\n      dx[3,1,2,j]=dx[3,1,2,j]+RateTreatFirst[2,1,j]*x[2,1,2,j]-(RateSuppFirstResis[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[3,1,2,j]+RateStageTreatFirstL[1]*x[3,2,2,j]\n      dx[4,1,2,j]=RateSuppFirstResis[1]*x[3,1,2,j]-(RateFailFirstResis[1]+mu[4,1,2])*x[4,1,2,j]+RateStageSuppFirst[1]*x[4,2,2,j]\n      dx[5,1,2,j]=RateFailFirstResis[1]*x[4,1,2,j]-(RateTreatSecond[1,j]+RateStageFailFirst[1]+mu[5,1,2 ])*x[5,1,2,j]\n      dx[6,1,2,j]=RateTreatSecond_noDTG[1,j]*x[11,1,2,j]+RateTreatSecond_noDTG[1,j]*x[15,1,2,j]+RateTreatSecond[1,j]*x[5,1,2,j]-(RateSuppSecond[1]+RateStageTreatSecondR[1]+mu[6,1,2])*x[6,1,2,j]+RateStageTreatSecondL[1]*x[6,2,2,j]\n      dx[7,1,2,j]=RateSuppSecond[1]*x[6,1,2,j]-(RateFailSecond[1]+mu[7,1,2])*x[7,1,2,j]+RateStageSuppSecond[1]*x[7,2,2,j]\n      dx[8,1,2,j]=RateFailSecond[1]*x[7,1,2,j]-(RateStageFailSecond[1]+mu[8,1,2])*x[8,1,2,j]\n      \n      dx[1,2,2,j]=-(RateStageInf[2]+RateDiag[2,j]+mu[1,2,2])*x[1,2,2,j]+RateStageInf[1]*x[1,1,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]+RateDiag[2,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,2,2,j]-(RateTreatFirst[2,2,j]+RateStageDiag[2]+mu[2,2,2])*x[2,2,2,j]+RateStageDiag[1]*x[2,1,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]+RateTreatFirst[2,2,j]*x[2,2,2,j]-(RateSuppFirstResis[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[3,2,2,j]+RateStageTreatFirstR[1]*x[3,1,2,j]+RateStageTreatFirstL[2]*x[3,3,2,j]\n      dx[4,2,2,j]=RateSuppFirstResis[2]*x[3,2,2,j]-(RateFailFirstResis[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[4,2,2,j]+RateStageSuppFirst[2]*x[4,3,2,j]\n      dx[5,2,2,j]=RateFailFirstResis[2]*x[4,2,2,j]-(RateTreatSecond[2,j]+RateStageFailFirst[2]+mu[5,2,2])*x[5,2,2,j]+RateStageFailFirst[1]*x[5,1,2,j]\n      dx[6,2,2,j]=RateTreatSecond_noDTG[2,j]*x[11,2,2,j]+RateTreatSecond_noDTG[2,j]*x[15,2,2,j]+RateTreatSecond[2,j]*x[5,2,2,j]-(RateSuppSecond[2]+RateStageTreatSecondR[2]+RateStageTreatSecondL[1]+mu[6,2,2])*x[6,2,2,j]+RateStageTreatSecondR[1]*x[6,1,2,j]+RateStageTreatSecondL[2]*x[6,3,2,j]\n      dx[7,2,2,j]=RateSuppSecond[2]*x[6,2,2,j]-(RateFailSecond[2]+RateStageSuppSecond[1]+mu[7,2,2])*x[7,2,2,j]+RateStageSuppSecond[2]*x[7,3,2,j]\n      dx[8,2,2,j]=RateFailSecond[2]*x[7,2,2,j]-(RateStageFailSecond[2]+mu[8,2,2])*x[8,2,2,j]+RateStageFailSecond[1]*x[8,1,2,j]\n      \n      dx[1,3,2,j]=-(RateStageInf[3]+RateDiag[3,j]+mu[1,3,2])*x[1,3,2,j]+RateStageInf[2]*x[1,2,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]+RateDiag[3,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,3,2,j]-(RateTreatFirst[2,3,j]+RateStageDiag[3]+mu[2,3,2])*x[2,3,2,j]+RateStageDiag[2]*x[2,2,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]+RateTreatFirst[2,3,j]*x[2,3,2,j]-(RateSuppFirstResis[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[3,3,2,j]+RateStageTreatFirstR[2]*x[3,2,2,j]+RateStageTreatFirstL[3]*x[3,4,2,j]\n      dx[4,3,2,j]=RateSuppFirstResis[3]*x[3,3,2,j]-(RateFailFirstResis[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[4,3,2,j]+RateStageSuppFirst[3]*x[4,4,2,j]\n      dx[5,3,2,j]=RateFailFirstResis[3]*x[4,3,2,j]-(RateTreatSecond[3,j]+RateStageFailFirst[3]+mu[5,3,2])*x[5,3,2,j]+RateStageFailFirst[2]*x[5,2,2,j]\n      dx[6,3,2,j]=RateTreatSecond_noDTG[3,j]*x[11,3,2,j]+RateTreatSecond_noDTG[3,j]*x[15,3,2,j]+RateTreatSecond[3,j]*x[5,3,2,j]-(RateSuppSecond[3]+RateStageTreatSecondR[3]+RateStageTreatSecondL[2]+mu[6,3,2])*x[6,3,2,j]+RateStageTreatSecondR[2]*x[6,2,2,j]+RateStageTreatSecondL[3]*x[6,4,2,j]\n      dx[7,3,2,j]=RateSuppSecond[3]*x[6,3,2,j]-(RateFailSecond[3]+RateStageSuppSecond[2]+mu[7,3,2])*x[7,3,2,j]+RateStageSuppSecond[3]*x[7,4,2,j]\n      dx[8,3,2,j]=RateFailSecond[3]*x[7,3,2,j]-(RateStageFailSecond[3]+mu[8,3,2])*x[8,3,2,j]+RateStageFailSecond[2]*x[8,2,2,j]\n      \n      dx[1,4,2,j]=-(RateDiag[4,j]+mu[1,4,2])*x[1,4,2,j]+RateStageInf[3]*x[1,3,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]+RateDiag[4,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,4,2,j]-(RateTreatFirst[2,4,j]+mu[2,4,2])*x[2,4,2,j]+RateStageDiag[3]*x[2,3,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]+RateTreatFirst[2,4,j]*x[2,4,2,j]-(RateSuppFirstResis[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[3,4,2,j]+RateStageTreatFirstR[3]*x[3,3,2,j]\n      dx[4,4,2,j]=RateSuppFirstResis[4]*x[3,4,2,j]-(RateFailFirstResis[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[4,4,2,j]\n      dx[5,4,2,j]=RateFailFirstResis[4]*x[4,4,2,j]-(RateTreatSecond[4,j]+mu[5,4,2])*x[5,4,2,j]+RateStageFailFirst[3]*x[5,3,2,j]\n      dx[6,4,2,j]=RateTreatSecond_noDTG[4,j]*x[11,4,2,j]+RateTreatSecond_noDTG[4,j]*x[15,4,2,j]+RateTreatSecond[4,j]*x[5,4,2,j]-(RateSuppSecond[4]+RateStageTreatSecondL[3]+mu[6,4,2])*x[6,4,2,j]+RateStageTreatSecondR[3]*x[6,3,2,j]\n      dx[7,4,2,j]=RateSuppSecond[4]*x[6,4,2,j]-(RateFailSecond[4]+RateStageSuppSecond[3]+mu[7,4,2])*x[7,4,2,j]\n      dx[8,4,2,j]=RateFailSecond[4]*x[7,4,2,j]-mu[8,4,2]*x[8,4,2,j]+RateStageFailSecond[3]*x[8,3,2,j]\n      \n      ##############################################################################################################################################################\n      \n      dx[1,1,2,j]=dx[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]-RateDirectTreatSecond[2,1]*x[2,1,2,j]+RateStopTreatFirst[1]*x[3,1,2,j]+RateStopSuppFirst[1]*x[4,1,2,j]+RateStopFailFirst[1]*x[5,1,2,j]+\n        (RateStopTreatSecond[1]*x[6,1,2,j]+RateStopSuppSecond[1]*x[7,1,2,j]+RateStopFailSecond[1]*x[8,1,2,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,1,2,j]=dx[3,1,2,j]-RateStopTreatFirst[1]*x[3,1,2,j]-RateTreatToFailFirstResis[1]*x[3,1,2,j]\n      dx[4,1,2,j]=dx[4,1,2,j]-RateStopSuppFirst[1]*x[4,1,2,j]+RateFailToSuppTreatFirstResis[1]*x[5,1,2,j]-RateSuppFirstToSecond[1]*x[4,1,2,j]\n      dx[5,1,2,j]=dx[5,1,2,j]-RateStopFailFirst[1]*x[5,1,2,j]-RateFailToSuppTreatFirstResis[1]*x[5,1,2,j]+RateTreatToFailFirstResis[1]*x[3,1,2,j]\n      dx[6,1,2,j]=dx[6,1,2,j]-RateStopTreatSecond[1]*x[6,1,2,j]+RateDirectTreatSecond[2,1]*x[2,1,2,j]+RateDirectTreatSecond[2,1]*x[12,1,2,j]-RateTreatToFailSecond[1]*x[6,1,2,j]\n      dx[7,1,2,j]=dx[7,1,2,j]-RateStopSuppSecond[1]*x[7,1,2,j]+RateFailToSuppTreatSecond[1]*x[8,1,2,j]+RateSuppFirstToSecond[1]*x[4,1,2,j]\n      dx[8,1,2,j]=dx[8,1,2,j]-RateStopFailSecond[1]*x[8,1,2,j]-RateFailToSuppTreatSecond[1]*x[8,1,2,j]+RateTreatToFailSecond[1]*x[6,1,2,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateDirectTreatSecond[2,2]*x[2,2,2,j]+RateStopTreatFirst[2]*x[3,2,2,j]+RateStopSuppFirst[2]*x[4,2,2,j]+RateStopFailFirst[2]*x[5,2,2,j]+\n        (RateStopTreatSecond[2]*x[6,2,2,j]+RateStopSuppSecond[2]*x[7,2,2,j]+RateStopFailSecond[2]*x[8,2,2,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,2,2,j]=dx[3,2,2,j]-RateStopTreatFirst[2]*x[3,2,2,j]-RateTreatToFailFirstResis[2]*x[3,2,2,j]\n      dx[4,2,2,j]=dx[4,2,2,j]-RateStopSuppFirst[2]*x[4,2,2,j]+RateFailToSuppTreatFirstResis[2]*x[5,2,2,j]-RateSuppFirstToSecond[2]*x[4,2,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]-RateStopFailFirst[2]*x[5,2,2,j]-RateFailToSuppTreatFirstResis[2]*x[5,2,2,j]+RateTreatToFailFirstResis[2]*x[3,2,2,j]\n      dx[6,2,2,j]=dx[6,2,2,j]-RateStopTreatSecond[2]*x[6,2,2,j]+RateDirectTreatSecond[2,2]*x[2,2,2,j]+RateDirectTreatSecond[2,2]*x[12,2,2,j]-RateTreatToFailSecond[2]*x[6,2,2,j]\n      dx[7,2,2,j]=dx[7,2,2,j]-RateStopSuppSecond[2]*x[7,2,2,j]+RateFailToSuppTreatSecond[2]*x[8,2,2,j]+RateSuppFirstToSecond[2]*x[4,2,2,j]\n      dx[8,2,2,j]=dx[8,2,2,j]-RateStopFailSecond[2]*x[8,2,2,j]-RateFailToSuppTreatSecond[2]*x[8,2,2,j]+RateTreatToFailSecond[2]*x[6,2,2,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateDirectTreatSecond[2,3]*x[2,3,2,j]+RateStopTreatFirst[3]*x[3,3,2,j]+RateStopSuppFirst[3]*x[4,3,2,j]+RateStopFailFirst[3]*x[5,3,2,j]+\n        (RateStopTreatSecond[3]*x[6,3,2,j]+RateStopSuppSecond[3]*x[7,3,2,j]+RateStopFailSecond[3]*x[8,3,2,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,3,2,j]=dx[3,3,2,j]-RateStopTreatFirst[3]*x[3,3,2,j]-RateTreatToFailFirstResis[3]*x[3,3,2,j]\n      dx[4,3,2,j]=dx[4,3,2,j]-RateStopSuppFirst[3]*x[4,3,2,j]+RateFailToSuppTreatFirstResis[3]*x[5,3,2,j]-RateSuppFirstToSecond[3]*x[4,3,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]-RateStopFailFirst[3]*x[5,3,2,j]-RateFailToSuppTreatFirstResis[3]*x[5,3,2,j]+RateTreatToFailFirstResis[3]*x[3,3,2,j]\n      dx[6,3,2,j]=dx[6,3,2,j]-RateStopTreatSecond[3]*x[6,3,2,j]+RateDirectTreatSecond[2,3]*x[2,3,2,j]+RateDirectTreatSecond[2,3]*x[12,3,2,j]-RateTreatToFailSecond[3]*x[6,3,2,j]\n      dx[7,3,2,j]=dx[7,3,2,j]-RateStopSuppSecond[3]*x[7,3,2,j]+RateFailToSuppTreatSecond[3]*x[8,3,2,j]+RateSuppFirstToSecond[3]*x[4,3,2,j]\n      dx[8,3,2,j]=dx[8,3,2,j]-RateStopFailSecond[3]*x[8,3,2,j]-RateFailToSuppTreatSecond[3]*x[8,3,2,j]+RateTreatToFailSecond[3]*x[6,3,2,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateDirectTreatSecond[2,4]*x[2,4,2,j]+RateStopTreatFirst[4]*x[3,4,2,j]+RateStopSuppFirst[4]*x[4,4,2,j]+RateStopFailFirst[4]*x[5,4,2,j]+\n        (RateStopTreatSecond[4]*x[6,4,2,j]+RateStopSuppSecond[4]*x[7,4,2,j]+RateStopFailSecond[4]*x[8,4,2,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,4,2,j]=dx[3,4,2,j]-RateStopTreatFirst[4]*x[3,4,2,j]-RateTreatToFailFirstResis[4]*x[3,4,2,j]\n      dx[4,4,2,j]=dx[4,4,2,j]-RateStopSuppFirst[4]*x[4,4,2,j]+RateFailToSuppTreatFirstResis[4]*x[5,4,2,j]-RateSuppFirstToSecond[4]*x[4,4,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]-RateStopFailFirst[4]*x[5,4,2,j]-RateFailToSuppTreatFirstResis[4]*x[5,4,2,j]+RateTreatToFailFirstResis[4]*x[3,4,2,j]\n      dx[6,4,2,j]=dx[6,4,2,j]-RateStopTreatSecond[4]*x[6,4,2,j]+RateDirectTreatSecond[2,4]*x[2,4,2,j]+RateDirectTreatSecond[2,4]*x[12,4,2,j]-RateTreatToFailSecond[4]*x[6,4,2,j]\n      dx[7,4,2,j]=dx[7,4,2,j]-RateStopSuppSecond[4]*x[7,4,2,j]+RateFailToSuppTreatSecond[4]*x[8,4,2,j]+RateSuppFirstToSecond[4]*x[4,4,2,j]\n      dx[8,4,2,j]=dx[8,4,2,j]-RateStopFailSecond[4]*x[8,4,2,j]-RateFailToSuppTreatSecond[4]*x[8,4,2,j]+RateTreatToFailSecond[4]*x[6,4,2,j]\n      \n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      #dx with interaction between resistant and susceptible compartments\n      dx[1,1,1,j]=dx[1,1,1,j]+RateSusceptible*x[1,1,2,j]\n      dx[2,1,1,j]=dx[2,1,1,j]+RateSusceptible*x[2,1,2,j]\n      dx[5,1,1,j]=dx[5,1,1,j]-RateResistant*x[5,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]+RateSusceptible*x[1,2,2,j]\n      dx[2,2,1,j]=dx[2,2,1,j]+RateSusceptible*x[2,2,2,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateResistant*x[5,2,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]+RateSusceptible*x[1,3,2,j]\n      dx[2,3,1,j]=dx[2,3,1,j]+RateSusceptible*x[2,3,2,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateResistant*x[5,3,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]+RateSusceptible*x[1,4,2,j]\n      dx[2,4,1,j]=dx[2,4,1,j]+RateSusceptible*x[2,4,2,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateResistant*x[5,4,1,j]\n      \n      #############################################################################################################################################################################\n      dx[1,1,2,j]=dx[1,1,2,j]-RateSusceptible*x[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]-RateSusceptible*x[2,1,2,j]\n      dx[5,1,2,j]=dx[5,1,2,j]+RateResistant*x[5,1,1,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]-RateSusceptible*x[1,2,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateSusceptible*x[2,2,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]+RateResistant*x[5,2,1,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]-RateSusceptible*x[1,3,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateSusceptible*x[2,3,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]+RateResistant*x[5,3,1,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]-RateSusceptible*x[1,4,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateSusceptible*x[2,4,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]+RateResistant*x[5,4,1,j]\n      \n      \n      #RateTreatFirstDTG[res,cd4,gender]------------------------------\n      #NNRTI susceptible\n      dx[2,1,1,j]=dx[2,1,1,j]-RateTreatFirstDTG[1,1,j]*x[2,1,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]-RateTreatFirstDTG[1,2,j]*x[2,2,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]-RateTreatFirstDTG[1,3,j]*x[2,3,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]-RateTreatFirstDTG[1,4,j]*x[2,4,1,j]\n      #NNRTI resistant\n      dx[2,1,2,j]=dx[2,1,2,j]-RateTreatFirstDTG[2,1,j]*x[2,1,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateTreatFirstDTG[2,2,j]*x[2,2,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateTreatFirstDTG[2,3,j]*x[2,3,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateTreatFirstDTG[2,4,j]*x[2,4,2,j]\n      \n      #RateSwitchDTG[care,cd4,res,gender]----------------------------\n      #NNRTI susceptible\n      dx[3,1,1,j]=dx[3,1,1,j]-RateSwitchDTG[1,1,1,j]*x[3,1,1,j]\n      dx[3,2,1,j]=dx[3,2,1,j]-RateSwitchDTG[1,2,1,j]*x[3,2,1,j]\n      dx[3,3,1,j]=dx[3,3,1,j]-RateSwitchDTG[1,3,1,j]*x[3,3,1,j]\n      dx[3,4,1,j]=dx[3,4,1,j]-RateSwitchDTG[1,4,1,j]*x[3,4,1,j]\n      \n      dx[4,1,1,j]=dx[4,1,1,j]-RateSwitchDTG[2,1,1,j]*x[4,1,1,j]\n      dx[4,2,1,j]=dx[4,2,1,j]-RateSwitchDTG[2,2,1,j]*x[4,2,1,j]\n      dx[4,3,1,j]=dx[4,3,1,j]-RateSwitchDTG[2,3,1,j]*x[4,3,1,j]\n      dx[4,4,1,j]=dx[4,4,1,j]-RateSwitchDTG[2,4,1,j]*x[4,4,1,j]\n      \n      dx[5,1,1,j]=dx[5,1,1,j]-RateSwitchDTG[3,1,1,j]*x[5,1,1,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateSwitchDTG[3,2,1,j]*x[5,2,1,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateSwitchDTG[3,3,1,j]*x[5,3,1,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateSwitchDTG[3,4,1,j]*x[5,4,1,j]\n      \n      #NNRTI resistant\n      dx[3,1,2,j]=dx[3,1,2,j]-RateSwitchDTG[1,1,2,j]*x[3,1,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]-RateSwitchDTG[1,2,2,j]*x[3,2,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]-RateSwitchDTG[1,3,2,j]*x[3,3,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]-RateSwitchDTG[1,4,2,j]*x[3,4,2,j]\n      \n      dx[4,1,2,j]=dx[4,1,2,j]-RateSwitchDTG[2,1,2,j]*x[4,1,2,j]\n      dx[4,2,2,j]=dx[4,2,2,j]-RateSwitchDTG[2,2,2,j]*x[4,2,2,j]\n      dx[4,3,2,j]=dx[4,3,2,j]-RateSwitchDTG[2,3,2,j]*x[4,3,2,j]\n      dx[4,4,2,j]=dx[4,4,2,j]-RateSwitchDTG[2,4,2,j]*x[4,4,2,j]\n      \n      dx[5,1,2,j]=dx[5,1,2,j]-RateSwitchDTG[3,1,2,j]*x[5,1,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]-RateSwitchDTG[3,2,2,j]*x[5,2,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]-RateSwitchDTG[3,3,2,j]*x[5,3,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]-RateSwitchDTG[3,4,2,j]*x[5,4,2,j]\n      \n      #DTG compartments-------------------------------------\n      #NNRTI susceptible\n      dx[9,1,1,j]=dx[9,1,1,j]+RateTreatFirstDTG[1,1,j]*x[2,1,1,j]+RateSwitchDTG[3,1,1,j]*x[5,1,1,j]+RateSwitchDTG[1,1,1,j]*x[3,1,1,j]-(RateSuppFirstDTG[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[9,1,1,j]+RateStageTreatFirstL[1]*x[9,2,1,j]\n      dx[10,1,1,j]=RateSuppFirstDTG[1]*x[9,1,1,j]-(RateFailFirstDTG[1]+mu[4,1,1])*x[10,1,1,j]+RateStageSuppFirst[1]*x[10,2,1,j]+RateSwitchDTG[2,1,1,j]*x[4,1,1,j]\n      dx[11,1,1,j]=RateFailFirstDTG[1]*x[10,1,1,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,1])*x[11,1,1,j]\n      dx[12,1,1,j]=dx[12,1,1,j]+RateDiag[1,j]*((j==2)*(1-p_women_dtg))*x[1,1,1,j]-(RateTreatFirst_noDTG[1,1,j]+RateStageDiag[1]+mu[2,1,1])*x[12,1,1,j]\n      dx[13,1,1,j]=dx[13,1,1,j]+RateTreatFirst_noDTG[1,1,j]*x[12,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[13,1,1,j]+RateStageTreatFirstL[1]*x[13,2,1,j]\n      dx[14,1,1,j]=dx[14,1,1,j]+RateSuppFirstSusc[1]*x[13,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[14,1,1,j]+RateStageSuppFirst[1]*x[14,2,1,j]\n      dx[15,1,1,j]=dx[15,1,1,j]+RateFailFirstSusc[1]*x[14,1,1,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,1])*x[15,1,1,j]\n      \n      dx[9,2,1,j]=dx[9,2,1,j]+RateTreatFirstDTG[1,2,j]*x[2,2,1,j]+RateSwitchDTG[3,2,1,j]*x[5,2,1,j]+RateSwitchDTG[1,2,1,j]*x[3,2,1,j]-(RateSuppFirstDTG[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[9,2,1,j]+RateStageTreatFirstR[1]*x[9,1,1,j]+RateStageTreatFirstL[2]*x[9,3,1,j]\n      dx[10,2,1,j]=RateSuppFirstDTG[2]*x[9,2,1,j]-(RateFailFirstDTG[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[10,2,1,j]+RateStageSuppFirst[2]*x[10,3,1,j]+RateSwitchDTG[2,2,1,j]*x[4,2,1,j]\n      dx[11,2,1,j]=RateFailFirstDTG[2]*x[10,2,1,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,1])*x[11,2,1,j]+RateStageFailFirst[1]*x[11,1,1,j]\n      dx[12,2,1,j]=dx[12,2,1,j]+RateDiag[2,j]*((j==2)*(1-p_women_dtg))*x[1,2,1,j]-(RateTreatFirst_noDTG[1,2,j]+RateStageDiag[2]+mu[2,2,1])*x[12,2,1,j]+RateStageDiag[1]*x[12,1,1,j]\n      dx[13,2,1,j]=dx[13,2,1,j]+RateTreatFirst_noDTG[1,2,j]*x[12,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[13,2,1,j]+RateStageTreatFirstR[1]*x[13,1,1,j]+RateStageTreatFirstL[2]*x[13,3,1,j]\n      dx[14,2,1,j]=dx[14,2,1,j]+RateSuppFirstSusc[2]*x[13,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[14,2,1,j]+RateStageSuppFirst[2]*x[14,3,1,j]\n      dx[15,2,1,j]=dx[15,2,1,j]+RateFailFirstSusc[2]*x[14,2,1,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,1])*x[15,2,1,j]+RateStageFailFirst[1]*x[15,1,1,j]\n      \n      dx[9,3,1,j]=dx[9,3,1,j]+RateTreatFirstDTG[1,3,j]*x[2,3,1,j]+RateSwitchDTG[3,3,1,j]*x[5,3,1,j]+RateSwitchDTG[1,3,1,j]*x[3,3,1,j]-(RateSuppFirstDTG[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[9,3,1,j]+RateStageTreatFirstR[2]*x[9,2,1,j]+RateStageTreatFirstL[3]*x[9,4,1,j]\n      dx[10,3,1,j]=RateSuppFirstDTG[3]*x[9,3,1,j]-(RateFailFirstDTG[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[10,3,1,j]+RateStageSuppFirst[3]*x[10,4,1,j]+RateSwitchDTG[2,3,1,j]*x[4,3,1,j]\n      dx[11,3,1,j]=RateFailFirstDTG[3]*x[10,3,1,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,1])*x[11,3,1,j]+RateStageFailFirst[2]*x[11,2,1,j]\n      dx[12,3,1,j]=dx[12,3,1,j]+RateDiag[3,j]*((j==2)*(1-p_women_dtg))*x[1,3,1,j]-(RateTreatFirst_noDTG[1,3,j]+RateStageDiag[3]+mu[2,3,1])*x[12,3,1,j]+RateStageDiag[2]*x[12,2,1,j]\n      dx[13,3,1,j]=dx[13,3,1,j]+RateTreatFirst_noDTG[1,3,j]*x[12,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[13,3,1,j]+RateStageTreatFirstR[2]*x[13,2,1,j]+RateStageTreatFirstL[3]*x[13,4,1,j]\n      dx[14,3,1,j]=dx[14,3,1,j]+RateSuppFirstSusc[3]*x[13,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[14,3,1,j]+RateStageSuppFirst[3]*x[14,4,1,j]\n      dx[15,3,1,j]=dx[15,3,1,j]+RateFailFirstSusc[3]*x[14,3,1,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,1])*x[15,3,1,j]+RateStageFailFirst[2]*x[15,2,1,j]\n      \n      dx[9,4,1,j]=dx[9,4,1,j]+RateTreatFirstDTG[1,4,j]*x[2,4,1,j]+RateSwitchDTG[3,4,1,j]*x[5,4,1,j]+RateSwitchDTG[1,4,1,j]*x[3,4,1,j]-(RateSuppFirstDTG[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[9,4,1,j]+RateStageTreatFirstR[3]*x[9,3,1,j]\n      dx[10,4,1,j]=RateSuppFirstDTG[4]*x[9,4,1,j]-(RateFailFirstDTG[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[10,4,1,j]+RateSwitchDTG[2,4,1,j]*x[4,4,1,j]\n      dx[11,4,1,j]=RateFailFirstDTG[4]*x[10,4,1,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,1])*x[11,4,1,j]+RateStageFailFirst[3]*x[11,3,1,j]\n      dx[12,4,1,j]=dx[12,4,1,j]+RateDiag[4,j]*((j==2)*(1-p_women_dtg))*x[1,4,1,j]-(RateTreatFirst_noDTG[1,4,j]+mu[2,4,1])*x[12,4,1,j]+RateStageDiag[3]*x[12,3,1,j]\n      dx[13,4,1,j]=dx[13,4,1,j]+RateTreatFirst_noDTG[1,4,j]*x[12,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[13,4,1,j]+RateStageTreatFirstR[3]*x[13,3,1,j]\n      dx[14,4,1,j]=dx[14,4,1,j]+RateSuppFirstSusc[4]*x[13,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[14,4,1,j]\n      dx[15,4,1,j]=dx[15,4,1,j]+RateFailFirstSusc[4]*x[14,4,1,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,1])*x[15,4,1,j]+RateStageFailFirst[3]*x[15,3,1,j]\n      \n      #NNRTI resistant\n      dx[9,1,2,j]=dx[9,1,2,j]+RateTreatFirstDTG[2,1,j]*x[2,1,2,j]+RateSwitchDTG[3,1,2,j]*x[5,1,2,j]+RateSwitchDTG[1,1,2,j]*x[3,1,2,j]-(RateSuppFirstDTG[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[9,1,2,j]+RateStageTreatFirstL[1]*x[9,2,2,j]\n      dx[10,1,2,j]=RateSuppFirstDTG[1]*x[9,1,2,j]-(RateFailFirstDTG[1]+mu[4,1,2])*x[10,1,2,j]+RateStageSuppFirst[1]*x[10,2,2,j]+RateSwitchDTG[2,1,2,j]*x[4,1,2,j]\n      dx[11,1,2,j]=RateFailFirstDTG[1]*x[10,1,2,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,2])*x[11,1,2,j]\n      dx[12,1,2,j]=dx[12,1,2,j]+RateDiag[1,j]*((j==2)*(1-p_women_dtg))*x[1,1,2,j]-(RateTreatFirst_noDTG[2,1,j]+RateStageDiag[1]+mu[2,1,2])*x[12,1,2,j]\n      dx[13,1,2,j]=dx[13,1,2,j]+RateTreatFirst_noDTG[2,1,j]*x[12,1,2,j]-(RateSuppFirstResis[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[13,1,2,j]+RateStageTreatFirstL[1]*x[13,2,2,j]\n      dx[14,1,2,j]=dx[14,1,2,j]+RateSuppFirstResis[1]*x[13,1,2,j]-(RateFailFirstResis[1]+mu[4,1,2])*x[14,1,2,j]+RateStageSuppFirst[1]*x[14,2,2,j]\n      dx[15,1,2,j]=dx[15,1,2,j]+RateFailFirstResis[1]*x[14,1,2,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,2])*x[15,1,2,j]\n      \n      dx[9,2,2,j]=dx[9,2,2,j]+RateTreatFirstDTG[2,2,j]*x[2,2,2,j]+RateSwitchDTG[3,2,2,j]*x[5,2,2,j]+RateSwitchDTG[1,2,2,j]*x[3,2,2,j]-(RateSuppFirstDTG[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[9,2,2,j]+RateStageTreatFirstR[1]*x[9,1,2,j]+RateStageTreatFirstL[2]*x[9,3,2,j]\n      dx[10,2,2,j]=RateSuppFirstDTG[2]*x[9,2,2,j]-(RateFailFirstDTG[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[10,2,2,j]+RateStageSuppFirst[2]*x[10,3,2,j]+RateSwitchDTG[2,2,2,j]*x[4,2,2,j]\n      dx[11,2,2,j]=RateFailFirstDTG[2]*x[10,2,2,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,2])*x[11,2,2,j]+RateStageFailFirst[1]*x[11,1,2,j]\n      dx[12,2,2,j]=dx[12,2,2,j]+RateDiag[2,j]*((j==2)*(1-p_women_dtg))*x[1,2,2,j]-(RateTreatFirst_noDTG[2,2,j]+RateStageDiag[2]+mu[2,2,2])*x[12,2,2,j]+RateStageDiag[1]*x[12,1,2,j]\n      dx[13,2,2,j]=dx[13,2,2,j]+RateTreatFirst_noDTG[2,2,j]*x[12,2,2,j]-(RateSuppFirstResis[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[13,2,2,j]+RateStageTreatFirstR[1]*x[13,1,2,j]+RateStageTreatFirstL[2]*x[13,3,2,j]\n      dx[14,2,2,j]=dx[14,2,2,j]+RateSuppFirstResis[2]*x[13,2,2,j]-(RateFailFirstResis[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[14,2,2,j]+RateStageSuppFirst[2]*x[14,3,2,j]\n      dx[15,2,2,j]=dx[15,2,2,j]+RateFailFirstResis[2]*x[14,2,2,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,2])*x[15,2,2,j]+RateStageFailFirst[1]*x[15,1,2,j]\n      \n      dx[9,3,2,j]=dx[9,3,2,j]+RateTreatFirstDTG[2,3,j]*x[2,3,2,j]+RateSwitchDTG[3,3,2,j]*x[5,3,2,j]+RateSwitchDTG[1,3,2,j]*x[3,3,2,j]-(RateSuppFirstDTG[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[9,3,2,j]+RateStageTreatFirstR[2]*x[9,2,2,j]+RateStageTreatFirstL[3]*x[9,4,2,j]\n      dx[10,3,2,j]=RateSuppFirstDTG[3]*x[9,3,2,j]-(RateFailFirstDTG[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[10,3,2,j]+RateStageSuppFirst[3]*x[10,4,2,j]+RateSwitchDTG[2,3,2,j]*x[4,3,2,j]\n      dx[11,3,2,j]=RateFailFirstDTG[3]*x[10,3,2,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,2])*x[11,3,2,j]+RateStageFailFirst[2]*x[11,2,2,j]\n      dx[12,3,2,j]=dx[12,3,2,j]+RateDiag[3,j]*((j==2)*(1-p_women_dtg))*x[1,3,2,j]-(RateTreatFirst_noDTG[2,3,j]+RateStageDiag[3]+mu[2,3,2])*x[12,3,2,j]+RateStageDiag[2]*x[12,2,2,j]\n      dx[13,3,2,j]=dx[13,3,2,j]+RateTreatFirst_noDTG[2,3,j]*x[12,3,2,j]-(RateSuppFirstResis[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[13,3,2,j]+RateStageTreatFirstR[2]*x[13,2,2,j]+RateStageTreatFirstL[3]*x[13,4,2,j]\n      dx[14,3,2,j]=dx[14,3,2,j]+RateSuppFirstResis[3]*x[13,3,2,j]-(RateFailFirstResis[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[14,3,2,j]+RateStageSuppFirst[3]*x[14,4,2,j]\n      dx[15,3,2,j]=dx[15,3,2,j]+RateFailFirstResis[3]*x[14,3,2,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,2])*x[15,3,2,j]+RateStageFailFirst[2]*x[15,2,2,j]\n      \n      dx[9,4,2,j]=dx[9,4,2,j]+RateTreatFirstDTG[2,4,j]*x[2,4,2,j]+RateSwitchDTG[3,4,2,j]*x[5,4,2,j]+RateSwitchDTG[1,4,2,j]*x[3,4,2,j]-(RateSuppFirstDTG[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[9,4,2,j]+RateStageTreatFirstR[3]*x[9,3,2,j]\n      dx[10,4,2,j]=RateSuppFirstDTG[4]*x[9,4,2,j]-(RateFailFirstDTG[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[10,4,2,j]+RateSwitchDTG[2,4,2,j]*x[4,4,2,j]\n      dx[11,4,2,j]=RateFailFirstDTG[4]*x[10,4,2,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,2])*x[11,4,2,j]+RateStageFailFirst[3]*x[11,3,2,j]\n      dx[12,4,2,j]=dx[12,4,2,j]+RateDiag[4,j]*((j==2)*(1-p_women_dtg))*x[1,4,2,j]-(RateTreatFirst_noDTG[2,4,j]+mu[2,4,2])*x[12,4,2,j]+RateStageDiag[3]*x[12,3,2,j]\n      dx[13,4,2,j]=dx[13,4,2,j]+RateTreatFirst_noDTG[2,4,j]*x[12,4,2,j]-(RateSuppFirstResis[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[13,4,2,j]+RateStageTreatFirstR[3]*x[13,3,2,j]\n      dx[14,4,2,j]=dx[14,4,2,j]+RateSuppFirstResis[4]*x[13,4,2,j]-(RateFailFirstResis[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[14,4,2,j]\n      dx[15,4,2,j]=dx[15,4,2,j]+RateFailFirstResis[4]*x[14,4,2,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,2])*x[15,4,2,j]+RateStageFailFirst[3]*x[15,3,2,j]\n      \n      \n      \n      # #DTG compartments-------------------------------------\n      # #NNRTI susceptible\n      # dx[9,1,1,j]=dx[9,1,1,j]+RateTreatFirstDTG[1,1,j]*x[2,1,1,j]+RateSwitchDTG[1,1,1,j]*x[3,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[9,1,1,j]+RateStageTreatFirstL[1]*x[9,2,1,j]\n      # dx[10,1,1,j]=RateSwitchDTG[2,1,1,j]*x[4,1,1,j]+RateSuppFirstSusc[1]*x[9,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[10,1,1,j]+RateStageSuppFirst[1]*x[10,2,1,j]\n      # dx[11,1,1,j]=RateSwitchDTG[3,1,1,j]*x[5,1,1,j]+RateFailFirstSusc[1]*x[10,1,1,j]-(RateStageFailFirst[1]+mu[5,1,1])*x[11,1,1,j]\n      # \n      # dx[9,2,1,j]=dx[9,2,1,j]+RateTreatFirstDTG[1,2,j]*x[2,2,1,j]+RateSwitchDTG[1,2,1,j]*x[3,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[9,2,1,j]+RateStageTreatFirstR[1]*x[9,1,1,j]+RateStageTreatFirstL[2]*x[9,3,1,j]\n      # dx[10,2,1,j]=RateSwitchDTG[2,2,1,j]*x[4,2,1,j]+RateSuppFirstSusc[2]*x[9,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[10,2,1,j]+RateStageSuppFirst[2]*x[10,3,1,j]\n      # dx[11,2,1,j]=RateSwitchDTG[3,2,1,j]*x[5,2,1,j]+RateFailFirstSusc[2]*x[10,2,1,j]-(RateStageFailFirst[2]+mu[5,2,1])*x[11,2,1,j]+RateStageFailFirst[1]*x[11,1,1,j]\n      # \n      # dx[9,3,1,j]=dx[9,3,1,j]+RateTreatFirstDTG[1,3,j]*x[2,3,1,j]+RateSwitchDTG[1,3,1,j]*x[3,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[9,3,1,j]+RateStageTreatFirstR[2]*x[9,2,1,j]+RateStageTreatFirstL[3]*x[9,4,1,j]\n      # dx[10,3,1,j]=RateSwitchDTG[2,3,1,j]*x[4,3,1,j]+RateSuppFirstSusc[3]*x[9,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[10,3,1,j]+RateStageSuppFirst[3]*x[10,4,1,j]\n      # dx[11,3,1,j]=RateSwitchDTG[3,3,1,j]*x[5,3,1,j]+RateFailFirstSusc[3]*x[10,3,1,j]-(RateStageFailFirst[3]+mu[5,3,1])*x[11,3,1,j]+RateStageFailFirst[2]*x[11,2,1,j]\n      # \n      # dx[9,4,1,j]=dx[9,4,1,j]+RateTreatFirstDTG[1,4,j]*x[2,4,1,j]+RateSwitchDTG[1,4,1,j]*x[3,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[9,4,1,j]+RateStageTreatFirstR[3]*x[9,3,1,j]\n      # dx[10,4,1,j]=RateSwitchDTG[2,4,1,j]*x[4,4,1,j]+RateSuppFirstSusc[4]*x[9,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[10,4,1,j]\n      # dx[11,4,1,j]=RateSwitchDTG[3,4,1,j]*x[5,4,1,j]+RateFailFirstSusc[4]*x[10,4,1,j]-(mu[5,4,1])*x[11,4,1,j]+RateStageFailFirst[3]*x[11,3,1,j]\n      # ##############################################################################################################################################################\n      \n      dx[9,1,1,j]=dx[9,1,1,j]-RateStopTreatFirst[1]*x[9,1,1,j]-RateTreatToFailFirstDTG[1]*x[9,1,1,j]\n      dx[10,1,1,j]=dx[10,1,1,j]-RateStopSuppFirst[1]*x[10,1,1,j]+RateFailToSuppTreatFirstDTG[1]*x[11,1,1,j]\n      dx[11,1,1,j]=dx[11,1,1,j]-RateStopFailFirst[1]*x[11,1,1,j]-RateFailToSuppTreatFirstDTG[1]*x[11,1,1,j]+RateTreatToFailFirstDTG[1]*x[9,1,1,j]\n      dx[12,1,1,j]=dx[12,1,1,j]-RateDirectTreatSecond[1,1]*x[12,1,1,j]+RateStopTreatFirst[1]*x[13,1,1,j]+RateStopSuppFirst[1]*x[14,1,1,j]+RateStopFailFirst[1]*x[15,1,1,j]+\n        (RateStopTreatSecond[1]*x[6,1,1,j]+RateStopSuppSecond[1]*x[7,1,1,j]+RateStopFailSecond[1]*x[8,1,1,j])*((j==2)*(1-p_women_dtg))\n      dx[13,1,1,j]=dx[13,1,1,j]-RateStopTreatFirst[1]*x[13,1,1,j]-RateTreatToFailFirstSusc[1]*x[13,1,1,j]\n      dx[14,1,1,j]=dx[14,1,1,j]-RateStopSuppFirst[1]*x[14,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[15,1,1,j]-RateSuppFirstToSecond[1]*x[14,1,1,j]\n      dx[15,1,1,j]=dx[15,1,1,j]-RateStopFailFirst[1]*x[15,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[15,1,1,j]+RateTreatToFailFirstSusc[1]*x[13,1,1,j]\n      \n      dx[9,2,1,j]=dx[9,2,1,j]-RateStopTreatFirst[2]*x[9,2,1,j]-RateTreatToFailFirstDTG[2]*x[9,2,1,j]\n      dx[10,2,1,j]=dx[10,2,1,j]-RateStopSuppFirst[2]*x[10,2,1,j]+RateFailToSuppTreatFirstDTG[2]*x[11,2,1,j]-RateSuppFirstToSecond[2]*x[10,2,1,j]\n      dx[11,2,1,j]=dx[11,2,1,j]-RateStopFailFirst[2]*x[11,2,1,j]-RateFailToSuppTreatFirstDTG[2]*x[11,2,1,j]+RateTreatToFailFirstDTG[2]*x[9,2,1,j]\n      dx[12,2,1,j]=dx[12,2,1,j]-RateDirectTreatSecond[1,2]*x[12,2,1,j]+RateStopTreatFirst[2]*x[13,2,1,j]+RateStopSuppFirst[2]*x[14,2,1,j]+RateStopFailFirst[2]*x[15,2,1,j]+\n        (RateStopTreatSecond[2]*x[6,2,1,j]+RateStopSuppSecond[2]*x[7,2,1,j]+RateStopFailSecond[2]*x[8,2,1,j])*((j==2)*(1-p_women_dtg))\n      dx[13,2,1,j]=dx[13,2,1,j]-RateStopTreatFirst[2]*x[13,2,1,j]-RateTreatToFailFirstSusc[2]*x[13,2,1,j]\n      dx[14,2,1,j]=dx[14,2,1,j]-RateStopSuppFirst[2]*x[14,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[15,2,1,j]-RateSuppFirstToSecond[2]*x[14,2,1,j]\n      dx[15,2,1,j]=dx[15,2,1,j]-RateStopFailFirst[2]*x[15,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[15,2,1,j]+RateTreatToFailFirstSusc[2]*x[13,2,1,j]\n      \n      dx[9,3,1,j]=dx[9,3,1,j]-RateStopTreatFirst[3]*x[9,3,1,j]-RateTreatToFailFirstDTG[3]*x[9,3,1,j]\n      dx[10,3,1,j]=dx[10,3,1,j]-RateStopSuppFirst[3]*x[10,3,1,j]+RateFailToSuppTreatFirstDTG[3]*x[11,3,1,j]\n      dx[11,3,1,j]=dx[11,3,1,j]-RateStopFailFirst[3]*x[11,3,1,j]-RateFailToSuppTreatFirstDTG[3]*x[11,3,1,j]+RateTreatToFailFirstDTG[3]*x[9,3,1,j]\n      dx[12,3,1,j]=dx[12,3,1,j]-RateDirectTreatSecond[1,3]*x[12,3,1,j]+RateStopTreatFirst[3]*x[13,3,1,j]+RateStopSuppFirst[3]*x[14,3,1,j]+RateStopFailFirst[3]*x[15,3,1,j]+\n        (RateStopTreatSecond[3]*x[6,3,1,j]+RateStopSuppSecond[3]*x[7,3,1,j]+RateStopFailSecond[3]*x[8,3,1,j])*((j==2)*(1-p_women_dtg))\n      dx[13,3,1,j]=dx[13,3,1,j]-RateStopTreatFirst[3]*x[13,3,1,j]-RateTreatToFailFirstSusc[3]*x[13,3,1,j]\n      dx[14,3,1,j]=dx[14,3,1,j]-RateStopSuppFirst[3]*x[14,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[15,3,1,j]-RateSuppFirstToSecond[3]*x[14,3,1,j]\n      dx[15,3,1,j]=dx[15,3,1,j]-RateStopFailFirst[3]*x[15,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[15,3,1,j]+RateTreatToFailFirstSusc[3]*x[13,3,1,j]\n      \n      dx[9,4,1,j]=dx[9,4,1,j]-RateStopTreatFirst[4]*x[9,4,1,j]-RateTreatToFailFirstDTG[4]*x[9,4,1,j]\n      dx[10,4,1,j]=dx[10,4,1,j]-RateStopSuppFirst[4]*x[10,4,1,j]+RateFailToSuppTreatFirstDTG[4]*x[11,4,1,j]\n      dx[11,4,1,j]=dx[11,4,1,j]-RateStopFailFirst[4]*x[11,4,1,j]-RateFailToSuppTreatFirstDTG[4]*x[11,4,1,j]+RateTreatToFailFirstDTG[4]*x[9,4,1,j]\n      dx[12,4,1,j]=dx[12,4,1,j]-RateDirectTreatSecond[1,4]*x[12,4,1,j]+RateStopTreatFirst[4]*x[13,4,1,j]+RateStopSuppFirst[4]*x[14,4,1,j]+RateStopFailFirst[4]*x[15,4,1,j]+\n        (RateStopTreatSecond[4]*x[6,4,1,j]+RateStopSuppSecond[4]*x[7,4,1,j]+RateStopFailSecond[4]*x[8,4,1,j])*((j==2)*(1-p_women_dtg))\n      dx[13,4,1,j]=dx[13,4,1,j]-RateStopTreatFirst[4]*x[13,4,1,j]-RateTreatToFailFirstSusc[4]*x[13,4,1,j]\n      dx[14,4,1,j]=dx[14,4,1,j]-RateStopSuppFirst[4]*x[14,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[15,4,1,j]-RateSuppFirstToSecond[4]*x[14,4,1,j]\n      dx[15,4,1,j]=dx[15,4,1,j]-RateStopFailFirst[4]*x[15,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[15,4,1,j]+RateTreatToFailFirstSusc[4]*x[13,4,1,j]\n      \n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      #NNRTI resistant\n      # dx[9,1,2,j]=dx[9,1,2,j]+RateTreatFirstDTG[2,1,j]*x[2,1,2,j]+RateSwitchDTG[1,1,2,j]*x[3,1,2,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[9,1,2,j]+RateStageTreatFirstL[1]*x[9,2,2,j]\n      # dx[10,1,2,j]=RateSwitchDTG[2,1,2,j]*x[4,1,2,j]+RateSuppFirstSusc[1]*x[9,1,2,j]-(RateFailFirstSusc[1]+mu[4,1,2])*x[10,1,2,j]+RateStageSuppFirst[1]*x[10,2,2,j]\n      # dx[11,1,2,j]=RateSwitchDTG[3,1,2,j]*x[5,1,2,j]+RateFailFirstSusc[1]*x[10,1,2,j]-(RateStageFailFirst[1]+mu[5,1,2])*x[11,1,2,j]\n      # \n      # dx[9,2,2,j]=dx[9,2,2,j]+RateTreatFirstDTG[2,2,j]*x[2,2,2,j]+RateSwitchDTG[1,2,2,j]*x[3,2,2,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[9,2,2,j]+RateStageTreatFirstR[1]*x[9,1,2,j]+RateStageTreatFirstL[2]*x[9,3,2,j]\n      # dx[10,2,2,j]=RateSwitchDTG[2,2,2,j]*x[4,2,2,j]+RateSuppFirstSusc[2]*x[9,2,2,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[10,2,2,j]+RateStageSuppFirst[2]*x[10,3,2,j]\n      # dx[11,2,2,j]=RateSwitchDTG[3,2,2,j]*x[5,2,2,j]+RateFailFirstSusc[2]*x[10,2,2,j]-(RateStageFailFirst[2]+mu[5,2,2])*x[11,2,2,j]+RateStageFailFirst[1]*x[11,1,2,j]\n      # \n      # dx[9,3,2,j]=dx[9,3,2,j]+RateTreatFirstDTG[2,3,j]*x[2,3,2,j]+RateSwitchDTG[1,3,2,j]*x[3,3,2,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[9,3,2,j]+RateStageTreatFirstR[2]*x[9,2,2,j]+RateStageTreatFirstL[3]*x[9,4,2,j]\n      # dx[10,3,2,j]=RateSwitchDTG[2,3,2,j]*x[4,3,2,j]+RateSuppFirstSusc[3]*x[9,3,2,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[10,3,2,j]+RateStageSuppFirst[3]*x[10,4,2,j]\n      # dx[11,3,2,j]=RateSwitchDTG[3,3,2,j]*x[5,3,2,j]+RateFailFirstSusc[3]*x[10,3,2,j]-(RateStageFailFirst[3]+mu[5,3,2])*x[11,3,2,j]+RateStageFailFirst[2]*x[11,2,2,j]\n      # \n      # dx[9,4,2,j]=dx[9,4,2,j]+RateTreatFirstDTG[2,4,j]*x[2,4,2,j]+RateSwitchDTG[1,4,2,j]*x[3,4,2,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[9,4,2,j]+RateStageTreatFirstR[3]*x[9,3,2,j]\n      # dx[10,4,2,j]=RateSwitchDTG[2,4,2,j]*x[4,4,2,j]+RateSuppFirstSusc[4]*x[9,4,2,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[10,4,2,j]\n      # dx[11,4,2,j]=RateSwitchDTG[3,4,2,j]*x[5,4,2,j]+RateFailFirstSusc[4]*x[10,4,2,j]-(mu[5,4,2])*x[11,4,2,j]+RateStageFailFirst[3]*x[11,3,2,j]\n      ##############################################################################################################################################################\n      \n      dx[9,1,2,j]=dx[9,1,2,j]-RateStopTreatFirst[1]*x[9,1,2,j]-RateTreatToFailFirstDTG[1]*x[9,1,2,j]\n      dx[10,1,2,j]=dx[10,1,2,j]-RateStopSuppFirst[1]*x[10,1,2,j]+RateFailToSuppTreatFirstDTG[1]*x[11,1,2,j]\n      dx[11,1,2,j]=dx[11,1,2,j]-RateStopFailFirst[1]*x[11,1,2,j]-RateFailToSuppTreatFirstDTG[1]*x[11,1,2,j]+RateTreatToFailFirstDTG[1]*x[9,1,2,j]\n      dx[12,1,2,j]=dx[12,1,2,j]-RateDirectTreatSecond[2,1]*x[12,1,2,j]+RateStopTreatFirst[1]*x[13,1,2,j]+RateStopSuppFirst[1]*x[14,1,2,j]+RateStopFailFirst[1]*x[15,1,2,j]+\n        (RateStopTreatSecond[1]*x[6,1,2,j]+RateStopSuppSecond[1]*x[7,1,2,j]+RateStopFailSecond[1]*x[8,1,2,j])*((j==2)*(1-p_women_dtg))\n      dx[13,1,2,j]=dx[13,1,2,j]-RateStopTreatFirst[1]*x[13,1,2,j]-RateTreatToFailFirstResis[1]*x[13,1,2,j]\n      dx[14,1,2,j]=dx[14,1,2,j]-RateStopSuppFirst[1]*x[14,1,2,j]+RateFailToSuppTreatFirstResis[1]*x[15,1,2,j]-RateSuppFirstToSecond[1]*x[14,1,2,j]\n      dx[15,1,2,j]=dx[15,1,2,j]-RateStopFailFirst[1]*x[15,1,2,j]-RateFailToSuppTreatFirstResis[1]*x[15,1,2,j]+RateTreatToFailFirstResis[1]*x[13,1,2,j]\n      \n      dx[9,2,2,j]=dx[9,2,2,j]-RateStopTreatFirst[2]*x[9,2,2,j]-RateTreatToFailFirstDTG[2]*x[9,2,2,j]\n      dx[10,2,2,j]=dx[10,2,2,j]-RateStopSuppFirst[2]*x[10,2,2,j]+RateFailToSuppTreatFirstDTG[2]*x[11,2,2,j]\n      dx[11,2,2,j]=dx[11,2,2,j]-RateStopFailFirst[2]*x[11,2,2,j]-RateFailToSuppTreatFirstDTG[2]*x[11,2,2,j]+RateTreatToFailFirstDTG[2]*x[9,2,2,j]\n      dx[12,2,2,j]=dx[12,2,2,j]-RateDirectTreatSecond[2,2]*x[12,2,2,j]+RateStopTreatFirst[2]*x[13,2,2,j]+RateStopSuppFirst[2]*x[14,2,2,j]+RateStopFailFirst[2]*x[15,2,2,j]+\n        (RateStopTreatSecond[2]*x[6,2,2,j]+RateStopSuppSecond[2]*x[7,2,2,j]+RateStopFailSecond[2]*x[8,2,2,j])*((j==2)*(1-p_women_dtg))\n      dx[13,2,2,j]=dx[13,2,2,j]-RateStopTreatFirst[2]*x[13,2,2,j]-RateTreatToFailFirstResis[2]*x[13,2,2,j]\n      dx[14,2,2,j]=dx[14,2,2,j]-RateStopSuppFirst[2]*x[14,2,2,j]+RateFailToSuppTreatFirstResis[2]*x[15,2,2,j]-RateSuppFirstToSecond[2]*x[14,2,2,j]\n      dx[15,2,2,j]=dx[15,2,2,j]-RateStopFailFirst[2]*x[15,2,2,j]-RateFailToSuppTreatFirstResis[2]*x[15,2,2,j]+RateTreatToFailFirstResis[2]*x[13,2,2,j]\n      \n      dx[9,3,2,j]=dx[9,3,2,j]-RateStopTreatFirst[3]*x[9,3,2,j]-RateTreatToFailFirstDTG[3]*x[9,3,2,j]\n      dx[10,3,2,j]=dx[10,3,2,j]-RateStopSuppFirst[3]*x[10,3,2,j]+RateFailToSuppTreatFirstDTG[3]*x[11,3,2,j]\n      dx[11,3,2,j]=dx[11,3,2,j]-RateStopFailFirst[3]*x[11,3,2,j]-RateFailToSuppTreatFirstDTG[3]*x[11,3,2,j]+RateTreatToFailFirstDTG[3]*x[9,3,2,j]\n      dx[12,3,2,j]=dx[12,3,2,j]-RateDirectTreatSecond[2,3]*x[12,3,2,j]+RateStopTreatFirst[3]*x[13,3,2,j]+RateStopSuppFirst[3]*x[14,3,2,j]+RateStopFailFirst[3]*x[15,3,2,j]+\n        (RateStopTreatSecond[3]*x[6,3,2,j]+RateStopSuppSecond[3]*x[7,3,2,j]+RateStopFailSecond[3]*x[8,3,2,j])*((j==2)*(1-p_women_dtg))\n      dx[13,3,2,j]=dx[13,3,2,j]-RateStopTreatFirst[3]*x[13,3,2,j]-RateTreatToFailFirstResis[3]*x[13,3,2,j]\n      dx[14,3,2,j]=dx[14,3,2,j]-RateStopSuppFirst[3]*x[14,3,2,j]+RateFailToSuppTreatFirstResis[3]*x[15,3,2,j]-RateSuppFirstToSecond[3]*x[14,3,2,j]\n      dx[15,3,2,j]=dx[15,3,2,j]-RateStopFailFirst[3]*x[15,3,2,j]-RateFailToSuppTreatFirstResis[3]*x[15,3,2,j]+RateTreatToFailFirstResis[3]*x[13,3,2,j]\n      \n      dx[9,4,2,j]=dx[9,4,2,j]-RateStopTreatFirst[4]*x[9,4,2,j]-RateTreatToFailFirstDTG[4]*x[9,4,2,j]\n      dx[10,4,2,j]=dx[10,4,2,j]-RateStopSuppFirst[4]*x[10,4,2,j]+RateFailToSuppTreatFirstDTG[4]*x[11,4,2,j]\n      dx[11,4,2,j]=dx[11,4,2,j]-RateStopFailFirst[4]*x[11,4,2,j]-RateFailToSuppTreatFirstDTG[4]*x[11,4,2,j]+RateTreatToFailFirstDTG[4]*x[9,4,2,j]\n      dx[12,4,2,j]=dx[12,4,2,j]-RateDirectTreatSecond[2,4]*x[12,4,2,j]+RateStopTreatFirst[4]*x[13,4,2,j]+RateStopSuppFirst[4]*x[14,4,2,j]+RateStopFailFirst[4]*x[15,4,2,j]+\n        (RateStopTreatSecond[4]*x[6,4,2,j]+RateStopSuppSecond[4]*x[7,4,2,j]+RateStopFailSecond[4]*x[8,4,2,j])*((j==2)*(1-p_women_dtg))\n      dx[13,4,2,j]=dx[13,4,2,j]-RateStopTreatFirst[4]*x[13,4,2,j]-RateTreatToFailFirstResis[4]*x[13,4,2,j]\n      dx[14,4,2,j]=dx[14,4,2,j]-RateStopSuppFirst[4]*x[14,4,2,j]+RateFailToSuppTreatFirstResis[4]*x[15,4,2,j]-RateSuppFirstToSecond[4]*x[14,4,2,j]\n      dx[15,4,2,j]=dx[15,4,2,j]-RateStopFailFirst[4]*x[15,4,2,j]-RateFailToSuppTreatFirstResis[4]*x[15,4,2,j]+RateTreatToFailFirstResis[4]*x[13,4,2,j]\n      \n      \n      \n      #Resistance acquisition and reversion\n      dx[12,1,2,j]=dx[12,1,2,j]-RateSusceptible*x[12,1,2,j]\n      dx[15,1,2,j]=dx[15,1,2,j]+RateResistant*x[15,1,1,j]\n      dx[12,2,2,j]=dx[12,2,2,j]-RateSusceptible*x[12,2,2,j]\n      dx[15,2,2,j]=dx[15,2,2,j]+RateResistant*x[15,2,1,j]\n      dx[12,3,2,j]=dx[12,3,2,j]-RateSusceptible*x[12,3,2,j]\n      dx[15,3,2,j]=dx[15,3,2,j]+RateResistant*x[15,3,1,j]\n      dx[12,4,2,j]=dx[12,4,2,j]-RateSusceptible*x[12,4,2,j]\n      dx[15,4,2,j]=dx[15,4,2,j]+RateResistant*x[15,4,1,j]\n      \n      dx[12,1,1,j]=dx[12,1,1,j]+RateSusceptible*x[12,1,2,j]\n      dx[15,1,1,j]=dx[15,1,1,j]-RateResistant*x[15,1,1,j]\n      dx[12,2,1,j]=dx[12,2,1,j]+RateSusceptible*x[12,2,2,j]\n      dx[15,2,1,j]=dx[15,2,1,j]-RateResistant*x[15,2,1,j]\n      dx[12,3,1,j]=dx[12,3,1,j]+RateSusceptible*x[12,3,2,j]\n      dx[15,3,1,j]=dx[15,3,1,j]-RateResistant*x[15,3,1,j]\n      dx[12,4,1,j]=dx[12,4,1,j]+RateSusceptible*x[12,4,2,j]\n      dx[15,4,1,j]=dx[15,4,1,j]-RateResistant*x[15,4,1,j]\n      \n    }\n    dx[x+dx<0]=0\n    #dx[12:15,1:4,1:2,1]=0\n    #new_infections\n    new_inf=S[1]/N[1]*(sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,1:2,1:2],c(1,3),sum))+\n                         sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8,9,11,12,13,15),1:4,1:2,1:2],c(2,4),sum)))+\n      S[2]/N[2]*(sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,1:2,1:2],c(1,3),sum))+\n                   sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8,9,11,12,13,15),1:4,1:2,1:2],c(2,4),sum)))\n    #death\n    death=sum(apply(x[1:8,1:4,1:2,1:2],c(1,2,3),sum)*mu)+sum(apply(x[12,1:4,1:2,1:2],c(1,2),sum)*mu[2,1:4,1:2])+\n      sum(apply(x[9:11,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])+sum(apply(x[13:15,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    death_w=sum(x[1:8,1:4,1:2,2]*mu)+sum(x[12,1:4,1:2,2]*mu[2,1:4,1:2])+\n      sum(x[9:11,1:4,1:2,2]*mu[3:5,1:4,1:2])+sum(x[13:15,1:4,1:2,2]*mu[3:5,1:4,1:2])\n    death_w_nnrti=sum(x[3:5,1:4,1:2,2]*mu[3:5,1:4,1:2])+sum(x[13:15,1:4,1:2,2]*mu[3:5,1:4,1:2])\n    death_w_inel=sum(x[13:15,1:4,1:2,2]*mu[3:5,1:4,1:2])\n    \n    death2=sum(apply(x[3:5,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    death3=sum(apply(x[13:15,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    death4=sum(apply(x[9:11,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    death5=sum(apply(x[2,1:4,1:2,1:2],c(1,2),sum)*mu[2,1:4,1:2])\n    #new_infections resistant\n    new_inf_res=S[1]/N[1]*(sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+\n                             sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8,9,11,12,13,15),1:4,2,1:2],c(2,3),sum)))+\n      S[2]/N[2]*(sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+\n                   sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8,9,11,12,13,15),1:4,2,1:2],c(2,3),sum)))\n    \n    n1=S[1]/N[1]*sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))#susc inf\n    n2=S[1]/N[1]*sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8,9,11),1:4,2,1:2],c(2,3),sum))#susc diag\n    n3=S[2]/N[2]*sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))#res inf\n    n4=S[2]/N[2]*sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8,9,11),1:4,2,1:2],c(2,3),sum))#res diag\n    #death resistant\n    death_res=sum(apply(x[1:8,1:4,2,1:2],c(1,2),sum)*mu[1:8,1:4,2])+sum(apply(x[12,1:4,2,1:2],c(1),sum)*mu[2,1:4,2])+\n      sum(apply(x[9:11,1:4,2,1:2],c(1,2),sum)*mu[3:5,1:4,2])+sum(apply(x[13:15,1:4,2,1:2],c(1,2),sum)*mu[3:5,1:4,2])\n    \n    \n    death_treat=sum(apply(x[3:8,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:8,1:4,1:2])+\n      sum(apply(x[9:11,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])+sum(apply(x[13:15,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    death_treat_res=sum(apply(x[3:8,1:4,2,1:2],c(1,2),sum)*mu[3:8,1:4,2])+\n      sum(apply(x[9:11,1:4,2,1:2],c(1,2),sum)*mu[3:5,1:4,2])+sum(apply(x[13:15,1:4,2,1:2],c(1,2),sum)*mu[3:5,1:4,2])\n    \n    \n    new_treat=sum(RateTreatFirst[1:2,1:4,1:2]*aperm(x[2,1:4,1:2,1:2],perm=c(2,1,3)))+\n      sum(RateTreatFirstDTG[1:2,1:4,1:2]*aperm(x[2,1:4,1:2,1:2],perm=c(2,1,3)))+\n      sum(RateDirectTreatSecond[1:2,1:4]*aperm(apply(x[2,1:4,1:2,1:2],c(1,2),sum),c(2,1)))+\n      sum(RateTreatFirst[1:2,1:4,1:2]*aperm(x[12,1:4,1:2,1:2],perm=c(2,1,3)))+\n      sum(RateDirectTreatSecond[1:2,1:4]*aperm(apply(x[12,1:4,1:2,1:2],c(1,2),sum),c(2,1)))\n    \n    \n    new_treat_res=sum(RateTreatFirst[2,1:4,1:2]*x[2,1:4,2,1:2])+\n      sum(RateTreatFirstDTG[2,1:4,1:2]*x[2,1:4,2,1:2])+\n      sum(RateDirectTreatSecond[2,1:4]*apply(x[2,1:4,2,1:2],c(1),sum))+\n      sum(RateTreatFirst[2,1:4,1:2]*x[12,1:4,2,1:2])+\n      sum(RateDirectTreatSecond[2,1:4]*apply(x[12,1:4,2,1:2],c(1),sum))\n    \n    death_diag=sum(apply(x[12,1:4,1:2,1:2],c(1,2),sum)*mu[2,1:4,1:2])+sum(apply(x[2,1:4,1:2,1:2],c(1,2),sum)*mu[2,1:4,1:2])\n    death_diag_res=sum(apply(x[12,1:4,2,1:2],c(1),sum)*mu[2,1:4,2])+sum(apply(x[2,1:4,2,1:2],c(1),sum)*mu[2,1:4,2])\n    \n    new_diag=sum(RateDiag[1:4,1:2]*apply(x[1,1:4,1:2,1:2],c(1,3),sum))\n    new_diag_res=sum(RateDiag[1:4,1:2]*apply(x[1,1:4,2,1:2],c(1,2),sum))\n    \n    \n    #why last cd4 class go down quicker in res than in susc\n    new_pi_susc=sum(apply(RateDirectTreatSecond[1:2,1:4],c(2),sum)*apply(x[c(2,12),1:4,1,1:2],c(2),sum))+\n      sum(RateTreatSecond[1:4,1:2]*x[c(5),1:4,1,1:2])+\n      sum(RateTreatSecond_noDTG[1:4,1:2]*apply(x[c(5,15),1:4,1,1:2],c(2,3),sum))\n    new_pi_res=sum(apply(RateDirectTreatSecond[1:2,1:4],c(2),sum)*apply(x[c(2,12),1:4,2,1:2],c(2),sum))+\n      sum(RateTreatSecond[1:4,1:2]*x[c(5),1:4,2,1:2])+\n      sum(RateTreatSecond_noDTG[1:4,1:2]*apply(x[c(5,15),1:4,2,1:2],c(2,3),sum))\n    new_pi_susc_4=sum(RateDirectTreatSecond[1:2,4]*apply(x[c(2,12),4,1,1:2],c(2),sum))+\n      sum(RateTreatSecond[4,1:2]*x[c(5),4,1,1:2])+\n      sum(RateTreatSecond_noDTG[4,1:2]*apply(x[c(5,15),4,1,1:2],c(2),sum))\n    new_pi_res_4=sum(RateDirectTreatSecond[1:2,4]*apply(x[c(2,12),4,2,1:2],c(2),sum))+\n      sum(RateTreatSecond[4,1:2]*x[c(5),4,2,1:2])+\n      sum(RateTreatSecond_noDTG[4,1:2]*apply(x[c(5,15),4,2,1:2],c(2),sum))\n    \n    \n    m_susc=sum(RateDiag[1:4,1]*x[1,1:4,1,1]+RateDiag[1:4,2]*p_women_dtg*x[1,1:4,1,2])\n    m_res=sum(RateDiag[1:4,1]*x[1,1:4,2,1]+RateDiag[1:4,2]*p_women_dtg*x[1,1:4,2,2])\n    \n    m_susc=m_susc-sum(RateTreatFirst[1,1:4,1]*x[2,1:4,1,1]+RateTreatFirst[1,1:4,2]*x[2,1:4,1,2])\n    m_res=m_res-sum(RateTreatFirst[2,1:4,1]*x[2,1:4,2,1]+RateTreatFirst[2,1:4,2]*x[2,1:4,2,2])\n    \n    m_susc=m_susc-sum(RateDirectTreatSecond[1,1:4]*x[2,1:4,1,1]+RateDirectTreatSecond[1,1:4]*x[2,1:4,1,2])\n    m_res=m_res-sum(RateDirectTreatSecond[2,1:4]*x[2,1:4,2,1]+RateDirectTreatSecond[2,1:4]*x[2,1:4,2,2])\n    \n    m_susc=m_susc-sum(RateTreatFirstDTG[1,1:4,1]*x[2,1:4,1,1]+RateTreatFirstDTG[1,1:4,2]*x[2,1:4,1,2])\n    m_res=m_res-sum(RateTreatFirstDTG[2,1:4,1]*x[2,1:4,2,1]+RateTreatFirstDTG[2,1:4,2]*x[2,1:4,2,2])\n    \n    m_susc=m_susc-sum(mu[2,1:4,1]*x[2,1:4,1,1]+mu[2,1:4,1]*x[2,1:4,1,2])\n    m_res=m_res-sum(mu[2,1:4,2]*x[2,1:4,2,1]+mu[2,1:4,2]*x[2,1:4,2,2])\n    \n    # new_treat_susc=sum(RateTreatFirstDTG[1,1:4,1:2]*x[2,1:4,1,1:2])\n    # new_treat_res=sum(RateTreatFirstDTG[2,1:4,1:2]*x[2,1:4,2,1:2])\n    \n    \n    mort_susc=sum(mu[1,1:4,1]*apply(x[1,1:4,1,1:2],1,sum))\n    mort_res=sum(mu[1,1:4,2]*apply(x[1,1:4,2,1:2],1,sum))\n    \n    # #new_diag_susc=sum(x[2,1:4,1,1:2])\n    # #new_diag_res=sum(x[2,1:4,2,1:2])\n    # mort_susc=sum(mu[2,1:4,1]*apply(x[2,1:4,1,1:2],1,sum))\n    # mort_res=sum(mu[2,1:4,2]*apply(x[2,1:4,2,1:2],1,sum))\n    \n    #################################################################\n    #dtg_impact.R: Resistance parameters and estimate of time to suppression\n    d1=sum(mu[3:4,1:4,1]*apply(x[3:4,1:4,1:2,1:2],c(1,2),sum))\n    d2=sum(mu[5,1:4,1]*apply(x[5,1:4,1:2,1:2],c(1),sum))\n    new_treat2=c(RateTreatFirst_noDTG[1,1:4,1]*x[12,1:4,1,2],\n                RateTreatFirst_noDTG[2,1:4,1]*x[12,1:4,2,2])\n    #dx[3:8,1:4,1,1:2]=dx[3:8,1:4,1,1:2]+infected_m15_month[t+1]*x[3:8,1:4,1,1:2]/sum(x[3:8,1:4,1,1:2])\n    ####################################################################################################################\n    res=c(dx,new_inf,death,new_diag,new_treat,death_treat,new_inf_res,death_res,death_w,death_w_inel,death_w_inel)\n    res_dtg_impact=c(dx,d1,d2,new_treat2)\n    #res=c(dx,sum(RateTreatSecond[1:4,1:2]*apply(x[c(5),1:4,1:2,1:2],c(1,3))),rep(0,9))\n    #res=c(dx,new_inf,death,new_diag,new_treat,death_treat,new_inf_res,death_res,new_diag_res,new_treat_res,death_treat_res)\n    #res=c(dx,new_inf,death,new_diag,new_pi_susc,new_pi_res,new_inf_res,death_res,new_diag_res,new_pi_susc_4,new_pi_res_4)\n    #res=c(dx,new_treat_susc,new_treat_res,new_diag_susc,new_diag_res,mort_susc,mort_res)\n    #res=c(dx,new_inf,death,new_diag,new_treat,death_diag,new_inf_res,death_res,new_diag_res,new_treat_res,death_diag_res)\n    #return(c(res_dtg_impact))\n    return(res_dtg_impact)\n    #})\n  })\n}\nmod_dtg_lsoda=function(t,x,parms){\n  theta=parms[[1]]\n  treat_dtg=parms[[2]]\n  parms1=parms[[3]]\n  p2=parms[[4]]\n  x2=rep(0,250)\n  \n  x2[select_15(3:5,1:4,1:2,1:2)]=x[1:48]\n  x2[241:242]=x[49:50]\n  data=mod_dtg(t,x2,theta,treat_dtgb,params,p2)\n  x2=data[select_15(3:5,1:4,1:2,1:2)]\n  x2=c(x2,data[241:242])\n  \n  return(list(x2))\n}\n\n#18 care stages\nselect_18=function(r1,r2,r3,r4){\n  l1=18\n  l2=4\n  l3=2\n  l4=2\n  ar=array(1:(l1*l2*l3*l4),dim=c(l1,l2,l3,l4))\n  return(as.vector(ar[r1,r2,r3,r4]))\n}\nxstart_2005=function(par,treat_dtg){\n  k1=par[9]\n  k2=par[10]\n  k3=par[11]\n  \n  start_value=array(0,dim=c(15,4,2,2))\n  start_value[1,1:4,1,1:2]=c(undiag_start[1]*repart_f(k1),undiag_start[2]*repart_f(k1))\n  start_value[2,1:4,1,1:2]=c(diag_start[1]*repart_f(k2),diag_start[2]*repart_f(k2))\n  start_value[3,1:4,1,1:2]=c(treat_start[1]*repart_f(k3),treat_start[2]*repart_f(k3))\n  \n  start_value[4,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0\n  start_value[5,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0\n  start_value[3,1:4,1,1:2]=start_value[3,1:4,1,1:2]*1\n  \n  start_value[1:2,1:4,2,1:2]=array(rep(rep(c(0.01,0.01,0.01,0.01),each=2),2),dim=c(2,4,2))*start_value[1:2,1:4,1,1:2]\n  start_value[1:2,1:4,1,1:2]=array(rep(rep(1-c(0.01,0.01,0.01,0.01),each=2),2),dim=c(2,4,2))*start_value[1:2,1:4,1,1:2]\n  start_value[3,1:4,2,1:2]=0.01*start_value[3,1:4,1,1:2]\n  start_value[3,1:4,1,1:2]=0.99*start_value[3,1:4,1,1:2]\n  start_value[4,1:4,2,1:2]=0.01*start_value[4,1:4,1,1:2]\n  start_value[4,1:4,1,1:2]=0.99*start_value[4,1:4,1,1:2]\n  start_value[5,1:4,2,1:2]=0.7*start_value[5,1:4,1,1:2]\n  start_value[5,1:4,1,1:2]=0.3*start_value[5,1:4,1,1:2]\n  \n  start_value[12:15,1:4,1:2,2]=(1-treat_dtg[1])*start_value[2:5,1:4,1:2,2]\n  start_value[2:5,1:4,1:2,2]=treat_dtg[1]*start_value[2:5,1:4,1:2,2]\n  \n  xstart=c(start_value,rep(0,10))\n  return(xstart)\n}\nmod_dtg_18=function(t,x,p1,treat_dtg,parms,p2,comp_time){\n  \n  parms2=mod_rate(t,x,p1,treat_dtg,parms,p2)\n  dx=array(0,dim=c(18,4,2,2))\n  x=array(x,dim=c(18,4,2,2))\n  \n  #Define comp_time globally, used here to fix time from which dtg-ineligible ind go to compartments 16\n  \n  with(as.list(parms2), {\n    for(j in 1:2){\n      #dx[x1,x2,x3,x4] x1:care stages x2:disease progression x3:resistance x4:gender\n      #dx with only interaction with the neighbours in the compartmental model\n      dx[1,1,1,j]=S[j]/N[j]*(sum(RateInf1[1:4,1:2,j]*apply(x[c(1),1:4,1,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,j]*apply(x[c(2,3,5,6,8,9,11,12,13,15,16,18),1:4,1,1:2],c(2,3),sum)))-\n        (RateStageInf[1]+RateDiag[1,j]+mu[1,1,1])*x[1,1,1,j]\n      dx[2,1,1,j]=dx[2,1,1,j]+RateDiag[1,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,1,1,j]-(RateTreatFirst[1,1,j]+RateStageDiag[1]+mu[2,1,1])*x[2,1,1,j]\n      dx[3,1,1,j]=dx[3,1,1,j]+RateTreatFirst[1,1,j]*x[2,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[3,1,1,j]+RateStageTreatFirstL[1]*x[3,2,1,j]\n      dx[4,1,1,j]=RateSuppFirstSusc[1]*x[3,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[4,1,1,j]+RateStageSuppFirst[1]*x[4,2,1,j]\n      dx[5,1,1,j]=RateFailFirstSusc[1]*x[4,1,1,j]-(RateTreatSecond[1,j]+RateStageFailFirst[1]+mu[5,1,1])*x[5,1,1,j]\n      dx[6,1,1,j]=RateTreatSecond_noDTG[1,j]*(x[11,1,1,j]+x[15,1,1,j]+x[18,1,1,j])+RateTreatSecond[1,j]*x[5,1,1,j]-(RateSuppSecond[1]+RateStageTreatSecondR[1]+mu[6,1,1])*x[6,1,1,j]+RateStageTreatSecondL[1]*x[6,2,1,j]\n      dx[7,1,1,j]=RateSuppSecond[1]*x[6,1,1,j]-(RateFailSecond[1]+mu[7,1,1])*x[7,1,1,j]+RateStageSuppSecond[1]*x[7,2,1,j]\n      dx[8,1,1,j]=RateFailSecond[1]*x[7,1,1,j]-(RateStageFailSecond[1]+mu[8,1,1])*x[8,1,1,j]\n      \n      dx[1,2,1,j]=-(RateStageInf[2]+RateDiag[2,j]+mu[1,2,1])*x[1,2,1,j]+RateStageInf[1]*x[1,1,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]+RateDiag[2,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,2,1,j]-(RateTreatFirst[1,2,j]+RateStageDiag[2]+mu[2,2,1])*x[2,2,1,j]+RateStageDiag[1]*x[2,1,1,j]\n      dx[3,2,1,j]=dx[3,2,1,j]+RateTreatFirst[1,2,j]*x[2,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[3,2,1,j]+RateStageTreatFirstR[1]*x[3,1,1,j]+RateStageTreatFirstL[2]*x[3,3,1,j]\n      dx[4,2,1,j]=RateSuppFirstSusc[2]*x[3,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[4,2,1,j]+RateStageSuppFirst[2]*x[4,3,1,j]\n      dx[5,2,1,j]=RateFailFirstSusc[2]*x[4,2,1,j]-(RateTreatSecond[2,j]+RateStageFailFirst[2]+mu[5,2,1])*x[5,2,1,j]+RateStageFailFirst[1]*x[5,1,1,j]\n      dx[6,2,1,j]=RateTreatSecond_noDTG[2,j]*(x[11,2,1,j]+x[15,2,1,j]+x[18,2,1,j])+RateTreatSecond[2,j]*x[5,2,1,j]-(RateSuppSecond[2]+RateStageTreatSecondR[2]+RateStageTreatSecondL[1]+mu[6,2,1])*x[6,2,1,j]+RateStageTreatSecondR[1]*x[6,1,1,j]+RateStageTreatSecondL[2]*x[6,3,1,j]\n      dx[7,2,1,j]=RateSuppSecond[2]*x[6,2,1,j]-(RateFailSecond[2]+RateStageSuppSecond[1]+mu[7,2,1])*x[7,2,1,j]+RateStageSuppSecond[2]*x[7,3,1,j]\n      dx[8,2,1,j]=RateFailSecond[2]*x[7,2,1,j]-(RateStageFailSecond[2]+mu[8,2,1])*x[8,2,1,j]+RateStageFailSecond[1]*x[8,1,1,j]\n      \n      dx[1,3,1,j]=-(RateStageInf[3]+RateDiag[3,j]+mu[1,3,1])*x[1,3,1,j]+RateStageInf[2]*x[1,2,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]+RateDiag[3,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,3,1,j]-(RateTreatFirst[1,3,j]+RateStageDiag[3]+mu[2,3,1])*x[2,3,1,j]+RateStageDiag[2]*x[2,2,1,j]\n      dx[3,3,1,j]=dx[3,3,1,j]+RateTreatFirst[1,3,j]*x[2,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[3,3,1,j]+RateStageTreatFirstR[2]*x[3,2,1,j]+RateStageTreatFirstL[3]*x[3,4,1,j]\n      dx[4,3,1,j]=RateSuppFirstSusc[3]*x[3,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[4,3,1,j]+RateStageSuppFirst[3]*x[4,4,1,j]\n      dx[5,3,1,j]=RateFailFirstSusc[3]*x[4,3,1,j]-(RateTreatSecond[3,j]+RateStageFailFirst[3]+mu[5,3,1])*x[5,3,1,j]+RateStageFailFirst[2]*x[5,2,1,j]\n      dx[6,3,1,j]=RateTreatSecond_noDTG[3,j]*(x[11,3,1,j]+x[15,3,1,j]+x[18,3,1,j])+RateTreatSecond[3,j]*x[5,3,1,j]-(RateSuppSecond[3]+RateStageTreatSecondR[3]+RateStageTreatSecondL[2]+mu[6,3,1])*x[6,3,1,j]+RateStageTreatSecondR[2]*x[6,2,1,j]+RateStageTreatSecondL[3]*x[6,4,1,j]\n      dx[7,3,1,j]=RateSuppSecond[3]*x[6,3,1,j]-(RateFailSecond[3]+RateStageSuppSecond[2]+mu[7,3,1])*x[7,3,1,j]+RateStageSuppSecond[3]*x[7,4,1,j]\n      dx[8,3,1,j]=RateFailSecond[3]*x[7,3,1,j]-(RateStageFailSecond[3]+mu[8,3,1])*x[8,3,1,j]+RateStageFailSecond[2]*x[8,2,1,j]\n      \n      dx[1,4,1,j]=-(RateDiag[4,j]+mu[1,4,1])*x[1,4,1,j]+RateStageInf[3]*x[1,3,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]+RateDiag[4,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,4,1,j]-(RateTreatFirst[1,4,j]+mu[2,4,1])*x[2,4,1,j]+RateStageDiag[3]*x[2,3,1,j]\n      dx[3,4,1,j]=dx[3,4,1,j]+RateTreatFirst[1,4,j]*x[2,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[3,4,1,j]+RateStageTreatFirstR[3]*x[3,3,1,j]\n      dx[4,4,1,j]=RateSuppFirstSusc[4]*x[3,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[4,4,1,j]\n      dx[5,4,1,j]=RateFailFirstSusc[4]*x[4,4,1,j]-(RateTreatSecond[4,j]+mu[5,4,1])*x[5,4,1,j]+RateStageFailFirst[3]*x[5,3,1,j]\n      dx[6,4,1,j]=RateTreatSecond_noDTG[4,j]*(x[11,4,1,j]+x[15,4,1,j]+x[18,4,1,j])+RateTreatSecond[4,j]*x[5,4,1,j]-(RateSuppSecond[4]+RateStageTreatSecondL[3]+mu[6,4,1])*x[6,4,1,j]+RateStageTreatSecondR[3]*x[6,3,1,j]\n      dx[7,4,1,j]=RateSuppSecond[4]*x[6,4,1,j]-(RateFailSecond[4]+RateStageSuppSecond[3]+mu[7,4,1])*x[7,4,1,j]\n      dx[8,4,1,j]=RateFailSecond[4]*x[7,4,1,j]-mu[8,4,1 ]*x[8,4,1,j]+RateStageFailSecond[3]*x[8,3,1,j]\n      \n      ##############################################################################################################################################################\n      \n      dx[1,1,1,j]=dx[1,1,1,j]\n      dx[2,1,1,j]=dx[2,1,1,j]-RateDirectTreatSecond[1,1]*x[2,1,1,j]+RateStopTreatFirst[1]*x[3,1,1,j]+RateStopSuppFirst[1]*x[4,1,1,j]+RateStopFailFirst[1]*x[5,1,1,j]+\n        (RateStopTreatSecond[1]*x[6,1,1,j]+RateStopSuppSecond[1]*x[7,1,1,j]+RateStopFailSecond[1]*x[8,1,1,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,1,1,j]=dx[3,1,1,j]-RateStopTreatFirst[1]*x[3,1,1,j]-RateTreatToFailFirstSusc[1]*x[3,1,1,j]\n      dx[4,1,1,j]=dx[4,1,1,j]-RateStopSuppFirst[1]*x[4,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[5,1,1,j]-RateSuppFirstToSecond[1]*x[4,1,1,j]\n      dx[5,1,1,j]=dx[5,1,1,j]-RateStopFailFirst[1]*x[5,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[5,1,1,j]+RateTreatToFailFirstSusc[1]*x[3,1,1,j]\n      dx[6,1,1,j]=dx[6,1,1,j]-RateStopTreatSecond[1]*x[6,1,1,j]+RateDirectTreatSecond[1,1]*x[2,1,1,j]+RateDirectTreatSecond[1,1]*x[12,1,1,j]-RateTreatToFailSecond[1]*x[6,1,1,j]\n      dx[7,1,1,j]=dx[7,1,1,j]-RateStopSuppSecond[1]*x[7,1,1,j]+RateFailToSuppTreatSecond[1]*x[8,1,1,j]+RateSuppFirstToSecond[1]*(x[4,1,1,j]+x[14,1,1,j]+x[17,1,1,j])\n      dx[8,1,1,j]=dx[8,1,1,j]-RateStopFailSecond[1]*x[8,1,1,j]-RateFailToSuppTreatSecond[1]*x[8,1,1,j]+RateTreatToFailSecond[1]*x[6,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]-RateDirectTreatSecond[1,2]*x[2,2,1,j]+RateStopTreatFirst[2]*x[3,2,1,j]+RateStopSuppFirst[2]*x[4,2,1,j]+RateStopFailFirst[2]*x[5,2,1,j]+\n        (RateStopTreatSecond[2]*x[6,2,1,j]+RateStopSuppSecond[2]*x[7,2,1,j]+RateStopFailSecond[2]*x[8,2,1,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,2,1,j]=dx[3,2,1,j]-RateStopTreatFirst[2]*x[3,2,1,j]-RateTreatToFailFirstSusc[2]*x[3,2,1,j]\n      dx[4,2,1,j]=dx[4,2,1,j]-RateStopSuppFirst[2]*x[4,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[5,2,1,j]-RateSuppFirstToSecond[2]*x[4,2,1,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateStopFailFirst[2]*x[5,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[5,2,1,j]+RateTreatToFailFirstSusc[2]*x[3,2,1,j]\n      dx[6,2,1,j]=dx[6,2,1,j]-RateStopTreatSecond[2]*x[6,2,1,j]+RateDirectTreatSecond[1,2]*x[2,2,1,j]+RateDirectTreatSecond[1,2]*x[12,2,1,j]-RateTreatToFailSecond[2]*x[6,2,1,j]\n      dx[7,2,1,j]=dx[7,2,1,j]-RateStopSuppSecond[2]*x[7,2,1,j]+RateFailToSuppTreatSecond[2]*x[8,2,1,j]+RateSuppFirstToSecond[2]*(x[4,2,1,j]+x[14,2,1,j]+x[17,2,1,j])\n      dx[8,2,1,j]=dx[8,2,1,j]-RateStopFailSecond[2]*x[8,2,1,j]-RateFailToSuppTreatSecond[2]*x[8,2,1,j]+RateTreatToFailSecond[2]*x[6,2,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]-RateDirectTreatSecond[1,3]*x[2,3,1,j]+RateStopTreatFirst[3]*x[3,3,1,j]+RateStopSuppFirst[3]*x[4,3,1,j]+RateStopFailFirst[3]*x[5,3,1,j]+\n        (RateStopTreatSecond[3]*x[6,3,1,j]+RateStopSuppSecond[3]*x[7,3,1,j]+RateStopFailSecond[3]*x[8,3,1,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,3,1,j]=dx[3,3,1,j]-RateStopTreatFirst[3]*x[3,3,1,j]-RateTreatToFailFirstSusc[3]*x[3,3,1,j]\n      dx[4,3,1,j]=dx[4,3,1,j]-RateStopSuppFirst[3]*x[4,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[5,3,1,j]-RateSuppFirstToSecond[3]*x[4,3,1,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateStopFailFirst[3]*x[5,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[5,3,1,j]+RateTreatToFailFirstSusc[3]*x[3,3,1,j]\n      dx[6,3,1,j]=dx[6,3,1,j]-RateStopTreatSecond[3]*x[6,3,1,j]+RateDirectTreatSecond[1,3]*x[2,3,1,j]+RateDirectTreatSecond[1,3]*x[12,3,1,j]-RateTreatToFailSecond[3]*x[6,3,1,j]\n      dx[7,3,1,j]=dx[7,3,1,j]-RateStopSuppSecond[3]*x[7,3,1,j]+RateFailToSuppTreatSecond[3]*x[8,3,1,j]+RateSuppFirstToSecond[3]*(x[4,3,1,j]+x[14,3,1,j]+x[17,3,1,j])\n      dx[8,3,1,j]=dx[8,3,1,j]-RateStopFailSecond[3]*x[8,3,1,j]-RateFailToSuppTreatSecond[3]*x[8,3,1,j]+RateTreatToFailSecond[3]*x[6,3,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]-RateDirectTreatSecond[1,4]*x[2,4,1,j]+RateStopTreatFirst[4]*x[3,4,1,j]+RateStopSuppFirst[4]*x[4,4,1,j]+RateStopFailFirst[4]*x[5,4,1,j]+\n        (RateStopTreatSecond[4]*x[6,4,1,j]+RateStopSuppSecond[4]*x[7,4,1,j]+RateStopFailSecond[4]*x[8,4,1,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,4,1,j]=dx[3,4,1,j]-RateStopTreatFirst[4]*x[3,4,1,j]-RateTreatToFailFirstSusc[4]*x[3,4,1,j]\n      dx[4,4,1,j]=dx[4,4,1,j]-RateStopSuppFirst[4]*x[4,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[5,4,1,j]-RateSuppFirstToSecond[4]*x[4,4,1,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateStopFailFirst[4]*x[5,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[5,4,1,j]+RateTreatToFailFirstSusc[4]*x[3,4,1,j]\n      dx[6,4,1,j]=dx[6,4,1,j]-RateStopTreatSecond[4]*x[6,4,1,j]+RateDirectTreatSecond[1,4]*x[2,4,1,j]+RateDirectTreatSecond[1,4]*x[12,4,1,j]-RateTreatToFailSecond[4]*x[6,4,1,j]\n      dx[7,4,1,j]=dx[7,4,1,j]-RateStopSuppSecond[4]*x[7,4,1,j]+RateFailToSuppTreatSecond[4]*x[8,4,1,j]+RateSuppFirstToSecond[4]*(x[4,4,1,j]+x[14,4,1,j]+x[17,4,1,j])\n      dx[8,4,1,j]=dx[8,4,1,j]-RateStopFailSecond[4]*x[8,4,1,j]-RateFailToSuppTreatSecond[4]*x[8,4,1,j]+RateTreatToFailSecond[4]*x[6,4,1,j]\n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      dx[1,1,2,j]=S[j]/N[j]*(sum(RateInf1[1:4,1:2,j]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,j]*apply(x[c(2,3,5,6,8,9,11,12,13,15,16,18),1:4,2,1:2],c(2,3),sum)))-\n        (RateStageInf[1]+RateDiag[1,j]+mu[1,1,2 ])*x[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]+RateDiag[1,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,1,2,j]-(RateTreatFirst[2,1,j]+RateStageDiag[1]+mu[2,1,2])*x[2,1,2,j]\n      dx[3,1,2,j]=dx[3,1,2,j]+RateTreatFirst[2,1,j]*x[2,1,2,j]-(RateSuppFirstResis[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[3,1,2,j]+RateStageTreatFirstL[1]*x[3,2,2,j]\n      dx[4,1,2,j]=RateSuppFirstResis[1]*x[3,1,2,j]-(RateFailFirstResis[1]+mu[4,1,2])*x[4,1,2,j]+RateStageSuppFirst[1]*x[4,2,2,j]\n      dx[5,1,2,j]=RateFailFirstResis[1]*x[4,1,2,j]-(RateTreatSecond[1,j]+RateStageFailFirst[1]+mu[5,1,2 ])*x[5,1,2,j]\n      dx[6,1,2,j]=RateTreatSecond_noDTG[1,j]*(x[11,1,2,j]+x[15,1,2,j]+x[18,1,2,j])+RateTreatSecond[1,j]*x[5,1,2,j]-(RateSuppSecond[1]+RateStageTreatSecondR[1]+mu[6,1,2])*x[6,1,2,j]+RateStageTreatSecondL[1]*x[6,2,2,j]\n      dx[7,1,2,j]=RateSuppSecond[1]*x[6,1,2,j]-(RateFailSecond[1]+mu[7,1,2])*x[7,1,2,j]+RateStageSuppSecond[1]*x[7,2,2,j]\n      dx[8,1,2,j]=RateFailSecond[1]*x[7,1,2,j]-(RateStageFailSecond[1]+mu[8,1,2])*x[8,1,2,j]\n      \n      dx[1,2,2,j]=-(RateStageInf[2]+RateDiag[2,j]+mu[1,2,2])*x[1,2,2,j]+RateStageInf[1]*x[1,1,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]+RateDiag[2,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,2,2,j]-(RateTreatFirst[2,2,j]+RateStageDiag[2]+mu[2,2,2])*x[2,2,2,j]+RateStageDiag[1]*x[2,1,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]+RateTreatFirst[2,2,j]*x[2,2,2,j]-(RateSuppFirstResis[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[3,2,2,j]+RateStageTreatFirstR[1]*x[3,1,2,j]+RateStageTreatFirstL[2]*x[3,3,2,j]\n      dx[4,2,2,j]=RateSuppFirstResis[2]*x[3,2,2,j]-(RateFailFirstResis[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[4,2,2,j]+RateStageSuppFirst[2]*x[4,3,2,j]\n      dx[5,2,2,j]=RateFailFirstResis[2]*x[4,2,2,j]-(RateTreatSecond[2,j]+RateStageFailFirst[2]+mu[5,2,2])*x[5,2,2,j]+RateStageFailFirst[1]*x[5,1,2,j]\n      dx[6,2,2,j]=RateTreatSecond_noDTG[2,j]*(x[11,2,2,j]+x[15,2,2,j]+x[18,2,2,j])+RateTreatSecond[2,j]*x[5,2,2,j]-(RateSuppSecond[2]+RateStageTreatSecondR[2]+RateStageTreatSecondL[1]+mu[6,2,2])*x[6,2,2,j]+RateStageTreatSecondR[1]*x[6,1,2,j]+RateStageTreatSecondL[2]*x[6,3,2,j]\n      dx[7,2,2,j]=RateSuppSecond[2]*x[6,2,2,j]-(RateFailSecond[2]+RateStageSuppSecond[1]+mu[7,2,2])*x[7,2,2,j]+RateStageSuppSecond[2]*x[7,3,2,j]\n      dx[8,2,2,j]=RateFailSecond[2]*x[7,2,2,j]-(RateStageFailSecond[2]+mu[8,2,2])*x[8,2,2,j]+RateStageFailSecond[1]*x[8,1,2,j]\n      \n      dx[1,3,2,j]=-(RateStageInf[3]+RateDiag[3,j]+mu[1,3,2])*x[1,3,2,j]+RateStageInf[2]*x[1,2,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]+RateDiag[3,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,3,2,j]-(RateTreatFirst[2,3,j]+RateStageDiag[3]+mu[2,3,2])*x[2,3,2,j]+RateStageDiag[2]*x[2,2,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]+RateTreatFirst[2,3,j]*x[2,3,2,j]-(RateSuppFirstResis[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[3,3,2,j]+RateStageTreatFirstR[2]*x[3,2,2,j]+RateStageTreatFirstL[3]*x[3,4,2,j]\n      dx[4,3,2,j]=RateSuppFirstResis[3]*x[3,3,2,j]-(RateFailFirstResis[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[4,3,2,j]+RateStageSuppFirst[3]*x[4,4,2,j]\n      dx[5,3,2,j]=RateFailFirstResis[3]*x[4,3,2,j]-(RateTreatSecond[3,j]+RateStageFailFirst[3]+mu[5,3,2])*x[5,3,2,j]+RateStageFailFirst[2]*x[5,2,2,j]\n      dx[6,3,2,j]=RateTreatSecond_noDTG[3,j]*(x[11,3,2,j]+x[15,3,2,j]+x[18,3,2,j])+RateTreatSecond[3,j]*x[5,3,2,j]-(RateSuppSecond[3]+RateStageTreatSecondR[3]+RateStageTreatSecondL[2]+mu[6,3,2])*x[6,3,2,j]+RateStageTreatSecondR[2]*x[6,2,2,j]+RateStageTreatSecondL[3]*x[6,4,2,j]\n      dx[7,3,2,j]=RateSuppSecond[3]*x[6,3,2,j]-(RateFailSecond[3]+RateStageSuppSecond[2]+mu[7,3,2])*x[7,3,2,j]+RateStageSuppSecond[3]*x[7,4,2,j]\n      dx[8,3,2,j]=RateFailSecond[3]*x[7,3,2,j]-(RateStageFailSecond[3]+mu[8,3,2])*x[8,3,2,j]+RateStageFailSecond[2]*x[8,2,2,j]\n      \n      dx[1,4,2,j]=-(RateDiag[4,j]+mu[1,4,2])*x[1,4,2,j]+RateStageInf[3]*x[1,3,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]+RateDiag[4,j]*((j==2)*(p_women_dtg)+(j==1))*x[1,4,2,j]-(RateTreatFirst[2,4,j]+mu[2,4,2])*x[2,4,2,j]+RateStageDiag[3]*x[2,3,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]+RateTreatFirst[2,4,j]*x[2,4,2,j]-(RateSuppFirstResis[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[3,4,2,j]+RateStageTreatFirstR[3]*x[3,3,2,j]\n      dx[4,4,2,j]=RateSuppFirstResis[4]*x[3,4,2,j]-(RateFailFirstResis[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[4,4,2,j]\n      dx[5,4,2,j]=RateFailFirstResis[4]*x[4,4,2,j]-(RateTreatSecond[4,j]+mu[5,4,2])*x[5,4,2,j]+RateStageFailFirst[3]*x[5,3,2,j]\n      dx[6,4,2,j]=RateTreatSecond_noDTG[4,j]*(x[11,4,2,j]+x[15,4,2,j]+x[18,4,2,j])+RateTreatSecond[4,j]*x[5,4,2,j]-(RateSuppSecond[4]+RateStageTreatSecondL[3]+mu[6,4,2])*x[6,4,2,j]+RateStageTreatSecondR[3]*x[6,3,2,j]\n      dx[7,4,2,j]=RateSuppSecond[4]*x[6,4,2,j]-(RateFailSecond[4]+RateStageSuppSecond[3]+mu[7,4,2])*x[7,4,2,j]\n      dx[8,4,2,j]=RateFailSecond[4]*x[7,4,2,j]-mu[8,4,2]*x[8,4,2,j]+RateStageFailSecond[3]*x[8,3,2,j]\n      \n      ##############################################################################################################################################################\n      \n      dx[1,1,2,j]=dx[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]-RateDirectTreatSecond[2,1]*x[2,1,2,j]+RateStopTreatFirst[1]*x[3,1,2,j]+RateStopSuppFirst[1]*x[4,1,2,j]+RateStopFailFirst[1]*x[5,1,2,j]+\n        (RateStopTreatSecond[1]*x[6,1,2,j]+RateStopSuppSecond[1]*x[7,1,2,j]+RateStopFailSecond[1]*x[8,1,2,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,1,2,j]=dx[3,1,2,j]-RateStopTreatFirst[1]*x[3,1,2,j]-RateTreatToFailFirstResis[1]*x[3,1,2,j]\n      dx[4,1,2,j]=dx[4,1,2,j]-RateStopSuppFirst[1]*x[4,1,2,j]+RateFailToSuppTreatFirstResis[1]*x[5,1,2,j]-RateSuppFirstToSecond[1]*x[4,1,2,j]\n      dx[5,1,2,j]=dx[5,1,2,j]-RateStopFailFirst[1]*x[5,1,2,j]-RateFailToSuppTreatFirstResis[1]*x[5,1,2,j]+RateTreatToFailFirstResis[1]*x[3,1,2,j]\n      dx[6,1,2,j]=dx[6,1,2,j]-RateStopTreatSecond[1]*x[6,1,2,j]+RateDirectTreatSecond[2,1]*x[2,1,2,j]+RateDirectTreatSecond[2,1]*x[12,1,2,j]-RateTreatToFailSecond[1]*x[6,1,2,j]\n      dx[7,1,2,j]=dx[7,1,2,j]-RateStopSuppSecond[1]*x[7,1,2,j]+RateFailToSuppTreatSecond[1]*x[8,1,2,j]+RateSuppFirstToSecond[1]*(x[4,1,2,j]+x[14,1,2,j]+x[17,1,2,j])\n      dx[8,1,2,j]=dx[8,1,2,j]-RateStopFailSecond[1]*x[8,1,2,j]-RateFailToSuppTreatSecond[1]*x[8,1,2,j]+RateTreatToFailSecond[1]*x[6,1,2,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateDirectTreatSecond[2,2]*x[2,2,2,j]+RateStopTreatFirst[2]*x[3,2,2,j]+RateStopSuppFirst[2]*x[4,2,2,j]+RateStopFailFirst[2]*x[5,2,2,j]+\n        (RateStopTreatSecond[2]*x[6,2,2,j]+RateStopSuppSecond[2]*x[7,2,2,j]+RateStopFailSecond[2]*x[8,2,2,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,2,2,j]=dx[3,2,2,j]-RateStopTreatFirst[2]*x[3,2,2,j]-RateTreatToFailFirstResis[2]*x[3,2,2,j]\n      dx[4,2,2,j]=dx[4,2,2,j]-RateStopSuppFirst[2]*x[4,2,2,j]+RateFailToSuppTreatFirstResis[2]*x[5,2,2,j]-RateSuppFirstToSecond[2]*x[4,2,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]-RateStopFailFirst[2]*x[5,2,2,j]-RateFailToSuppTreatFirstResis[2]*x[5,2,2,j]+RateTreatToFailFirstResis[2]*x[3,2,2,j]\n      dx[6,2,2,j]=dx[6,2,2,j]-RateStopTreatSecond[2]*x[6,2,2,j]+RateDirectTreatSecond[2,2]*x[2,2,2,j]+RateDirectTreatSecond[2,2]*x[12,2,2,j]-RateTreatToFailSecond[2]*x[6,2,2,j]\n      dx[7,2,2,j]=dx[7,2,2,j]-RateStopSuppSecond[2]*x[7,2,2,j]+RateFailToSuppTreatSecond[2]*x[8,2,2,j]+RateSuppFirstToSecond[2]*(x[4,2,2,j]+x[14,2,2,j]+x[17,2,2,j])\n      dx[8,2,2,j]=dx[8,2,2,j]-RateStopFailSecond[2]*x[8,2,2,j]-RateFailToSuppTreatSecond[2]*x[8,2,2,j]+RateTreatToFailSecond[2]*x[6,2,2,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateDirectTreatSecond[2,3]*x[2,3,2,j]+RateStopTreatFirst[3]*x[3,3,2,j]+RateStopSuppFirst[3]*x[4,3,2,j]+RateStopFailFirst[3]*x[5,3,2,j]+\n        (RateStopTreatSecond[3]*x[6,3,2,j]+RateStopSuppSecond[3]*x[7,3,2,j]+RateStopFailSecond[3]*x[8,3,2,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,3,2,j]=dx[3,3,2,j]-RateStopTreatFirst[3]*x[3,3,2,j]-RateTreatToFailFirstResis[3]*x[3,3,2,j]\n      dx[4,3,2,j]=dx[4,3,2,j]-RateStopSuppFirst[3]*x[4,3,2,j]+RateFailToSuppTreatFirstResis[3]*x[5,3,2,j]-RateSuppFirstToSecond[3]*x[4,3,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]-RateStopFailFirst[3]*x[5,3,2,j]-RateFailToSuppTreatFirstResis[3]*x[5,3,2,j]+RateTreatToFailFirstResis[3]*x[3,3,2,j]\n      dx[6,3,2,j]=dx[6,3,2,j]-RateStopTreatSecond[3]*x[6,3,2,j]+RateDirectTreatSecond[2,3]*x[2,3,2,j]+RateDirectTreatSecond[2,3]*x[12,3,2,j]-RateTreatToFailSecond[3]*x[6,3,2,j]\n      dx[7,3,2,j]=dx[7,3,2,j]-RateStopSuppSecond[3]*x[7,3,2,j]+RateFailToSuppTreatSecond[3]*x[8,3,2,j]+RateSuppFirstToSecond[3]*(x[4,3,2,j]+x[14,3,2,j]+x[17,3,2,j])\n      dx[8,3,2,j]=dx[8,3,2,j]-RateStopFailSecond[3]*x[8,3,2,j]-RateFailToSuppTreatSecond[3]*x[8,3,2,j]+RateTreatToFailSecond[3]*x[6,3,2,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateDirectTreatSecond[2,4]*x[2,4,2,j]+RateStopTreatFirst[4]*x[3,4,2,j]+RateStopSuppFirst[4]*x[4,4,2,j]+RateStopFailFirst[4]*x[5,4,2,j]+\n        (RateStopTreatSecond[4]*x[6,4,2,j]+RateStopSuppSecond[4]*x[7,4,2,j]+RateStopFailSecond[4]*x[8,4,2,j])*((j==2)*(p_women_dtg)+(j==1))\n      dx[3,4,2,j]=dx[3,4,2,j]-RateStopTreatFirst[4]*x[3,4,2,j]-RateTreatToFailFirstResis[4]*x[3,4,2,j]\n      dx[4,4,2,j]=dx[4,4,2,j]-RateStopSuppFirst[4]*x[4,4,2,j]+RateFailToSuppTreatFirstResis[4]*x[5,4,2,j]-RateSuppFirstToSecond[4]*x[4,4,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]-RateStopFailFirst[4]*x[5,4,2,j]-RateFailToSuppTreatFirstResis[4]*x[5,4,2,j]+RateTreatToFailFirstResis[4]*x[3,4,2,j]\n      dx[6,4,2,j]=dx[6,4,2,j]-RateStopTreatSecond[4]*x[6,4,2,j]+RateDirectTreatSecond[2,4]*x[2,4,2,j]+RateDirectTreatSecond[2,4]*x[12,4,2,j]-RateTreatToFailSecond[4]*x[6,4,2,j]\n      dx[7,4,2,j]=dx[7,4,2,j]-RateStopSuppSecond[4]*x[7,4,2,j]+RateFailToSuppTreatSecond[4]*x[8,4,2,j]+RateSuppFirstToSecond[4]*(x[4,4,2,j]+x[14,4,2,j]+x[17,4,2,j])\n      dx[8,4,2,j]=dx[8,4,2,j]-RateStopFailSecond[4]*x[8,4,2,j]-RateFailToSuppTreatSecond[4]*x[8,4,2,j]+RateTreatToFailSecond[4]*x[6,4,2,j]\n      \n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      #dx with interaction between resistant and susceptible compartments\n      dx[1,1,1,j]=dx[1,1,1,j]+RateSusceptible*x[1,1,2,j]\n      dx[2,1,1,j]=dx[2,1,1,j]+RateSusceptible*x[2,1,2,j]\n      dx[5,1,1,j]=dx[5,1,1,j]-RateResistant*x[5,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]+RateSusceptible*x[1,2,2,j]\n      dx[2,2,1,j]=dx[2,2,1,j]+RateSusceptible*x[2,2,2,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateResistant*x[5,2,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]+RateSusceptible*x[1,3,2,j]\n      dx[2,3,1,j]=dx[2,3,1,j]+RateSusceptible*x[2,3,2,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateResistant*x[5,3,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]+RateSusceptible*x[1,4,2,j]\n      dx[2,4,1,j]=dx[2,4,1,j]+RateSusceptible*x[2,4,2,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateResistant*x[5,4,1,j]\n      \n      #############################################################################################################################################################################\n      dx[1,1,2,j]=dx[1,1,2,j]-RateSusceptible*x[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]-RateSusceptible*x[2,1,2,j]\n      dx[5,1,2,j]=dx[5,1,2,j]+RateResistant*x[5,1,1,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]-RateSusceptible*x[1,2,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateSusceptible*x[2,2,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]+RateResistant*x[5,2,1,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]-RateSusceptible*x[1,3,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateSusceptible*x[2,3,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]+RateResistant*x[5,3,1,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]-RateSusceptible*x[1,4,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateSusceptible*x[2,4,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]+RateResistant*x[5,4,1,j]\n      \n      \n      #RateTreatFirstDTG[res,cd4,gender]------------------------------\n      #NNRTI susceptible\n      dx[2,1,1,j]=dx[2,1,1,j]-RateTreatFirstDTG[1,1,j]*x[2,1,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]-RateTreatFirstDTG[1,2,j]*x[2,2,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]-RateTreatFirstDTG[1,3,j]*x[2,3,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]-RateTreatFirstDTG[1,4,j]*x[2,4,1,j]\n      #NNRTI resistant\n      dx[2,1,2,j]=dx[2,1,2,j]-RateTreatFirstDTG[2,1,j]*x[2,1,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateTreatFirstDTG[2,2,j]*x[2,2,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateTreatFirstDTG[2,3,j]*x[2,3,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateTreatFirstDTG[2,4,j]*x[2,4,2,j]\n      \n      #RateSwitchDTG[care,cd4,res,gender]----------------------------\n      #NNRTI susceptible\n      dx[3,1,1,j]=dx[3,1,1,j]-RateSwitchDTG[1,1,1,j]*x[3,1,1,j]\n      dx[3,2,1,j]=dx[3,2,1,j]-RateSwitchDTG[1,2,1,j]*x[3,2,1,j]\n      dx[3,3,1,j]=dx[3,3,1,j]-RateSwitchDTG[1,3,1,j]*x[3,3,1,j]\n      dx[3,4,1,j]=dx[3,4,1,j]-RateSwitchDTG[1,4,1,j]*x[3,4,1,j]\n      \n      dx[4,1,1,j]=dx[4,1,1,j]-RateSwitchDTG[2,1,1,j]*x[4,1,1,j]\n      dx[4,2,1,j]=dx[4,2,1,j]-RateSwitchDTG[2,2,1,j]*x[4,2,1,j]\n      dx[4,3,1,j]=dx[4,3,1,j]-RateSwitchDTG[2,3,1,j]*x[4,3,1,j]\n      dx[4,4,1,j]=dx[4,4,1,j]-RateSwitchDTG[2,4,1,j]*x[4,4,1,j]\n      \n      dx[5,1,1,j]=dx[5,1,1,j]-RateSwitchDTG[3,1,1,j]*x[5,1,1,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateSwitchDTG[3,2,1,j]*x[5,2,1,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateSwitchDTG[3,3,1,j]*x[5,3,1,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateSwitchDTG[3,4,1,j]*x[5,4,1,j]\n      \n      #NNRTI resistant\n      dx[3,1,2,j]=dx[3,1,2,j]-RateSwitchDTG[1,1,2,j]*x[3,1,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]-RateSwitchDTG[1,2,2,j]*x[3,2,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]-RateSwitchDTG[1,3,2,j]*x[3,3,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]-RateSwitchDTG[1,4,2,j]*x[3,4,2,j]\n      \n      dx[4,1,2,j]=dx[4,1,2,j]-RateSwitchDTG[2,1,2,j]*x[4,1,2,j]\n      dx[4,2,2,j]=dx[4,2,2,j]-RateSwitchDTG[2,2,2,j]*x[4,2,2,j]\n      dx[4,3,2,j]=dx[4,3,2,j]-RateSwitchDTG[2,3,2,j]*x[4,3,2,j]\n      dx[4,4,2,j]=dx[4,4,2,j]-RateSwitchDTG[2,4,2,j]*x[4,4,2,j]\n      \n      dx[5,1,2,j]=dx[5,1,2,j]-RateSwitchDTG[3,1,2,j]*x[5,1,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]-RateSwitchDTG[3,2,2,j]*x[5,2,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]-RateSwitchDTG[3,3,2,j]*x[5,3,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]-RateSwitchDTG[3,4,2,j]*x[5,4,2,j]\n      \n      #DTG compartments-------------------------------------\n      #NNRTI susceptible\n      dx[9,1,1,j]=dx[9,1,1,j]+RateTreatFirstDTG[1,1,j]*x[2,1,1,j]+RateSwitchDTG[3,1,1,j]*x[5,1,1,j]+RateSwitchDTG[1,1,1,j]*x[3,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[9,1,1,j]+RateStageTreatFirstL[1]*x[9,2,1,j]\n      dx[10,1,1,j]=RateSuppFirstSusc[1]*x[9,1,1,j]-(RateFailFirstDTG[1]+mu[4,1,1])*x[10,1,1,j]+RateStageSuppFirst[1]*x[10,2,1,j]+RateSwitchDTG[2,1,1,j]*x[4,1,1,j]\n      dx[11,1,1,j]=RateFailFirstDTG[1]*x[10,1,1,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,1])*x[11,1,1,j]\n      dx[12,1,1,j]=dx[12,1,1,j]+RateDiag[1,j]*((j==2)*(1-p_women_dtg))*x[1,1,1,j]-(RateTreatFirst_noDTG[1,1,j]+RateStageDiag[1]+mu[2,1,1])*x[12,1,1,j]\n      dx[13,1,1,j]=dx[13,1,1,j]+RateTreatFirst_noDTG[1,1,j]*(t<comp_time)*x[12,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[13,1,1,j]+RateStageTreatFirstL[1]*x[13,2,1,j]\n      dx[14,1,1,j]=dx[14,1,1,j]+RateSuppFirstSusc[1]*x[13,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[14,1,1,j]+RateStageSuppFirst[1]*x[14,2,1,j]\n      dx[15,1,1,j]=dx[15,1,1,j]+RateFailFirstSusc[1]*x[14,1,1,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,1])*x[15,1,1,j]\n      dx[16,1,1,j]=dx[16,1,1,j]+RateTreatFirst_noDTG[1,1,j]*(t>=comp_time)*x[12,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[16,1,1,j]+RateStageTreatFirstL[1]*x[16,2,1,j]\n      dx[17,1,1,j]=dx[17,1,1,j]+RateSuppFirstSusc[1]*x[16,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[17,1,1,j]+RateStageSuppFirst[1]*x[17,2,1,j]\n      dx[18,1,1,j]=dx[18,1,1,j]+RateFailFirstSusc[1]*x[17,1,1,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,1])*x[18,1,1,j]\n      \n      dx[9,2,1,j]=dx[9,2,1,j]+RateTreatFirstDTG[1,2,j]*x[2,2,1,j]+RateSwitchDTG[3,2,1,j]*x[5,2,1,j]+RateSwitchDTG[1,2,1,j]*x[3,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[9,2,1,j]+RateStageTreatFirstR[1]*x[9,1,1,j]+RateStageTreatFirstL[2]*x[9,3,1,j]\n      dx[10,2,1,j]=RateSuppFirstSusc[2]*x[9,2,1,j]-(RateFailFirstDTG[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[10,2,1,j]+RateStageSuppFirst[2]*x[10,3,1,j]+RateSwitchDTG[2,2,1,j]*x[4,2,1,j]\n      dx[11,2,1,j]=RateFailFirstDTG[2]*x[10,2,1,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,1])*x[11,2,1,j]+RateStageFailFirst[1]*x[11,1,1,j]\n      dx[12,2,1,j]=dx[12,2,1,j]+RateDiag[2,j]*((j==2)*(1-p_women_dtg))*x[1,2,1,j]-(RateTreatFirst_noDTG[1,2,j]+RateStageDiag[2]+mu[2,2,1])*x[12,2,1,j]+RateStageDiag[1]*x[12,1,1,j]\n      dx[13,2,1,j]=dx[13,2,1,j]+RateTreatFirst_noDTG[1,2,j]*(t<comp_time)*x[12,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[13,2,1,j]+RateStageTreatFirstR[1]*x[13,1,1,j]+RateStageTreatFirstL[2]*x[13,3,1,j]\n      dx[14,2,1,j]=dx[14,2,1,j]+RateSuppFirstSusc[2]*x[13,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[14,2,1,j]+RateStageSuppFirst[2]*x[14,3,1,j]\n      dx[15,2,1,j]=dx[15,2,1,j]+RateFailFirstSusc[2]*x[14,2,1,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,1])*x[15,2,1,j]+RateStageFailFirst[1]*x[15,1,1,j]\n      dx[16,2,1,j]=dx[16,2,1,j]+RateTreatFirst_noDTG[1,2,j]*(t>=comp_time)*x[12,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[16,2,1,j]+RateStageTreatFirstR[1]*x[16,1,1,j]+RateStageTreatFirstL[2]*x[16,3,1,j]\n      dx[17,2,1,j]=dx[17,2,1,j]+RateSuppFirstSusc[2]*x[16,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[17,2,1,j]+RateStageSuppFirst[2]*x[17,3,1,j]\n      dx[18,2,1,j]=dx[18,2,1,j]+RateFailFirstSusc[2]*x[17,2,1,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,1])*x[18,2,1,j]+RateStageFailFirst[1]*x[18,1,1,j]\n      \n      dx[9,3,1,j]=dx[9,3,1,j]+RateTreatFirstDTG[1,3,j]*x[2,3,1,j]+RateSwitchDTG[3,3,1,j]*x[5,3,1,j]+RateSwitchDTG[1,3,1,j]*x[3,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[9,3,1,j]+RateStageTreatFirstR[2]*x[9,2,1,j]+RateStageTreatFirstL[3]*x[9,4,1,j]\n      dx[10,3,1,j]=RateSuppFirstSusc[3]*x[9,3,1,j]-(RateFailFirstDTG[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[10,3,1,j]+RateStageSuppFirst[3]*x[10,4,1,j]+RateSwitchDTG[2,3,1,j]*x[4,3,1,j]\n      dx[11,3,1,j]=RateFailFirstDTG[3]*x[10,3,1,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,1])*x[11,3,1,j]+RateStageFailFirst[2]*x[11,2,1,j]\n      dx[12,3,1,j]=dx[12,3,1,j]+RateDiag[3,j]*((j==2)*(1-p_women_dtg))*x[1,3,1,j]-(RateTreatFirst_noDTG[1,3,j]+RateStageDiag[3]+mu[2,3,1])*x[12,3,1,j]+RateStageDiag[2]*x[12,2,1,j]\n      dx[13,3,1,j]=dx[13,3,1,j]+RateTreatFirst_noDTG[1,3,j]*(t<comp_time)*x[12,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[13,3,1,j]+RateStageTreatFirstR[2]*x[13,2,1,j]+RateStageTreatFirstL[3]*x[13,4,1,j]\n      dx[14,3,1,j]=dx[14,3,1,j]+RateSuppFirstSusc[3]*x[13,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[14,3,1,j]+RateStageSuppFirst[3]*x[14,4,1,j]\n      dx[15,3,1,j]=dx[15,3,1,j]+RateFailFirstSusc[3]*x[14,3,1,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,1])*x[15,3,1,j]+RateStageFailFirst[2]*x[15,2,1,j]\n      dx[16,3,1,j]=dx[16,3,1,j]+RateTreatFirst_noDTG[1,3,j]*(t>=comp_time)*x[12,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[16,3,1,j]+RateStageTreatFirstR[2]*x[16,2,1,j]+RateStageTreatFirstL[3]*x[16,4,1,j]\n      dx[17,3,1,j]=dx[17,3,1,j]+RateSuppFirstSusc[3]*x[16,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[17,3,1,j]+RateStageSuppFirst[3]*x[17,4,1,j]\n      dx[18,3,1,j]=dx[18,3,1,j]+RateFailFirstSusc[3]*x[17,3,1,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,1])*x[18,3,1,j]+RateStageFailFirst[2]*x[18,2,1,j]\n      \n      dx[9,4,1,j]=dx[9,4,1,j]+RateTreatFirstDTG[1,4,j]*x[2,4,1,j]+RateSwitchDTG[3,4,1,j]*x[5,4,1,j]+RateSwitchDTG[1,4,1,j]*x[3,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[9,4,1,j]+RateStageTreatFirstR[3]*x[9,3,1,j]\n      dx[10,4,1,j]=RateSuppFirstSusc[4]*x[9,4,1,j]-(RateFailFirstDTG[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[10,4,1,j]+RateSwitchDTG[2,4,1,j]*x[4,4,1,j]\n      dx[11,4,1,j]=RateFailFirstDTG[4]*x[10,4,1,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,1])*x[11,4,1,j]+RateStageFailFirst[3]*x[11,3,1,j]\n      dx[12,4,1,j]=dx[12,4,1,j]+RateDiag[4,j]*((j==2)*(1-p_women_dtg))*x[1,4,1,j]-(RateTreatFirst_noDTG[1,4,j]+mu[2,4,1])*x[12,4,1,j]+RateStageDiag[3]*x[12,3,1,j]\n      dx[13,4,1,j]=dx[13,4,1,j]+RateTreatFirst_noDTG[1,4,j]*(t<comp_time)*x[12,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[13,4,1,j]+RateStageTreatFirstR[3]*x[13,3,1,j]\n      dx[14,4,1,j]=dx[14,4,1,j]+RateSuppFirstSusc[4]*x[13,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[14,4,1,j]\n      dx[15,4,1,j]=dx[15,4,1,j]+RateFailFirstSusc[4]*x[14,4,1,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,1])*x[15,4,1,j]+RateStageFailFirst[3]*x[15,3,1,j]\n      dx[16,4,1,j]=dx[16,4,1,j]+RateTreatFirst_noDTG[1,4,j]*(t>=comp_time)*x[12,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[16,4,1,j]+RateStageTreatFirstR[3]*x[16,3,1,j]\n      dx[17,4,1,j]=dx[17,4,1,j]+RateSuppFirstSusc[4]*x[16,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[17,4,1,j]\n      dx[18,4,1,j]=dx[18,4,1,j]+RateFailFirstSusc[4]*x[17,4,1,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,1])*x[18,4,1,j]+RateStageFailFirst[3]*x[18,3,1,j]\n      \n      #NNRTI resistant\n      dx[9,1,2,j]=dx[9,1,2,j]+RateTreatFirstDTG[2,1,j]*x[2,1,2,j]+RateSwitchDTG[3,1,2,j]*x[5,1,2,j]+RateSwitchDTG[1,1,2,j]*x[3,1,2,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[9,1,2,j]+RateStageTreatFirstL[1]*x[9,2,2,j]\n      dx[10,1,2,j]=RateSuppFirstSusc[1]*x[9,1,2,j]-(RateFailFirstDTG[1]+mu[4,1,2])*x[10,1,2,j]+RateStageSuppFirst[1]*x[10,2,2,j]+RateSwitchDTG[2,1,2,j]*x[4,1,2,j]\n      dx[11,1,2,j]=RateFailFirstDTG[1]*x[10,1,2,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,2])*x[11,1,2,j]\n      dx[12,1,2,j]=dx[12,1,2,j]+RateDiag[1,j]*((j==2)*(1-p_women_dtg))*x[1,1,2,j]-(RateTreatFirst_noDTG[2,1,j]+RateStageDiag[1]+mu[2,1,2])*x[12,1,2,j]\n      dx[13,1,2,j]=dx[13,1,2,j]+RateTreatFirst_noDTG[2,1,j]*(t<comp_time)*x[12,1,2,j]-(RateSuppFirstResis[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[13,1,2,j]+RateStageTreatFirstL[1]*x[13,2,2,j]\n      dx[14,1,2,j]=dx[14,1,2,j]+RateSuppFirstResis[1]*x[13,1,2,j]-(RateFailFirstResis[1]+mu[4,1,2])*x[14,1,2,j]+RateStageSuppFirst[1]*x[14,2,2,j]\n      dx[15,1,2,j]=dx[15,1,2,j]+RateFailFirstResis[1]*x[14,1,2,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,2])*x[15,1,2,j]\n      dx[16,1,2,j]=dx[16,1,2,j]+RateTreatFirst_noDTG[2,1,j]*(t>=comp_time)*x[12,1,2,j]-(RateSuppFirstResis[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[16,1,2,j]+RateStageTreatFirstL[1]*x[16,2,2,j]\n      dx[17,1,2,j]=dx[17,1,2,j]+RateSuppFirstResis[1]*x[16,1,2,j]-(RateFailFirstResis[1]+mu[4,1,2])*x[17,1,2,j]+RateStageSuppFirst[1]*x[17,2,2,j]\n      dx[18,1,2,j]=dx[18,1,2,j]+RateFailFirstResis[1]*x[17,1,2,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,2])*x[18,1,2,j]\n      \n      \n      dx[9,2,2,j]=dx[9,2,2,j]+RateTreatFirstDTG[2,2,j]*x[2,2,2,j]+RateSwitchDTG[3,2,2,j]*x[5,2,2,j]+RateSwitchDTG[1,2,2,j]*x[3,2,2,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[9,2,2,j]+RateStageTreatFirstR[1]*x[9,1,2,j]+RateStageTreatFirstL[2]*x[9,3,2,j]\n      dx[10,2,2,j]=RateSuppFirstSusc[2]*x[9,2,2,j]-(RateFailFirstDTG[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[10,2,2,j]+RateStageSuppFirst[2]*x[10,3,2,j]+RateSwitchDTG[2,2,2,j]*x[4,2,2,j]\n      dx[11,2,2,j]=RateFailFirstDTG[2]*x[10,2,2,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,2])*x[11,2,2,j]+RateStageFailFirst[1]*x[11,1,2,j]\n      dx[12,2,2,j]=dx[12,2,2,j]+RateDiag[2,j]*((j==2)*(1-p_women_dtg))*x[1,2,2,j]-(RateTreatFirst_noDTG[2,2,j]+RateStageDiag[2]+mu[2,2,2])*x[12,2,2,j]+RateStageDiag[1]*x[12,1,2,j]\n      dx[13,2,2,j]=dx[13,2,2,j]+RateTreatFirst_noDTG[2,2,j]*(t<comp_time)*x[12,2,2,j]-(RateSuppFirstResis[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[13,2,2,j]+RateStageTreatFirstR[1]*x[13,1,2,j]+RateStageTreatFirstL[2]*x[13,3,2,j]\n      dx[14,2,2,j]=dx[14,2,2,j]+RateSuppFirstResis[2]*x[13,2,2,j]-(RateFailFirstResis[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[14,2,2,j]+RateStageSuppFirst[2]*x[14,3,2,j]\n      dx[15,2,2,j]=dx[15,2,2,j]+RateFailFirstResis[2]*x[14,2,2,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,2])*x[15,2,2,j]+RateStageFailFirst[1]*x[15,1,2,j]\n      dx[16,2,2,j]=dx[16,2,2,j]+RateTreatFirst_noDTG[2,2,j]*(t>=comp_time)*x[12,2,2,j]-(RateSuppFirstResis[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[16,2,2,j]+RateStageTreatFirstR[1]*x[16,1,2,j]+RateStageTreatFirstL[2]*x[16,3,2,j]\n      dx[17,2,2,j]=dx[17,2,2,j]+RateSuppFirstResis[2]*x[16,2,2,j]-(RateFailFirstResis[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[17,2,2,j]+RateStageSuppFirst[2]*x[17,3,2,j]\n      dx[18,2,2,j]=dx[18,2,2,j]+RateFailFirstResis[2]*x[17,2,2,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,2])*x[18,2,2,j]+RateStageFailFirst[1]*x[18,1,2,j]\n      \n      \n      dx[9,3,2,j]=dx[9,3,2,j]+RateTreatFirstDTG[2,3,j]*x[2,3,2,j]+RateSwitchDTG[3,3,2,j]*x[5,3,2,j]+RateSwitchDTG[1,3,2,j]*x[3,3,2,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[9,3,2,j]+RateStageTreatFirstR[2]*x[9,2,2,j]+RateStageTreatFirstL[3]*x[9,4,2,j]\n      dx[10,3,2,j]=RateSuppFirstSusc[3]*x[9,3,2,j]-(RateFailFirstDTG[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[10,3,2,j]+RateStageSuppFirst[3]*x[10,4,2,j]+RateSwitchDTG[2,3,2,j]*x[4,3,2,j]\n      dx[11,3,2,j]=RateFailFirstDTG[3]*x[10,3,2,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,2])*x[11,3,2,j]+RateStageFailFirst[2]*x[11,2,2,j]\n      dx[12,3,2,j]=dx[12,3,2,j]+RateDiag[3,j]*((j==2)*(1-p_women_dtg))*x[1,3,2,j]-(RateTreatFirst_noDTG[2,3,j]+RateStageDiag[3]+mu[2,3,2])*x[12,3,2,j]+RateStageDiag[2]*x[12,2,2,j]\n      dx[13,3,2,j]=dx[13,3,2,j]+RateTreatFirst_noDTG[2,3,j]*(t<comp_time)*x[12,3,2,j]-(RateSuppFirstResis[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[13,3,2,j]+RateStageTreatFirstR[2]*x[13,2,2,j]+RateStageTreatFirstL[3]*x[13,4,2,j]\n      dx[14,3,2,j]=dx[14,3,2,j]+RateSuppFirstResis[3]*x[13,3,2,j]-(RateFailFirstResis[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[14,3,2,j]+RateStageSuppFirst[3]*x[14,4,2,j]\n      dx[15,3,2,j]=dx[15,3,2,j]+RateFailFirstResis[3]*x[14,3,2,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,2])*x[15,3,2,j]+RateStageFailFirst[2]*x[15,2,2,j]\n      dx[16,3,2,j]=dx[16,3,2,j]+RateTreatFirst_noDTG[2,3,j]*(t>=comp_time)*x[12,3,2,j]-(RateSuppFirstResis[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[16,3,2,j]+RateStageTreatFirstR[2]*x[16,2,2,j]+RateStageTreatFirstL[3]*x[16,4,2,j]\n      dx[17,3,2,j]=dx[17,3,2,j]+RateSuppFirstResis[3]*x[16,3,2,j]-(RateFailFirstResis[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[17,3,2,j]+RateStageSuppFirst[3]*x[17,4,2,j]\n      dx[18,3,2,j]=dx[18,3,2,j]+RateFailFirstResis[3]*x[17,3,2,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,2])*x[18,3,2,j]+RateStageFailFirst[2]*x[18,2,2,j]\n      \n      \n      dx[9,4,2,j]=dx[9,4,2,j]+RateTreatFirstDTG[2,4,j]*x[2,4,2,j]+RateSwitchDTG[3,4,2,j]*x[5,4,2,j]+RateSwitchDTG[1,4,2,j]*x[3,4,2,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[9,4,2,j]+RateStageTreatFirstR[3]*x[9,3,2,j]\n      dx[10,4,2,j]=RateSuppFirstSusc[4]*x[9,4,2,j]-(RateFailFirstDTG[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[10,4,2,j]+RateSwitchDTG[2,4,2,j]*x[4,4,2,j]\n      dx[11,4,2,j]=RateFailFirstDTG[4]*x[10,4,2,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,2])*x[11,4,2,j]+RateStageFailFirst[3]*x[11,3,2,j]\n      dx[12,4,2,j]=dx[12,4,2,j]+RateDiag[4,j]*((j==2)*(1-p_women_dtg))*x[1,4,2,j]-(RateTreatFirst_noDTG[2,4,j]+mu[2,4,2])*x[12,4,2,j]+RateStageDiag[3]*x[12,3,2,j]\n      dx[13,4,2,j]=dx[13,4,2,j]+RateTreatFirst_noDTG[2,4,j]*x[12,4,2,j]*(t<comp_time)-(RateSuppFirstResis[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[13,4,2,j]+RateStageTreatFirstR[3]*x[13,3,2,j]\n      dx[14,4,2,j]=dx[14,4,2,j]+RateSuppFirstResis[4]*x[13,4,2,j]-(RateFailFirstResis[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[14,4,2,j]\n      dx[15,4,2,j]=dx[15,4,2,j]+RateFailFirstResis[4]*x[14,4,2,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,2])*x[15,4,2,j]+RateStageFailFirst[3]*x[15,3,2,j]\n      dx[16,4,2,j]=dx[16,4,2,j]+RateTreatFirst_noDTG[2,4,j]*x[12,4,2,j]*(t>=comp_time)-(RateSuppFirstResis[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[16,4,2,j]+RateStageTreatFirstR[3]*x[16,3,2,j]\n      dx[17,4,2,j]=dx[17,4,2,j]+RateSuppFirstResis[4]*x[16,4,2,j]-(RateFailFirstResis[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[17,4,2,j]\n      dx[18,4,2,j]=dx[18,4,2,j]+RateFailFirstResis[4]*x[17,4,2,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,2])*x[18,4,2,j]+RateStageFailFirst[3]*x[18,3,2,j]\n      \n      \n      \n      ##############################################################################################################################################################\n      \n      dx[9,1,1,j]=dx[9,1,1,j]-RateStopTreatFirst[1]*x[9,1,1,j]-RateTreatToFailFirstDTG[1]*x[9,1,1,j]\n      dx[10,1,1,j]=dx[10,1,1,j]-RateStopSuppFirst[1]*x[10,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[11,1,1,j]\n      dx[11,1,1,j]=dx[11,1,1,j]-RateStopFailFirst[1]*x[11,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[11,1,1,j]+RateTreatToFailFirstDTG[1]*x[9,1,1,j]\n      dx[12,1,1,j]=dx[12,1,1,j]-RateDirectTreatSecond[1,1]*x[12,1,1,j]+RateStopTreatFirst[1]*x[13,1,1,j]+RateStopSuppFirst[1]*x[14,1,1,j]+RateStopFailFirst[1]*x[15,1,1,j]+\n        (RateStopTreatSecond[1]*x[6,1,1,j]+RateStopSuppSecond[1]*x[7,1,1,j]+RateStopFailSecond[1]*x[8,1,1,j])*((j==2)*(1-p_women_dtg))\n      dx[13,1,1,j]=dx[13,1,1,j]-RateStopTreatFirst[1]*x[13,1,1,j]-RateTreatToFailFirstSusc[1]*x[13,1,1,j]\n      dx[14,1,1,j]=dx[14,1,1,j]-RateStopSuppFirst[1]*x[14,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[15,1,1,j]-RateSuppFirstToSecond[1]*x[14,1,1,j]\n      dx[15,1,1,j]=dx[15,1,1,j]-RateStopFailFirst[1]*x[15,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[15,1,1,j]+RateTreatToFailFirstSusc[1]*x[13,1,1,j]\n      dx[16,1,1,j]=dx[16,1,1,j]-RateStopTreatFirst[1]*x[16,1,1,j]-RateTreatToFailFirstSusc[1]*x[16,1,1,j]\n      dx[17,1,1,j]=dx[17,1,1,j]-RateStopSuppFirst[1]*x[17,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[18,1,1,j]-RateSuppFirstToSecond[1]*x[17,1,1,j]\n      dx[18,1,1,j]=dx[18,1,1,j]-RateStopFailFirst[1]*x[18,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[18,1,1,j]+RateTreatToFailFirstSusc[1]*x[16,1,1,j]\n      \n      dx[9,2,1,j]=dx[9,2,1,j]-RateStopTreatFirst[2]*x[9,2,1,j]-RateTreatToFailFirstDTG[2]*x[9,2,1,j]\n      dx[10,2,1,j]=dx[10,2,1,j]-RateStopSuppFirst[2]*x[10,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[11,2,1,j]-RateSuppFirstToSecond[2]*x[10,2,1,j]\n      dx[11,2,1,j]=dx[11,2,1,j]-RateStopFailFirst[2]*x[11,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[11,2,1,j]+RateTreatToFailFirstDTG[2]*x[9,2,1,j]\n      dx[12,2,1,j]=dx[12,2,1,j]-RateDirectTreatSecond[1,2]*x[12,2,1,j]+RateStopTreatFirst[2]*x[13,2,1,j]+RateStopSuppFirst[2]*x[14,2,1,j]+RateStopFailFirst[2]*x[15,2,1,j]+\n        (RateStopTreatSecond[2]*x[6,2,1,j]+RateStopSuppSecond[2]*x[7,2,1,j]+RateStopFailSecond[2]*x[8,2,1,j])*((j==2)*(1-p_women_dtg))\n      dx[13,2,1,j]=dx[13,2,1,j]-RateStopTreatFirst[2]*x[13,2,1,j]-RateTreatToFailFirstSusc[2]*x[13,2,1,j]\n      dx[14,2,1,j]=dx[14,2,1,j]-RateStopSuppFirst[2]*x[14,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[15,2,1,j]-RateSuppFirstToSecond[2]*x[14,2,1,j]\n      dx[15,2,1,j]=dx[15,2,1,j]-RateStopFailFirst[2]*x[15,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[15,2,1,j]+RateTreatToFailFirstSusc[2]*x[13,2,1,j]\n      dx[16,2,1,j]=dx[16,2,1,j]-RateStopTreatFirst[2]*x[16,2,1,j]-RateTreatToFailFirstSusc[2]*x[16,2,1,j]\n      dx[17,2,1,j]=dx[17,2,1,j]-RateStopSuppFirst[2]*x[17,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[18,2,1,j]-RateSuppFirstToSecond[2]*x[17,2,1,j]\n      dx[18,2,1,j]=dx[18,2,1,j]-RateStopFailFirst[2]*x[18,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[18,2,1,j]+RateTreatToFailFirstSusc[2]*x[16,2,1,j]\n      \n      dx[9,3,1,j]=dx[9,3,1,j]-RateStopTreatFirst[3]*x[9,3,1,j]-RateTreatToFailFirstDTG[3]*x[9,3,1,j]\n      dx[10,3,1,j]=dx[10,3,1,j]-RateStopSuppFirst[3]*x[10,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[11,3,1,j]\n      dx[11,3,1,j]=dx[11,3,1,j]-RateStopFailFirst[3]*x[11,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[11,3,1,j]+RateTreatToFailFirstDTG[3]*x[9,3,1,j]\n      dx[12,3,1,j]=dx[12,3,1,j]-RateDirectTreatSecond[1,3]*x[12,3,1,j]+RateStopTreatFirst[3]*x[13,3,1,j]+RateStopSuppFirst[3]*x[14,3,1,j]+RateStopFailFirst[3]*x[15,3,1,j]+\n        (RateStopTreatSecond[3]*x[6,3,1,j]+RateStopSuppSecond[3]*x[7,3,1,j]+RateStopFailSecond[3]*x[8,3,1,j])*((j==2)*(1-p_women_dtg))\n      dx[13,3,1,j]=dx[13,3,1,j]-RateStopTreatFirst[3]*x[13,3,1,j]-RateTreatToFailFirstSusc[3]*x[13,3,1,j]\n      dx[14,3,1,j]=dx[14,3,1,j]-RateStopSuppFirst[3]*x[14,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[15,3,1,j]-RateSuppFirstToSecond[3]*x[14,3,1,j]\n      dx[15,3,1,j]=dx[15,3,1,j]-RateStopFailFirst[3]*x[15,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[15,3,1,j]+RateTreatToFailFirstSusc[3]*x[13,3,1,j]\n      dx[16,3,1,j]=dx[16,3,1,j]-RateStopTreatFirst[3]*x[16,3,1,j]-RateTreatToFailFirstSusc[3]*x[16,3,1,j]\n      dx[17,3,1,j]=dx[17,3,1,j]-RateStopSuppFirst[3]*x[17,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[18,3,1,j]-RateSuppFirstToSecond[3]*x[17,3,1,j]\n      dx[18,3,1,j]=dx[18,3,1,j]-RateStopFailFirst[3]*x[18,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[18,3,1,j]+RateTreatToFailFirstSusc[3]*x[16,3,1,j]\n      \n      dx[9,4,1,j]=dx[9,4,1,j]-RateStopTreatFirst[4]*x[9,4,1,j]-RateTreatToFailFirstDTG[4]*x[9,4,1,j]\n      dx[10,4,1,j]=dx[10,4,1,j]-RateStopSuppFirst[4]*x[10,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[11,4,1,j]\n      dx[11,4,1,j]=dx[11,4,1,j]-RateStopFailFirst[4]*x[11,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[11,4,1,j]+RateTreatToFailFirstDTG[4]*x[9,4,1,j]\n      dx[12,4,1,j]=dx[12,4,1,j]-RateDirectTreatSecond[1,4]*x[12,4,1,j]+RateStopTreatFirst[4]*x[13,4,1,j]+RateStopSuppFirst[4]*x[14,4,1,j]+RateStopFailFirst[4]*x[15,4,1,j]+\n        (RateStopTreatSecond[4]*x[6,4,1,j]+RateStopSuppSecond[4]*x[7,4,1,j]+RateStopFailSecond[4]*x[8,4,1,j])*((j==2)*(1-p_women_dtg))\n      dx[13,4,1,j]=dx[13,4,1,j]-RateStopTreatFirst[4]*x[13,4,1,j]-RateTreatToFailFirstSusc[4]*x[13,4,1,j]\n      dx[14,4,1,j]=dx[14,4,1,j]-RateStopSuppFirst[4]*x[14,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[15,4,1,j]-RateSuppFirstToSecond[4]*x[14,4,1,j]\n      dx[15,4,1,j]=dx[15,4,1,j]-RateStopFailFirst[4]*x[15,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[15,4,1,j]+RateTreatToFailFirstSusc[4]*x[13,4,1,j]\n      dx[16,4,1,j]=dx[16,4,1,j]-RateStopTreatFirst[4]*x[16,4,1,j]-RateTreatToFailFirstSusc[4]*x[16,4,1,j]\n      dx[17,4,1,j]=dx[17,4,1,j]-RateStopSuppFirst[4]*x[17,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[18,4,1,j]-RateSuppFirstToSecond[4]*x[17,4,1,j]\n      dx[18,4,1,j]=dx[18,4,1,j]-RateStopFailFirst[4]*x[18,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[18,4,1,j]+RateTreatToFailFirstSusc[4]*x[16,4,1,j]\n      \n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      \n      dx[9,1,2,j]=dx[9,1,2,j]-RateStopTreatFirst[1]*x[9,1,2,j]-RateTreatToFailFirstDTG[1]*x[9,1,2,j]\n      dx[10,1,2,j]=dx[10,1,2,j]-RateStopSuppFirst[1]*x[10,1,2,j]+RateFailToSuppTreatFirstSusc[1]*x[11,1,2,j]\n      dx[11,1,2,j]=dx[11,1,2,j]-RateStopFailFirst[1]*x[11,1,2,j]-RateFailToSuppTreatFirstSusc[1]*x[11,1,2,j]+RateTreatToFailFirstDTG[1]*x[9,1,2,j]\n      dx[12,1,2,j]=dx[12,1,2,j]-RateDirectTreatSecond[2,1]*x[12,1,2,j]+RateStopTreatFirst[1]*x[13,1,2,j]+RateStopSuppFirst[1]*x[14,1,2,j]+RateStopFailFirst[1]*x[15,1,2,j]+\n        (RateStopTreatSecond[1]*x[6,1,2,j]+RateStopSuppSecond[1]*x[7,1,2,j]+RateStopFailSecond[1]*x[8,1,2,j])*((j==2)*(1-p_women_dtg))\n      dx[13,1,2,j]=dx[13,1,2,j]-RateStopTreatFirst[1]*x[13,1,2,j]-RateTreatToFailFirstResis[1]*x[13,1,2,j]\n      dx[14,1,2,j]=dx[14,1,2,j]-RateStopSuppFirst[1]*x[14,1,2,j]+RateFailToSuppTreatFirstResis[1]*x[15,1,2,j]-RateSuppFirstToSecond[1]*x[14,1,2,j]\n      dx[15,1,2,j]=dx[15,1,2,j]-RateStopFailFirst[1]*x[15,1,2,j]-RateFailToSuppTreatFirstResis[1]*x[15,1,2,j]+RateTreatToFailFirstResis[1]*x[13,1,2,j]\n      dx[16,1,2,j]=dx[16,1,2,j]-RateStopTreatFirst[1]*x[16,1,2,j]-RateTreatToFailFirstResis[1]*x[16,1,2,j]\n      dx[17,1,2,j]=dx[17,1,2,j]-RateStopSuppFirst[1]*x[17,1,2,j]+RateFailToSuppTreatFirstResis[1]*x[18,1,2,j]-RateSuppFirstToSecond[1]*x[17,1,2,j]\n      dx[18,1,2,j]=dx[18,1,2,j]-RateStopFailFirst[1]*x[18,1,2,j]-RateFailToSuppTreatFirstResis[1]*x[18,1,2,j]+RateTreatToFailFirstResis[1]*x[16,1,2,j]\n      \n      dx[9,2,2,j]=dx[9,2,2,j]-RateStopTreatFirst[2]*x[9,2,2,j]-RateTreatToFailFirstDTG[2]*x[9,2,2,j]\n      dx[10,2,2,j]=dx[10,2,2,j]-RateStopSuppFirst[2]*x[10,2,2,j]+RateFailToSuppTreatFirstSusc[2]*x[11,2,2,j]\n      dx[11,2,2,j]=dx[11,2,2,j]-RateStopFailFirst[2]*x[11,2,2,j]-RateFailToSuppTreatFirstSusc[2]*x[11,2,2,j]+RateTreatToFailFirstDTG[2]*x[9,2,2,j]\n      dx[12,2,2,j]=dx[12,2,2,j]-RateDirectTreatSecond[2,2]*x[12,2,2,j]+RateStopTreatFirst[2]*x[13,2,2,j]+RateStopSuppFirst[2]*x[14,2,2,j]+RateStopFailFirst[2]*x[15,2,2,j]+\n        (RateStopTreatSecond[2]*x[6,2,2,j]+RateStopSuppSecond[2]*x[7,2,2,j]+RateStopFailSecond[2]*x[8,2,2,j])*((j==2)*(1-p_women_dtg))\n      dx[13,2,2,j]=dx[13,2,2,j]-RateStopTreatFirst[2]*x[13,2,2,j]-RateTreatToFailFirstResis[2]*x[13,2,2,j]\n      dx[14,2,2,j]=dx[14,2,2,j]-RateStopSuppFirst[2]*x[14,2,2,j]+RateFailToSuppTreatFirstResis[2]*x[15,2,2,j]-RateSuppFirstToSecond[2]*x[14,2,2,j]\n      dx[15,2,2,j]=dx[15,2,2,j]-RateStopFailFirst[2]*x[15,2,2,j]-RateFailToSuppTreatFirstResis[2]*x[15,2,2,j]+RateTreatToFailFirstResis[2]*x[13,2,2,j]\n      dx[16,2,2,j]=dx[16,2,2,j]-RateStopTreatFirst[2]*x[16,2,2,j]-RateTreatToFailFirstResis[2]*x[16,2,2,j]\n      dx[17,2,2,j]=dx[17,2,2,j]-RateStopSuppFirst[2]*x[17,2,2,j]+RateFailToSuppTreatFirstResis[2]*x[18,2,2,j]-RateSuppFirstToSecond[2]*x[17,2,2,j]\n      dx[18,2,2,j]=dx[18,2,2,j]-RateStopFailFirst[2]*x[18,2,2,j]-RateFailToSuppTreatFirstResis[2]*x[18,2,2,j]+RateTreatToFailFirstResis[2]*x[16,2,2,j]\n      \n      dx[9,3,2,j]=dx[9,3,2,j]-RateStopTreatFirst[3]*x[9,3,2,j]-RateTreatToFailFirstDTG[3]*x[9,3,2,j]\n      dx[10,3,2,j]=dx[10,3,2,j]-RateStopSuppFirst[3]*x[10,3,2,j]+RateFailToSuppTreatFirstSusc[3]*x[11,3,2,j]\n      dx[11,3,2,j]=dx[11,3,2,j]-RateStopFailFirst[3]*x[11,3,2,j]-RateFailToSuppTreatFirstSusc[3]*x[11,3,2,j]+RateTreatToFailFirstDTG[3]*x[9,3,2,j]\n      dx[12,3,2,j]=dx[12,3,2,j]-RateDirectTreatSecond[2,3]*x[12,3,2,j]+RateStopTreatFirst[3]*x[13,3,2,j]+RateStopSuppFirst[3]*x[14,3,2,j]+RateStopFailFirst[3]*x[15,3,2,j]+\n        (RateStopTreatSecond[3]*x[6,3,2,j]+RateStopSuppSecond[3]*x[7,3,2,j]+RateStopFailSecond[3]*x[8,3,2,j])*((j==2)*(1-p_women_dtg))\n      dx[13,3,2,j]=dx[13,3,2,j]-RateStopTreatFirst[3]*x[13,3,2,j]-RateTreatToFailFirstResis[3]*x[13,3,2,j]\n      dx[14,3,2,j]=dx[14,3,2,j]-RateStopSuppFirst[3]*x[14,3,2,j]+RateFailToSuppTreatFirstResis[3]*x[15,3,2,j]-RateSuppFirstToSecond[3]*x[14,3,2,j]\n      dx[15,3,2,j]=dx[15,3,2,j]-RateStopFailFirst[3]*x[15,3,2,j]-RateFailToSuppTreatFirstResis[3]*x[15,3,2,j]+RateTreatToFailFirstResis[3]*x[13,3,2,j]\n      dx[16,3,2,j]=dx[16,3,2,j]-RateStopTreatFirst[3]*x[16,3,2,j]-RateTreatToFailFirstResis[3]*x[16,3,2,j]\n      dx[17,3,2,j]=dx[17,3,2,j]-RateStopSuppFirst[3]*x[17,3,2,j]+RateFailToSuppTreatFirstResis[3]*x[18,3,2,j]-RateSuppFirstToSecond[3]*x[17,3,2,j]\n      dx[18,3,2,j]=dx[18,3,2,j]-RateStopFailFirst[3]*x[18,3,2,j]-RateFailToSuppTreatFirstResis[3]*x[18,3,2,j]+RateTreatToFailFirstResis[3]*x[16,3,2,j]\n      \n      dx[9,4,2,j]=dx[9,4,2,j]-RateStopTreatFirst[4]*x[9,4,2,j]-RateTreatToFailFirstDTG[4]*x[9,4,2,j]\n      dx[10,4,2,j]=dx[10,4,2,j]-RateStopSuppFirst[4]*x[10,4,2,j]+RateFailToSuppTreatFirstSusc[4]*x[11,4,2,j]\n      dx[11,4,2,j]=dx[11,4,2,j]-RateStopFailFirst[4]*x[11,4,2,j]-RateFailToSuppTreatFirstSusc[4]*x[11,4,2,j]+RateTreatToFailFirstDTG[4]*x[9,4,2,j]\n      dx[12,4,2,j]=dx[12,4,2,j]-RateDirectTreatSecond[2,4]*x[12,4,2,j]+RateStopTreatFirst[4]*x[13,4,2,j]+RateStopSuppFirst[4]*x[14,4,2,j]+RateStopFailFirst[4]*x[15,4,2,j]+\n        (RateStopTreatSecond[4]*x[6,4,2,j]+RateStopSuppSecond[4]*x[7,4,2,j]+RateStopFailSecond[4]*x[8,4,2,j])*((j==2)*(1-p_women_dtg))\n      dx[13,4,2,j]=dx[13,4,2,j]-RateStopTreatFirst[4]*x[13,4,2,j]-RateTreatToFailFirstResis[4]*x[13,4,2,j]\n      dx[14,4,2,j]=dx[14,4,2,j]-RateStopSuppFirst[4]*x[14,4,2,j]+RateFailToSuppTreatFirstResis[4]*x[15,4,2,j]-RateSuppFirstToSecond[4]*x[14,4,2,j]\n      dx[15,4,2,j]=dx[15,4,2,j]-RateStopFailFirst[4]*x[15,4,2,j]-RateFailToSuppTreatFirstResis[4]*x[15,4,2,j]+RateTreatToFailFirstResis[4]*x[13,4,2,j]\n      dx[16,4,2,j]=dx[16,4,2,j]-RateStopTreatFirst[4]*x[16,4,2,j]-RateTreatToFailFirstResis[4]*x[16,4,2,j]\n      dx[17,4,2,j]=dx[17,4,2,j]-RateStopSuppFirst[4]*x[17,4,2,j]+RateFailToSuppTreatFirstResis[4]*x[18,4,2,j]-RateSuppFirstToSecond[4]*x[17,4,2,j]\n      dx[18,4,2,j]=dx[18,4,2,j]-RateStopFailFirst[4]*x[18,4,2,j]-RateFailToSuppTreatFirstResis[4]*x[18,4,2,j]+RateTreatToFailFirstResis[4]*x[16,4,2,j]\n      \n      \n      #Resistance acquisition and reversion\n      dx[12,1,2,j]=dx[12,1,2,j]-RateSusceptible*x[12,1,2,j]\n      dx[15,1,2,j]=dx[15,1,2,j]+RateResistant*x[15,1,1,j]\n      dx[18,1,2,j]=dx[18,1,2,j]+RateResistant*x[18,1,1,j]\n      dx[12,2,2,j]=dx[12,2,2,j]-RateSusceptible*x[12,2,2,j]\n      dx[15,2,2,j]=dx[15,2,2,j]+RateResistant*x[15,2,1,j]\n      dx[18,2,2,j]=dx[18,2,2,j]+RateResistant*x[18,2,1,j]\n      dx[12,3,2,j]=dx[12,3,2,j]-RateSusceptible*x[12,3,2,j]\n      dx[15,3,2,j]=dx[15,3,2,j]+RateResistant*x[15,3,1,j]\n      dx[18,3,2,j]=dx[18,3,2,j]+RateResistant*x[18,3,1,j]\n      dx[12,4,2,j]=dx[12,4,2,j]-RateSusceptible*x[12,4,2,j]\n      dx[15,4,2,j]=dx[15,4,2,j]+RateResistant*x[15,4,1,j]\n      dx[18,4,2,j]=dx[18,4,2,j]+RateResistant*x[18,4,1,j]\n      \n      dx[12,1,1,j]=dx[12,1,1,j]+RateSusceptible*x[12,1,2,j]\n      dx[15,1,1,j]=dx[15,1,1,j]-RateResistant*x[15,1,1,j]\n      dx[18,1,1,j]=dx[18,1,1,j]-RateResistant*x[18,1,1,j]\n      dx[12,2,1,j]=dx[12,2,1,j]+RateSusceptible*x[12,2,2,j]\n      dx[15,2,1,j]=dx[15,2,1,j]-RateResistant*x[15,2,1,j]\n      dx[18,2,1,j]=dx[18,2,1,j]-RateResistant*x[18,2,1,j]\n      dx[12,3,1,j]=dx[12,3,1,j]+RateSusceptible*x[12,3,2,j]\n      dx[15,3,1,j]=dx[15,3,1,j]-RateResistant*x[15,3,1,j]\n      dx[18,3,1,j]=dx[18,3,1,j]-RateResistant*x[18,3,1,j]\n      dx[12,4,1,j]=dx[12,4,1,j]+RateSusceptible*x[12,4,2,j]\n      dx[15,4,1,j]=dx[15,4,1,j]-RateResistant*x[15,4,1,j]\n      dx[18,4,1,j]=dx[18,4,1,j]-RateResistant*x[18,4,1,j]\n      \n    }\n    dx[x+dx<0]=0\n    #dx[12:15,1:4,1:2,1]=0\n    #new_infections\n    new_inf=S[1]/N[1]*(sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,1:2,1:2],c(1,3),sum))+\n                         sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8,9,11,12,13,15,16,18),1:4,1:2,1:2],c(2,4),sum)))+\n      S[2]/N[2]*(sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,1:2,1:2],c(1,3),sum))+\n                   sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8,9,11,12,13,15,16,18),1:4,1:2,1:2],c(2,4),sum)))\n    #death\n    death=sum(apply(x[1:8,1:4,1:2,1:2],c(1,2,3),sum)*mu)+sum(apply(x[12,1:4,1:2,1:2],c(1,2),sum)*mu[2,1:4,1:2])+\n      sum(apply(x[9:11,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])+\n      sum(apply(x[13:15,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])+\n      sum(apply(x[16:18,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    \n    \n    death_w=sum(x[1:8,1:4,1:2,2]*mu)+sum(x[12,1:4,1:2,2]*mu[2,1:4,1:2])+\n      sum(x[9:11,1:4,1:2,2]*mu[3:5,1:4,1:2])+sum(x[13:15,1:4,1:2,2]*mu[3:5,1:4,1:2])\n    death_w_nnrti=sum(x[3:5,1:4,1:2,2]*mu[3:5,1:4,1:2])+sum(x[13:15,1:4,1:2,2]*mu[3:5,1:4,1:2])\n    death_w_inel=sum(x[13:15,1:4,1:2,2]*mu[3:5,1:4,1:2])\n    death_w_inel_2018=ifelse(sum(x[16:18,1:4,1:2,2])==0,\n                             0,sum(x[16:18,1:4,1:2,2]*mu[3:5,1:4,1:2])/sum(x[16:18,1:4,1:2,2]))\n    \n    treat_16=t(RateTreatFirst_noDTG[1:2,1:4,2])*x[12,1:4,1:2,2]\n    \n    \n    death2=sum(apply(x[3:5,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    death3=sum(apply(x[13:15,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    death4=sum(apply(x[9:11,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    death5=sum(apply(x[2,1:4,1:2,1:2],c(1,2),sum)*mu[2,1:4,1:2])\n    #new_infections resistant\n    new_inf_res=S[1]/N[1]*(sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+\n                             sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8,9,11,12,13,15),1:4,2,1:2],c(2,3),sum)))+\n      S[2]/N[2]*(sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+\n                   sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8,9,11,12,13,15),1:4,2,1:2],c(2,3),sum)))\n    \n    n1=S[1]/N[1]*sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))#susc inf\n    n2=S[1]/N[1]*sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8,9,11),1:4,2,1:2],c(2,3),sum))#susc diag\n    n3=S[2]/N[2]*sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))#res inf\n    n4=S[2]/N[2]*sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8,9,11),1:4,2,1:2],c(2,3),sum))#res diag\n    #death resistant\n    death_res=sum(apply(x[1:8,1:4,2,1:2],c(1,2),sum)*mu[1:8,1:4,2])+sum(apply(x[12,1:4,2,1:2],c(1),sum)*mu[2,1:4,2])+\n      sum(apply(x[9:11,1:4,2,1:2],c(1,2),sum)*mu[3:5,1:4,2])+sum(apply(x[13:15,1:4,2,1:2],c(1,2),sum)*mu[3:5,1:4,2])\n    \n    \n    death_treat=sum(apply(x[3:8,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:8,1:4,1:2])+\n      sum(apply(x[9:11,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])+sum(apply(x[13:15,1:4,1:2,1:2],c(1,2,3),sum)*mu[3:5,1:4,1:2])\n    death_treat_res=sum(apply(x[3:8,1:4,2,1:2],c(1,2),sum)*mu[3:8,1:4,2])+\n      sum(apply(x[9:11,1:4,2,1:2],c(1,2),sum)*mu[3:5,1:4,2])+sum(apply(x[13:15,1:4,2,1:2],c(1,2),sum)*mu[3:5,1:4,2])\n    \n    \n    new_treat=sum(RateTreatFirst[1:2,1:4,1:2]*aperm(x[2,1:4,1:2,1:2],perm=c(2,1,3)))+\n      sum(RateTreatFirstDTG[1:2,1:4,1:2]*aperm(x[2,1:4,1:2,1:2],perm=c(2,1,3)))+\n      sum(RateDirectTreatSecond[1:2,1:4]*aperm(apply(x[2,1:4,1:2,1:2],c(1,2),sum),c(2,1)))+\n      sum(RateTreatFirst[1:2,1:4,1:2]*aperm(x[12,1:4,1:2,1:2],perm=c(2,1,3)))+\n      sum(RateDirectTreatSecond[1:2,1:4]*aperm(apply(x[12,1:4,1:2,1:2],c(1,2),sum),c(2,1)))\n    \n    \n    new_treat_res=sum(RateTreatFirst[2,1:4,1:2]*x[2,1:4,2,1:2])+\n      sum(RateTreatFirstDTG[2,1:4,1:2]*x[2,1:4,2,1:2])+\n      sum(RateDirectTreatSecond[2,1:4]*apply(x[2,1:4,2,1:2],c(1),sum))+\n      sum(RateTreatFirst[2,1:4,1:2]*x[12,1:4,2,1:2])+\n      sum(RateDirectTreatSecond[2,1:4]*apply(x[12,1:4,2,1:2],c(1),sum))\n    \n    death_diag=sum(apply(x[12,1:4,1:2,1:2],c(1,2),sum)*mu[2,1:4,1:2])+sum(apply(x[2,1:4,1:2,1:2],c(1,2),sum)*mu[2,1:4,1:2])\n    death_diag_res=sum(apply(x[12,1:4,2,1:2],c(1),sum)*mu[2,1:4,2])+sum(apply(x[2,1:4,2,1:2],c(1),sum)*mu[2,1:4,2])\n    \n    new_diag=sum(RateDiag[1:4,1:2]*apply(x[1,1:4,1:2,1:2],c(1,3),sum))\n    new_diag_res=sum(RateDiag[1:4,1:2]*apply(x[1,1:4,2,1:2],c(1,2),sum))\n    \n    \n    #why last cd4 class go down quicker in res than in susc\n    new_pi_susc=sum(apply(RateDirectTreatSecond[1:2,1:4],c(2),sum)*apply(x[c(2,12),1:4,1,1:2],c(2),sum))+\n      sum(RateTreatSecond[1:4,1:2]*x[c(5),1:4,1,1:2])+\n      sum(RateTreatSecond_noDTG[1:4,1:2]*apply(x[c(5,15),1:4,1,1:2],c(2,3),sum))\n    new_pi_res=sum(apply(RateDirectTreatSecond[1:2,1:4],c(2),sum)*apply(x[c(2,12),1:4,2,1:2],c(2),sum))+\n      sum(RateTreatSecond[1:4,1:2]*x[c(5),1:4,2,1:2])+\n      sum(RateTreatSecond_noDTG[1:4,1:2]*apply(x[c(5,15),1:4,2,1:2],c(2,3),sum))\n    new_pi_susc_4=sum(RateDirectTreatSecond[1:2,4]*apply(x[c(2,12),4,1,1:2],c(2),sum))+\n      sum(RateTreatSecond[4,1:2]*x[c(5),4,1,1:2])+\n      sum(RateTreatSecond_noDTG[4,1:2]*apply(x[c(5,15),4,1,1:2],c(2),sum))\n    new_pi_res_4=sum(RateDirectTreatSecond[1:2,4]*apply(x[c(2,12),4,2,1:2],c(2),sum))+\n      sum(RateTreatSecond[4,1:2]*x[c(5),4,2,1:2])+\n      sum(RateTreatSecond_noDTG[4,1:2]*apply(x[c(5,15),4,2,1:2],c(2),sum))\n    \n    \n    m_susc=sum(RateDiag[1:4,1]*x[1,1:4,1,1]+RateDiag[1:4,2]*p_women_dtg*x[1,1:4,1,2])\n    m_res=sum(RateDiag[1:4,1]*x[1,1:4,2,1]+RateDiag[1:4,2]*p_women_dtg*x[1,1:4,2,2])\n    \n    m_susc=m_susc-sum(RateTreatFirst[1,1:4,1]*x[2,1:4,1,1]+RateTreatFirst[1,1:4,2]*x[2,1:4,1,2])\n    m_res=m_res-sum(RateTreatFirst[2,1:4,1]*x[2,1:4,2,1]+RateTreatFirst[2,1:4,2]*x[2,1:4,2,2])\n    \n    m_susc=m_susc-sum(RateDirectTreatSecond[1,1:4]*x[2,1:4,1,1]+RateDirectTreatSecond[1,1:4]*x[2,1:4,1,2])\n    m_res=m_res-sum(RateDirectTreatSecond[2,1:4]*x[2,1:4,2,1]+RateDirectTreatSecond[2,1:4]*x[2,1:4,2,2])\n    \n    m_susc=m_susc-sum(RateTreatFirstDTG[1,1:4,1]*x[2,1:4,1,1]+RateTreatFirstDTG[1,1:4,2]*x[2,1:4,1,2])\n    m_res=m_res-sum(RateTreatFirstDTG[2,1:4,1]*x[2,1:4,2,1]+RateTreatFirstDTG[2,1:4,2]*x[2,1:4,2,2])\n    \n    m_susc=m_susc-sum(mu[2,1:4,1]*x[2,1:4,1,1]+mu[2,1:4,1]*x[2,1:4,1,2])\n    m_res=m_res-sum(mu[2,1:4,2]*x[2,1:4,2,1]+mu[2,1:4,2]*x[2,1:4,2,2])\n    \n    # new_treat_susc=sum(RateTreatFirstDTG[1,1:4,1:2]*x[2,1:4,1,1:2])\n    # new_treat_res=sum(RateTreatFirstDTG[2,1:4,1:2]*x[2,1:4,2,1:2])\n    \n    \n    mort_susc=sum(mu[1,1:4,1]*apply(x[1,1:4,1,1:2],1,sum))\n    mort_res=sum(mu[1,1:4,2]*apply(x[1,1:4,2,1:2],1,sum))\n    \n    # #new_diag_susc=sum(x[2,1:4,1,1:2])\n    # #new_diag_res=sum(x[2,1:4,2,1:2])\n    # mort_susc=sum(mu[2,1:4,1]*apply(x[2,1:4,1,1:2],1,sum))\n    # mort_res=sum(mu[2,1:4,2]*apply(x[2,1:4,2,1:2],1,sum))\n    \n    #dx[3:8,1:4,1,1:2]=dx[3:8,1:4,1,1:2]+infected_m15_month[t+1]*x[3:8,1:4,1,1:2]/sum(x[3:8,1:4,1,1:2])\n    ####################################################################################################################\n    #res=c(dx,treat_16,0,death_w_inel_2018)\n    #res=c(dx,new_inf,death,new_diag,new_treat,death_treat,new_inf_res,death_res,death_w,death_w_nnrti,death_w_inel_2018)\n    \n    res=c(dx,new_inf,death,new_diag,new_treat,death_treat,new_inf_res,death_res,new_diag_res,new_treat_res,death_treat_res)\n    #res=c(dx,new_inf,death,new_diag,new_pi_susc,new_pi_res,new_inf_res,death_res,new_diag_res,new_pi_susc_4,new_pi_res_4)\n    #res=c(dx,new_treat_susc,new_treat_res,new_diag_susc,new_diag_res,mort_susc,mort_res)\n    #res=c(dx,new_inf,death,new_diag,new_treat,death_diag,new_inf_res,death_res,new_diag_res,new_treat_res,death_diag_res)\n    return(c(res))\n    #return(list(c(res,newinf,newsu,newres,death)))\n    #})\n  })\n}\n\n#Mortality computation\n#15\n# mod_dtg=function(t,x,p1,treat_dtg,parms){\n#   \n#   parms2=mod_rate(t,x,p1,treat_dtg,parms)\n#   dx=array(0,dim=c(15,4,2,2))\n#   x=array(x,dim=c(15,4,2,2))\n#   \n#   #Define comp_time globally, used here to fix time from which dtg-ineligible ind go to compartments 16\n#   \n#   with(as.list(parms2), {\n#     for(j in 1:2){\n#       dx[13,1,1,j]=dx[13,1,1,j]+RateTreatFirst_noDTG[1,1,j]*x[12,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[13,1,1,j]+RateStageTreatFirstL[1]*x[13,2,1,j]\n#       dx[14,1,1,j]=dx[14,1,1,j]+RateSuppFirstSusc[1]*x[13,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[14,1,1,j]+RateStageSuppFirst[1]*x[14,2,1,j]\n#       dx[15,1,1,j]=dx[15,1,1,j]+RateFailFirstSusc[1]*x[14,1,1,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,1])*x[15,1,1,j]\n#       \n#       dx[13,2,1,j]=dx[13,2,1,j]+RateTreatFirst_noDTG[1,2,j]*x[12,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[13,2,1,j]+RateStageTreatFirstR[1]*x[13,1,1,j]+RateStageTreatFirstL[2]*x[13,3,1,j]\n#       dx[14,2,1,j]=dx[14,2,1,j]+RateSuppFirstSusc[2]*x[13,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[14,2,1,j]+RateStageSuppFirst[2]*x[14,3,1,j]\n#       dx[15,2,1,j]=dx[15,2,1,j]+RateFailFirstSusc[2]*x[14,2,1,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,1])*x[15,2,1,j]+RateStageFailFirst[1]*x[15,1,1,j]\n#       \n#       dx[13,3,1,j]=dx[13,3,1,j]+RateTreatFirst_noDTG[1,3,j]*x[12,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[13,3,1,j]+RateStageTreatFirstR[2]*x[13,2,1,j]+RateStageTreatFirstL[3]*x[13,4,1,j]\n#       dx[14,3,1,j]=dx[14,3,1,j]+RateSuppFirstSusc[3]*x[13,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[14,3,1,j]+RateStageSuppFirst[3]*x[14,4,1,j]\n#       dx[15,3,1,j]=dx[15,3,1,j]+RateFailFirstSusc[3]*x[14,3,1,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,1])*x[15,3,1,j]+RateStageFailFirst[2]*x[15,2,1,j]\n#       \n#       dx[13,4,1,j]=dx[13,4,1,j]+RateTreatFirst_noDTG[1,4,j]*x[12,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[13,4,1,j]+RateStageTreatFirstR[3]*x[13,3,1,j]\n#       dx[14,4,1,j]=dx[14,4,1,j]+RateSuppFirstSusc[4]*x[13,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[14,4,1,j]\n#       dx[15,4,1,j]=dx[15,4,1,j]+RateFailFirstSusc[4]*x[14,4,1,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,1])*x[15,4,1,j]+RateStageFailFirst[3]*x[15,3,1,j]\n#       \n#       #NNRTI resistant\n#       dx[13,1,2,j]=dx[13,1,2,j]+RateTreatFirst_noDTG[2,1,j]*x[12,1,2,j]-(RateSuppFirstResis[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[13,1,2,j]+RateStageTreatFirstL[1]*x[13,2,2,j]\n#       dx[14,1,2,j]=dx[14,1,2,j]+RateSuppFirstResis[1]*x[13,1,2,j]-(RateFailFirstResis[1]+mu[4,1,2])*x[14,1,2,j]+RateStageSuppFirst[1]*x[14,2,2,j]\n#       dx[15,1,2,j]=dx[15,1,2,j]+RateFailFirstResis[1]*x[14,1,2,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,2])*x[15,1,2,j]\n#       \n#       dx[13,2,2,j]=dx[13,2,2,j]+RateTreatFirst_noDTG[2,2,j]*x[12,2,2,j]-(RateSuppFirstResis[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[13,2,2,j]+RateStageTreatFirstR[1]*x[13,1,2,j]+RateStageTreatFirstL[2]*x[13,3,2,j]\n#       dx[14,2,2,j]=dx[14,2,2,j]+RateSuppFirstResis[2]*x[13,2,2,j]-(RateFailFirstResis[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[14,2,2,j]+RateStageSuppFirst[2]*x[14,3,2,j]\n#       dx[15,2,2,j]=dx[15,2,2,j]+RateFailFirstResis[2]*x[14,2,2,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,2])*x[15,2,2,j]+RateStageFailFirst[1]*x[15,1,2,j]\n#       \n#       dx[13,3,2,j]=dx[13,3,2,j]+RateTreatFirst_noDTG[2,3,j]*x[12,3,2,j]-(RateSuppFirstResis[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[13,3,2,j]+RateStageTreatFirstR[2]*x[13,2,2,j]+RateStageTreatFirstL[3]*x[13,4,2,j]\n#       dx[14,3,2,j]=dx[14,3,2,j]+RateSuppFirstResis[3]*x[13,3,2,j]-(RateFailFirstResis[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[14,3,2,j]+RateStageSuppFirst[3]*x[14,4,2,j]\n#       dx[15,3,2,j]=dx[15,3,2,j]+RateFailFirstResis[3]*x[14,3,2,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,2])*x[15,3,2,j]+RateStageFailFirst[2]*x[15,2,2,j]\n#       \n#       dx[13,4,2,j]=dx[13,4,2,j]+RateTreatFirst_noDTG[2,4,j]*x[12,4,2,j]-(RateSuppFirstResis[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[13,4,2,j]+RateStageTreatFirstR[3]*x[13,3,2,j]\n#       dx[14,4,2,j]=dx[14,4,2,j]+RateSuppFirstResis[4]*x[13,4,2,j]-(RateFailFirstResis[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[14,4,2,j]\n#       dx[15,4,2,j]=dx[15,4,2,j]+RateFailFirstResis[4]*x[14,4,2,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,2])*x[15,4,2,j]+RateStageFailFirst[3]*x[15,3,2,j]\n#       \n#       ##############################################################################################################################################################\n#       \n#       dx[13,1,1,j]=dx[13,1,1,j]-RateStopTreatFirst[1]*x[13,1,1,j]-RateTreatToFailFirstSusc[1]*x[13,1,1,j]\n#       dx[14,1,1,j]=dx[14,1,1,j]-RateStopSuppFirst[1]*x[14,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[15,1,1,j]-RateSuppFirstToSecond[1]*x[14,1,1,j]\n#       dx[15,1,1,j]=dx[15,1,1,j]-RateStopFailFirst[1]*x[15,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[15,1,1,j]+RateTreatToFailFirstSusc[1]*x[13,1,1,j]\n#       \n#       dx[13,2,1,j]=dx[13,2,1,j]-RateStopTreatFirst[2]*x[13,2,1,j]-RateTreatToFailFirstSusc[2]*x[13,2,1,j]\n#       dx[14,2,1,j]=dx[14,2,1,j]-RateStopSuppFirst[2]*x[14,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[15,2,1,j]-RateSuppFirstToSecond[2]*x[14,2,1,j]\n#       dx[15,2,1,j]=dx[15,2,1,j]-RateStopFailFirst[2]*x[15,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[15,2,1,j]+RateTreatToFailFirstSusc[2]*x[13,2,1,j]\n#       \n#       dx[13,3,1,j]=dx[13,3,1,j]-RateStopTreatFirst[3]*x[13,3,1,j]-RateTreatToFailFirstSusc[3]*x[13,3,1,j]\n#       dx[14,3,1,j]=dx[14,3,1,j]-RateStopSuppFirst[3]*x[14,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[15,3,1,j]-RateSuppFirstToSecond[3]*x[14,3,1,j]\n#       dx[15,3,1,j]=dx[15,3,1,j]-RateStopFailFirst[3]*x[15,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[15,3,1,j]+RateTreatToFailFirstSusc[3]*x[13,3,1,j]\n#       \n#       dx[13,4,1,j]=dx[13,4,1,j]-RateStopTreatFirst[4]*x[13,4,1,j]-RateTreatToFailFirstSusc[4]*x[13,4,1,j]\n#       dx[14,4,1,j]=dx[14,4,1,j]-RateStopSuppFirst[4]*x[14,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[15,4,1,j]-RateSuppFirstToSecond[4]*x[14,4,1,j]\n#       dx[15,4,1,j]=dx[15,4,1,j]-RateStopFailFirst[4]*x[15,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[15,4,1,j]+RateTreatToFailFirstSusc[4]*x[13,4,1,j]\n#       #############################################################################################################################################################################\n#       #############################################################################################################################################################################\n#       \n#       dx[13,1,2,j]=dx[13,1,2,j]-RateStopTreatFirst[1]*x[13,1,2,j]-RateTreatToFailFirstResis[1]*x[13,1,2,j]\n#       dx[14,1,2,j]=dx[14,1,2,j]-RateStopSuppFirst[1]*x[14,1,2,j]+RateFailToSuppTreatFirstResis[1]*x[15,1,2,j]-RateSuppFirstToSecond[1]*x[14,1,2,j]\n#       dx[15,1,2,j]=dx[15,1,2,j]-RateStopFailFirst[1]*x[15,1,2,j]-RateFailToSuppTreatFirstResis[1]*x[15,1,2,j]+RateTreatToFailFirstResis[1]*x[13,1,2,j]\n#       \n#       dx[13,2,2,j]=dx[13,2,2,j]-RateStopTreatFirst[2]*x[13,2,2,j]-RateTreatToFailFirstResis[2]*x[13,2,2,j]\n#       dx[14,2,2,j]=dx[14,2,2,j]-RateStopSuppFirst[2]*x[14,2,2,j]+RateFailToSuppTreatFirstResis[2]*x[15,2,2,j]-RateSuppFirstToSecond[2]*x[14,2,2,j]\n#       dx[15,2,2,j]=dx[15,2,2,j]-RateStopFailFirst[2]*x[15,2,2,j]-RateFailToSuppTreatFirstResis[2]*x[15,2,2,j]+RateTreatToFailFirstResis[2]*x[13,2,2,j]\n#       \n#       dx[13,3,2,j]=dx[13,3,2,j]-RateStopTreatFirst[3]*x[13,3,2,j]-RateTreatToFailFirstResis[3]*x[13,3,2,j]\n#       dx[14,3,2,j]=dx[14,3,2,j]-RateStopSuppFirst[3]*x[14,3,2,j]+RateFailToSuppTreatFirstResis[3]*x[15,3,2,j]-RateSuppFirstToSecond[3]*x[14,3,2,j]\n#       dx[15,3,2,j]=dx[15,3,2,j]-RateStopFailFirst[3]*x[15,3,2,j]-RateFailToSuppTreatFirstResis[3]*x[15,3,2,j]+RateTreatToFailFirstResis[3]*x[13,3,2,j]\n#       \n#       dx[13,4,2,j]=dx[13,4,2,j]-RateStopTreatFirst[4]*x[13,4,2,j]-RateTreatToFailFirstResis[4]*x[13,4,2,j]\n#       dx[14,4,2,j]=dx[14,4,2,j]-RateStopSuppFirst[4]*x[14,4,2,j]+RateFailToSuppTreatFirstResis[4]*x[15,4,2,j]-RateSuppFirstToSecond[4]*x[14,4,2,j]\n#       dx[15,4,2,j]=dx[15,4,2,j]-RateStopFailFirst[4]*x[15,4,2,j]-RateFailToSuppTreatFirstResis[4]*x[15,4,2,j]+RateTreatToFailFirstResis[4]*x[13,4,2,j]\n#       \n#       #Resistance acquisition and reversion\n#       dx[15,1,2,j]=dx[15,1,2,j]+RateResistant*x[15,1,1,j]\n#       dx[15,2,2,j]=dx[15,2,2,j]+RateResistant*x[15,2,1,j]\n#       dx[15,3,2,j]=dx[15,3,2,j]+RateResistant*x[15,3,1,j]\n#       dx[15,4,2,j]=dx[15,4,2,j]+RateResistant*x[15,4,1,j]\n#       \n#       dx[15,1,1,j]=dx[15,1,1,j]-RateResistant*x[15,1,1,j]\n#       dx[15,2,1,j]=dx[15,2,1,j]-RateResistant*x[15,2,1,j]\n#       dx[15,3,1,j]=dx[15,3,1,j]-RateResistant*x[15,3,1,j]\n#       dx[15,4,1,j]=dx[15,4,1,j]-RateResistant*x[15,4,1,j]\n#     }\n#     dx[x+dx<0]=0\n#     \n#     death_w_inel_2018=ifelse(sum(x[13:15,1:4,1:2,2])==0,\n#                              0,sum(x[13:15,1:4,1:2,2]*mu[3:5,1:4,1:2])/sum(x[13:15,1:4,1:2,2]))\n#     res=c(dx,death_w_inel_2018,rep(0,9))\n#     \n#     return(c(res))\n#     #return(list(c(res,newinf,newsu,newres,death)))\n#     #})\n#   })\n# }\n# #18\n# mod_dtg=function(t,x,p1,treat_dtg,parms){\n#   \n#   parms2=mod_rate(t,x,p1,treat_dtg,parms)\n#   dx=array(0,dim=c(18,4,2,2))\n#   x=array(x,dim=c(18,4,2,2))\n#   \n#   #Define comp_time globally, used here to fix time from which dtg-ineligible ind go to compartments 16\n#   \n#   with(as.list(parms2), {\n#     for(j in 1:2){\n#       dx[16,1,1,j]=dx[16,1,1,j]+RateTreatFirst_noDTG[1,1,j]*x[12,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[16,1,1,j]+RateStageTreatFirstL[1]*x[16,2,1,j]\n#       dx[17,1,1,j]=dx[17,1,1,j]+RateSuppFirstSusc[1]*x[16,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[17,1,1,j]+RateStageSuppFirst[1]*x[17,2,1,j]\n#       dx[18,1,1,j]=dx[18,1,1,j]+RateFailFirstSusc[1]*x[17,1,1,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,1])*x[18,1,1,j]\n#       \n#       dx[16,2,1,j]=dx[16,2,1,j]+RateTreatFirst_noDTG[1,2,j]*x[12,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[16,2,1,j]+RateStageTreatFirstR[1]*x[16,1,1,j]+RateStageTreatFirstL[2]*x[16,3,1,j]\n#       dx[17,2,1,j]=dx[17,2,1,j]+RateSuppFirstSusc[2]*x[16,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[17,2,1,j]+RateStageSuppFirst[2]*x[17,3,1,j]\n#       dx[18,2,1,j]=dx[18,2,1,j]+RateFailFirstSusc[2]*x[17,2,1,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,1])*x[18,2,1,j]+RateStageFailFirst[1]*x[18,1,1,j]\n#       \n#       dx[16,3,1,j]=dx[16,3,1,j]+RateTreatFirst_noDTG[1,3,j]*x[12,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[16,3,1,j]+RateStageTreatFirstR[2]*x[16,2,1,j]+RateStageTreatFirstL[3]*x[16,4,1,j]\n#       dx[17,3,1,j]=dx[17,3,1,j]+RateSuppFirstSusc[3]*x[16,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[17,3,1,j]+RateStageSuppFirst[3]*x[17,4,1,j]\n#       dx[18,3,1,j]=dx[18,3,1,j]+RateFailFirstSusc[3]*x[17,3,1,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,1])*x[18,3,1,j]+RateStageFailFirst[2]*x[18,2,1,j]\n#       \n#       dx[16,4,1,j]=dx[16,4,1,j]+RateTreatFirst_noDTG[1,4,j]*x[12,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[16,4,1,j]+RateStageTreatFirstR[3]*x[16,3,1,j]\n#       dx[17,4,1,j]=dx[17,4,1,j]+RateSuppFirstSusc[4]*x[16,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[17,4,1,j]\n#       dx[18,4,1,j]=dx[18,4,1,j]+RateFailFirstSusc[4]*x[17,4,1,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,1])*x[18,4,1,j]+RateStageFailFirst[3]*x[18,3,1,j]\n#       \n#       #NNRTI resistant\n#       dx[16,1,2,j]=dx[16,1,2,j]+RateTreatFirst_noDTG[2,1,j]*x[12,1,2,j]-(RateSuppFirstResis[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[16,1,2,j]+RateStageTreatFirstL[1]*x[16,2,2,j]\n#       dx[17,1,2,j]=dx[17,1,2,j]+RateSuppFirstResis[1]*x[16,1,2,j]-(RateFailFirstResis[1]+mu[4,1,2])*x[17,1,2,j]+RateStageSuppFirst[1]*x[17,2,2,j]\n#       dx[18,1,2,j]=dx[18,1,2,j]+RateFailFirstResis[1]*x[17,1,2,j]-(RateTreatSecond_noDTG[1,j]+RateStageFailFirst[1]+mu[5,1,2])*x[18,1,2,j]\n#       \n#       dx[16,2,2,j]=dx[16,2,2,j]+RateTreatFirst_noDTG[2,2,j]*x[12,2,2,j]-(RateSuppFirstResis[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2])*x[16,2,2,j]+RateStageTreatFirstR[1]*x[16,1,2,j]+RateStageTreatFirstL[2]*x[16,3,2,j]\n#       dx[17,2,2,j]=dx[17,2,2,j]+RateSuppFirstResis[2]*x[16,2,2,j]-(RateFailFirstResis[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[17,2,2,j]+RateStageSuppFirst[2]*x[17,3,2,j]\n#       dx[18,2,2,j]=dx[18,2,2,j]+RateFailFirstResis[2]*x[17,2,2,j]-(RateTreatSecond_noDTG[2,j]+RateStageFailFirst[2]+mu[5,2,2])*x[18,2,2,j]+RateStageFailFirst[1]*x[18,1,2,j]\n#       \n#       dx[16,3,2,j]=dx[16,3,2,j]+RateTreatFirst_noDTG[2,3,j]*x[12,3,2,j]-(RateSuppFirstResis[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[16,3,2,j]+RateStageTreatFirstR[2]*x[16,2,2,j]+RateStageTreatFirstL[3]*x[16,4,2,j]\n#       dx[17,3,2,j]=dx[17,3,2,j]+RateSuppFirstResis[3]*x[16,3,2,j]-(RateFailFirstResis[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[17,3,2,j]+RateStageSuppFirst[3]*x[17,4,2,j]\n#       dx[18,3,2,j]=dx[18,3,2,j]+RateFailFirstResis[3]*x[17,3,2,j]-(RateTreatSecond_noDTG[3,j]+RateStageFailFirst[3]+mu[5,3,2])*x[18,3,2,j]+RateStageFailFirst[2]*x[18,2,2,j]\n#       \n#       dx[16,4,2,j]=dx[16,4,2,j]+RateTreatFirst_noDTG[2,4,j]*x[12,4,2,j]-(RateSuppFirstResis[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[16,4,2,j]+RateStageTreatFirstR[3]*x[16,3,2,j]\n#       dx[17,4,2,j]=dx[17,4,2,j]+RateSuppFirstResis[4]*x[16,4,2,j]-(RateFailFirstResis[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[17,4,2,j]\n#       dx[18,4,2,j]=dx[18,4,2,j]+RateFailFirstResis[4]*x[17,4,2,j]-(RateTreatSecond_noDTG[4,j]+mu[5,4,2])*x[18,4,2,j]+RateStageFailFirst[3]*x[18,3,2,j]\n#       \n#       ##############################################################################################################################################################\n#       \n#       dx[16,1,1,j]=dx[16,1,1,j]-RateStopTreatFirst[1]*x[16,1,1,j]-RateTreatToFailFirstSusc[1]*x[16,1,1,j]\n#       dx[17,1,1,j]=dx[17,1,1,j]-RateStopSuppFirst[1]*x[17,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[18,1,1,j]-RateSuppFirstToSecond[1]*x[17,1,1,j]\n#       dx[18,1,1,j]=dx[18,1,1,j]-RateStopFailFirst[1]*x[18,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[18,1,1,j]+RateTreatToFailFirstSusc[1]*x[16,1,1,j]\n#       \n#       dx[16,2,1,j]=dx[16,2,1,j]-RateStopTreatFirst[2]*x[16,2,1,j]-RateTreatToFailFirstSusc[2]*x[16,2,1,j]\n#       dx[17,2,1,j]=dx[17,2,1,j]-RateStopSuppFirst[2]*x[17,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[18,2,1,j]-RateSuppFirstToSecond[2]*x[17,2,1,j]\n#       dx[18,2,1,j]=dx[18,2,1,j]-RateStopFailFirst[2]*x[18,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[18,2,1,j]+RateTreatToFailFirstSusc[2]*x[16,2,1,j]\n#       \n#       dx[16,3,1,j]=dx[16,3,1,j]-RateStopTreatFirst[3]*x[16,3,1,j]-RateTreatToFailFirstSusc[3]*x[16,3,1,j]\n#       dx[17,3,1,j]=dx[17,3,1,j]-RateStopSuppFirst[3]*x[17,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[18,3,1,j]-RateSuppFirstToSecond[3]*x[17,3,1,j]\n#       dx[18,3,1,j]=dx[18,3,1,j]-RateStopFailFirst[3]*x[18,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[18,3,1,j]+RateTreatToFailFirstSusc[3]*x[16,3,1,j]\n#       \n#       dx[16,4,1,j]=dx[16,4,1,j]-RateStopTreatFirst[4]*x[16,4,1,j]-RateTreatToFailFirstSusc[4]*x[16,4,1,j]\n#       dx[17,4,1,j]=dx[17,4,1,j]-RateStopSuppFirst[4]*x[17,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[18,4,1,j]-RateSuppFirstToSecond[4]*x[17,4,1,j]\n#       dx[18,4,1,j]=dx[18,4,1,j]-RateStopFailFirst[4]*x[18,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[18,4,1,j]+RateTreatToFailFirstSusc[4]*x[16,4,1,j]\n#       \n#       #############################################################################################################################################################################\n#       #############################################################################################################################################################################\n#       \n#       dx[16,1,2,j]=dx[16,1,2,j]-RateStopTreatFirst[1]*x[16,1,2,j]-RateTreatToFailFirstResis[1]*x[16,1,2,j]\n#       dx[17,1,2,j]=dx[17,1,2,j]-RateStopSuppFirst[1]*x[17,1,2,j]+RateFailToSuppTreatFirstResis[1]*x[18,1,2,j]-RateSuppFirstToSecond[1]*x[17,1,2,j]\n#       dx[18,1,2,j]=dx[18,1,2,j]-RateStopFailFirst[1]*x[18,1,2,j]-RateFailToSuppTreatFirstResis[1]*x[18,1,2,j]+RateTreatToFailFirstResis[1]*x[16,1,2,j]\n#       \n#       dx[16,2,2,j]=dx[16,2,2,j]-RateStopTreatFirst[2]*x[16,2,2,j]-RateTreatToFailFirstResis[2]*x[16,2,2,j]\n#       dx[17,2,2,j]=dx[17,2,2,j]-RateStopSuppFirst[2]*x[17,2,2,j]+RateFailToSuppTreatFirstResis[2]*x[18,2,2,j]-RateSuppFirstToSecond[2]*x[17,2,2,j]\n#       dx[18,2,2,j]=dx[18,2,2,j]-RateStopFailFirst[2]*x[18,2,2,j]-RateFailToSuppTreatFirstResis[2]*x[18,2,2,j]+RateTreatToFailFirstResis[2]*x[16,2,2,j]\n#       \n#       dx[16,3,2,j]=dx[16,3,2,j]-RateStopTreatFirst[3]*x[16,3,2,j]-RateTreatToFailFirstResis[3]*x[16,3,2,j]\n#       dx[17,3,2,j]=dx[17,3,2,j]-RateStopSuppFirst[3]*x[17,3,2,j]+RateFailToSuppTreatFirstResis[3]*x[18,3,2,j]-RateSuppFirstToSecond[3]*x[17,3,2,j]\n#       dx[18,3,2,j]=dx[18,3,2,j]-RateStopFailFirst[3]*x[18,3,2,j]-RateFailToSuppTreatFirstResis[3]*x[18,3,2,j]+RateTreatToFailFirstResis[3]*x[16,3,2,j]\n#       \n#       dx[16,4,2,j]=dx[16,4,2,j]-RateStopTreatFirst[4]*x[16,4,2,j]-RateTreatToFailFirstResis[4]*x[16,4,2,j]\n#       dx[17,4,2,j]=dx[17,4,2,j]-RateStopSuppFirst[4]*x[17,4,2,j]+RateFailToSuppTreatFirstResis[4]*x[18,4,2,j]-RateSuppFirstToSecond[4]*x[17,4,2,j]\n#       dx[18,4,2,j]=dx[18,4,2,j]-RateStopFailFirst[4]*x[18,4,2,j]-RateFailToSuppTreatFirstResis[4]*x[18,4,2,j]+RateTreatToFailFirstResis[4]*x[16,4,2,j]\n#       \n#       \n#       #Resistance acquisition and reversion\n#       dx[18,1,2,j]=dx[18,1,2,j]+RateResistant*x[18,1,1,j]\n#       dx[18,2,2,j]=dx[18,2,2,j]+RateResistant*x[18,2,1,j]\n#       dx[18,3,2,j]=dx[18,3,2,j]+RateResistant*x[18,3,1,j]\n#       dx[18,4,2,j]=dx[18,4,2,j]+RateResistant*x[18,4,1,j]\n#       \n#       dx[18,1,1,j]=dx[18,1,1,j]-RateResistant*x[18,1,1,j]\n#       dx[18,2,1,j]=dx[18,2,1,j]-RateResistant*x[18,2,1,j]\n#       dx[18,3,1,j]=dx[18,3,1,j]-RateResistant*x[18,3,1,j]\n#       dx[18,4,1,j]=dx[18,4,1,j]-RateResistant*x[18,4,1,j]\n#     }\n#     dx[x+dx<0]=0\n#     \n#     death_w_inel_2018=ifelse(sum(x[16:18,1:4,1:2,2])==0,\n#                              0,sum(x[16:18,1:4,1:2,2]*mu[3:5,1:4,1:2])/sum(x[16:18,1:4,1:2,2]))\n#     res=c(dx,death_w_inel_2018,rep(0,9))\n#     \n#     return(c(res))\n#     #return(list(c(res,newinf,newsu,newres,death)))\n#     #})\n#   })\n# }\n\n# \n# xstart1=c(runif(240,0,1),rep(0,10))\n# ru=runif(1,0,1)\n# \n# xstart2=c(rep(0,288),rep(0,10))\n# xstart2[select(1:15,1:4,1:2,1:2)]=xstart1[select_dtg_2(1:15,1:4,1:2,1:2)]\n# xstart2[select(16:18,1:4,1:2,1:2)]=ru*xstart2[select(13:15,1:4,1:2,1:2)]\n# xstart2[select(13:15,1:4,1:2,1:2)]=(1-ru)*xstart2[select(13:15,1:4,1:2,1:2)]\n# \n# d1=mod_dtg(50,xstart1,theta,treat_dtgb,params)\n# new_inf1=d1[241]\n# d1=d1[1:240]\n# d2=mod_dtg(50,xstart2,theta,treat_dtgb,params)\n# new_inf2=d2[289]\n# d2=d2[1:288]\n# a2=array(0,dim=c(15,4,2,2))\n# a2[13:15,1:4,1:2,1:2]=d2[select(16:18,1:4,1:2,1:2)]\n# \n# array(d1[select_dtg_2(1:15,1:4,1:2,1:2)],dim=c(15,4,2,2))-\n#   (array(d2[select(1:15,1:4,1:2,1:2)],dim=c(15,4,2,2))+a2)\n# new_inf1-new_inf2",
    "created" : 1556185118869.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "4|29|11|0|\n13|27|493|0|\n495|22|525|0|\n528|44|939|0|\n941|29|948|0|\n950|23|976|0|\n978|35|986|0|\n988|53|1013|0|\n1019|40|1070|0|\n1072|48|1622|0|\n1627|33|1634|0|\n1635|39|2199|0|\n2200|27|2227|0|\n2230|41|2947|0|\n2953|45|3095|0|\n3245|32|3252|0|\n3253|39|3281|0|\n3282|44|3866|0|\n3867|34|3881|0|\n",
    "hash" : "883924319",
    "id" : "60FB8062",
    "lastKnownWriteTime" : 1560248836,
    "last_content_update" : 1560248836975,
    "path" : "~/Step1/Rfiles/used scripts/marisa/parmin4_v3.R",
    "project_path" : null,
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 12,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}