{
    "collab_server" : "",
    "contents" : "library(deSolve)\nlibrary(zoo)\nlibrary(\"Rcpp\")\nlibrary(\"BH\")\nlibrary(\"RColorBrewer\")\nlibrary(utils)\nlibrary(xtable)\nlibrary(dplyr)\nsourceCpp(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/solvdiff_cpp.cpp\")\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/parmin4_v3.R\")\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n#source(\"C:/Users/ahauser/Documents/Step2/dtg/value_gender4_v4.R\")\n\n#Parameters with new diag rate 08.08.2018\np1=c(rate1_inf=3.35, rate2_inf=0.5, rate1_diag=300, rate2_diag=6, rate_treat=0.0025,rate_death=0.08)\np2=c(rate1_inf=NA, rate2_inf=NA, rate1_diag=NA, rate2_diag=NA, rate_treat=NA,rate_death=NA,q=0.1,rate_ratio=0.5,k1=1,k2=2,k3=2,alpha=2,rate_res=5,rate_susc=125)\n\n#Parameters with new diag rate 05.02.2019 (used only atm as no optimum found)\np1=c(rate1_inf=3.318999e+00, rate2_inf=5.440886e-01, rate1_diag=2.736363e+02, rate2_diag=7.710578e+00, rate_treat=1.879695e-03,rate_death=1.632000e-01)\np2=c(rate1_inf=NA, rate2_inf=NA, rate1_diag=NA, rate2_diag=NA, rate_treat=NA,rate_death=NA,q=0.05,rate_ratio=0.5,k1=1,k2=2,k3=2,alpha=2,rate_res=5,rate_susc=125)\np2=c(p2,res_test=0)\n\n#resistance data\ndata_csv<-read.csv(\"C:/Users/ahauser/Documents/Step1/Excelfiles/GREGSON_FINAL_data_WHOHIVDR23052017.csv\")\ndata_csv<-data_csv[which(data_csv$Country==\"South Africa\"),]\ndata_csv<-data_csv[data_csv$Mid_Point_Year>=2005,]\ndata_csv<-read.csv(\"C:/Users/ahauser/Documents/Step1/Excelfiles/HNP_StatsData.csv\")\ndata_csv=data_csv[data_csv$Country.Code==\"TLA\",]\nhnp_cov = filter(data_csv,Indicator.Code %in% c(\"SH.HIV.ARTC.ZS\"))%>%\n  left_join(country_key) %>%\n  arrange(CountryID,year) %>%\n  select(Country.Name,CountryID,year,prop=value) %>%\n  left_join(hnp_hivprev) %>% \n  mutate(value=prop*value/100) %>%\n  mutate(Indicator=\"Adults living with HIV on ART (M)\") %>%\n  select(-prop)\n\n#Prepare the data\ntimes=1:133\ntheta=p1\nxstart=xstart_f(p2)\nparams[[\"RateDirectTreatSecond\"]]=c(0,0,0,0)\ndata=my_fun10_solver2(xstart,theta,params,p2)\ndata<-data_convert_to_old(data)\nfigures_2(data,tdr_p=1,new_diag=TRUE,tdr_cd4 = TRUE)\n\nparams[[\"RateTreatSecond\"]]=params[[\"RateTreatSecond\"]]/5\nrowSums(data[seq(1,tmax,1),1+select(6:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])\nrowSums(data[seq(1,tmax,1),1+select(5,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(3:5,1:4,1:2,1:2)])\nrowSums(data[seq(1,tmax,1),1+select(c(5,8),1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(4,5,7,8),1:4,1:2,1:2)])\nrowSums(data[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\nrowSums(data[seq(1,tmax,1),1+select(5,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(4:5,1:4,1:2,1:2)])\ndiff(rowSums(data[seq(1,tmax,1),1+select(6:8,1:4,1:2,1:2)]))/rowSums(data[seq(1,tmax,1),1+select(5,1:4,1:2,1:2)])\n\n\n###################################################################################################\n#Model outcome\n#figure now\nfigures_2=function(data,cex_t=1.5,cex_l=2,width=4,tdr_p=1,new_diag=FALSE,tdr_cd4=FALSE){\n  #Time axis\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  \n  #Data\n  new_infected=rollapply(diff(data[1:tmax,\"129\"]),12,sum)\n  death_people=rollapply(diff(data[1:tmax,\"131\"]),12,sum)\n  undiag_people=rowSums(data[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people=rowSums(data[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people=rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr=rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),1:4,1:2,1:2)])\n  trandr1=rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),1,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),1,1:2,1:2)])\n  trandr2=rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),2,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),2,1:2,1:2)])\n  trandr3=rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),3,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),3,1:2,1:2)])\n  trandr4=rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),4,1:2,1:2)])\n  \n  new_diag_susc=diff(data[1:tmax,\"136\"])\n  new_diag_res=diff(data[1:tmax,\"137\"])\n  tdr_new_diag=new_diag_res/(new_diag_susc+new_diag_res)\n  \n  if(tdr_p==1){\n    tdr_title=\"F. TDR prevalence (undiagnosed people)\"\n  }\n  if(new_diag & tdr_p==1){\n    trandr=c(NA,tdr_new_diag)\n    tdr_title=\"F. TDR prevalence (newly diagnosed)\"\n  }\n  if(tdr_p==2){\n    tdr_title=\"F. TDR prevalence (diagnosed people)\"\n  }\n  \n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  m <- matrix(c(1,2,3,4,5,6,7,7,8,8),nrow = 5,ncol = 2,byrow = TRUE)\n  graphics::layout(mat = m,heights = c(0.29,0.29,0.32,0.05,0.05),widths=c(0.5,0.5))\n\n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2015+11/12,length.out=11),newinf_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(c(newinf_value,new_infected))),xaxt='n',xlab=\"\",ylab=\"\",main=\"A. Newly infected\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected,type=\"l\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot2\n  par(mai=c(0.2,0.7,0.5,0.4))\n  #plot(2005.5:2015.5,apply(undiag_value,1,sum),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(apply(undiag_value,1,sum),undiag_people)),xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  plot(2005.5:2015.5,undiag_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(undiag_value,undiag_people)),xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people,type=\"l\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot3\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2015+11/12,length.out=11),death_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(death_value,death_people)),xaxt='n',xlab=\"\",ylab=\"\",main=\"C. AIDS-related deaths\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people,type=\"l\",col=\"black\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot4\n  par(mai=c(0.2,0.7,0.5,0.4))\n  #plot(2005.5:2015.5,c(rep(NA,5),treat_percent*100),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(treat_percent,treat_people)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  plot(seq(2005.5,2015.5,length.out=11),treat_percent*100,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(treat_percent,treat_people)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,type=\"l\",col=\"black\",lwd=width)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  \n  width_ci=2\n  #Plot5\n  par(mai=c(0.8,0.8,0.5,0.4))\n  plot(2005.5:2016.5,c(rep(NA,5),88,NA,NA,NA,95,NA,NA),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(resis_people[-1])*100,100),xaxt='n',xlab=\"\",ylab=\"\",main=\"E. ADR (Failing 1st-line)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.5,cex.lab=2.2,cex=2,lwd=3)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),type=\"l\",col=\"black\",lwd=width)\n  segments(2010.5,80.3, 2010.5, 93.3,col=\"blue\",lwd=width_ci)\n  segments(2010,80.3, 2011, 80.3,col=\"blue\",lwd=width_ci)\n  segments(2010,93.3, 2011, 93.3,col=\"blue\",lwd=width_ci)\n  segments(2014.5,93.7, 2014.5, 96.7,col=\"blue\",lwd=width_ci)\n  segments(2014,93.7, 2015, 93.7,col=\"blue\",lwd=width_ci)\n  segments(2014,96.7, 2015, 96.7,col=\"blue\",lwd=width_ci)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  #Plot6\n  colcd4=brewer.pal(n = 6, name =\"YlOrRd\")\n  par(mai=c(0.8,0.7,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (undiagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,15),xaxt='n',xlab=\"\",ylab=\"\",main=tdr_title,pch=1,col=\"blue\",cex.main=2,cex.axis=2.5,cex.lab=2.5,cex=2,lwd=3)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  if(tdr_cd4){\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr1*100,type=\"l\",col=colcd4[6],lwd=width-1,lty=5)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2*100,type=\"l\",col=colcd4[5],lwd=width-1,lty=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr3*100,type=\"l\",col=colcd4[4],lwd=width-1,lty=3)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr4*100,type=\"l\",col=colcd4[2],lwd=width-1,lty=2)\n  }\n  segments(2005,0, 2005, 5.7,col=\"blue\",lwd=width_ci)\n  segments(2004.5,0, 2005.5, 0,col=\"blue\",lwd=width_ci)\n  segments(2004.5,5.7, 2005.5, 5.7,col=\"blue\",lwd=width_ci)\n  segments(2009,0.1, 2009, 12.7,col=\"blue\",lwd=width_ci)\n  segments(2008.5,0.1, 2009.5, 0.1,col=\"blue\",lwd=width_ci)\n  segments(2008.5,12.7, 2009.5, 12.7,col=\"blue\",lwd=width_ci)\n  segments(2011,3.2, 2011, 6.5,col=\"blue\",lwd=width_ci)\n  segments(2010.5,3.2, 2011.5, 3.2,col=\"blue\",lwd=width_ci)\n  segments(2010.5,6.5, 2011.5, 6.5,col=\"blue\",lwd=width_ci)\n  segments(2014,5.6, 2014,12.2,col=\"blue\",lwd=width_ci)\n  segments(2013.5,5.6, 2014.5, 5.6,col=\"blue\",lwd=width_ci)\n  segments(2013.5,12.2, 2014.5, 12.2,col=\"blue\",lwd=width_ci)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,tck=-0.1,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2,tck=-0.05)\n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  \n  legend(x=\"left\", inset =0,\n         c(\"Simulated by the model\",\"Estimated data (WHO)\",\"Data from previous studies\"),\n         lty=c(1,NA,NA),pch=c(NA,\"o\",\"o\"), lwd=c(2,3,3), col=c(\"black\",\"red\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.25,0.25,0.25),x.intersp = c(0.2,0.2,0.2),seg.len=0.5)\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  \n  legend(x=\"left\", inset =0,\n         c(\"CD4>500\",\"500>CD4>350\",\"350>CD4>200\",\"CD4<200\"),\n        lwd=c(2,2,2,2), col=c(colcd4[c(6,5,4,2)]),lty=c(5,4,3,2), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.15,0.15,0.15),x.intersp = c(0.15,0.15,0.15,0.15),seg.len = 0.5)\n  \n  }\n#figure_scen now\nfigures_scen=function(list_data,scen=c(\"Scen. 1\", \"Scen. 2\", \"Scen. 3\"),cex_t=1.5,cex_l=2,width=4,t_width=c(0.15,0.15,0.15,0.15)){\n  #Datasets 1,2,3,4\n  data=list_data[[1]]\n  data2=list_data[[2]]\n  data3=list_data[[3]]\n  data4=list_data[[4]]\n  #Time axis\n  tmax=times[length(times)]+1#because it times start at 0 but column of data at 1\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  \n  #Data\n  new_infected=rollapply(diff(data[1:tmax,\"129\"]),12,sum)\n  death_people=rollapply(diff(data[1:tmax,\"131\"]),12,sum)\n  undiag_people=rowSums(data[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people=rowSums(data[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people=rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr=rowSums(data[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  #Data2\n  new_infected2=rollapply(diff(data2[1:tmax,\"129\"]),12,sum)\n  death_people2=rollapply(diff(data2[1:tmax,\"131\"]),12,sum)\n  undiag_people2=rowSums(data2[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people2=rowSums(data2[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people2=rowSums(data2[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr2=rowSums(data2[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  #Data3\n  new_infected3=rollapply(diff(data3[1:tmax,\"129\"]),12,sum)\n  death_people3=rollapply(diff(data3[1:tmax,\"131\"]),12,sum)\n  undiag_people3=rowSums(data3[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people3=rowSums(data3[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people3=rowSums(data3[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr3=rowSums(data3[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  #Data4\n  new_infected4=rollapply(diff(data4[1:tmax,\"129\"]),12,sum)\n  death_people4=rollapply(diff(data4[1:tmax,\"131\"]),12,sum)\n  undiag_people4=rowSums(data4[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people4=rowSums(data4[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people4=rowSums(data4[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr4=rowSums(data4[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  \n  #TDR among newly diagnosed\n  trandr=c(NA,diff(data[1:tmax,\"137\"])/(diff(data[1:tmax,\"136\"])+diff(data[1:tmax,\"137\"])))\n  trandr2=c(NA,diff(data2[1:tmax,\"137\"])/(diff(data2[1:tmax,\"136\"])+diff(data2[1:tmax,\"137\"])))\n  trandr3=c(NA,diff(data3[1:tmax,\"137\"])/(diff(data3[1:tmax,\"136\"])+diff(data3[1:tmax,\"137\"])))\n  trandr4=c(NA,diff(data4[1:tmax,\"137\"])/(diff(data4[1:tmax,\"136\"])+diff(data4[1:tmax,\"137\"])))\n  #################################################################################################################\n  #not needed for the plots\n  minf=rowSums(data[seq(1,tmax,12),1+select(1:8,1:4,1:2,1)])\n  finf=rowSums(data[seq(1,tmax,12),1+select(1:8,1:4,1:2,2)])\n  \n  supp1=rowSums(data[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])\n  supp2=rowSums(data2[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])\n  supp3=rowSums(data3[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])\n  supp4=rowSums(data4[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])\n  \n  supp1p=rowSums(data[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(4,5),1:4,1:2,1:2)])\n  supp2p=rowSums(data2[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(c(4,5),1:4,1:2,1:2)])\n  supp3p=rowSums(data3[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(c(4,5),1:4,1:2,1:2)])\n  supp4p=rowSums(data4[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(4,5),1:4,1:2,1:2)])\n  \n  rowSums(data4[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  a=rowSums(data4[seq(1,tmax,1),1+select(c(4),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(4),1:4,1:2,1:2)])\n  b=rowSums(data[seq(1,tmax,1),1+select(c(4),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(4),1:4,1:2,1:2)])\n  #a/b\n  rowSums(data4[seq(1,tmax,1),1+select(c(3:5),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(3:5),1:4,1:2,1:2)])\n  ###################################################################################################################\n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4,5,6,7,7,8,8),nrow = 5,ncol = 2,byrow = TRUE)\n  layout(mat = m,heights = c(0.28,0.28,0.34,0.05,0.05),widths=c(0.5,0.5))\n\n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  #plot(seq(2005+11/12,2014+11/12,length.out=10),newinf_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(c(newinf_value,new_infected,new_infected2,new_infected3,new_infected4)),max(c(newinf_value,new_infected,new_infected2,new_infected3,new_infected4))),xaxt='n',xlab=\"\",ylab=\"\",main=\"A. Newly infected\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  plot(seq(time_start_diff,time_stop_diff,1/12),new_infected,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(c(newinf_value,new_infected,new_infected2,new_infected3,new_infected4))),xaxt='n',xlab=\"\",ylab=\"\",main=\"A. Newly infected\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected,type=\"l\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected4,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  \n  #Plot2\n  #par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  par(mai=c(0.2,0.7,0.5,0.4))\n  #plot(2005.5:2015.5,apply(undiag_value,1,sum),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(apply(undiag_value,1,sum),undiag_people,undiag_people2,undiag_people3,undiag_people4),max(apply(undiag_value,1,sum),undiag_people,undiag_people2,undiag_people3,undiag_people4)),xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),undiag_people,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(undiag_people,undiag_people2,undiag_people3,undiag_people4)),xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people4,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot3\n  par(mai=c(0.2,0.8,0.5,0.4))\n  #plot(seq(2005+11/12,2014+11/12,length.out=10),death_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(death_value,death_people,death_people2,death_people3,death_people4),max(death_value,death_people,death_people2,death_people3,death_people4)),xaxt='n',xlab=\"\",ylab=\"\",main=\"C. AIDS-related deaths\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  plot(seq(time_start_diff,time_stop_diff,1/12),death_people,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(death_value,death_people,death_people2,death_people3,death_people4)),xaxt='n',xlab=\"\",ylab=\"\",main=\"C. AIDS-related deaths\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people4,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot4\n  par(mai=c(0.2,0.7,0.5,0.4))\n  #plot(2005.5:2015.5,c(rep(NA,5),treat_percent*100),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(treat_percent,treat_people,treat_people2,treat_people3,treat_people4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(treat_percent,treat_people,treat_people2,treat_people3,treat_people4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people4*100,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  \n  #Plot5\n  #par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  par(mai=c(0.8,0.8,0.5,0.4))\n  #plot(2005.5:2016.5,c(rep(NA,5),88,NA,NA,NA,95,NA,NA),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,100),xaxt='n',xlab=\"\",ylab=\"\",main=\"E. ADR (Failing 1st-line)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,100),xaxt='n',xlab=\"\",ylab=\"\",main=\"E. ADR (Failing 1st-line)\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people2[13:length(resis_people2)]*100),type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people3[13:length(resis_people3)]*100),type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people4[13:length(resis_people4)]*100),type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  #Plot6\n  par(mai=c(0.8,0.7,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  #plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(trandr,trandr2,trandr3,trandr4,0.1,na.rm=TRUE)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"F. TDR Prevalence (Newly diagnosed)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(trandr,trandr2,trandr3,trandr4,0.1,na.rm=TRUE)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"F. TDR Prevalence (Newly diagnosed)\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr4*100,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,tck=-0.1,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2,tck=-0.05)\n  \n  #Legend\n  # par(lwd=1,mai=c(0,0,0,0))\n  # plot.new()\n  # legend(x=\"left\", inset =0,\n  #        c(\"Simulated by the model\",\"Estimated data (WHO)\",\"Data from previous studies\"),\n  #        lty=c(1,NA,NA),pch=c(NA,\"o\",\"o\"), lwd=c(2,3,3), col=c(\"black\",\"red\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.2,0.2,0.2))\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Model simulation\",scen),\n         lty=c(1,1,1,1),pch=c(NA,NA,NA,NA), lwd=c(2,2,2,2), col=c(\"black\",\"blue\",\"red\",\"orange\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = t_width,seg.len=c(1.2,1.2,1.2,1.2))\n}\n#figure_sens now\nfigures_sens=function(data_list,data_fit,cex_t=1.5,cex_l=2,new_diag=TRUE,col_d1=\"red\",col_d2=\"blue\"){\n  #Vector of last point for each iter\n  tmax=dim(data_list[[1]])[1]\n  inf_vec=lapply(data_list,function(x) rollapply(diff(x[1:tmax,\"129\"]),12,sum))\n  death_vec=lapply(data_list,function(x) rollapply(diff(x[1:tmax,\"131\"]),12,sum))\n  undiag_vec=lapply(data_list,function(x) rowSums(x[1:tmax,1+seq(1,121,8)]))\n  treat_vec=lapply(data_list,function(x) rowSums(x[1:tmax,1+select(3:8,1:4,1:2,1:2)])/rowSums(x[1:tmax,1+select(1:8,1:4,1:2,1:2)]))\n  resis_vec=lapply(data_list,function(x) rowSums(x[1:tmax,1+select(c(5),1:4,2,1:2)])/rowSums(x[1:tmax,1+select(c(5),1:4,1:2,1:2)]))\n  trandr_vec=lapply(data_list,function(x) rowSums(x[1:tmax,1+select(c(2),1:4,2,1:2)])/rowSums(x[1:tmax,1+select(c(2),1:4,1:2,1:2)]))\n  trandr2_vec=lapply(data_list,function(x) c(diff(x[1:tmax,\"137\"])/(diff(x[1:tmax,\"136\"])+diff(x[1:tmax,\"137\"]))))\n  #vector order\n  inf_mat=do.call(rbind, inf_vec)\n  inf_inf=apply(inf_mat,2,min)\n  inf_sup=apply(inf_mat,2,max)\n  inf_med=apply(inf_mat,2,median)\n  death_mat=do.call(rbind, death_vec)\n  death_inf=apply(death_mat,2,min)\n  death_sup=apply(death_mat,2,max)\n  death_med=apply(death_mat,2,median)\n  undiag_mat=do.call(rbind, undiag_vec)\n  undiag_inf=apply(undiag_mat,2,min)\n  undiag_sup=apply(undiag_mat,2,max)\n  undiag_med=apply(undiag_mat,2,median)\n  treat_mat=do.call(rbind, treat_vec)\n  treat_inf=apply(treat_mat,2,min)\n  treat_sup=apply(treat_mat,2,max)\n  treat_med=apply(treat_mat,2,median)\n  resis_mat=do.call(rbind, resis_vec)\n  resis_inf=apply(resis_mat,2,min)\n  resis_sup=apply(resis_mat,2,max)\n  resis_med=apply(resis_mat,2,median)\n  trandr_mat=do.call(rbind, trandr_vec)\n  trandr_inf=apply(trandr_mat,2,min)\n  trandr_sup=apply(trandr_mat,2,max)\n  trandr_med=apply(trandr_mat,2,median)\n  trandr2_mat=do.call(rbind, trandr2_vec)\n  trandr2_inf=apply(trandr2_mat,2,min)\n  trandr2_sup=apply(trandr2_mat,2,max)\n  trandr2_med=apply(trandr2_mat,2,median)\n  \n  new_infected=rollapply(diff(data_fit[1:tmax,\"129\"]),12,sum)\n  death_people=rollapply(diff(data_fit[1:tmax,\"131\"]),12,sum)\n  undiag_people=rowSums(data_fit[seq(1,tmax,1),1+seq(1,121,8)])\n  treat_people=rowSums(data_fit[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data_fit[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people=rowSums(data_fit[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data_fit[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr=rowSums(data_fit[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data_fit[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  \n  if(new_diag){\n    trandr_inf=c(NA,trandr2_inf)\n    trandr_sup=c(NA,trandr2_sup)\n    trandr_med=c(NA,trandr2_med)\n    trandr=c(NA,diff(data_fit[1:tmax,\"137\"])/(diff(data_fit[1:tmax,\"136\"])+diff(data_fit[1:tmax,\"137\"])))\n  }\n  #t\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  #Graphical parameters\n  width=3\n  ##################################################################################################################\n  m <- matrix(c(1,2,3,4,5,6,7,7),nrow = 4,ncol = 2,byrow = TRUE)\n  layout(mat = m,heights = c(0.30,0.30,0.34,0.06),widths=c(0.5,0.5))\n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2014+11/12,length.out=10),newinf_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(c(newinf_value,inf_inf))*0,max(c(newinf_value,inf_sup))),xaxt='n',xlab=\"\",ylab=\"\",main=\"A. Newly infected\",pch=1,col=col_d1,cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),inf_inf,type=\"l\",lwd=1)\n  lines(seq(time_start_diff,time_stop_diff,1/12),inf_sup,type=\"l\",lwd=1)\n  polygon(c(seq(time_start_diff,time_stop_diff,1/12),rev(seq(time_start_diff,time_stop_diff,1/12))),\n          c(inf_sup,rev(inf_inf)),\n          col = rgb(0.5,0.5,0.5,0.5), border = NA)\n  #lines(seq(time_start_diff,time_stop_diff,1/12),new_infected,type=\"l\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),inf_med,type=\"l\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot2\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(2005.5:2015.5,apply(undiag_value,1,sum),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(apply(undiag_value,1,sum),undiag_inf)*0,max(apply(undiag_value,1,sum),undiag_sup)),xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",pch=1,col=col_d1,cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_inf,type=\"l\",lwd=1)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_sup,type=\"l\",lwd=1)\n  polygon(c(seq(time_start_abs,time_stop_abs,1/12),rev(seq(time_start_abs,time_stop_abs,1/12))),\n          c(undiag_sup,rev(undiag_inf)),\n          col = rgb(0.5,0.5,0.5,0.5), border = NA)\n  #lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people,type=\"l\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_med,type=\"l\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot3\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2014+11/12,length.out=10),death_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(death_value,death_inf)*0,max(death_value,death_sup)),xaxt='n',xlab=\"\",ylab=\"\",main=\"C. AIDS-related deaths\",pch=1,col=col_d1,cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_inf,type=\"l\",lwd=1)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_sup,type=\"l\",lwd=1)\n  polygon(c(seq(time_start_diff,time_stop_diff,1/12),rev(seq(time_start_diff,time_stop_diff,1/12))),\n          c(death_sup,rev(death_inf)),\n          col = rgb(0.5,0.5,0.5,0.5), border = NA)\n  #lines(seq(time_start_diff,time_stop_diff,1/12),death_people,type=\"l\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_med,type=\"l\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot4\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(2005.5:2015.5,c(rep(NA,5),treat_percent*100),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(treat_percent,treat_sup)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",pch=1,col=col_d1,cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_inf*100,type=\"l\",lwd=1)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_sup*100,type=\"l\",lwd=1)\n  polygon(c(seq(time_start_abs,time_stop_abs,1/12),rev(seq(time_start_abs,time_stop_abs,1/12))),\n          c(treat_sup*100,rev(treat_inf)*100),\n          col = rgb(0.5,0.5,0.5,0.5), border = NA)\n  #lines(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,type=\"l\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_med*100,type=\"l\",lwd=width)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  \n  #Plot5\n  par(mai=c(0.8,0.8,0.5,0.4))\n  plot(2005.5:2016.5,c(rep(NA,5),88,NA,NA,NA,95,NA,NA),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,100),xaxt='n',xlab=\"\",ylab=\"\",main=\"E. ADR (Failing 1st-line)\",pch=1,col=col_d2,cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12)[-(1:12)],(resis_inf*100)[-(1:12)],type=\"l\",lwd=1)\n  lines(seq(time_start_abs,time_stop_abs,1/12)[-(1:12)],(resis_sup*100)[-(1:12)],type=\"l\",lwd=1)\n  polygon(c(seq(time_start_abs,time_stop_abs,1/12)[-(1:12)],rev(seq(time_start_abs,time_stop_abs,1/12)[-(1:12)])),\n          c((resis_sup*100)[-(1:12)],rev((resis_inf*100)[-(1:12)])),\n          col = rgb(0.5,0.5,0.5,0.5), border = NA)\n  #lines(seq(time_start_abs,time_stop_abs,1/12)[-(1:12)],(resis_people*100)[-(1:12)],type=\"l\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12)[-(1:12)],(resis_med*100)[-(1:12)],type=\"l\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  \n  #Plot6\n  par(mai=c(0.8,0.7,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (newly)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(10,trandr_sup*100,na.rm=TRUE)),xaxt='n',xlab=\"\",ylab=\"\",main=\"F. TDR Prevalence (newly diagnosed)\",pch=1,col=col_d2,cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr_inf*100,type=\"l\",lwd=1)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr_sup*100,type=\"l\",lwd=1)\n  polygon(c(seq(time_start_abs,time_stop_abs,1/12),rev(seq(time_start_abs,time_stop_abs,1/12))),\n          c(trandr_sup*100,rev(trandr_inf)*100),\n          col = rgb(0.5,0.5,0.5,0.5), border = NA)\n  #lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr_med*100,type=\"l\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,tck=-0.1,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2,tck=-0.05)\n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Simulated by the model\",\"Estimated data (WHO)\",\"Data from previous studies\"),\n         lty=c(1,NA,NA),pch=c(NA,\"o\",\"o\"), lwd=c(2,3,3), col=c(\"black\",\"red\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.2,0.2,0.2))\n  \n}\n#figures_2(data) #Be careful: issue with my_fun10_solver2, when modifying smth in params and running, it will overwrite the data file even if saved with a different name\n#To prevent that, one option is to convert the data file with data_convert_to_old function\n#data sens function: return a list of h2 elements corresponding to sensitivity variation\nfigures_2((list_scen_data[[1]])[[1]],tdr_p=1,new_diag=TRUE,tdr_cd4 = TRUE)\nsum((list_scen_data[[1]])[[1]])\nsum(data)\n#Figure\nfigures_2(data,tdr_p=1,new_diag=TRUE,tdr_cd4 = TRUE)\nfigures_2(data,tdr_p=1,new_diag=TRUE,tdr_cd4 = FALSE)\nloglikwrap(theta)\n#resistance in newly diagnosed\ntmax=dim(data)[1]\nnew_diag_susc=diff(data[1:tmax,\"136\"])\nnew_diag_res=diff(data[1:tmax,\"137\"])\ntdr_new_diag=new_diag_res/(new_diag_susc+new_diag_res)\n#resistance in newly infected, newly diagnosed (cd4 class 1 and 4) and newly treated\nres_new_inf<-rollapply(diff(data[1:tmax,\"133\"]),1,sum)/rollapply(diff(data[1:tmax,\"129\"]),1,sum)\nres_new_treat<-rollapply(diff(data[1:tmax,\"135\"]),1,sum)/rollapply(diff(data[1:tmax,\"132\"]),1,sum)\nrowSums(data[seq(1,tmax,1),1+select(1,1,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1,1,1:2,1:2)])\nrowSums(data[seq(1,tmax,1),1+select(1,4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1,4,1:2,1:2)])\n#proportion of suppressed people\nrowSums(data[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(4:5,1:4,1:2,1:2)])\n#proportion of res. among new failing individual\ndiff(data[1:tmax,\"139\"])/(diff(data[1:tmax,\"138\"])+diff(data[1:tmax,\"139\"]))\n\n\n#Outcomes present in the paper\noutcome=function(data){\n  tmax=dim(data)[1]\n  #Diagnosis and treatment\n  rowSums(data[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  rowSums(data[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  rowSums(data[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  #new infections\n  rollapply(diff(data[1:tmax,\"129\"]),12,sum)\n  #deaths\n  rollapply(diff(data[1:tmax,\"131\"]),12,sum)\n  #adr\n  rowSums(data[seq(1,tmax,1),1+select(5,1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(5,1:4,1:2,1:2)])\n  #tdr\n  diff(data[1:tmax,\"137\"])/(diff(data[1:tmax,\"136\"])+diff(data[1:tmax,\"137\"]))\n  rowSums(data[seq(1,tmax,1),1+select(1,1,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1,1,1:2,1:2)])\n  rowSums(data[seq(1,tmax,1),1+select(1,1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  rowSums(data[seq(1,tmax,1),1+select(1,4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1,4,1:2,1:2)])\n  diff(data[1:tmax,\"133\"])/diff(data[1:tmax,\"129\"])\n  diff(data[1:tmax,\"135\"])/diff(data[1:tmax,\"132\"])\n  diff(data[1:tmax,\"139\"])/(diff(data[1:tmax,\"138\"])+diff(data[1:tmax,\"139\"]))\n  #death in infectious\n  rollapply(diff(data[1:tmax,\"134\"]),12,sum)\n  \n  (rowSums(data[seq(1,tmax,1),1+select(2:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)]))[1]\n  \n  (rowSums(data[seq(1,tmax,1),1+select(2:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)]))[tmax-1]\n  \n  sum(diff(data[1:97,\"134\"]))/8\n  \n  #(rowSums(data[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(2:8,1:4,1:2,1:2)]))[tmax-1]\n  (rowSums(data[seq(1,tmax,1),1+select(c(4,7),1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(4,5,7,8),1:4,1:2,1:2)]))[tmax-1]\n  rowSums(data[seq(1,tmax,1),1+select(c(4,7),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(4,5,7,8),1:4,2,1:2)])\n  \n  #diff(data[1:tmax,\"139\"])/(diff(data[1:tmax,\"138\"])+diff(data[1:tmax,\"139\"]))\n  \n  rowSums(data[seq(1,tmax,1),1+select(2:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  rowSums(data[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(2:8,1:4,1:2,1:2)])\n  rowSums(data[seq(1,tmax,1),1+select(c(4,7),1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(4,5,7,8),1:4,1:2,1:2)])\n  \n  }\n\noutcome((list_scen_data[[1]])[[1]])\n\na<-sapply(list_scen_data[[1]],function(x) outcome(x))\na<-apply(a[,-1],1,function(x) quantile(x,probs=c(0,1),na.rm=TRUE))\na\nfigures_2((list_scen_data[[1]])[[1]])\n\n#Special scenario: optimimal management of failure\nswitch_6=function(parms,p1,p2,switch){\n  parms<-within(parms,{RateTreatSecond=rep(1/switch,4)})\n  theta=p1\n  xstart=xstart_f(p2)\n  data=my_fun10_solver2(xstart,theta,parms,p2)\n  data<-data_convert_to_old(data)\n  return(data)\n}\ntimes=1:133\ndata=switch_6(params,p1,p2,5)\ndiff(data[1:tmax,\"137\"])/(diff(data[1:tmax,\"136\"])+diff(data[1:tmax,\"137\"]))\nrowSums(data[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\nfigures_2(data)\n\n#Special scenario: difference in mortality when increasing treatment rate\ndeath_infectious=function(parms,p1,p2,treat){\n  parms<-within(parms,{Treat_frame[,3:4]=Treat_frame[,3:4]*treat})\n  theta=p1\n  xstart=xstart_f(p2)\n  data=my_fun10_solver2(xstart,theta,parms,p2)\n  data<-data_convert_to_old(data)\n  return(data)\n}\ntmax=dim(data)[1]\ndata1=death_infectious(params,p1,p2,1)\nd1=rollapply(diff(data1[1:tmax,\"139\"]),12,sum)\ndata5=death_infectious(params,p1,p2,5)\nd5=rollapply(diff(data5[1:tmax,\"139\"]),12,sum)\nrollapply(diff(data1[1:tmax,\"131\"]),12,sum)-rollapply(diff(data1[1:tmax,\"139\"]),12,sum)\nd5-d1\n(d5-d1)/d1\n(rollapply(diff(data5[1:tmax,\"139\"]),12,sum)-rollapply(diff(data1[1:tmax,\"139\"]),12,sum))\nrollapply(diff(rowSums(data5[seq(1,tmax,1),1+select(c(4,7),1:4,1:2,1:2)])),12,sum)-rollapply(diff(rowSums(data1[seq(1,tmax,1),1+select(c(4,7),1:4,1:2,1:2)])),12,sum)\n\n###################################################################################################\n###################################################################################################\n#Some additional simulations: 1) contribution of tdr in resistance, 2)impact of no nnrti-res transmission, 3) diff in supp level between susc and res, 4) proportion of people going directly to 2nd-line\n#1. Proportion of ADR resistance in people failing treatment\np2[\"res_test\"]=0\nxstart=xstart_f(p2)\ndata=my_fun10_solver2(xstart,theta,params,p2)\ndata<-data_convert_to_old(data)\n\nrollapply(diff(data[1:tmax,\"129\"]),11,sum)/\n  (rollapply(diff(data[1:tmax,\"129\"]),11,sum)+rollapply(diff(data[1:tmax,\"131\"]),11,sum))\nrollapply(diff(data[1:tmax,\"133\"]),11,sum)/\n  (rollapply(diff(data[1:tmax,\"132\"]),11,sum)+rollapply(diff(data[1:tmax,\"133\"]),11,sum))\n \n#####----------------------------------------------------------------------------------------------------------\n#For 2) and 3): assume no treatment interuption\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\nparams=within(params,{\nRateStopTreatFirst=4.35/rep(Inf,4)\nRateStopSuppFirst=4.35/rep(Inf,4)\nRateStopFailFirst=4.35/rep(Inf,4)\nRateStopTreatSecond=4.35/rep(Inf,4) #Assumption : T2 same as T1\n#RateStopSuppSecond=4.35/c(390,725,660,1600),\nRateStopSuppSecond=4.35/rep(Inf,4) #Assumption : S2 same as S1\nRateStopFailSecond=4.35/rep(Inf,4) #Assumption : F2 same as F1\n})\n\n#####----------------------------------------------------------------------------------------------------------\n#2. impact of no nnrti-resistance transmission\n#baseline simulation\nxstart=xstart_f(p2)\ndata=my_fun10_solver2(xstart,theta,params,p2)\ndata<-data_convert_to_old(data)\n#no transmission of nnrti resistance\np2[\"rate_susc\"]=0.1\nxstart=xstart_f(p2)\nxstart[select(1,1:4,1,1:2)]=xstart[select(1,1:4,1,1:2)]+xstart[select(1,1:4,2,1:2)]\nxstart[select(1,1:4,2,1:2)]=0\nxstart[select(2,1:4,1,1:2)]=xstart[select(2,1:4,1,1:2)]+xstart[select(2,1:4,2,1:2)]\nxstart[select(2,1:4,2,1:2)]=0\nxstart[select(3,1:4,1,1:2)]=xstart[select(3,1:4,1,1:2)]+xstart[select(3,1:4,2,1:2)]\nxstart[select(3,1:4,2,1:2)]=0\ndata1=my_fun10_solver2(xstart,theta,params,p2)\ndata1<-data_convert_to_old(data1)\n#diff in level of suppression\ntmax=dim(data)[1]\na=(rowSums(data[seq(1,tmax,1),1+select(c(4,7),1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(3:8),1:4,1:2,1:2)]))\nb=(rowSums(data1[seq(1,tmax,1),1+select(c(4,7),1:4,1:2,1:2)])/rowSums(data1[seq(1,tmax,1),1+select(c(3:8),1:4,1:2,1:2)]))\nplot(a)\nlines(b)\n\n\n#####----------------------------------------------------------------------------------------------------------\n#3. Difference in treatment efficacy between nnrti-susceptible and -resistant individuals\nparams=within(params,{\n              RateTreatSecond=c(0,0,0,0)\n})\n#nnrti-susceptible\n#third 90 if all nnrti-susceptible\nxstart=xstart=rep(0,138)\nxstart[select(3,1:4,1,1:2)]=1\ntheta=p1\ndata=my_fun10_solver2(xstart,theta,params,p2)\ndata<-data_convert_to_old(data)\ntmax=dim(data)[1]\n(rowSums(data[seq(1,tmax,1),1+select(c(4),1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(4:5),1:4,1:2,1:2)]))\n#2 year : 78% ,5 year : 89%, 10 year: 91%\n\n#third 90 if all nnrti-resistant\nxstart=xstart=rep(0,138)\nxstart[select(3,1:4,2,1:2)]=1\ndata1=my_fun10_solver2(xstart,theta,params,p2)\ndata1<-data_convert_to_old(data1)\n(rowSums(data1[seq(1,tmax,1),1+select(c(4),1:4,1:2,1:2)])/rowSums(data1[seq(1,tmax,1),1+select(c(4:5),1:4,1:2,1:2)]))\n#2 year : 52% ,5 year : 75.5%, 10 year: 83%\n\n#####----------------------------------------------------------------------------------------------------------\n#4. Proportion of people directly going to 2nd line (response to reviewer 3, see return of mod_cpp)\n#no RT\np2[\"res_test\"]=0\nxstart=xstart_f(p2)\ndata=my_fun10_solver2(xstart,theta,params,p2)\ndata<-data_convert_to_old(data)\nrowSums(data[seq(1,tmax,1),1+select(c(3),1:4,2,1:2)])\nnew_treat<-rollapply(diff(data[1:tmax,\"129\"]),11,sum)+rollapply(diff(data[1:tmax,\"131\"]),11,sum)+\n  rollapply(diff(data[1:tmax,\"132\"]),11,sum)\nrollapply(diff(data[1:tmax,\"132\"]),11,sum)/new_treat\nrowSums(data[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n\n#RT\np2[\"res_test\"]=1\nxstart=xstart_f(p2)\nxstart[select(6,1:4,2,1:2)]=xstart[select(3,1:4,2,1:2)]\nxstart[select(3,1:4,2,1:2)]=0\ndata=my_fun10_solver2(xstart,theta,params,p2)\ndata<-data_convert_to_old(data)\nrowSums(data[seq(1,tmax,1),1+select(c(3),1:4,2,1:2)])\nnew_treat<-rollapply(diff(data[1:tmax,\"129\"]),11,sum)+rollapply(diff(data[1:tmax,\"131\"]),11,sum)+\n  rollapply(diff(data[1:tmax,\"132\"]),11,sum)\nrollapply(diff(data[1:tmax,\"132\"]),11,sum)/new_treat\nrowSums(data[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n###################################################################################################\n###################################################################################################\n#Function changing params according to scenario chosen, used in simulation_and_sensitivity_ub.R\n#Increasing treatment rate, takes less time to be treated\nscen1_params=function(acc_treat,params){\n  source(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n  params=within(params,{\n    Treat_frame[,3:4]=Treat_frame[,3:4]*acc_treat\n  })\n  return(params)\n}\n#how much faster will it be to switch to 2nd-line when patient on a failing treatment\nscen2_params=function(acc_treat,params){\n  source(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n  params[[\"RateTreatSecond\"]]=params[[\"RateTreatSecond\"]]*acc_treat\n  return(params)\n}\n#Earlier implementation of the Treat-All policy\nscen4_params=function(ant_treatall,params){\n  source(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n  params=within(params,{\n    Treat_frame2=data.frame(a=Treat_frame$a[1]-ant_treatall,b=Treat_frame$b[1]-ant_treatall,c=c(0,0,0,0),d=Treat_frame$d)\n    Treat_frame2$c=apply(Treat_frame,1,function(x) lin_st(Treat_frame$a[1]-ant_treatall,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))\n  })\n  return(params)\n}\n\n###################################################################################################\n#Counterfactual scenario and subsequent sensitivity analysis is done in simulation_and_sensitivity_ub.R\nrange_sensitivity=function(data_list){\n  \n  data=data_list[[1]]\n  tmax=dim(data)[1]\n  new_infected=rollapply(diff(data[1:tmax,\"129\"]),12,sum)\n  death_people=rollapply(diff(data[1:tmax,\"131\"]),12,sum)\n  undiag_people=rowSums(data[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people=rowSums(data[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people=rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr=c(NA,diff(data[1:tmax,\"137\"])/(diff(data[1:tmax,\"136\"])+diff(data[1:tmax,\"137\"])))\n  \n  h2=length(data_list)-1\n  mat_inf=matrix(NA,nrow=h2,ncol=tmax-12)\n  mat_death=matrix(NA,nrow=h2,ncol=tmax-12)\n  mat_undiag=matrix(NA,nrow=h2,ncol=tmax)\n  mat_treat=matrix(NA,nrow=h2,ncol=tmax)\n  mat_resis=matrix(NA,nrow=h2,ncol=tmax)\n  mat_trandr=matrix(NA,nrow=h2,ncol=tmax)\n  for(i in 1:h2){\n    data=data_list[[i+1]]\n    mat_inf[i,]=rollapply(diff(data[1:tmax,\"129\"]),12,sum)\n    mat_death[i,]=rollapply(diff(data[1:tmax,\"131\"]),12,sum)\n    mat_undiag[i,]=rowSums(data[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n    mat_treat[i,]=rowSums(data[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n    mat_resis[i,]=rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n    mat_trandr[i,]=c(NA,diff(data[1:tmax,\"137\"])/(diff(data[1:tmax,\"136\"])+diff(data[1:tmax,\"137\"])))\n  }\n  inf_minmax=apply(mat_inf,2,function(x) quantile(x,probs=c(0,1)))\n  death_minmax=apply(mat_death,2,function(x) quantile(x,probs=c(0,1)))\n  undiag_minmax=apply(mat_undiag,2,function(x) quantile(x,probs=c(0,1)))\n  treat_minmax=apply(mat_treat,2,function(x) quantile(x,probs=c(0,1)))\n  resis_minmax=apply(mat_resis,2,function(x) quantile(x,probs=c(0,1),na.rm=TRUE))\n  trandr_minmax=apply(mat_trandr,2,function(x) quantile(x,probs=c(0,1),na.rm=TRUE))\n  #trandr_minmax=cbind(c(NA,NA),trandr_minmax)\n  \n  return(list(inf_minmax,undiag_minmax,death_minmax,treat_minmax,resis_minmax,trandr_minmax))\n}\n#Relative diff in outcomes with and without sens for every counterfactual scenario\ntable_scen=function(scen_data_baseline,scen_data){\n  data=scen_data_baseline[[1]]\n  tmax=dim(data)[1]\n  \n  #Give a vector of length h2+1 of outcome in 2016, baseline scenario\n  death_b=sapply(scen_data_baseline,function(x) rollapply(diff(x[1:tmax,\"131\"]),12,sum)[121])\n  new_inf_b=sapply(scen_data_baseline,function(x) rollapply(diff(x[1:tmax,\"129\"]),12,sum)[121])\n  tdr_p_b=sapply(scen_data_baseline,function(x) (diff(x[1:tmax,\"137\"])/(diff(x[1:tmax,\"136\"])+diff(x[1:tmax,\"137\"])))[132])\n  tdr_a_b=sapply(scen_data_baseline,function(x) sum(diff(x[1:tmax,\"133\"])[121:132]))\n  adr_p_b=sapply(scen_data_baseline,function(x) (rowSums(x[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(x[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)]))[133])\n  adr_a_b=sapply(scen_data_baseline,function(x) sum(diff(x[1:tmax,\"138\"])[121:132]))\n  #Give a vector of length h2+1 of outcome in 2016, specified scenario\n  death=sapply(scen_data,function(x) rollapply(diff(x[1:tmax,\"131\"]),12,sum)[121])\n  new_inf=sapply(scen_data,function(x) rollapply(diff(x[1:tmax,\"129\"]),12,sum)[121])\n  tdr_p=sapply(scen_data,function(x) (diff(x[1:tmax,\"137\"])/(diff(x[1:tmax,\"136\"])+diff(x[1:tmax,\"137\"])))[132])\n  tdr_a=sapply(scen_data,function(x) sum(diff(x[1:tmax,\"133\"])[121:132]))\n  adr_p=sapply(scen_data,function(x) (rowSums(x[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(x[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)]))[133])\n  adr_a=sapply(scen_data,function(x) sum(diff(x[1:tmax,\"138\"])[121:132]))\n  \n  #quantile of relative differences in outcome according to sensitivity variation\n  m1=sprintf(\"%.1f\",quantile(((death-death_b)/1)[-1],probs=c(0,1)))\n  m2=sprintf(\"%.1f\",quantile(((new_inf-new_inf_b)/1)[-1],probs=c(0,1)))\n  m3=sprintf(\"%.1f\",quantile((100*(tdr_p-tdr_p_b)/1)[-1],probs=c(0,1)))\n  m4=sprintf(\"%.1f\",quantile(((tdr_a-tdr_a_b)/1)[-1],probs=c(0,1)))\n  m5=sprintf(\"%.1f\",quantile((100*(adr_p-adr_p_b)/1)[-1],probs=c(0,1)))\n  m6=sprintf(\"%.1f\",quantile(((adr_a-adr_a_b)/1)[-1],probs=c(0,1),na.rm=TRUE))\n  \n  #relative differences in outcome, no sensitivity variation\n  m1_m=sprintf(\"%.1f\", ((death-death_b)/1)[1])\n  m2_m=sprintf(\"%.1f\", ((new_inf-new_inf_b)/1)[1])\n  m3_m=sprintf(\"%.1f\", (100*(tdr_p-tdr_p_b)/1)[1])\n  m4_m=sprintf(\"%.1f\", ((tdr_a-tdr_a_b)/1)[1])\n  m5_m=sprintf(\"%.1f\", (100*(adr_p-adr_p_b)/1)[1])\n  m6_m=sprintf(\"%.1f\", ((adr_a-adr_a_b)/1)[1])\n  return(matrix(c(m1,m1_m,m2,m2_m,m3,m3_m,m5,m5_m,m4,m4_m,m6,m6_m),nrow=3))\n}\n#Figure plotting fit with sensitivity interval in light grey area\nfigure_fit=function(data_list,range_list,cex_t=1.5,cex_l=2,width=4,tdr_p=1,new_diag=FALSE,tdr_cd4=FALSE){\n  data=data_list[[1]]\n  tmax=dim(data)[1]\n  new_infected=rollapply(diff(data[1:tmax,\"129\"]),12,sum)\n  death_people=rollapply(diff(data[1:tmax,\"131\"]),12,sum)\n  undiag_people=rowSums(data[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people=rowSums(data[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people=rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr=c(NA,diff(data[1:tmax,\"137\"])/(diff(data[1:tmax,\"136\"])+diff(data[1:tmax,\"137\"])))\n  trandr1=rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),1,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),1,1:2,1:2)])\n  trandr2=rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),2,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),2,1:2,1:2)])\n  trandr3=rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),3,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),3,1:2,1:2)])\n  trandr4=rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(tdr_p),4,1:2,1:2)])\n  \n  #Time axis\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  \n  \n  tdr_title=\"NNRTI TDR\"\n  \n  \n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  m <- matrix(c(1,2,3,4,5,6,7,6,7,8,7,9,7,10,7,11,7,12),nrow = 9,ncol = 2,byrow = TRUE)\n  graphics::layout(mat = m,heights = c(1,1,1,0.3,0.1,rep(1.01/5,5)),widths=c(0.5,0.5))\n  \n  #Plot1\n  range=range_list[[1]]\n  par(mai=c(0.2,0.8,0.25,0.4))\n  plot(seq(2005+11/12,2015+11/12,length.out=11),newinf_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(c(newinf_value,new_infected))),xaxt='n',xlab=\"\",ylab=\"\",main=\"A. Newly infected\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  polygon(c(seq(time_start_diff,time_stop_diff,1/12),rev(seq(time_start_diff,time_stop_diff,1/12))),\n          c(range[2,],rev(range[1,])),\n          col = rgb(0.5,0.5,0.5,0.5), border = NA)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected,type=\"l\",lwd=width)\n  #lines(seq(2005+11/12,2014+11/12,length.out=10),newinf_value,pch=1,lwd=4,cex=2,type=\"p\")\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot2\n  range=range_list[[2]]\n  par(mai=c(0.2,0.7,0.25,0.4))\n  #plot(2005.5:2015.5,apply(undiag_value,1,sum),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(apply(undiag_value,1,sum),undiag_people)),xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  plot(2005.5:2015.5,undiag_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(undiag_value,undiag_people)),xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  polygon(c(seq(time_start_abs,time_stop_abs,1/12),rev(seq(time_start_abs,time_stop_abs,1/12))),\n          c(range[2,],rev(range[1,])),\n          col = rgb(0.5,0.5,0.5,0.5), border = NA)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people,type=\"l\",lwd=width)\n  #lines(2005.5:2015.5,undiag_value,pch=1,lwd=4,cex=2,type=\"p\")\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot3\n  range=range_list[[3]]\n  par(mai=c(0.2,0.8,0.25,0.4))\n  plot(seq(2005+11/12,2015+11/12,length.out=11),death_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(death_value,death_people)),xaxt='n',xlab=\"\",ylab=\"\",main=\"C. AIDS-related deaths\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  polygon(c(seq(time_start_diff,time_stop_diff,1/12),rev(seq(time_start_diff,time_stop_diff,1/12))),\n          c(range[2,],rev(range[1,])),\n          col = rgb(0.5,0.5,0.5,0.5), border = NA)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people,type=\"l\",col=\"black\",lwd=width)\n  #lines(seq(2005+11/12,2014+11/12,length.out=10),death_value,pch=1,lwd=4,cex=2,type=\"p\")\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot4\n  range=range_list[[4]]\n  par(mai=c(0.2,0.7,0.25,0.4))\n  plot(seq(2005.5,2015.5,length.out=11),treat_percent*100,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(treat_percent,treat_people)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  polygon(c(seq(time_start_abs,time_stop_abs,1/12),rev(seq(time_start_abs,time_stop_abs,1/12))),\n          c(range[2,],rev(range[1,]))*100,\n          col = rgb(0.5,0.5,0.5,0.5), border = NA)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,type=\"l\",col=\"black\",lwd=width)\n  #lines(seq(2005+11/12,2014+11/12,length.out=10),treat_percent*100,pch=1,lwd=4,cex=2,type=\"p\")\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  \n  width_ci=2\n  #Plot5\n  range=range_list[[5]]\n  range[,1:12]=NA\n  par(mai=c(0.2,0.8,0.25,0.4))\n  plot(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(resis_people[-1])*100,100),xaxt='n',xlab=\"\",ylab=\"\",main=\"E. NNRTI ADR\",pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2)\n  #plot(2005.5:2016.5,c(rep(NA,5),88,NA,NA,NA,95,NA,NA),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(resis_people[-1])*100,100),xaxt='n',xlab=\"\",ylab=\"\",main=\"E. ADR (Failing 1st-line)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=3)\n  polygon(c(seq(time_start_abs,time_stop_abs,1/12),rev(seq(time_start_abs,time_stop_abs,1/12))),\n          c(range[2,],rev(range[1,]))*100,\n          col = rgb(0.5,0.5,0.5,0.5), border = NA)\n  # segments(2010.5,80.3, 2010.5, 93.3,col=\"blue\",lwd=width_ci)\n  # segments(2010,80.3, 2011, 80.3,col=\"blue\",lwd=width_ci)\n  # segments(2010,93.3, 2011, 93.3,col=\"blue\",lwd=width_ci)\n  # segments(2014.5,93.7, 2014.5, 96.7,col=\"blue\",lwd=width_ci)\n  # segments(2014,93.7, 2015, 93.7,col=\"blue\",lwd=width_ci)\n  # segments(2014,96.7, 2015, 96.7,col=\"blue\",lwd=width_ci)\n  lines(c(2010.5,2014.5),c(88,95),pch=16,cex=10*sqrt(c(110,788)/788),col=rgb(0,0,1,0.4),type=\"p\")\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),type=\"l\",col=\"black\",lwd=width)\n  #lines(2005.5:2016.5,c(rep(NA,5),88,NA,NA,NA,95,NA,NA),pch=1,lwd=4,cex=2,type=\"p\")\n  #mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  #axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  #axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  #Plot6\n  range=range_list[[6]]\n  par(mai=c(0.8,0.7,0.25,0.4))\n  #plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,15),xaxt='n',xlab=\"\",ylab=\"\",main=tdr_title,pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2,lwd=3)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,15),xaxt='n',xlab=\"\",ylab=\"\",main=paste0(\"F. \",tdr_title),pch=1,cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  polygon(c(seq(time_start_abs,time_stop_abs,1/12),rev(seq(time_start_abs,time_stop_abs,1/12))),\n          c(c(range[2,]),rev(c(range[1,])))*100,\n          col = rgb(0.5,0.5,0.5,0.5), border = NA)\n  lines(data_csv$Mid_Point_Year,data_csv$n_nnrti/data_csv$n_geno*100,pch=16,cex=10*sqrt(data_csv$n_geno/max(data_csv$n_geno)),col=rgb(0,0,1,0.4),type=\"p\")\n  # segments(2005,0, 2005, 5.7,col=\"blue\",lwd=width_ci)\n  # segments(2004.5,0, 2005.5, 0,col=\"blue\",lwd=width_ci)\n  # segments(2004.5,5.7, 2005.5, 5.7,col=\"blue\",lwd=width_ci)\n  # segments(2009,0.1, 2009, 12.7,col=\"blue\",lwd=width_ci)\n  # segments(2008.5,0.1, 2009.5, 0.1,col=\"blue\",lwd=width_ci)\n  # segments(2008.5,12.7, 2009.5, 12.7,col=\"blue\",lwd=width_ci)\n  # segments(2011,3.2, 2011, 6.5,col=\"blue\",lwd=width_ci)\n  # segments(2010.5,3.2, 2011.5, 3.2,col=\"blue\",lwd=width_ci)\n  # segments(2010.5,6.5, 2011.5, 6.5,col=\"blue\",lwd=width_ci)\n  # segments(2014,5.6, 2014,12.2,col=\"blue\",lwd=width_ci)\n  # segments(2013.5,5.6, 2014.5, 5.6,col=\"blue\",lwd=width_ci)\n  # segments(2013.5,12.2, 2014.5, 12.2,col=\"blue\",lwd=width_ci)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  #lines(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),pch=1,lwd=4,cex=2,type=\"p\")\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,tck=-0.1,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2,tck=-0.05)\n  \n  #Plot 7\n  colcd4=brewer.pal(n = 6, name =\"YlOrRd\")\n  par(mai=c(0.8,0.8,0.25,0.4))\n  #plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,15),xaxt='n',xlab=\"\",ylab=\"\",main=tdr_title,pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2,lwd=3)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width,xlim=c(time_start_abs,time_stop_diff),ylim=c(0,15),xaxt='n',xlab=\"\",ylab=\"\",main=paste0(\"G. \",tdr_title),cex.main=2,cex.axis=2.2,cex.lab=2.5,cex=2)\n  lines(data_csv$Mid_Point_Year,data_csv$n_nnrti/data_csv$n_geno*100,pch=16,cex=10*sqrt(data_csv$n_geno/max(data_csv$n_geno)),col=rgb(0,0,1,0.4),type=\"p\")\n  #lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr1*100,type=\"l\",col=colcd4[6],lwd=width-1,lty=5)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2*100,type=\"l\",col=colcd4[5],lwd=width-1,lty=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr3*100,type=\"l\",col=colcd4[4],lwd=width-1,lty=3)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr4*100,type=\"l\",col=colcd4[2],lwd=width-1,lty=2)\n  \n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,tck=-0.1,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2,tck=-0.05)\n  \n  #Legend\n  par(lwd=1,mai=c(0,0.5,0,0))\n  plot.new()\n  \n  par(lwd=1,mai=c(0,0.5,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"MARISA sim.\",\"Thembisa data\"),\n         lty=c(1,NA),pch=c(NA,\"o\"), lwd=c(2,2), col=c(\"black\",\"red\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.25,0.4),x.intersp = c(0.15,0.15),seg.len=0.5)\n  \n  par(lwd=1,mai=c(0,0.5,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Observational data\"),\n         lty=c(NA),pch=c(16), lwd=c(3), col=rgb(0,0,1,0.4), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.2),x.intersp = c(0.2),seg.len=0.5)\n  \n  par(lwd=1,mai=c(0,0.5,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"CD4>500\",\"500>CD4>350\"),\n         lwd=c(2,2),pch=c(NA,NA), col=c(colcd4[c(6,5)]),lty=c(5,4), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.2,0.4),x.intersp = c(0.15,0.15),seg.len = 0.5)\n  \n  par(lwd=1,mai=c(0,0.5,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"350>CD4>200\",\"CD4<200\"),\n         lwd=c(2,2),pch=c(NA,NA), col=c(colcd4[c(4,2)]),lty=c(3,2), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.2,0.4),x.intersp = c(0.15,0.15),seg.len = 0.5)\n  \n}\n#Figure plotting counterfactual scenario with sensitivity interval in 2016 plot\nfigure_scen=function(list_scen_data,scen_n=1,cex_t=1.5,cex_l=2,width=4,t_width=c(0.15,0.15,0.15,0.15)){\n  scenarios=c(0,1,1,1,2,2,2,3,4,4,4)\n  scen_names=c(\"Baseline mod.\", \"2*rate\", \"3*rate\", \"5*rate\",\"2*rate\", \"5*rate\", \"10*rate\",\"Res. testing\",\"1.5 y\",\"3 y\", \"6 y\")\n  scen_ind=which(scenarios==scen_n)\n  if(scen_n==3){scen_ind=rep(scen_ind,4)}\n  scen_names=scen_names[scen_ind]\n  #Datasets 1,2,3,4\n  data_list=list_scen_data[[1]]\n  data_list2=list_scen_data[[scen_ind[1]]]\n  data_list3=list_scen_data[[scen_ind[2]]]\n  data_list4=list_scen_data[[scen_ind[3]]]\n  \n  data=data_list[[1]]\n  data2=data_list2[[1]]\n  data3=data_list3[[1]]\n  data4=data_list4[[1]]\n  \n  range_2016=sapply(range_sensitivity(data_list),function(x) x[,dim(x)[2]])\n  range2_2016=sapply(range_sensitivity(data_list2),function(x) x[,dim(x)[2]])\n  range3_2016=sapply(range_sensitivity(data_list3),function(x) x[,dim(x)[2]])\n  range4_2016=sapply(range_sensitivity(data_list4),function(x) x[,dim(x)[2]])\n  #Time axis\n  tmax=times[length(times)]+1#because it times start at 0 but column of data at 1\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  \n  #Data\n  new_infected=rollapply(diff(data[1:tmax,\"129\"]),12,sum)\n  death_people=rollapply(diff(data[1:tmax,\"131\"]),12,sum)\n  undiag_people=rowSums(data[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people=rowSums(data[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people=rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr=c(NA,diff(data[1:tmax,\"137\"])/(diff(data[1:tmax,\"136\"])+diff(data[1:tmax,\"137\"])))\n  #Data2\n  new_infected2=rollapply(diff(data2[1:tmax,\"129\"]),12,sum)\n  death_people2=rollapply(diff(data2[1:tmax,\"131\"]),12,sum)\n  undiag_people2=rowSums(data2[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people2=rowSums(data2[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people2=rowSums(data2[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr2=c(NA,diff(data2[1:tmax,\"137\"])/(diff(data2[1:tmax,\"136\"])+diff(data2[1:tmax,\"137\"])))\n  #Data3\n  new_infected3=rollapply(diff(data3[1:tmax,\"129\"]),12,sum)\n  death_people3=rollapply(diff(data3[1:tmax,\"131\"]),12,sum)\n  undiag_people3=rowSums(data3[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people3=rowSums(data3[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people3=rowSums(data3[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr3=c(NA,diff(data3[1:tmax,\"137\"])/(diff(data3[1:tmax,\"136\"])+diff(data3[1:tmax,\"137\"])))\n  #Data4\n  new_infected4=rollapply(diff(data4[1:tmax,\"129\"]),12,sum)\n  death_people4=rollapply(diff(data4[1:tmax,\"131\"]),12,sum)\n  undiag_people4=rowSums(data4[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people4=rowSums(data4[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people4=rowSums(data4[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr4=c(NA,diff(data4[1:tmax,\"137\"])/(diff(data4[1:tmax,\"136\"])+diff(data4[1:tmax,\"137\"])))\n  \n  #################################################################################################################\n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4,5,6,7,8,9,10,11,12,13,13,13,13),nrow = 4,ncol = 4,byrow = TRUE)\n  graphics::layout(mat = m,heights = c(1,1,1.2,0.2),widths=c(0.4,0.1,0.4,0.1))\n  \n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0))\n  yLow=sapply(list(range_2016,range2_2016,range3_2016,range4_2016),function(x) x[1,1])\n  yHigh=sapply(list(range_2016,range2_2016,range3_2016,range4_2016),function(x) x[2,1])\n  ylim=ylim=c(min(c(0,newinf_value,new_infected,new_infected2,new_infected3,new_infected4,yLow))*0.9,max(c(newinf_value,new_infected,new_infected2,new_infected3,new_infected4,yHigh))*1.1)\n  plot(seq(time_start_diff,time_stop_diff,1/12),new_infected,xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"A. Newly infected\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected,type=\"l\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected4,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  par(mai=c(0.2,0,0.5,0.4))\n  plot(1:4,sapply(list(new_infected,new_infected2,new_infected3,new_infected4),function(x) x[length(x)]),xlim=c(0.2,4.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\",\"red\",\"orange\"))\n  arrows(1:4,yHigh,1:4,yLow,col=c(\"black\",\"blue\",\"red\",\"orange\"),angle=90,length=0.06,code=3)\n  \n  #Plot2\n  #par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  par(mai=c(0.2,0.7,0.5,0))\n  yLow=sapply(list(range_2016,range2_2016,range3_2016,range4_2016),function(x) x[1,2])\n  yHigh=sapply(list(range_2016,range2_2016,range3_2016,range4_2016),function(x) x[2,2])\n  ylim=c(min(0,undiag_people,undiag_people2,undiag_people3,undiag_people4,yLow)*0.9,max(undiag_people,undiag_people2,undiag_people3,undiag_people4,yHigh)*1.1)\n  plot(seq(time_start_abs,time_stop_abs,1/12),undiag_people,xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people4,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  par(mai=c(0.2,0,0.5,0.4))\n  plot(1:4,sapply(list(undiag_people,undiag_people2,undiag_people3,undiag_people4),function(x) x[length(x)]),xlim=c(0.2,4.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\",\"red\",\"orange\"))\n  arrows(1:4,yHigh,1:4,yLow,col=c(\"black\",\"blue\",\"red\",\"orange\"),angle=90,length=0.06,code=3)\n  \n  #Plot3\n  par(mai=c(0.2,0.8,0.5,0))\n  yLow=sapply(list(range_2016,range2_2016,range3_2016,range4_2016),function(x) x[1,3])\n  yHigh=sapply(list(range_2016,range2_2016,range3_2016,range4_2016),function(x) x[2,3])\n  ylim=c(min(0,death_value,death_people,death_people2,death_people3,death_people4,yLow)*0.9,max(death_value,death_people,death_people2,death_people3,death_people4))\n  plot(seq(time_start_diff,time_stop_diff,1/12),death_people,xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"C. AIDS-related deaths\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people4,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  par(mai=c(0.2,0,0.5,0.4))\n  plot(1:4,sapply(list(death_people,death_people2,death_people3,death_people4),function(x) x[length(x)]),xlim=c(0.2,4.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\",\"red\",\"orange\"))\n  arrows(1:4,yHigh,1:4,yLow,col=c(\"black\",\"blue\",\"red\",\"orange\"),angle=90,length=0.06,code=3)\n  \n  #Plot4\n  par(mai=c(0.2,0.7,0.5,0))\n  yLow=sapply(list(range_2016,range2_2016,range3_2016,range4_2016),function(x) x[1,4])\n  yHigh=sapply(list(range_2016,range2_2016,range3_2016,range4_2016),function(x) x[2,4])\n  ylim=c(0,max(treat_percent,treat_people,treat_people2,treat_people3,treat_people4,yHigh)*100)\n  #plot(2005.5:2015.5,c(rep(NA,5),treat_percent*100),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(treat_percent,treat_people,treat_people2,treat_people3,treat_people4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people4*100,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  par(mai=c(0.2,0,0.5,0.4))\n  plot(1:4,sapply(list(treat_people,treat_people2,treat_people3,treat_people4),function(x) x[length(x)]*100),xlim=c(0.2,4.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\",\"red\",\"orange\"))\n  arrows(1:4,yHigh*100,1:4,yLow*100,col=c(\"black\",\"blue\",\"red\",\"orange\"),angle=90,length=0.06,code=3)\n  \n  #Plot5\n  par(mai=c(0.8,0.8,0.5,0))\n  yLow=sapply(list(range_2016,range2_2016,range3_2016,range4_2016),function(x) x[1,5])\n  yHigh=sapply(list(range_2016,range2_2016,range3_2016,range4_2016),function(x) x[2,5])\n  ylim=c(30,100)\n  plot(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"E. NNRTI ADR\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people2[13:length(resis_people2)]*100),type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people3[13:length(resis_people3)]*100),type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people4[13:length(resis_people4)]*100),type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  par(mai=c(0.8,0,0.5,0.4))\n  plot(1:4,sapply(list(resis_people,resis_people2,resis_people3,resis_people4),function(x) x[length(x)]*100),xlim=c(0.2,4.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\",\"red\",\"orange\"))\n  arrows(1:4,yHigh*100,1:4,yLow*100,col=c(\"black\",\"blue\",\"red\",\"orange\"),angle=90,length=0.06,code=3)\n  \n  #Plot6\n  par(mai=c(0.8,0.7,0.5,0))\n  yLow=sapply(list(range_2016,range2_2016,range3_2016,range4_2016),function(x) x[1,6])\n  yHigh=sapply(list(range_2016,range2_2016,range3_2016,range4_2016),function(x) x[2,6])\n  ylim=c(0,max(trandr,trandr2,trandr3,trandr4,0.1,yHigh,na.rm=TRUE)*100*1.1)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"F. NNRTI TDR\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr4*100,type=\"l\",col=\"orange\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,tck=-0.1,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2,tck=-0.05)\n  par(mai=c(0.8,0,0.5,0.4))\n  plot(1:4,sapply(list(trandr,trandr2,trandr3,trandr4),function(x) x[length(x)]*100),xlim=c(0.2,4.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\",\"red\",\"orange\"))\n  arrows(1:4,yHigh*100,1:4,yLow*100,col=c(\"black\",\"blue\",\"red\",\"orange\"),angle=90,length=0.06,code=3)\n  \n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Model sim\",scen_names),\n         lty=c(1,1,1,1),pch=c(NA,NA,NA,NA), lwd=c(2,2,2,2), col=c(\"black\",\"blue\",\"red\",\"orange\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = t_width,seg.len=c(1.2,1.2,1.2,1.2))\n}\nfigure_scen=function(list_scen_data,scen_n=1,cex_t=1.5,cex_l=2,width=4,t_width=c(0.15,0.15,0.15,0.15)){\n  scenarios=c(0,1,1,1,2,2,2,3,4,4,4)\n  scen_names=c(\"Baseline mod.\", \"2*rate\", \"3*rate\", \"5*rate\",\"2*rate\", \"5*rate\", \"10*rate\",\"Res. testing\",\"1.5 y\",\"3 y\", \"6 y\")\n  scen_ind=which(scenarios==scen_n)\n  scen_names=scen_names[scen_ind]\n  #Datasets 1,2,3,4\n  data_list=list_scen_data[[1]]\n  data_list2=list_scen_data[[scen_ind[1]]]\n \n  data=data_list[[1]]\n  data2=data_list2[[1]]\n  \n  range_2016=sapply(range_sensitivity(data_list),function(x) x[,dim(x)[2]])\n  range2_2016=sapply(range_sensitivity(data_list2),function(x) x[,dim(x)[2]])\n  #Time axis\n  tmax=times[length(times)]+1#because it times start at 0 but column of data at 1\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  \n  #Data\n  new_infected=rollapply(diff(data[1:tmax,\"129\"]),12,sum)\n  death_people=rollapply(diff(data[1:tmax,\"131\"]),12,sum)\n  undiag_people=rowSums(data[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people=rowSums(data[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people=rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr=c(NA,diff(data[1:tmax,\"137\"])/(diff(data[1:tmax,\"136\"])+diff(data[1:tmax,\"137\"])))\n  #Data2\n  new_infected2=rollapply(diff(data2[1:tmax,\"129\"]),12,sum)\n  death_people2=rollapply(diff(data2[1:tmax,\"131\"]),12,sum)\n  undiag_people2=rowSums(data2[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people2=rowSums(data2[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people2=rowSums(data2[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr2=c(NA,diff(data2[1:tmax,\"137\"])/(diff(data2[1:tmax,\"136\"])+diff(data2[1:tmax,\"137\"])))\n  #################################################################################################################\n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4,5,6,7,8,9,10,11,12,13,13,13,13),nrow = 4,ncol = 4,byrow = TRUE)\n  graphics::layout(mat = m,heights = c(1,1,1.2,0.2),widths=c(0.4,0.1,0.4,0.1))\n  \n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0))\n  yLow=sapply(list(range_2016,range2_2016),function(x) x[1,1])\n  yHigh=sapply(list(range_2016,range2_2016),function(x) x[2,1])\n  ylim=ylim=c(min(c(0,newinf_value,new_infected,new_infected2,yLow))*0.9,max(c(newinf_value,new_infected,new_infected2,yHigh))*1.1)\n  plot(seq(time_start_diff,time_stop_diff,1/12),new_infected,xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"A. Newly infected\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected,type=\"l\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected2,type=\"l\",col=\"blue\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  par(mai=c(0.2,0,0.5,0.4))\n  plot(1:2,sapply(list(new_infected,new_infected2),function(x) x[length(x)]),xlim=c(0.2,2.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\"))\n  arrows(1:2,yHigh,1:2,yLow,col=c(\"black\",\"blue\"),angle=90,length=0.06,code=3)\n  \n  #Plot2\n  #par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  par(mai=c(0.2,0.7,0.5,0))\n  yLow=sapply(list(range_2016,range2_2016),function(x) x[1,2])\n  yHigh=sapply(list(range_2016,range2_2016),function(x) x[2,2])\n  ylim=c(min(0,undiag_people,undiag_people2,yLow)*0.9,max(undiag_people,undiag_people2,yHigh)*1.1)\n  plot(seq(time_start_abs,time_stop_abs,1/12),undiag_people,xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people2,type=\"l\",col=\"blue\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  par(mai=c(0.2,0,0.5,0.4))\n  plot(1:2,sapply(list(undiag_people,undiag_people2),function(x) x[length(x)]),xlim=c(0.2,2.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\",\"red\",\"orange\"))\n  arrows(1:2,yHigh,1:2,yLow,col=c(\"black\",\"blue\"),angle=90,length=0.06,code=3)\n  \n  #Plot3\n  par(mai=c(0.2,0.8,0.5,0))\n  yLow=sapply(list(range_2016,range2_2016),function(x) x[1,3])\n  yHigh=sapply(list(range_2016,range2_2016),function(x) x[2,3])\n  ylim=c(min(0,death_value,death_people,death_people2,yLow)*0.9,max(death_value,death_people,death_people2))\n  plot(seq(time_start_diff,time_stop_diff,1/12),death_people,xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"C. AIDS-related deaths\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people2,type=\"l\",col=\"blue\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  par(mai=c(0.2,0,0.5,0.4))\n  plot(1:2,sapply(list(death_people,death_people2),function(x) x[length(x)]),xlim=c(0.2,2.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\"))\n  arrows(1:2,yHigh,1:2,yLow,col=c(\"black\",\"blue\"),angle=90,length=0.06,code=3)\n  \n  #Plot4\n  par(mai=c(0.2,0.7,0.5,0))\n  yLow=sapply(list(range_2016,range2_2016),function(x) x[1,4])\n  yHigh=sapply(list(range_2016,range2_2016),function(x) x[2,4])\n  ylim=c(0,max(treat_percent,treat_people,treat_people2,yHigh)*100)\n  #plot(2005.5:2015.5,c(rep(NA,5),treat_percent*100),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(treat_percent,treat_people,treat_people2,treat_people3,treat_people4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people2*100,type=\"l\",col=\"blue\",lwd=width)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  par(mai=c(0.2,0,0.5,0.4))\n  plot(1:2,sapply(list(treat_people,treat_people2),function(x) x[length(x)]*100),xlim=c(0.2,2.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\"))\n  arrows(1:2,yHigh*100,1:2,yLow*100,col=c(\"black\",\"blue\"),angle=90,length=0.06,code=3)\n  \n  #Plot5\n  par(mai=c(0.8,0.8,0.5,0))\n  yLow=sapply(list(range_2016,range2_2016),function(x) x[1,5])\n  yHigh=sapply(list(range_2016,range2_2016),function(x) x[2,5])\n  ylim=c(30,100)\n  plot(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"E. NNRTI ADR\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people2[13:length(resis_people2)]*100),type=\"l\",col=\"blue\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  par(mai=c(0.8,0,0.5,0.4))\n  plot(1:2,sapply(list(resis_people,resis_people2),function(x) x[length(x)]*100),xlim=c(0.2,2.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\"))\n  arrows(1:2,yHigh*100,1:2,yLow*100,col=c(\"black\",\"blue\"),angle=90,length=0.06,code=3)\n  \n  #Plot6\n  par(mai=c(0.8,0.7,0.5,0))\n  yLow=sapply(list(range_2016,range2_2016),function(x) x[1,6])\n  yHigh=sapply(list(range_2016,range2_2016),function(x) x[2,6])\n  ylim=c(0,max(trandr,trandr2,0.1,yHigh,na.rm=TRUE)*100*1.1)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"F. NNRTI TDR\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2*100,type=\"l\",col=\"blue\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,tck=-0.1,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2,tck=-0.05)\n  par(mai=c(0.8,0,0.5,0.4))\n  plot(1:2,sapply(list(trandr,trandr2),function(x) x[length(x)]*100),xlim=c(0.2,2.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\"))\n  arrows(1:2,yHigh*100,1:2,yLow*100,col=c(\"black\",\"blue\"),angle=90,length=0.06,code=3)\n  \n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Model sim\",scen_names),\n         lty=c(1,1,1,1),pch=c(NA,NA,NA,NA), lwd=c(2,2,2,2), col=c(\"black\",\"blue\",\"red\",\"orange\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = t_width,seg.len=c(1.2,1.2,1.2,1.2))\n}\n\n#Figure CROI\nfigure_croi=function(list_scen_data,cex_t=1.5,cex_l=2,width=4,t_width=c(0.15,0.15,0.15,0.15)){\n  scen_ind=c(2,6,8,11)\n  #Datasets 1,2,3,4\n  data_list=list_scen_data[[1]]\n  data_list2=list_scen_data[[scen_ind[1]]]\n  data_list3=list_scen_data[[scen_ind[2]]]\n  data_list4=list_scen_data[[scen_ind[3]]]\n  data_list5=list_scen_data[[scen_ind[4]]]\n  \n  data=data_list[[1]]\n  data2=data_list2[[1]]\n  data3=data_list3[[1]]\n  data4=data_list4[[1]]\n  data5=data_list5[[1]]\n  \n  range_2016=sapply(range_sensitivity(data_list),function(x) x[,dim(x)[2]])\n  range2_2016=sapply(range_sensitivity(data_list2),function(x) x[,dim(x)[2]])\n  range3_2016=sapply(range_sensitivity(data_list3),function(x) x[,dim(x)[2]])\n  range4_2016=sapply(range_sensitivity(data_list4),function(x) x[,dim(x)[2]])\n  range5_2016=sapply(range_sensitivity(data_list5),function(x) x[,dim(x)[2]])\n  #Time axis\n  tmax=times[length(times)]+1#because it times start at 0 but column of data at 1\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  \n  #Data\n  new_infected=rollapply(diff(data[1:tmax,\"129\"]),12,sum)\n  death_people=rollapply(diff(data[1:tmax,\"131\"]),12,sum)\n  undiag_people=rowSums(data[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people=rowSums(data[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people=rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr=c(NA,diff(data[1:tmax,\"137\"])/(diff(data[1:tmax,\"136\"])+diff(data[1:tmax,\"137\"])))\n  #Data2\n  new_infected2=rollapply(diff(data2[1:tmax,\"129\"]),12,sum)\n  death_people2=rollapply(diff(data2[1:tmax,\"131\"]),12,sum)\n  undiag_people2=rowSums(data2[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people2=rowSums(data2[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people2=rowSums(data2[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr2=c(NA,diff(data2[1:tmax,\"137\"])/(diff(data2[1:tmax,\"136\"])+diff(data2[1:tmax,\"137\"])))\n  #Data3\n  new_infected3=rollapply(diff(data3[1:tmax,\"129\"]),12,sum)\n  death_people3=rollapply(diff(data3[1:tmax,\"131\"]),12,sum)\n  undiag_people3=rowSums(data3[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people3=rowSums(data3[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people3=rowSums(data3[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr3=c(NA,diff(data3[1:tmax,\"137\"])/(diff(data3[1:tmax,\"136\"])+diff(data3[1:tmax,\"137\"])))\n  #Data4\n  new_infected4=rollapply(diff(data4[1:tmax,\"129\"]),12,sum)\n  death_people4=rollapply(diff(data4[1:tmax,\"131\"]),12,sum)\n  undiag_people4=rowSums(data4[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people4=rowSums(data4[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people4=rowSums(data4[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr4=c(NA,diff(data4[1:tmax,\"137\"])/(diff(data4[1:tmax,\"136\"])+diff(data4[1:tmax,\"137\"])))\n  #Data5\n  new_infected5=rollapply(diff(data5[1:tmax,\"129\"]),12,sum)\n  death_people5=rollapply(diff(data5[1:tmax,\"131\"]),12,sum)\n  undiag_people5=rowSums(data5[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people5=rowSums(data5[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data5[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people5=rowSums(data5[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data5[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr5=c(NA,diff(data5[1:tmax,\"137\"])/(diff(data5[1:tmax,\"136\"])+diff(data5[1:tmax,\"137\"])))\n  \n  #################################################################################################################\n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4,5,6,7,8,9,10,11,12,13,13,13,13,14,14,14,14),nrow = 5,ncol = 4,byrow = TRUE)\n  graphics::layout(mat = m,heights = c(1,1,1.2,0.1,0.1),widths=c(0.4,0.1,0.4,0.1))\n  \n  #Plot1\n  par(mai=c(0.2,0.8,0.3,0))\n  yLow=sapply(list(range_2016,range2_2016,range3_2016,range4_2016,range5_2016),function(x) x[1,1])\n  yHigh=sapply(list(range_2016,range2_2016,range3_2016,range4_2016,range5_2016),function(x) x[2,1])\n  ylim=c(min(c(newinf_value,new_infected,new_infected2,new_infected3,new_infected4,new_infected5,yLow))*0.9,max(c(newinf_value,new_infected,new_infected2,new_infected3,new_infected4,new_infected5,yHigh))*1.1)\n  plot(seq(time_start_diff,time_stop_diff,1/12),new_infected,xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"A. Newly infected\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected,type=\"l\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected4,type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected5,type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  par(mai=c(0.2,0,0.3,0.4))\n  plot(1:5,sapply(list(new_infected,new_infected2,new_infected3,new_infected4,new_infected5),function(x) x[length(x)]),xlim=c(0.2,5.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\",\"red\",\"orange\",\"violet\"))\n  print(yLow)\n  print(yHigh)\n  arrows(1:5,yHigh,1:5,yLow,col=c(\"black\",\"blue\",\"red\",\"orange\",\"violet\"),angle=90,length=0.06,code=3)\n  \n  #Plot2\n  #par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  par(mai=c(0.2,0.7,0.3,0))\n  yLow=sapply(list(range_2016,range2_2016,range3_2016,range4_2016,range5_2016),function(x) x[1,2])\n  yHigh=sapply(list(range_2016,range2_2016,range3_2016,range4_2016,range5_2016),function(x) x[2,2])\n  ylim=c(min(undiag_people,undiag_people2,undiag_people3,undiag_people4,undiag_people5,yLow)*0.9,max(undiag_people,undiag_people2,undiag_people3,undiag_people4,undiag_people5,yHigh)*1.1)\n  plot(seq(time_start_abs,time_stop_abs,1/12),undiag_people,xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people4,type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people5,type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  par(mai=c(0.2,0,0.3,0.4))\n  plot(1:5,sapply(list(undiag_people,undiag_people2,undiag_people3,undiag_people4,undiag_people5),function(x) x[length(x)]),xlim=c(0.2,5.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\",\"red\",\"orange\",\"violet\"))\n  arrows(1:5,yHigh,1:5,yLow,col=c(\"black\",\"blue\",\"red\",\"orange\",\"violet\"),angle=90,length=0.06,code=3)\n  \n  #Plot3\n  par(mai=c(0.2,0.8,0.3,0))\n  yLow=sapply(list(range_2016,range2_2016,range3_2016,range4_2016,range5_2016),function(x) x[1,3])\n  yHigh=sapply(list(range_2016,range2_2016,range3_2016,range4_2016,range5_2016),function(x) x[2,3])\n  ylim=c(min(death_value,death_people,death_people2,death_people3,death_people4,death_people5,yLow)*0.9,max(death_value,death_people,death_people2,death_people3,death_people4,death_people5))\n  plot(seq(time_start_diff,time_stop_diff,1/12),death_people,xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"C. AIDS-related deaths\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people4,type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people5,type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  par(mai=c(0.2,0,0.3,0.4))\n  plot(1:5,sapply(list(death_people,death_people2,death_people3,death_people4,death_people5),function(x) x[length(x)]),xlim=c(0.2,5.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\",\"red\",\"orange\",\"violet\"))\n  arrows(1:5,yHigh,1:5,yLow,col=c(\"black\",\"blue\",\"red\",\"orange\",\"violet\"),angle=90,length=0.06,code=3)\n  \n  #Plot4\n  par(mai=c(0.2,0.7,0.3,0))\n  yLow=sapply(list(range_2016,range2_2016,range3_2016,range4_2016,range5_2016),function(x) x[1,4])\n  yHigh=sapply(list(range_2016,range2_2016,range3_2016,range4_2016,range5_2016),function(x) x[2,4])\n  ylim=c(0,max(treat_percent,treat_people,treat_people2,treat_people3,treat_people4,treat_people5,yHigh)*100)\n  #plot(2005.5:2015.5,c(rep(NA,5),treat_percent*100),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(treat_percent,treat_people,treat_people2,treat_people3,treat_people4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  plot(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people4*100,type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people5*100,type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  par(mai=c(0.2,0,0.3,0.4))\n  plot(1:5,sapply(list(treat_people,treat_people2,treat_people3,treat_people4,treat_people5),function(x) x[length(x)]*100),xlim=c(0.2,5.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\",\"red\",\"orange\",\"violet\"))\n  arrows(1:5,yHigh*100,1:5,yLow*100,col=c(\"black\",\"blue\",\"red\",\"orange\",\"violet\"),angle=90,length=0.06,code=3)\n  \n  #Plot5\n  par(mai=c(0.8,0.8,0.3,0))\n  yLow=sapply(list(range_2016,range2_2016,range3_2016,range4_2016,range5_2016),function(x) x[1,5])\n  yHigh=sapply(list(range_2016,range2_2016,range3_2016,range4_2016,range5_2016),function(x) x[2,5])\n  ylim=c(0,100)\n  plot(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"E. NNRTI ADR\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people2[13:length(resis_people2)]*100),type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people3[13:length(resis_people3)]*100),type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people4[13:length(resis_people4)]*100),type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people5[13:length(resis_people5)]*100),type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  par(mai=c(0.8,0,0.3,0.4))\n  plot(1:5,sapply(list(resis_people,resis_people2,resis_people3,resis_people4,resis_people5),function(x) x[length(x)]*100),xlim=c(0.2,5.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\",\"red\",\"orange\",\"violet\"))\n  arrows(1:5,yHigh*100,1:5,yLow*100,col=c(\"black\",\"blue\",\"red\",\"orange\",\"violet\"),angle=90,length=0.06,code=3)\n  \n  #Plot6\n  par(mai=c(0.8,0.7,0.3,0))\n  yLow=sapply(list(range_2016,range2_2016,range3_2016,range4_2016,range5_2016),function(x) x[1,6])\n  yHigh=sapply(list(range_2016,range2_2016,range3_2016,range4_2016,range5_2016),function(x) x[2,6])\n  ylim=c(0,max(trandr,trandr2,trandr3,trandr4,trandr5,0.1,yHigh,na.rm=TRUE)*100*1.1)\n  plot(seq(time_start_abs,time_stop_abs,1/12),trandr*100,xlim=c(time_start_abs,time_stop_diff),ylim=ylim,xaxt='n',xlab=\"\",ylab=\"\",main=\"F. NNRTI TDR\",type=\"l\",col=\"black\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr4*100,type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr5*100,type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,tck=-0.1,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2,tck=-0.05)\n  par(mai=c(0.8,0,0.3,0.4))\n  plot(1:5,sapply(list(trandr,trandr2,trandr3,trandr4,trandr5),function(x) x[length(x)]*100),xlim=c(0.2,5.8),ylim=ylim,xaxt='n',yaxt='n',xlab=\"\",ylab=\"\",col=c(\"black\",\"blue\",\"red\",\"orange\",\"violet\"))\n  arrows(1:5,yHigh*100,1:5,yLow*100,col=c(\"black\",\"blue\",\"red\",\"orange\",\"violet\"),angle=90,length=0.06,code=3)\n  \n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Baseline model\",\"Doubled treatment rate\"),\n         lty=c(1,1),pch=c(NA,NA), lwd=c(2,2), col=c(\"black\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.3,0.3),seg.len = c(1,1))\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"5-fold increased switching rate\", \"DR testing\",\"6-year earlier Treat-All\"),\n         lty=c(1,1,1),pch=c(NA,NA,NA), lwd=c(2,2,2,2), col=c(\"red\",\"orange\",\"violet\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.3,0.4,0.3),seg.len=c(1,1,1))\n  \n}\n\nfigure_scen(list_scen_data,scen_n=1)\nfigure_croi(list_scen_data)\n#1) load data\n#create a list of 11 scenarios, each element contains a list of 1+h2 dataframe representing results from baseline and h2 sensitivity variations\nlist_scen_data=lapply(as.list(1:11),function(x){\n  load(paste(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/simulation11/simulation_and_sensitivity\",x,\".RData\",sep=\"\"))\n  #load(paste(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/simulation8/simulation_and_sensitivity\",x,\".RData\",sep=\"\"))\n  return(list_data)\n  })\nsum((list_scen_data[[1]])[[1]])\nsum((list_scen_data[[8]])[[1]])\n# load(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/list_data8.RData\")\n# list_scen_data[[8]]=list_data8\n\n#2) Range sensitivity\n#create a list of 11 scenarios, each element contains a list of 6 matrices of dim 2*length(times) representing 95% interval for each of the 6 outcomes\nrange_list=lapply(list_scen_data,function(x) range_sensitivity(x))\n#3) Range sensitvity and estimate with no sens. of absolute diff\n#create a list of matrix representing the sensitivity ranges and estimate with no sens. of relative diff in 6 outcomes\nscen_data_baseline=list_scen_data[[1]]\ndiff_list=lapply(list_scen_data,function(x) table_scen(scen_data_baseline,x))\n\n#create data frame to transform into a table in latex\na=data.frame()\na2=data.frame()\n#outcomes that are 1000 people year\na<-sapply(diff_list,function(x){\nas.vector(apply(x,2,function(y) c(paste0(y[3]),paste0(\"(\",y[1],\",\",y[2],\")\"))))\n})\n#outcomes that are percent\na2<-sapply(diff_list,function(x){\n  as.vector(apply(x,2,function(y) c(paste0(y[3],\"%\"),paste0(\"(\",y[1],\"%,\",y[2],\"%)\"))))\n})\nbold <- function(x) {paste('\\\\textbf{',x,'}', sep ='')}\n#combine table and save it in a tex file\na=rbind(a[1:4,],a2[5:8,],a[9:12,])\na=cbind(c(rbind(bold(c(\"Death\",\"New inf.\",\"TDR level\",\"ADR level\",\"TDR cases\",\"ADR cases\")),rep(\"Sens. range\",6))),a)\na=a[,-2]\na=cbind(a[,1:4],rep(\" \",12),a[,5:7],rep(\" \",12),a[,8],rep(\" \",12),a[,9:11])\nprint(xtable(a, type = \"latex\"), file = \"filename2.tex\",include.rownames = FALSE,include.colnames = FALSE)\n\n#4) Figures\nfigure_fit(list_scen_data[[1]],range_list[[1]])\nfigure_scen(list_scen_data,scen_n=1)\nfigure_scen(list_scen_data,scen_n=2)\nfigure_scen(list_scen_data,scen_n=3,width=2)\nfigure_scen(list_scen_data,scen_n=4)\nfigure_croi(list_scen_data)\nfigure_fit(start_data_list,range_sensitivity(start_data_list))\n###################################################################################################\n###################################################################################################\n###################################################################################################\n###################################################################################################\n#used to test figures_2 and figures_scen\n#range in 2016, 4 matrices\nrange_2016=matrix(rep(sapply(list(new_infected,undiag_people,death_people,treat_people,resis_people,trandr),function(x) x[length(x)]),each=2)*rep(c(0.9,1.1),6),nrow=2)\nrange2_2016=matrix(rep(sapply(list(new_infected2,undiag_people2,death_people2,treat_people2,resis_people2,trandr2),function(x) x[length(x)]),each=2)*rep(c(0.9,1.1),6),nrow=2)\nrange3_2016=matrix(rep(sapply(list(new_infected3,undiag_people3,death_people3,treat_people3,resis_people3,trandr3),function(x) x[length(x)]),each=2)*rep(c(0.9,1.1),6),nrow=2)\nrange4_2016=matrix(rep(sapply(list(new_infected4,undiag_people4,death_people4,treat_people4,resis_people4,trandr4),function(x) x[length(x)]),each=2)*rep(c(0.9,1.1),6),nrow=2)\n#range for 6 indicators, list\nrange_list=list()\nrange_list[[1]]=matrix(rep(new_infected,each=2)*rep(c(0.5,1.5),length(new_infected)),nrow=2)\nrange_list[[2]]=matrix(rep(undiag_people,each=2)*rep(c(0.5,1.5),length(undiag_people)),nrow=2)\nrange_list[[3]]=matrix(rep(death_people,each=2)*rep(c(0.5,1.5),length(death_people)),nrow=2)\nrange_list[[4]]=matrix(rep(treat_people,each=2)*rep(c(0.5,1.5),length(treat_people)),nrow=2)\nrange_list[[5]]=matrix(rep(resis_people,each=2)*rep(c(0.5,1.5),length(resis_people)),nrow=2)\nrange_list[[6]]=matrix(rep(trandr,each=2)*rep(c(0.5,1.5),length(trandr)),nrow=2)\n\n###################################################################################################\n###################################################################################################\n###################################################################################################\n###################################################################################################\n#This part was previously used when we run counterfactual scenarios without sensitivity analysis\n#counterfactual scenario 1: increasing treatment initiation rate\nscen1_params=function(acc_treat,params){\n  source(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n  params=within(params,{\n    Treat_frame[,3:4]=Treat_frame[,3:4]*acc_treat\n  })\n  return(params)\n}\n\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\ndata_scen1<-my_fun10_solver2(xstart,theta,params,0,p2)\ndata_scen1<-data_convert_to_old(data_scen1)\n\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\nacc_treat=2 #Increasing treatment rate, takes less time to be treated\nparams=within(params,{\n  Treat_frame[,3:4]=Treat_frame[,3:4]*acc_treat\n})\ndata_scen2<-my_fun10_solver2(xstart,theta,params,0,p2)\ndata_scen2<-data_convert_to_old(data_scen2)\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n\nacc_treat=3 #Increasing treatment rate, takes less time to be treated\nparams=within(params,{\n  Treat_frame[,3:4]=Treat_frame[,3:4]*acc_treat\n})\ndata_scen3<-my_fun10_solver2(xstart,theta,params,0,p2)\ndata_scen3<-data_convert_to_old(data_scen3)\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n\nacc_treat=5 #Increasing treatment rate, takes less time to be treated\nparams=within(params,{\n  Treat_frame[,3:4]=Treat_frame[,3:4]*acc_treat\n})\ndata_scen4<-my_fun10_solver2(xstart,theta,params,0,p2)\ndata_scen4<-data_convert_to_old(data_scen4)\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n\n#load the figures_scen function in the contscen.R file\nlist_1=list(data_scen1,\n            data_scen2,\n            data_scen3,\n            data_scen4)\nfigures_scen(list_1,scen=c(\"2 * rate\",\"3 * rate\", \"5 * rate\"))\n###################################################################################################\n#counterfactual scenario 2: early switch to 2nd-line\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\ndata_scen1<-my_fun10_solver2(xstart,theta,params,0,p2)\ndata_scen1<-data_convert_to_old(data_scen1)\n\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\nacc_treat=2 #how much faster will it be to switch to 2nd-line when patient on a failing treatment\nparams[[\"RateTreatSecond\"]]=params[[\"RateTreatSecond\"]]*acc_treat\ndata_scen2<-my_fun10_solver2(xstart,theta,params,0,p2)\ndata_scen2<-data_convert_to_old(data_scen2)\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n\nacc_treat=5\nparams[[\"RateTreatSecond\"]]=params[[\"RateTreatSecond\"]]*acc_treat\ndata_scen3<-my_fun10_solver2(xstart,theta,params,0,p2)\ndata_scen3<-data_convert_to_old(data_scen3)\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n\nacc_treat=10\nparams[[\"RateTreatSecond\"]]=params[[\"RateTreatSecond\"]]*acc_treat\ndata_scen4<-my_fun10_solver2(xstart,theta,params,0,p2)\ndata_scen4<-data_convert_to_old(data_scen4)\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n\n#load the figures_scen function in the contscen.R file\nlist_2=list(data_scen1,\n            data_scen2,\n            data_scen3,\n            data_scen4)\nfigures_scen(list_2,scen=c(\"2 * rate\",\"5 * rate\", \"10 * rate\"))\n###################################################################################################\n#counterfactual scenario 3: earlier implementation of the Treat-All policy\n#1.5 years earlier\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\nant_treatall=1.5 #Increasing treatment rate, takes less time to be treated\nparams=within(params,{\n  Treat_frame2=data.frame(a=Treat_frame$a[1]-ant_treatall,b=Treat_frame$b[1]-ant_treatall,c=c(0,0,0,0),d=Treat_frame$d)\n  Treat_frame2$c=apply(Treat_frame,1,function(x) lin_st(Treat_frame$a[1]-ant_treatall,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))\n})\ndata_scen2<-my_fun10_solver2(xstart,theta,params,0,p2)\ndata_scen2<-data_convert_to_old(data_scen2)\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n#3 years earlier\nant_treatall=3 #Increasing treatment rate, takes less time to be treated\nparams=within(params,{\n  Treat_frame2=data.frame(a=Treat_frame$a[1]-ant_treatall,b=Treat_frame$b[1]-ant_treatall,c=c(0,0,0,0),d=Treat_frame$d)\n  Treat_frame2$c=apply(Treat_frame,1,function(x) lin_st(Treat_frame$a[1]-ant_treatall,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))\n})\ndata_scen3<-my_fun10_solver2(xstart,theta,params,0,p2)\ndata_scen3<-data_convert_to_old(data_scen3)\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n#6 years earlier\nant_treatall=6 #Increasing treatment rate, takes less time to be treated\nparams=within(params,{\n   Treat_frame2=data.frame(a=Treat_frame$a[1]-ant_treatall,b=Treat_frame$b[1]-ant_treatall,c=c(0,0,0,0),d=Treat_frame$d)\n   Treat_frame2$c=apply(Treat_frame,1,function(x) lin_st(Treat_frame$a[1]-ant_treatall,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))\n })\ndata_scen4<-my_fun10_solver2(xstart,theta,params,0,p2)\ndata_scen4<-data_convert_to_old(data_scen4)\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n\n#load the figures_scen function in the contscen.R file\nlist_3=list(data_scen1,\n            data_scen2,\n            data_scen3,\n            data_scen4)\nfigures_scen(list_3,scen=c(\"1.5 years\",\"3 years\", \"6 years\"))\n###################################################################################################\n#Fourth counterfactual scenario\n#Run the model and plot\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/parmin4_v3.R\")\ndata_drtest=my_fun10_solver2(xstart,theta,params,1,p2)\ndata_drtest<-data_convert_to_old(data_drtest)\n\nfigures_scen(list(data_scen1,data_drtest,data_drtest,data_drtest),width = 2)\n###################################################################################################\n###################################################################################################\n#sensitivity analysis, sens_analysis.R file\n#resistance parameters:3 parameters\nfigures_sens(data_list2,data_m,new_diag=TRUE)\nfigures_sens(data_list3,data_m,new_diag=TRUE)\n\n###################################################################################################\n###################################################################################################\n#Sum plot\nlist_1\nlist_2\nlist_3\ndata_drtest\ndata_baseline=list_1[[1]]\n\n#Data\nrelative_change<-function(data1,data2){\n  tmax=dim(data)[1]\n  \n  new_infected1=rollapply(diff(data1[1:tmax,\"129\"]),12,sum)\n  new_infected2=rollapply(diff(data2[1:tmax,\"129\"]),12,sum)\n  new_infected1=new_infected1[length(new_infected1)]\n  new_infected2=new_infected2[length(new_infected2)]\n  \n  death1=rollapply(diff(data1[1:tmax,\"131\"]),12,sum)\n  death2=rollapply(diff(data2[1:tmax,\"131\"]),12,sum)\n  death1=death1[length(death1)]\n  death2=death2[length(death2)]\n  \n  new_diag_susc1=diff(data1[1:tmax,\"136\"])\n  new_diag_res1=diff(data1[1:tmax,\"137\"])\n  tdr_new_diag1=new_diag_res1/(new_diag_susc1+new_diag_res1)\n  new_diag_susc2=diff(data2[1:tmax,\"136\"])\n  new_diag_res2=diff(data2[1:tmax,\"137\"])\n  tdr_new_diag2=new_diag_res2/(new_diag_susc2+new_diag_res2)\n  tdr_new_diag1=tdr_new_diag1[length(tdr_new_diag1)]\n  tdr_new_diag2=tdr_new_diag2[length(tdr_new_diag2)]\n  \n  inf=(new_infected2-new_infected1)/new_infected1*100\n  mort=(death2-death1)/death1*100\n  tdr=(tdr_new_diag2-tdr_new_diag1)/tdr_new_diag1*100\n  \n  return(c(inf,mort,tdr))\n}\n###################################################################################################\n#plot\nmyd<- data.frame( var1 = rep(c(\"Scenario1: Sub-Scenario 1\",\"Scenario1: Sub-Scenario 2\",\"Scenario2: Sub-Scenario 1\",\"Scenario2: Sub-Scenario 2\"),each=2), \n                     samp = rep(c(\"Outcome 1\",\"Outcome 2\"),4), \n                  V4=rep(NA,8),V3 = rep(NA,8), V2 = rep(NA,8), V1 = rep(NA,8) )\nmyd<- data.frame( var1 = rep(c(\"Scenario1\",\"Scenario1\",\"Scenario2\",\"Scenario2\"),each=2),\n                  var2 = rep(c(\"sub1\",\"sub2\",\"sub1\",\"sub2\"),each=2),\n                  samp = rep(c(\"Outcome 1\",\"Outcome 2\"),4), \n                  V4=rep(NA,8),V3 = rep(NA,8), V2 = rep(NA,8), V1 = rep(NA,8) )\nmyd<- data.frame( var2 = rep(c(\"1st-line\",\"1st-line & switch\"),each=2),\n                  samp = rep(c(\"Cumulative number of AIDS-related death averted 2018-2038\",\"Cumulative number of averted new-infections 2018-2038\"),2), \n                  V4=rep(NA,4),V3 = rep(NA,4), V2 = rep(NA,4), V1 = rep(NA,4) )\n\nmyd[myd$var2==\"1st-line\",\"V1\"]=runif(2,100,200)\nmyd[myd$var2==\"1st-line\",\"V2\"]=runif(2,100,200)\nmyd[myd$var2==\"1st-line\",\"V3\"]=runif(2,100,200)\nmyd[myd$var2==\"1st-line\",\"V4\"]=runif(2,100,200)\nmyd[myd$var2==\"1st-line & switch\",\"V1\"]=runif(2,100,200)\nmyd[myd$var2==\"1st-line & switch\",\"V2\"]=runif(2,100,200)\nmyd[myd$var2==\"1st-line & switch\",\"V3\"]=runif(2,100,200)\nmyd[myd$var2==\"1st-line & switch\",\"V4\"]=runif(2,100,200)\n\nlibrary(reshape2)\nlibrary(ggplot2)\nmeltd<- melt(myd, id.vars=1:2)\n\npar(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\nm <- matrix(c(1,2),nrow = 2,ncol = 1,byrow = TRUE)\nlayout(mat = m,heights = c(0.85,0.15))\n\nplot1<-\n  ggplot(meltd, aes(x = var2, y = value, fill = variable, label = paste0(round(value, 1), \"%\"))) +\n  geom_bar(stat = \"identity\", position = position_dodge(width = 0.8), width = 0.6) +\n  facet_grid(samp ~ .,switch = \"y\",  scales = \"free_y\", space = \"free\",labeller=label_wrap_gen(width=25, multi_line=T)) +\n  coord_flip() +\n  scale_fill_manual(\"legend\",values = c(\"V4\"=\"violet\",\"V3\" = \"orange\", \"V2\" = \"red\", \"V1\" = \"blue\")) +\n  geom_text(aes(y = value + 20 * sign(value)), position = position_dodge(width = 0.8), size=4)+\n  theme_bw()+\n  theme(\n    strip.placement = \"outside\",\n    #axis.title.x = element_blank(),\n    axis.title.y = element_blank(),\n    # added face and size arguments\n    axis.text.y = element_text(colour=\"black\", size=12),\n    axis.text.x= element_text(size=13),\n    strip.text.y = element_text(size = 10, colour = \"black\", face='bold'),\n    plot.margin = margin(0.1, 0.1, 2, 0.1, \"cm\"))+\n  ylab(\"N (1000)\")\n\nplot1\n\n###################################################################################################\n#plot\nmyd<- data.frame( var1 = rep(c(\" Newly infected\",\"Mortality\",\"TDR level\"),each=4), \n                  samp = rep(c(\"Scenario 1: increased ART initiation rate\",\"Scenario 2: earlier switch to 2nd-line\",\"Scenario 3: earlier Treat-All implementation\",\"Scenario 4: DR testing\"),3), \n                  V3 = rep(NA,12), V2 = rep(NA,12), V1 = rep(NA,12) )\n\nmyd[myd$samp==\"Scenario 1: increased ART initiation rate\",\"V1\"]=relative_change(data_baseline,list_1[[2]])\nmyd[myd$samp==\"Scenario 1: increased ART initiation rate\",\"V2\"]=relative_change(data_baseline,list_1[[3]])\nmyd[myd$samp==\"Scenario 1: increased ART initiation rate\",\"V3\"]=relative_change(data_baseline,list_1[[4]])\nmyd[myd$samp==\"Scenario 2: earlier switch to 2nd-line\",\"V1\"]=relative_change(data_baseline,list_2[[2]])\nmyd[myd$samp==\"Scenario 2: earlier switch to 2nd-line\",\"V2\"]=relative_change(data_baseline,list_2[[3]])\nmyd[myd$samp==\"Scenario 2: earlier switch to 2nd-line\",\"V3\"]=relative_change(data_baseline,list_2[[4]])\nmyd[myd$samp==\"Scenario 3: earlier Treat-All implementation\",\"V1\"]=relative_change(data_baseline,list_3[[2]])\nmyd[myd$samp==\"Scenario 3: earlier Treat-All implementation\",\"V2\"]=relative_change(data_baseline,list_3[[3]])\nmyd[myd$samp==\"Scenario 3: earlier Treat-All implementation\",\"V3\"]=relative_change(data_baseline,list_3[[4]])\nmyd[myd$samp==\"Scenario 4: DR testing\",\"V1\"]=relative_change(data_baseline,data_drtest)\n\n# rshaping data to long form for ggplot2 \nmeltd<- melt(myd, id.vars=1:2) \n\npar(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\nm <- matrix(c(1,2),nrow = 2,ncol = 1,byrow = TRUE)\nlayout(mat = m,heights = c(0.85,0.15))\n\nplot1<-ggplot(meltd, aes(x = var1, y = value, fill = variable, label = paste0(round(value, 1), \"%\"))) +\n  geom_bar(stat = \"identity\", position = position_dodge(width = 0.8), width = 0.6) +\n  facet_grid(samp ~ ., switch = \"y\", scales = \"free_y\", space = \"free\",labeller=label_wrap_gen(width=25, multi_line=T)) +\n  coord_flip() +\n  scale_fill_manual(\"legend\",values = c(\"V3\" = \"orange\", \"V2\" = \"red\", \"V1\" = \"blue\", \"Baseline\" = \"black\")) +\n  geom_text(aes(y = value + 5 * sign(value)), position = position_dodge(width = 0.8), size=4)+\n  theme_bw() +\n  theme(\n    legend.position = \"none\",\n    strip.placement = \"outside\",\n    #axis.title.x = element_blank(),\n    axis.title.y = element_blank(),\n    # added face and size arguments\n    axis.text.y = element_text(colour=\"black\", size=12),\n    axis.text.x= element_text(size=13),\n    strip.text.y = element_text(size = 10, colour = \"black\", face='bold'),\n    plot.margin = margin(0.1, 0.1, 2, 0.1, \"cm\"))+\n  ylab(\"Relative change in 2016 (in %)\")\n\nplot1\n###################################################################################################\n#legend\n\npar(mfrow=c(1,1))\nNfact = 14\nNrows = 2\nNcols = 8\nMyOrder = as.vector(matrix(1:(Nrows*Ncols), nrow=Nrows, ncol=Ncols, byrow=T))\n\nMyCol <- c(\"white\",\"blue\",\"red\",\"orange\",\n           \"white\",\"blue\",\"red\",\"orange\",\n           \"white\",\"blue\",\"red\",\"orange\",\n           \"white\",\"blue\")\nx <- 1:Nfact\nMyLab <- c(\"Scenario 1:\",TeX(\"$2\\\\cdot \\\\gamma$\"),TeX(\"$3\\\\cdot \\\\gamma$\"),TeX(\"$5\\\\cdot \\\\gamma$\"),\n           \"Scenario 2:\",TeX(\"$2\\\\cdot \\\\gamma$\"),TeX(\"$5\\\\cdot \\\\gamma$\"),TeX(\"$10\\\\cdot \\\\gamma$\"),\n           \"Scenario 3:\",TeX(\"1.5 year\"),TeX(\"3 years\"),TeX(\"6 years\"),\n           \"Scenario 4:\",TeX(\"DR testing at baseline\"))\n\nplot.new()\nlegend(\"top\", MyLab[MyOrder], fill = MyCol[MyOrder], ncol = Ncols, border=NA,x.intersp = 0.3,text.width = c(rep(c(c(0.05,rep(0.04,2),0.06),c(0.0,0.06,0.04,0.03)),2))[MyOrder],box.col = NA)\n###################################################################################################\n###################################################################################################\n###################################################################################################\n###################################################################################################\n#Used for CROI abstract\nfigures_scen_4=function(list_data,scen=c(\"Scen. 1\", \"Scen. 2\", \"Scen. 3\",\"Scen. 4\"),cex_t=1.5,cex_l=2,width=4,t_width=c(0.15,0.15,0.15,0.15)){\n  #Datasets 1,2,3,4\n  data=list_data[[1]]\n  data2=list_data[[2]]\n  data3=list_data[[3]]\n  data4=list_data[[4]]\n  data5=list_data[[5]]\n  #Time axis\n  tmax=times[length(times)]+1#because it times start at 0 but column of data at 1\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  \n  #Data\n  new_infected=rollapply(diff(data[1:tmax,\"129\"]),12,sum)\n  death_people=rollapply(diff(data[1:tmax,\"131\"]),12,sum)\n  undiag_people=rowSums(data[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people=rowSums(data[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people=rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr=rowSums(data[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  #Data2\n  new_infected2=rollapply(diff(data2[1:tmax,\"129\"]),12,sum)\n  death_people2=rollapply(diff(data2[1:tmax,\"131\"]),12,sum)\n  undiag_people2=rowSums(data2[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people2=rowSums(data2[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people2=rowSums(data2[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr2=rowSums(data2[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  #Data3\n  new_infected3=rollapply(diff(data3[1:tmax,\"129\"]),12,sum)\n  death_people3=rollapply(diff(data3[1:tmax,\"131\"]),12,sum)\n  undiag_people3=rowSums(data3[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people3=rowSums(data3[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people3=rowSums(data3[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr3=rowSums(data3[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  #Data4\n  new_infected4=rollapply(diff(data4[1:tmax,\"129\"]),12,sum)\n  death_people4=rollapply(diff(data4[1:tmax,\"131\"]),12,sum)\n  undiag_people4=rowSums(data4[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people4=rowSums(data4[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people4=rowSums(data4[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr4=rowSums(data4[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  #Data5\n  new_infected5=rollapply(diff(data5[1:tmax,\"129\"]),12,sum)\n  death_people5=rollapply(diff(data5[1:tmax,\"131\"]),12,sum)\n  undiag_people5=rowSums(data5[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people5=rowSums(data5[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data5[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people5=rowSums(data5[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data5[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr5=rowSums(data5[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data5[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  \n  #TDR among newly diagnosed\n  trandr=c(NA,diff(data[1:tmax,\"137\"])/(diff(data[1:tmax,\"136\"])+diff(data[1:tmax,\"137\"])))\n  trandr2=c(NA,diff(data2[1:tmax,\"137\"])/(diff(data2[1:tmax,\"136\"])+diff(data2[1:tmax,\"137\"])))\n  trandr3=c(NA,diff(data3[1:tmax,\"137\"])/(diff(data3[1:tmax,\"136\"])+diff(data3[1:tmax,\"137\"])))\n  trandr4=c(NA,diff(data4[1:tmax,\"137\"])/(diff(data4[1:tmax,\"136\"])+diff(data4[1:tmax,\"137\"])))\n  trandr5=c(NA,diff(data5[1:tmax,\"137\"])/(diff(data5[1:tmax,\"136\"])+diff(data5[1:tmax,\"137\"])))\n  #################################################################################################################\n  #not needed for the plots\n  minf=rowSums(data[seq(1,tmax,12),1+select(1:8,1:4,1:2,1)])\n  finf=rowSums(data[seq(1,tmax,12),1+select(1:8,1:4,1:2,2)])\n  \n  supp1=rowSums(data[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])\n  supp2=rowSums(data2[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])\n  supp3=rowSums(data3[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])\n  supp4=rowSums(data4[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])\n  \n  supp1p=rowSums(data[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(4,5),1:4,1:2,1:2)])\n  supp2p=rowSums(data2[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(c(4,5),1:4,1:2,1:2)])\n  supp3p=rowSums(data3[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(c(4,5),1:4,1:2,1:2)])\n  supp4p=rowSums(data4[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(4,5),1:4,1:2,1:2)])\n  \n  rowSums(data4[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  a=rowSums(data4[seq(1,tmax,1),1+select(c(4),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(4),1:4,1:2,1:2)])\n  b=rowSums(data[seq(1,tmax,1),1+select(c(4),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(4),1:4,1:2,1:2)])\n  #a/b\n  rowSums(data4[seq(1,tmax,1),1+select(c(3:5),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(3:5),1:4,1:2,1:2)])\n  ###################################################################################################################\n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4,5,6,7,7,8,8),nrow = 5,ncol = 2,byrow = TRUE)\n  layout(mat = m,heights = c(0.28,0.28,0.34,0.05,0.05),widths=c(0.5,0.5))\n  \n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2014+11/12,length.out=10),newinf_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(c(newinf_value,new_infected,new_infected2,new_infected3,new_infected4)),max(c(newinf_value,new_infected,new_infected2,new_infected3,new_infected4))),xaxt='n',xlab=\"\",ylab=\"\",main=\"A. Newly infected\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected,type=\"l\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected4,type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected5,type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  \n  #Plot2\n  #par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(2005.5:2015.5,apply(undiag_value,1,sum),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(apply(undiag_value,1,sum),undiag_people,undiag_people2,undiag_people3,undiag_people4),max(apply(undiag_value,1,sum),undiag_people,undiag_people2,undiag_people3,undiag_people4)),xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people,type=\"l\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people4,type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people5,type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot3\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2014+11/12,length.out=10),death_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(death_value,death_people,death_people2,death_people3,death_people4),max(death_value,death_people,death_people2,death_people3,death_people4)),xaxt='n',xlab=\"\",ylab=\"\",main=\"C. AIDS-related deaths\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people4,type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people5,type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot4\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(2005.5:2015.5,c(rep(NA,5),treat_percent*100),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(treat_percent,treat_people,treat_people2,treat_people3,treat_people4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people4*100,type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people5*100,type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  \n  #Plot5\n  #par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  par(mai=c(0.8,0.8,0.5,0.4))\n  plot(2005.5:2016.5,c(rep(NA,5),88,NA,NA,NA,95,NA,NA),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,100),xaxt='n',xlab=\"\",ylab=\"\",main=\"E. ADR (Failing 1st-line)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people2[13:length(resis_people2)]*100),type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people3[13:length(resis_people3)]*100),type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people4[13:length(resis_people4)]*100),type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people5[13:length(resis_people4)]*100),type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  #Plot6\n  par(mai=c(0.8,0.7,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(trandr,trandr2,trandr3,trandr4,0.1,na.rm=TRUE)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"F. TDR Prevalence (Newly diagnosed)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr4*100,type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr5*100,type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,tck=-0.1,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2,tck=-0.05)\n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Baseline model\",\"Estimated data (WHO)\",\"Data from previous studies\"),\n         lty=c(1,NA,NA),pch=c(NA,\"o\",\"o\"), lwd=c(2,3,3), col=c(\"black\",\"red\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.2,0.2,0.2))\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(scen),\n         lty=c(1,1,1,1),pch=c(NA,NA,NA,NA), lwd=c(2,2,2,2), col=c(\"blue\",\"red\",\"orange\",\"violet\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = t_width,seg.len=c(1.2,1.2,1.2,1.2))\n  \n}\nfigures_scen_legend=function(list_data,scen=c(\"Scen. 1\", \"Scen. 2\", \"Scen. 3\",\"Scen. 4\"),cex_t=1.5,cex_l=2,width=4,t_width=c(0.15,0.15,0.15,0.15),legend_width3=0.8){\n  #Datasets 1,2,3,4\n  data=list_data[[1]]\n  data2=list_data[[2]]\n  data3=list_data[[3]]\n  data4=list_data[[4]]\n  data5=list_data[[5]]\n  #Time axis\n  tmax=times[length(times)]+1#because it times start at 0 but column of data at 1\n  tmax=dim(data)[1]\n  time_start_abs=2005\n  time_start_diff=2005+11/12\n  time_stop_abs=time_start_abs+(tmax-1)/12\n  time_stop_diff=time_start_diff+(tmax-1)/12-1\n  \n  #Data\n  new_infected=rollapply(diff(data[1:tmax,\"129\"]),12,sum)\n  death_people=rollapply(diff(data[1:tmax,\"131\"]),12,sum)\n  undiag_people=rowSums(data[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people=rowSums(data[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people=rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr=rowSums(data[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  #Data2\n  new_infected2=rollapply(diff(data2[1:tmax,\"129\"]),12,sum)\n  death_people2=rollapply(diff(data2[1:tmax,\"131\"]),12,sum)\n  undiag_people2=rowSums(data2[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people2=rowSums(data2[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people2=rowSums(data2[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr2=rowSums(data2[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  #Data3\n  new_infected3=rollapply(diff(data3[1:tmax,\"129\"]),12,sum)\n  death_people3=rollapply(diff(data3[1:tmax,\"131\"]),12,sum)\n  undiag_people3=rowSums(data3[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people3=rowSums(data3[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people3=rowSums(data3[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr3=rowSums(data3[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  #Data4\n  new_infected4=rollapply(diff(data4[1:tmax,\"129\"]),12,sum)\n  death_people4=rollapply(diff(data4[1:tmax,\"131\"]),12,sum)\n  undiag_people4=rowSums(data4[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people4=rowSums(data4[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people4=rowSums(data4[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr4=rowSums(data4[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  #Data5\n  new_infected5=rollapply(diff(data5[1:tmax,\"129\"]),12,sum)\n  death_people5=rollapply(diff(data5[1:tmax,\"131\"]),12,sum)\n  undiag_people5=rowSums(data5[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\n  treat_people5=rowSums(data5[seq(1,tmax,1),1+select(3:8,1:4,1:2,1:2)])/rowSums(data5[seq(1,tmax,1),1+select(1:8,1:4,1:2,1:2)])\n  resis_people5=rowSums(data5[seq(1,tmax,1),1+select(c(5),1:4,2,1:2)])/rowSums(data5[seq(1,tmax,1),1+select(c(5),1:4,1:2,1:2)])\n  trandr5=rowSums(data5[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data5[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  \n  #TDR among newly diagnosed\n  trandr=c(NA,diff(data[1:tmax,\"137\"])/(diff(data[1:tmax,\"136\"])+diff(data[1:tmax,\"137\"])))\n  trandr2=c(NA,diff(data2[1:tmax,\"137\"])/(diff(data2[1:tmax,\"136\"])+diff(data2[1:tmax,\"137\"])))\n  trandr3=c(NA,diff(data3[1:tmax,\"137\"])/(diff(data3[1:tmax,\"136\"])+diff(data3[1:tmax,\"137\"])))\n  trandr4=c(NA,diff(data4[1:tmax,\"137\"])/(diff(data4[1:tmax,\"136\"])+diff(data4[1:tmax,\"137\"])))\n  trandr5=c(NA,diff(data5[1:tmax,\"137\"])/(diff(data5[1:tmax,\"136\"])+diff(data5[1:tmax,\"137\"])))\n  #################################################################################################################\n  #not needed for the plots\n  minf=rowSums(data[seq(1,tmax,12),1+select(1:8,1:4,1:2,1)])\n  finf=rowSums(data[seq(1,tmax,12),1+select(1:8,1:4,1:2,2)])\n  \n  supp1=rowSums(data[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])\n  supp2=rowSums(data2[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])\n  supp3=rowSums(data3[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])\n  supp4=rowSums(data4[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])\n  \n  supp1p=rowSums(data[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(4,5),1:4,1:2,1:2)])\n  supp2p=rowSums(data2[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])/rowSums(data2[seq(1,tmax,1),1+select(c(4,5),1:4,1:2,1:2)])\n  supp3p=rowSums(data3[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])/rowSums(data3[seq(1,tmax,1),1+select(c(4,5),1:4,1:2,1:2)])\n  supp4p=rowSums(data4[seq(1,tmax,1),1+select(4,1:4,1:2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(4,5),1:4,1:2,1:2)])\n  \n  rowSums(data4[seq(1,tmax,1),1+select(c(2),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(2),1:4,1:2,1:2)])\n  a=rowSums(data4[seq(1,tmax,1),1+select(c(4),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(4),1:4,1:2,1:2)])\n  b=rowSums(data[seq(1,tmax,1),1+select(c(4),1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(c(4),1:4,1:2,1:2)])\n  #a/b\n  rowSums(data4[seq(1,tmax,1),1+select(c(3:5),1:4,2,1:2)])/rowSums(data4[seq(1,tmax,1),1+select(c(3:5),1:4,1:2,1:2)])\n  ###################################################################################################################\n  #Thembisa estimates\n  par(mfrow = c(1,1),lwd=2,oma=c(0,0.1,0,0))\n  \n  m <- matrix(c(1,2,3,4,5,6,7,7,8,8,9,9),nrow = 6,ncol = 2,byrow = TRUE)\n  layout(mat = m,heights = c(0.22,0.22,0.28,0.03,0.03,0.22),widths=c(0.5,0.5))\n  \n  #Plot1\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2014+11/12,length.out=10),newinf_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(c(newinf_value,new_infected,new_infected2,new_infected3,new_infected4)),max(c(newinf_value,new_infected,new_infected2,new_infected3,new_infected4))),xaxt='n',xlab=\"\",ylab=\"\",main=\"A. Newly infected\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected,type=\"l\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected4,type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),new_infected5,type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  \n  #Plot2\n  #par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(2005.5:2015.5,apply(undiag_value,1,sum),xlim=c(time_start_abs,time_stop_diff),ylim=c(min(apply(undiag_value,1,sum),undiag_people,undiag_people2,undiag_people3,undiag_people4),max(apply(undiag_value,1,sum),undiag_people,undiag_people2,undiag_people3,undiag_people4)),xaxt='n',xlab=\"\",ylab=\"\",main=\"B. Undiagnosed people\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people,type=\"l\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people4,type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),undiag_people5,type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot3\n  par(mai=c(0.2,0.8,0.5,0.4))\n  plot(seq(2005+11/12,2014+11/12,length.out=10),death_value,xlim=c(time_start_abs,time_stop_diff),ylim=c(min(death_value,death_people,death_people2,death_people3,death_people4),max(death_value,death_people,death_people2,death_people3,death_people4)),xaxt='n',xlab=\"\",ylab=\"\",main=\"C. AIDS-related deaths\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people2,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people3,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people4,type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_diff,time_stop_diff,1/12),death_people5,type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"1000 people\",side=2,line=4,cex=cex_t)\n  \n  #Plot4\n  par(mai=c(0.2,0.7,0.5,0.4))\n  plot(2005.5:2015.5,c(rep(NA,5),treat_percent*100),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(treat_percent,treat_people,treat_people2,treat_people3,treat_people4)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"D. ART coverage\",pch=1,col=\"red\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people4*100,type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),treat_people5*100,type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  \n  #Plot5\n  #par(lwd=2,mai=c(0.3,0.6,0.2,0.1))\n  par(mai=c(0.8,0.8,0.5,0.4))\n  plot(2005.5:2016.5,c(rep(NA,5),88,NA,NA,NA,95,NA,NA),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,100),xaxt='n',xlab=\"\",ylab=\"\",main=\"E. ADR (Failing 1st-line)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people[13:length(resis_people)]*100),type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people2[13:length(resis_people2)]*100),type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people3[13:length(resis_people3)]*100),type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people4[13:length(resis_people4)]*100),type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),c(rep(NA,12),resis_people5[13:length(resis_people4)]*100),type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  \n  #Plot6\n  par(mai=c(0.8,0.7,0.5,0.4))\n  #plot(2005.5:2016.5,c(1,1.25,3,2.5,3.5,4,4.75,6,8,10,9.5,8.5),ylim=c(min(trandr,trandr2,trandr3,trandr4)*100,max(trandr,trandr2,trandr3,trandr4)*100),xlab=\"Calendar year\",ylab=\"percent\",main=\"F. TDR Prevalence (diagnosed people)\",pch=1,col=\"blue\",cex.main=2,cex.axis=1.5,cex.lab=1.6,cex=2,lwd=4)\n  plot(c(2005,2009,2011,2014),c(1.7,2.1,5.2,9),xlim=c(time_start_abs,time_stop_diff),ylim=c(0,max(trandr,trandr2,trandr3,trandr4,0.1,na.rm=TRUE)*100),xaxt='n',xlab=\"\",ylab=\"\",main=\"F. TDR Prevalence (Newly diagnosed)\",pch=1,col=\"blue\",cex.main=2,cex.axis=2.2,cex.lab=2.2,cex=2,lwd=4)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr*100,type=\"l\",col=\"black\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr2*100,type=\"l\",col=\"blue\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr3*100,type=\"l\",col=\"red\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr4*100,type=\"l\",col=\"orange\",lwd=width)\n  lines(seq(time_start_abs,time_stop_abs,1/12),trandr5*100,type=\"l\",col=\"violet\",lwd=width)\n  mtext(text=\"Calendar year\",side=1,line=4,cex=cex_t)\n  mtext(text=\"percent\",side=2,line=4,cex=cex_t)\n  axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,col=\"white\")\n  axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2)\n  #axis(side=1,tick=TRUE,line=1,cex.axis=2.5,lwd=2,tck=-0.1,col=\"white\")\n  #axis(side=1,labels=FALSE,tick=TRUE,line=0.5,cex.axis=3,lwd=2,tck=-0.05)\n  \n  #Legend\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(\"Baseline model\",\"Estimated data (WHO)\",\"Data from previous studies\"),\n         lty=c(1,NA,NA),pch=c(NA,\"o\",\"o\"), lwd=4, col=c(\"black\",\"red\",\"blue\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = c(0.15,0.17,0.24),seg.len = 0.5,x.intersp=0.1)\n  par(lwd=1,mai=c(0,0,0,0))\n  plot.new()\n  legend(x=\"left\", inset =0,\n         c(scen),\n         lty=c(1,1,1,1),pch=c(NA,NA,NA,NA), lwd=4, col=c(\"blue\",\"red\",\"orange\",\"violet\"), box.col=NA,horiz=TRUE,cex=cex_l,text.width = t_width,seg.len=c(0.5,0.5,0.5,0.5),x.intersp=0.1)\n  plot.new()\n  par(lwd=1,mai=c(0,0,0,0))\n  legend(x=\"left\",paste(strwrap(\"Figure 1: The MARISA model was fitted to Thembisa/UNAIDS estimates: (A) annual number of new infections; (B) number of undiagnosed infected individuals; (C) annual number of AIDS-related deaths; and (D) ART coverage. Outputs from the MARISA model included (E) the prevalence of acquired drug resistance among individuals with first-line treatment failure and (F) the prevalence of transmitted drug resistance among newly diagnosed people, which are compared to results from cross-sectional surveys (blue points). The colored lines represent the following scenarios: doubled treatment initiation rate (blue), doubled switching rate from first- to second-line treatment (red), implementation of baseline drug resistance testing (yellow) and 5-year earlier implementation of the Treat-All policy (violet).\",width=legend_width3*getOption(\"width\")),sep=\"\\n\"),\n         cex=1.8,x.intersp = -1,y.intersp=0.6,box.col=NA)\n}\n\n#Model baseline\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\ndata_scen<-my_fun10_solver2(xstart,theta)\ndata_scen<-data_convert_to_old(data_scen)\n\n#counterfactual scenario 1: increasing treatment initiation rate\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\nacc_treat=2 #Increasing treatment rate, takes less time to be treated\nparams=within(params,{\n  Treat_frame[,3:4]=Treat_frame[,3:4]*acc_treat\n})\ndata_scen1<-my_fun10_solver2(xstart,theta)\ndata_scen1<-data_convert_to_old(data_scen1)\n\n#counterfactual scenario 2: early switch to 2nd-line\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\nacc_treat=2 #how much faster will it be to switch to 2nd-line when patient on a failing treatment\nparams[[\"RateTreatSecond\"]]=params[[\"RateTreatSecond\"]]*acc_treat\ndata_scen2<-my_fun10_solver2(xstart,theta)\ndata_scen2<-data_convert_to_old(data_scen2)\n\n#counterfactual scenario 3: put the Treat-All policy foward\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\nant_treatall=5 #Increasing treatment rate, takes less time to be treated\nparams=within(params,{\n  Treat_frame2=data.frame(a=Treat_frame$a[1]-ant_treatall,b=Treat_frame$b[1]-ant_treatall,c=c(0,0,0,0),d=Treat_frame$d)\n  Treat_frame2$c=apply(Treat_frame,1,function(x) lin_st(Treat_frame$a[1]-ant_treatall,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))\n})\ndata_scen3<-my_fun10_solver2(xstart,theta)\ndata_scen3<-data_convert_to_old(data_scen3)\n\n#counterfactual scenario 4: DR testing\n#change RateTreatFirst/DirectSecond in the mod_cpp() function in the parmin4_v3.R file\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/parmin4_v3.R\")\ndata_drtest=my_fun10_solver2(xstart,theta)\ndata_drtest<-data_convert_to_old(data_drtest)\n\nlist=list(data_scen,\n          data_scen1,\n          data_scen2,\n          data_drtest)\nlist2=list(data_scen,\n           data_scen1,\n           data_scen2,\n           data_drtest,\n           data_scen3)\nfigures_scen(list,scen=c(\"Increased treat. rate\",\"Earlier switch\", \"DR testing\"),cex_l=2,width=3,t_width=c(0.15,0.19,0.2,0.18))\nfigures_scen_4(list2,scen=c(\"Increased treat. rate\",\"Earlier switch\", \"DR testing\",\"Earlier Treat-All\"),cex_l=2,width=2.5,t_width=c(0.15,0.19,0.16,0.16))\nfigures_scen_legend(list2,scen=c(\"Increased treat. rate\",\"Earlier switch\", \"DR testing\",\"Earlier Treat-All\"),cex_l=2,width=3,t_width=c(0.15,0.22,0.2,0.18))\n#12x10 inch\n###################################################################################################\n###################################################################################################\n###################################################################################################\n###################################################################################################\n#starting point might affect the fit\nfigures_sens(data_list_start_point,data_m)\n\np1=c(rate1_inf=3.35, rate2_inf=0.5, rate1_diag=300, rate2_diag=6, rate_treat=0.0025,rate_death=0.1)\np2=c(rate1_inf=NA, rate2_inf=NA, rate1_diag=NA, rate2_diag=NA, rate_treat=NA,rate_death=NA,q=0.01,rate_ratio=0.5,k1=1,k2=2,k3=2,alpha=2,rate_res=5,rate_susc=125)\nxstart=xstart_f(p2)\ntheta=p1\n\n#Run the model and plot\ndata=my_fun10_solver2(xstart,theta)\ndata<-data_convert_to_old(data)\nfigures_2(data,tdr_p=1,new_diag=TRUE,tdr_cd4 = TRUE)\n\n#new-infected\ntheta1=p1\ntheta1[1]=theta[1]*0.9\ndata1=my_fun10_solver2(xstart,theta1)\ndata1<-data_convert_to_old(data1)\ntheta2=p1\ntheta2[1]=theta[1]*1.1\ndata2=my_fun10_solver2(xstart,theta)\ndata2<-data_convert_to_old(data2)\n\n#death\ntheta3=p1\ntheta3[6]=theta[6]*0.95\ndata3=my_fun10_solver2(xstart,theta3)\ndata3<-data_convert_to_old(data3)\ntheta4=p1\ntheta4[6]=theta[6]*1.2\ndata4=my_fun10_solver2(xstart,theta4)\ndata4<-data_convert_to_old(data4)\n\n#art-coverage\ntheta5=p1\ntheta5[5]=theta[5]*0.9\ndata5=my_fun10_solver2(xstart,theta5)\ndata5<-data_convert_to_old(data5)\ntheta6=p1\ntheta6[5]=theta[5]*2\ndata6=my_fun10_solver2(xstart,theta6)\ndata6<-data_convert_to_old(data6)\n\n#pdr\np2=c(rate1_inf=NA, rate2_inf=NA, rate1_diag=NA, rate2_diag=NA, rate_treat=NA,rate_death=NA,q=0.01,rate_ratio=0.5,k1=1,k2=2,k3=2,alpha=2,rate_res=5,rate_susc=125)\np2[\"rate_res\"]=p2[\"rate_res\"]/0.95\ndata7=my_fun10_solver2(xstart,theta)\ndata7<-data_convert_to_old(data7)\np2[\"rate_res\"]=p2[\"rate_res\"]/2\ndata8=my_fun10_solver2(xstart,theta)\ndata8<-data_convert_to_old(data8)\n\n#adr\np2=c(rate1_inf=NA, rate2_inf=NA, rate1_diag=NA, rate2_diag=NA, rate_treat=NA,rate_death=NA,q=0.01,rate_ratio=0.5,k1=1,k2=2,k3=2,alpha=2,rate_res=5,rate_susc=125)\np2[\"rate_susc\"]=p2[\"rate_susc\"]/0.98\ndata9=my_fun10_solver2(xstart,theta)\ndata9<-data_convert_to_old(data9)\np2[\"rate_susc\"]=p2[\"rate_susc\"]/1.02\ndata10=my_fun10_solver2(xstart,theta)\ndata10<-data_convert_to_old(data10)\n\ndata_list_start_point=list(data1,data2,data3,data4,data5,data6,data7,data8,data9,data10)\nfigures_sens(data_list_start_point,data)\n\n\n\n\n\n\n\n\n\n\n\ntmax=dim(data)[1]\nrowSums(data[seq(1,tmax,1),1+select(1,1:4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1,1:4,1:2,1:2)])\nrowSums(data[seq(1,tmax,1),1+select(1,1,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1,1,1:2,1:2)])\nrowSums(data[seq(1,tmax,1),1+select(1,2,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1,2,1:2,1:2)])\nrowSums(data[seq(1,tmax,1),1+select(1,3,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1,3,1:2,1:2)])\nrowSums(data[seq(1,tmax,1),1+select(1,4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(1,4,1:2,1:2)])\n\nrowSums(data[seq(1,tmax,1),1+select(2,1,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(2,1,1:2,1:2)])\nrowSums(data[seq(1,tmax,1),1+select(2,2,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(2,2,1:2,1:2)])\nrowSums(data[seq(1,tmax,1),1+select(2,3,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(2,3,1:2,1:2)])\nrowSums(data[seq(1,tmax,1),1+select(2,4,2,1:2)])/rowSums(data[seq(1,tmax,1),1+select(2,4,1:2,1:2)])\n\n",
    "created" : 1555441141182.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2033633871",
    "id" : "34B9B143",
    "lastKnownWriteTime" : 1559815401,
    "last_content_update" : 1559815401,
    "path" : "~/Step1/Rfiles/used scripts/marisa/graphs.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 11,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}