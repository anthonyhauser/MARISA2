{
    "collab_server" : "",
    "contents" : "library(\"Rcpp\")\nlibrary(zoo)\nlibrary(\"BH\")\nlibrary(deSolve)\n# sourceCpp(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/solvdiff_cpp.cpp\")\n# source(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\nsourceCpp(\"solvdiff_cpp.cpp\")\nsource(\"value_gender4_v3.R\")\n#load(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/params.set.RData\")\nload(\"params.set.RData\")\n\n#Parameters with new diag rate 05.02.2019 (used only atm as no optimum found)\np1=c(rate1_inf=3.318999e+00, rate2_inf=5.440886e-01, rate1_diag=2.736363e+02, rate2_diag=7.710578e+00, rate_treat=1.879695e-03,rate_death=1.632000e-01)\np2=c(rate1_inf=NA, rate2_inf=NA, rate1_diag=NA, rate2_diag=NA, rate_treat=NA,rate_death=NA,q=0.05,rate_ratio=0.5,k1=1,k2=2,k3=2,alpha=2,rate_res=5,rate_susc=125)\np2=c(p2,res_test=0)\nargs=(commandArgs(TRUE))\nargs=as.numeric(unlist(args))\nprint(args)\n\nscen=c(0,1,1,1,2,2,2,3,4,4,4)\nvalue=c(NA,2,3,5,2,5,10,NA,1.5,3,6)\n\n###################################################################################################################################\n#function taken in parmin5.R\n#ODE function\n#ODE function\nmod_cpp=function(t,x,p1,parms=params,p2=p2){\n  with(as.list(parms), {\n    x=x[1:(64*2)]\n    \n    ##################################################################################################################\n    #Optimization\n    rate1_inf <- p1[1] #number of unprotected sexual acts/month\n    rate2_inf <- p1[2]\n    rate1_diag <- p1[3] #diagnosis rate\n    rate2_diag <- p1[4] #diagnosis rate\n    rate_treat <- p1[5] #scale parameter for overall treatment rate\n    rate_death <- p1[6] #scale parameter for overall death\n    q <- p2[7]\n    #Range\n    rate_ratio <- p2[8] #varying parameter to estimate death for treated (but neither suppressed nor failed)\n    \n    alpha <- p2[12] #ratio between outcome when resistant/sensitive\n    rate_res <- p2[13] #resistant rate\n    rate_susc <- p2[14] #reversion rate\n    res_test <- p2[15]\n    \n    #1. Infection and Diagnosis\n    RateInf1=array(rep(RateTransm,each=4),dim=c(4,2,2))*rate1_inf\n    RateInf2=RateInf1*rate2_inf\n    \n    Diag_frame[,4]=Diag_frame[,4]*rate2_diag\n    #RateDiag[cd4]\n    RateDiag=1/rate1_diag*apply(Diag_frame,1,function(x) smooth_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))\n    #print(array(rep(RateDiag,2)*rep(c(1,diag_women),each=4),dim=c(4,2)))\n    RateDiag=array(rep(RateDiag,2)*rep(c(1,diag_women),each=4),dim=c(4,2))+\n      array(rep(oi_inc,2)*rep(smooth_st(2005+t/12,oi_test[\"a\"],oi_test[\"b\"],oi_test[\"c\"],oi_test[\"d\"]),8),dim=c(4,2))+\n      array(c(rep(0,4),preg_inc)*rep(smooth_st(2005+t/12,preg_test[\"a\"],preg_test[\"b\"],preg_test[\"c\"],preg_test[\"d\"]),8),dim=c(4,2))\n    \n    #2. Treatment theoretical (if no counterfactual scenario)\n    # RateTreatFirst_th=apply(Treat_frame,1,function(x) smooth_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*smooth_st(2005+t/12,2001,2012,1,200/12)*rate_treat\n    # RateTreatFirst_th=apply(\n    #                   data.frame(t1=apply(Treat_frame,1,function(x) lin_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"])),\n    #                   t2=apply(Treat_frame2,1,function(x) lin_st(2005+t/12,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*as.numeric(2005+t/12>Treat_frame2$a[4])),\n    #                   1,max)\n    # RateTreatFirst_th=RateTreatFirst_th*smooth_st(2005+t/12,2001,2012,1,200/12)*rate_treat\n    \n    RateTreatFirst_f=function(y){\n      if(y<2005){\n        return(apply(Treat_frame_original,1,function(x) smooth_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*smooth_st(y,2001,2012,1,200/12)*rate_treat)\n      }else{\n        return(apply(\n          data.frame(t1=apply(Treat_frame,1,function(x) lin_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"])),\n                     t2=apply(Treat_frame2,1,function(x) lin_st(y,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))*as.numeric(y>Treat_frame2$a[4])),\n          1,max)*smooth_st(y,2001,2012,1,200/12)*rate_treat)\n      }\n    }\n    RateTreatFirst_th=RateTreatFirst_f(2005+t/12)\n    \n    RateDirectTreatSecond_th=RateDirectTreatSecond\n    \n    if(res_test>0){\n      RateTreatFirst=matrix(c(RateTreatFirst_th,c(0,0,0,0)),nrow=2,ncol=4,byrow=T)\n      RateDirectTreatSecond=matrix(c(RateDirectTreatSecond_th,RateTreatFirst_th+RateDirectTreatSecond_th),nrow=2,ncol=4,byrow=T)\n      \n    }else{\n      RateTreatFirst=matrix(c(RateTreatFirst_th,RateTreatFirst_th),nrow=2,ncol=4,byrow=T)\n      RateDirectTreatSecond=matrix(c(RateDirectTreatSecond_th,RateDirectTreatSecond_th),nrow=2,ncol=4,byrow=T)\n    }\n    \n    #3. Death\n    #p1=min(1,q*mean(sapply(2005+seq(t-36,t,1)/12,function(x) RateTreatFirst_f(x)[4]/rate_treat)))\n    p1=1-0.27*exp(-q*(mean(sapply(2005+seq(t-36,t,1)/12,function(x) RateTreatFirst_f(x)[4])-\n                             sapply(2005+seq(-36,0,1)/12,function(x) RateTreatFirst_f(x)[4])))/rate_treat)\n    mu[1:2,4,1]=p1*40.9+(1-p1)*134.4\n    mu[4,4,1]=p1*8.3+(1-p1)*41.7\n    mu[5,4,1]=p1*11.8+(1-p1)*59.7\n    mu[3,1:4,1]=rate_ratio*mu[4,1:4,1]+(1-rate_ratio)*mu[5,1:4,1]\n    mu[6:8,1:4,1]=mu[3:5,1:4,1]\n    mu[1:8,1:4,2]=mu[1:8,1:4,1]\n    mu=mu*rate_death/1000\n    \n    #Back and forth mutation and impact on treatment outcome\n    RateResistant=1/rate_res\n    RateSusceptible=1/rate_susc\n    #From T to S\n    RateSuppFirstSusc=RateSuppFirst/1\n    RateSuppFirstResis=1/alpha*RateSuppFirst/1\n    #From S to F\n    RateFailFirstSusc=RateFailFirst*1\n    RateFailFirstResis=alpha*RateFailFirst*1\n    #From T to F\n    RateTreatToFailFirstSusc=RateTreatToFailFirst*1\n    RateTreatToFailFirstResis=alpha*RateTreatToFailFirst*1\n    #From F to S\n    RateFailToSuppTreatFirstSusc=RateFailToSuppTreatFirst/1\n    RateFailToSuppTreatFirstResis=1/alpha*RateFailToSuppTreatFirst/1\n    \n    #For second-line regimen, no effect of NNRTI resistance on treatment as it is PI\n    ##################################################################################################################\n    dx=array(0,dim=c(8,4,2,2))\n    x=array(x,dim=c(8,4,2,2))\n    I=apply(x,4,sum)\n    \n    #First approach to model S: S=N-I\n    N=N_value_f(t+1)\n    S=N-I\n    \n    \n    #people reaching 15 years old\n    dx[1,1:4,1,1:2]=rep(c(predict(inf_m,1+t/12)$y/4,predict(inf_w,1+t/12)$y/4)/12,each=4)\n    dx[1,1:4,2,1:2]=0\n    dx[2,1:4,1,1:2]=rep(c(predict(diag_m,1+t/12)$y/4,predict(diag_w,1+t/12)$y/4)/12,each=4)\n    dx[2,1:4,2,1:2]=0\n    dx[3,1:4,1,1:2]=(1-0.9*0.2)*rep(c(predict(treat_m,1+t/12)$y/4,predict(treat_w,1+t/12)$y/4)/12,each=4)\n    dx[3,1:4,2,1:2]=0.9*0.2*rep(c(predict(treat_m,1+t/12)$y/4,predict(treat_w,1+t/12)$y/4)/12,each=4)\n    \n    for(j in 1:2){\n      #dx[x1,x2,x3,x4] x1:care stages x2:disease progression x3:resistance x4:gender\n      #dx with only interaction with the neighbours in the compartmental model\n      dx[1,1,1,j]=dx[1,1,1,j]+S[j]/N[j]*(sum(RateInf1[1:4,1:2,j]*apply(x[c(1),1:4,1,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,j]*apply(x[c(2,3,5,6,8),1:4,1,1:2],c(2,3),sum)))-\n        (RateStageInf[1]+RateDiag[1,j]+mu[1,1,1])*x[1,1,1,j]\n      dx[2,1,1,j]=dx[2,1,1,j]+RateDiag[1,j]*x[1,1,1,j]-(RateTreatFirst[1,1]+RateStageDiag[1]+mu[2,1,1])*x[2,1,1,j]\n      dx[3,1,1,j]=dx[3,1,1,j]+RateTreatFirst[1,1]*x[2,1,1,j]-(RateSuppFirstSusc[1]+RateStageTreatFirstR[1]+mu[3,1,1])*x[3,1,1,j]+RateStageTreatFirstL[1]*x[3,2,1,j]\n      dx[4,1,1,j]=RateSuppFirstSusc[1]*x[3,1,1,j]-(RateFailFirstSusc[1]+mu[4,1,1])*x[4,1,1,j]+RateStageSuppFirst[1]*x[4,2,1,j]\n      dx[5,1,1,j]=RateFailFirstSusc[1]*x[4,1,1,j]-(RateTreatSecond[1]+RateStageFailFirst[1]+mu[5,1,1])*x[5,1,1,j]\n      dx[6,1,1,j]=RateTreatSecond[1]*x[5,1,1,j]-(RateSuppSecond[1]+RateStageTreatSecondR[1]+mu[6,1,1])*x[6,1,1,j]+RateStageTreatSecondL[1]*x[6,2,1,j]\n      dx[7,1,1,j]=RateSuppSecond[1]*x[6,1,1,j]-(RateFailSecond[1]+mu[7,1,1])*x[7,1,1,j]+RateStageSuppSecond[1]*x[7,2,1,j]\n      dx[8,1,1,j]=RateFailSecond[1]*x[7,1,1,j]-(RateStageFailSecond[1]+mu[8,1,1])*x[8,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]-(RateStageInf[2]+RateDiag[2,j]+mu[1,2,1])*x[1,2,1,j]+RateStageInf[1]*x[1,1,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]+RateDiag[2,j]*x[1,2,1,j]-(RateTreatFirst[1,2]+RateStageDiag[2]+mu[2,2,1])*x[2,2,1,j]+RateStageDiag[1]*x[2,1,1,j]\n      dx[3,2,1,j]=dx[3,2,1,j]+RateTreatFirst[1,2]*x[2,2,1,j]-(RateSuppFirstSusc[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,1])*x[3,2,1,j]+RateStageTreatFirstR[1]*x[3,1,1,j]+RateStageTreatFirstL[2]*x[3,3,1,j]\n      dx[4,2,1,j]=RateSuppFirstSusc[2]*x[3,2,1,j]-(RateFailFirstSusc[2]+RateStageSuppFirst[1]+mu[4,2,1])*x[4,2,1,j]+RateStageSuppFirst[2]*x[4,3,1,j]\n      dx[5,2,1,j]=RateFailFirstSusc[2]*x[4,2,1,j]-(RateTreatSecond[2]+RateStageFailFirst[2]+mu[5,2,1])*x[5,2,1,j]+RateStageFailFirst[1]*x[5,1,1,j]\n      dx[6,2,1,j]=RateTreatSecond[2]*x[5,2,1,j]-(RateSuppSecond[2]+RateStageTreatSecondR[2]+RateStageTreatSecondL[1]+mu[6,2,1 ])*x[6,2,1,j]+RateStageTreatSecondR[1]*x[6,1,1,j]+RateStageTreatSecondL[2]*x[6,3,1,j]\n      dx[7,2,1,j]=RateSuppSecond[2]*x[6,2,1,j]-(RateFailSecond[2]+RateStageSuppSecond[1]+mu[7,2,1])*x[7,2,1,j]+RateStageSuppSecond[2]*x[7,3,1,j]\n      dx[8,2,1,j]=RateFailSecond[2]*x[7,2,1,j]-(RateStageFailSecond[2]+mu[8,2,1])*x[8,2,1,j]+RateStageFailSecond[1]*x[8,1,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]-(RateStageInf[3]+RateDiag[3,j]+mu[1,3,1])*x[1,3,1,j]+RateStageInf[2]*x[1,2,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]+RateDiag[3,j]*x[1,3,1,j]-(RateTreatFirst[1,3]+RateStageDiag[3]+mu[2,3,1])*x[2,3,1,j]+RateStageDiag[2]*x[2,2,1,j]\n      dx[3,3,1,j]=dx[3,3,1,j]+RateTreatFirst[1,3]*x[2,3,1,j]-(RateSuppFirstSusc[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,1])*x[3,3,1,j]+RateStageTreatFirstR[2]*x[3,2,1,j]+RateStageTreatFirstL[3]*x[3,4,1,j]\n      dx[4,3,1,j]=RateSuppFirstSusc[3]*x[3,3,1,j]-(RateFailFirstSusc[3]+RateStageSuppFirst[2]+mu[4,3,1])*x[4,3,1,j]+RateStageSuppFirst[3]*x[4,4,1,j]\n      dx[5,3,1,j]=RateFailFirstSusc[3]*x[4,3,1,j]-(RateTreatSecond[3]+RateStageFailFirst[3]+mu[5,3,1])*x[5,3,1,j]+RateStageFailFirst[2]*x[5,2,1,j]\n      dx[6,3,1,j]=RateTreatSecond[3]*x[5,3,1,j]-(RateSuppSecond[3]+RateStageTreatSecondR[3]+RateStageTreatSecondL[2]+mu[6,3,1])*x[6,3,1,j]+RateStageTreatSecondR[2]*x[6,2,1,j]+RateStageTreatSecondL[3]*x[6,4,1,j]\n      dx[7,3,1,j]=RateSuppSecond[3]*x[6,3,1,j]-(RateFailSecond[3]+RateStageSuppSecond[2]+mu[7,3,1])*x[7,3,1,j]+RateStageSuppSecond[3]*x[7,4,1,j]\n      dx[8,3,1,j]=RateFailSecond[3]*x[7,3,1,j]-(RateStageFailSecond[3]+mu[8,3,1])*x[8,3,1,j]+RateStageFailSecond[2]*x[8,2,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]-(RateDiag[4,j]+mu[1,4,1])*x[1,4,1,j]+RateStageInf[3]*x[1,3,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]+RateDiag[4,j]*x[1,4,1,j]-(RateTreatFirst[1,4]+mu[2,4,1])*x[2,4,1,j]+RateStageDiag[3]*x[2,3,1,j]\n      dx[3,4,1,j]=dx[3,4,1,j]+RateTreatFirst[1,4]*x[2,4,1,j]-(RateSuppFirstSusc[4]+RateStageTreatFirstL[3]+mu[3,4,1])*x[3,4,1,j]+RateStageTreatFirstR[3]*x[3,3,1,j]\n      dx[4,4,1,j]=RateSuppFirstSusc[4]*x[3,4,1,j]-(RateFailFirstSusc[4]+RateStageSuppFirst[3]+mu[4,4,1])*x[4,4,1,j]\n      dx[5,4,1,j]=RateFailFirstSusc[4]*x[4,4,1,j]-(RateTreatSecond[4]+mu[5,4,1])*x[5,4,1,j]+RateStageFailFirst[3]*x[5,3,1,j]\n      dx[6,4,1,j]=RateTreatSecond[4]*x[5,4,1,j]-(RateSuppSecond[4]+RateStageTreatSecondL[3]+mu[6,4,1])*x[6,4,1,j]+RateStageTreatSecondR[3]*x[6,3,1,j]\n      dx[7,4,1,j]=RateSuppSecond[4]*x[6,4,1,j]-(RateFailSecond[4]+RateStageSuppSecond[3]+mu[7,4,1])*x[7,4,1,j]\n      dx[8,4,1,j]=RateFailSecond[4]*x[7,4,1,j]-mu[8,4,1 ]*x[8,4,1,j]+RateStageFailSecond[3]*x[8,3,1,j]\n      \n      ##############################################################################################################################################################\n      \n      dx[1,1,1,j]=dx[1,1,1,j]\n      dx[2,1,1,j]=dx[2,1,1,j]-RateDirectTreatSecond[1,1]*x[2,1,1,j]+RateStopTreatFirst[1]*x[3,1,1,j]+RateStopSuppFirst[1]*x[4,1,1,j]+RateStopFailFirst[1]*x[5,1,1,j]+\n        RateStopTreatSecond[1]*x[6,1,1,j]+RateStopSuppSecond[1]*x[7,1,1,j]+RateStopFailSecond[1]*x[8,1,1,j]\n      dx[3,1,1,j]=dx[3,1,1,j]-RateStopTreatFirst[1]*x[3,1,1,j]-RateTreatToFailFirstSusc[1]*x[3,1,1,j]\n      dx[4,1,1,j]=dx[4,1,1,j]-RateStopSuppFirst[1]*x[4,1,1,j]+RateFailToSuppTreatFirstSusc[1]*x[5,1,1,j]-RateSuppFirstToSecond[1]*x[4,1,1,j]\n      dx[5,1,1,j]=dx[5,1,1,j]-RateStopFailFirst[1]*x[5,1,1,j]-RateFailToSuppTreatFirstSusc[1]*x[5,1,1,j]+RateTreatToFailFirstSusc[1]*x[3,1,1,j]\n      dx[6,1,1,j]=dx[6,1,1,j]-RateStopTreatSecond[1]*x[6,1,1,j]+RateDirectTreatSecond[1,1]*x[2,1,1,j]-RateTreatToFailSecond[1]*x[6,1,1,j]\n      dx[7,1,1,j]=dx[7,1,1,j]-RateStopSuppSecond[1]*x[7,1,1,j]+RateFailToSuppTreatSecond[1]*x[8,1,1,j]+RateSuppFirstToSecond[1]*x[4,1,1,j]\n      dx[8,1,1,j]=dx[8,1,1,j]-RateStopFailSecond[1]*x[8,1,1,j]-RateFailToSuppTreatSecond[1]*x[8,1,1,j]+RateTreatToFailSecond[1]*x[6,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]\n      dx[2,2,1,j]=dx[2,2,1,j]-RateDirectTreatSecond[1,2]*x[2,2,1,j]+RateStopTreatFirst[2]*x[3,2,1,j]+RateStopSuppFirst[2]*x[4,2,1,j]+RateStopFailFirst[2]*x[5,2,1,j]+\n        RateStopTreatSecond[2]*x[6,2,1,j]+RateStopSuppSecond[2]*x[7,2,1,j]+RateStopFailSecond[2]*x[8,2,1,j]\n      dx[3,2,1,j]=dx[3,2,1,j]-RateStopTreatFirst[2]*x[3,2,1,j]-RateTreatToFailFirstSusc[2]*x[3,2,1,j]\n      dx[4,2,1,j]=dx[4,2,1,j]-RateStopSuppFirst[2]*x[4,2,1,j]+RateFailToSuppTreatFirstSusc[2]*x[5,2,1,j]-RateSuppFirstToSecond[2]*x[4,2,1,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateStopFailFirst[2]*x[5,2,1,j]-RateFailToSuppTreatFirstSusc[2]*x[5,2,1,j]+RateTreatToFailFirstSusc[2]*x[3,2,1,j]\n      dx[6,2,1,j]=dx[6,2,1,j]-RateStopTreatSecond[2]*x[6,2,1,j]+RateDirectTreatSecond[1,2]*x[2,2,1,j]-RateTreatToFailSecond[2]*x[6,2,1,j]\n      dx[7,2,1,j]=dx[7,2,1,j]-RateStopSuppSecond[2]*x[7,2,1,j]+RateFailToSuppTreatSecond[2]*x[8,2,1,j]+RateSuppFirstToSecond[2]*x[4,2,1,j]\n      dx[8,2,1,j]=dx[8,2,1,j]-RateStopFailSecond[2]*x[8,2,1,j]-RateFailToSuppTreatSecond[2]*x[8,2,1,j]+RateTreatToFailSecond[2]*x[6,2,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]\n      dx[2,3,1,j]=dx[2,3,1,j]-RateDirectTreatSecond[1,3]*x[2,3,1,j]+RateStopTreatFirst[3]*x[3,3,1,j]+RateStopSuppFirst[3]*x[4,3,1,j]+RateStopFailFirst[3]*x[5,3,1,j]+\n        RateStopTreatSecond[3]*x[6,3,1,j]+RateStopSuppSecond[3]*x[7,3,1,j]+RateStopFailSecond[3]*x[8,3,1,j]\n      dx[3,3,1,j]=dx[3,3,1,j]-RateStopTreatFirst[3]*x[3,3,1,j]-RateTreatToFailFirstSusc[3]*x[3,3,1,j]\n      dx[4,3,1,j]=dx[4,3,1,j]-RateStopSuppFirst[3]*x[4,3,1,j]+RateFailToSuppTreatFirstSusc[3]*x[5,3,1,j]-RateSuppFirstToSecond[3]*x[4,3,1,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateStopFailFirst[3]*x[5,3,1,j]-RateFailToSuppTreatFirstSusc[3]*x[5,3,1,j]+RateTreatToFailFirstSusc[3]*x[3,3,1,j]\n      dx[6,3,1,j]=dx[6,3,1,j]-RateStopTreatSecond[3]*x[6,3,1,j]+RateDirectTreatSecond[1,3]*x[2,3,1,j]-RateTreatToFailSecond[3]*x[6,3,1,j]\n      dx[7,3,1,j]=dx[7,3,1,j]-RateStopSuppSecond[3]*x[7,3,1,j]+RateFailToSuppTreatSecond[3]*x[8,3,1,j]+RateSuppFirstToSecond[3]*x[4,3,1,j]\n      dx[8,3,1,j]=dx[8,3,1,j]-RateStopFailSecond[3]*x[8,3,1,j]-RateFailToSuppTreatSecond[3]*x[8,3,1,j]+RateTreatToFailSecond[3]*x[6,3,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]\n      dx[2,4,1,j]=dx[2,4,1,j]-RateDirectTreatSecond[1,4]*x[2,4,1,j]+RateStopTreatFirst[4]*x[3,4,1,j]+RateStopSuppFirst[4]*x[4,4,1,j]+RateStopFailFirst[4]*x[5,4,1,j]+\n        RateStopTreatSecond[4]*x[6,4,1,j]+RateStopSuppSecond[4]*x[7,4,1,j]+RateStopFailSecond[4]*x[8,4,1,j]\n      dx[3,4,1,j]=dx[3,4,1,j]-RateStopTreatFirst[4]*x[3,4,1,j]-RateTreatToFailFirstSusc[4]*x[3,4,1,j]\n      dx[4,4,1,j]=dx[4,4,1,j]-RateStopSuppFirst[4]*x[4,4,1,j]+RateFailToSuppTreatFirstSusc[4]*x[5,4,1,j]-RateSuppFirstToSecond[4]*x[4,4,1,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateStopFailFirst[4]*x[5,4,1,j]-RateFailToSuppTreatFirstSusc[4]*x[5,4,1,j]+RateTreatToFailFirstSusc[4]*x[3,4,1,j]\n      dx[6,4,1,j]=dx[6,4,1,j]-RateStopTreatSecond[4]*x[6,4,1,j]+RateDirectTreatSecond[1,4]*x[2,4,1,j]-RateTreatToFailSecond[4]*x[6,4,1,j]\n      dx[7,4,1,j]=dx[7,4,1,j]-RateStopSuppSecond[4]*x[7,4,1,j]+RateFailToSuppTreatSecond[4]*x[8,4,1,j]+RateSuppFirstToSecond[4]*x[4,4,1,j]\n      dx[8,4,1,j]=dx[8,4,1,j]-RateStopFailSecond[4]*x[8,4,1,j]-RateFailToSuppTreatSecond[4]*x[8,4,1,j]+RateTreatToFailSecond[4]*x[6,4,1,j]\n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      dx[1,1,2,j]=dx[1,1,2,j]+S[j]/N[j]*(sum(RateInf1[1:4,1:2,j]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+sum(RateInf2[1:4,1:2,j]*apply(x[c(2,3,5,6,8),1:4,2,1:2],c(2,3),sum)))-\n        (RateStageInf[1]+RateDiag[1,j]+mu[1,1,2 ])*x[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]+RateDiag[1,j]*x[1,1,2,j]-(RateTreatFirst[2,1]+RateStageDiag[1]+mu[2,1,2 ])*x[2,1,2,j]\n      dx[3,1,2,j]=dx[3,1,2,j]+RateTreatFirst[2,1]*x[2,1,2,j]-(RateSuppFirstResis[1]+RateStageTreatFirstR[1]+mu[3,1,2])*x[3,1,2,j]+RateStageTreatFirstL[1]*x[3,2,2,j]\n      dx[4,1,2,j]=RateSuppFirstResis[1]*x[3,1,2,j]-(RateFailFirstResis[1]+mu[4,1,2])*x[4,1,2,j]+RateStageSuppFirst[1]*x[4,2,2,j]\n      dx[5,1,2,j]=RateFailFirstResis[1]*x[4,1,2,j]-(RateTreatSecond[1]+RateStageFailFirst[1]+mu[5,1,2 ])*x[5,1,2,j]\n      dx[6,1,2,j]=RateTreatSecond[1]*x[5,1,2,j]-(RateSuppSecond[1]+RateStageTreatSecondR[1]+mu[6,1,2 ])*x[6,1,2,j]+RateStageTreatSecondL[1]*x[6,2,2,j]\n      dx[7,1,2,j]=RateSuppSecond[1]*x[6,1,2,j]-(RateFailSecond[1]+mu[7,1,2])*x[7,1,2,j]+RateStageSuppSecond[1]*x[7,2,2,j]\n      dx[8,1,2,j]=RateFailSecond[1]*x[7,1,2,j]-(RateStageFailSecond[1]+mu[8,1,2])*x[8,1,2,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]-(RateStageInf[2]+RateDiag[2,j]+mu[1,2,2])*x[1,2,2,j]+RateStageInf[1]*x[1,1,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]+RateDiag[2,j]*x[1,2,2,j]-(RateTreatFirst[2,2]+RateStageDiag[2]+mu[2,2,2])*x[2,2,2,j]+RateStageDiag[1]*x[2,1,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]+RateTreatFirst[2,2]*x[2,2,2,j]-(RateSuppFirstResis[2]+RateStageTreatFirstR[2]+RateStageTreatFirstL[1]+mu[3,2,2 ])*x[3,2,2,j]+RateStageTreatFirstR[1]*x[3,1,2,j]+RateStageTreatFirstL[2]*x[3,3,2,j]\n      dx[4,2,2,j]=RateSuppFirstResis[2]*x[3,2,2,j]-(RateFailFirstResis[2]+RateStageSuppFirst[1]+mu[4,2,2])*x[4,2,2,j]+RateStageSuppFirst[2]*x[4,3,2,j]\n      dx[5,2,2,j]=RateFailFirstResis[2]*x[4,2,2,j]-(RateTreatSecond[2]+RateStageFailFirst[2]+mu[5,2,2])*x[5,2,2,j]+RateStageFailFirst[1]*x[5,1,2,j]\n      dx[6,2,2,j]=RateTreatSecond[2]*x[5,2,2,j]-(RateSuppSecond[2]+RateStageTreatSecondR[2]+RateStageTreatSecondL[1]+mu[6,2,2])*x[6,2,2,j]+RateStageTreatSecondR[1]*x[6,1,2,j]+RateStageTreatSecondL[2]*x[6,3,2,j]\n      dx[7,2,2,j]=RateSuppSecond[2]*x[6,2,2,j]-(RateFailSecond[2]+RateStageSuppSecond[1]+mu[7,2,2])*x[7,2,2,j]+RateStageSuppSecond[2]*x[7,3,2,j]\n      dx[8,2,2,j]=RateFailSecond[2]*x[7,2,2,j]-(RateStageFailSecond[2]+mu[8,2,2])*x[8,2,2,j]+RateStageFailSecond[1]*x[8,1,2,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]-(RateStageInf[3]+RateDiag[3,j]+mu[1,3,2])*x[1,3,2,j]+RateStageInf[2]*x[1,2,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]+RateDiag[3,j]*x[1,3,2,j]-(RateTreatFirst[2,3]+RateStageDiag[3]+mu[2,3,2])*x[2,3,2,j]+RateStageDiag[2]*x[2,2,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]+RateTreatFirst[2,3]*x[2,3,2,j]-(RateSuppFirstResis[3]+RateStageTreatFirstR[3]+RateStageTreatFirstL[2]+mu[3,3,2])*x[3,3,2,j]+RateStageTreatFirstR[2]*x[3,2,2,j]+RateStageTreatFirstL[3]*x[3,4,2,j]\n      dx[4,3,2,j]=RateSuppFirstResis[3]*x[3,3,2,j]-(RateFailFirstResis[3]+RateStageSuppFirst[2]+mu[4,3,2])*x[4,3,2,j]+RateStageSuppFirst[3]*x[4,4,2,j]\n      dx[5,3,2,j]=RateFailFirstResis[3]*x[4,3,2,j]-(RateTreatSecond[3]+RateStageFailFirst[3]+mu[5,3,2])*x[5,3,2,j]+RateStageFailFirst[2]*x[5,2,2,j]\n      dx[6,3,2,j]=RateTreatSecond[3]*x[5,3,2,j]-(RateSuppSecond[3]+RateStageTreatSecondR[3]+RateStageTreatSecondL[2]+mu[6,3,2])*x[6,3,2,j]+RateStageTreatSecondR[2]*x[6,2,2,j]+RateStageTreatSecondL[3]*x[6,4,2,j]\n      dx[7,3,2,j]=RateSuppSecond[3]*x[6,3,2,j]-(RateFailSecond[3]+RateStageSuppSecond[2]+mu[7,3,2])*x[7,3,2,j]+RateStageSuppSecond[3]*x[7,4,2,j]\n      dx[8,3,2,j]=RateFailSecond[3]*x[7,3,2,j]-(RateStageFailSecond[3]+mu[8,3,2])*x[8,3,2,j]+RateStageFailSecond[2]*x[8,2,2,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]-(RateDiag[4,j]+mu[1,4,2])*x[1,4,2,j]+RateStageInf[3]*x[1,3,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]+RateDiag[4,j]*x[1,4,2,j]-(RateTreatFirst[2,4]+mu[2,4,2])*x[2,4,2,j]+RateStageDiag[3]*x[2,3,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]+RateTreatFirst[2,4]*x[2,4,2,j]-(RateSuppFirstResis[4]+RateStageTreatFirstL[3]+mu[3,4,2])*x[3,4,2,j]+RateStageTreatFirstR[3]*x[3,3,2,j]\n      dx[4,4,2,j]=RateSuppFirstResis[4]*x[3,4,2,j]-(RateFailFirstResis[4]+RateStageSuppFirst[3]+mu[4,4,2])*x[4,4,2,j]\n      dx[5,4,2,j]=RateFailFirstResis[4]*x[4,4,2,j]-(RateTreatSecond[4]+mu[5,4,2])*x[5,4,2,j]+RateStageFailFirst[3]*x[5,3,2,j]\n      dx[6,4,2,j]=RateTreatSecond[4]*x[5,4,2,j]-(RateSuppSecond[4]+RateStageTreatSecondL[3]+mu[6,4,2])*x[6,4,2,j]+RateStageTreatSecondR[3]*x[6,3,2,j]\n      dx[7,4,2,j]=RateSuppSecond[4]*x[6,4,2,j]-(RateFailSecond[4]+RateStageSuppSecond[3]+mu[7,4,2])*x[7,4,2,j]\n      dx[8,4,2,j]=RateFailSecond[4]*x[7,4,2,j]-mu[8,4,2]*x[8,4,2,j]+RateStageFailSecond[3]*x[8,3,2,j]\n      \n      ##############################################################################################################################################################\n      \n      dx[1,1,2,j]=dx[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]-RateDirectTreatSecond[2,1]*x[2,1,2,j]+RateStopTreatFirst[1]*x[3,1,2,j]+RateStopSuppFirst[1]*x[4,1,2,j]+RateStopFailFirst[1]*x[5,1,2,j]+\n        RateStopTreatSecond[1]*x[6,1,2,j]+RateStopSuppSecond[1]*x[7,1,2,j]+RateStopFailSecond[1]*x[8,1,2,j]\n      dx[3,1,2,j]=dx[3,1,2,j]-RateStopTreatFirst[1]*x[3,1,2,j]-RateTreatToFailFirstResis[1]*x[3,1,2,j]\n      dx[4,1,2,j]=dx[4,1,2,j]-RateStopSuppFirst[1]*x[4,1,2,j]+RateFailToSuppTreatFirstResis[1]*x[5,1,2,j]-RateSuppFirstToSecond[1]*x[4,1,2,j]\n      dx[5,1,2,j]=dx[5,1,2,j]-RateStopFailFirst[1]*x[5,1,2,j]-RateFailToSuppTreatFirstResis[1]*x[5,1,2,j]+RateTreatToFailFirstResis[1]*x[3,1,2,j]\n      dx[6,1,2,j]=dx[6,1,2,j]-RateStopTreatSecond[1]*x[6,1,2,j]+RateDirectTreatSecond[2,1]*x[2,1,2,j]-RateTreatToFailSecond[1]*x[6,1,2,j]\n      dx[7,1,2,j]=dx[7,1,2,j]-RateStopSuppSecond[1]*x[7,1,2,j]+RateFailToSuppTreatSecond[1]*x[8,1,2,j]+RateSuppFirstToSecond[1]*x[4,1,2,j]\n      dx[8,1,2,j]=dx[8,1,2,j]-RateStopFailSecond[1]*x[8,1,2,j]-RateFailToSuppTreatSecond[1]*x[8,1,2,j]+RateTreatToFailSecond[1]*x[6,1,2,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateDirectTreatSecond[2,2]*x[2,2,2,j]+RateStopTreatFirst[2]*x[3,2,2,j]+RateStopSuppFirst[2]*x[4,2,2,j]+RateStopFailFirst[2]*x[5,2,2,j]+\n        RateStopTreatSecond[2]*x[6,2,2,j]+RateStopSuppSecond[2]*x[7,2,2,j]+RateStopFailSecond[2]*x[8,2,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]-RateStopTreatFirst[2]*x[3,2,2,j]-RateTreatToFailFirstResis[2]*x[3,2,2,j]\n      dx[4,2,2,j]=dx[4,2,2,j]-RateStopSuppFirst[2]*x[4,2,2,j]+RateFailToSuppTreatFirstResis[2]*x[5,2,2,j]-RateSuppFirstToSecond[2]*x[4,2,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]-RateStopFailFirst[2]*x[5,2,2,j]-RateFailToSuppTreatFirstResis[2]*x[5,2,2,j]+RateTreatToFailFirstResis[2]*x[3,2,2,j]\n      dx[6,2,2,j]=dx[6,2,2,j]-RateStopTreatSecond[2]*x[6,2,2,j]+RateDirectTreatSecond[2,2]*x[2,2,2,j]-RateTreatToFailSecond[2]*x[6,2,2,j]\n      dx[7,2,2,j]=dx[7,2,2,j]-RateStopSuppSecond[2]*x[7,2,2,j]+RateFailToSuppTreatSecond[2]*x[8,2,2,j]+RateSuppFirstToSecond[2]*x[4,2,2,j]\n      dx[8,2,2,j]=dx[8,2,2,j]-RateStopFailSecond[2]*x[8,2,2,j]-RateFailToSuppTreatSecond[2]*x[8,2,2,j]+RateTreatToFailSecond[2]*x[6,2,2,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateDirectTreatSecond[2,3]*x[2,3,2,j]+RateStopTreatFirst[3]*x[3,3,2,j]+RateStopSuppFirst[3]*x[4,3,2,j]+RateStopFailFirst[3]*x[5,3,2,j]+\n        RateStopTreatSecond[3]*x[6,3,2,j]+RateStopSuppSecond[3]*x[7,3,2,j]+RateStopFailSecond[3]*x[8,3,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]-RateStopTreatFirst[3]*x[3,3,2,j]-RateTreatToFailFirstResis[3]*x[3,3,2,j]\n      dx[4,3,2,j]=dx[4,3,2,j]-RateStopSuppFirst[3]*x[4,3,2,j]+RateFailToSuppTreatFirstResis[3]*x[5,3,2,j]-RateSuppFirstToSecond[3]*x[4,3,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]-RateStopFailFirst[3]*x[5,3,2,j]-RateFailToSuppTreatFirstResis[3]*x[5,3,2,j]+RateTreatToFailFirstResis[3]*x[3,3,2,j]\n      dx[6,3,2,j]=dx[6,3,2,j]-RateStopTreatSecond[3]*x[6,3,2,j]+RateDirectTreatSecond[2,3]*x[2,3,2,j]-RateTreatToFailSecond[3]*x[6,3,2,j]\n      dx[7,3,2,j]=dx[7,3,2,j]-RateStopSuppSecond[3]*x[7,3,2,j]+RateFailToSuppTreatSecond[3]*x[8,3,2,j]+RateSuppFirstToSecond[3]*x[4,3,2,j]\n      dx[8,3,2,j]=dx[8,3,2,j]-RateStopFailSecond[3]*x[8,3,2,j]-RateFailToSuppTreatSecond[3]*x[8,3,2,j]+RateTreatToFailSecond[3]*x[6,3,2,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateDirectTreatSecond[2,4]*x[2,4,2,j]+RateStopTreatFirst[4]*x[3,4,2,j]+RateStopSuppFirst[4]*x[4,4,2,j]+RateStopFailFirst[4]*x[5,4,2,j]+\n        RateStopTreatSecond[4]*x[6,4,2,j]+RateStopSuppSecond[4]*x[7,4,2,j]+RateStopFailSecond[4]*x[8,4,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]-RateStopTreatFirst[4]*x[3,4,2,j]-RateTreatToFailFirstResis[4]*x[3,4,2,j]\n      dx[4,4,2,j]=dx[4,4,2,j]-RateStopSuppFirst[4]*x[4,4,2,j]+RateFailToSuppTreatFirstResis[4]*x[5,4,2,j]-RateSuppFirstToSecond[4]*x[4,4,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]-RateStopFailFirst[4]*x[5,4,2,j]-RateFailToSuppTreatFirstResis[4]*x[5,4,2,j]+RateTreatToFailFirstResis[4]*x[3,4,2,j]\n      dx[6,4,2,j]=dx[6,4,2,j]-RateStopTreatSecond[4]*x[6,4,2,j]+RateDirectTreatSecond[2,4]*x[2,4,2,j]-RateTreatToFailSecond[4]*x[6,4,2,j]\n      dx[7,4,2,j]=dx[7,4,2,j]-RateStopSuppSecond[4]*x[7,4,2,j]+RateFailToSuppTreatSecond[4]*x[8,4,2,j]+RateSuppFirstToSecond[4]*x[4,4,2,j]\n      dx[8,4,2,j]=dx[8,4,2,j]-RateStopFailSecond[4]*x[8,4,2,j]-RateFailToSuppTreatSecond[4]*x[8,4,2,j]+RateTreatToFailSecond[4]*x[6,4,2,j]\n      \n      #############################################################################################################################################################################\n      #############################################################################################################################################################################\n      #dx with interaction between resistant and Resiseptible compartments\n      dx[1,1,1,j]=dx[1,1,1,j]+RateSusceptible*x[1,1,2,j]\n      dx[2,1,1,j]=dx[2,1,1,j]+RateSusceptible*x[2,1,2,j]\n      dx[3,1,1,j]=dx[3,1,1,j]\n      dx[4,1,1,j]=dx[4,1,1,j]\n      dx[5,1,1,j]=dx[5,1,1,j]-RateResistant*x[5,1,1,j]\n      dx[6,1,1,j]=dx[6,1,1,j]\n      dx[7,1,1,j]=dx[7,1,1,j]\n      dx[8,1,1,j]=dx[8,1,1,j]\n      \n      dx[1,2,1,j]=dx[1,2,1,j]+RateSusceptible*x[1,2,2,j]\n      dx[2,2,1,j]=dx[2,2,1,j]+RateSusceptible*x[2,2,2,j]\n      dx[3,2,1,j]=dx[3,2,1,j]\n      dx[4,2,1,j]=dx[4,2,1,j]\n      dx[5,2,1,j]=dx[5,2,1,j]-RateResistant*x[5,2,1,j]\n      dx[6,2,1,j]=dx[6,2,1,j]\n      dx[7,2,1,j]=dx[7,2,1,j]\n      dx[8,2,1,j]=dx[8,2,1,j]\n      \n      dx[1,3,1,j]=dx[1,3,1,j]+RateSusceptible*x[1,3,2,j]\n      dx[2,3,1,j]=dx[2,3,1,j]+RateSusceptible*x[2,3,2,j]\n      dx[3,3,1,j]=dx[3,3,1,j]\n      dx[4,3,1,j]=dx[4,3,1,j]\n      dx[5,3,1,j]=dx[5,3,1,j]-RateResistant*x[5,3,1,j]\n      dx[6,3,1,j]=dx[6,3,1,j]\n      dx[7,3,1,j]=dx[7,3,1,j]\n      dx[8,3,1,j]=dx[8,3,1,j]\n      \n      dx[1,4,1,j]=dx[1,4,1,j]+RateSusceptible*x[1,4,2,j]\n      dx[2,4,1,j]=dx[2,4,1,j]+RateSusceptible*x[2,4,2,j]\n      dx[3,4,1,j]=dx[3,4,1,j]\n      dx[4,4,1,j]=dx[4,4,1,j]\n      dx[5,4,1,j]=dx[5,4,1,j]-RateResistant*x[5,4,1,j]\n      dx[6,4,1,j]=dx[6,4,1,j]\n      dx[7,4,1,j]=dx[7,4,1,j]\n      dx[8,4,1,j]=dx[8,4,1,j]\n      \n      #############################################################################################################################################################################\n      dx[1,1,2,j]=dx[1,1,2,j]-RateSusceptible*x[1,1,2,j]\n      dx[2,1,2,j]=dx[2,1,2,j]-RateSusceptible*x[2,1,2,j]\n      dx[3,1,2,j]=dx[3,1,2,j]\n      dx[4,1,2,j]=dx[4,1,2,j]\n      dx[5,1,2,j]=dx[5,1,2,j]+RateResistant*x[5,1,1,j]\n      dx[6,1,2,j]=dx[6,1,2,j]\n      dx[7,1,2,j]=dx[7,1,2,j]\n      dx[8,1,2,j]=dx[8,1,2,j]\n      \n      dx[1,2,2,j]=dx[1,2,2,j]-RateSusceptible*x[1,2,2,j]\n      dx[2,2,2,j]=dx[2,2,2,j]-RateSusceptible*x[2,2,2,j]\n      dx[3,2,2,j]=dx[3,2,2,j]\n      dx[4,2,2,j]=dx[4,2,2,j]\n      dx[5,2,2,j]=dx[5,2,2,j]+RateResistant*x[5,2,1,j]\n      dx[6,2,2,j]=dx[6,2,2,j]\n      dx[7,2,2,j]=dx[7,2,2,j]\n      dx[8,2,2,j]=dx[8,2,2,j]\n      \n      dx[1,3,2,j]=dx[1,3,2,j]-RateSusceptible*x[1,3,2,j]\n      dx[2,3,2,j]=dx[2,3,2,j]-RateSusceptible*x[2,3,2,j]\n      dx[3,3,2,j]=dx[3,3,2,j]\n      dx[4,3,2,j]=dx[4,3,2,j]\n      dx[5,3,2,j]=dx[5,3,2,j]+RateResistant*x[5,3,1,j]\n      dx[6,3,2,j]=dx[6,3,2,j]\n      dx[7,3,2,j]=dx[7,3,2,j]\n      dx[8,3,2,j]=dx[8,3,2,j]\n      \n      dx[1,4,2,j]=dx[1,4,2,j]-RateSusceptible*x[1,4,2,j]\n      dx[2,4,2,j]=dx[2,4,2,j]-RateSusceptible*x[2,4,2,j]\n      dx[3,4,2,j]=dx[3,4,2,j]\n      dx[4,4,2,j]=dx[4,4,2,j]\n      dx[5,4,2,j]=dx[5,4,2,j]+RateResistant*x[5,4,1,j]\n      dx[6,4,2,j]=dx[6,4,2,j]\n      dx[7,4,2,j]=dx[7,4,2,j]\n      dx[8,4,2,j]=dx[8,4,2,j]\n    }\n    dx[(dx+x)<0]=0\n    #new_infections\n    new_inf=S[1]/N[1]*(sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,1:2,1:2],c(1,3),sum))+\n                         sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8),1:4,1:2,1:2],c(2,4),sum)))+\n      S[2]/N[2]*(sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,1:2,1:2],c(1,3),sum))+\n                   sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8),1:4,1:2,1:2],c(2,4),sum)))\n    \n    #new_infections resistant\n    new_inf_res=S[1]/N[1]*(sum(RateInf1[1:4,1:2,1]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+\n                             sum(RateInf2[1:4,1:2,1]*apply(x[c(2,3,5,6,8),1:4,2,1:2],c(2,3),sum)))+\n      S[2]/N[2]*(sum(RateInf1[1:4,1:2,2]*apply(x[c(1),1:4,2,1:2],c(1,2),sum))+\n                   sum(RateInf2[1:4,1:2,2]*apply(x[c(2,3,5,6,8),1:4,2,1:2],c(2,3),sum)))\n    \n    #death\n    death=sum(apply(x[1:8,1:4,1:2,1:2],c(1,2,3),sum)*mu)\n    \n    #death\n    death_infectious=sum(apply(x[c(1,2,3,5,6,8),1:4,1:2,1:2],c(1,2,3),sum)*mu[c(1,2,3,5,6,8),1:4,1:2])\n    \n    \n    #death resistant\n    death_res=sum(apply(x[1:8,1:4,2,1:2],c(1,2),sum)*mu[1:8,1:4,2])\n    \n    #new treated\n    new_treat=sum(RateTreatFirst[1:2,1:4]*t(apply(x[2,1:4,1:2,1:2],c(1,2),sum)))+\n      sum(RateDirectTreatSecond[1:2,1:4]*t(apply(x[2,1:4,1:2,1:2],c(1,2),sum)))\n    #new treated resistant\n    new_treat_res=sum(RateTreatFirst[2,1:4]*t(apply(x[2,1:4,2,1:2],c(1),sum)))+\n      sum(RateDirectTreatSecond[2,1:4]*t(apply(x[2,1:4,2,1:2],c(1),sum)))\n    \n    #new diagnosed susceptible\n    new_diag_susc=sum(RateDiag[1:4,1:2]*x[1,1:4,1,1:2])\n    #new diagnosed resistant\n    new_diag_res=sum(RateDiag[1:4,1:2]*x[1,1:4,2,1:2])\n    \n    #reviewer 2 response, proportion of ADR among res ind failing 1st-line\n    res_fail=sum(RateFailFirstResis[1:4]*apply(x[4,1:4,2,1:2],1,sum))+\n      sum(RateTreatToFailFirstResis[1:4]*apply(x[3,1:4,2,1:2],1,sum))\n    res_acq=sum(RateResistant*x[5,1:4,1,1:2])\n    \n    #new adr\n    new_adr=sum(x[c(5),1:4,1,1:2])*RateResistant\n    new_fail_susc=sum(RateFailFirstSusc[1:4]*apply(x[4,1:4,1,1:2],1,sum))+sum(RateTreatToFailFirstSusc[1:4]*apply(x[3,1:4,1,1:2],1,sum))\n    new_fail_res=sum(RateFailFirstResis[1:4]*apply(x[4,1:4,2,1:2],1,sum))+sum(RateTreatToFailFirstResis[1:4]*apply(x[3,1:4,2,1:2],1,sum))\n    \n    #reviewr 3 response no effect of baseline drug resistanct testing\n    t1=sum(RateTreatFirst[1:2,1:4]*t(apply(x[2,1:4,1:2,1:2],c(1,2),sum))) #go to 1st-line\n    t2=sum(matrix(rep(RateDirectTreatSecond_th,2),nrow=2,ncol=4)*t(apply(x[2,1:4,1:2,1:2],c(1,2),sum))) #go to second-line without rt\n    t3<-ifelse(res_test==0,0,sum(RateTreatFirst_th*apply(x[2,1:4,2,1:2],c(1),sum))) #go to second-line because rt\n    \n    #dx[3:8,1:4,1,1:2]=dx[3:8,1:4,1,1:2]+infected_m15_month[t+1]*x[3:8,1:4,1,1:2]/sum(x[3:8,1:4,1,1:2])\n    ####################################################################################################################  \n    #res=c(dx,new_inf,death,new_treat,new_inf_res,death_infectious,new_treat_res,new_diag_susc,new_diag_res,new_adr,death_infectious)\n    res=c(dx,new_inf,death,new_treat,new_inf_res,death_infectious,new_treat_res,new_diag_susc,new_diag_res,new_fail_susc,new_fail_res)\n    #reviewer 2 response, proportion of ADR among res ind failing 1st-line\n    #res=c(dx,res_fail,res_acq,new_fail_susc,new_fail_res,rep(0,6))\n    #reviewer 3 response, proportion of people going to 2nd-line due to rt\n    #res=c(dx,t1,t2,t3,rep(0,7))\n    return(c(res))\n    #return(list(c(res,newinf,newsu,newres,death)))\n    #})\n  })\n}\n#select the right rows\nselect=function(r1,r2,r3,r4){\n  l1=8\n  l2=4\n  l3=2\n  l4=2\n  ar=array(1:(l1*l2*l3*l4),dim=c(l1,l2,l3,l4))\n  return(as.vector(ar[r1,r2,r3,r4]))\n}\n#starting values\nxstart_f=function(par){\n  k1=par[9]\n  k2=par[10]\n  k3=par[11]\n  \n  start_value=array(0,dim=c(8,4,2,2))\n  start_value[1,1:4,1,1:2]=c(undiag_start[1]*repart_f(k1),undiag_start[2]*repart_f(k1))\n  start_value[2,1:4,1,1:2]=c(diag_start[1]*repart_f(k2),diag_start[2]*repart_f(k2))\n  start_value[3,1:4,1,1:2]=c(treat_start[1]*repart_f(k3),treat_start[2]*repart_f(k3))\n  \n  start_value[4,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0\n  start_value[5,1:4,1,1:2]=start_value[3,1:4,1,1:2]*0\n  start_value[3,1:4,1,1:2]=start_value[3,1:4,1,1:2]*1\n  \n  res_start=0.01\n  \n  start_value[1:2,1:4,2,1:2]=array(rep(rep(c(res_start,res_start,res_start,res_start),each=2)*rep(c(1,1),4),2),dim=c(2,4,2))*start_value[1:2,1:4,1,1:2]\n  start_value[1:2,1:4,1,1:2]=array(rep(1-rep(c(res_start,res_start,res_start,res_start),each=2)*rep(c(1,1),4),2),dim=c(2,4,2))*start_value[1:2,1:4,1,1:2]\n  start_value[3,1:4,2,1:2]=res_start*start_value[3,1:4,1,1:2]\n  start_value[3,1:4,1,1:2]=(1-res_start)*start_value[3,1:4,1,1:2]\n  start_value[4,1:4,2,1:2]=res_start*start_value[4,1:4,1,1:2]\n  start_value[4,1:4,1,1:2]=(1-res_start)*start_value[4,1:4,1,1:2]\n  start_value[5,1:4,2,1:2]=0.7*start_value[5,1:4,1,1:2]\n  start_value[5,1:4,1,1:2]=0.3*start_value[5,1:4,1,1:2]\n  xstart=c(start_value,rep(0,10))\n  return(xstart)\n}\n#convert data so that we can plot with the old plot function\ndata_convert_to_old=function(data){\n  data_ret=matrix(0,nrow=dim(data)[1],ncol=140)\n  colnames(data_ret)=c(\"t\",as.character(1:139))\n  data_ret[,1]=1:(dim(data)[1])\n  data_ret[,2:130]=data[,1:129]# the col 131 is left blank (0) as it was already the case in the previous code and to not change the other functions\n  data_ret[,132]=data[,130]\n  data_ret[,133:140]=data[,131:138]\n  return(data_ret)\n}\n#loglikelihood with four indicators\nloglik <- function (theta, times, xstart,params,p2) {\n  par=p2\n  par[\"k1\"]=1\n  par[\"k2\"]=2\n  par[\"k3\"]=2\n  xstart=xstart_f(p2)\n  \n  data=my_fun10_solver2(xstart,theta,params,p2)\n  data<-data_convert_to_old(data)\n  tmax=dim(data)[1]\n  \n  mod_newinf=rollapply(diff(data[1:tmax,\"129\"]),12,sum)[seq(1,121,12)]\n  mod_death=rollapply(diff(data[1:tmax,\"131\"]),12,sum)[seq(1,121,12)]\n  mod_undiag=rowSums(data[seq(6,126,12),1+select(1,1:4,1:2,1:2)])\n  mod_treat=rowSums(data[seq(6,126,12),1+select(3:8,1:4,1:2,1:2)])\n  \n  return(-(sum(newinf_value*log(mod_newinf)-mod_newinf)+\n             sum(undiag_value*log(mod_undiag)-mod_undiag)+\n             sum(death_value*log(mod_death)-mod_death)+\n             sum(treat_value*log(mod_treat)-mod_treat))/1000+269.376)\n  \n  # return(-(sum(dnorm(x=sqrt(newinf_value),mean=sqrt(mod_newinf),sd=0.5,log=TRUE))+\n  #   sum(dnorm(x=sqrt(undiag_value),mean=sqrt(mod_undiag),sd=0.5,log=TRUE))+\n  #   sum(dnorm(x=sqrt(death_value),mean=sqrt(mod_death),sd=0.5,log=TRUE))+\n  #   sum(dnorm(x=sqrt(treat_value),mean=sqrt(mod_treat),sd=0.5,log=TRUE))))\n}\n# wrapper for loglikelihood function to take only the estimated parameters as an argument\nloglikwrap <- function(par) {\n  return(loglik(theta = par,times=times,xstart=xstart,params=params,p2=p2))\n}\n###################################################################################################################################\n#function taken in graphs.R\n#Increasing treatment rate, takes less time to be treated\nscen1_params=function(acc_treat,params){\n  #source(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n  source(\"value_gender4_v3.R\")\n  params=within(params,{\n    Treat_frame[,3:4]=Treat_frame[,3:4]*acc_treat\n  })\n  return(params)\n}\n#how much faster will it be to switch to 2nd-line when patient on a failing treatment\nscen2_params=function(acc_treat,params){\n  #source(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n  source(\"value_gender4_v3.R\")\n  params[[\"RateTreatSecond\"]]=params[[\"RateTreatSecond\"]]*acc_treat\n  return(params)\n}\n#Earlier implementation of the Treat-All policy\nscen4_params=function(ant_treatall,params){\n  #source(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n  source(\"value_gender4_v3.R\")\n  params=within(params,{\n    Treat_frame2=data.frame(a=Treat_frame$a[1]-ant_treatall,b=Treat_frame$b[1]-ant_treatall,c=c(0,0,0,0),d=Treat_frame$d)\n    Treat_frame2$c=apply(Treat_frame,1,function(x) lin_st(Treat_frame$a[1]-ant_treatall,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))\n  })\n  return(params)\n}\n#function adapted from file sens_analysis.R\n#data sens function: return a list of h2 elements corresponding to sensitivity variation\nsource(\"value_gender4_v3.R\")\ndata_sens=function(params.set,p1,p2,parms,scen,par_scen){\n  #Assessing scenario and scenario parameter\n  print(p2)\n  parms<-within(parms,{\n  if(scen==1){\n    Treat_frame[,3:4]=Treat_frame[,3:4]*par_scen\n  }\n  if(scen==2){\n    RateTreatSecond=RateTreatSecond*par_scen\n  }\n  if(scen==4){\n    Treat_frame2=data.frame(a=Treat_frame$a[1]-par_scen,b=Treat_frame$b[1]-par_scen,c=c(0,0,0,0),d=Treat_frame$d)\n    Treat_frame2$c=apply(Treat_frame,1,function(x) lin_st(Treat_frame$a[1]-par_scen,x[\"a\"],x[\"b\"],x[\"c\"],x[\"d\"]))\n  }\n  })\n  if(scen==3){\n    p2[\"res_test\"]=1\n  }\n  \n  #Simulate dataset with no sensitivity variation\n  data_list=list()\n  xstart=xstart_f(p2)\n  data=my_fun10_solver2(xstart,p1,parms,p2)\n  data<-data_convert_to_old(data)\n  data_list[[1]]=data\n  #figures_2(data)\n  #Simulate h2 times according to different values of sensitivity parameters\n  h2=dim(params.set)[1]\n  for(j in 1:h2){\n    #Changing parameters according to sensitivity matrix params.set\n    p2[c(\"rate_res\",\"rate_susc\",\"alpha\")]=params.set[j,1:3]\n    parms1<-within(parms,{\n      RateStopTreatFirst=4.35/c(1800,1400,750,680)*params.set[j,4]\n      RateStopSuppFirst=4.35/c(9000,5400,3300,1600)*params.set[j,4]\n      RateStopFailFirst=4.35/c(2700,2080,1240,560)*params.set[j,4]\n      RateStopTreatSecond=4.35/c(1800,1400,750,680)*params.set[j,4] #Assumption : T2 same as T1\n      RateStopSuppSecond=4.35/c(9000,5400,3300,1600)*params.set[j,4] #Assumption : S2 same as S1\n      RateStopFailSecond=4.35/c(2700,2080,1240,560)*params.set[j,4]\n      \n    RateTransm=c(params.set[j,6]*params.set[j,5]*params.set[j,7],\n                            1-params.set[j,5],\n                            1-params.set[j,5],\n                            0)*0.003*(0.05*(0.008/0.003)*1+2*(1-0.05))*\n      (1/(params.set[j,5]*params.set[j,6]*params.set[j,7]+2*(1-params.set[j,5])))\n    #factor to keep the same total number of new infected when changing hiv prevalence/risk among msm and msm prop\n    })\n \n    #Simulate dataset\n    xstart=xstart_f(p2)\n    data=my_fun10_solver2(xstart,p1,parms1,p2)\n    data<-data_convert_to_old(data)\n    \n    #Save dataset\n    data_list[[j+1]]=data\n    \n  \n    if(j%%5==0){\n      print(j)\n    }\n  }\n  return(data_list)\n}\n###################################################################################################################################\n#run the model for each parameter variation\nlist_data=data_sens(params.set,p1,p2,params,scen[args],value[args])\nsave(list_data,file = \"list_data.RData\")\n#save(list_data8,file = \"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/list_data8.RData\")\n\n",
    "created" : 1555401379807.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "26|44|437|0|\n439|29|446|0|\n448|23|474|0|\n476|35|484|0|\n486|53|511|0|\n513|29|515|0|\n",
    "hash" : "3894837937",
    "id" : "FBD9C708",
    "lastKnownWriteTime" : 1553769985,
    "last_content_update" : 1555402430826,
    "path" : "~/Step1/Rfiles/used scripts/marisa/simulation_and_sensitivity_ub.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 10,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}