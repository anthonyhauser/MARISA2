{
    "collab_server" : "",
    "contents" : "#heatmap\nlibrary(deSolve)\nlibrary(zoo)\nlibrary(\"Rcpp\")\nlibrary(\"BH\")\nlibrary(\"RColorBrewer\")\nlibrary(plotly)\n\n#Baseline model: from 2005 to 2018 will be used later\n#load p1 and p2 from graphs.R\n\n\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/parmin4_v3.R\")\nsourceCpp(\"C:/Users/ahauser/Documents/Step2/dtg/solvdiff_cpp_dtg_2_2018.cpp\")\nload(\"C:/Users/ahauser/Documents/Step2/R_results/data_dtg_2005_2018.RData\")\nsource(\"C:/Users/ahauser/Documents/Step1/Rfiles/used scripts/marisa/value_gender4_v3.R\")\n\n#no treatment interruption\nparams<-within(params,{\n  RateStopTreatFirst=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopSuppFirst=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopFailFirst=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopTreatSecond=4.35/c(Inf,Inf,Inf,Inf) #Assumption : T2 same as T1\n  RateStopSuppSecond=4.35/c(Inf,Inf,Inf,Inf)\n  RateStopFailSecond=4.35/c(Inf,Inf,Inf,Inf)\n})\n#no starting with second-line PI\nparams<-within(params,{\n  RateDirectTreatSecond=4.35/c(5000,12000,13000,1850)\n})\np1=c(rate1_inf=3.318999e+00, rate2_inf=5.440886e-01, rate1_diag=2.736363e+02, rate2_diag=7.710578e+00, rate_treat=1.879695e-03,rate_death=1.632000e-01)\np2=c(rate1_inf=NA, rate2_inf=NA, rate1_diag=NA, rate2_diag=NA, rate_treat=NA,rate_death=NA,q=0.05,rate_ratio=0.5,k1=1,k2=2,k3=2,alpha=2,rate_res=5,rate_susc=125)\ntheta=p1\n\n\n###########################################################################################################################\n#R simulation, no more used see heatmap_ub.R\nxstart_dtg_2_2018=data[dim(data)[1],]\n\ni_len=12\nj_len=12\ndata_heatmap=list()\nfor(i in 1:i_len){\n  for(j in 1:j_len){\n    x=1/(1+(i-1)/(i_len-1)*19)\n    y=(j-1)/(j_len-1)\n    \n    treat_dtg=c(p_w_start=y,p_w_switch=y,rate_first=1,rate_switch=x,p_treat=1,p_supp=1,p_fail=1,delay_first=0,delay_switch=0)\n    xstart=xstart_dtg_2_2018\n    xstart[select_15(12:15,1:4,1:2,2)]=(1-treat_dtg[1])*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\n    xstart[select_15(2:5,1:4,1:2,2)]=treat_dtg[1]*(xstart_dtg_2_2018[select_15(2:5,1:4,1:2,2)]+xstart_dtg_2_2018[select_15(12:15,1:4,1:2,2)])\n    data_h=my_fun10_solver2_dtg_2(xstart,theta,treat_dtg,params,p2)\n    rownames(data_h)=1:(dim(data_h)[1])\n    data_h=rbind(data[-dim(data)[1],],data_h)\n    data_heatmap[[j_len*(i-1)+j]]=data_h\n  }\n  print(i)\n}\n\n###########################################################################################################################\n#Results from Ubelix simulations, heatmap_ub.R\n#-------------------------------------------------------------------------------------------\n#Loading data\n#1) with inverted x-axis, spaced according to rate not to time\nj_len=51\ni_len=49\ndata_heatmap=list()\nfor(i in 1:i_len){\n  for(j in 1:j_len){\nload(paste(\"C:/Users/ahauser/Documents/Step2/60276312/heatmap\",j_len*(i_len+2-i)+j,\".RData\",sep=\"\"))\n    data_heatmap[[j_len*(i-1)+j]]=data_h\n  }\n  print(i)\n}\n\n#2) with inverted x-axis, time is equally spaced\nj_len=51\ni_len=39\ndata_heatmap=list()\nfor(i in 1:i_len){\n  for(j in 1:j_len){\n    #load(paste(\"C:/Users/ahauser/Documents/Step2/60391337/heatmap\",j_len*(i-1)+j,\".RData\",sep=\"\"))\n    load(paste(\"C:/Users/ahauser/Documents/Step2/65471464/heatmap\",j_len*(i-1)+j,\".RData\",sep=\"\"))\n    data_heatmap[[j_len*(i-1)+j]]=data_h\n  }\n  print(i)\n}\n#-------------------------------------------------------------------------------------------\n#Transforming data\ntmax=dim(data_heatmap[[1]])[1]\nheatmap=matrix(sapply(data_heatmap,function(x) sum(x[tmax,select_15(c(2,12),1:4,2,1:2)])/\n                        sum(x[tmax,select_15(c(2,12),1:4,1:2,1:2)])),c(j_len,i_len))\nsave(heatmap,file=\"C:/Users/ahauser/Documents/Step2/heatmap_mat.RData\")\n\nheatmap_2035=matrix(sapply(data_heatmap,function(x) sum(x[361,select_15(c(2,12),1:4,2,1:2)])/\n                        sum(x[361,select_15(c(2,12),1:4,1:2,1:2)])),c(j_len,i_len))\nheatmap_2020=matrix(sapply(data_heatmap,function(x) sum(x[181,select_15(c(2,12),1:4,2,1:2)])/\n                             sum(x[181,select_15(c(2,12),1:4,1:2,1:2)])),c(j_len,i_len))\n\n#-------------------------------------------------------------------------------------------\n#Plotting data\n#load(file=\"C:/Users/ahauser/Documents/Step2/dtg_res.RData\")\nvals <- unique(scales::rescale(c(heatmap_2035)))\no <- order(vals, decreasing = FALSE)\ncols <- scales::col_numeric(\"Blues\", domain = NULL)(vals)\ncolz <- setNames(data.frame(vals[o], cols[o]), NULL)\nplot_dtg<-plot_ly(z=heatmap_2035,colorscale = colz,colorbar = list(thickness=60,len=0.7,title = \"NNRTI PDR \\n level in 2035\",titlefont=list(size=20),tickfont=list(size=18)), type = \"contour\") %>%\n  plotly::layout(xaxis=list(title=\"Time to switch to DTG (year)\",titlefont=list(family=\"Arial\",size=24),ticktext=seq(1,20,by=0.5)[c(seq(1,i_len,by=5),i_len)],tickvals=c(seq(1,i_len,by=5),i_len)-1,tickmode=\"array\",tickfont=list(size=18)),\n                 yaxis=list(title=\"% women eligible for DTG\",titlefont=list(family=\"Arial\",size=24),ticktext=seq(0,100,by=10),tickvals=seq(0,50,by=5),tickmode=\"array\",tickfont=list(size=18))\n  )\nplot_dtg\n\n\n\nplot_heatmap=function(x,xtitle=\"Time to switch to DTG (year)\",ytitle=\"% women eligible for DTG\",\n                      main.title=\"NNRTI PDR \\n level in 2035\",x.len=i_len,y.len=j_len,\n                      x.text=seq(1,20,by=0.5)[c(seq(1,i_len,by=5),i_len)],y.text=seq(0,100,by=10),\n                      x.vals=c(seq(1,i_len,by=5),i_len)-1,y.vals=seq(0,50,by=5)){\n  vals <- unique(scales::rescale(c(x)))\n  o <- order(vals, decreasing = FALSE)\n  cols <- scales::col_numeric(\"Blues\", domain = NULL)(vals)\n  colz <- setNames(data.frame(vals[o], cols[o]), NULL)\n  plot<-plot_ly(z=x,colorscale = colz,colorbar = list(thickness=60,len=0.7,title = main.title,titlefont=list(size=20),tickfont=list(size=18)), type = \"contour\") %>%\n    plotly::layout(xaxis=list(title=xtitle,titlefont=list(family=\"Arial\",size=24),ticktext=x.text,tickvals=x.vals,tickmode=\"array\",tickfont=list(size=18)),\n                   yaxis=list(title=ytitle,titlefont=list(family=\"Arial\",size=24),ticktext=y.text,tickvals=y.vals,tickmode=\"array\",tickfont=list(size=18))\n    )\n  return(plot)\n}\n###########################################################################################################################\n#Results from Ubelix simulations, heatmap_3par_ub.R\n#-------------------------------------------------------------------------------------------\n#Loading data\nload(paste(\"C:/Users/ahauser/Documents/Step2/65471464/heatmap\",1,\".RData\",sep=\"\"))\ndim_data=dim(data_h)\nj_len=51\ni_len=39\nk_len=20\n\n#outcome\noutcome=function(x){\n  return(sum(x[361,select_15(c(2,12),1:4,2,1:2)])/\n           sum(x[361,select_15(c(2,12),1:4,1:2,1:2)]))\n}\n\ndata_heatmap=array(0,dim=c(i_len,j_len,k_len))\nfor(i in 1:i_len){\n  data_i=list()\n  for(j in 1:j_len){\n    #load(paste(\"C:/Users/ahauser/Documents/Step2/R_results/heatmap_3par/heatmap\",j_len*(i-1)+j,\".RData\",sep=\"\"))\n    load(paste(\"C:/Users/ahauser/Documents/Step2/R_results/heatmap_3par_2/heatmap\",j_len*(i-1)+j,\".RData\",sep=\"\"))\n    for(k in 1:k_len){\n      data_heatmap[i,j,k]=outcome(list_data[[k]])\n    }\n    #print(j)\n  }\n  #print(\"-------------------------------------------\")\n  print(i)\n}\n\n\n\n\n\n\n\n\n#change z\nx=1\ny=100\nz=1\ntreat_dtg=c(p_w_start=y,p_w_switch=y,rate_first=1,rate_switch=x,p_treat=1,p_supp=1,p_fail=z,delay_first=0,delay_switch=0)\nm<-mod_rate(160,xstart,p1,treat_dtg,params,p2)\n\nx=1\ny=100\nz=10\ntreat_dtg=c(p_w_start=y,p_w_switch=y,rate_first=1,rate_switch=x,p_treat=1,p_supp=1,p_fail=z,delay_first=0,delay_switch=0)\nm2=mod_rate(160,xstart,p1,treat_dtg,params,p2)\nm2[[1]]/m[[1]]\nm2[[2]]/m[[2]]\n\n#change x y \nx=1\ny=8\nz=1\ntreat_dtg=c(p_w_start=y,p_w_switch=y,rate_first=1,rate_switch=x,p_treat=1,p_supp=1,p_fail=z,delay_first=0,delay_switch=0)\nm<-mod_rate(160,xstart,p1,treat_dtg,params,p2)\n\nx=4\ny=100\nz=1\ntreat_dtg=c(p_w_start=y,p_w_switch=y,rate_first=1,rate_switch=x,p_treat=1,p_supp=1,p_fail=z,delay_first=0,delay_switch=0)\nm2=mod_rate(160,xstart,p1,treat_dtg,params,p2)\nm2[[1]]/m[[1]]\nm2[[2]]/m[[2]]\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\ni=39\nj=51\nk=1\nload(paste(\"C:/Users/ahauser/Documents/Step2/R_results/heatmap_3par/heatmap\",j_len*(i-1)+j,\".RData\",sep=\"\"))\ndata=list_data[[k]]\nsum(data[160,select_15(c(5),1:4,1:2,1:2)])/sum(data[160,])\nsum(data[140,select_15(c(6:8),1:4,1:2,1:2)])/sum(data[140,select_15(c(3:11,13:15),1:4,1:2,1:2)])\nsum(data[361,select_15(c(5),1:4,1:2,1:2)])\n\ndtg_list=list()\nfor(ii in 1:9){\n  i=20\n  j=51\n  k=2*ii\nload(paste(\"C:/Users/ahauser/Documents/Step2/R_results/heatmap_3par/heatmap\",j_len*(i-1)+j,\".RData\",sep=\"\"))\ndtg_list[[ii]]=list_data[[k]]\n}\nfigures_dtg_4_update(dtg_list,new_inf = TRUE)\nfigures_2_dtg_update(dtg_list[[1]])\nfigures_2_dtg_update(dtg_list[[9]])\n\n\n\n\n\n#heatmap x,y for different z\n#z=1,k=1\n#z=10,k=10\n#z=20,k=20\nplot_ly(z=t(data_heatmap[,,1]))\nplot_heatmap(x=t(data_heatmap[,,1]))\nplot_heatmap(x=t(data_heatmap[,,10]))\nplot_heatmap(x=t(data_heatmap[,,20]))\n\nplot_heatmap(x=t(data_heatmap[1,,]),xtitle = \"x-fold increase\")\nplot_ly(z=data_heatmap[,,10])\nplot_ly(z=t(data_heatmap[,,20]))\n\n#heatmap z,y for different x\n#x=1,i=1\n#x=10,i=19\n#x=20,i=39\nplot_heatmap(x=data_heatmap[1,,],xtitle = \"x-fold increase\")\nplot_heatmap(x=data_heatmap[20,,],xtitle = \"x-fold increase\")\nplot_heatmap(x=data_heatmap[39,,],xtitle = \"x-fold increase\")\nplot_ly(z=data_heatmap[1,,])\nplot_ly(z=data_heatmap[19,,])\nplot_ly(z=data_heatmap[39,,])\n\nplot_ly(z=data_heatmap[,20,])\nplot_heatmap(data_heatmap[,21,])\n\n###########################################################################################################################\n###########################################################################################################################\n#Alternatives\n#time on x-axis, rate is equally spaced\nplot_ly(z=heatmap_2030,colorscale = \"Greys\",colorbar = list(title = \"NNRTI resistance \\n level in 2030\"), type = \"heatmap\") %>%\n  plotly::layout(xaxis=list(title=\"Time to switch (year)\",titlefont=list(family=\"Arial\"),ticktext=round((1/seq(1,(3-1)/(51-1),by=-0.02))[c(1,seq(4,49,by=5))],digits=1),tickvals=c(1,seq(4,49,by=5))-1,tickmode=\"array\"),\n                 yaxis=list(title=\"Proportion of women eligible for DTG\",titlefont=list(family=\"Arial\"),ticktext=seq(0,1,by=0.1),tickvals=seq(0,50,by=5),tickmode=\"array\")\n  )\n#time on x-axis, time is equally space\nplot_ly(z=heatmap_2035,colorscale = \"Greys\",colorbar = list(title = \"NNRTI resistance \\n level in 2035\"), type = \"heatmap\") %>%\n  plotly::layout(xaxis=list(title=\"Time to switch (year)\",titlefont=list(family=\"Arial\"),ticktext=seq(1,20,by=0.5)[c(seq(1,i_len,by=5),i_len)],tickvals=c(seq(1,i_len,by=5),i_len)-1,tickmode=\"array\"),\n                 yaxis=list(title=\"Proportion of women eligible for DTG\",titlefont=list(family=\"Arial\"),ticktext=seq(0,1,by=0.1),tickvals=seq(0,50,by=5),tickmode=\"array\")\n  )\n#rate on x-axis\nplot_ly(z=heatmap,colorscale=\"Green\",colorbar = list(title = \"NNRTI PDR \\n level in 2038\"), type = \"heatmap\") %>%\n  plotly::layout(margin = m,xaxis=list(title=\"Relative switching rate\",titlefont=list(family=\"Arial\"),ticktext=seq(0,1,by=0.1),tickvals=seq(0,50,by=5),tickmode=\"array\"),\n                 yaxis=list(title=\"Proportion of women eligible for DTG\",titlefont=list(family=\"Arial\"),ticktext=seq(0,1,by=0.1),tickvals=seq(0,50,by=5),tickmode=\"array\")\n  )\n\n###########################################################################################################################\n#not used\n#Results from Ubelix simulation: calendar time on x-axis\nj_len=51\ni=51\nt_len=241\ntmax=397\ndata_heatmap=rep(NA,t_len*j_len)\n\nfor(j in 1:j_len){\n  load(paste(\"C:/Users/ahauser/Documents/Step2/60276312/heatmap\",j_len*(i-1)+j,\".RData\",sep=\"\"))\n  data_heatmap[seq(j,(t_len-1)*j_len+j,by=j_len)]=\n    rowSums(data_h[seq(tmax-t_len+1,tmax,1),select_15(c(2,12),1:4,2,1:2)])/rowSums(data_h[seq(tmax-t_len+1,tmax,1),select_15(c(2,12),1:4,1:2,1:2)])\n}\n\n#Plot\nheatmap=matrix(data_heatmap,c(j_len,t_len))\nplot_ly(z=heatmap,colorbar = list(title = \"NNRTI resistance \\n level\"),type = \"heatmap\") %>%\n  plotly::layout(xaxis=list(title=\"Calendar year\",titlefont=list(family=\"Arial\"),ticktext=seq(2018,2038,by=2),tickvals=seq(0,t_len-1,by=24),tickmode=\"array\"),\n                 yaxis=list(title=\"Proportion of women eligible for DTG\",titlefont=list(family=\"Arial\"),ticktext=seq(0,1,by=0.1),tickvals=seq(0,50,by=5),tickmode=\"array\")\n  )\n",
    "created" : 1551285113790.000,
    "dirty" : true,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3992206687",
    "id" : "498C0A63",
    "lastKnownWriteTime" : 1553853872,
    "last_content_update" : 1556722272606,
    "path" : "~/Step2/dtg/heatmap.R",
    "project_path" : "heatmap.R",
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}